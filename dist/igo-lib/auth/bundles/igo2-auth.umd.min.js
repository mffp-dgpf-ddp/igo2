!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs"),require("@igo2/utils"),require("jwt-decode"),require("rxjs/operators"),require("@angular/router"),require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("@angular/forms"),require("@angular/material"),require("@igo2/core")):"function"==typeof define&&define.amd?define("@igo2/auth",["exports","rxjs","@igo2/utils","jwt-decode","rxjs/operators","@angular/router","@angular/core","@angular/common","@angular/common/http","@angular/forms","@angular/material","@igo2/core"],e):e((t.igo2=t.igo2||{},t.igo2.auth={}),t.rxjs,t.utils,t.jwtDecode,t.rxjs.operators,t.ng.router,t.ng.core,t.ng.common,t.ng.common.http,t.ng.forms,t.ng.material,t.i2)}(this,function(t,r,e,o,a,n,i,s,u,c,p,l){"use strict";o=o&&o.hasOwnProperty("default")?o["default"]:o;var g=(h.prototype.set=function(t){localStorage.setItem(this.tokenKey,t)},h.prototype.remove=function(){localStorage.removeItem(this.tokenKey)},h.prototype.get=function(){return localStorage.getItem(this.tokenKey)},h.prototype.decode=function(){var t=this.get();if(t)return o(t)},h.prototype.isExpired=function(){var t=this.decode(),e=(new Date).getTime()/1e3;return!(t&&e<t.exp)},Object.defineProperty(h.prototype,"tokenKey",{get:function(){var t=this.injector.get(l.ConfigService);return this.options=t.getConfig("auth")||{},this.options.tokenKey},enumerable:!0,configurable:!0}),h.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],h.ctorParameters=function(){return[{type:i.Injector}]},h.ngInjectableDef=i.defineInjectable({factory:function(){return new h(i.inject(i.INJECTOR))},token:h,providedIn:"root"}),h);function h(t){this.injector=t}var d=(f.prototype.login=function(t,e){var o=new u.HttpHeaders;o.append("Content-Type","application/json");var n=JSON.stringify({username:t,password:this.encodePassword(e)});return this.loginCall(n,o)},f.prototype.loginWithToken=function(t,e){var o=new u.HttpHeaders;o.append("Content-Type","application/json");var n=JSON.stringify({token:t,typeConnection:e});return this.loginCall(n,o)},f.prototype.loginAnonymous=function(){return this.anonymous=!0,r.of(!0)},f.prototype.logout=function(){return this.anonymous=!1,this.tokenService.remove(),this.authenticate$.next(!1),r.of(!0)},f.prototype.isAuthenticated=function(){return!this.tokenService.isExpired()},f.prototype.getToken=function(){return this.tokenService.get()},f.prototype.decodeToken=function(){return!!this.isAuthenticated()&&this.tokenService.decode()},f.prototype.goToRedirectUrl=function(){if(this.router){var t=this.redirectUrl||this.router.url;if(t===this.options.loginRoute){var e=this.options.homeRoute||"/";this.router.navigateByUrl(e)}else t&&this.router.navigateByUrl(t)}},f.prototype.getUserInfo=function(){var t=this.options.url+"/info";return this.http.get(t)},f.prototype.getProfils=function(){return this.http.get(this.options.url+"/profils")},f.prototype.updateUser=function(t){var e=this.options.url;return this.http.patch(e,JSON.stringify(t))},f.prototype.encodePassword=function(t){return e.Base64.encode(t)},Object.defineProperty(f.prototype,"logged",{get:function(){return this.authenticated||this.isAnonymous},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"isAnonymous",{get:function(){return this.anonymous},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"authenticated",{get:function(){return this.isAuthenticated()},enumerable:!0,configurable:!0}),f.prototype.loginCall=function(t,e){var o=this;return this.http.post(this.options.url+"/login",t,{headers:e}).pipe(a.tap(function(t){o.tokenService.set(t.token);var e=o.decodeToken();e&&e.user&&e.user.locale&&o.languageService.setLanguage(e.user.locale),o.authenticate$.next(!0)}))},f.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],f.ctorParameters=function(){return[{type:u.HttpClient},{type:g},{type:l.ConfigService},{type:l.LanguageService},{type:n.Router,decorators:[{type:i.Optional}]}]},f.ngInjectableDef=i.defineInjectable({factory:function(){return new f(i.inject(u.HttpClient),i.inject(g),i.inject(l.ConfigService),i.inject(l.LanguageService),i.inject(n.Router,8))},token:f,providedIn:"root"}),f);function f(t,e,o,n,i){this.http=t,this.tokenService=e,this.config=o,this.languageService=n,this.router=i,this.authenticate$=new r.BehaviorSubject(undefined),this.anonymous=!1,this.options=this.config.getConfig("auth")||{},this.authenticate$.next(this.authenticated)}var y=(Object.defineProperty(v.prototype,"backgroundDisable",{get:function(){return!this.isLogoutRoute&&!this.isLogoutRoute&&this._backgroundDisable},set:function(t){this._backgroundDisable="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"hasAlreadyConnectedDiv",{get:function(){return this._hasAlreadyConnectedDiv},set:function(t){this._hasAlreadyConnectedDiv="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"hasLogoutDiv",{get:function(){return this._hasLogoutDiv},set:function(t){this._hasLogoutDiv="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"showAlreadyConnectedDiv",{get:function(){return this.isLogoutRoute?this.hasAlreadyConnectedDiv:this._showAlreadyConnectedDiv},set:function(t){this._showAlreadyConnectedDiv="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"showLogoutDiv",{get:function(){return this.isLogoutRoute?this.hasLogoutDiv:this._showLogoutDiv},set:function(t){this._showLogoutDiv="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"showLoginDiv",{get:function(){if(!this.isLogoutRoute)return!0},enumerable:!0,configurable:!0}),v.prototype.ngOnInit=function(){this.analyzeRoute(),this.getName()},v.prototype.login=function(){this.auth.goToRedirectUrl(),this.getName()},v.prototype.logout=function(){var t=this;this.auth.logout().subscribe(function(){t.user=undefined,t.router&&(t.options.logoutRoute?t.router.navigate([t.options.logoutRoute]):t.options.homeRoute&&t.router.navigate([t.options.homeRoute]))})},v.prototype.home=function(){this.router&&this.options.homeRoute&&this.router.navigate([this.options.homeRoute])},v.prototype.getName=function(){if(this.auth.decodeToken()){var t=this.auth.decodeToken();this.user={name:t.user.firstName||t.user.sourceId}}},v.prototype.analyzeRoute=function(){var i=this;this.router&&this.router.events.pipe(a.filter(function(t){return t instanceof n.NavigationStart})).subscribe(function(t){if(t.url){var e=t.url,o=i.options.logoutRoute,n=i.options.loginRoute;i.isLogoutRoute=e===o,i.isLoginRoute=e===n,i.isLogoutRoute&&i.auth.logout()}})},v.decorators=[{type:i.Component,args:[{selector:"igo-auth-form",template:'<div *ngIf="visible">\r\n  <div *ngIf="!auth.logged && backgroundDisable" class="backgroundDisable"></div>\r\n\r\n  <div *ngIf="!auth.logged && showLoginDiv" class="login center-block">\r\n    <h1>{{\'igo.auth.connection\' | translate}}</h1>\r\n\r\n    <igo-auth-google\r\n      *ngIf="options.google && options.google.enabled !== false"\r\n      (login)="login()">\r\n    </igo-auth-google>\r\n    <igo-auth-facebook\r\n      *ngIf="options.facebook && options.facebook.enabled !== false"\r\n      (login)="login()">\r\n    </igo-auth-facebook>\r\n    <igo-auth-intern\r\n      *ngIf="!options.intern || options.intern.enabled !== false"\r\n      [allowAnonymous]="options.allowAnonymous"\r\n      (login)="login()">\r\n    </igo-auth-intern>\r\n  </div>\r\n\r\n  <div *ngIf="auth.logged && showAlreadyConnectedDiv" class="login center-block">\r\n    <p>{{\'igo.auth.welcome\' | translate: user}}</p>\r\n    <button mat-raised-button type="button" (click)="logout()">{{\'igo.auth.signOut\' | translate}}</button>\r\n  </div>\r\n\r\n  <div *ngIf="showLogoutDiv" class="login center-block">\r\n    <p>{{\'igo.auth.deconnection\' | translate}}</p>\r\n    <button *ngIf="options.homeRoute" mat-raised-button type="button" (click)="home()">{{\'igo.auth.home\' | translate}}</button>\r\n  </div>\r\n\r\n</div>\r\n',changeDetection:i.ChangeDetectionStrategy.Default,styles:[":host{z-index:999}div.login{z-index:200;width:90%;min-width:360px;max-width:600px;padding:25px 50px;border:1px solid #888;background-color:#fff}.center-block{position:fixed;top:20%;left:50%;transform:translate(-50%,0)}.backgroundDisable{position:fixed;top:0;left:0;background:#000;opacity:.8;z-index:100;height:100%;width:100%}"]}]}],v.ctorParameters=function(){return[{type:d},{type:l.ConfigService},{type:n.Router,decorators:[{type:i.Optional}]}]},v.propDecorators={backgroundDisable:[{type:i.Input}],hasAlreadyConnectedDiv:[{type:i.Input}],hasLogoutDiv:[{type:i.Input}],showAlreadyConnectedDiv:[{type:i.Input}],showLogoutDiv:[{type:i.Input}]},v);function v(t,e,o){this.auth=t,this.config=e,this.router=o,this._backgroundDisable=!0,this._hasAlreadyConnectedDiv=!0,this._hasLogoutDiv=!0,this._showAlreadyConnectedDiv=!1,this._showLogoutDiv=!1,this.visible=!0,this.options=this.config.getConfig("auth")||{},this.visible=0!==Object.getOwnPropertyNames(this.options).length}var m=(Object.defineProperty(b.prototype,"allowAnonymous",{get:function(){return this._allowAnonymous},set:function(t){this._allowAnonymous=t},enumerable:!0,configurable:!0}),b.prototype.loginUser=function(t){var e=this;return this.auth.login(t.username,t.password).subscribe(function(){e.login.emit(!0)},function(t){e.error=t.error.message}),!1},b.prototype.loginAnonymous=function(){var t=this;this.auth.loginAnonymous().subscribe(function(){t.login.emit(!0)})},b.decorators=[{type:i.Component,args:[{selector:"igo-auth-intern",template:'<form [formGroup]="form" role="form" (ngSubmit)="loginUser(form.value)">\r\n  <div>\r\n    <mat-form-field class="full-width">\r\n      <input matInput required placeholder="{{\'igo.auth.user\' | translate}}" formControlName="username">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div>\r\n    <mat-form-field class="full-width">\r\n      <input matInput required type="password" placeholder="{{\'igo.auth.password\' | translate}}" formControlName="password">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <button mat-raised-button type="submit" [disabled]="!form.valid">{{\'igo.auth.login\' | translate}}</button>\r\n  <button *ngIf="allowAnonymous" mat-raised-button type="button" (click)="loginAnonymous()">{{\'igo.auth.accessAnonymous\' | translate }}</button>\r\n  <div *ngIf="error">\r\n    <br/>\r\n    <font size="3" color="red">{{error}}</font>\r\n  </div>\r\n</form>\r\n',changeDetection:i.ChangeDetectionStrategy.Default,styles:[".full-width{width:100%}"]}]}],b.ctorParameters=function(){return[{type:d},{type:c.FormBuilder}]},b.propDecorators={allowAnonymous:[{type:i.Input}],login:[{type:i.Output}]},b);function b(t,e){this.auth=t,this._allowAnonymous=!0,this.error="",this.login=new i.EventEmitter,this.form=e.group({username:["",c.Validators.required],password:["",c.Validators.required]})}var j=(k.prototype.subscribeEvents=function(){var e=this;window.FB.Event.subscribe("auth.statusChange",function(t){e.statusChangeCallback(t)})},k.prototype.statusChangeCallback=function(t){if("connected"===t.status){var e=t.authResponse.accessToken;this.loginFacebook(e)}},k.prototype.loginFacebook=function(t){var e=this;this.authService.loginWithToken(t,"facebook").subscribe(function(){e.appRef.tick(),e.login.emit(!0)})},k.prototype.loadSDKFacebook=function(){var t=this;if(!document.getElementById("facebook-jssdk")){var e=document.getElementsByTagName("script")[0],o=document.createElement("script");o.id="facebook-jssdk",o.src="https://connect.facebook.net/fr_CA/sdk.js#xfbml=1&version=v2.9&appId="+this.options.apiKey,o.onload=function(){t.subscribeEvents()},e.parentNode.insertBefore(o,e)}},k.decorators=[{type:i.Component,args:[{selector:"igo-auth-facebook",template:'<div scope="public_profile,email"\r\n     class="fb-login-button" data-max-rows="1" data-size="large"\r\n     data-button-type="continue_with" data-show-faces="false"\r\n     data-auto-logout-link="false" data-use-continue-as="false">\r\n</div>\r\n',changeDetection:i.ChangeDetectionStrategy.OnPush,styles:[".fb-login-button{padding:10px 0}"]}]}],k.ctorParameters=function(){return[{type:d},{type:l.ConfigService},{type:i.ApplicationRef}]},k.propDecorators={login:[{type:i.Output}]},k);function k(t,e,o){this.authService=t,this.config=e,this.appRef=o,this.login=new i.EventEmitter,this.options=this.config.getConfig("auth.facebook")||{},this.options.apiKey&&this.loadSDKFacebook()}var w=(I.prototype.handleSignInClick=function(){window.gapi.auth2.getAuthInstance().signIn()},I.prototype.handleSignOutClick=function(){window.gapi.auth2.getAuthInstance().signOut()},I.prototype.handleClientLoad=function(){var t=this;window.gapi.load("client:auth2",function(){return t.initClient()})},I.prototype.initClient=function(){var e=this;window.gapi.client.init({apiKey:this.options.apiKey,clientId:this.options.clientId,discoveryDocs:["https://people.googleapis.com/$discovery/rest?version=v1"],scope:"profile"}).then(function(){e.handleSignOutClick(),window.gapi.auth2.getAuthInstance().isSignedIn.listen(function(t){e.updateSigninStatus(t)})})},I.prototype.updateSigninStatus=function(t){t&&this.loginGoogle(window.gapi.client.getToken().access_token)},I.prototype.loginGoogle=function(t){var e=this;this.authService.loginWithToken(t,"google").subscribe(function(){e.appRef.tick(),e.login.emit(!0)})},I.prototype.loadSDKGoogle=function(){var t=this,e=document.getElementsByTagName("script")[0],o=document.createElement("script");o.id="google-jssdk",o.src="https://apis.google.com/js/api.js",o.onload=function(){t.handleClientLoad()},e.parentNode.insertBefore(o,e)},I.prototype.loadPlatform=function(){var t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.id="google-platform",e.src="https://apis.google.com/js/platform.js",t.parentNode.insertBefore(e,t)},I.decorators=[{type:i.Component,args:[{selector:"igo-auth-google",template:'<div class="g-signin2 google-login-button" data-height="40" data-width="265" data-longtitle="true">\r\n',changeDetection:i.ChangeDetectionStrategy.OnPush,styles:[".google-login-button{padding:10px 0}"]}]}],I.ctorParameters=function(){return[{type:d},{type:l.ConfigService},{type:i.ApplicationRef}]},I.propDecorators={login:[{type:i.Output}]},I);function I(t,e,o){this.authService=t,this.config=e,this.appRef=o,this.login=new i.EventEmitter,this.options=this.config.getConfig("auth.google")||{},this.options.apiKey&&this.options.clientId&&(this.loadSDKGoogle(),this.loadPlatform())}var S=(C.prototype.canActivate=function(t,e){if(this.authService.logged)return!0;this.authService.redirectUrl=e.url;var o=this.config.getConfig("auth");return o&&o.loginRoute&&this.router.navigateByUrl(o.loginRoute),!1},C.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],C.ctorParameters=function(){return[{type:d},{type:l.ConfigService},{type:n.Router}]},C.ngInjectableDef=i.defineInjectable({factory:function(){return new C(i.inject(d),i.inject(l.ConfigService),i.inject(n.Router))},token:C,providedIn:"root"}),C);function C(t,e,o){this.authService=t,this.config=e,this.router=o}var D=(R.prototype.canActivate=function(t,e){if(this.authService.authenticated)return!0;this.authService.redirectUrl=e.url;var o=this.config.getConfig("auth");return o&&o.loginRoute&&this.router.navigateByUrl(o.loginRoute),!1},R.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],R.ctorParameters=function(){return[{type:d},{type:l.ConfigService},{type:n.Router}]},R.ngInjectableDef=i.defineInjectable({factory:function(){return new R(i.inject(d),i.inject(l.ConfigService),i.inject(n.Router))},token:R,providedIn:"root"}),R);function R(t,e,o){this.authService=t,this.config=e,this.router=o}var A=(P.prototype.canActivate=function(t,e){var o=this.authService.decodeToken();if(o&&o.user&&o.user.isAdmin)return!0;this.authService.redirectUrl=e.url;var n=this.config.getConfig("auth");return n&&n.loginRoute&&this.router.navigateByUrl(n.loginRoute),!1},P.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],P.ctorParameters=function(){return[{type:d},{type:l.ConfigService},{type:n.Router}]},P.ngInjectableDef=i.defineInjectable({factory:function(){return new P(i.inject(d),i.inject(l.ConfigService),i.inject(n.Router))},token:P,providedIn:"root"}),P);function P(t,e,o){this.authService=t,this.config=e,this.router=o}var x=(O.prototype.canActivate=function(t,o){var n=this;return this.authService.getProfils().pipe(a.map(function(t){var e=n.config.getConfig("auth");return!(!t||!t.some(function(t){return-1!==e.profilsGuard.indexOf(t)}))||(n.authService.redirectUrl=o.url,e&&e.loginRoute&&n.router.navigateByUrl(e.loginRoute),!1)}))},O.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],O.ctorParameters=function(){return[{type:d},{type:l.ConfigService},{type:n.Router}]},O.ngInjectableDef=i.defineInjectable({factory:function(){return new O(i.inject(d),i.inject(l.ConfigService),i.inject(n.Router))},token:O,providedIn:"root"}),O);function O(t,e,o){this.authService=t,this.config=e,this.router=o}var L=(E.prototype.intercept=function(t,e){var o=this.tokenService.get(),n=document.createElement("a");if(n.href=t.url,!o&&-1===this.trustHosts.indexOf(n.hostname))return e.handle(t);var i="Bearer "+o,r=t.clone({headers:t.headers.set("Authorization",i)});return e.handle(r)},E.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],E.ctorParameters=function(){return[{type:l.ConfigService},{type:g}]},E.ngInjectableDef=i.defineInjectable({factory:function(){return new E(i.inject(l.ConfigService),i.inject(g))},token:E,providedIn:"root"}),E);function E(t,e){this.config=t,this.tokenService=e,this.trustHosts=[],this.trustHosts=this.config.getConfig("auth.trustHosts")||[],this.trustHosts.push(window.location.hostname)}var T=(_.decorators=[{type:i.Directive,args:[{selector:"[igoProtected]"}]}],_.ctorParameters=function(){return[{type:d},{type:i.ElementRef}]},_);function _(t,e){t.isAuthenticated()||e.nativeElement.parentNode.removeChild(e.nativeElement)}var N=[{path:"login",component:y},{path:"logout",component:y}],B=(M.decorators=[{type:i.NgModule,args:[{imports:[n.RouterModule.forChild(N)],exports:[n.RouterModule],providers:[]}]}],M);function M(){}var U=(q.forRoot=function(){return{ngModule:q,providers:[{provide:u.HTTP_INTERCEPTORS,useClass:L,multi:!0}]}},q.decorators=[{type:i.NgModule,args:[{imports:[s.CommonModule,c.ReactiveFormsModule,p.MatFormFieldModule,p.MatInputModule,p.MatButtonModule,l.IgoLanguageModule],declarations:[y,w,m,j,T],exports:[y,T]}]}],q);function q(){}t.AuthFormComponent=y,t.AuthService=d,t.LoggedGuard=S,t.AuthGuard=D,t.AdminGuard=A,t.ProfilsGuard=x,t.AuthInterceptor=L,t.ProtectedDirective=T,t.TokenService=g,t.AuthRoutingModule=B,t.IgoAuthModule=U,t.ɵd=j,t.ɵa=y,t.ɵb=w,t.ɵc=m,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=igo2-auth.umd.min.js.map