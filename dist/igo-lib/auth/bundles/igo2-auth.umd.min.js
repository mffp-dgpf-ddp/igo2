!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs"),require("@igo2/utils"),require("jwt-decode"),require("rxjs/operators"),require("@angular/router"),require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("@angular/forms"),require("@angular/material"),require("@igo2/core")):"function"==typeof define&&define.amd?define("@igo2/auth",["exports","rxjs","@igo2/utils","jwt-decode","rxjs/operators","@angular/router","@angular/core","@angular/common","@angular/common/http","@angular/forms","@angular/material","@igo2/core"],e):e((t.igo2=t.igo2||{},t.igo2.auth={}),t.rxjs,t.utils,t.jwtDecode,t.rxjs.operators,t.ng.router,t.ng.core,t.ng.common,t.ng.common.http,t.ng.forms,t.ng.material,t.i2)}(this,function(t,r,e,o,a,n,i,u,s,c,l,p){"use strict";o=o&&o.hasOwnProperty("default")?o["default"]:o;var g=function(){function t(t){this.injector=t}return t.prototype.set=function(t){localStorage.setItem(this.tokenKey,t)},t.prototype.remove=function(){localStorage.removeItem(this.tokenKey)},t.prototype.get=function(){return localStorage.getItem(this.tokenKey)},t.prototype.decode=function(){var t=this.get();if(t)return o(t)},t.prototype.isExpired=function(){var t=this.decode(),e=(new Date).getTime()/1e3;return!(t&&e<t.exp)},Object.defineProperty(t.prototype,"tokenKey",{get:function(){var t=this.injector.get(p.ConfigService);return this.options=t.getConfig("auth")||{},this.options.tokenKey},enumerable:!0,configurable:!0}),t.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:i.Injector}]},t.ngInjectableDef=i.defineInjectable({factory:function(){return new t(i.inject(i.INJECTOR))},token:t,providedIn:"root"}),t}(),h=function(){function t(t,e,o,n,i){this.http=t,this.tokenService=e,this.config=o,this.languageService=n,this.router=i,this.authenticate$=new r.BehaviorSubject(undefined),this.anonymous=!1,this.options=this.config.getConfig("auth")||{},this.authenticate$.next(this.authenticated)}return t.prototype.login=function(t,e){var o=new s.HttpHeaders;o.append("Content-Type","application/json");var n=JSON.stringify({username:t,password:this.encodePassword(e)});return this.loginCall(n,o)},t.prototype.loginWithToken=function(t,e){var o=new s.HttpHeaders;o.append("Content-Type","application/json");var n=JSON.stringify({token:t,typeConnection:e});return this.loginCall(n,o)},t.prototype.loginAnonymous=function(){return this.anonymous=!0,r.of(!0)},t.prototype.logout=function(){return this.anonymous=!1,this.tokenService.remove(),this.authenticate$.next(!1),r.of(!0)},t.prototype.isAuthenticated=function(){return!this.tokenService.isExpired()},t.prototype.getToken=function(){return this.tokenService.get()},t.prototype.decodeToken=function(){return!!this.isAuthenticated()&&this.tokenService.decode()},t.prototype.goToRedirectUrl=function(){if(this.router){var t=this.redirectUrl||this.router.url;if(t===this.options.loginRoute){var e=this.options.homeRoute||"/";this.router.navigateByUrl(e)}else t&&this.router.navigateByUrl(t)}},t.prototype.getUserInfo=function(){var t=this.options.url+"/info";return this.http.get(t)},t.prototype.getProfils=function(){return this.http.get(this.options.url+"/profils")},t.prototype.updateUser=function(t){var e=this.options.url;return this.http.patch(e,JSON.stringify(t))},t.prototype.encodePassword=function(t){return e.Base64.encode(t)},Object.defineProperty(t.prototype,"logged",{get:function(){return this.authenticated||this.isAnonymous},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isAnonymous",{get:function(){return this.anonymous},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"authenticated",{get:function(){return this.isAuthenticated()},enumerable:!0,configurable:!0}),t.prototype.loginCall=function(t,e){var o=this;return this.http.post(this.options.url+"/login",t,{headers:e}).pipe(a.tap(function(t){o.tokenService.set(t.token);var e=o.decodeToken();e&&e.user&&e.user.locale&&o.languageService.setLanguage(e.user.locale),o.authenticate$.next(!0)}))},t.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:s.HttpClient},{type:g},{type:p.ConfigService},{type:p.LanguageService},{type:n.Router,decorators:[{type:i.Optional}]}]},t.ngInjectableDef=i.defineInjectable({factory:function(){return new t(i.inject(s.HttpClient),i.inject(g),i.inject(p.ConfigService),i.inject(p.LanguageService),i.inject(n.Router,8))},token:t,providedIn:"root"}),t}(),f=function(){function t(t,e,o){this.auth=t,this.config=e,this.router=o,this._backgroundDisable=!0,this._hasAlreadyConnectedDiv=!0,this._hasLogoutDiv=!0,this._showAlreadyConnectedDiv=!1,this._showLogoutDiv=!1,this.visible=!0,this.options=this.config.getConfig("auth")||{},this.visible=0!==Object.getOwnPropertyNames(this.options).length}return Object.defineProperty(t.prototype,"backgroundDisable",{get:function(){return!this.isLogoutRoute&&!this.isLogoutRoute&&this._backgroundDisable},set:function(t){this._backgroundDisable="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasAlreadyConnectedDiv",{get:function(){return this._hasAlreadyConnectedDiv},set:function(t){this._hasAlreadyConnectedDiv="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasLogoutDiv",{get:function(){return this._hasLogoutDiv},set:function(t){this._hasLogoutDiv="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showAlreadyConnectedDiv",{get:function(){return this.isLogoutRoute?this.hasAlreadyConnectedDiv:this._showAlreadyConnectedDiv},set:function(t){this._showAlreadyConnectedDiv="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showLogoutDiv",{get:function(){return this.isLogoutRoute?this.hasLogoutDiv:this._showLogoutDiv},set:function(t){this._showLogoutDiv="true"===t.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showLoginDiv",{get:function(){if(!this.isLogoutRoute)return!0},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){this.analyzeRoute(),this.getName()},t.prototype.login=function(){this.auth.goToRedirectUrl(),this.getName()},t.prototype.logout=function(){var t=this;this.auth.logout().subscribe(function(){t.user=undefined,t.router&&(t.options.logoutRoute?t.router.navigate([t.options.logoutRoute]):t.options.homeRoute&&t.router.navigate([t.options.homeRoute]))})},t.prototype.home=function(){this.router&&this.options.homeRoute&&this.router.navigate([this.options.homeRoute])},t.prototype.getName=function(){if(this.auth.decodeToken()){var t=this.auth.decodeToken();this.user={name:t.user.firstName||t.user.sourceId}}},t.prototype.analyzeRoute=function(){var i=this;this.router&&this.router.events.pipe(a.filter(function(t){return t instanceof n.NavigationStart})).subscribe(function(t){if(t.url){var e=t.url,o=i.options.logoutRoute,n=i.options.loginRoute;i.isLogoutRoute=e===o,i.isLoginRoute=e===n,i.isLogoutRoute&&i.auth.logout()}})},t.decorators=[{type:i.Component,args:[{selector:"igo-auth-form",template:'<div *ngIf="visible">\r\n  <div *ngIf="!auth.logged && backgroundDisable" class="backgroundDisable"></div>\r\n\r\n  <div *ngIf="!auth.logged && showLoginDiv" class="login center-block">\r\n    <h1>{{\'igo.auth.connection\' | translate}}</h1>\r\n\r\n    <igo-auth-google\r\n      *ngIf="options.google && options.google.enabled !== false"\r\n      (login)="login()">\r\n    </igo-auth-google>\r\n    <igo-auth-facebook\r\n      *ngIf="options.facebook && options.facebook.enabled !== false"\r\n      (login)="login()">\r\n    </igo-auth-facebook>\r\n    <igo-auth-intern\r\n      *ngIf="!options.intern || options.intern.enabled !== false"\r\n      [allowAnonymous]="options.allowAnonymous"\r\n      (login)="login()">\r\n    </igo-auth-intern>\r\n  </div>\r\n\r\n  <div *ngIf="auth.logged && showAlreadyConnectedDiv" class="login center-block">\r\n    <p>{{\'igo.auth.welcome\' | translate: user}}</p>\r\n    <button mat-raised-button type="button" (click)="logout()">{{\'igo.auth.signOut\' | translate}}</button>\r\n  </div>\r\n\r\n  <div *ngIf="showLogoutDiv" class="login center-block">\r\n    <p>{{\'igo.auth.deconnection\' | translate}}</p>\r\n    <button *ngIf="options.homeRoute" mat-raised-button type="button" (click)="home()">{{\'igo.auth.home\' | translate}}</button>\r\n  </div>\r\n\r\n</div>\r\n',changeDetection:i.ChangeDetectionStrategy.Default,styles:[":host{z-index:999}div.login{z-index:200;width:90%;min-width:360px;max-width:600px;padding:25px 50px;border:1px solid #888;background-color:#fff}.center-block{position:fixed;top:20%;left:50%;-webkit-transform:translate(-50%,0);transform:translate(-50%,0)}.backgroundDisable{position:fixed;top:0;left:0;background:#000;opacity:.8;z-index:100;height:100%;width:100%}"]}]}],t.ctorParameters=function(){return[{type:h},{type:p.ConfigService},{type:n.Router,decorators:[{type:i.Optional}]}]},t.propDecorators={backgroundDisable:[{type:i.Input}],hasAlreadyConnectedDiv:[{type:i.Input}],hasLogoutDiv:[{type:i.Input}],showAlreadyConnectedDiv:[{type:i.Input}],showLogoutDiv:[{type:i.Input}]},t}(),d=function(){function t(t,e){this.auth=t,this._allowAnonymous=!0,this.error="",this.login=new i.EventEmitter,this.form=e.group({username:["",c.Validators.required],password:["",c.Validators.required]})}return Object.defineProperty(t.prototype,"allowAnonymous",{get:function(){return this._allowAnonymous},set:function(t){this._allowAnonymous=t},enumerable:!0,configurable:!0}),t.prototype.loginUser=function(t){var e=this;return this.auth.login(t.username,t.password).subscribe(function(){e.login.emit(!0)},function(t){e.error=t.error.message}),!1},t.prototype.loginAnonymous=function(){var t=this;this.auth.loginAnonymous().subscribe(function(){t.login.emit(!0)})},t.decorators=[{type:i.Component,args:[{selector:"igo-auth-intern",template:'<form [formGroup]="form" role="form" (ngSubmit)="loginUser(form.value)">\r\n  <div>\r\n    <mat-form-field class="full-width">\r\n      <input matInput required placeholder="{{\'igo.auth.user\' | translate}}" formControlName="username">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div>\r\n    <mat-form-field class="full-width">\r\n      <input matInput required type="password" placeholder="{{\'igo.auth.password\' | translate}}" formControlName="password">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <button mat-raised-button type="submit" [disabled]="!form.valid">{{\'igo.auth.login\' | translate}}</button>\r\n  <button *ngIf="allowAnonymous" mat-raised-button type="button" (click)="loginAnonymous()">{{\'igo.auth.accessAnonymous\' | translate }}</button>\r\n  <div *ngIf="error">\r\n    <br/>\r\n    <font size="3" color="red">{{error}}</font>\r\n  </div>\r\n</form>\r\n',changeDetection:i.ChangeDetectionStrategy.Default,styles:[".full-width{width:100%}"]}]}],t.ctorParameters=function(){return[{type:h},{type:c.FormBuilder}]},t.propDecorators={allowAnonymous:[{type:i.Input}],login:[{type:i.Output}]},t}(),y=function(){function t(t,e,o){this.authService=t,this.config=e,this.appRef=o,this.login=new i.EventEmitter,this.options=this.config.getConfig("auth.facebook")||{},this.options.apiKey&&this.loadSDKFacebook()}return t.prototype.subscribeEvents=function(){var e=this;window.FB.Event.subscribe("auth.statusChange",function(t){e.statusChangeCallback(t)})},t.prototype.statusChangeCallback=function(t){if("connected"===t.status){var e=t.authResponse.accessToken;this.loginFacebook(e)}},t.prototype.loginFacebook=function(t){var e=this;this.authService.loginWithToken(t,"facebook").subscribe(function(){e.appRef.tick(),e.login.emit(!0)})},t.prototype.loadSDKFacebook=function(){var t=this;if(!document.getElementById("facebook-jssdk")){var e=document.getElementsByTagName("script")[0],o=document.createElement("script");o.id="facebook-jssdk",o.src="https://connect.facebook.net/fr_CA/sdk.js#xfbml=1&version=v2.9&appId="+this.options.apiKey,o.onload=function(){t.subscribeEvents()},e.parentNode.insertBefore(o,e)}},t.decorators=[{type:i.Component,args:[{selector:"igo-auth-facebook",template:'<div scope="public_profile,email"\r\n     class="fb-login-button" data-max-rows="1" data-size="large"\r\n     data-button-type="continue_with" data-show-faces="false"\r\n     data-auto-logout-link="false" data-use-continue-as="false">\r\n</div>\r\n',changeDetection:i.ChangeDetectionStrategy.OnPush,styles:[".fb-login-button{padding:10px 0}"]}]}],t.ctorParameters=function(){return[{type:h},{type:p.ConfigService},{type:i.ApplicationRef}]},t.propDecorators={login:[{type:i.Output}]},t}(),v=function(){function t(t,e,o){this.authService=t,this.config=e,this.appRef=o,this.login=new i.EventEmitter,this.options=this.config.getConfig("auth.google")||{},this.options.apiKey&&this.options.clientId&&(this.loadSDKGoogle(),this.loadPlatform())}return t.prototype.handleSignInClick=function(){window.gapi.auth2.getAuthInstance().signIn()},t.prototype.handleSignOutClick=function(){window.gapi.auth2.getAuthInstance().signOut()},t.prototype.handleClientLoad=function(){var t=this;window.gapi.load("client:auth2",function(){return t.initClient()})},t.prototype.initClient=function(){var e=this;window.gapi.client.init({apiKey:this.options.apiKey,clientId:this.options.clientId,discoveryDocs:["https://people.googleapis.com/$discovery/rest?version=v1"],scope:"profile"}).then(function(){e.handleSignOutClick(),window.gapi.auth2.getAuthInstance().isSignedIn.listen(function(t){e.updateSigninStatus(t)})})},t.prototype.updateSigninStatus=function(t){t&&this.loginGoogle(window.gapi.client.getToken().access_token)},t.prototype.loginGoogle=function(t){var e=this;this.authService.loginWithToken(t,"google").subscribe(function(){e.appRef.tick(),e.login.emit(!0)})},t.prototype.loadSDKGoogle=function(){var t=this,e=document.getElementsByTagName("script")[0],o=document.createElement("script");o.id="google-jssdk",o.src="https://apis.google.com/js/api.js",o.onload=function(){t.handleClientLoad()},e.parentNode.insertBefore(o,e)},t.prototype.loadPlatform=function(){var t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.id="google-platform",e.src="https://apis.google.com/js/platform.js",t.parentNode.insertBefore(e,t)},t.decorators=[{type:i.Component,args:[{selector:"igo-auth-google",template:'<div class="g-signin2 google-login-button" data-height="40" data-width="265" data-longtitle="true">\r\n',changeDetection:i.ChangeDetectionStrategy.OnPush,styles:[".google-login-button{padding:10px 0}"]}]}],t.ctorParameters=function(){return[{type:h},{type:p.ConfigService},{type:i.ApplicationRef}]},t.propDecorators={login:[{type:i.Output}]},t}(),m=function(){function t(t,e,o){this.authService=t,this.config=e,this.router=o}return t.prototype.canActivate=function(t,e){if(this.authService.logged)return!0;this.authService.redirectUrl=e.url;var o=this.config.getConfig("auth");return o&&o.loginRoute&&this.router.navigateByUrl(o.loginRoute),!1},t.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:h},{type:p.ConfigService},{type:n.Router}]},t.ngInjectableDef=i.defineInjectable({factory:function(){return new t(i.inject(h),i.inject(p.ConfigService),i.inject(n.Router))},token:t,providedIn:"root"}),t}(),b=function(){function t(t,e,o){this.authService=t,this.config=e,this.router=o}return t.prototype.canActivate=function(t,e){if(this.authService.authenticated)return!0;this.authService.redirectUrl=e.url;var o=this.config.getConfig("auth");return o&&o.loginRoute&&this.router.navigateByUrl(o.loginRoute),!1},t.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:h},{type:p.ConfigService},{type:n.Router}]},t.ngInjectableDef=i.defineInjectable({factory:function(){return new t(i.inject(h),i.inject(p.ConfigService),i.inject(n.Router))},token:t,providedIn:"root"}),t}(),k=function(){function t(t,e,o){this.authService=t,this.config=e,this.router=o}return t.prototype.canActivate=function(t,e){var o=this.authService.decodeToken();if(o&&o.user&&o.user.isAdmin)return!0;this.authService.redirectUrl=e.url;var n=this.config.getConfig("auth");return n&&n.loginRoute&&this.router.navigateByUrl(n.loginRoute),!1},t.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:h},{type:p.ConfigService},{type:n.Router}]},t.ngInjectableDef=i.defineInjectable({factory:function(){return new t(i.inject(h),i.inject(p.ConfigService),i.inject(n.Router))},token:t,providedIn:"root"}),t}(),w=function(){function t(t,e,o){this.authService=t,this.config=e,this.router=o}return t.prototype.canActivate=function(t,o){var n=this;return this.authService.getProfils().pipe(a.map(function(t){var e=n.config.getConfig("auth");return!(!t||!t.some(function(t){return-1!==e.profilsGuard.indexOf(t)}))||(n.authService.redirectUrl=o.url,e&&e.loginRoute&&n.router.navigateByUrl(e.loginRoute),!1)}))},t.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:h},{type:p.ConfigService},{type:n.Router}]},t.ngInjectableDef=i.defineInjectable({factory:function(){return new t(i.inject(h),i.inject(p.ConfigService),i.inject(n.Router))},token:t,providedIn:"root"}),t}(),j=function(){function t(t,e){this.config=t,this.tokenService=e,this.trustHosts=[],this.trustHosts=this.config.getConfig("auth.trustHosts")||[],this.trustHosts.push(window.location.hostname)}return t.prototype.intercept=function(t,e){var o=this.tokenService.get(),n=document.createElement("a");if(n.href=t.url,!o&&-1===this.trustHosts.indexOf(n.hostname))return e.handle(t);var i="Bearer "+o,r=t.clone({headers:t.headers.set("Authorization",i)});return e.handle(r)},t.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:p.ConfigService},{type:g}]},t.ngInjectableDef=i.defineInjectable({factory:function(){return new t(i.inject(p.ConfigService),i.inject(g))},token:t,providedIn:"root"}),t}(),I=function(){function t(t,e){t.isAuthenticated()||e.nativeElement.parentNode.removeChild(e.nativeElement)}return t.decorators=[{type:i.Directive,args:[{selector:"[igoProtected]"}]}],t.ctorParameters=function(){return[{type:h},{type:i.ElementRef}]},t}(),S=[{path:"login",component:f},{path:"logout",component:f}],C=function(){function t(){}return t.decorators=[{type:i.NgModule,args:[{imports:[n.RouterModule.forChild(S)],exports:[n.RouterModule],providers:[]}]}],t}(),D=function(){function t(){}return t.forRoot=function(){return{ngModule:t,providers:[{provide:s.HTTP_INTERCEPTORS,useClass:j,multi:!0}]}},t.decorators=[{type:i.NgModule,args:[{imports:[u.CommonModule,c.ReactiveFormsModule,l.MatFormFieldModule,l.MatInputModule,l.MatButtonModule,p.IgoLanguageModule],declarations:[f,v,d,y,I],exports:[f,I]}]}],t}();t.AuthFormComponent=f,t.AuthService=h,t.LoggedGuard=m,t.AuthGuard=b,t.AdminGuard=k,t.ProfilsGuard=w,t.AuthInterceptor=j,t.ProtectedDirective=I,t.TokenService=g,t.AuthRoutingModule=C,t.IgoAuthModule=D,t.ɵd=y,t.ɵa=f,t.ɵb=v,t.ɵc=d,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=igo2-auth.umd.min.js.map