!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs/operators"),require("ol/proj"),require("ol/easing"),require("ol/geom/Point"),require("@angular/common/http"),require("rxjs"),require("@angular/animations"),require("@angular/forms"),require("@igo2/utils"),require("@igo2/auth"),require("@angular/common"),require("@angular/material"),require("@igo2/core"),require("@angular/core"),require("@angular/platform-browser"),require("@igo2/common"),require("@igo2/geo"),require("ol/format/GeoJSON")):"function"==typeof define&&define.amd?define("@igo2/context",["exports","rxjs/operators","ol/proj","ol/easing","ol/geom/Point","@angular/common/http","rxjs","@angular/animations","@angular/forms","@igo2/utils","@igo2/auth","@angular/common","@angular/material","@igo2/core","@angular/core","@angular/platform-browser","@igo2/common","@igo2/geo","ol/format/GeoJSON"],e):e((t.igo2=t.igo2||{},t.igo2.context={}),t.rxjs.operators,t.olproj,t.oleasing,t.olPoint,t.ng.common.http,t.rxjs,t.ng.animations,t.ng.forms,t.utils,t.i2,t.ng.common,t.ng.material,t.i1$1,t.ng.core,t.ng.platformBrowser,t.common$1,t.i3,t.olFormatGeoJSON)}(this,function(t,a,n,i,g,e,s,o,r,m,c,u,l,p,d,f,h,v,x){"use strict";function C(t){var e="function"==typeof Symbol&&t[Symbol.iterator],o=0;return e?e.call(t):{next:function(){return t&&o>=t.length&&(t=void 0),{value:t&&t[o++],done:!t}}}}function y(t,e){var o="function"==typeof Symbol&&t[Symbol.iterator];if(!o)return t;var n,i,r=o.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(n=r.next()).done;)a.push(n.value)}catch(s){i={error:s}}finally{try{n&&!n.done&&(o=r["return"])&&o.call(r)}finally{if(i)throw i.error}}return a}function b(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(y(arguments[e]));return t}g=g&&g.hasOwnProperty("default")?g["default"]:g,x=x&&x.hasOwnProperty("default")?x["default"]:x;var S={"null":0,read:1,write:2};S[S["null"]]="null",S[S.read]="read",S[S.write]="write";var M={"public":0,"protected":1,"private":2};M[M["public"]]="public",M[M["protected"]]="protected",M[M["private"]]="private";var I=function(){function t(t,e,o,n,i){var r=this;this.http=t,this.authService=e,this.languageService=o,this.config=n,this.route=i,this.context$=new s.BehaviorSubject(undefined),this.contexts$=new s.BehaviorSubject({ours:[]}),this.defaultContextId$=new s.BehaviorSubject(undefined),this.editedContext$=new s.BehaviorSubject(undefined),this.mapViewFromRoute={},this.options=Object.assign({basePath:"contexts",contextListFile:"_contexts.json",defaultContextUri:"_default"},this.config.getConfig("context")),this.baseUrl=this.options.url,this.readParamsFromRoute(),this.authService.authenticate$.subscribe(function(t){if(null!==t){var e=r.contexts$.subscribe(function(t){e&&(e.unsubscribe(),r.handleContextsChange(t))});r.loadContexts()}else r.loadDefaultContext()})}return t.prototype.get=function(){var t=this.baseUrl+"/contexts";return this.http.get(t)},t.prototype.getById=function(t){var e=this.baseUrl+"/contexts/"+t;return this.http.get(e)},t.prototype.getDetails=function(e){var o=this,t=this.baseUrl+"/contexts/"+e+"/details";return this.http.get(t).pipe(a.catchError(function(t){return o.handleError(t,e)}))},t.prototype.getDefault=function(){var e=this,t=this.baseUrl+"/contexts/default";return this.http.get(t).pipe(a.tap(function(t){e.defaultContextId$.next(t.id)}))},t.prototype.setDefault=function(t){var e=this.baseUrl+"/contexts/default";return this.http.post(e,{defaultContextId:t})},t.prototype["delete"]=function(o){var n=this,t=this.baseUrl+"/contexts/"+o;return this.http["delete"](t).pipe(a.tap(function(t){var e={ours:[]};Object.keys(n.contexts$.value).forEach(function(t){return e[t]=n.contexts$.value[t].filter(function(t){return t.id!==o})}),n.contexts$.next(e)}))},t.prototype.create=function(t){var e=this,o=this.baseUrl+"/contexts";return this.http.post(o,JSON.stringify(t)).pipe(a.map(function(t){return e.authService.authenticated?t.permission=S[S.write]:t.permission=S[S.read],e.contexts$.value.ours.push(t),e.contexts$.next(e.contexts$.value),t}))},t.prototype.clone=function(t,e){var o=this;void 0===e&&(e={});var n=this.baseUrl+"/contexts/"+t+"/clone";return this.http.post(n,JSON.stringify(e)).pipe(a.map(function(t){return t.permission=S[S.write],o.contexts$.value.ours.push(t),o.contexts$.next(o.contexts$.value),t}))},t.prototype.update=function(t,e){var o=this.baseUrl+"/contexts/"+t;return this.http.patch(o,JSON.stringify(e))},t.prototype.addToolAssociation=function(t,e){var o=this.baseUrl+"/contexts/"+t+"/tools",n={toolId:e};return this.http.post(o,JSON.stringify(n))},t.prototype.deleteToolAssociation=function(t,e){var o=this.baseUrl+"/contexts/"+t+"/tools/"+e;return this.http["delete"](o)},t.prototype.getPermissions=function(t){var e=this.baseUrl+"/contexts/"+t+"/permissions";return this.http.get(e)},t.prototype.addPermissionAssociation=function(t,e,o){var n=this.baseUrl+"/contexts/"+t+"/permissions",i={profil:e,typePermission:o};return this.http.post(n,JSON.stringify(i))},t.prototype.deletePermissionAssociation=function(t,e){var o=this.baseUrl+"/contexts/"+t+"/permissions/"+e;return this.http["delete"](o)},t.prototype.getLocalContexts=function(){var t=this.getPath(this.options.contextListFile);return this.http.get(t).pipe(a.map(function(t){return{ours:t}}))},t.prototype.getLocalContext=function(e){var o=this,t=this.getPath(e+".json");return this.http.get(t).pipe(a.catchError(function(t){return o.handleError(t,e)}))},t.prototype.loadContexts=function(){var n=this;(this.baseUrl?this.get():this.getLocalContexts()).subscribe(function(t){var e=n.contexts$.value["public"];if(e){var o=e.find(function(t){return t.uri===n.options.defaultContextUri});o&&(t["public"]||(t["public"]=[]),t["public"].push(o))}n.contexts$.next(t)})},t.prototype.loadDefaultContext=function(){var n=this,i=function(t){void 0===t&&(t=!1),!t&&n.baseUrl&&n.authService.authenticated?n.getDefault().subscribe(function(t){n.options.defaultContextUri=t.uri,n.addContextToList(t),n.setContext(t)},function(){n.defaultContextId$.next(undefined),n.loadContext(n.options.defaultContextUri)}):n.loadContext(n.options.defaultContextUri)};this.route&&this.route.options.contextKey?this.route.queryParams.pipe(a.debounceTime(100)).subscribe(function(t){var e=t[n.route.options.contextKey],o=!1;e&&(n.options.defaultContextUri=e,o=!0),i(o)}):i()},t.prototype.loadContext=function(t){var e=this,o=this.context$.value;if(!o||o.uri!==t)var n=this.getContextByUri(t).subscribe(function(t){n.unsubscribe(),e.addContextToList(t),e.setContext(t)},function(t){n.unsubscribe()})},t.prototype.setContext=function(t){var e=this.context$.value;if(e&&t&&t.id===e.id)return t.map.view.keepCurrentView===undefined&&(t.map.view.keepCurrentView=!0),void this.context$.next(t);t.map||(t.map={view:{}}),Object.assign(t.map.view,this.mapViewFromRoute),this.context$.next(t)},t.prototype.loadEditedContext=function(t){var e=this;this.getContextByUri(t).subscribe(function(t){e.setEditedContext(t)})},t.prototype.setEditedContext=function(t){this.editedContext$.next(t)},t.prototype.getContextFromMap=function(t){var e,o,n=t.ol.getView(),i=n.getProjection().getCode(),r=new g(n.getCenter()).transform(i,"EPSG:4326"),a={uri:m.uuid(),title:"",scope:"private",map:{view:{center:r.getCoordinates(),zoom:n.getZoom(),projection:i}},layers:[],tools:[]},s=t.layers$.getValue();try{for(var c=C(s),u=c.next();!u.done;u=c.next()){var l=u.value,p={id:l.options.id?String(l.options.id):undefined,title:l.options.title,zIndex:l.zIndex,visible:l.visible,sourceOptions:{type:l.dataSource.options.type,params:l.dataSource.options.params,url:l.dataSource.options.url}};a.layers.push(p)}}catch(d){e={error:d}}finally{try{u&&!u.done&&(o=c["return"])&&o.call(c)}finally{if(e)throw e.error}}return a.tools=this.tools.map(function(t){return String(t.id)}),a},t.prototype.setTools=function(t){this.tools=t},t.prototype.getContextByUri=function(e){var t,o;if(this.baseUrl){var n=void 0;try{for(var i=C(Object.keys(this.contexts$.value)),r=i.next();!r.done;r=i.next()){var a=r.value;if(n=this.contexts$.value[a].find(function(t){return t.uri===e}))break}}catch(c){t={error:c}}finally{try{r&&!r.done&&(o=i["return"])&&o.call(i)}finally{if(t)throw t.error}}var s=n?n.id:e;return this.getDetails(s)}return this.getLocalContext(e)},t.prototype.readParamsFromRoute=function(){var s=this;this.route&&this.route.queryParams.subscribe(function(t){var e=s.route.options.centerKey;if(e&&t[e]){var o=t[e];s.mapViewFromRoute.center=o.split(",").map(Number),s.mapViewFromRoute.geolocate=!1}var n=s.route.options.projectionKey;if(n&&t[n]){var i=t[n];s.mapViewFromRoute.projection=i}var r=s.route.options.zoomKey;if(r&&t[r]){var a=t[r];s.mapViewFromRoute.zoom=Number(a)}})},t.prototype.getPath=function(t){return this.options.basePath.replace(/\/$/,"")+"/"+t},t.prototype.handleError=function(t,e){var o=this.contexts$.value.ours.find(function(t){return t.uri===e}),n=o?o.title:e;throw[{title:this.languageService.translate.instant("igo.context.contextManager.invalid.title"),text:this.languageService.translate.instant("igo.context.contextManager.invalid.text",{value:n})}]},t.prototype.handleContextsChange=function(t,e){void 0===e&&(e=!1);var o=this.context$.value,n=this.editedContext$.value;e&&this.findContext(o)?(o.map.view.keepCurrentView===undefined&&(o.map.view.keepCurrentView=!0),this.context$.next(o),this.getDefault().subscribe(function(){})):this.loadDefaultContext();var i=this.findContext(n);i&&"write"===i.permission||this.setEditedContext(undefined)},t.prototype.addContextToList=function(t){if(!this.findContext(t)){var e={id:t.id,uri:t.uri,title:t.title,scope:t.scope,permission:S[S.read]};this.contexts$.value&&this.contexts$.value["public"]&&(this.contexts$.value["public"].push(e),this.contexts$.next(this.contexts$.value))}},t.prototype.findContext=function(e){var t,o;if(!e||!e.id)return!1;var n,i=this.contexts$.value;try{for(var r=C(Object.keys(i)),a=r.next();!a.done;a=r.next()){if(n=i[a.value].find(function(t){return t.id===e.id}))break}}catch(s){t={error:s}}finally{try{a&&!a.done&&(o=r["return"])&&o.call(r)}finally{if(t)throw t.error}}return n},t.decorators=[{type:d.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:e.HttpClient},{type:c.AuthService},{type:p.LanguageService},{type:p.ConfigService},{type:p.RouteService,decorators:[{type:d.Optional}]}]},t.ngInjectableDef=d.defineInjectable({factory:function(){return new t(d.inject(e.HttpClient),d.inject(c.AuthService),d.inject(p.LanguageService),d.inject(p.ConfigService),d.inject(p.RouteService,8))},token:t,providedIn:"root"}),t}(),P=function(){function t(t,e){this.contextService=e,this.component=t}return Object.defineProperty(t.prototype,"map",{get:function(){return this.component.map},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){var e=this;this.context$$=this.contextService.context$.pipe(a.filter(function(t){return t!==undefined})).subscribe(function(t){return e.handleContextChange(t)})},t.prototype.ngOnDestroy=function(){this.context$$.unsubscribe()},t.prototype.handleContextChange=function(t){if(t.map!==undefined){var e=t.map.view;!0!==e.keepCurrentView&&(this.component.view=e)}},t.decorators=[{type:d.Directive,args:[{selector:"[igoMapContext]"}]}],t.ctorParameters=function(){return[{type:v.MapBrowserComponent},{type:I}]},t}(),w=function(){function t(t,e,o,n){this.component=t,this.contextService=e,this.layerService=o,this.route=n,this.contextLayers=[]}return Object.defineProperty(t.prototype,"map",{get:function(){return this.component.map},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){var e=this;if(this.context$$=this.contextService.context$.pipe(a.filter(function(t){return t!==undefined})).subscribe(function(t){return e.handleContextChange(t)}),this.route&&this.route.options.visibleOnLayersKey&&this.route.options.visibleOffLayersKey&&this.route.options.contextKey)var o=this.route.queryParams.pipe(a.skip(1)).subscribe(function(t){e.queryParams=t,o.unsubscribe()})},t.prototype.ngOnDestroy=function(){this.context$$.unsubscribe()},t.prototype.handleContextChange=function(t){var r=this;t.layers!==undefined&&(this.map.removeLayers(this.contextLayers),this.contextLayers=[],s.zip.apply(void 0,b(t.layers.map(function(t,e){return r.layerService.createAsyncLayer(t).pipe(a.withLatestFrom(s.of(e)))}))).subscribe(function(t){var e=t.reduce(function(t,e){var o=y(e,2),n=o[0],i=o[1];return n.visible=r.computeLayerVisibilityFromUrl(n),n.zIndex=n.zIndex||i+1,t[i]=n,t},new Array(t.length));r.contextLayers=e,r.map.addLayers(e)}))},t.prototype.computeLayerVisibilityFromUrl=function(t){var e=this.queryParams,o=this.contextService.context$.value.uri,n=t.id,i=t.visible;if(!e||!n)return i;var r=e[this.route.options.contextKey];if(r===o||!r){var a="",s="",c=[],u=[];this.route.options.visibleOnLayersKey&&e[this.route.options.visibleOnLayersKey]&&(a=e[this.route.options.visibleOnLayersKey]),this.route.options.visibleOffLayersKey&&e[this.route.options.visibleOffLayersKey]&&(s=e[this.route.options.visibleOffLayersKey]),"*"===a&&(i=!0),"*"===s&&(i=!1),c=a.split(","),u=s.split(","),-1<c.indexOf(n)&&(i=!0),-1<u.indexOf(n)&&(i=!1)}return i},t.decorators=[{type:d.Directive,args:[{selector:"[igoLayerContext]"}]}],t.ctorParameters=function(){return[{type:v.MapBrowserComponent},{type:I},{type:v.LayerService},{type:p.RouteService,decorators:[{type:d.Optional}]}]},t}(),O=function(){function t(t){this.cdRef=t,this._contexts={ours:[]},this.select=new d.EventEmitter,this.unselect=new d.EventEmitter,this.edit=new d.EventEmitter,this["delete"]=new d.EventEmitter,this.save=new d.EventEmitter,this.clone=new d.EventEmitter,this.favorite=new d.EventEmitter,this.managePermissions=new d.EventEmitter,this.manageTools=new d.EventEmitter,this.titleMapping={ours:"igo.context.contextManager.ourContexts",shared:"igo.context.contextManager.sharedContexts","public":"igo.context.contextManager.publicContexts"}}return Object.defineProperty(t.prototype,"contexts",{get:function(){return this._contexts},set:function(t){this._contexts=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selectedContext",{get:function(){return this._selectedContext},set:function(t){this._selectedContext=t,this.cdRef.detectChanges()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defaultContextId",{get:function(){return this._defaultContextId},set:function(t){this._defaultContextId=t},enumerable:!0,configurable:!0}),t.decorators=[{type:d.Component,args:[{selector:"igo-context-list",template:'<igo-list [navigation]="true">\r\n  <ng-template ngFor let-groupContexts [ngForOf]="contexts | keyvalue">\r\n    <igo-collapsible *ngIf="groupContexts.value.length" [title]="titleMapping[groupContexts.key] | translate">\r\n\r\n      <ng-template ngFor let-context [ngForOf]="groupContexts.value">\r\n        <igo-context-item\r\n          igoListItem\r\n          color="accent"\r\n          [selected]="selectedContext && selectedContext.uri === context.uri"\r\n          [context]="context"\r\n          [default]="this.defaultContextId === context.id"\r\n          (edit)="edit.emit(context)"\r\n          (delete)="delete.emit(context)"\r\n          (clone)="clone.emit(context)"\r\n          (save)="save.emit(context)"\r\n          (favorite)="favorite.emit(context)"\r\n          (manageTools)="manageTools.emit(context)"\r\n          (managePermissions)="managePermissions.emit(context)"\r\n          (select)="select.emit(context)"\r\n          (unselect)="unselect.emit(context)">\r\n        </igo-context-item>\r\n      </ng-template>\r\n\r\n    </igo-collapsible>\r\n  </ng-template>\r\n</igo-list>\r\n'}]}],t.ctorParameters=function(){return[{type:d.ChangeDetectorRef}]},t.propDecorators={contexts:[{type:d.Input}],selectedContext:[{type:d.Input}],defaultContextId:[{type:d.Input}],select:[{type:d.Output}],unselect:[{type:d.Output}],edit:[{type:d.Output}],"delete":[{type:d.Output}],save:[{type:d.Output}],clone:[{type:d.Output}],favorite:[{type:d.Output}],managePermissions:[{type:d.Output}],manageTools:[{type:d.Output}]},t}(),k=function(){function t(t,e,o,n,i,r){this.contextService=e,this.mapService=o,this.languageService=n,this.confirmDialogService=i,this.messageService=r,this.component=t}return t.prototype.onSelect=function(t){this.contextService.loadContext(t.uri)},t.prototype.onEdit=function(t){this.contextService.loadEditedContext(t.uri)},t.prototype.onSave=function(n){var i=this,t=this.mapService.getMap(),e=this.contextService.getContextFromMap(t),o={layers:e.layers,map:{view:e.map.view}};this.contextService.update(n.id,o).subscribe(function(){var t=i.languageService.translate,e=t.instant("igo.context.contextManager.dialog.saveMsg",{value:n.title}),o=t.instant("igo.context.contextManager.dialog.saveTitle");i.messageService.success(e,o)})},t.prototype.onFavorite=function(n){var i=this;this.contextService.setDefault(n.id).subscribe(function(){i.contextService.defaultContextId$.next(n.id);var t=i.languageService.translate,e=t.instant("igo.context.contextManager.dialog.favoriteMsg",{value:n.title}),o=t.instant("igo.context.contextManager.dialog.favoriteTitle");i.messageService.success(e,o)})},t.prototype.onManageTools=function(t){this.contextService.loadEditedContext(t.uri)},t.prototype.onManagePermissions=function(t){this.contextService.loadEditedContext(t.uri)},t.prototype.onDelete=function(o){var n=this,i=this.languageService.translate;this.confirmDialogService.open(i.instant("igo.context.contextManager.dialog.confirmDelete")).subscribe(function(t){t&&n.contextService["delete"](o.id).subscribe(function(){var t=i.instant("igo.context.contextManager.dialog.deleteMsg",{value:o.title}),e=i.instant("igo.context.contextManager.dialog.deleteTitle");n.messageService.info(t,e)})})},t.prototype.onClone=function(n){var i=this,t={title:n.title+"-copy",uri:n.uri+"-copy"};this.contextService.clone(n.id,t).subscribe(function(){var t=i.languageService.translate,e=t.instant("igo.context.contextManager.dialog.cloneMsg",{value:n.title}),o=t.instant("igo.context.contextManager.dialog.cloneTitle");i.messageService.success(e,o)})},t.prototype.ngOnInit=function(){var e=this;this.component.contexts={ours:[]},this.contexts$$=this.contextService.contexts$.subscribe(function(t){return e.handleContextsChange(t)}),this.defaultContextId$$=this.contextService.defaultContextId$.subscribe(function(t){e.component.defaultContextId=t}),this.selectedContext$$=this.contextService.context$.pipe(a.debounceTime(100)).subscribe(function(t){return e.component.selectedContext=t}),this.contextService.loadContexts()},t.prototype.ngOnDestroy=function(){this.contexts$$.unsubscribe(),this.selectedContext$$.unsubscribe(),this.defaultContextId$$.unsubscribe()},t.prototype.handleContextsChange=function(t){this.component.contexts=t},t.decorators=[{type:d.Directive,args:[{selector:"[igoContextListBinding]"}]}],t.ctorParameters=function(){return[{type:O,decorators:[{type:d.Self}]},{type:I},{type:v.MapService},{type:p.LanguageService},{type:h.ConfirmDialogService},{type:p.MessageService}]},t.propDecorators={onSelect:[{type:d.HostListener,args:["select",["$event"]]}],onEdit:[{type:d.HostListener,args:["edit",["$event"]]}],onSave:[{type:d.HostListener,args:["save",["$event"]]}],onFavorite:[{type:d.HostListener,args:["favorite",["$event"]]}],onManageTools:[{type:d.HostListener,args:["manageTools",["$event"]]}],onManagePermissions:[{type:d.HostListener,args:["managePermissions",["$event"]]}],onDelete:[{type:d.HostListener,args:["delete",["$event"]]}],onClone:[{type:d.HostListener,args:["clone",["$event"]]}]},t}(),L=function(){function t(t){this.auth=t,this.typePermission=S,this.color="primary",this.collapsed=!0,this._default=!1,this.edit=new d.EventEmitter,this["delete"]=new d.EventEmitter,this.save=new d.EventEmitter,this.clone=new d.EventEmitter,this.favorite=new d.EventEmitter,this.managePermissions=new d.EventEmitter,this.manageTools=new d.EventEmitter}return Object.defineProperty(t.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"default",{get:function(){return this._default},set:function(t){this._default=t},enumerable:!0,configurable:!0}),t.prototype.favoriteClick=function(t){this.auth.authenticated&&this.favorite.emit(t)},t.decorators=[{type:d.Component,args:[{selector:"igo-context-item",template:'<mat-list-item>\r\n  <button mat-list-avatar\r\n    mat-icon-button\r\n    igoStopPropagation\r\n    [matTooltip]="\'igo.context.contextManager.favorite\' | translate"\r\n    matTooltipShowDelay="500"\r\n    [color]="default ? \'primary\' : \'default\'"\r\n    (click)="favoriteClick(context)">\r\n    <mat-icon *ngIf="!context.iconImage" svgIcon="{{context.icon ? context.icon : context.scope === \'public\' ? \'earth\' : \'star\'}}"></mat-icon>\r\n    <img *ngIf="context.iconImage" [src]="context.iconImage">\r\n  </button>\r\n  <h4 matLine>{{context.title}}</h4>\r\n\r\n  <div *ngIf="auth.authenticated && context.permission === typePermission[typePermission.read]"\r\n       igoStopPropagation\r\n       class="igo-actions-container">\r\n\r\n       <button\r\n         mat-icon-button\r\n         [matTooltip]="\'igo.context.contextManager.clone\' | translate"\r\n         matTooltipShowDelay="500"\r\n         [color]="color"\r\n         (click)="clone.emit(context)">\r\n         <mat-icon svgIcon="content-copy"></mat-icon>\r\n       </button>\r\n </div>\r\n\r\n\r\n  <div *ngIf="context.permission === typePermission[typePermission.write]"\r\n       igoStopPropagation\r\n       class="igo-actions-container">\r\n\r\n     <button *ngIf="collapsed"\r\n       mat-icon-button\r\n       [matTooltip]="\'igo.context.contextManager.save\' | translate"\r\n       matTooltipShowDelay="500"\r\n       [color]="color"\r\n       (click)="save.emit(context)">\r\n       <mat-icon svgIcon="content-save"></mat-icon>\r\n     </button>\r\n\r\n    <div #actions class="igo-actions-expand-container">\r\n\r\n      <button\r\n        mat-icon-button\r\n        [matTooltip]="\'igo.context.contextManager.managePermissions\' | translate"\r\n        matTooltipShowDelay="500"\r\n        [color]="color"\r\n        (click)="managePermissions.emit(context)">\r\n        <mat-icon svgIcon="account-outline"></mat-icon>\r\n      </button>\r\n\r\n      \x3c!--button\r\n        mat-icon-button\r\n        [matTooltip]="\'igo.context.contextManager.manageTools\' | translate"\r\n        [color]="color"\r\n        (click)="manageTools.emit(context)">\r\n        <mat-icon svgIcon="widgets"></mat-icon>\r\n      </button--\x3e\r\n\r\n      <button\r\n        mat-icon-button\r\n        [matTooltip]="\'igo.context.contextManager.clone\' | translate"\r\n        matTooltipShowDelay="500"\r\n        [color]="color"\r\n        (click)="clone.emit(context)">\r\n        <mat-icon svgIcon="content-copy"></mat-icon>\r\n      </button>\r\n\r\n      <button\r\n        mat-icon-button\r\n        [color]="color"\r\n        [matTooltip]="\'igo.context.contextManager.edit\' | translate"\r\n        matTooltipShowDelay="500"\r\n        (click)="edit.emit(context)">\r\n        <mat-icon svgIcon="pencil"></mat-icon>\r\n      </button>\r\n\r\n      <button\r\n        mat-icon-button\r\n        color="warn"\r\n        [matTooltip]="\'igo.context.contextManager.delete\' | translate"\r\n        matTooltipShowDelay="500"\r\n        (click)="delete.emit(context)">\r\n        <mat-icon svgIcon="delete"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <button\r\n      mat-icon-button\r\n      igoCollapse\r\n      [color]="color"\r\n      [target]="actions"\r\n      [collapsed]=collapsed\r\n      (click)="collapsed = !collapsed">\r\n      <mat-icon svgIcon="dots-horizontal"></mat-icon>\r\n    </button>\r\n\r\n  </div>\r\n\r\n</mat-list-item>\r\n',styles:[":host{overflow:hidden}.igo-actions-container{flex-shrink:0}.igo-actions-expand-container{display:inline-flex}mat-list-item>>>.mat-list-item-content .mat-list-text{padding:0}mat-list-item>>>.mat-list-item-content .mat-list-text>h4{padding:0 16px}mat-icon.disabled{color:rgba(0,0,0,.38)}"]}]}],t.ctorParameters=function(){return[{type:c.AuthService}]},t.propDecorators={context:[{type:d.Input}],"default":[{type:d.Input}],edit:[{type:d.Output}],"delete":[{type:d.Output}],save:[{type:d.Output}],clone:[{type:d.Output}],favorite:[{type:d.Output}],managePermissions:[{type:d.Output}],manageTools:[{type:d.Output}]},t}(),T=function(){function t(t){this.formBuilder=t,this._disabled=!1,this.submitForm=new d.EventEmitter,this.clone=new d.EventEmitter,this["delete"]=new d.EventEmitter}return Object.defineProperty(t.prototype,"btnSubmitText",{get:function(){return this._btnSubmitText},set:function(t){this._btnSubmitText=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t,this.buildForm()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"disabled",{get:function(){return this._disabled},set:function(t){this._disabled=t},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){this.buildForm()},t.prototype.handleFormSubmit=function(t){var e=Object.assign({},t);(e=m.ObjectUtils.removeNull(e)).uri=e.uri.replace(" ",""),e.uri?e.uri=this.prefix+"-"+e.uri:e.uri=this.prefix,this.submitForm.emit(e)},t.prototype.buildForm=function(){var t=this.context||{},e=t.uri.split("-");this.prefix=e.shift();var o=e.join("-");this.form=this.formBuilder.group({title:[t.title],uri:[o||" "]})},t.decorators=[{type:d.Component,args:[{selector:"igo-context-form",template:'<form class="igo-form" [formGroup]="form"\r\n  (ngSubmit)="handleFormSubmit(form.value)">\r\n\r\n  <mat-form-field class="full-width">\r\n    <input matInput required\r\n           [placeholder]="\'igo.context.contextManager.form.title\' | translate"\r\n           formControlName="title">\r\n   <mat-error>\r\n    {{ \'igo.context.contextManager.form.titleRequired\' | translate }}\r\n   </mat-error>\r\n  </mat-form-field>\r\n\r\n  <mat-form-field id="uriInput" class="full-width">\r\n    <span *ngIf="prefix" class="prefix">{{prefix}}-</span>\r\n    <span class="fieldWrapper">\r\n      <input matInput\r\n           [placeholder]="\'igo.context.contextManager.form.uri\' | translate"\r\n           formControlName="uri">\r\n    </span>\r\n  </mat-form-field>\r\n\r\n  <div class="igo-form-button-group">\r\n    <button\r\n      mat-raised-button\r\n      type="submit"\r\n      [disabled]="!form.valid || disabled">\r\n      {{ \'igo.context.contextManager.form.edit\' | translate }}\r\n    </button>\r\n  </div>\r\n\r\n</form>\r\n',styles:[".full-width{width:100%}#uriInput .fieldWrapper{display:block;overflow:hidden}#uriInput .prefix{float:left}"]}]}],t.ctorParameters=function(){return[{type:r.FormBuilder}]},t.propDecorators={btnSubmitText:[{type:d.Input}],context:[{type:d.Input}],disabled:[{type:d.Input}],submitForm:[{type:d.Output}],clone:[{type:d.Output}],"delete":[{type:d.Output}]},t}(),$=function(){function t(){this.submitForm=new d.EventEmitter}return Object.defineProperty(t.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t},enumerable:!0,configurable:!0}),t.decorators=[{type:d.Component,args:[{selector:"igo-context-edit",template:'<igo-context-form *ngIf="context"\r\n   [btnSubmitText]="\'igo.context.contextManager.save\' | translate"\r\n   [context]="context"\r\n   (submitForm)="submitForm.emit($event)">\r\n</igo-context-form>\r\n'}]}],t.ctorParameters=function(){return[]},t.propDecorators={context:[{type:d.Input}],submitForm:[{type:d.Output}]},t}(),E=function(){function t(t,e,o,n){this.contextService=e,this.messageService=o,this.languageService=n,this.component=t}return t.prototype.onEdit=function(n){var i=this,t=this.component.context.id;this.contextService.update(t,n).subscribe(function(){var t=i.languageService.translate,e=t.instant("igo.context.contextManager.dialog.saveMsg",{value:n.title||i.component.context.title}),o=t.instant("igo.context.contextManager.dialog.saveTitle");i.messageService.success(e,o)})},t.prototype.ngOnInit=function(){var e=this;this.editedContext$$=this.contextService.editedContext$.subscribe(function(t){return e.handleEditedContextChange(t)})},t.prototype.ngOnDestroy=function(){this.editedContext$$.unsubscribe()},t.prototype.handleEditedContextChange=function(t){this.component.context=t},t.decorators=[{type:d.Directive,args:[{selector:"[igoContextEditBinding]"}]}],t.ctorParameters=function(){return[{type:$,decorators:[{type:d.Self}]},{type:I},{type:p.MessageService},{type:p.LanguageService}]},t.propDecorators={onEdit:[{type:d.HostListener,args:["submitForm",["$event"]]}]},t}(),j=function(){function t(t){this.formBuilder=t,this.addPermission=new d.EventEmitter,this.removePermission=new d.EventEmitter,this.scopeChanged=new d.EventEmitter}return Object.defineProperty(t.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"permissions",{get:function(){return this._permissions},set:function(t){this._permissions=t},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){this.buildForm()},t.prototype.handleFormSubmit=function(t){this.addPermission.emit(t)},t.prototype.buildForm=function(){this.form=this.formBuilder.group({profil:[],typePermission:["read"]})},t.decorators=[{type:d.Component,args:[{selector:"igo-context-permissions",template:'<div *ngIf="context">\r\n\r\n  <div class="scopeForm">\r\n    <mat-radio-group [(ngModel)]="context.scope"\r\n                    (change)="scopeChanged.emit(context)">\r\n      <mat-radio-button value="private">\r\n        {{ \'igo.context.permission.scope.private\' | translate }}\r\n      </mat-radio-button>\r\n      <mat-radio-button value="protected">\r\n        {{ \'igo.context.permission.scope.protected\' | translate }}\r\n      </mat-radio-button>\r\n      <mat-radio-button value="public">\r\n        {{ \'igo.context.permission.scope.public\' | translate }}\r\n      </mat-radio-button>\r\n    </mat-radio-group>\r\n  </div>\r\n\r\n  <form *ngIf="context.scope !== \'private\'" [formGroup]="form"\r\n    (ngSubmit)="handleFormSubmit(form.value)">\r\n\r\n    <mat-form-field class="full-width">\r\n      <input matInput required\r\n             [placeholder]="\'igo.context.permission.profil\' | translate"\r\n             formControlName="profil">\r\n     <mat-error>\r\n       {{ \'igo.context.permission.profilRequired\' | translate }}\r\n     </mat-error>\r\n    </mat-form-field>\r\n\r\n\r\n    <mat-radio-group formControlName="typePermission">\r\n      <mat-radio-button value="read">\r\n        {{ \'igo.context.permission.read\' | translate }}\r\n      </mat-radio-button>\r\n      <mat-radio-button value="write">\r\n        {{ \'igo.context.permission.write\' | translate }}\r\n      </mat-radio-button>\r\n    </mat-radio-group>\r\n\r\n\r\n    <div class="igo-form-button-group">\r\n      <button\r\n        mat-raised-button\r\n        type="submit"\r\n        [disabled]="!form.valid">\r\n        {{ \'igo.context.permission.addBtn\' | translate }}\r\n      </button>\r\n    </div>\r\n\r\n  </form>\r\n\r\n  <igo-list *ngIf="permissions && context.scope !== \'private\'">\r\n    <ng-template ngFor let-groupPermissions [ngForOf]="permissions | keyvalue">\r\n      <igo-collapsible\r\n        *ngIf="groupPermissions.value.length"\r\n        [title]="\'igo.context.permission.\' + groupPermissions.key | translate">\r\n\r\n        <ng-template ngFor let-permission [ngForOf]="groupPermissions.value">\r\n          <mat-list-item>\r\n            <mat-icon mat-list-avatar svgIcon="account-outline"></mat-icon>\r\n            <h4 mat-line>{{permission.profil}}</h4>\r\n\r\n            <div igoStopPropagation\r\n                 class="igo-actions-container">\r\n\r\n               <button\r\n                 mat-icon-button\r\n                 [matTooltip]="\'igo.context.permission.delete\' | translate"\r\n                 matTooltipShowDelay="500"\r\n                 color="warn"\r\n                 (click)="removePermission.emit(permission)">\r\n                 <mat-icon svgIcon="delete"></mat-icon>\r\n               </button>\r\n            </div>\r\n\r\n          </mat-list-item>\r\n        </ng-template>\r\n      </igo-collapsible>\r\n    </ng-template>\r\n  </igo-list>\r\n\r\n</div>\r\n',styles:[":host{margin:0 10px}.full-width{width:100%}mat-radio-button{padding:14px 14px 14px 0}.scopeForm,form{padding:5px}"]}]}],t.ctorParameters=function(){return[{type:r.FormBuilder}]},t.propDecorators={context:[{type:d.Input}],permissions:[{type:d.Input}],addPermission:[{type:d.Output}],removePermission:[{type:d.Output}],scopeChanged:[{type:d.Output}]},t}(),B=function(){function t(t,e,o,n){this.contextService=e,this.languageService=o,this.messageService=n,this.component=t}return t.prototype.onAddPermission=function(p){var d=this,t=this.component.context.id;this.contextService.addPermissionAssociation(t,p.profil,p.typePermission).subscribe(function(t){var e,o;try{for(var n=C(t),i=n.next();!i.done;i=n.next()){var r=i.value;d.component.permissions[p.typePermission].push(r)}}catch(l){e={error:l}}finally{try{i&&!i.done&&(o=n["return"])&&o.call(n)}finally{if(e)throw e.error}}var a=p.profil,s=d.languageService.translate,c=s.instant("igo.context.permission.dialog.addMsg",{value:a}),u=s.instant("igo.context.permission.dialog.addTitle");d.messageService.success(c,u)})},t.prototype.onRemovePermission=function(r){var a=this,t=this.component.context.id;this.contextService.deletePermissionAssociation(t,r.id).subscribe(function(){var t=a.component.permissions[r.typePermission].findIndex(function(t){return t.id===r.id});a.component.permissions[r.typePermission].splice(t,1);var e=r.profil,o=a.languageService.translate,n=o.instant("igo.context.permission.dialog.deleteMsg",{value:e}),i=o.instant("igo.context.permission.dialog.deleteTitle");a.messageService.success(n,i)})},t.prototype.onScopeChanged=function(t){var n=this,i=t.scope;this.contextService.update(t.id,{scope:i}).subscribe(function(){var t=n.languageService.translate,e=t.instant("igo.context.permission.dialog.scopeChangedMsg",{value:t.instant("igo.context.permission.scope."+i)}),o=t.instant("igo.context.permission.dialog.scopeChangedTitle");n.messageService.success(e,o)})},t.prototype.ngOnInit=function(){var e=this;this.editedContext$$=this.contextService.editedContext$.subscribe(function(t){return e.handleEditedContextChange(t)})},t.prototype.ngOnDestroy=function(){this.editedContext$$.unsubscribe()},t.prototype.handleEditedContextChange=function(t){var o=this;(this.component.context=t)&&this.contextService.getPermissions(t.id).subscribe(function(t){var e={read:(t=t||[]).filter(function(t){return"read"===t.typePermission.toString()}),write:t.filter(function(t){return"write"===t.typePermission.toString()})};return o.component.permissions=e})},t.decorators=[{type:d.Directive,args:[{selector:"[igoContextPermissionsBinding]"}]}],t.ctorParameters=function(){return[{type:j,decorators:[{type:d.Self}]},{type:I},{type:p.LanguageService},{type:p.MessageService}]},t.propDecorators={onAddPermission:[{type:d.HostListener,args:["addPermission",["$event"]]}],onRemovePermission:[{type:d.HostListener,args:["removePermission",["$event"]]}],onScopeChanged:[{type:d.HostListener,args:["scopeChanged",["$event"]]}]},t}(),D=[P,w],F=function(){function t(){}return t.forRoot=function(){return{ngModule:t}},t.decorators=[{type:d.NgModule,args:[{imports:[u.CommonModule,r.FormsModule,r.ReactiveFormsModule,l.MatFormFieldModule,l.MatInputModule,l.MatIconModule,l.MatButtonModule,l.MatTooltipModule,l.MatListModule,l.MatCheckboxModule,l.MatRadioModule,c.IgoAuthModule,h.IgoListModule,h.IgoKeyValueModule,h.IgoCollapsibleModule,h.IgoStopPropagationModule,p.IgoLanguageModule],exports:b([O,k,L,T,$,E,j,B],D),declarations:b([O,k,L,T,$,E,j,B],D)}]}],t}(),_=function(){function t(t){this.dialogRef=t}return t.decorators=[{type:d.Component,args:[{selector:"igo-bookmark-dialog",template:'<h1 mat-dialog-title>{{ \'igo.context.bookmarkButton.dialog.title\' | translate }}</h1>\r\n<div mat-dialog-content>\r\n  <mat-form-field>\r\n    <input matInput required autocomplete="off"\r\n      [placeholder]="\'igo.context.bookmarkButton.dialog.placeholder\' | translate"\r\n      [(ngModel)]="title">\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color="primary"\r\n         [disabled]="!title"\r\n         (click)="dialogRef.close(title)">\r\n    {{\'igo.common.confirmDialog.confirmBtn\' | translate}}\r\n  </button>\r\n  <button mat-button\r\n          (click)="dialogRef.close(false)">\r\n    {{\'igo.common.confirmDialog.cancelBtn\' | translate}}\r\n  </button>\r\n</div>\r\n'}]}],t.ctorParameters=function(){return[{type:l.MatDialogRef}]},t}(),R=function(){function t(t,e,o,n){this.dialog=t,this.contextService=e,this.languageService=o,this.messageService=n}return Object.defineProperty(t.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t},enumerable:!0,configurable:!0}),t.prototype.createContext=function(){var i=this;this.dialog.open(_,{disableClose:!1}).afterClosed().subscribe(function(t){if(t){var n=i.contextService.getContextFromMap(i.map);n.title=t,i.contextService.create(n).subscribe(function(){var t=i.languageService.translate,e=t.instant("igo.context.bookmarkButton.dialog.createTitle"),o=t.instant("igo.context.bookmarkButton.dialog.createMsg",{value:n.title});i.messageService.success(o,e)})}})},t.decorators=[{type:d.Component,args:[{selector:"igo-bookmark-button",template:'<div class="igo-bookmark-button-container">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]="\'igo.context.bookmarkButton.create\' | translate"\r\n    matTooltipPosition="above"\r\n    [color]="color"\r\n    (click)="createContext()">\r\n    <mat-icon svgIcon="bookmark"></mat-icon>\r\n  </button>\r\n</div>\r\n',styles:[".igo-bookmark-button-container{width:40px}.igo-bookmark-button-container button{background-color:#fff}.igo-bookmark-button-container button:hover{background-color:#efefef}:host>>>button .mat-button-ripple-round,button{border-radius:0}"]}]}],t.ctorParameters=function(){return[{type:l.MatDialog},{type:I},{type:p.LanguageService},{type:p.MessageService}]},t.propDecorators={map:[{type:d.Input}],color:[{type:d.Input}]},t}(),U=function(){function t(t,e){this.http=t,this.config=e,this.baseUrl=this.config.getConfig("context.url")}return t.prototype.get=function(){if(!this.baseUrl)return s.EMPTY;var t=this.baseUrl+"/pois";return this.http.get(t)},t.prototype["delete"]=function(t){var e=this.baseUrl+"/pois/"+t;return this.http["delete"](e)},t.prototype.create=function(t){var e=this.baseUrl+"/pois";return this.http.post(e,JSON.stringify(t))},t.decorators=[{type:d.Injectable}],t.ctorParameters=function(){return[{type:e.HttpClient},{type:p.ConfigService}]},t}(),q=function(){function t(t){this.dialogRef=t}return t.decorators=[{type:d.Component,args:[{selector:"igo-poi-dialog",template:'<h1 mat-dialog-title>{{ \'igo.context.poiButton.dialog.title\' | translate }}</h1>\r\n<div mat-dialog-content>\r\n  <mat-form-field>\r\n    <input matInput required autocomplete="off"\r\n      [placeholder]="\'igo.context.poiButton.dialog.placeholder\' | translate"\r\n      [(ngModel)]="title">\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color="primary"\r\n         [disabled]="!title"\r\n         (click)="dialogRef.close(title)">\r\n    {{\'igo.common.confirmDialog.confirmBtn\' | translate}}\r\n  </button>\r\n  <button mat-button\r\n          (click)="dialogRef.close(false)">\r\n    {{\'igo.common.confirmDialog.cancelBtn\' | translate}}\r\n  </button>\r\n</div>\r\n'}]}],t.ctorParameters=function(){return[{type:l.MatDialogRef}]},t}(),A=function(){function t(t,e,o,n,i,r){this.dialog=t,this.authService=e,this.poiService=o,this.messageService=n,this.languageService=i,this.confirmDialogService=r}return Object.defineProperty(t.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){var e=this;this.authenticate$$=this.authService.authenticate$.subscribe(function(t){t&&e.getPois()})},t.prototype.ngOnDestroy=function(){this.authenticate$$.unsubscribe()},t.prototype.deletePoi=function(o){var n=this;if(o&&o.id){var i=this.languageService.translate;this.confirmDialogService.open(i.instant("igo.context.poiButton.dialog.confirmDelete")).subscribe(function(t){t&&n.poiService["delete"](o.id).subscribe(function(){var t=i.instant("igo.context.poiButton.dialog.deleteTitle"),e=i.instant("igo.context.poiButton.dialog.deleteMsg",{value:o.title});n.messageService.info(e,t),n.pois=n.pois.filter(function(t){return t.id!==o.id})},function(t){t.error.title="DELETE Pois",n.messageService.showError(t)})})}},t.prototype.getPois=function(){var e=this;this.poiService.get().subscribe(function(t){e.pois=t},function(t){t.error.title="GET Pois",e.messageService.showError(t)})},t.prototype.createPoi=function(){var i=this,t=this.map.ol.getView(),e=t.getProjection().getCode(),o=new g(t.getCenter()).transform(e,"EPSG:4326"),r={title:"",x:o.getCoordinates()[0],y:o.getCoordinates()[1],zoom:t.getZoom()};this.dialog.open(q,{disableClose:!1}).afterClosed().subscribe(function(t){t&&(r.title=t,i.poiService.create(r).subscribe(function(t){var e=i.languageService.translate,o=e.instant("igo.context.poiButton.dialog.createTitle"),n=e.instant("igo.context.poiButton.dialog.createMsg",{value:r.title});i.messageService.success(n,o),r.id=t.id,i.pois.push(r)},function(t){t.error.title="POST Pois",i.messageService.showError(t)}))})},t.prototype.zoomOnPoi=function(e){var t=this.pois.find(function(t){return t.id===e}),o=n.fromLonLat([Number(t.x),Number(t.y)],this.map.projection);this.map.ol.getView().animate({center:o,zoom:t.zoom,duration:500,easing:i.easeOut})},t.decorators=[{type:d.Component,args:[{selector:"igo-poi-button",template:'<mat-select [placeholder]="\'igo.context.poiButton.placeholder\' | translate"\r\n           floatPlaceholder="never">\r\n\r\n  <mat-option (click)="createPoi()">\r\n    <div class="titlePoi">{{ \'igo.context.poiButton.create\' | translate }}</div>\r\n    <button igoStopPropagation class="addPoi buttonPoi"\r\n      mat-icon-button\r\n      color="primary"\r\n      (click)="createPoi()">\r\n      <mat-icon svgIcon="plus-circle"></mat-icon>\r\n    </button>\r\n  </mat-option>\r\n  <mat-option *ngFor="let poi of pois" [value]="poi.id" (click)="zoomOnPoi(poi.id)">\r\n    <div class="titlePoi">{{ poi.title }}</div>\r\n    <button igoStopPropagation class="deletePoi buttonPoi"\r\n      mat-icon-button\r\n      color="warn"\r\n      (click)="deletePoi(poi)">\r\n      <mat-icon svgIcon="delete"></mat-icon>\r\n    </button>\r\n  </mat-option>\r\n</mat-select>\r\n',styles:["mat-select{width:150px;background-color:#fff;height:40px;padding-top:0}mat-select>>>.mat-select-trigger{height:40px}mat-select>>>.mat-select-placeholder,mat-select>>>.mat-select-value-text{padding:5px;top:12px;position:relative}.mat-option{text-overflow:inherit}.titlePoi{max-width:135px;overflow:hidden;text-overflow:ellipsis;float:left}.buttonPoi{float:right;margin:4px -10px 4px 0}.buttonPoi>>>.mat-icon{margin:0 8px}"]}]}],t.ctorParameters=function(){return[{type:l.MatDialog},{type:c.AuthService},{type:U},{type:p.MessageService},{type:p.LanguageService},{type:h.ConfirmDialogService}]},t.propDecorators={map:[{type:d.Input}],color:[{type:d.Input}]},t}(),z=function(){function t(t,e){this.dialogRef=t,this.auth=e;var o=this.auth.decodeToken();this.user=o.user,this.exp=new Date(1e3*o.exp).toLocaleString()}return t.decorators=[{type:d.Component,args:[{selector:"igo-user-dialog",template:"<h1 mat-dialog-title>{{'igo.context.userButton.infoTitle' | translate}}</h1>\r\n<div mat-dialog-content>\r\n  <p>{{'igo.context.userButton.dialog.user' | translate}}: {{user.sourceId}}</p>\r\n  <p>{{'igo.context.userButton.dialog.email' | translate}}: {{user.email}}</p>\r\n  <p>{{'igo.context.userButton.dialog.expiration' | translate}}: {{exp}}</p>\r\n</div>\r\n<div mat-dialog-actions style=\"justify-content: center\">\r\n  <button mat-button color=\"primary\"\r\n         (click)=\"dialogRef.close(false)\">\r\n    OK\r\n  </button>\r\n</div>\r\n"}]}],t.ctorParameters=function(){return[{type:l.MatDialogRef},{type:c.AuthService}]},t}();function K(){return o.trigger("userButtonState",[o.state("collapse",o.style({width:"0",overflow:"hidden",display:"none"})),o.state("expand",o.style({overflow:"hidden",display:"display"})),o.transition("collapse => expand",o.animate("200ms")),o.transition("expand => collapse",o.animate("200ms"))])}var V=function(){function t(t,e,o){this.dialog=t,this.config=e,this.auth=o,this.expand=!1,this.visible=!1,this.visible=!!this.config.getConfig("auth")}return Object.defineProperty(t.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t},enumerable:!0,configurable:!0}),t.prototype.accountClick=function(){this.auth.authenticated?this.expand=!this.expand:this.auth.logout()},t.prototype.logout=function(){this.expand=!1,this.auth.logout()},t.prototype.infoUser=function(){this.dialog.open(z,{disableClose:!1})},t.decorators=[{type:d.Component,args:[{selector:"igo-user-button",template:'<div *ngIf="visible" class="igo-user-button-container">\r\n  <div class="igo-user-button-more-container" [@userButtonState]="expand ? \'expand\' : \'collapse\'">\r\n\r\n    <igo-poi-button [color]="color" [map]="map"></igo-poi-button>\r\n    <igo-bookmark-button [color]="color" [map]="map"></igo-bookmark-button>\r\n\r\n    <button\r\n      mat-icon-button\r\n      [matTooltip]="\'igo.context.userButton.infoTitle\' | translate"\r\n      matTooltipPosition="above"\r\n      [color]="color"\r\n      (click)="infoUser()">\r\n      <mat-icon svgIcon="information-outline"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      mat-icon-button\r\n      [matTooltip]="\'igo.context.userButton.logout\' | translate"\r\n      matTooltipPosition="above"\r\n      [color]="color"\r\n      (click)="logout()">\r\n      <mat-icon svgIcon="power"></mat-icon>\r\n    </button>\r\n\r\n  </div>\r\n\r\n  <button\r\n    mat-icon-button\r\n    [color]="auth.authenticated ? color : \'warn\'"\r\n    (click)="accountClick()">\r\n    <mat-icon svgIcon="account-box"></mat-icon>\r\n  </button>\r\n</div>\r\n',animations:[K()],styles:[".igo-user-button-container button{background-color:#fff}.igo-user-button-container button:hover{background-color:#efefef}.igo-user-button-more-container{float:left;height:40px}.igo-user-button-more-container>*{margin-right:2px;float:left}@media only screen and (max-width:450px),only screen and (max-height:450px){.igo-user-button-container>button{position:absolute;bottom:0}.igo-user-button-more-container{height:80px;width:150px;position:relative;left:24px}}:host>>>button .mat-button-ripple-round,button{border-radius:0}"]}]}],t.ctorParameters=function(){return[{type:l.MatDialog},{type:p.ConfigService},{type:c.AuthService}]},t.propDecorators={map:[{type:d.Input}],color:[{type:d.Input}]},t}(),N=function(){function t(){}return t.forRoot=function(){return{ngModule:t}},t.decorators=[{type:d.NgModule,args:[{imports:[u.CommonModule,p.IgoLanguageModule,h.IgoConfirmDialogModule,h.IgoStopPropagationModule,c.IgoAuthModule,r.FormsModule,l.MatIconModule,l.MatButtonModule,l.MatSelectModule,l.MatOptionModule,l.MatTooltipModule,l.MatFormFieldModule,l.MatDialogModule,l.MatInputModule],exports:[R,A,V],declarations:[R,_,A,q,V,z],entryComponents:[_,q,z],providers:[U]}]}],t}(),H=function(){function t(t,e,o,n,i){this.config=t,this.contextService=e,this.messageService=o,this.routingFormService=n,this.route=i,this.apiUrl=this.config.getConfig("context.url")}return t.prototype.getUrl=function(t,e,o){return this.apiUrl?this.getUrlWithApi(t,e):this.getUrlWithoutApi(t,o)},t.prototype.getUrlWithApi=function(t,e){var o=this,n=this.contextService.getContextFromMap(t);return n.scope="public",n.title=e.title,n.uri=e.uri,this.contextService.create(n).subscribe(function(t){},function(t){t.error.title="Share Map",o.messageService.showError(t)}),location.origin+location.pathname+"?context="+e.uri},t.prototype.getUrlWithoutApi=function(t,e){var o,n;if(this.route&&this.route.options.visibleOnLayersKey&&this.route.options.visibleOffLayersKey&&t.getZoom()){var i=e.layerlistControls.querystring,r=this.route.options.visibleOnLayersKey,a=this.route.options.visibleOffLayersKey,s=t.layers,c=this.route.options.routingCoordKey,u=[];this.routingFormService&&this.routingFormService.getStopsCoordinates()&&0!==this.routingFormService.getStopsCoordinates().length&&this.routingFormService.getStopsCoordinates().forEach(function(t){u.push(t)});var l="";2<=u.length&&(l=c+"="+u.join(";"));var p=s.filter(function(t){return t.visible}),d=s.filter(function(t){return!t.visible}),g="",m=[];p.length>d.length?(g=r+"=*&"+a+"=",m=d):(g=a+"=*&"+r+"=",m=p);try{for(var f=C(m),h=f.next();!h.done;h=f.next()){var v=h.value;v.id&&(g+=v.id+",")}}catch(S){o={error:S}}finally{try{h&&!h.done&&(n=f["return"])&&n.call(f)}finally{if(o)throw o.error}}g=g.substr(0,g.length-1);var x="zoom="+t.getZoom(),y="center="+(t.getCenter("EPSG:4326")||[]).toString(),b="";return this.contextService.context$.value&&(b="context="+this.contextService.context$.value.uri),(""+location.origin+location.pathname+"?"+b+"&"+x+"&"+y+"&"+g+"&"+i+"&"+l).replace(/&&/g,"&")}},t.decorators=[{type:d.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:p.ConfigService},{type:I},{type:p.MessageService},{type:v.RoutingFormService,decorators:[{type:d.Optional}]},{type:p.RouteService,decorators:[{type:d.Optional}]}]},t.ngInjectableDef=d.defineInjectable({factory:function(){return new t(d.inject(p.ConfigService),d.inject(I),d.inject(p.MessageService),d.inject(v.RoutingFormService,8),d.inject(p.RouteService,8))},token:t,providedIn:"root"}),t}(),G=function(){function t(t,e,o,n,i,r,a){this.config=t,this.languageService=e,this.messageService=o,this.auth=n,this.shareMapService=i,this.formBuilder=r,this.layerListService=a,this._hasShareMapButton=!0,this._hasCopyLinkButton=!1,this.hasApi=!1,this.publicShareOption={layerlistControls:{querystring:""}},this.hasApi=!!this.config.getConfig("context.url")}return Object.defineProperty(t.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasShareMapButton",{get:function(){return this._hasShareMapButton},set:function(t){this._hasShareMapButton=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasCopyLinkButton",{get:function(){return this._hasCopyLinkButton},set:function(t){this._hasCopyLinkButton=t},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){var o=this;this.auth.authenticate$.subscribe(function(t){var e=o.auth.decodeToken();o.userId=e.user?e.user.id:undefined,o.url=undefined,o.buildForm()})},t.prototype.ngAfterViewInit=function(){this.hasApi||this.resetUrl()},t.prototype.hasLayerListControls=function(){return!!(this.layerListService.keyword||this.layerListService.sortedAlpha||this.layerListService.onlyVisible||this.layerListService.onlyInRange)&&(this.publicShareOption.layerlistControls.querystring="",this.layerListService.keyword&&(this.publicShareOption.layerlistControls.querystring+="&llck="+this.layerListService.keyword),this.layerListService.sortedAlpha&&(this.publicShareOption.layerlistControls.querystring+="&llca=1"),this.layerListService.onlyVisible&&(this.publicShareOption.layerlistControls.querystring+="&llcv=1"),this.layerListService.onlyInRange&&(this.publicShareOption.layerlistControls.querystring+="&llcr=1"),!0)},t.prototype.resetUrl=function(t){void 0===t&&(t={}),this.hasLayerListControls();var e=Object.assign({},t);e.uri=this.userId?this.userId+"-"+t.uri:t.uri,this.url=this.shareMapService.getUrl(this.map,e,this.publicShareOption)},t.prototype.copyTextToClipboard=function(t){if(m.Clipboard.copy(t)){var e=this.languageService.translate,o=e.instant("igo.context.shareMap.dialog.copyTitle"),n=e.instant("igo.context.shareMap.dialog.copyMsg");this.messageService.success(n,o)}},t.prototype.buildForm=function(){var t=m.uuid(),e="Partage ";e+=this.userId?"("+this.userId+"-"+t+")":"("+t+")",this.form=this.formBuilder.group({title:[e],uri:[t]})},t.decorators=[{type:d.Component,args:[{selector:"igo-share-map",template:'<form class="igo-form" [formGroup]="form"\r\n  (ngSubmit)="resetUrl(form.value)">\r\n\r\n  <div *ngIf="hasApi" class="igo-input-container">\r\n    <mat-form-field>\r\n      <input matInput required\r\n             [placeholder]="\'igo.context.contextManager.form.title\' | translate"\r\n             formControlName="title">\r\n     <mat-error>\r\n      {{ \'igo.context.contextManager.form.titleRequired\' | translate }}\r\n     </mat-error>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div *ngIf="hasApi" id="uriInput" class="igo-input-container">\r\n    <mat-form-field>\r\n      <span *ngIf="userId" class="prefix">{{userId}}-</span>\r\n      <span class="fieldWrapper">\r\n        <input matInput required\r\n             [readonly]="!userId"\r\n             [placeholder]="\'igo.context.contextManager.form.uri\' | translate"\r\n             formControlName="uri">\r\n       </span>\r\n     <mat-error>\r\n      {{ \'igo.context.contextManager.form.uriRequired\' | translate }}\r\n     </mat-error>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div *ngIf="hasShareMapButton" class="igo-form-button-group">\r\n    <button\r\n      mat-raised-button\r\n      type="submit"\r\n      [disabled]="!form.valid">\r\n      {{ \'igo.context.shareMap.button\' | translate }}\r\n    </button>\r\n  </div>\r\n\r\n</form>\r\n\r\n<div *ngIf="url" class="igo-input-container linkToShare">\r\n  <mat-form-field>\r\n    <textarea #textArea matInput readonly rows="1"\r\n      [placeholder]="\'igo.context.shareMap.placeholderLink\' | translate"\r\n      [value]="url"></textarea>\r\n    <button\r\n      mat-icon-button\r\n      tooltip-position="below"\r\n      matTooltipShowDelay="500"\r\n      [matTooltip]="\'igo.context.shareMap.copy\' | translate"\r\n      color="primary"\r\n      (click)="copyTextToClipboard(textArea)">\r\n      <mat-icon svgIcon="content-copy"></mat-icon>\r\n    </button>\r\n  </mat-form-field>\r\n\r\n  <div *ngIf="hasCopyLinkButton" class="igo-form-button-group">\r\n    <button\r\n      mat-raised-button\r\n      (click)="copyTextToClipboard(textArea)">\r\n      <mat-icon svgIcon="content-copy"></mat-icon>\r\n      {{ \'igo.context.shareMap.copy\' | translate }}\r\n    </button>\r\n  </div>\r\n\r\n</div>\r\n',styles:['@charset "UTF-8";mat-form-field{width:100%}#uriInput .fieldWrapper{display:block;overflow:hidden}#uriInput .prefix{float:left}.linkToShare{padding:25px 5px 5px}.linkToShare textarea{resize:none;width:calc(100% - 60px);line-height:1.3;height:40px;overflow-y:hidden;word-wrap:normal;word-break:break-all}.linkToShare mat-form-field>button{float:right;margin:-10px 0}.igo-form{padding:20px 5px 5px}.igo-form-button-group{text-align:center;padding-top:10px}']}]}],t.ctorParameters=function(){return[{type:p.ConfigService},{type:p.LanguageService},{type:p.MessageService},{type:c.AuthService},{type:H},{type:r.FormBuilder},{type:v.LayerListService}]},t.propDecorators={map:[{type:d.Input}],hasShareMapButton:[{type:d.Input}],hasCopyLinkButton:[{type:d.Input}]},t}(),J=function(){function t(t,e,o){this.layerListService=e,this.route=o,this.component=t}return t.prototype.ngOnInit=function(){this.initRoutes()},t.prototype.initRoutes=function(){var r=this;this.route&&(this.route.options.llcKKey||this.route.options.llcAKey||this.route.options.llcVKey||this.route.options.llcVKey)&&this.route.queryParams.subscribe(function(t){var e=t[r.route.options.llcKKey],o=t[r.route.options.llcAKey],n=t[r.route.options.llcVKey],i=t[r.route.options.llcRKey];e&&!r.layerListService.keywordInitialized&&(r.layerListService.keyword=e,r.layerListService.keywordInitialized=!0),o&&!r.layerListService.sortedAlphaInitialized&&(r.layerListService.sortedAlpha="1"===o,r.layerListService.sortedAlphaInitialized=!0),n&&!r.layerListService.onlyVisibleInitialized&&(r.layerListService.onlyVisible="1"===n,r.layerListService.onlyVisibleInitialized=!0),i&&!r.layerListService.onlyInRangeInitialized&&(r.layerListService.onlyInRange="1"===i,r.layerListService.onlyInRangeInitialized=!0),r.component.hasApi||r.component.resetUrl()})},t.decorators=[{type:d.Directive,args:[{selector:"[igoShareMapBinding]"}]}],t.ctorParameters=function(){return[{type:G,decorators:[{type:d.Self}]},{type:v.LayerListService},{type:p.RouteService,decorators:[{type:d.Optional}]}]},t}(),W=function(){function t(){}return t.forRoot=function(){return{ngModule:t}},t.decorators=[{type:d.NgModule,args:[{imports:[u.CommonModule,r.FormsModule,r.ReactiveFormsModule,l.MatIconModule,l.MatTooltipModule,l.MatFormFieldModule,l.MatInputModule,l.MatButtonModule,p.IgoLanguageModule],exports:[G,J],declarations:[G,J]}]}],t}(),Z=function(){function t(t){this.titleService=t,this.format=new x,this._title=this.titleService.getTitle(),this.topPanelState="initial"}return Object.defineProperty(t.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"opened",{get:function(){return this._opened},set:function(t){this._opened=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"feature",{get:function(){return this._feature},set:function(t){this._feature=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tool",{get:function(){return this._tool},set:function(t){this._tool=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"media",{get:function(){return this._media},set:function(t){this._media=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._title},set:function(t){t&&(this._title=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"featureTitle",{get:function(){return this.feature?h.getEntityTitle(this.feature):undefined},enumerable:!0,configurable:!0}),t.prototype.zoomToFeatureExtent=function(){if(this.feature.geometry){var t=this.format.readFeature(this.feature,{dataProjection:this.feature.projection,featureProjection:this.map.projection});v.moveToOlFeatures(this.map,[t],v.FeatureMotion.Zoom)}},t.prototype.toggleTopPanel=function(){"initial"===this.topPanelState?this.topPanelState="expanded":this.topPanelState="initial"},t.decorators=[{type:d.Component,args:[{selector:"igo-sidenav",template:'<mat-sidenav\r\n  #sidenav\r\n  igoSidenavShim\r\n  mode="side"\r\n  [opened]="opened">\r\n\r\n  <div class="igo-sidenav-content">\r\n\r\n    <igo-flexible\r\n      #topPanel\r\n      initial="50%" initialMobile="100%"\r\n      expanded="calc(100% - 58px)"\r\n      [state]="topPanelState">\r\n\r\n      <div class="igo-content">\r\n        <igo-panel [title]="tool ? (tool.title | translate) : title">\r\n          <button\r\n            mat-icon-button\r\n            panelLeftButton\r\n            tooltip-position="below"\r\n            matTooltipShowDelay="500"\r\n            [matTooltip]="\'igo.context.sidenav.goBack\' | translate"\r\n            *ngIf="tool">\r\n            <mat-icon svgIcon="arrow-back"></mat-icon>\r\n          </button>\r\n\r\n          <button\r\n            mat-icon-button\r\n            panelRightButton\r\n            tooltip-position="below"\r\n            matTooltipShowDelay="500"\r\n            [matTooltip]="\'igo.context.sidenav.mainMenu\' | translate"\r\n            *ngIf="tool">\r\n            <mat-icon svgIcon="menu"></mat-icon>\r\n          </button>\r\n\r\n          \x3c!--igo-toolbar\r\n            igoToolContext igoToolbarBinding\r\n            [withTitle]="tool ? false : true">\r\n          </igo-toolbar>\r\n\r\n          <div class="igo-toolbox-container" [ngClass]="{\'shown\': tool ? true : false}">\r\n            <igo-toolbox [animate]="true"></igo-toolbox>\r\n          </div--\x3e\r\n        </igo-panel>\r\n      </div>\r\n\r\n      <div igoFlexibleFill class="igo-content">\r\n        <igo-panel\r\n          [title]="featureTitle"\r\n          *ngIf="feature && media !== \'mobile\'">\r\n\r\n          <button\r\n            mat-icon-button\r\n            panelLeftButton\r\n            class="igo-icon-button"\r\n            (click)="toggleTopPanel()">\r\n            <mat-icon [svgIcon]="[\'collapsed\', \'initial\'].indexOf(topPanel.state) >= 0 ? \'arrow_downward\' : \'arrow_upward\'"></mat-icon>\r\n          </button>\r\n\r\n          <button\r\n            mat-icon-button\r\n            panelRightButton\r\n            class="igo-icon-button"\r\n            (click)="zoomToFeatureExtent()"\r\n            *ngIf="feature.geometry">\r\n            <mat-icon svgIcon="zoom-in"></mat-icon>\r\n          </button>\r\n\r\n          <igo-feature-details\r\n            [feature]="feature"\r\n            *ngIf="[\'collapsed\', \'initial\'].indexOf(topPanel.state) >= 0">\r\n          </igo-feature-details>\r\n        </igo-panel>\r\n      </div>\r\n\r\n    </igo-flexible>\r\n\r\n  </div>\r\n</mat-sidenav>\r\n',styles:[".igo-sidenav-content .igo-flexible-fill .igo-container,:host ::ng-deep .igo-flexible-fill .igo-container{box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;border-top:1px solid rgba(0,0,0,.2)}igo-toolbar:not(.with-title),mat-sidenav{-o-box-shadow:2px 0 2px 0 #ddd;box-shadow:2px 0 2px 0 #ddd}:host{background-color:#fff}:host ::ng-deep mat-sidenav{z-index:3!important}mat-sidenav{width:400px}@media only screen and (max-width:450px),only screen and (max-height:450px){mat-sidenav{width:calc(100% - 40px - 5px)}}.igo-sidenav-content{margin-top:50px;height:calc(100% - 50px)}igo-toolbar{position:absolute;top:51px;left:0;bottom:0}igo-toolbar.with-title{right:0;overflow:auto}igo-toolbar:not(.with-title){overflow:hidden}igo-toolbar ::ng-deep igo-list{overflow:inherit}.igo-toolbox-container{position:absolute;top:51px;bottom:0;right:0;overflow:auto}.igo-toolbox-container.shown{left:48px}igo-feature-details ::ng-deep table{width:100%}"]}]}],t.ctorParameters=function(){return[{type:f.Title}]},t.propDecorators={map:[{type:d.Input}],opened:[{type:d.Input}],feature:[{type:d.Input}],tool:[{type:d.Input}],media:[{type:d.Input}],title:[{type:d.Input}]},t}(),Y=function(){function t(){}return t.forRoot=function(){return{ngModule:t}},t.decorators=[{type:d.NgModule,args:[{imports:[u.CommonModule,l.MatIconModule,l.MatButtonModule,l.MatSidenavModule,l.MatTooltipModule,p.IgoLanguageModule,h.IgoPanelModule,h.IgoFlexibleModule,v.IgoFeatureModule,F],exports:[Z],declarations:[Z]}]}],t}(),Q=function(){function t(){}return t.forRoot=function(){return{ngModule:t,providers:[]}},t.decorators=[{type:d.NgModule,args:[{imports:[],declarations:[],exports:[F,N,W,Y]}]}],t}();t.IgoContextModule=Q,t.IgoContextManagerModule=F,t.IgoContextMapButtonModule=N,t.IgoShareMapModule=W,t.IgoSidenavModule=Y,t.ContextService=I,t.TypePermission=S,t.Scope=M,t.LayerContextDirective=w,t.MapContextDirective=P,t.ContextListComponent=O,t.ContextListBindingDirective=k,t.ContextItemComponent=L,t.ContextFormComponent=T,t.ContextEditComponent=$,t.ContextEditBindingDirective=E,t.ContextPermissionsComponent=j,t.ContextPermissionsBindingDirective=B,t.BookmarkButtonComponent=R,t.BookmarkDialogComponent=_,t.PoiButtonComponent=A,t.PoiDialogComponent=q,t.PoiService=U,t.UserButtonComponent=V,t.UserDialogComponent=z,t.ShareMapService=H,t.ShareMapComponent=G,t.ShareMapBindingDirective=J,t.SidenavComponent=Z,t.ɵg=E,t.ɵf=$,t.ɵe=T,t.ɵd=L,t.ɵb=k,t.ɵa=O,t.ɵi=B,t.ɵh=j,t.ɵc=I,t.ɵk=w,t.ɵj=P,t.ɵl=R,t.ɵq=_,t.ɵm=A,t.ɵr=q,t.ɵn=U,t.ɵp=K,t.ɵo=V,t.ɵs=z,t.ɵv=J,t.ɵt=G,t.ɵu=H,t.ɵw=Z,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=igo2-context.umd.min.js.map