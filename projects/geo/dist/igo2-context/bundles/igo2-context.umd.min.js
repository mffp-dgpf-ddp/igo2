!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("ol/style"),require("ol/source/Cluster"),require("rxjs/operators"),require("ol/proj"),require("ol/easing"),require("ol/geom/Point"),require("@angular/common/http"),require("@angular/animations"),require("@angular/forms"),require("@igo2/auth"),require("@angular/common"),require("@angular/material"),require("@angular/platform-browser"),require("@igo2/common"),require("@igo2/geo"),require("ol/format/GeoJSON"),require("@angular/core"),require("@igo2/core"),require("@igo2/utils"),require("rxjs"),require("@ionic/angular"),require("@ionic-native/file/ngx"),require("@ionic-native/file-opener/ngx"),require("@ionic-native/file-opener/ngx/index"),require("@ionic-native/file/ngx/index")):"function"==typeof define&&define.amd?define("@igo2/context",["exports","ol/style","ol/source/Cluster","rxjs/operators","ol/proj","ol/easing","ol/geom/Point","@angular/common/http","@angular/animations","@angular/forms","@igo2/auth","@angular/common","@angular/material","@angular/platform-browser","@igo2/common","@igo2/geo","ol/format/GeoJSON","@angular/core","@igo2/core","@igo2/utils","rxjs","@ionic/angular","@ionic-native/file/ngx","@ionic-native/file-opener/ngx","@ionic-native/file-opener/ngx/index","@ionic-native/file/ngx/index"],e):e((t.igo2=t.igo2||{},t.igo2.context={}),t.olStyle,t.Cluster,t.rxjs.operators,t.olproj,t.oleasing,t.olPoint,t.ng.common.http,t.ng.animations,t.ng.forms,t.auth,t.ng.common,t.ng.material,t.ng.platformBrowser,t.common,t.geo,t.olFormatGeoJSON,t.ng.core,t.core,t.utils,t.rxjs,t.i2$1,t.ngx,t.ngx$1,t.i3,t.i4)}(this,function(t,u,l,a,n,r,h,e,o,i,s,c,p,d,m,g,f,x,v,y,b,S,C,w,M,I){"use strict";l=l&&l.hasOwnProperty("default")?l["default"]:l,h=h&&h.hasOwnProperty("default")?h["default"]:h,f=f&&f.hasOwnProperty("default")?f["default"]:f;var P=function(t,e){return(P=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)};function E(t,e){function o(){this.constructor=t}P(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}function D(t){var e="function"==typeof Symbol&&t[Symbol.iterator],o=0;return e?e.call(t):{next:function(){return t&&o>=t.length&&(t=void 0),{value:t&&t[o++],done:!t}}}}function O(t,e){var o="function"==typeof Symbol&&t[Symbol.iterator];if(!o)return t;var n,r,i=o.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(n=i.next()).done;)a.push(n.value)}catch(s){r={error:s}}finally{try{n&&!n.done&&(o=i["return"])&&o.call(i)}finally{if(r)throw r.error}}return a}function F(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(O(arguments[e]));return t}var k,T=(E($,k=Error),$);function $(){return null!==k&&k.apply(this,arguments)||this}var L,j=(E(B,L=T),B);function B(){var t=L.call(this,"Invalid context")||this;return Object.setPrototypeOf(t,B.prototype),t}var A,_=(E(U,A=T),U);function U(){var t=A.call(this,"Nothing to export")||this;return Object.setPrototypeOf(t,U.prototype),t}function z(t,e,o){if(t instanceof _)this.handleNothingToExportError(e,o);else{var n=o.translate,r=n.instant("igo.context.contextImportExport.export.failed.title"),i=n.instant("igo.context.contextImportExport.export.failed.text");e.error(i,r)}}function R(t,e){var o=e.translate,n=o.instant("igo.context.contextImportExport.export.success.title"),r=o.instant("igo.context.contextImportExport.export.success.text");t.success(r,n)}function N(t,e,o,n,r){if(Object.keys(e).length<=0)W(t,o,n);else{var i=Z(t);G(e,i,r);var a=n.translate,s=a.instant("igo.context.contextImportExport.import.success.title"),c=a.instant("igo.context.contextImportExport.import.success.text",{value:i});o.success(c,s)}}function q(t,e,o,n,r){r=r||30,{"Invalid file":H,"File is too large":V,"Failed to read file":K}[e.message](t,e,o,n,r)}function H(t,e,o,n){var r=n.translate,i=r.instant("igo.context.contextImportExport.import.invalid.title"),a=r.instant("igo.context.contextImportExport.import.invalid.text",{value:t.name,mimeType:t.type});o.error(a,i)}function V(t,e,o,n,r){var i=n.translate,a=i.instant("igo.context.contextImportExport.import.tooLarge.title"),s=i.instant("igo.context.contextImportExport.import.tooLarge.text",{value:t.name,size:r});o.error(s,a)}function K(t,e,o,n){var r=n.translate,i=r.instant("igo.context.contextImportExport.import.unreadable.title"),a=r.instant("igo.context.contextImportExport.import.unreadable.text",{value:t.name});o.error(a,i)}function W(t,e,o){var n=o.translate,r=n.instant("igo.context.contextImportExport.import.empty.title"),i=n.instant("igo.context.contextImportExport.import.empty.text",{value:t.name});e.error(i,r)}function G(t,e,o){t.title=e,t.imported=!0,o.contexts$.value.ours.unshift(t),o.contexts$.next(o.contexts$.value),o.importedContext.unshift(t),o.loadContext(t.uri)}function J(t){return t.name.split(".").pop().toLowerCase()}function Z(t){return t.name.substr(0,t.name.lastIndexOf("."))}function Y(t,e,o){var n=Math.floor(255*Math.random()),r=Math.floor(255*Math.random()),i=Math.floor(255*Math.random()),a=new u.Stroke({color:[n,r,i,1],width:2}),s=new u.Fill({color:[n,r,i,.4]}),c=new g.FeatureDataSource({type:"vector",queryable:!0});c.ol.addFeatures(t);var l=new g.VectorLayer({title:o,source:c,style:new u.Style({stroke:a,fill:s,image:new u.Circle({radius:5,stroke:a,fill:s})})});return e.addLayer(l),l}function Q(t,e,o,n,r){var i,a,s;if(n.getStyleList(o.toString()+".styleByAttribute")){var c=n.getStyleList(o.toString()+".styleByAttribute");i=function(t){return r.createStyleByAttribute(t,c)}}else if(n.getStyleList(o.toString()+".clusterStyle")){var l=n.getStyleList(o.toString()+".clusterParam");a=n.getStyleList(o.toString()+".distance");var u=r.createStyle(n.getStyleList(o.toString()+".clusterStyle"));i=function(t){return r.createClusterStyle(t,l,u)}}else i=n.getStyleList(o.toString()+".style")?r.createStyle(n.getStyleList(o.toString()+".style")):r.createStyle(n.getStyleList("default.style"));if(n.getStyleList(o.toString()+".clusterStyle")){var p={distance:a,type:"cluster",queryable:!0};(s=new g.ClusterDataSource(p)).ol.source.addFeatures(t)}else{p={type:"vector",queryable:!0};(s=new g.FeatureDataSource(p)).ol.addFeatures(t)}var d=new g.VectorLayer({title:o,source:s,style:i});return e.addLayer(d),d}var X={"null":0,read:1,write:2};X[X["null"]]="null",X[X.read]="read",X[X.write]="write";var tt={"public":0,"protected":1,"private":2};tt[tt["public"]]="public",tt[tt["protected"]]="protected",tt[tt["private"]]="private";var et=(Object.defineProperty(ot.prototype,"defaultContextUri",{get:function(){return this._defaultContextUri||this.options.defaultContextUri},set:function(t){this._defaultContextUri=t},enumerable:!0,configurable:!0}),ot.prototype.get=function(t,e){var o=this.baseUrl+"/contexts";return t&&this.authService.authenticated&&(o+="?permission="+t.join(),e&&(o+="&hidden=true")),this.http.get(o)},ot.prototype.getById=function(t){var e=this.baseUrl+"/contexts/"+t;return this.http.get(e)},ot.prototype.getDetails=function(e){var o=this,t=this.baseUrl+"/contexts/"+e+"/details";return this.http.get(t).pipe(a.catchError(function(t){return o.handleError(t,e)}))},ot.prototype.getDefault=function(){var e=this,t=this.baseUrl+"/contexts/default";return this.http.get(t).pipe(a.tap(function(t){e.defaultContextId$.next(t.id)}))},ot.prototype.getProfilByUser=function(){if(this.baseUrl){var t=this.baseUrl+"/profils?";return this.http.get(t)}return b.of([])},ot.prototype.setDefault=function(t){var e=this.baseUrl+"/contexts/default";return this.http.post(e,{defaultContextId:t})},ot.prototype.hideContext=function(t){var e=this.baseUrl+"/contexts/"+t+"/hide";return this.http.post(e,{})},ot.prototype.showContext=function(t){var e=this.baseUrl+"/contexts/"+t+"/show";return this.http.post(e,{})},ot.prototype["delete"]=function(e,t){var o=this;void 0===t&&(t=!1);var n={ours:[]};if(Object.keys(this.contexts$.value).forEach(function(t){return n[t]=o.contexts$.value[t].filter(function(t){return t.id!==e})}),t)return this.importedContext=this.importedContext.filter(function(t){return t.id!==e}),b.of(this.contexts$.next(n));var r=this.baseUrl+"/contexts/"+e;return this.http["delete"](r).pipe(a.tap(function(t){o.contexts$.next(n)}))},ot.prototype.create=function(t){var e=this,o=this.baseUrl+"/contexts";return this.http.post(o,JSON.stringify(t)).pipe(a.map(function(t){return e.authService.authenticated?t.permission=X[X.write]:t.permission=X[X.read],e.contexts$.value.ours.unshift(t),e.contexts$.next(e.contexts$.value),t}))},ot.prototype.clone=function(t,e){var o=this;void 0===e&&(e={});var n=this.baseUrl+"/contexts/"+t+"/clone";return this.http.post(n,JSON.stringify(e)).pipe(a.map(function(t){return t.permission=X[X.write],o.contexts$.value.ours.unshift(t),o.contexts$.next(o.contexts$.value),t}))},ot.prototype.update=function(t,e){var o=this.baseUrl+"/contexts/"+t;return this.http.patch(o,JSON.stringify(e))},ot.prototype.addToolAssociation=function(t,e){var o=this.baseUrl+"/contexts/"+t+"/tools",n={toolId:e};return this.http.post(o,JSON.stringify(n))},ot.prototype.deleteToolAssociation=function(t,e){var o=this.baseUrl+"/contexts/"+t+"/tools/"+e;return this.http["delete"](o)},ot.prototype.getPermissions=function(t){var e=this.baseUrl+"/contexts/"+t+"/permissions";return this.http.get(e)},ot.prototype.addPermissionAssociation=function(t,e,o){var n=this,r=this.baseUrl+"/contexts/"+t+"/permissions",i={profil:e,typePermission:o};return this.http.post(r,JSON.stringify(i)).pipe(a.catchError(function(t){return[n.handleError(t,undefined,!0)]}))},ot.prototype.deletePermissionAssociation=function(t,e){var o=this.baseUrl+"/contexts/"+t+"/permissions/"+e;return this.http["delete"](o)},ot.prototype.getLocalContexts=function(){var t=this.getPath(this.options.contextListFile);return this.http.get(t).pipe(a.map(function(t){return{ours:t}}))},ot.prototype.getLocalContext=function(e){var n=this,t=this.getPath(e+".json");return this.http.get(t).pipe(a.flatMap(function(o){if(!o.base)return b.of(o);var t=n.getPath(o.base+".json");return n.http.get(t).pipe(a.map(function(t){var e=o;return e.map=y.ObjectUtils.mergeDeep(t.map,o.map),e.layers=(t.layers||[]).concat(o.layers||[]).reverse().filter(function(e,t,o){return!e.id||o.findIndex(function(t){return t.id===e.id})===t}).reverse(),e.toolbar=o.toolbar||t.toolbar,e.tools=(o.tools||[]).concat(t.tools||[]).filter(function(e,t,o){return o.findIndex(function(t){return t.name===e.name})===t}),e}),a.catchError(function(t){return n.handleError(t,e)}))}),a.catchError(function(t){return n.handleError(t,e)}))},ot.prototype.loadContexts=function(t,e){var o=this;(this.baseUrl?this.get(t,e):this.getLocalContexts()).subscribe(function(t){t.ours=o.importedContext.concat(t.ours),o.contexts$.next(t)})},ot.prototype.loadDefaultContext=function(){var n=this,r=function(t){void 0===t&&(t=!1),!t&&n.baseUrl&&n.authService.authenticated?n.getDefault().subscribe(function(t){n.defaultContextUri=t.uri,n.addContextToList(t),n.setContext(t)},function(){n.defaultContextId$.next(undefined),n.loadContext(n.defaultContextUri)}):n.loadContext(n.defaultContextUri)};this.route&&this.route.options.contextKey?this.route.queryParams.pipe(a.debounceTime(100)).subscribe(function(t){var e=t[n.route.options.contextKey],o=!1;e&&(n.defaultContextUri=e,o=!0),r(o)}):r()},ot.prototype.loadContext=function(e){var o=this,t=this.context$.value;if(!t||t.uri!==e)var n=this.getContextByUri(e).subscribe(function(t){n&&n.unsubscribe(),o.addContextToList(t),o.setContext(t)},function(t){n&&n.unsubscribe(),e!==o.options.defaultContextUri&&o.loadContext(o.options.defaultContextUri)})},ot.prototype.setContext=function(t){this.handleContextMessage(t);var e=this.context$.value;if(e&&t&&t.id===e.id)return t.map.view.keepCurrentView===undefined&&(t.map.view.keepCurrentView=!0),void this.context$.next(t);t.map||(t.map={view:{}}),Object.assign(t.map.view,this.mapViewFromRoute),this.context$.next(t)},ot.prototype.loadEditedContext=function(t){var e=this;this.getContextByUri(t).subscribe(function(t){e.setEditedContext(t)})},ot.prototype.setEditedContext=function(t){this.editedContext$.next(t)},ot.prototype.getContextFromMap=function(t,e){var o,n,r=t.ol.getView(),i=r.getProjection().getCode(),a=new h(r.getCenter()).transform(i,"EPSG:4326"),s={uri:y.uuid(),title:"",scope:"private",map:{view:{center:a.getCoordinates(),zoom:r.getZoom(),projection:i,maxZoomOnExtent:t.viewController.maxZoomOnExtent}},layers:[],tools:[]},c=[];c=!0===e?t.layers$.getValue().filter(function(t){return!0===t.baseLayer||"searchPointerSummaryId"===t.options.id}).sort(function(t,e){return t.zIndex-e.zIndex}):t.layers$.getValue().sort(function(t,e){return t.zIndex-e.zIndex});var l=0;try{for(var u=D(c),p=u.next();!p.done;p=u.next()){var d=p.value,m={id:d.options.id?String(d.options.id):undefined,layerOptions:{title:d.options.title,zIndex:++l,visible:d.visible},sourceOptions:{type:d.dataSource.options.type,params:d.dataSource.options.params,url:d.dataSource.options.url,queryable:d.queryable}};m.sourceOptions.type&&s.layers.push(m)}}catch(g){o={error:g}}finally{try{p&&!p.done&&(n=u["return"])&&n.call(u)}finally{if(o)throw o.error}}return s.tools=this.tools.map(function(t){return{id:String(t.id),global:t.global}}),s},ot.prototype.getContextFromLayers=function(t,e,o){var s=this.context$.getValue(),n=t.ol.getView(),r=n.getProjection().getCode(),c={uri:o,title:o,map:{view:{center:new h(n.getCenter()).transform(r,"EPSG:4326").getCoordinates(),zoom:n.getZoom(),projection:r}},layers:[],toolbar:[],tools:[],extraFeatures:[]},i=t.layers$.getValue();return c.layers=i.filter(function(t){return t.baseLayer}).map(function(t){return{baseLayer:!0,sourceOptions:t.options.sourceOptions,title:t.options.title,visible:t.visible}}),e.forEach(function(e){var t=s.layers.find(function(t){return e.id===t.source.id&&!t.baseLayer});if(t){var o=t.style;t.styleByAttribute?o=undefined:t.clusterBaseStyle&&(o=undefined,delete t.sourceOptions.source,delete t.sourceOptions.format);var n={baseLayer:t.baseLayer,title:e.options.title,zIndex:e.zIndex,styleByAttribute:t.styleByAttribute,clusterBaseStyle:t.clusterBaseStyle,style:o,clusterParam:t.clusterParam,visible:e.visible,opacity:e.opacity,sourceOptions:t.sourceOptions};c.layers.push(n)}else if("VECTOR"!==e.ol.type){var r=e.options;delete r.source,c.layers.push(r)}else{var i=void 0,a=new f;i=e.ol.getSource()instanceof l?a.writeFeatures(e.ol.getSource().getSource().getFeatures(),{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}):a.writeFeatures(e.ol.getSource().getFeatures(),{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),(i=JSON.parse(i)).name=e.options.title,c.extraFeatures.push(i)}}),c.toolbar=this.toolbar,c.tools=this.tools,c},ot.prototype.setTools=function(t){this.tools=t},ot.prototype.setToolbar=function(t){this.toolbar=t},ot.prototype.handleContextMessage=function(t){this.contextMessage&&this.messageService.remove(this.contextMessage.id);var e=t.message;e&&(e.title=e.title?this.languageService.translate.instant(e.title):undefined,e.text=e.text?this.languageService.translate.instant(e.text):undefined,this.messageService.message(e))},ot.prototype.getContextByUri=function(e){var t,o;if(this.baseUrl){var n=void 0;try{for(var r=D(Object.keys(this.contexts$.value)),i=r.next();!i.done;i=r.next()){var a=i.value;if(n=this.contexts$.value[a].find(function(t){return t.uri===e}))break}}catch(l){t={error:l}}finally{try{i&&!i.done&&(o=r["return"])&&o.call(r)}finally{if(t)throw t.error}}if(n&&n.imported)return b.of(n);var s=n?n.id:e;return this.getDetails(s)}var c=this.contexts$.value.ours.find(function(t){return t.uri===e&&!0===t.imported});return c?b.of(c):this.getLocalContext(e)},ot.prototype.getContextLayers=function(t){var e=[];return t.layers$.getValue().forEach(function(t){t.baseLayer||"searchPointerSummaryId"===t.options.id||e.push(t)}),e},ot.prototype.readParamsFromRoute=function(){var s=this;this.route&&this.route.queryParams.subscribe(function(t){var e=s.route.options.centerKey;if(e&&t[e]){var o=t[e];s.mapViewFromRoute.center=o.split(",").map(Number),s.mapViewFromRoute.geolocate=!1}var n=s.route.options.projectionKey;if(n&&t[n]){var r=t[n];s.mapViewFromRoute.projection=r}var i=s.route.options.zoomKey;if(i&&t[i]){var a=t[i];s.mapViewFromRoute.zoom=Number(a)}})},ot.prototype.getPath=function(t){return this.options.basePath.replace(/\/$/,"")+"/"+t},ot.prototype.handleError=function(t,e,o){var n=this.contexts$.value.ours.find(function(t){return t.uri===e}),r=n?n.title:e;throw t.error.title=this.languageService.translate.instant("igo.context.contextManager.invalid.title"),t.error.message=this.languageService.translate.instant("igo.context.contextManager.invalid.text",{value:r}),t.error.toDisplay=!0,o&&(t.error.title=this.languageService.translate.instant("igo.context.contextManager.errors.addPermissionTitle"),t.error.message=this.languageService.translate.instant("igo.context.contextManager.errors.addPermission")),t},ot.prototype.handleContextsChange=function(t,e){void 0===e&&(e=!0);var o=this.context$.value,n=this.editedContext$.value;e&&this.findContext(o)?(o.map.view.keepCurrentView===undefined&&(o.map.view.keepCurrentView=!0),this.context$.next(o),this.baseUrl&&this.authService.authenticated&&this.getDefault().subscribe()):this.loadDefaultContext();var r=this.findContext(n);r&&"write"===r.permission||this.setEditedContext(undefined)},ot.prototype.addContextToList=function(t){if(!this.findContext(t)){var e={id:t.id,uri:t.uri,title:t.title,scope:t.scope,permission:X[X.read]};this.contexts$.value&&this.contexts$.value["public"]&&(this.contexts$.value["public"].push(e),this.contexts$.next(this.contexts$.value))}},ot.prototype.findContext=function(e){var t,o;if(!e)return!1;var n,r=this.contexts$.value;try{for(var i=D(Object.keys(r)),a=i.next();!a.done&&!(n=r[a.value].find(function(t){return e.id&&t.id===e.id||e.uri&&t.uri===e.uri}));a=i.next());}catch(s){t={error:s}}finally{try{a&&!a.done&&(o=i["return"])&&o.call(i)}finally{if(t)throw t.error}}return n},ot.decorators=[{type:x.Injectable,args:[{providedIn:"root"}]}],ot.ctorParameters=function(){return[{type:e.HttpClient},{type:s.AuthService},{type:v.LanguageService},{type:v.ConfigService},{type:v.MessageService},{type:v.RouteService,decorators:[{type:x.Optional}]}]},ot.ngInjectableDef=x.defineInjectable({factory:function(){return new ot(x.inject(e.HttpClient),x.inject(s.AuthService),x.inject(v.LanguageService),x.inject(v.ConfigService),x.inject(v.MessageService),x.inject(v.RouteService,8))},token:ot,providedIn:"root"}),ot);function ot(t,e,o,n,r,i){var a=this;this.http=t,this.authService=e,this.languageService=o,this.config=n,this.messageService=r,this.route=i,this.context$=new b.BehaviorSubject(undefined),this.contexts$=new b.BehaviorSubject({ours:[]}),this.defaultContextId$=new b.BehaviorSubject(undefined),this.editedContext$=new b.BehaviorSubject(undefined),this.importedContext=[],this.mapViewFromRoute={},this.options=Object.assign({basePath:"contexts",contextListFile:"_contexts.json",defaultContextUri:"_default"},this.config.getConfig("context")),this.baseUrl=this.options.url,this.readParamsFromRoute(),this.authService.authenticate$.subscribe(function(t){if(t&&a.baseUrl)a.get().subscribe(function(t){a.handleContextsChange(t)});else{var e=a.contexts$.subscribe(function(t){e&&(e.unsubscribe(),a.handleContextsChange(t))});a.loadContexts()}})}var nt,rt=(E(it,nt=Error),it);function it(){return null!==nt&&nt.apply(this,arguments)||this}var at,st=(E(ct,at=rt),ct);function ct(){var t=at.call(this,"Invalid file")||this;return Object.setPrototypeOf(t,ct.prototype),t}var lt,ut=(E(pt,lt=rt),pt);function pt(){var t=lt.call(this,"Failed to read file")||this;return Object.setPrototypeOf(t,pt.prototype),t}var dt,mt=(E(gt,dt=rt),gt);function gt(){var t=dt.call(this,"Nothing to import")||this;return Object.setPrototypeOf(t,gt.prototype),t}var ht,ft=(E(xt,ht=rt),xt);function xt(){var t=ht.call(this,"File is too large")||this;return Object.setPrototypeOf(t,mt.prototype),t}var vt,yt=(E(bt,vt=rt),bt);function bt(){var t=vt.call(this,"Invalid SRS definition")||this;return Object.setPrototypeOf(t,mt.prototype),t}var St=(Ct.prototype["import"]=function(t){return this.importAsync(t)},Ct.prototype.getFileImporter=function(t){var e=J(t),o=t.type,n=F(Ct.allowedMimeTypes),r=Ct.allowedExtensions;return n.indexOf(o)<0&&r.indexOf(e)<0?undefined:"application/json"===o||e===Ct.allowedExtensions?this.importFile:undefined},Ct.prototype.importAsync=function(o){var n=this;return new b.Observable(function(t){if(o.size>=n.clientSideFileSizeMax)t.error(new ft);else{var e=n.getFileImporter(o);e!==undefined?e.call(n,o,t):t.error(new st)}})},Ct.prototype.importFile=function(n,r){var i=this,t=new FileReader;t.onload=function(t){try{var e=i.parseContextFromFile(n,t.target.result);r.next(e)}catch(o){r.error(new ut)}r.complete()},t.onerror=function(t){r.error(new ut)},t.readAsText(n,"UTF-8")},Ct.prototype.parseContextFromFile=function(t,e){return JSON.parse(e)},Ct.allowedMimeTypes=["application/json"],Ct.allowedExtensions="json",Ct.decorators=[{type:x.Injectable,args:[{providedIn:"root"}]}],Ct.ctorParameters=function(){return[{type:v.ConfigService}]},Ct.ngInjectableDef=x.defineInjectable({factory:function(){return new Ct(x.inject(v.ConfigService))},token:Ct,providedIn:"root"}),Ct);function Ct(t){this.config=t;var e=this.config.getConfig("importExport.clientSideFileSizeMaxMb");this.clientSideFileSizeMax=(e||30)*Math.pow(1024,2)}var wt=(Mt.prototype["export"]=function(t){return this.exportAsync(t)},Mt.prototype.exportAsync=function(o){var n=this;return new b.Observable(function(t){if(!0!==n.nothingToExport(o)){var e=JSON.stringify(o);y.downloadContent(e,"text/json;charset=utf-8",o.uri+".json"),t.complete()}else t.error(new _)})},Mt.prototype.nothingToExport=function(t){return t.map===undefined},Mt.decorators=[{type:x.Injectable,args:[{providedIn:"root"}]}],Mt.ngInjectableDef=x.defineInjectable({factory:function(){return new Mt},token:Mt,providedIn:"root"}),Mt);function Mt(){}var It=(Pt.prototype.ngOnInit=function(){var t=this.config.getConfig("importExport.clientSideFileSizeMaxMb");this.clientSideFileSizeMax=(t||30)*Math.pow(1024,2),this.fileSizeMb=this.clientSideFileSizeMax/Math.pow(1024,2),this.layerList=this.contextService.getContextLayers(this.map)},Pt.prototype.importFiles=function(t){var e,o,n=this;this.loading$.next(!0);var r=function(e){i.contextImportService["import"](e).subscribe(function(t){return n.onFileImportSuccess(e,t)},function(t){return n.onFileImportError(e,t)},function(){n.loading$.next(!1)})},i=this;try{for(var a=D(t),s=a.next();!s.done;s=a.next())r(s.value)}catch(c){e={error:c}}finally{try{s&&!s.done&&(o=a["return"])&&o.call(a)}finally{if(e)throw e.error}}},Pt.prototype.handleExportFormSubmit=function(t){var e=this;this.loading$.next(!0),this.res=this.contextService.getContextFromLayers(this.map,t.layers,t.name),this.res.imported=!0,this.contextExportService["export"](this.res).subscribe(function(){},function(t){return e.onFileExportError(t)},function(){e.onFileExportSuccess(),e.loading$.next(!1)})},Pt.prototype.buildForm=function(){this.form=this.formBuilder.group({layers:["",[i.Validators.required]],name:["",[i.Validators.required]]})},Pt.prototype.onFileImportSuccess=function(t,e){N(t,e,this.messageService,this.languageService,this.contextService)},Pt.prototype.onFileImportError=function(t,e){this.loading$.next(!1),q(t,e,this.messageService,this.languageService,this.fileSizeMb)},Pt.prototype.onFileExportError=function(t){this.loading$.next(!1),z(t,this.messageService,this.languageService)},Pt.prototype.onFileExportSuccess=function(){R(this.messageService,this.languageService)},Pt.prototype.selectAll=function(t){t._selected&&(this.form.controls.layers.setValue(this.layerList),t._selected=!0),!1===t._selected&&this.form.controls.layers.setValue([])},Pt.prototype.onImportExportChange=function(t){this.activeImportExport=t.value},Pt.decorators=[{type:x.Component,args:[{selector:"igo-context-import-export",template:'<div class="import-export-toggle mat-typography">\r\n    <mat-button-toggle-group\r\n          [value]="activeImportExport"\r\n          (change)="onImportExportChange($event)">\r\n          <mat-button-toggle [value]="\'import\'">\r\n            {{\'igo.geo.importExportForm.importTabTitle\' | translate}}\r\n          </mat-button-toggle>\r\n          <mat-button-toggle [value]="\'export\'">\r\n            {{\'igo.geo.importExportForm.exportTabTitle\' | translate}}\r\n          </mat-button-toggle>\r\n    </mat-button-toggle-group>\r\n</div>\r\n\r\n<div *ngIf="activeImportExport === \'import\'">\r\n    <form class="igo-form">\r\n        <div class="igo-form-button-group">\r\n            <button mat-raised-button type="button" (click)="fileInput.click()" [disabled]="loading$ | async">\r\n                {{\'igo.geo.importExportForm.importButton\' | translate}}\r\n            </button>\r\n            <igo-spinner [shown]="loading$ | async"></igo-spinner>\r\n            <input\r\n                #fileInput\r\n                type="file"\r\n                [style.display]="\'none\'"\r\n                (click)="fileInput.value = null"\r\n                (change)="importFiles($event.target.files)">\r\n        </div>\r\n    </form>\r\n    <section class="mat-typography">\r\n        <h4>{{\'igo.geo.importExportForm.importClarifications\' | translate}}</h4>\r\n            <ul>\r\n                <li>{{\'igo.geo.importExportForm.importSizeMax\' | translate: {size: fileSizeMb} }}</li>\r\n            </ul>\r\n    </section>\r\n</div>\r\n\r\n\r\n<form class="igo-form" *ngIf="activeImportExport === \'export\'" [formGroup]="form">\r\n    <div class="igo-input-container">\r\n        <mat-form-field class="example-full-width">\r\n            <mat-label>{{\'igo.context.contextImportExport.export.exportContextName\' | translate}}</mat-label>\r\n            <input formControlName="name" matInput [value]="">\r\n        </mat-form-field>\r\n    </div>\r\n    <div class="igo-input-container">\r\n        <mat-form-field>\r\n            <mat-label>{{\'igo.context.contextImportExport.export.exportPlaceHolder\' | translate}}</mat-label>\r\n            <mat-select formControlName="layers" multiple>\r\n                <mat-option [value]="1" (click)="selectAll(e)" #e>\r\n                    {{\'igo.context.contextImportExport.export.exportSelectAll\' | translate}}\r\n                </mat-option>\r\n                <mat-divider></mat-divider>\r\n                <mat-option *ngFor="let layer of layerList" [value]="layer">{{layer.title}}</mat-option>\r\n            </mat-select>\r\n        </mat-form-field>\r\n    </div>\r\n    <div class="igo-form-button-group">\r\n        <button\r\n            mat-raised-button\r\n            type="button"\r\n            [disabled]="!form.valid || (loading$ | async)"\r\n            (click)="handleExportFormSubmit(form.value)">\r\n            {{\'igo.geo.importExportForm.exportButton\' | translate}}\r\n        </button>\r\n        <igo-spinner [shown]="loading$ | async"></igo-spinner>\r\n    </div>\r\n</form>\r\n',styles:[".import-export-toggle{padding:10px;text-align:center}.import-export-toggle mat-button-toggle-group{width:100%}.import-export-toggle mat-button-toggle-group mat-button-toggle{width:50%}.igo-input-container{padding:10px}.igo-input-container mat-form-field{width:100%}h4{padding:0 5px}.igo-form{padding:15px 5px}.igo-form-button-group{text-align:center;padding-top:10px}igo-spinner{position:absolute;padding-left:10px}"]}]}],Pt.ctorParameters=function(){return[{type:St},{type:wt},{type:v.LanguageService},{type:v.MessageService},{type:i.FormBuilder},{type:v.ConfigService},{type:et}]},Pt.propDecorators={map:[{type:x.Input}]},Pt);function Pt(t,e,o,n,r,i,a){this.contextImportService=t,this.contextExportService=e,this.languageService=o,this.messageService=n,this.formBuilder=r,this.config=i,this.contextService=a,this.inputProj="EPSG:4326",this.loading$=new b.BehaviorSubject(!1),this.forceNaming=!1,this.activeImportExport="import",this.buildForm()}var Et=(Ot.forRoot=function(){return{ngModule:Ot}},Ot.decorators=[{type:x.NgModule,args:[{imports:[i.FormsModule,i.ReactiveFormsModule,c.CommonModule,p.MatButtonModule,p.MatButtonToggleModule,p.MatDividerModule,p.MatTabsModule,p.MatSelectModule,p.MatOptionModule,p.MatFormFieldModule,p.MatInputModule,p.MatCheckboxModule,v.IgoLanguageModule,m.IgoSpinnerModule,p.MatTooltipModule],exports:[It],declarations:[It]}]}],Ot);function Ot(){}var Ft=(kt.decorators=[{type:x.Component,args:[{selector:"igo-bookmark-dialog",template:'<h1 mat-dialog-title class="mat-typography">{{ \'igo.context.bookmarkButton.dialog.title\' | translate }}</h1>\r\n<div mat-dialog-content class="mat-typography">\r\n  <mat-form-field>\r\n    <input matInput required autocomplete="off"\r\n      maxlength="128"\r\n      [placeholder]="\'igo.context.bookmarkButton.dialog.placeholder\' | translate"\r\n      [(ngModel)]="title">\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color="primary"\r\n         [disabled]="!title"\r\n         (click)="dialogRef.close(title)">\r\n    {{\'igo.common.confirmDialog.confirmBtn\' | translate}}\r\n  </button>\r\n  <button mat-button\r\n          (click)="dialogRef.close(false)">\r\n    {{\'igo.common.confirmDialog.cancelBtn\' | translate}}\r\n  </button>\r\n</div>\r\n'}]}],kt.ctorParameters=function(){return[{type:p.MatDialogRef}]},kt);function kt(t){this.dialogRef=t}var Tt=(Object.defineProperty($t.prototype,"map",{get:function(){return this.component.map},enumerable:!0,configurable:!0}),$t.prototype.ngOnInit=function(){var e=this;this.context$$=this.contextService.context$.pipe(a.filter(function(t){return t!==undefined})).subscribe(function(t){return e.handleContextChange(t)})},$t.prototype.ngOnDestroy=function(){this.context$$.unsubscribe()},$t.prototype.handleContextChange=function(t){if(t.map!==undefined){var e=t.map.view;this.component.view&&!0===e.keepCurrentView||(this.component.view=e)}},$t.decorators=[{type:x.Directive,args:[{selector:"[igoMapContext]"}]}],$t.ctorParameters=function(){return[{type:g.MapBrowserComponent},{type:et}]},$t);function $t(t,e){this.contextService=e,this.component=t}var Lt=(Object.defineProperty(jt.prototype,"map",{get:function(){return this.component.map},enumerable:!0,configurable:!0}),jt.prototype.ngOnInit=function(){var e=this;if(this.context$$=this.contextService.context$.pipe(a.filter(function(t){return t!==undefined})).subscribe(function(t){return e.handleContextChange(t)}),this.route&&this.route.options.visibleOnLayersKey&&this.route.options.visibleOffLayersKey&&this.route.options.contextKey)var o=this.route.queryParams.subscribe(function(t){0<Object.keys(t).length&&(e.queryParams=t,o.unsubscribe())})},jt.prototype.ngOnDestroy=function(){this.context$$.unsubscribe()},jt.prototype.handleContextChange=function(e){var n=this;if(e.layers!==undefined){!0===this.removeLayersOnContextChange?this.map.removeAllLayers():this.map.removeLayers(this.contextLayers),this.contextLayers=[];var t=b.merge.apply(void 0,F(e.layers.map(function(t,e){return n.layerService.createAsyncLayer(t)})));t.pipe(a.buffer(t.pipe(a.debounceTime(500)))).subscribe(function(t){t=t.filter(function(t){return t!==undefined}).map(function(t){return t.visible=n.computeLayerVisibilityFromUrl(t),t.zIndex=t.zIndex,t}),n.contextLayers.concat(t),n.map.addLayers(t),e.extraFeatures&&e.extraFeatures.forEach(function(t){var e=new f,o=t.name;t=JSON.stringify(t),t=e.readFeatures(t,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),n.configService.getConfig("importWithStyle")?Q(t,n.map,o,n.styleListService,n.styleService):Y(t,n.map,o)})})}},jt.prototype.computeLayerVisibilityFromUrl=function(t){var e=this.queryParams,o=this.contextService.context$.value.uri,n=t.id,r=t.visible;if(!e||!n)return r;var i=e[this.route.options.contextKey];if(i===o||!i){var a="",s="",c=[],l=[];this.route.options.visibleOnLayersKey&&e[this.route.options.visibleOnLayersKey]&&(a=e[this.route.options.visibleOnLayersKey]),this.route.options.visibleOffLayersKey&&e[this.route.options.visibleOffLayersKey]&&(s=e[this.route.options.visibleOffLayersKey]),"*"===a&&(r=!0),"*"===s&&(r=!1),c=a.split(","),l=s.split(","),-1<c.indexOf(n)&&(r=!0),-1<l.indexOf(n)&&(r=!1)}return r},jt.decorators=[{type:x.Directive,args:[{selector:"[igoLayerContext]"}]}],jt.ctorParameters=function(){return[{type:g.MapBrowserComponent},{type:et},{type:g.LayerService},{type:v.ConfigService},{type:g.StyleListService},{type:g.StyleService},{type:v.RouteService,decorators:[{type:x.Optional}]}]},jt.propDecorators={removeLayersOnContextChange:[{type:x.Input}]},jt);function jt(t,e,o,n,r,i,a){this.component=t,this.contextService=e,this.layerService=o,this.configService=n,this.styleListService=r,this.styleService=i,this.route=a,this.contextLayers=[],this.removeLayersOnContextChange=!0}var Dt="always",Bt="never",At=(Object.defineProperty(_t.prototype,"contexts",{get:function(){return this._contexts},set:function(t){this._contexts=t,this.cdRef.detectChanges(),this.next()},enumerable:!0,configurable:!0}),Object.defineProperty(_t.prototype,"selectedContext",{get:function(){return this._selectedContext},set:function(t){this._selectedContext=t,this.cdRef.detectChanges()},enumerable:!0,configurable:!0}),Object.defineProperty(_t.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(_t.prototype,"defaultContextId",{get:function(){return this._defaultContextId},set:function(t){this._defaultContextId=t},enumerable:!0,configurable:!0}),Object.defineProperty(_t.prototype,"term",{get:function(){return this._term},set:function(t){this._term=t,this.next()},enumerable:!0,configurable:!0}),Object.defineProperty(_t.prototype,"sortedAlpha",{get:function(){return this._sortedAlpha},set:function(t){this._sortedAlpha=t,this.next()},enumerable:!0,configurable:!0}),_t.prototype.ngOnInit=function(){var t=this;this.change$$=this.change$.pipe(a.debounce(function(){return 0===t.contexts.ours.length?b.EMPTY:b.timer(50)})).subscribe(function(){t.contexts$.next(t.filterContextsList(t.contexts))}),this.actionStore.load([{id:"emptyContext",title:this.languageService.translate.instant("igo.context.contextManager.emptyContext"),icon:"map-outline",tooltip:this.languageService.translate.instant("igo.context.contextManager.emptyContextTooltip"),handler:function(){t.createContext(!0)}},{id:"contextFromMap",title:this.languageService.translate.instant("igo.context.contextManager.contextMap"),icon:"map-check",tooltip:this.languageService.translate.instant("igo.context.contextManager.contextMapTooltip"),handler:function(){t.createContext(!1)}}])},_t.prototype.next=function(){this.change$.next()},_t.prototype.filterContextsList=function(t){var o=this;if(""===this.term)return this.sortedAlpha&&(t=this.sortContextsList(t)),t;var e={ours:t.ours.filter(function(t){var e=o.term.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");return t.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").includes(e)})};if(this.contexts["public"]){var n=t["public"].filter(function(t){var e=o.term.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");return t.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").includes(e)});e["public"]=n}if(this.contexts.shared){var r=t.shared.filter(function(t){var e=o.term.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");return t.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").includes(e)});e.shared=r}return this.sortedAlpha&&(e=this.sortContextsList(e)),e},_t.prototype.ngOnDestroy=function(){this.change$$.unsubscribe()},_t.prototype.showFilter=function(){switch(this.showContextFilter){case Dt:return!0;case Bt:return!1;default:var t=this.contexts.ours.length;return this.contexts["public"]?t+=this.contexts["public"].length:t+=0,this.contexts.shared?t+=this.contexts.shared.length:t+=0,t>=this.thresholdToFilter}},_t.prototype.sortContextsList=function(t){var o=this;if(t){var e=JSON.parse(JSON.stringify(t));return e.ours.sort(function(t,e){return o.normalize(t.title)<o.normalize(e.title)?-1:o.normalize(t.title)>o.normalize(e.title)?1:0}),e.shared?e.shared.sort(function(t,e){return o.normalize(t.title)<o.normalize(e.title)?-1:o.normalize(t.title)>o.normalize(e.title)?1:0}):e["public"]&&e["public"].sort(function(t,e){return o.normalize(t.title)<o.normalize(e.title)?-1:o.normalize(t.title)>o.normalize(e.title)?1:0}),e}},_t.prototype.normalize=function(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()},_t.prototype.toggleSort=function(t){this.sortedAlpha=t},_t.prototype.clearFilter=function(){this.term=""},_t.prototype.createContext=function(e){var o=this;this.dialog.open(Ft,{disableClose:!1}).afterClosed().subscribe(function(t){t&&o.create.emit({title:t,empty:e})})},_t.prototype.getPermission=function(e){if(e)return this.permissions.find(function(t){return t.name===e.name})},_t.prototype.userSelection=function(t,e){var o,n,r,i,a=this.getPermission(t);if(a&&(a.checked=!a.checked,this.storageService.set("contexts.permissions."+a.name,a.checked),a.indeterminate=!1),e){var s=!1;try{for(var c=D(e.childs),l=c.next();!l.done;l=c.next()){var u=l.value;if(this.getPermission(u).checked!==a.checked){s=!0;break}}}catch(h){o={error:h}}finally{try{l&&!l.done&&(n=c["return"])&&n.call(c)}finally{if(o)throw o.error}}var p=this.getPermission(e);p&&(p.checked=a.checked,this.storageService.set("contexts.permissions."+p.name,a.checked),p.indeterminate=s)}if(t.childs)try{for(var d=D(t.childs),m=d.next();!m.done;m=d.next()){u=m.value;var g=this.getPermission(u);g&&g.checked!==a.checked&&(g.checked=a.checked,this.storageService.set("contexts.permissions."+g.name,a.checked))}}catch(f){r={error:f}}finally{try{m&&!m.done&&(i=d["return"])&&i.call(d)}finally{if(r)throw r.error}}this.filterPermissionsChanged.emit(this.permissions)},_t.prototype.hideContext=function(e){if(e.hidden=!0,!this.showHidden){var t={ours:[],shared:[],"public":[]};t.ours=this.contexts.ours.filter(function(t){return t.id!==e.id}),t.shared=this.contexts.shared.filter(function(t){return t.id!==e.id}),t["public"]=this.contexts["public"].filter(function(t){return t.id!==e.id}),this.contexts=t}this.hide.emit(e)},_t.prototype.showContext=function(t){t.hidden=!1,this.show.emit(t)},_t.decorators=[{type:x.Component,args:[{selector:"igo-context-list",template:'<igo-list [navigation]="true">\r\n  <mat-form-field *ngIf="showFilter()" [ngClass]="auth.authenticated ? \'context-filter-min-width\' : \'context-filter-max-width\'">\r\n    <input\r\n      matInput\r\n      type="text"\r\n      [placeholder]="\'igo.context.contextManager.filterPlaceHolder\' | translate"\r\n      [(ngModel)]="term">\r\n    <button\r\n      mat-button\r\n      mat-icon-button\r\n      matSuffix\r\n      class="clear-button"\r\n      *ngIf="term.length"\r\n      aria-label="Clear"\r\n      color="warn"\r\n      (click)="clearFilter()">\r\n      <mat-icon svgIcon="close"></mat-icon>\r\n    </button>\r\n  </mat-form-field>\r\n\r\n  <button\r\n  *ngIf="!sortedAlpha"\r\n  mat-icon-button\r\n  [matTooltip]="\'igo.context.contextManager.sortAlphabetically\' | translate"\r\n  matTooltipShowDelay="500"\r\n  (click)="toggleSort(true)">\r\n  <mat-icon color="primary" svgIcon="sort-alphabetical"></mat-icon>\r\n  </button>\r\n  <button\r\n    *ngIf="sortedAlpha"\r\n    mat-icon-button\r\n    [matTooltip]="\'igo.context.contextManager.sortContextOrder\' | translate"\r\n    matTooltipShowDelay="500"\r\n    (click)="toggleSort(false)">\r\n    <mat-icon color="warn" svgIcon="sort-variant-remove"></mat-icon>\r\n  </button>\r\n\r\n  <igo-actionbar *ngIf="auth.authenticated"\r\n    class="add-context-button"\r\n    [iconColor]="color"\r\n    [store]="actionStore"\r\n    [withIcon]="true"\r\n    icon="plus"\r\n    [withTitle]="actionbarMode === \'overlay\'"\r\n    [horizontal]="false"\r\n    [mode]="actionbarMode">\r\n  </igo-actionbar>\r\n\r\n  <button *ngIf="auth.authenticated && users && users.length"\r\n    mat-icon-button\r\n    [matTooltip]="\'igo.context.contextManager.filterUser\' | translate"\r\n    matTooltipShowDelay="500"\r\n    [matMenuTriggerFor]="accountMenu">\r\n    <mat-icon color="primary" svgIcon="filter-menu"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu #accountMenu="matMenu">\r\n    <ng-container *ngFor="let user of users">\r\n      <span class="profilsMenu">\r\n        <mat-checkbox\r\n          class="mat-menu-item"\r\n          [checked]="getPermission(user).checked"\r\n          [indeterminate]="getPermission(user).indeterminate"\r\n          (click)="$event.stopPropagation()"\r\n          (change)="userSelection(user)">\r\n        </mat-checkbox>\r\n        <button *ngIf="user.childs"\r\n          [matMenuTriggerFor]="subAccountMenu"\r\n          mat-menu-item>\r\n          {{user.title}}\r\n        </button>\r\n        <button\r\n          mat-menu-item\r\n          *ngIf="!user.childs">\r\n          {{user.title}}\r\n        </button>\r\n      </span>\r\n\r\n      <mat-menu #subAccountMenu="matMenu">\r\n        <mat-checkbox *ngFor="let child of user.childs"\r\n          class="mat-menu-item"\r\n          [checked]="getPermission(child).checked"\r\n          (click)="$event.stopPropagation()"\r\n          (change)="userSelection(child, user)">\r\n          {{child.title}}\r\n        </mat-checkbox>\r\n      </mat-menu>\r\n    </ng-container>\r\n\r\n    <span class="profilsMenu">\r\n      <mat-checkbox\r\n        class="mat-menu-item"\r\n        [checked]="showHidden"\r\n        (click)="$event.stopPropagation()"\r\n        (change)="showHiddenContexts.emit()">\r\n      </mat-checkbox>\r\n      <button mat-menu-item>\r\n        {{ \'igo.context.contextManager.showHidden\' | translate }}\r\n      </button>\r\n    </span>\r\n  </mat-menu>\r\n\r\n  <ng-template ngFor let-groupContexts [ngForOf]="contexts$ | async | keyvalue">\r\n\r\n    <igo-collapsible *ngIf="groupContexts.value.length && auth.authenticated" [title]="titleMapping[groupContexts.key] | translate"\r\n      [collapsed]="collapsed[titleMapping[groupContexts.key]]" (toggle)="collapsed[titleMapping[groupContexts.key]] = $event">\r\n\r\n      <ng-template ngFor let-context [ngForOf]="groupContexts.value">\r\n        <igo-context-item\r\n          igoListItem\r\n          color="accent"\r\n          [selected]="selectedContext && selectedContext.uri === context.uri"\r\n          [context]="context"\r\n          [default]="context.id && this.defaultContextId && this.defaultContextId === context.id"\r\n          (edit)="edit.emit(context)"\r\n          (delete)="delete.emit(context)"\r\n          (clone)="clone.emit(context)"\r\n          (save)="save.emit(context)"\r\n          (hide)="hideContext(context)"\r\n          (show)="showContext(context)"\r\n          (favorite)="favorite.emit(context)"\r\n          (manageTools)="manageTools.emit(context)"\r\n          (managePermissions)="managePermissions.emit(context)"\r\n          (select)="select.emit(context)"\r\n          (unselect)="unselect.emit(context)">\r\n        </igo-context-item>\r\n      </ng-template>\r\n\r\n    </igo-collapsible>\r\n\r\n    <ng-template *ngIf="groupContexts.value.length && !auth.authenticated" ngFor let-context [ngForOf]="groupContexts.value">\r\n      <igo-context-item\r\n        igoListItem\r\n        color="accent"\r\n        [selected]="selectedContext && selectedContext.uri === context.uri"\r\n        [context]="context"\r\n        [default]="this.defaultContextId === context.id"\r\n        (select)="select.emit(context)"\r\n        (unselect)="unselect.emit(context)">\r\n      </igo-context-item>\r\n    </ng-template>\r\n\r\n  </ng-template>\r\n</igo-list>\r\n',changeDetection:x.ChangeDetectionStrategy.OnPush,styles:[".context-filter-max-width{width:calc(100% - 100px);margin:5px;padding-left:6px}.context-filter-min-width{width:calc(100% - 135px);margin:5px;padding-left:6px}.clear-button{padding-right:5px}mat-form-field{height:40px}.profilsMenu{display:-webkit-box;display:flex}.profilsMenu>mat-checkbox{width:8px}.add-context-button{margin:0;width:40px;display:-webkit-inline-box;display:inline-flex}"]}]}],_t.ctorParameters=function(){return[{type:x.ChangeDetectorRef},{type:et},{type:s.AuthService},{type:p.MatDialog},{type:v.LanguageService},{type:v.StorageService}]},_t.propDecorators={contexts:[{type:x.Input}],selectedContext:[{type:x.Input}],map:[{type:x.Input}],defaultContextId:[{type:x.Input}],select:[{type:x.Output}],unselect:[{type:x.Output}],edit:[{type:x.Output}],"delete":[{type:x.Output}],save:[{type:x.Output}],clone:[{type:x.Output}],create:[{type:x.Output}],hide:[{type:x.Output}],show:[{type:x.Output}],showHiddenContexts:[{type:x.Output}],favorite:[{type:x.Output}],managePermissions:[{type:x.Output}],manageTools:[{type:x.Output}],filterPermissionsChanged:[{type:x.Output}],term:[{type:x.Input}]},_t);function _t(t,e,o,n,r,i){this.cdRef=t,this.contextService=e,this.auth=o,this.dialog=n,this.languageService=r,this.storageService=i,this.contextsInitial={ours:[]},this.contexts$=new b.BehaviorSubject(this.contextsInitial),this.change$=new b.ReplaySubject(1),this._contexts={ours:[]},this.collapsed=[],this.select=new x.EventEmitter,this.unselect=new x.EventEmitter,this.edit=new x.EventEmitter,this["delete"]=new x.EventEmitter,this.save=new x.EventEmitter,this.clone=new x.EventEmitter,this.create=new x.EventEmitter,this.hide=new x.EventEmitter,this.show=new x.EventEmitter,this.showHiddenContexts=new x.EventEmitter,this.favorite=new x.EventEmitter,this.managePermissions=new x.EventEmitter,this.manageTools=new x.EventEmitter,this.filterPermissionsChanged=new x.EventEmitter,this.titleMapping={ours:"igo.context.contextManager.ourContexts",shared:"igo.context.contextManager.sharedContexts","public":"igo.context.contextManager.publicContexts"},this.permissions=[],this.actionStore=new m.ActionStore([]),this.actionbarMode=m.ActionbarMode.Overlay,this.color="primary",this.showHidden=!1,this._term="",this._sortedAlpha=undefined,this.showContextFilter=Dt,this.thresholdToFilter=5}var Ut=(zt.prototype.onSelect=function(t){this.contextService.loadContext(t.uri)},zt.prototype.onEdit=function(t){this.contextService.loadEditedContext(t.uri)},zt.prototype.onSave=function(n){var r=this,t=this.mapService.getMap(),e=this.contextService.getContextFromMap(t),o=function(){var t=r.languageService.translate,e=t.instant("igo.context.contextManager.dialog.saveMsg",{value:n.title}),o=t.instant("igo.context.contextManager.dialog.saveTitle");r.messageService.success(e,o)};if(n.imported)return e.title=n.title,this.contextService["delete"](n.id,!0),void this.contextService.create(e).subscribe(function(t){r.contextService.loadContext(t.uri),o()});var i={layers:e.layers,map:{view:e.map.view}};this.contextService.update(n.id,i).subscribe(function(){o()})},zt.prototype.onFavorite=function(n){var r=this;this.contextService.setDefault(n.id).subscribe(function(){r.contextService.defaultContextId$.next(n.id);var t=r.languageService.translate,e=t.instant("igo.context.contextManager.dialog.favoriteMsg",{value:n.title}),o=t.instant("igo.context.contextManager.dialog.favoriteTitle");r.messageService.success(e,o)})},zt.prototype.onManageTools=function(t){this.contextService.loadEditedContext(t.uri)},zt.prototype.onManagePermissions=function(t){this.contextService.loadEditedContext(t.uri)},zt.prototype.onDelete=function(o){var n=this,r=this.languageService.translate;this.confirmDialogService.open(r.instant("igo.context.contextManager.dialog.confirmDelete")).subscribe(function(t){t&&n.contextService["delete"](o.id,o.imported).subscribe(function(){var t=r.instant("igo.context.contextManager.dialog.deleteMsg",{value:o.title}),e=r.instant("igo.context.contextManager.dialog.deleteTitle");n.messageService.info(t,e)})})},zt.prototype.onClone=function(n){var r=this,t={title:n.title+"-copy",uri:n.uri+"-copy"};this.contextService.clone(n.id,t).subscribe(function(){var t=r.languageService.translate,e=t.instant("igo.context.contextManager.dialog.cloneMsg",{value:n.title}),o=t.instant("igo.context.contextManager.dialog.cloneTitle");r.messageService.success(e,o)})},zt.prototype.onCreate=function(t){var n=this,e=t.title,o=t.empty,r=this.contextService.getContextFromMap(this.component.map,o);r.title=e,this.contextService.create(r).subscribe(function(){var t=n.languageService.translate,e=t.instant("igo.context.bookmarkButton.dialog.createTitle"),o=t.instant("igo.context.bookmarkButton.dialog.createMsg",{value:r.title});n.messageService.success(o,e),n.contextService.loadContext(r.uri)})},zt.prototype.loadContexts=function(){var t,e,o=["none"];try{for(var n=D(this.component.permissions),r=n.next();!r.done;r=n.next()){var i=r.value;!0!==i.checked&&!0!==i.indeterminate||o.push(i.name)}}catch(a){t={error:a}}finally{try{r&&!r.done&&(e=n["return"])&&e.call(n)}finally{if(t)throw t.error}}this.component.showHidden?this.contextService.loadContexts(o,!0):this.contextService.loadContexts(o,!1)},zt.prototype.showHiddenContexts=function(){this.component.showHidden=!this.component.showHidden,this.storageService.set("contexts.showHidden",this.component.showHidden),this.loadContexts()},zt.prototype.onShowContext=function(t){this.contextService.showContext(t.id).subscribe()},zt.prototype.onHideContext=function(t){this.contextService.hideContext(t.id).subscribe()},zt.prototype.ngOnInit=function(){var f=this;this.component.contexts={ours:[]},this.component.showHidden=this.storageService.get("contexts.showHidden"),this.contexts$$=this.contextService.contexts$.subscribe(function(t){return f.handleContextsChange(t)}),this.defaultContextId$$=this.contextService.defaultContextId$.subscribe(function(t){f.component.defaultContextId=t}),this.selectedContext$$=this.contextService.context$.pipe(a.debounceTime(100)).subscribe(function(t){return f.component.selectedContext=t}),this.auth.authenticate$.subscribe(function(t){t&&f.contextService.getProfilByUser().subscribe(function(t){var e,o,n,r;f.component.users=t,f.component.permissions=[];var i=f.component.users.reduce(function(t,e){return t=t.concat(e),t=e.childs?t.concat(e.childs):t},[]);try{for(var a=D(i),s=a.next();!s.done;s=a.next()){var c=s.value,l={name:c.name,checked:f.storageService.get("contexts.permissions."+c.name)};f.component.permissions.push(l)}}catch(g){e={error:g}}finally{try{s&&!s.done&&(o=a["return"])&&o.call(a)}finally{if(e)throw e.error}}var u=["none"];try{for(var p=D(f.component.permissions),d=p.next();!d.done;d=p.next()){var m=d.value;!0!==m.checked&&!0!==m.indeterminate||u.push(m.name)}}catch(h){n={error:h}}finally{try{d&&!d.done&&(r=p["return"])&&r.call(p)}finally{if(n)throw n.error}}f.component.showHidden?f.contextService.loadContexts(u,!0):f.contextService.loadContexts(u,!1)})})},zt.prototype.ngOnDestroy=function(){this.contexts$$.unsubscribe(),this.selectedContext$$.unsubscribe(),this.defaultContextId$$.unsubscribe()},zt.prototype.handleContextsChange=function(t){this.component.contexts=t},zt.decorators=[{type:x.Directive,args:[{selector:"[igoContextListBinding]"}]}],zt.ctorParameters=function(){return[{type:At,decorators:[{type:x.Self}]},{type:et},{type:g.MapService},{type:v.LanguageService},{type:m.ConfirmDialogService},{type:v.MessageService},{type:s.AuthService},{type:v.StorageService}]},zt.propDecorators={onSelect:[{type:x.HostListener,args:["select",["$event"]]}],onEdit:[{type:x.HostListener,args:["edit",["$event"]]}],onSave:[{type:x.HostListener,args:["save",["$event"]]}],onFavorite:[{type:x.HostListener,args:["favorite",["$event"]]}],onManageTools:[{type:x.HostListener,args:["manageTools",["$event"]]}],onManagePermissions:[{type:x.HostListener,args:["managePermissions",["$event"]]}],onDelete:[{type:x.HostListener,args:["delete",["$event"]]}],onClone:[{type:x.HostListener,args:["clone",["$event"]]}],onCreate:[{type:x.HostListener,args:["create",["$event"]]}],loadContexts:[{type:x.HostListener,args:["filterPermissionsChanged"]}],showHiddenContexts:[{type:x.HostListener,args:["showHiddenContexts"]}],onShowContext:[{type:x.HostListener,args:["show",["$event"]]}],onHideContext:[{type:x.HostListener,args:["hide",["$event"]]}]},zt);function zt(t,e,o,n,r,i,a,s){this.contextService=e,this.mapService=o,this.languageService=n,this.confirmDialogService=r,this.messageService=i,this.auth=a,this.storageService=s,this.component=t}var Rt=(Object.defineProperty(Nt.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t},enumerable:!0,configurable:!0}),Object.defineProperty(Nt.prototype,"default",{get:function(){return this._default},set:function(t){this._default=t},enumerable:!0,configurable:!0}),Object.defineProperty(Nt.prototype,"hidden",{get:function(){return this.context.hidden},enumerable:!0,configurable:!0}),Object.defineProperty(Nt.prototype,"canShare",{get:function(){return!0===this.storageService.get("canShare")},enumerable:!0,configurable:!0}),Nt.prototype.favoriteClick=function(t){this.auth.authenticated&&this.favorite.emit(t)},Nt.decorators=[{type:x.Component,args:[{selector:"igo-context-item",template:'<mat-list-item\r\n  class="mat-list-item"\r\n  [ngClass]="{\'mat-list-item-light\': hidden}">\r\n  <button mat-list-avatar\r\n    *ngIf="auth.authenticated"\r\n    mat-icon-button\r\n    igoStopPropagation\r\n    [matTooltip]="auth.authenticated ? (\'igo.context.contextManager.favorite\' | translate) : \'\'"\r\n    matTooltipShowDelay="500"\r\n    [color]="default ? \'primary\' : \'default\'"\r\n    (click)="favoriteClick(context)">\r\n    <mat-icon *ngIf="!context.iconImage" svgIcon="{{context.icon ? context.icon : context.scope === \'public\' ? \'earth\' : \'star\'}}"></mat-icon>\r\n    <img *ngIf="context.iconImage" [src]="context.iconImage">\r\n  </button>\r\n  <h4 matLine>{{context.title}}</h4>\r\n\r\n  <div *ngIf="auth.authenticated"\r\n       igoStopPropagation\r\n       class="igo-actions-container">\r\n\r\n     <button *ngIf="collapsed && selected && (context.permission === typePermission[typePermission.write] || context.imported)"\r\n       mat-icon-button\r\n       [matTooltip]="\'igo.context.contextManager.save\' | translate"\r\n       matTooltipShowDelay="500"\r\n       [color]="color"\r\n       (click)="save.emit(context)">\r\n       <mat-icon svgIcon="content-save"></mat-icon>\r\n     </button>\r\n\r\n    <div #actions class="igo-actions-expand-container">\r\n\r\n      <button *ngIf="canShare && !context.imported"\r\n        mat-icon-button\r\n        [matTooltip]="\'igo.context.contextManager.managePermissions\' | translate"\r\n        matTooltipShowDelay="500"\r\n        [color]="color"\r\n        (click)="managePermissions.emit(context)">\r\n        <mat-icon svgIcon="account-arrow-right"></mat-icon>\r\n      </button>\r\n\r\n      \x3c!--button\r\n        mat-icon-button\r\n        [matTooltip]="\'igo.context.contextManager.manageTools\' | translate"\r\n        [color]="color"\r\n        (click)="manageTools.emit(context)">\r\n        <mat-icon svgIcon="widgets"></mat-icon>\r\n      </button--\x3e\r\n\r\n      <button *ngIf="!context.imported"\r\n        mat-icon-button\r\n        [matTooltip]="\'igo.context.contextManager.clone\' | translate"\r\n        matTooltipShowDelay="500"\r\n        [color]="color"\r\n        (click)="clone.emit(context)">\r\n        <mat-icon svgIcon="content-copy"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf="context.permission === typePermission[typePermission.write] && !context.imported"\r\n        mat-icon-button\r\n        [color]="color"\r\n        [matTooltip]="\'igo.context.contextManager.edit\' | translate"\r\n        matTooltipShowDelay="500"\r\n        (click)="edit.emit(context)">\r\n        <mat-icon svgIcon="pencil"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf="!context.hidden && !context.imported"\r\n        mat-icon-button\r\n        [color]="color"\r\n        [matTooltip]="\'igo.context.contextManager.hide\' | translate"\r\n        matTooltipShowDelay="500"\r\n        (click)="hide.emit(context)">\r\n        <mat-icon svgIcon="eye"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf="context.hidden && !context.imported"\r\n        mat-icon-button\r\n        [color]="color"\r\n        [matTooltip]="\'igo.context.contextManager.show\' | translate"\r\n        matTooltipShowDelay="500"\r\n        (click)="show.emit(context)">\r\n        <mat-icon svgIcon="eye-off"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf="context.permission === typePermission[typePermission.write] || context.imported"\r\n        mat-icon-button\r\n        color="warn"\r\n        [matTooltip]="\'igo.context.contextManager.delete\' | translate"\r\n        matTooltipShowDelay="500"\r\n        (click)="delete.emit(context)">\r\n        <mat-icon svgIcon="delete"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <button\r\n      mat-icon-button\r\n      igoCollapse\r\n      [color]="color"\r\n      [target]="actions"\r\n      [collapsed]=collapsed\r\n      (click)="collapsed = !collapsed">\r\n      <mat-icon svgIcon="dots-horizontal"></mat-icon>\r\n    </button>\r\n\r\n  </div>\r\n\r\n</mat-list-item>\r\n',changeDetection:x.ChangeDetectionStrategy.OnPush,styles:[":host{overflow:hidden}.igo-actions-container{flex-shrink:0}.igo-actions-expand-container{display:-webkit-inline-box;display:inline-flex}mat-list-item>>>.mat-list-item-content .mat-list-text{padding:0}mat-icon.disabled{color:rgba(0,0,0,.38)}mat-list-item.mat-list-item-light>>>.mat-list-item-content{color:#969696}"]}]}],Nt.ctorParameters=function(){return[{type:s.AuthService},{type:v.StorageService}]},Nt.propDecorators={context:[{type:x.Input}],"default":[{type:x.Input}],selected:[{type:x.Input}],edit:[{type:x.Output}],"delete":[{type:x.Output}],save:[{type:x.Output}],clone:[{type:x.Output}],hide:[{type:x.Output}],show:[{type:x.Output}],favorite:[{type:x.Output}],managePermissions:[{type:x.Output}],manageTools:[{type:x.Output}]},Nt);function Nt(t,e){this.auth=t,this.storageService=e,this.typePermission=X,this.color="primary",this.collapsed=!0,this._default=!1,this.edit=new x.EventEmitter,this["delete"]=new x.EventEmitter,this.save=new x.EventEmitter,this.clone=new x.EventEmitter,this.hide=new x.EventEmitter,this.show=new x.EventEmitter,this.favorite=new x.EventEmitter,this.managePermissions=new x.EventEmitter,this.manageTools=new x.EventEmitter}var qt=(Object.defineProperty(Ht.prototype,"btnSubmitText",{get:function(){return this._btnSubmitText},set:function(t){this._btnSubmitText=t},enumerable:!0,configurable:!0}),Object.defineProperty(Ht.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t,this.buildForm()},enumerable:!0,configurable:!0}),Object.defineProperty(Ht.prototype,"disabled",{get:function(){return this._disabled},set:function(t){this._disabled=t},enumerable:!0,configurable:!0}),Ht.prototype.ngOnInit=function(){this.buildForm()},Ht.prototype.handleFormSubmit=function(t){var e=Object.assign({},t);(e=y.ObjectUtils.removeNull(e)).uri=e.uri.replace(" ",""),e.uri?e.uri=this.prefix+"-"+e.uri:e.uri=this.prefix,this.submitForm.emit(e)},Ht.prototype.copyTextToClipboard=function(){var t=this.prefix+"-"+this.form.value.uri.replace(" ","");if(y.Clipboard.copy(t)){var e=this.languageService.translate,o=e.instant("igo.context.contextManager.dialog.copyTitle"),n=e.instant("igo.context.contextManager.dialog.copyMsg");this.messageService.success(n,o)}},Ht.prototype.buildForm=function(){var t=this.context||{},e=t.uri.split("-");this.prefix=e.shift();var o=e.join("-");this.form=this.formBuilder.group({title:[t.title],uri:[o||" "]})},Ht.decorators=[{type:x.Component,args:[{selector:"igo-context-form",template:'<form class="igo-form" [formGroup]="form"\r\n  (ngSubmit)="handleFormSubmit(form.value)">\r\n\r\n  <mat-form-field class="full-width">\r\n    <input matInput required\r\n           maxlength="128"\r\n           [placeholder]="\'igo.context.contextManager.form.title\' | translate"\r\n           formControlName="title">\r\n   <mat-error>\r\n    {{ \'igo.context.contextManager.form.titleRequired\' | translate }}\r\n   </mat-error>\r\n  </mat-form-field>\r\n\r\n  <mat-form-field id="uriInput" class="full-width">\r\n    <span *ngIf="prefix" class="prefix">{{prefix}}-</span>\r\n    <span class="fieldWrapper">\r\n      <input matInput\r\n           maxlength="64"\r\n           floatLabel = "always"\r\n           [placeholder]="\'igo.context.contextManager.form.uri\' | translate"\r\n           formControlName="uri">\r\n    </span>\r\n  </mat-form-field>\r\n\r\n  <button\r\n    id="copyButton"\r\n    type="button"\r\n    mat-icon-button\r\n    tooltip-position="below"\r\n    matTooltipShowDelay="500"\r\n    [matTooltip]="\'igo.context.contextManager.form.copy\' | translate"\r\n    color="primary"\r\n    (click)="copyTextToClipboard()">\r\n    <mat-icon svgIcon="content-copy"></mat-icon>\r\n  </button>\r\n\r\n  <div class="igo-form-button-group">\r\n    <button\r\n      mat-raised-button\r\n      type="submit"\r\n      [disabled]="!form.valid || disabled">\r\n      {{ \'igo.context.contextManager.form.edit\' | translate }}\r\n    </button>\r\n  </div>\r\n\r\n</form>\r\n',styles:["form{margin:10px}.full-width{width:100%}#uriInput .fieldWrapper{display:block;overflow:hidden}#uriInput .prefix{float:left}#copyButton{width:24px;float:right;position:relative;top:-58px;left:5px}"]}]}],Ht.ctorParameters=function(){return[{type:i.FormBuilder},{type:v.LanguageService},{type:v.MessageService}]},Ht.propDecorators={btnSubmitText:[{type:x.Input}],context:[{type:x.Input}],disabled:[{type:x.Input}],submitForm:[{type:x.Output}],clone:[{type:x.Output}],"delete":[{type:x.Output}]},Ht);function Ht(t,e,o){this.formBuilder=t,this.languageService=e,this.messageService=o,this._disabled=!1,this.submitForm=new x.EventEmitter,this.clone=new x.EventEmitter,this["delete"]=new x.EventEmitter}var Vt=(Object.defineProperty(Kt.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t,this.refresh()},enumerable:!0,configurable:!0}),Kt.prototype.refresh=function(){this.cd.detectChanges()},Kt.decorators=[{type:x.Component,args:[{selector:"igo-context-edit",template:'<igo-context-form *ngIf="context"\r\n   [btnSubmitText]="\'igo.context.contextManager.save\' | translate"\r\n   [context]="context"\r\n   (submitForm)="submitForm.emit($event)">\r\n</igo-context-form>\r\n'}]}],Kt.ctorParameters=function(){return[{type:x.ChangeDetectorRef}]},Kt.propDecorators={context:[{type:x.Input}],submitForm:[{type:x.Output}]},Kt);function Kt(t){this.cd=t,this.submitForm=new x.EventEmitter}var Wt=(Gt.prototype.onEdit=function(n){var r=this,t=this.component.context.id;this.contextService.update(t,n).subscribe(function(){var t=r.languageService.translate,e=t.instant("igo.context.contextManager.dialog.saveMsg",{value:n.title||r.component.context.title}),o=t.instant("igo.context.contextManager.dialog.saveTitle");r.messageService.success(e,o),r.contextService.setEditedContext(undefined),r.submitSuccessed.emit(n)})},Gt.prototype.ngOnInit=function(){var e=this;this.editedContext$$=this.contextService.editedContext$.subscribe(function(t){return e.handleEditedContextChange(t)})},Gt.prototype.ngOnDestroy=function(){this.editedContext$$.unsubscribe()},Gt.prototype.handleEditedContextChange=function(t){this.component.context=t},Gt.decorators=[{type:x.Directive,args:[{selector:"[igoContextEditBinding]"}]}],Gt.ctorParameters=function(){return[{type:Vt,decorators:[{type:x.Self}]},{type:et},{type:v.MessageService},{type:v.LanguageService}]},Gt.propDecorators={submitSuccessed:[{type:x.Output}],onEdit:[{type:x.HostListener,args:["submitForm",["$event"]]}]},Gt);function Gt(t,e,o,n){this.contextService=e,this.messageService=o,this.languageService=n,this.submitSuccessed=new x.EventEmitter,this.component=t}var Jt=(Object.defineProperty(Zt.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t,this.cd.detectChanges()},enumerable:!0,configurable:!0}),Object.defineProperty(Zt.prototype,"permissions",{get:function(){return this._permissions},set:function(t){this._permissions=t,this.cd.detectChanges()},enumerable:!0,configurable:!0}),Object.defineProperty(Zt.prototype,"profils",{get:function(){return this._profils},set:function(t){this._profils=t,this.cd.detectChanges()},enumerable:!0,configurable:!0}),Object.defineProperty(Zt.prototype,"canWrite",{get:function(){return this.context.permission===X[X.write]},enumerable:!0,configurable:!0}),Zt.prototype.ngOnInit=function(){var e=this;this.buildForm(),this.formValueChanges$$=this.formControl.valueChanges.subscribe(function(n){n.length?(e.http.get(e.baseUrlProfils+"q="+n).subscribe(function(t){e.profils=t}),e.profils.filter(function(t){var e=n.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),o=t.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");return(t.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")+o).includes(e)})):e.profils=[]})},Zt.prototype.displayFn=function(t){return t?t.title:undefined},Zt.prototype.handleFormSubmit=function(t){this.addPermission.emit(t)},Zt.prototype.buildForm=function(){this.form=this.formBuilder.group({profil:[],typePermission:["read"]})},Zt.prototype.onProfilSelected=function(t){this.form.setValue({profil:t.name,typePermission:this.form.value.typePermission})},Zt.decorators=[{type:x.Component,args:[{selector:"igo-context-permissions",template:'<div *ngIf="context">\r\n\r\n  <div *ngIf="!canWrite" class="scopeForm">\r\n    <h4>{{ \'igo.context.permission.readOnlyTitle\' | translate }}</h4>\r\n    <p>{{ \'igo.context.permission.readOnlyMsg\' | translate }}</p>\r\n  </div>\r\n\r\n  <div *ngIf="canWrite" class="scopeForm">\r\n    <mat-radio-group [(ngModel)]="context.scope"\r\n                    (change)="scopeChanged.emit(context)">\r\n      <mat-radio-button value="private">\r\n        {{ \'igo.context.permission.scope.private\' | translate }}\r\n      </mat-radio-button>\r\n      <mat-radio-button value="protected">\r\n        {{ \'igo.context.permission.scope.shared\' | translate }}\r\n      </mat-radio-button>\r\n      <mat-radio-button *ngIf="authService.isAdmin" value="public">\r\n        {{ \'igo.context.permission.scope.public\' | translate }}\r\n      </mat-radio-button>\r\n    </mat-radio-group>\r\n  </div>\r\n\r\n  <form *ngIf="context.scope !== \'private\' && canWrite" [formGroup]="form"\r\n    (ngSubmit)="handleFormSubmit(form.value)">\r\n\r\n    <mat-form-field class="full-width">\r\n      <input matInput required\r\n             [placeholder]="\'igo.context.permission.user\' | translate"\r\n             [formControl]="formControl"\r\n             [matAutocomplete]="auto">\r\n      <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onProfilSelected($event.option.value)"\r\n        [displayWith]="displayFn">\r\n          <mat-option *ngFor="let profil of this.profils" [value]="profil">\r\n              {{profil.title}}<br>\r\n              <small class="mat-typography">{{profil.name}}</small>\r\n          </mat-option>\r\n      </mat-autocomplete>\r\n     <mat-error>\r\n       {{ \'igo.context.permission.profilRequired\' | translate }}\r\n     </mat-error>\r\n    </mat-form-field>\r\n\r\n\r\n    <mat-radio-group formControlName="typePermission">\r\n      <mat-radio-button value="read">\r\n        {{ \'igo.context.permission.read\' | translate }}\r\n      </mat-radio-button>\r\n      <mat-radio-button value="write">\r\n        {{ \'igo.context.permission.write\' | translate }}\r\n      </mat-radio-button>\r\n    </mat-radio-group>\r\n\r\n\r\n    <div class="igo-form-button-group">\r\n      <button\r\n        mat-raised-button\r\n        type="submit"\r\n        [disabled]="!form.valid">\r\n        {{ \'igo.context.permission.addBtn\' | translate }}\r\n      </button>\r\n    </div>\r\n\r\n  </form>\r\n\r\n  <igo-list *ngIf="permissions && context.scope !== \'private\'">\r\n    <ng-template ngFor let-groupPermissions [ngForOf]="permissions | keyvalue">\r\n      <igo-collapsible\r\n        *ngIf="groupPermissions.value.length"\r\n        [title]="\'igo.context.permission.\' + groupPermissions.key | translate">\r\n\r\n        <ng-template ngFor let-permission [ngForOf]="groupPermissions.value">\r\n          <mat-list-item>\r\n            <mat-icon mat-list-avatar svgIcon="account-outline"></mat-icon>\r\n            <h4 mat-line>{{permission.profilTitle}} <small class="mat-typography">{{permission.profil}}</small></h4>\r\n\r\n            <div igoStopPropagation\r\n                 class="igo-actions-container">\r\n\r\n               <button *ngIf="canWrite || permission.profil === authService.decodeToken().user.sourceId"\r\n                 mat-icon-button\r\n                 [matTooltip]="\'igo.context.permission.delete\' | translate"\r\n                 matTooltipShowDelay="500"\r\n                 color="warn"\r\n                 (click)="removePermission.emit(permission)">\r\n                 <mat-icon svgIcon="delete"></mat-icon>\r\n               </button>\r\n            </div>\r\n\r\n          </mat-list-item>\r\n        </ng-template>\r\n      </igo-collapsible>\r\n    </ng-template>\r\n  </igo-list>\r\n\r\n</div>\r\n',styles:[":host{margin:10px}.full-width{width:100%}mat-radio-button{padding:14px 14px 14px 0}.scopeForm,form{padding:5px}mat-option ::ng-deep .mat-option-text{line-height:initial}"]}]}],Zt.ctorParameters=function(){return[{type:i.FormBuilder},{type:x.ChangeDetectorRef},{type:e.HttpClient},{type:s.AuthService}]},Zt.propDecorators={context:[{type:x.Input}],permissions:[{type:x.Input}],addPermission:[{type:x.Output}],removePermission:[{type:x.Output}],scopeChanged:[{type:x.Output}]},Zt);function Zt(t,e,o,n){this.formBuilder=t,this.cd=e,this.http=o,this.authService=n,this._profils=[],this.baseUrlProfils="/apis/igo2/profils-users?",this.formControl=new i.FormControl,this.addPermission=new x.EventEmitter,this.removePermission=new x.EventEmitter,this.scopeChanged=new x.EventEmitter}var Yt=(Qt.prototype.onAddPermission=function(u){var p=this,d=this.languageService.translate;if(u.profil){var t=this.component.context.id;this.contextService.addPermissionAssociation(t,u.profil,u.typePermission).subscribe(function(t){var e,o;try{for(var n=D(t),r=n.next();!r.done;r=n.next()){var i=r.value;p.component.permissions[u.typePermission].push(i)}}catch(l){e={error:l}}finally{try{r&&!r.done&&(o=n["return"])&&o.call(n)}finally{if(e)throw e.error}}var a=u.profil,s=d.instant("igo.context.permission.dialog.addMsg",{value:a}),c=d.instant("igo.context.permission.dialog.addTitle");p.messageService.success(s,c),p.cd.detectChanges()})}else{var e=d.instant("igo.context.contextManager.errors.addPermissionEmpty"),o=d.instant("igo.context.contextManager.errors.addPermissionTitle");this.messageService.error(e,o)}},Qt.prototype.onRemovePermission=function(i){var a=this,t=this.component.context.id;this.contextService.deletePermissionAssociation(t,i.id).subscribe(function(){var t=a.component.permissions[i.typePermission].findIndex(function(t){return t.id===i.id});a.component.permissions[i.typePermission].splice(t,1);var e=i.profil,o=a.languageService.translate,n=o.instant("igo.context.permission.dialog.deleteMsg",{value:e}),r=o.instant("igo.context.permission.dialog.deleteTitle");a.messageService.success(n,r),a.cd.detectChanges()})},Qt.prototype.onScopeChanged=function(t){var n=this,r=t.scope;this.contextService.update(t.id,{scope:r}).subscribe(function(){var t=n.languageService.translate,e=t.instant("igo.context.permission.dialog.scopeChangedMsg",{value:t.instant("igo.context.permission.scope."+r)}),o=t.instant("igo.context.permission.dialog.scopeChangedTitle");n.messageService.success(e,o)})},Qt.prototype.ngOnInit=function(){var e=this;this.editedContext$$=this.contextService.editedContext$.subscribe(function(t){return e.handleEditedContextChange(t)})},Qt.prototype.ngOnDestroy=function(){this.editedContext$$.unsubscribe(),this.contextService.editedContext$.next(undefined)},Qt.prototype.handleEditedContextChange=function(t){var o=this;(this.component.context=t)&&this.contextService.getPermissions(t.id).subscribe(function(t){var e={read:(t=t||[]).filter(function(t){return"read"===t.typePermission.toString()}),write:t.filter(function(t){return"write"===t.typePermission.toString()})};return o.component.permissions=e})},Qt.decorators=[{type:x.Directive,args:[{selector:"[igoContextPermissionsBinding]"}]}],Qt.ctorParameters=function(){return[{type:Jt,decorators:[{type:x.Self}]},{type:et},{type:v.LanguageService},{type:v.MessageService},{type:x.ChangeDetectorRef}]},Qt.propDecorators={onAddPermission:[{type:x.HostListener,args:["addPermission",["$event"]]}],onRemovePermission:[{type:x.HostListener,args:["removePermission",["$event"]]}],onScopeChanged:[{type:x.HostListener,args:["scopeChanged",["$event"]]}]},Qt);function Qt(t,e,o,n,r){this.contextService=e,this.languageService=o,this.messageService=n,this.cd=r,this.component=t}var Xt=(Object.defineProperty(te.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(te.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t},enumerable:!0,configurable:!0}),te.prototype.createContext=function(){var r=this;this.dialog.open(Ft,{disableClose:!1}).afterClosed().subscribe(function(t){if(t){var n=r.contextService.getContextFromMap(r.map);n.title=t,r.contextService.create(n).subscribe(function(){var t=r.languageService.translate,e=t.instant("igo.context.bookmarkButton.dialog.createTitle"),o=t.instant("igo.context.bookmarkButton.dialog.createMsg",{value:n.title});r.messageService.success(o,e),r.contextService.loadContext(n.uri)})}})},te.decorators=[{type:x.Component,args:[{selector:"igo-bookmark-button",template:'<div class="igo-bookmark-button-container">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]="\'igo.context.bookmarkButton.create\' | translate"\r\n    matTooltipPosition="above"\r\n    [color]="color"\r\n    (click)="createContext()">\r\n    <mat-icon svgIcon="star"></mat-icon>\r\n  </button>\r\n</div>\r\n',styles:[".igo-bookmark-button-container{width:40px}.igo-bookmark-button-container button{background-color:#fff}.igo-bookmark-button-container button:hover{background-color:#efefef}:host>>>button .mat-button-ripple-round,button{border-radius:0}"]}]}],te.ctorParameters=function(){return[{type:p.MatDialog},{type:et},{type:v.LanguageService},{type:v.MessageService}]},te.propDecorators={map:[{type:x.Input}],color:[{type:x.Input}]},te);function te(t,e,o,n){this.dialog=t,this.contextService=e,this.languageService=o,this.messageService=n}var ee=(oe.prototype.get=function(){if(!this.baseUrl)return b.EMPTY;var t=this.baseUrl+"/pois";return this.http.get(t)},oe.prototype["delete"]=function(t){var e=this.baseUrl+"/pois/"+t;return this.http["delete"](e)},oe.prototype.create=function(t){var e=this.baseUrl+"/pois";return this.http.post(e,JSON.stringify(t))},oe.decorators=[{type:x.Injectable}],oe.ctorParameters=function(){return[{type:e.HttpClient},{type:v.ConfigService}]},oe);function oe(t,e){this.http=t,this.config=e,this.baseUrl=this.config.getConfig("context.url")}var ne=(re.decorators=[{type:x.Component,args:[{selector:"igo-poi-dialog",template:'<h1 mat-dialog-title class="mat-typography">{{ \'igo.context.poiButton.dialog.title\' | translate }}</h1>\r\n<div mat-dialog-content>\r\n  <mat-form-field>\r\n    <input matInput required autocomplete="off"\r\n      [placeholder]="\'igo.context.poiButton.dialog.placeholder\' | translate"\r\n      [(ngModel)]="title">\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color="primary"\r\n         [disabled]="!title"\r\n         (click)="dialogRef.close(title)">\r\n    {{\'igo.common.confirmDialog.confirmBtn\' | translate}}\r\n  </button>\r\n  <button mat-button\r\n          (click)="dialogRef.close(false)">\r\n    {{\'igo.common.confirmDialog.cancelBtn\' | translate}}\r\n  </button>\r\n</div>\r\n'}]}],re.ctorParameters=function(){return[{type:p.MatDialogRef}]},re);function re(t){this.dialogRef=t}var ie=(Object.defineProperty(ae.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(ae.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t},enumerable:!0,configurable:!0}),ae.prototype.ngOnInit=function(){var e=this;this.authenticate$$=this.authService.authenticate$.subscribe(function(t){t&&e.getPois()})},ae.prototype.ngOnDestroy=function(){this.authenticate$$.unsubscribe()},ae.prototype.deletePoi=function(o){var n=this;if(o&&o.id){var r=this.languageService.translate;this.confirmDialogService.open(r.instant("igo.context.poiButton.dialog.confirmDelete")).subscribe(function(t){t&&n.poiService["delete"](o.id).subscribe(function(){var t=r.instant("igo.context.poiButton.dialog.deleteTitle"),e=r.instant("igo.context.poiButton.dialog.deleteMsg",{value:o.title});n.messageService.info(e,t),n.pois=n.pois.filter(function(t){return t.id!==o.id})},function(t){t.error.title="DELETE Pois",n.messageService.showError(t)})})}},ae.prototype.getPois=function(){var e=this;this.poiService.get().subscribe(function(t){e.pois=t},function(t){t.error.title="GET Pois",e.messageService.showError(t)})},ae.prototype.createPoi=function(){var r=this,t=this.map.ol.getView(),e=t.getProjection().getCode(),o=new h(t.getCenter()).transform(e,"EPSG:4326"),i={title:"",x:o.getCoordinates()[0],y:o.getCoordinates()[1],zoom:t.getZoom()};this.dialog.open(ne,{disableClose:!1}).afterClosed().subscribe(function(t){t&&(i.title=t,r.poiService.create(i).subscribe(function(t){var e=r.languageService.translate,o=e.instant("igo.context.poiButton.dialog.createTitle"),n=e.instant("igo.context.poiButton.dialog.createMsg",{value:i.title});r.messageService.success(n,o),i.id=t.id,r.pois.push(i)},function(t){t.error.title="POST Pois",r.messageService.showError(t)}))})},ae.prototype.zoomOnPoi=function(e){var t=this.pois.find(function(t){return t.id===e}),o=n.fromLonLat([Number(t.x),Number(t.y)],this.map.projection);this.map.ol.getView().animate({center:o,zoom:t.zoom,duration:500,easing:r.easeOut})},ae.decorators=[{type:x.Component,args:[{selector:"igo-poi-button",template:'<mat-select [placeholder]="\'igo.context.poiButton.placeholder\' | translate"\r\n           floatPlaceholder="never">\r\n\r\n  <mat-option (click)="createPoi()">\r\n    <div class="titlePoi">{{ \'igo.context.poiButton.create\' | translate }}</div>\r\n    <button igoStopPropagation class="addPoi buttonPoi"\r\n      mat-icon-button\r\n      color="primary"\r\n      (click)="createPoi()">\r\n      <mat-icon svgIcon="plus-circle"></mat-icon>\r\n    </button>\r\n  </mat-option>\r\n  <mat-option *ngFor="let poi of pois" [value]="poi.id" (click)="zoomOnPoi(poi.id)">\r\n    <div class="titlePoi">{{ poi.title }}</div>\r\n    <button igoStopPropagation class="deletePoi buttonPoi"\r\n      mat-icon-button\r\n      color="warn"\r\n      (click)="deletePoi(poi)">\r\n      <mat-icon svgIcon="delete"></mat-icon>\r\n    </button>\r\n  </mat-option>\r\n</mat-select>\r\n',styles:["mat-select{width:150px;background-color:#fff;height:40px;padding-top:0}mat-select>>>.mat-select-trigger{height:40px}mat-select>>>.mat-select-placeholder,mat-select>>>.mat-select-value-text{padding:5px;top:12px;position:relative}.mat-option{text-overflow:inherit}.titlePoi{max-width:135px;overflow:hidden;text-overflow:ellipsis;float:left}.buttonPoi{float:right;margin:4px -10px 4px 0}.buttonPoi>>>.mat-icon{margin:0 8px}"]}]}],ae.ctorParameters=function(){return[{type:p.MatDialog},{type:s.AuthService},{type:ee},{type:v.MessageService},{type:v.LanguageService},{type:m.ConfirmDialogService}]},ae.propDecorators={map:[{type:x.Input}],color:[{type:x.Input}]},ae);function ae(t,e,o,n,r,i){this.dialog=t,this.authService=e,this.poiService=o,this.messageService=n,this.languageService=r,this.confirmDialogService=i}var se=(ce.decorators=[{type:x.Component,args:[{selector:"igo-user-dialog",template:'<h1 mat-dialog-title class="mat-typography">{{\'igo.context.userButton.infoTitle\' | translate}}</h1>\r\n<div mat-dialog-content class="mat-typography">\r\n  <p>{{\'igo.context.userButton.dialog.user\' | translate}}: {{user.sourceId}}</p>\r\n  <p>{{\'igo.context.userButton.dialog.email\' | translate}}: {{user.email}}</p>\r\n  <p>{{\'igo.context.userButton.dialog.expiration\' | translate}}: {{exp}}</p>\r\n</div>\r\n<div mat-dialog-actions style="justify-content: center">\r\n  <button mat-button color="primary"\r\n         (click)="dialogRef.close(false)">\r\n    OK\r\n  </button>\r\n</div>\r\n'}]}],ce.ctorParameters=function(){return[{type:p.MatDialogRef},{type:s.AuthService}]},ce);function ce(t,e){this.dialogRef=t,this.auth=e;var o=this.auth.decodeToken();this.user=o.user,this.exp=new Date(1e3*o.exp).toLocaleString()}function le(){return o.trigger("userButtonState",[o.state("collapse",o.style({width:"0",overflow:"hidden",display:"none"})),o.state("expand",o.style({overflow:"hidden",display:"display"})),o.transition("collapse => expand",o.animate("200ms")),o.transition("expand => collapse",o.animate("200ms"))])}var ue=(Object.defineProperty(pe.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(pe.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t},enumerable:!0,configurable:!0}),pe.prototype.accountClick=function(){this.auth.authenticated?this.expand=!this.expand:this.auth.logout()},pe.prototype.logout=function(){this.expand=!1,this.auth.logout()},pe.prototype.infoUser=function(){this.dialog.open(se,{disableClose:!1})},pe.decorators=[{type:x.Component,args:[{selector:"igo-user-button",template:'<div *ngIf="visible" class="igo-user-button-container">\r\n  <div class="igo-user-button-more-container" [@userButtonState]="expand ? \'expand\' : \'collapse\'">\r\n\r\n    <igo-poi-button *ngIf="hasApi" [color]="color" [map]="map"></igo-poi-button>\r\n    <igo-bookmark-button *ngIf="hasApi" [color]="color" [map]="map"></igo-bookmark-button>\r\n\r\n    <button\r\n      mat-icon-button\r\n      [matTooltip]="\'igo.context.userButton.infoTitle\' | translate"\r\n      matTooltipPosition="above"\r\n      [color]="color"\r\n      (click)="infoUser()">\r\n      <mat-icon svgIcon="information-outline"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      mat-icon-button\r\n      [matTooltip]="\'igo.context.userButton.logout\' | translate"\r\n      matTooltipPosition="above"\r\n      [color]="color"\r\n      (click)="logout()">\r\n      <mat-icon svgIcon="power"></mat-icon>\r\n    </button>\r\n\r\n  </div>\r\n\r\n  <button\r\n    mat-icon-button\r\n    [color]="auth.authenticated ? color : \'warn\'"\r\n    (click)="accountClick()">\r\n    <mat-icon svgIcon="account-box"></mat-icon>\r\n  </button>\r\n</div>\r\n',animations:[le()],styles:[".igo-user-button-container button{background-color:#fff}.igo-user-button-container button:hover{background-color:#efefef}.igo-user-button-more-container{float:left;height:40px}.igo-user-button-more-container>*{margin-right:2px;float:left}@media only screen and (orientation:portrait) and (max-width:599px),only screen and (orientation:landscape) and (max-width:959px){.igo-user-button-container>button{position:absolute;bottom:0}.igo-user-button-more-container{height:80px;width:150px;position:relative;left:24px}}:host>>>button .mat-button-ripple-round,button{border-radius:0}"]}]}],pe.ctorParameters=function(){return[{type:p.MatDialog},{type:v.ConfigService},{type:s.AuthService}]},pe.propDecorators={map:[{type:x.Input}],color:[{type:x.Input}]},pe);function pe(t,e,o){this.dialog=t,this.config=e,this.auth=o,this.expand=!1,this.visible=!1,this.hasApi=!1,this.visible=!!this.config.getConfig("auth"),this.hasApi=this.config.getConfig("context.url")!==undefined}var de=(me.forRoot=function(){return{ngModule:me}},me.decorators=[{type:x.NgModule,args:[{imports:[c.CommonModule,v.IgoLanguageModule,m.IgoConfirmDialogModule,m.IgoStopPropagationModule,s.IgoAuthModule,i.FormsModule,p.MatIconModule,p.MatButtonModule,p.MatSelectModule,p.MatOptionModule,p.MatTooltipModule,p.MatFormFieldModule,p.MatDialogModule,p.MatInputModule],exports:[Xt,ie,ue,Ft],declarations:[Xt,Ft,ie,ne,ue,se],entryComponents:[Ft,ne,se],providers:[ee]}]}],me);function me(){}var ge=[Tt,Lt],he=(fe.forRoot=function(){return{ngModule:fe}},fe.decorators=[{type:x.NgModule,args:[{imports:[c.CommonModule,i.FormsModule,i.ReactiveFormsModule,p.MatFormFieldModule,p.MatInputModule,p.MatIconModule,p.MatButtonModule,p.MatTooltipModule,p.MatListModule,p.MatCheckboxModule,p.MatRadioModule,p.MatDialogModule,p.MatMenuModule,p.MatOptionModule,p.MatAutocompleteModule,s.IgoAuthModule,m.IgoListModule,m.IgoKeyValueModule,m.IgoCollapsibleModule,m.IgoStopPropagationModule,v.IgoLanguageModule,Et,de,m.IgoActionbarModule],entryComponents:[Ft],exports:F([At,Ut,Rt,qt,Vt,Wt,Jt,Yt],ge),declarations:F([At,Ut,Rt,qt,Vt,Wt,Jt,Yt],ge)}]}],fe);function fe(){}var xe=(ve.prototype.getUrl=function(t,e,o){return this.apiUrl?this.getUrlWithApi(t,e):this.getUrlWithoutApi(t,o)},ve.prototype.getUrlWithApi=function(t,e){var o=this,n=this.contextService.getContextFromMap(t);return n.scope="public",n.title=e.title,n.uri=e.uri,this.contextService.create(n).subscribe(function(t){},function(t){t.error.title="Share Map",o.messageService.showError(t)}),location.origin+location.pathname+"?context="+e.uri},ve.prototype.getUrlWithoutApi=function(t,e){var o,n,r,i;if(this.route&&this.route.options.visibleOnLayersKey&&this.route.options.visibleOffLayersKey&&t.viewController.getZoom()){var a=e.layerlistControls.querystring,s=this.route.options.visibleOnLayersKey,c=this.route.options.visibleOffLayersKey,l=t.layers,u=l.filter(function(t){return t.visible&&"searchPointerSummaryId"!==t.id}),p=l.filter(function(t){return!t.visible&&"searchPointerSummaryId"!==t.id});0===u.length&&(s=""),0===p.length&&(c="");var d="",m=[];m=u.length>p.length?(d=s+"=*&"+c+"=",p):(d=c+"=*&"+s+"=",u);try{for(var g=D(m),h=g.next();!h.done;h=g.next()){var f=h.value;f.id&&(d+=f.id+",")}}catch(L){o={error:L}}finally{try{h&&!h.done&&(n=g["return"])&&n.call(g)}finally{if(o)throw o.error}}var x=[],v=this.contextService.context$.value.layers;try{for(var y=D(v),b=y.next();!b.done;b=y.next()){var S=b.value;x.push(S.id||S.source.id)}}catch(j){r={error:j}}finally{try{b&&!b.done&&(i=y["return"])&&i.call(y)}finally{if(r)throw r.error}}var C=this.makeLayersByService(l,x,"wms"),w=this.makeLayersByService(l,x,"wmts");d=d.substr(0,d.length-1);var M=this.route.options.zoomKey,I=this.route.options.centerKey,P=this.route.options.contextKey,E=M+"="+t.viewController.getZoom(),O=t.viewController.getCenter("EPSG:4326")||[],F=(I+"="+O[0].toFixed(5).replace(/\.([^0]+)0+$/,".$1")+","+O[1].toFixed(5).replace(/\.([^0]+)0+$/,".$1")).replace(/.00000/g,""),k="";this.contextService.context$.value&&(k=P+"="+this.contextService.context$.value.uri);for(var T=""+location.origin+location.pathname+"?"+k+"&"+E+"&"+F+"&"+d+"&"+a+"&"+C+"&"+a+"&"+w,$=0;$<5;$++)T=(T=T.replace(/&&/g,"&")).endsWith("&")?T.slice(0,-1):T;return T=(T=(T=T.endsWith("&")?T.slice(0,-1):T).replace("?&wm","&wm")).replace("?&","?")}},ve.prototype.makeLayersByService=function(t,r,e){var o,n,i=[],a=function(t){if(-1===r.indexOf(t.id)){var e=t.dataSource.options.url,o="";"wms"===t.dataSource.options.type?o=encodeURIComponent(t.dataSource.options.params.LAYERS):"wmts"===t.dataSource.options.type&&(o=encodeURIComponent(t.dataSource.options.layer));var n=o+":igoz"+t.zIndex;i.find(function(t){return t.url===e})?i.forEach(function(t){t.url===e&&t.layers.push(n)}):i.push({url:e,layers:[n]})}};try{for(var s=D(t.filter(function(t){return t.dataSource.options&&t.dataSource.options.type===e})),c=s.next();!c.done;c=s.next())a(c.value)}catch(g){o={error:g}}finally{try{c&&!c.done&&(n=s["return"])&&n.call(s)}finally{if(o)throw o.error}}var l="";if(1<=i.length){var u="wms"===e?this.route.options.wmsUrlKey:"wmts"===e?this.route.options.wmtsUrlKey:"",p="wms"===e?this.route.options.wmsLayersKey:"wmts"===e?this.route.options.wmtsLayersKey:"",d="",m="";i.forEach(function(t){d+=t.url+",",m+="("+t.layers.join(",")+"),"}),d=d.endsWith(",")?d.slice(0,-1):d,m=m.endsWith(",")?m.slice(0,-1):m,l=u+"="+d+"&"+p+"="+m}return l},ve.decorators=[{type:x.Injectable,args:[{providedIn:"root"}]}],ve.ctorParameters=function(){return[{type:v.ConfigService},{type:et},{type:v.MessageService},{type:v.RouteService,decorators:[{type:x.Optional}]}]},ve.ngInjectableDef=x.defineInjectable({factory:function(){return new ve(x.inject(v.ConfigService),x.inject(et),x.inject(v.MessageService),x.inject(v.RouteService,8))},token:ve,providedIn:"root"}),ve);function ve(t,e,o,n){this.config=t,this.contextService=e,this.messageService=o,this.route=n,this.apiUrl=this.config.getConfig("context.url")}var ye=(be.prototype.ngOnInit=function(){var o=this;this.auth.authenticate$.subscribe(function(t){var e=o.auth.decodeToken();o.userId=e.user?e.user.id:undefined,o.url=undefined,o.buildForm()}),this.mapState$$=this.map.viewController.state$.subscribe(function(t){o.hasApi||(o.resetUrl(),o.cdRef.detectChanges())})},be.prototype.ngAfterViewInit=function(){this.hasApi||this.resetUrl()},be.prototype.ngOnDestroy=function(){this.mapState$$.unsubscribe()},be.prototype.resetUrl=function(t){void 0===t&&(t={});var e=Object.assign({},t);e.uri=this.userId?this.userId+"-"+t.uri:t.uri,this.url=this.shareMapService.getUrl(this.map,e,this.publicShareOption)},be.prototype.copyTextToClipboard=function(t){if(y.Clipboard.copy(t)){var e=this.languageService.translate,o=e.instant("igo.context.shareMap.dialog.copyTitle"),n=e.instant("igo.context.shareMap.dialog.copyMsg");this.messageService.success(n,o)}},be.prototype.buildForm=function(){var t=y.uuid(),e="Partage ";e+=this.userId?"("+this.userId+"-"+t+")":"("+t+")",this.form=this.formBuilder.group({title:[e],uri:[t]})},be.decorators=[{type:x.Component,args:[{selector:"igo-share-map",template:'<form class="igo-form" [formGroup]="form"\r\n  (ngSubmit)="resetUrl(form.value)">\r\n\r\n  <div *ngIf="hasApi" class="igo-input-container">\r\n    <mat-form-field>\r\n      <input matInput required\r\n             [placeholder]="\'igo.context.contextManager.form.title\' | translate"\r\n             formControlName="title">\r\n     <mat-error>\r\n      {{ \'igo.context.contextManager.form.titleRequired\' | translate }}\r\n     </mat-error>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div *ngIf="hasApi" id="uriInput" class="igo-input-container">\r\n    <mat-form-field>\r\n      <span *ngIf="userId" class="prefix">{{userId}}-</span>\r\n      <span class="fieldWrapper">\r\n        <input matInput required\r\n             [readonly]="!userId"\r\n             [placeholder]="\'igo.context.contextManager.form.uri\' | translate"\r\n             formControlName="uri">\r\n       </span>\r\n     <mat-error>\r\n      {{ \'igo.context.contextManager.form.uriRequired\' | translate }}\r\n     </mat-error>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div *ngIf="hasApi" class="igo-form-button-group">\r\n    <button\r\n      mat-raised-button\r\n      type="submit"\r\n      [disabled]="!form.valid">\r\n      {{ \'igo.context.shareMap.button\' | translate }}\r\n    </button>\r\n  </div>\r\n\r\n</form>\r\n\r\n<div *ngIf="url" class="igo-input-container linkToShare">\r\n  <mat-form-field>\r\n    <textarea #textArea matInput readonly rows="1"\r\n      [ngClass]="{\'textAreaWithButton\': hasApi}"\r\n      [placeholder]="\'igo.context.shareMap.placeholderLink\' | translate"\r\n      [value]="url"></textarea>\r\n    <button *ngIf="hasApi"\r\n      mat-icon-button\r\n      tooltip-position="below"\r\n      matTooltipShowDelay="500"\r\n      [matTooltip]="\'igo.context.shareMap.copy\' | translate"\r\n      color="primary"\r\n      (click)="copyTextToClipboard(textArea)">\r\n      <mat-icon svgIcon="content-copy"></mat-icon>\r\n    </button>\r\n  </mat-form-field>\r\n\r\n  <div *ngIf="!hasApi" class="igo-form-button-group">\r\n    <button\r\n      mat-raised-button\r\n      (click)="copyTextToClipboard(textArea)">\r\n      <mat-icon svgIcon="content-copy"></mat-icon>\r\n      {{ \'igo.context.shareMap.copy\' | translate }}\r\n    </button>\r\n  </div>\r\n  <div *ngIf="!hasApi">\r\n    <br/>\r\n    <section class="mat-typography">\r\n        <h4>{{\'igo.context.shareMap.included\' | translate}}</h4>\r\n        <ul>\r\n          <li>{{\'igo.context.shareMap.context\' | translate}}</li>\r\n          <li>{{\'igo.context.shareMap.center\' | translate}}</li>\r\n          <li>{{\'igo.context.shareMap.zoom\' | translate}}</li>\r\n          <li>{{\'igo.context.shareMap.addedLayers\' | translate}}</li>\r\n          <li>{{\'igo.context.shareMap.visibleInvisible\' | translate}}</li>\r\n        </ul>\r\n\r\n      <h4>{{\'igo.context.shareMap.excluded\' | translate}}</h4>\r\n      <ul>\r\n        <li>{{\'igo.context.shareMap.order\' | translate}}</li>\r\n        <li>{{\'igo.context.shareMap.opacity\' | translate}}</li>\r\n        <li>{{\'igo.context.shareMap.filterOgc\' | translate}}</li>\r\n        <li>{{\'igo.context.shareMap.filterTime\' | translate}}</li>\r\n      </ul>\r\n    </section>\r\n  </div>\r\n\r\n</div>\r\n',styles:['@charset "UTF-8";mat-form-field{width:100%}#uriInput .fieldWrapper{display:block;overflow:hidden}#uriInput .prefix{float:left}.linkToShare{padding:25px 5px 5px}.linkToShare textarea{resize:none;width:100%;line-height:1.3;height:40px;overflow-y:hidden;word-wrap:normal;word-break:break-all}.linkToShare textarea.textAreaWithButton{width:calc(100% - 60px)}.linkToShare mat-form-field>button{float:right;margin:-10px 0}.igo-form{padding:20px 5px 5px}.igo-form-button-group{text-align:center;padding-top:10px}']}]}],be.ctorParameters=function(){return[{type:v.ConfigService},{type:v.LanguageService},{type:v.MessageService},{type:s.AuthService},{type:xe},{type:i.FormBuilder},{type:x.ChangeDetectorRef}]},be.propDecorators={map:[{type:x.Input}]},be);function be(t,e,o,n,r,i,a){this.config=t,this.languageService=e,this.messageService=o,this.auth=n,this.shareMapService=r,this.formBuilder=i,this.cdRef=a,this.hasApi=!1,this.publicShareOption={layerlistControls:{querystring:""}},this.hasApi=!!this.config.getConfig("context.url")}var Se=(Ce.forRoot=function(){return{ngModule:Ce}},Ce.decorators=[{type:x.NgModule,args:[{imports:[c.CommonModule,i.FormsModule,i.ReactiveFormsModule,p.MatIconModule,p.MatTooltipModule,p.MatFormFieldModule,p.MatInputModule,p.MatButtonModule,v.IgoLanguageModule],exports:[ye],declarations:[ye]}]}],Ce);function Ce(){}var we=(Object.defineProperty(Me.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0}),Object.defineProperty(Me.prototype,"opened",{get:function(){return this._opened},set:function(t){this._opened=t},enumerable:!0,configurable:!0}),Object.defineProperty(Me.prototype,"feature",{get:function(){return this._feature},set:function(t){this._feature=t},enumerable:!0,configurable:!0}),Object.defineProperty(Me.prototype,"tool",{get:function(){return this._tool},set:function(t){this._tool=t},enumerable:!0,configurable:!0}),Object.defineProperty(Me.prototype,"media",{get:function(){return this._media},set:function(t){this._media=t},enumerable:!0,configurable:!0}),Object.defineProperty(Me.prototype,"title",{get:function(){return this._title},set:function(t){t&&(this._title=t)},enumerable:!0,configurable:!0}),Object.defineProperty(Me.prototype,"featureTitle",{get:function(){return this.feature?m.getEntityTitle(this.feature):undefined},enumerable:!0,configurable:!0}),Me.prototype.zoomToFeatureExtent=function(){if(this.feature.geometry){var t=this.format.readFeature(this.feature,{dataProjection:this.feature.projection,featureProjection:this.map.projection});g.moveToOlFeatures(this.map,[t],g.FeatureMotion.Zoom)}},Me.prototype.toggleTopPanel=function(){"initial"===this.topPanelState?this.topPanelState="expanded":this.topPanelState="initial"},Me.decorators=[{type:x.Component,args:[{selector:"igo-sidenav",template:'<mat-sidenav\r\n  #sidenav\r\n  igoSidenavShim\r\n  mode="side"\r\n  [opened]="opened">\r\n\r\n  <div class="igo-sidenav-content">\r\n\r\n    <igo-flexible\r\n      #topPanel\r\n      initial="50%" initialMobile="100%"\r\n      expanded="calc(100% - 58px)"\r\n      [state]="topPanelState">\r\n\r\n      <div class="igo-content">\r\n        <igo-panel [title]="tool ? (tool.title | translate) : title">\r\n          <button\r\n            mat-icon-button\r\n            panelLeftButton\r\n            tooltip-position="below"\r\n            matTooltipShowDelay="500"\r\n            [matTooltip]="\'igo.context.sidenav.goBack\' | translate"\r\n            *ngIf="tool">\r\n            <mat-icon svgIcon="arrow-back"></mat-icon>\r\n          </button>\r\n\r\n          <button\r\n            mat-icon-button\r\n            panelRightButton\r\n            tooltip-position="below"\r\n            matTooltipShowDelay="500"\r\n            [matTooltip]="\'igo.context.sidenav.mainMenu\' | translate"\r\n            *ngIf="tool">\r\n            <mat-icon svgIcon="menu"></mat-icon>\r\n          </button>\r\n\r\n        </igo-panel>\r\n      </div>\r\n\r\n      <div igoFlexibleFill class="igo-content">\r\n        <igo-panel\r\n          [title]="featureTitle"\r\n          *ngIf="feature && media !== \'mobile\'">\r\n\r\n          <button\r\n            mat-icon-button\r\n            panelLeftButton\r\n            class="igo-icon-button"\r\n            (click)="toggleTopPanel()">\r\n            <mat-icon [svgIcon]="[\'collapsed\', \'initial\'].indexOf(topPanel.state) >= 0 ? \'arrow_downward\' : \'arrow_upward\'"></mat-icon>\r\n          </button>\r\n\r\n          <button\r\n            mat-icon-button\r\n            panelRightButton\r\n            class="igo-icon-button"\r\n            (click)="zoomToFeatureExtent()"\r\n            *ngIf="feature.geometry">\r\n            <mat-icon svgIcon="zoom-in"></mat-icon>\r\n          </button>\r\n\r\n          <igo-feature-details\r\n            [feature]="feature"\r\n            *ngIf="[\'collapsed\', \'initial\'].indexOf(topPanel.state) >= 0">\r\n          </igo-feature-details>\r\n        </igo-panel>\r\n      </div>\r\n\r\n    </igo-flexible>\r\n\r\n  </div>\r\n</mat-sidenav>\r\n',styles:[".igo-sidenav-content .igo-flexible-fill .igo-container,:host ::ng-deep .igo-flexible-fill .igo-container{box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;border-top:1px solid rgba(0,0,0,.2)}mat-sidenav{-o-box-shadow:2px 0 2px 0 #ddd;box-shadow:2px 0 2px 0 #ddd;width:400px}:host{background-color:#fff}:host ::ng-deep mat-sidenav{z-index:3!important}@media only screen and (orientation:portrait) and (max-width:599px),only screen and (orientation:landscape) and (max-width:959px){mat-sidenav{width:calc(100% - 40px - 5px)}}.igo-sidenav-content{margin-top:50px;height:calc(100% - 50px)}igo-feature-details ::ng-deep table{width:100%}"]}]}],Me.ctorParameters=function(){return[{type:d.Title}]},Me.propDecorators={map:[{type:x.Input}],opened:[{type:x.Input}],feature:[{type:x.Input}],tool:[{type:x.Input}],media:[{type:x.Input}],title:[{type:x.Input}]},Me);function Me(t){this.titleService=t,this.format=new f,this._title=this.titleService.getTitle(),this.topPanelState="initial"}var Ie=(Pe.forRoot=function(){return{ngModule:Pe}},Pe.decorators=[{type:x.NgModule,args:[{imports:[c.CommonModule,p.MatIconModule,p.MatButtonModule,p.MatSidenavModule,p.MatTooltipModule,v.IgoLanguageModule,m.IgoPanelModule,m.IgoFlexibleModule,g.IgoFeatureModule,he],exports:[we],declarations:[we]}]}],Pe);function Pe(){}var Ee=(Oe.forRoot=function(){return{ngModule:Oe,providers:[]}},Oe.decorators=[{type:x.NgModule,args:[{imports:[p.MatInputModule,p.MatFormFieldModule,p.MatMenuModule],declarations:[],exports:[Et,he,de,Se,Ie]}]}],Oe);function Oe(){}var Fe,ke=(E(Te,Fe=wt),Te.prototype.exportAsync=function(n){var r=this;return new b.Observable(function(t){if(!0!==Fe.prototype.nothingToExport.call(r,n)){var e=JSON.stringify(n);if(r.platform.is("cordova")){var o=r.config.getConfig("ExportDirectory");r.file.writeFile(o,n.uri+".json",e,{replace:!0}).then(function(t){return r.fileOpener.open(o+"/"+n.uri+".json","text/plain")}),t.complete()}else y.downloadContent(e,"text/json;charset=utf-8",n.uri+".json"),t.complete()}else t.error(new _)})},Te.decorators=[{type:x.Injectable,args:[{providedIn:"root"}]}],Te.ctorParameters=function(){return[{type:v.ConfigService},{type:S.Platform},{type:w.FileOpener},{type:C.File}]},Te.ngInjectableDef=x.defineInjectable({factory:function(){return new Te(x.inject(v.ConfigService),x.inject(S.Platform),x.inject(M.FileOpener),x.inject(I.File))},token:Te,providedIn:"root"}),Te);function Te(t,e,o,n){var r=Fe.call(this)||this;return r.config=t,r.platform=e,r.fileOpener=o,r.file=n,r}t.IgoContextModule=Ee,t.IgoContextImportExportModule=Et,t.IgoContextManagerModule=he,t.IgoContextMapButtonModule=de,t.IgoShareMapModule=Se,t.IgoSidenavModule=Ie,t.ExportError=T,t.ExportInvalidFileError=j,t.ExportNothingToExportError=_,t.ImportError=rt,t.ImportInvalidFileError=st,t.ImportUnreadableFileError=ut,t.ImportNothingToImportError=mt,t.ImportSizeError=ft,t.ImportSRSError=yt,t.ContextExportService=wt,t.ContextExportIonicService=ke,t.ContextImportService=St,t.handleFileImportSuccess=N,t.handleFileImportError=q,t.handleInvalidFileImportError=H,t.handleSizeFileImportError=V,t.handleUnreadbleFileImportError=K,t.handleNothingToImportError=W,t.addContextToContextList=G,t.getFileExtension=J,t.computeLayerTitleFromFile=Z,t.addImportedFeaturesToMap=Y,t.addImportedFeaturesStyledToMap=Q,t.handleFileExportError=z,t.handleFileExportSuccess=R,t.handleNothingToExportError=function $e(t,e){var o=e.translate,n=o.instant("igo.context.contextImportExport.export.nothing.title"),r=o.instant("igo.context.contextImportExport.export.nothing.text");t.error(r,n)},t.ContextImportExportComponent=It,t.ContextService=et,t.TypePermission=X,t.Scope=tt,t.LayerContextDirective=Lt,t.MapContextDirective=Tt,t.ContextListComponent=At,t.ContextListBindingDirective=Ut,t.ContextItemComponent=Rt,t.ContextFormComponent=qt,t.ContextEditComponent=Vt,t.ContextEditBindingDirective=Wt,t.ContextPermissionsComponent=Jt,t.ContextPermissionsBindingDirective=Yt,t.BookmarkButtonComponent=Xt,t.BookmarkDialogComponent=Ft,t.PoiButtonComponent=ie,t.PoiDialogComponent=ne,t.PoiService=ee,t.UserButtonComponent=ue,t.UserDialogComponent=se,t.ShareMapService=xe,t.ShareMapComponent=ye,t.SidenavComponent=we,t.ɵa=It,t.ɵc=wt,t.ɵb=St,t.ɵr=Wt,t.ɵq=Vt,t.ɵp=qt,t.ɵo=Rt,t.ɵn=Ut,t.ɵm=At,t.ɵt=Yt,t.ɵs=Jt,t.ɵd=et,t.ɵv=Lt,t.ɵu=Tt,t.ɵe=Xt,t.ɵj=Ft,t.ɵf=ie,t.ɵk=ne,t.ɵg=ee,t.ɵi=le,t.ɵh=ue,t.ɵl=se,t.ɵw=ye,t.ɵx=xe,t.ɵy=we,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=igo2-context.umd.min.js.map