{"version":3,"sources":["ng://@igo2/geo/lib/metadata/shared/metadata.service.ts","ng://@igo2/geo/lib/metadata/metadata-button/metadata-button.component.ts","ng://@igo2/geo/lib/metadata/metadata.module.ts","node_modules/tslib/tslib.es6.js","ng://@igo2/geo/lib/datasource/shared/datasources/data.service.ts","ng://@igo2/geo/lib/utils/id-generator.ts","ng://@igo2/geo/lib/datasource/shared/datasources/datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/feature-datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/osm-datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/xyz-datasource.ts","ng://@igo2/geo/lib/filter/shared/ogc-filter.ts","ng://@igo2/geo/lib/datasource/shared/datasources/wms-wfs.utils.ts","ng://@igo2/geo/lib/datasource/shared/datasources/wfs-datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/wfs.service.ts","ng://@igo2/geo/lib/query/shared/query.enums.ts","ng://@igo2/geo/lib/datasource/shared/datasources/wms-datasource.ts","ng://@igo2/geo/lib/datasource/utils/tilegrid.ts","ng://@igo2/geo/lib/datasource/shared/datasources/wmts-datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/carto-datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/arcgisrest-datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/tilearcgisrest-datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/websocket-datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/mvt-datasource.ts","ng://@igo2/geo/lib/datasource/shared/datasources/cluster-datasource.ts","ng://@igo2/geo/lib/feature/shared/feature.enums.ts","ng://@igo2/geo/lib/layer/shared/layer.enums.ts","ng://@igo2/geo/lib/map/shared/map.utils.ts","ng://@igo2/geo/lib/layer/shared/layers/layer.ts","ng://@igo2/geo/lib/layer/shared/layers/layer.interface.ts","ng://@igo2/geo/lib/layer/utils/image-watcher.ts","ng://@igo2/geo/lib/layer/utils/tile-watcher.ts","ng://@igo2/geo/lib/layer/utils/outputLegend.ts","ng://@igo2/geo/lib/layer/utils/vector-watcher.ts","ng://@igo2/geo/lib/layer/shared/layers/image-layer.ts","ng://@igo2/geo/lib/layer/shared/layers/tile-layer.ts","ng://@igo2/geo/lib/layer/shared/layers/vector-layer.ts","ng://@igo2/geo/lib/layer/shared/layers/vectortile-layer.ts","ng://@igo2/geo/lib/map/map-browser/map-browser.component.ts","ng://@igo2/geo/lib/overlay/shared/overlay.enum.ts","ng://@igo2/geo/lib/overlay/shared/overlay.service.ts","ng://@igo2/geo/lib/overlay/shared/overlay.directive.ts","ng://@igo2/geo/lib/overlay/shared/overlay.utils.ts","ng://@igo2/geo/lib/layer/shared/style.service.ts","ng://@igo2/geo/lib/query/shared/query.utils.ts","ng://@igo2/geo/lib/layer/layer-item/layer-item.component.ts","ng://@igo2/geo/lib/layer/layer-legend/layer-legend.component.ts","ng://@igo2/geo/lib/layer/layer-legend-item/layer-legend-item.component.ts","ng://@igo2/geo/lib/layer/layer-legend-list/layer-legend-list.component.ts","ng://@igo2/geo/lib/layer/layer-list/layer-list.enum.ts","ng://@igo2/geo/lib/layer/layer-list/layer-list.component.ts","ng://@igo2/geo/lib/map/shared/map.service.ts","ng://@igo2/geo/lib/layer/layer-list/layer-list-binding.directive.ts","ng://@igo2/geo/lib/layer/layer-list-tool/layer-list-tool.component.ts","ng://@igo2/geo/lib/layer/layer-list-tool/layer-list-tool.service.ts","ng://@igo2/geo/lib/layer/track-feature-button/track-feature-button.component.ts","ng://@igo2/geo/lib/feature/shared/strategies/loading.ts","ng://@igo2/geo/lib/feature/shared/strategies/loading-layer.ts","ng://@igo2/geo/lib/feature/shared/store.ts","ng://@igo2/geo/lib/feature/shared/strategies/selection.ts","ng://@igo2/geo/lib/feature/shared/feature.utils.ts","ng://@igo2/geo/lib/feature/feature-form/feature-form.component.ts","ng://@igo2/geo/lib/overlay/shared/overlay.ts","ng://@igo2/geo/lib/map/utils/layer-watcher.ts","ng://@igo2/geo/lib/map/shared/map.enums.ts","ng://@igo2/geo/lib/map/shared/controllers/controller.ts","ng://@igo2/geo/lib/map/shared/controllers/view.ts","ng://@igo2/geo/lib/map/shared/map.ts","ng://@igo2/geo/lib/map/shared/mapOffline.directive.ts","ng://@igo2/geo/lib/map/shared/map-pointer-position.directive.ts","ng://@igo2/geo/lib/map/shared/map-pointer-position-by-key.directive.ts","ng://@igo2/geo/lib/map/shared/projection.service.ts","ng://@igo2/geo/lib/map/zoom-button/zoom-button.component.ts","ng://@igo2/geo/lib/map/geolocate-button/geolocate-button.component.ts","ng://@igo2/geo/lib/map/offline-button/offline-button.component.ts","ng://@igo2/geo/lib/map/baselayers-switcher/baselayers-switcher.animation.ts","ng://@igo2/geo/lib/map/baselayers-switcher/baselayers-switcher.component.ts","ng://@igo2/geo/lib/map/baselayers-switcher/mini-basemap.component.ts","ng://@igo2/geo/lib/map/rotation-button/rotation-button.component.ts","ng://@igo2/geo/lib/datasource/utils/esri-style-generator.ts","ng://@igo2/geo/lib/filter/shared/time-filter.enum.ts","ng://@igo2/geo/lib/datasource/shared/capabilities.service.ts","ng://@igo2/geo/lib/datasource/shared/options/options.service.ts","ng://@igo2/geo/lib/datasource/shared/datasource.service.ts","ng://@igo2/geo/lib/datasource/shared/options/options-api.service.ts","ng://@igo2/geo/lib/layer/shared/layer.service.ts","ng://@igo2/geo/lib/catalog/shared/catalog.enum.ts","ng://@igo2/geo/lib/catalog/shared/catalog.abstract.ts","ng://@igo2/geo/lib/query/shared/query.service.ts","ng://@igo2/geo/lib/query/shared/query.directive.ts","ng://@igo2/geo/lib/search/shared/sources/source.ts","ng://@igo2/geo/lib/query/shared/query-search-source.ts","ng://@igo2/geo/lib/utils/googleLinks.ts","ng://@igo2/geo/lib/utils/osmLinks.ts","ng://@igo2/geo/lib/catalog/shared/catalog.service.ts","ng://@igo2/geo/lib/catalog/catalog-browser/catalog-browser.component.ts","ng://@igo2/geo/lib/catalog/catalog-browser/catalog-browser-layer.component.ts","ng://@igo2/geo/lib/catalog/catalog-browser/catalog-browser-group.component.ts","ng://@igo2/geo/lib/layer/layer-legend-list/layer-legend-list-binding.directive.ts","ng://@igo2/geo/lib/layer/layer.module.ts","ng://@igo2/geo/lib/catalog/catalog-browser/catalog-browser.module.ts","ng://@igo2/geo/lib/catalog/catalog-library/catalog-library.component.ts","ng://@igo2/geo/lib/catalog/catalog-library/catalog-library-item.component.ts","ng://@igo2/geo/lib/catalog/catalog-library/catalog-library.module.ts","ng://@igo2/geo/lib/catalog/catalog.module.ts","ng://@igo2/geo/lib/datasource/datasource.module.ts","ng://@igo2/geo/lib/filter/shared/filterable-datasource.pipe.ts","ng://@igo2/geo/lib/filter/shared/time-filter.service.ts","ng://@igo2/geo/lib/filter/shared/ogc-filter.service.ts","ng://@igo2/geo/lib/filter/shared/spatial-filter.enum.ts","ng://@igo2/geo/lib/filter/shared/spatial-filter.service.ts","ng://@igo2/geo/lib/download/shared/download.service.ts","ng://@igo2/geo/lib/download/download-button/download-button.component.ts","ng://@igo2/geo/lib/download/download.module.ts","ng://@igo2/geo/lib/feature/feature-details/feature-details.component.ts","ng://@igo2/geo/lib/feature/feature-details/feature-details.module.ts","ng://@igo2/geo/lib/feature/feature-form/feature-form.module.ts","ng://@igo2/geo/lib/feature/feature.module.ts","ng://@igo2/geo/lib/geometry/geometry-form-field/geometry-form-field.component.ts","ng://@igo2/geo/lib/measure/shared/measure.enum.ts","ng://@igo2/geo/lib/measure/shared/measure.utils.ts","ng://@igo2/geo/lib/geometry/shared/geometry.errors.ts","ng://@igo2/geo/lib/geometry/shared/geometry.utils.ts","ng://@igo2/geo/lib/geometry/shared/controls/draw.ts","ng://@igo2/geo/lib/geometry/shared/controls/modify.ts","ng://@igo2/geo/lib/geometry/shared/controls/slice.ts","ng://@igo2/geo/lib/measure/measurer/measurer-dialog.component.ts","ng://@igo2/geo/lib/measure/measurer/measurer.component.ts","ng://@igo2/geo/lib/measure/measurer/measure-format.pipe.ts","ng://@igo2/geo/lib/geometry/geometry-form-field/geometry-form-field-input.component.ts","ng://@igo2/geo/lib/geometry/geometry-form-field/geometry-form-field.module.ts","ng://@igo2/geo/lib/geometry/geometry.module.ts","ng://@igo2/geo/lib/filter/time-filter-button/time-filter-button.component.ts","ng://@igo2/geo/lib/filter/time-filter-form/time-filter-form.component.ts","ng://@igo2/geo/lib/filter/time-filter-item/time-filter-item.component.ts","ng://@igo2/geo/lib/filter/time-filter-list/time-filter-list.component.ts","ng://@igo2/geo/lib/filter/time-filter-list/time-filter-list-binding.directive.ts","ng://@igo2/geo/lib/wkt/shared/wkt.service.ts","ng://@igo2/geo/lib/filter/ogc-filter-form/ogc-filter-form.component.ts","ng://@igo2/geo/lib/filter/ogc-filterable-form/ogc-filterable-form.component.ts","ng://@igo2/geo/lib/filter/ogc-filterable-item/ogc-filterable-item.component.ts","ng://@igo2/geo/lib/filter/ogc-filterable-list/ogc-filterable-list.component.ts","ng://@igo2/geo/lib/filter/ogc-filterable-list/ogc-filterable-list-binding.directive.ts","ng://@igo2/geo/lib/filter/ogc-filter-button/ogc-filter-button.component.ts","ng://@igo2/geo/lib/filter/ogc-filter-toggle-button/ogc-filter-toggle-button.component.ts","ng://@igo2/geo/lib/filter/spatial-filter/spatial-filter-type/spatial-filter-type.component.ts","ng://@igo2/geo/lib/filter/spatial-filter/spatial-filter-list/spatial-filter-list.component.ts","ng://@igo2/geo/lib/filter/spatial-filter/spatial-filter-item/spatial-filter-item.component.ts","ng://@igo2/geo/lib/filter/filter.module.ts","ng://@igo2/geo/lib/import-export/export-button/export-button.component.ts","ng://@igo2/geo/lib/import-export/shared/export.errors.ts","ng://@igo2/geo/lib/import-export/shared/export.utils.ts","ng://@igo2/geo/lib/import-export/shared/export.type.ts","ng://@igo2/geo/lib/import-export/shared/export.service.ts","ng://@igo2/geo/lib/import-export/shared/import.errors.ts","ng://@igo2/geo/lib/import-export/shared/import.utils.ts","ng://@igo2/geo/lib/import-export/shared/import.service.ts","ng://@igo2/geo/lib/import-export/style-list/style-list.service.ts","ng://@igo2/geo/lib/import-export/import-export/import-export.component.ts","ng://@igo2/geo/lib/import-export/shared/drop-geo-file.directive.ts","ng://@igo2/geo/lib/import-export/style-list/style-list.provider.ts","ng://@igo2/geo/lib/import-export/style-list/style-list.module.ts","ng://@igo2/geo/lib/import-export/import-export.module.ts","ng://@igo2/geo/lib/map/map.module.ts","ng://@igo2/geo/lib/measure/measurer/measurer-item.component.ts","ng://@igo2/geo/lib/measure/measurer/measurer.module.ts","ng://@igo2/geo/lib/measure/measure.module.ts","ng://@igo2/geo/lib/overlay/overlay.module.ts","ng://@igo2/geo/lib/print/shared/print.service.ts","ng://@igo2/geo/lib/print/print/print.component.ts","ng://@igo2/geo/lib/print/shared/print.type.ts","ng://@igo2/geo/lib/print/print-form/print-form.component.ts","ng://@igo2/geo/lib/print/print.module.ts","ng://@igo2/geo/lib/query/shared/query-search-source.providers.ts","ng://@igo2/geo/lib/query/query.module.ts","ng://@igo2/geo/lib/search/shared/search-source.service.ts","ng://@igo2/geo/lib/search/shared/search.utils.ts","ng://@igo2/geo/lib/search/shared/search.service.ts","ng://@igo2/geo/lib/directions/directions-sources/directions-source.ts","ng://@igo2/geo/lib/directions/shared/directions-source.service.ts","ng://@igo2/geo/lib/directions/shared/directions.service.ts","ng://@igo2/geo/lib/directions/directions-form/directions-form.service.ts","ng://@igo2/geo/lib/directions/directions-form/directions-form.component.ts","ng://@igo2/geo/lib/directions/directions-form/directions-form-binding.directive.ts","ng://@igo2/geo/lib/directions/directions.module.ts","ng://@igo2/geo/lib/search/shared/search-source-service.providers.ts","ng://@igo2/geo/lib/search/shared/sources/icherche.ts","ng://@igo2/geo/lib/search/shared/sources/icherche.providers.ts","ng://@igo2/geo/lib/search/shared/sources/coordinates.ts","ng://@igo2/geo/lib/search/shared/sources/coordinates.providers.ts","ng://@igo2/geo/lib/search/shared/sources/ilayer.ts","ng://@igo2/geo/lib/search/shared/sources/ilayer.providers.ts","ng://@igo2/geo/lib/search/shared/search.enums.ts","ng://@igo2/geo/lib/search/search-selector/search-selector.component.ts","ng://@igo2/geo/lib/search/search-selector/search-selector.module.ts","ng://@igo2/geo/lib/search/search-settings/search-settings.component.ts","ng://@igo2/geo/lib/search/search-settings/search-settings.module.ts","ng://@igo2/geo/lib/search/search-bar/search-bar.component.ts","ng://@igo2/geo/lib/search/search-bar/search-url-param.directive.ts","ng://@igo2/geo/lib/search/search-bar/search-bar.module.ts","ng://@igo2/geo/lib/search/search-results/search-results.component.ts","ng://@igo2/geo/lib/search/search-results/search-results-item.component.ts","ng://@igo2/geo/lib/search/search-results/search-results-add-button.component.ts","ng://@igo2/geo/lib/search/search-results/search-results.module.ts","ng://@igo2/geo/lib/search/shared/search-pointer-summary.directive.ts","ng://@igo2/geo/lib/search/search.module.ts","ng://@igo2/geo/lib/toast/toast.component.ts","ng://@igo2/geo/lib/toast/toast.module.ts","ng://@igo2/geo/lib/workspace/widgets/ogc-filter/ogc-filter.component.ts","ng://@igo2/geo/lib/workspace/widgets/widgets.ts","ng://@igo2/geo/lib/workspace/widgets/ogc-filter/ogc-filter.module.ts","ng://@igo2/geo/lib/workspace/shared/wfs-workspace.ts","ng://@igo2/geo/lib/workspace/shared/wfs-workspace.service.ts","ng://@igo2/geo/lib/workspace/shared/wms-workspace.ts","ng://@igo2/geo/lib/workspace/shared/wms-workspace.service.ts","ng://@igo2/geo/lib/workspace/workspace-selector/workspace-selector.directive.ts","ng://@igo2/geo/lib/workspace/workspace-selector/workspace-selector.module.ts","ng://@igo2/geo/lib/workspace/workspace.module.ts","ng://@igo2/geo/lib/wkt/wkt.module.ts","ng://@igo2/geo/lib/geo.module.ts","ng://@igo2/geo/lib/datasource/shared/options/options-api.providers.ts","ng://@igo2/geo/lib/search/shared/sources/cadastre.ts","ng://@igo2/geo/lib/search/shared/sources/cadastre.providers.ts","ng://@igo2/geo/lib/search/shared/sources/nominatim.ts","ng://@igo2/geo/lib/search/shared/sources/nominatim.providers.ts","ng://@igo2/geo/lib/search/shared/sources/storedqueries.ts","ng://@igo2/geo/lib/search/shared/sources/storedqueries.providers.ts","ng://@igo2/geo/lib/directions/shared/directions.enum.ts","ng://@igo2/geo/lib/directions/directions-sources/osrm-directions-source.ts","ng://@igo2/geo/lib/directions/directions-sources/directions-source.provider.ts","ng://@igo2/geo/lib/import-export/shared/export-ionic.service.ts","ng://@igo2/geo/lib/print/shared/print-ionic.service.ts","ng://@igo2/geo/lib/filter/shared/ogc-filter.enum.ts","ng://@igo2/geo/lib/layer/layer-list-tool/layer-list-tool.enum.ts"],"names":["MetadataService","prototype","open","metadata","extern","window","url","Injectable","args","providedIn","MetadataButtonComponent","Object","defineProperty","this","_layer","value","_color","openMetadata","metadataService","layer","options","Component","selector","template","changeDetection","ChangeDetectionStrategy","OnPush","Input","IgoMetadataModule","forRoot","ngModule","providers","NgModule","imports","CommonModule","MatIconModule","MatButtonModule","MatTooltipModule","IgoLanguageModule","exports","declarations","extendStatics","d","b","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__extends","__","constructor","create","__assign","assign","t","s","i","n","arguments","length","call","apply","__decorate","decorators","target","key","desc","c","r","getOwnPropertyDescriptor","Reflect","decorate","__metadata","metadataKey","metadataValue","__values","o","m","Symbol","iterator","next","done","__read","e","ar","push","error","__spread","concat","DataService","generateIdFromSourceOptions","wms","generateWMSIdFromSourceOptions","wmts","generateWMTSIdFromSourceOptions","xyz","generateXYZIdFromSourceOptions","feature","generateFeatureIdFromSourceOptions","osm","_options","type","generateId","layers","params","LAYERS","chain","charAt","location","origin","Md5","hashStr","uuid","DataSource","getLegend","style","scale","legend","setLegend","html","dataService","id","ol","createOlSource","tslib_1.__extends","FeatureDataSource","sourceOptions","format","getSourceFormatFromOptions","olSourceVector","olFormatCls","formatType","olformat","undefined","Error","olformat.GeoJSON","formatOptions","onUnwatch","queryTitle","OSMDataSource","olSourceOSM","XYZDataSource","olSourceXYZ","OgcFilterWriter","defineOgcFiltersDefaultOptions","ogcFiltersOptions","fieldNameGeometry","srcType","ogcFiltersDefaultValue","enabled","editable","geometryName","advancedOgcFilters","pushButtons","buildFilter","filters","extent","proj","ourBboxFilter","enableBbox","test","JSON","stringify","olfilter.bbox","getCode","join","checkIgoFiltersProperties","wfsOptions","srsName","featureNS","featurePrefix","featureTypes","filter","olfilter.and","bundleFilter","outputFormat","query","olFormatWFS","writeGetFeature","XMLSerializer","serializeToString","split","filterObject","_this","logicalArray_1","forEach","element","createFilter","operator","logical","logicalArray","filterOptions","geometry","wfsPropertyName","propertyName","wfsPattern","pattern","wfsMatchCase","matchCase","wfsWildCard","wildCard","wfsSingleChar","singleChar","wfsEscapeChar","escapeChar","wfsLowerBoundary","lowerBoundary","wfsUpperBoundary","upperBoundary","wfsGeometryName","wfsExtent","wfsWktGeometry","wkt_geometry","wfsSrsName","wfsBegin","begin","wfsEnd","end","wfsExpression","expression","olFormatWKT","readGeometry","dataProjection","featureProjection","olfilter.between","olfilter.contains","olfilter.during","olfilter.equalTo","olfilter.greaterThan","olfilter.greaterThanOrEqualTo","olfilter.intersects","olfilter.isNull","olfilter.lessThan","olfilter.lessThanOrEqualTo","olfilter.like","replace","olfilter.notEqualTo","olfilter.within","olfilter.or","olfilter.not","defineInterfaceFilterSequence","level","filterSequence","addInterfaceFilter","computeAllowedOperators","fields","defaultOperatorsType","allowedOperators","effectiveOperators","srcField","find","field","name","allowedOperatorsType","toLowerCase","operators","Intersects","spatial","fieldRestrict","Within","PropertyIsEqualTo","PropertyIsNotEqualTo","During","PropertyIsGreaterThan","PropertyIsGreaterThanOrEqualTo","PropertyIsLessThan","PropertyIsLessThanOrEqualTo","igoOgcFilterObject","parentLogical","f","active","filterid","igoSpatialSelector","filterArray","addFilterProperties","status","rebuiltIgoOgcFilterObjectFromSequence","sequence","nextElement_1","lastProcessedFilter_1","lastParentLogical_1","logicalArray_2","uiFilter","index","indexOf","console","log","computeIgoPushButton","groups","every","group","computedButtons","pb","bundles","bundle","ObjectUtils","copyDeep","title","ids","includes","pbGroup","handleOgcFiltersAppliedValue","ogcFilters","filterQueryStringPushButton","filterQueryStringAdvancedFilters","pushButtonBundle","g","conditions_1","map","buttonBundle","bundleCondition","buttons","ogcpb","enabledPb","igoFilters","filterQueryString","formatProcessedOgcFilter","processedFilter","layersOrTypenames","appliedFilter","layerOrTypenames","PropertyIsLike","PropertyIsBetween","PropertyIsNull","Contains","defaultEpsg","defaultMaxFeatures","defaultWfsVersion","defaultFieldNameGeometry","gmlRegex","RegExp","jsonRegex","formatWFSQueryString","dataSourceOptions","count","epsg","properties","versionWfs200","urlWfs","paramsWFS","effectiveCount","epsgCode","version","paramMaxFeatures","cnt","maxFeatures","srs","valueReference","sourceFields","fieldsNames_1","sourcefield","getFeature","getpropertyvalue","checkWfsParams","wfsDataSourceOptions","getFormatFromOptions","OlFormat.WFS","OlFormat","match","gmlFormat","olFormatGML2","olFormatGML32","olFormatGML3","OlFormat.TopoJSON","OlFormat.GeoJSON","OlFormat.EsriJSON","OlFormat.GPX","OlFormat.WKT","olFormatOSMXML","OlFormat.KML","WFSDataSource","overlaps","resolution","buildUrl","strategy","OlLoadingStrategy.bbox","queryStringValues","ogcFilterWriter","filterOrBox","filterOrPush","prefix","xmlFilter","baseUrl","download","dynamicUrl","wfsService","_super","getSourceFieldsFromWFS","WFSService","getData","defineFieldAndValuefromWFS","subscribe","getfeatureSourceField","alias","values","sf","wfsGetFeature","nb","http","get","responseType","Observable","fieldList","fieldListWoGeom","fieldListWoGeomStr","olFormats","oneFeature","features","readFeatures","getKeys","getGeometryName","manyFeatures","mfeatures","built_properties_value","complete","kv","getProperties","boundedBy","property","fieldType","featureProperties","v","HttpClient","GML2","GML3","GEOJSON","GEOJSON2","ESRIJSON","TEXT","HTML","HTMLGML2","IFRAME","BLANK","WMSDataSource","mapLabel","queryHtmlTarget","QueryHtmlTarget","refresh","updateParams","igoRefresh","Math","random","buildDynamicDownloadUrlFromParamsWFS","asWFSDataSourceOptions","olSourceImageWMS","sourceParams","VERSION","separator","currentStyle","dpi","DPI","MAP_RESOLUTION","FORMAT_OPTIONS","refreshIntervalSec","setInterval","wfsCheckup","mergeDeep","sourceField","initOgcFilters","FILTER","createDefaultTileGrid","projectionExtent","olproj.get","getExtent","size","extentGetWidth","resolutions","matrixIds","z","pow","olTileGridWMTS","extentGetTopLeft","WMTSDataSource","tileGrid","olSourceWMTS","CartoDataSource","crossOrigin","olSourceCarto","htmlString","config","items","visible","layerOptions","types_1","tslib_1.__values","types_1_1","oneType","cartocss","pop","color","substr","colors","data","j","layer_name","ArcGISRestDataSource","esrijsonFormat","olFormatEsriJSON","attributions","encodeURIComponent","timeFilter","time","timeExtent","customParams","bind","olloadingstrategy.bbox","legendInfo","parseInt","lyr","layerName","_b","_c","lyrLegend","layerId","label","TileArcGISRestDataSource","olSourceTileArcGISRest","WebSocketDataSource","createWebSocket","ws","WebSocket","onmessage","onMessage","onclose","onClose","onerror","onError","onopen","onOpen","event","featureAdded","readFeature","featureToRemove","getFeatureById","getId","removeFeature","addFeature","clear","close","MVTDataSource","mvtFormat","featureClass","olFormatMVT","olSourceVectorTile","ClusterDataSource","source","olSourceCluster","FEATURE","None","Move","Zoom","Default","LAYER","stringToLonLat","str","mapProjection","opts","lonLat","coordStr","negativeLon","degreesLon","minutesLon","secondsLon","directionLon","decimalLon","negativeLat","degreesLat","minutesLat","secondsLat","directionLat","decimalLat","zone","radius","conf","lon","lat","projectionStr","projectionRegex","lonlatCoord","lonLatPattern","lonLatRegex","dmsCoord","dmsCoordPattern","dmsRegex","patternUtm","utmRegex","patternMtm","mtmRegex","ddCoord","patternDd","ddRegex","dmdCoord","patternDmd","dmdRegex","patternBELL","bellRegex","mmCoord","mmPattern","mmRegex","isXYCoords","toLocaleUpperCase","trim","_a","parseFloat","convertDMSToDD","_d","epsgUtm","Number","_e","olproj","transform","_f","epsgMtm","_g","_h","_j","_k","message","_l","forceNA","olproj.transform","degrees","minutes","seconds","direction","dd","viewStatesAreEqual","state1","state2","zoom","trunc","center","formatScale","round","getResolutionFromScale","getScaleFromResolution","unit","olproj.METERS_PER_UNIT","ctrlKeyDown","originalEvent","altKey","MAC","metaKey","ctrlKey","shiftKey","roundCoordTo","coord","decimal","toFixed","lonLatConversion","projections","rawCoord3857","convertedLonLat","code","igo2CoordFormat","utmZone","utmZoneFromLonLat","utmName","rawCoordUtm","mtmZone","mtmZoneFromLonLat","mtmName","rawCoordMtm","projection","rawCoord","numericEpsgCode","ceil","long","Layer","dataSource","getZIndex","zIndex","setZIndex","baseLayer","opacity","setOpacity","isInResolutionsRange$","getMaxResolution","setMaxResolution","Infinity","updateInResolutionsRange","getMinResolution","setMinResolution","visible$","setVisible","isInResolutionsRange","showInLayerList","setMap","igoMap","unobserveResolution","observeResolution","resolution$$","viewController","resolution$","unsubscribe","getResolution","minResolution","maxResolution","authInterceptor","legendCollapsed","firstLoadComponent","BehaviorSubject","displayed$","combineLatest","pipe","bunch","createOlLayer","maxScaleDenom","minScaleDenom","legendOptions","collapsed","set","TITLE","ABSTRACT","CUSTOM","Watcher","ImageWatcher","watch","on","handleLoadStart","handleLoadEnd","unwatch","un","image","__watchers__","loading","SubjectStatus","Working","watcherIndex","splice","loaded","Done","TileWatcher","tile","getLayersLegends","legends","newContext","document","createElement","getContext","font","heightPos","layers_1","layers_1_1","legendUrls","legendUrl","legendImage","Image","src","onload","fillText","drawImage","height","legendUrls_1","legendUrls_1_1","VectorWatcher","ImageLayer","olOptions","olLayerImage","getSource","setImageLoadFunction","customLoader","watcher","xhr","XMLHttpRequest","interceptXhr","abort","getImage","arrayBufferView","Uint8Array","response","blob","Blob","imageUrl","URL","createObjectURL","send","status$","TileLayer","olLayerTile","VectorLayer","browsable","exportable","animation","flash","trackFeature","enableTrackFeature","olLayerVector","start","Date","getTime","listenerKey","animate","vectorContext","frameState","flashGeom","getGeometry","clone","elapsed","elapsedRatio","duration","easeOut","newColor","ColorAsArray","getStyleFunction","style2","styleClone","getType","getRadius","setRadius","getStroke","setColor","setWidth","getWidth","getFill","setText","setStyle","drawGeometry","unByKey","render","stopAnimation","trackFeatureListenerId","centerMapOnFeature","feat","getView","setCenter","getCoordinates","disableTrackFeature","VectorTileLayer","olLayerVectorTile","MapBrowserComponent","_view","updateView","ngOnInit","status$$","handleStatusChange","ngAfterViewInit","setTarget","ngOnDestroy","activityService","unregister","activityId","register","ActivityService","ZoomIfOutMapExtent","OverlayService","setFeatures","action","OverlayAction","features$","OverlayDirective","component","features$$","overlayService","res","handleFeatures","Directive","Self","olFormatGeoJSON","createOverlayLayer","overlayDataSource","createOverlayLayerStyle","defaultStyle","createOverlayDefaultStyle","markerStyle","createOverlayMarkerStyle","olFeature","createBufferStyle","strokeRGBA","strokeWidth","fillRGBA","bufferRadius","stroke","olstyle.Stroke","width","fill","olstyle.Style","olstyle.Circle","text","olstyle.Text","olstyle.Fill","overflow","customStyle","StyleService","createStyle","geometryType","getText","fillOpacity","strokeOpacity","strokeColor","fillWithOpacity","slice","strokeWithOpacity","iconColor","svgIconColor","svgOutlineColor","svg","outlineColor","isIE","navigator","userAgent","olstyle.Icon","imgSize","anchor","parseStyle","styleOptions","olCls","getOlCls","keys","_key","olKey","getOlKey","olstyle","toUpperCase","olstyle.RegularShape","createStyleByAttribute","styleByAttribute","attribute","icon","labelStyle","getLabel","baseStyle","val","toString","getStyle","OlFeature","createClusterStyle","clusterParam","layerStyle","clusterRanges","minRadius","maxRadius","showRange","dynamicRadius","clusterRadius","radiusMin","image_","radiusCalc","labelMatch","labelToGet","from","matchAll","layerIsQueryable","queryable","olLayerIsQueryable","olLayer","LayerItemComponent","_activeLayer","selectionMode","layerTool$","renderer","addClass","elRef","nativeElement","focusedCls","removeClass","_selectAll","layerCheck","layers$","removable","expandLegendIfVisible","toggleLegend","updateQueryBadge","onResolutionChange","tooltipText","computeTooltip","networkService","currentState","state","showLegend$","toggleLegendOnClick","toggleVisibility","toggleLegendOnVisibilityChange","tooltip","layerTooltip","layerMetadata","TooltipType","abstract","inResolutionRange","updateLegendOnResolutionChange","inResolutionRange$","hidden","queryBadge","queryBadgeHidden$","toggleLayerTool","getValue","emit","check","checkbox","NetworkService","Renderer2","ElementRef","Output","orderable","lowerDisabled","raiseDisabled","EventEmitter","LayerLegendComponent","lastlLegend","styles","listStyles","STYLES","legendItems$","toggleLegendItem","item","transfertToggleLegendItem","newLegends","outLegends","lastLegends","computeItemTitle","layerLegend","of","localLayerOptions","parse","capabilitiesService","getWMSOptions","wmsDataSourceOptions","_layerOptionsFromSource","getScale","updateLegend","legendItems","stylesAvailable","languageService","translate","instant","sA","normalize","onChangeStyle","getParams","onLoadImage","elemRef","renderedLegends","first","renderedLegend","imagesHeight","CapabilitiesService","LanguageService","ViewChildren","LayerLegendItemComponent","LayerLegendListComponent","_layers","change$$","change$","debounce","EMPTY","timer","computeShownLayers","hasVisibleOrInRangeLayers$","hasVisibleAndNotInRangeLayers$","layersInUi$","excludeBaseLayers","shownLayers","showAllLegendsValue","sortLayersByZindex","sort","layer1","layer2","toggleShowAllLegends","toggle","allLegendsShown","showAllLegend","ReplaySubject","allowShowAllLegends","always","never","default","LayerListComponent","_map","activeLayer$","_keyword","_onlyVisible","_sortedAlpha","activeLayer","getUpperLayer","isUpperBaselayer","getLowerLayer","isLowerBaselayer","layersChecked","raisableLayers","selectAllCheck","lowerableLayers","layersCheckedOpacity","showToolbar$","computeShowToolbar","computeLayers","appliedFilterAndSort","keyword","sortAlpha","onlyVisible","selectAllCheck$$","selectAllCheck$","checks","layerTool","lay","clearKeyword","l","reduce","prev","current","findIndex","base","mapIndex","this_1","currentLayer","previousLayer","raisableLayer","raiseLayers","layersToRaise","this_2","layers_2","layers_2_1","setTimeout","elements","computeElementRef","isScrolledIntoView","offsetParent","scrollTop","offsetTop","this_3","nextLayer","layers_3","layers_3_1","lowerableLayer","lowerLayers","layersToLower","this_4","layers_4","layers_4_1","offsetHeight","clientHeight","layersOut","filterLayers","sortLayersByTitle","onKeywordChange","term","onAppliedFilterAndSortChange","layerFilterAndSortOptions","showToolbar","LayerListControlsEnum","keepLayerIds","layerKeywords","keywordList","kw","localKeyword","layerTitle","dataSourceType","keywordRegex_1","keywordInList","a","thresholdToFilterAndSort","toggleOpacity","removeLayers","layers_5","layers_5_1","removeLayer","layersCheck","eventMapIndex","this_5","toggleSelectionMode","selection","selectAll","elemSource","elem","docViewTop","docViewBottom","elemTop","checkItems","getElementsByClassName","checkItem","getElementsByTagName","ContentChild","layersAreAllVisible","ogcButton","timeButton","floatLabel","expandLegendOfVisibleLayers","MapService","getMap","LayerListBindingDirective","layersOrResolutionChange$$","mapService","debounceTime","setLayersVisibilityStatus","layersVisibility$$","visibles","Boolean","allLayersAreVisible","RouteService","Optional","route","LayerListToolComponent","onlyVisible$","sortAlpha$","term$","term$$","onlyVisible$$","sortAlpha$$","clearTerm","toggleSortAlpha","toggleOnlyVisible","LayerListToolService","onlyInRange","keywordInitialized","sortedAlphaInitialized","onlyVisibleInitialized","onlyInRangeInitialized","TrackFeatureButtonComponent","toggleTrackFeature","EntityStoreStrategy","FeatureStoreLoadingStrategy","bindStore","store","watchStore","unbindStore","unwatchStore","setMotion","motion","doActivate","stores","doDeactivate","unwatchAll","stores$$","has","subscription","view","all$","onFeaturesChange","delete","entries","clearLayer","setLayerFeatures","selectMotion","viewScale","areaRatio","getFeatureId","pristine","FeatureMotion","Map","FeatureStoreLoadingLayerStrategy","onSourceChanges","olFeatures","getFeatures","setStoreOlFeatures","EntityStore","FeatureStore","bindLayer","getEntityId","checkLayer","featureToOl","setLayerOlFeatures","featureFromOl","load","diff","computeOlFeaturesDiff","remove","removeOlFeaturesFromLayer","add","addOlFeaturesToLayer","moveToOlFeatures","addFeatures","entities","OlDragSelectInteraction","OlDragBoxInteraction","FeatureStoreSelectionStrategy","_overlayStore","activate","unselectAll","updateAll","selected","overlayStore","deactivateSelection","unlistenToMapClick","removeDragBoxInteraction","addOverlayLayer","listenToMapClick","dragBox","addDragBoxInteraction","watchAll","removeOverlayLayer","stores$","stateView","manyBy$","record","records","entity","skip","onSelectFromStore","mapClickListener","onMapClick","listener","exclusive","reverse","getFeaturesAtPixel","pixel","hitTolerance","layerFilter","onSelectFromMap","olDragSelectInteraction","olInteractions","getInteractions","getArray","olInteractions_1","olInteractions_1_1","olInteraction","condition","addInteraction","olDragSelectInteractionEndKey","onDragBoxEnd","removeInteraction","mapBrowserEvent","acc","olSource","getFeaturesInExtent","doMotion","overlayFeaturesKeys","featuresKeys","getKey","groupedFeatures","groupFeaturesByStore","unselectAllFeaturesFromStore","selectFeaturesFromStore","reverseMany","updateMany","createOverlayStore","overlayLayer","addLayer","projectionOut","OlFormatGeoJSON","setId","getEntityTitle","mapTitle","getEntityProperty","getEntityRevision","getEntityIcon","meta","sourceId","renderFeatureFromOl","olRenderFeature","projectionIn","geom","exclude","excludeOffline","excludeAttribute","excludeAttributeOffline","olFormat","ends","ends_","OlPolygon","flatCoordinates_","OlGeometryLayout","XY","OlPoint","OlLineString","writeGeometryObject","startsWith","revision","getRevision","computeOlFeatureExtent","olExtent","olextent.createEmpty","olFeatureExtent","olFeatureProjection","olproj.transformExtent","olGeometry","computeOlFeaturesExtent","featureExtent","olextent.extend","scaleExtent","olextent","getSize","featuresAreOutOfView","featuresExtent","mapExtent","viewExtent","x","olextent.containsExtent","featuresAreTooDeepInView","mapExtentArea","olextent.getArea","featuresExtentArea","getZoom","zoomToExtent","moveToExtent","tryBindStoreLayer","tryAddLoadingStrategy","getStrategyOfType","addStrategy","activateStrategyOfType","tryAddSelectionStrategy","olFeaturesMap","olFeaturesToRemove","newOlFeature","olFeaturesToAddIds","FeatureFormComponent","feature$","onSubmit","formDataToFeature","submitForm","igoForm","propertyPrefix","entry","ViewChild","Overlay","removeOlFeature","addOlFeatures","addOlFeature","removeFeatures","LayerWatcher","unwatchLayer","watchLayer","layer$$","distinctUntilChanged","subscriptions","status_1","Waiting","MapController","getOlMap","olMap","setOlMap","teardownObservers","observerKeys","MapViewController","stateHistory","setupObservers","onMoveEnd","extent$$","extent$","setExtent","getOlProjection","olView","getProjection","getCenter","calculateExtent","getUnits","zoomIn","zoomTo","zoomOut","cancelAnimations","easing","oleasing.easeOut","MapViewAction","getRotation","resetRotation","rotation","hasPreviousState","states","stateIndex","hasNextState","previousState","setStateIndex","nextState","clearStateHistory","setInitialState","fromCenter","toCenter","distCenter","sqrt","fromExtent","fromSize","xSize","maxZoom","maxZoomOnExtent","fit","padding","setState","state$","Subject","IgoMap","init","controls","attribution","attributionOpt","olControlAttribution","scaleLine","scaleLineOpt","olControlScaleLine","interactions","altShiftDragRotate","doubleClickZoom","keyboard","mouseWheelZoom","shiftDragZoom","dragPan","pinchRotate","pinchZoom","olinteraction.defaults","setView","overlay","buffer","layerWatcher","currentView","viewOptions","unsubscribeGeolocate","olproj.fromLonLat","geolocate","alwaysTracking","changeBaseLayer","getBaseLayers","setMinZoom","minZoom","setMaxZoom","getLayerById","getLayerByAlias","addLayers","offsetZIndex","offsetBaseLayerZIndex","addedLayers","offset","doAddLayer","setLayers","newLayers","layersToRemove","doRemoveLayer","removeAllLayers","raiseLayer","getLayerIndex","moveLayer","lowerLayer","reverseLayers","reverseLayers_1","reverseLayers_1_1","to","layerTo","zIndexTo","zIndexFrom","existingLayer","maxZIndex","max","sortLayersByZIndex","track","geolocation$$","geolocation","getTracking","startGeolocation","geolocation$","getAccuracy","getAccuracyGeometry","geolocationFeature","bufferFeature","positionFollower","options_","coordinates","getPosition","bufferGeom","olCircle","bufferStroke","bufferFill","bufferText","showBufferRadius","setZoom","stopGeolocation","setTracking","olGeolocation","trackingOptions","enableHighAccuracy","tracking","evt","onOfflineToggle","offline","offlineButtonToggle$","defaultOptions","olproj4.register","proj4","MapOfflineDirective","offlineButtonToggle","offlineButtonStatus","networkState","connection","messageService","info","offlineButtonState","changeLayer","message_1","title_1","messageObs","titleObs","message1","title1","pathOffline","setUrl","MessageService","PointerPositionDirective","listenToMapPointerMove","unlistenToMapPointerMove","pointerMoveListener","onPointerEvent","pointerPositionDelay","delay","dragging","mediaService","isTouchScreen","lastTimeoutRequest","clearTimeout","lonlat","coordinate","pointerPositionCoord","MediaService","PointerPositionByKeyDirective","subscribeToKeyDown","subscribeToKeyUp","unsubscribeToKeyDown","unsubscribeToKeyUp","pointerPositionByKeyDelay","keyDown$$","fromEvent","keyCode","pointerPositionByKeyCode","definedKeyIsDown$","keyUp$$","lonlat_1","pointerPositionByKeyCoord","ProjectionService","registerProjection","defs","def","ConfigService","getConfig","ZoomButtonComponent","getMinZoom","getMaxZoom","GeolocateButtonComponent","OfflineButtonComponent","onToggle","btnStyle","colorOff","change","baseLayersSwitcherSlideInOut","trigger","transition","BaseLayersSwitcherComponent","_useStaticIcon","layers$$","arrayLayers","_baseLayers","collapseOrExpand","baseLayers","useStaticIcon","expand","mapResolution","mapZoom","bl","blHidden","animations","showButton","media$","Media","Mobile","MiniBaseMapComponent","handleMoveEnd","_baseLayer","handleBaseLayerChanged","_disabled","_display","disabled","appRef","tick","basemap","baselayer","layerService","createLayer","LayerService","ApplicationRef","RotationButtonComponent","_showIfNoRotation","rotationStyle","radians","EsriStyleGenerator","_convertPointToPixel","point","_transformColor","_getResolutionForScale","units","mpu","_convertEsriTS","symbol","_transformAngle","angle","weight","family","textBaseline","verticalAlignment","textAlign","horizontalAlignment","offsetX","xoffset","offsetY","yoffset","_convertEsriPMS","contentType","imageData","_convertEsriSFS","outline","_convertOutline","lineDash","color$$1","_convertEsriSLS","ol3Rad","PI","_convertEsriSMS","points","radius2","_convertLabelingInfo","labelingInfo","mapUnits","ii","labelExpression","maxScale","minScale","_converters","_renderSimple","_renderClassBreaks","defaultSymbol","classes","classBreakInfos","classBreakInfo","min","classMinValue","minValue","classMaxValue","_renderUniqueValue","field1","infos","uniqueValueInfos","me","hash","generateStyle","layerInfo","drawingInfo","styleFunctions","drawingInfoStyle","_renderers","labelingInfoStyleFunctions","result","esriPMS","esriSFS","esriSLS","esriSMS","esriTS","uniqueValue","simple","classBreaks","DATE","TIME","DATETIME","YEAR","CALENDAR","SLIDER","baseOptions","getCapabilities","capabilities","parseWMSOptions","getWMTSOptions","parseWMTSOptions","getCartoOptions","account","mapId","jsonp","cartoOptions","parseCartoOptions","getArcgisOptions","arcgisOptions","catchError","err","forkJoin","parseArcgisOptions","getTileArcgisOptions","parseTileArcgisOptions","service","HttpParams","fromObject","request","_i","parsers","read","caught","findDataSourceInCapabilities","Capability","queryFormat","DataURL","Abstract","KeywordList","getTimeFilter","timeFilterable","Style","queryFormatMimeTypePriority","QueryFormatMimeType","mimeType","Request","GetFeatureInfo","Format","keyEnum","QueryFormat","queryFormatMimeTypePriority_1","queryFormatMimeTypePriority_1_1","removeUndefined","Title","MaxScaleDenominator","MinScaleDenominator","OnlineResource","Contents","el","Identifier","optionsFromCapabilities","ouputOptions","layer_definition","styleGenerator","olAttribution","copyrightText","timeInfo","setTime","toUTCString","range","TimeFilterType","TimeFilterStyle","layerArray","layer_1","isArray","Name","dimension","Dimension","minMaxDim","step","self","tslib_1.__decorate","Cacheable","maxCacheCount","WMSCapabilities","WMTSCapabilities","OptionsService","DataSourceService","createAsyncDataSource","context","createOSMDataSource","createFeatureDataSource","createWFSDataSource","wmsContext","removeDuplicateCaseInsensitive","createWMSDataSource","createWMTSDataSource","createXYZDataSource","createCartoDataSource","createArcGISRestDataSource","createWebSocketDataSource","createMVTDataSource","createTileArcGISRestDataSource","createClusterDataSource","datasources$","wfsDataSourceService","observables","optionsService","optionsFromApi","toDisplay","optionsMerged","projectionService","OptionsApiService","urlApi","Inject","createTileLayer","createVectorLayer","createImageLayer","createVectorTileLayer","createAsyncLayer","dataSourceService","styleService","serviceStyle_1","serviceStyle_2","baseStyle_1","clusterBaseStyle","layerOptionsOl","applyMapboxStyle","serviceStyle_3","mapboxStyle","getMapboxGlStyle","stylefunction","AuthInterceptor","Group","baselayers","composite","Catalog","catalogService","WMSCatalog","collectCatalogItems","loadCatalogWMSLayerItems","sType","TypeCatalog","WMTSCatalog","loadCatalogWMTSLayerItems","BaselayersCatalog","loadCatalogBaseLayerItems","CompositeCatalog","loadCatalogCompositeLayerItems","CatalogFactory","createInstanceCatalog","QueryService","queryLayer","getQueryUrl","extractData","urlGml","mergeMap","gmlRes","imposedGeom","mergeGML","parser","olformat.WMSGetFeatureInfo","pts","firstFeatureType","olmpts","olmline","olgeom.MultiLineString","ptsArray","olmpoly","olgeom.MultiPolygon","nbFeatures","bbox","getQueryParams","bboxExtent","featureGeometryCoordinates","featureGeometryType","olgeom.Point","appendLineString","olgeom.LineString","appendPolygon","olgeom.Polygon","convexHull","cross","lower","points_1","points_1_1","upper","imposedGeometry","queryDataSource","allowedFieldsAndAlias","getAllowedFieldsAndAlias","extractGML3Data","extractGeoJSONData","extractEsriJSONData","extractTextData","extractHtmlData","extractGML2Data","geomToAdd","createGeometryFromUrlClick","features_1","features_1_1","getQueryTitle","sourceTitle","order","searchParams","bboxRaw","xPosition","yPosition","y","crs","threshold","abs","clickx","clicky","clickx1","clicky1","wktPoly","olformat.WKT","warn","featureToResult","htmlTarget","bodyTagStart","bodyTagEnd","lastIndexOf","body","queryString","pairs","pair","decodeURIComponent","featureOL","featureGeometry","shape","SHAPE","the_geom","datasource","forceGML2","wmsDatasource","WMSGetFeatureInfoOptions","INFO_FORMAT","getMimeInfoFormat","QUERY_LAYERS","FEATURE_COUNT","getGetFeatureInfoUrl","cartoDatasource","sql","meters","queryPrecision","tileArcGISRestDatasource","olextent.boundingExtent","olextent.buffer","mime","getLabelMatch","queryEnabled","QueryDirective","cancelOngoingQueries","onMapEvent","queryService","queries$","queryFeatures","doQueryFeatures","queryLayers","waitForAllQueries","queries$$","zip","results","query$","clickedFeatures","forEachFeatureAtPixel","layerOL","newFeature","values_","nom","id_","_icon","OlRenderFeature","queryFeaturesHitTolerance","queryFeaturesCondition","queryableLayers","hasFeature","sub","SearchSource","getDefaultOptions","available","showInPointerSummary","showInSettings","searchUrl","settings","setParamFromSetting","setting","confValue_1","getHashtagsValid","settingsName","hashtags","searchSourceSetting","getSettingsValues","hashtagsValid","hashtag","hashtagKey","substring","types","search","QuerySearchSource","GoogleLinks","getGoogleMapsCoordLink","getGoogleStreetViewLink","getGoogleMapsNameLink","encodeURI","OsmLinks","getOpenStreetMapLink","getOpenStreetCamLink","CatalogService","loadCatalogs","contextConfig","catalogConfig","apiUrl","catalogsFromConfig","sources","observables$","baseLayersCatalog","catalogsFromApi$","catalogs","_response","loadCatalogItems","catalog","getCatalogBaseLayersOptions","layersOptions","CatalogItemType","getCatalogCapabilities","includeRecursiveItems","getWMTSItems","compositeCatalog","catalogsFromInstance","request1$","request2$","k","groupImpose","pushImposeGroup_1","outGroupImpose","address","flatLayer","flatDeepLayer","arr","obs","idx","request3$","output","recursiveGroupByLayerAddress","keyFn","outItem","indicesMatchTitle_1","bInd","nPosition","groupId","ind","ix","groupByGroupId","TypeCapabilities","prepareCatalogItemLayer","idParent","layersQueryFormat","configuredQueryFormat","retriveLayerInfoFormat","showLegend","queryParams","baseSourceOptions","setCrossOriginAnonymous","layerPrepare","tooltipType","prepareCatalogItemGroup","itemListIn","regexes","idGroup","idGroupItemNextLevel","groupItem","testLayerRegexes","layerItem","itemsPrepare","loopLevel","regFilters","findCatalogInfoFormat","idGroupItem","matrixSet","requestEncoding","regex","layerNameFromCatalog","currentLayerInfoFormat","baseInfoFormat","configuredInfoFormat","specific","CatalogBrowserComponent","currentItems","added","sortDirection","valueAccessor","catalogShowLegend","catalogAllowLegend","EntityStoreWatcher","cdRef","destroy","isGroup","isLayer","onLayerAddedChange","update","addLayerToMap","removeLayerFromMap","onGroupAddedChange","addGroupToMap","removeGroupFromMap","addLayersToMap","removeLayersFromMap","oLayers","oLayer","sortCatalogItemsByTitle","returnItem","titleA","titleB","ChangeDetectorRef","toggleCollapsedGroup","CatalogBrowserLayerComponent","isPreview$","addedLayerIsPreview","onMouseEvent","onToggleClick","askForLegend","layerLegendShown$","igoLayer$","addedChange","haveGroup","inRange$","CatalogBrowserGroupComponent","evaluateAdded","evaluateDisabled","added$","onToggleCollapsed","layerAddedChange","tryToggleGroup","onLayerPreview","preview$","all","toggleCollapsed","disabled$","onTitleClick","LayerLegendListBindingDirective","IgoLayerModule","MatInputModule","MatFormFieldModule","FormsModule","MatDividerModule","MatMenuModule","MatSlideToggleModule","MatSelectModule","MatListModule","MatSliderModule","MatBadgeModule","MatCheckboxModule","IgoListModule","IgoCollapsibleModule","IgoImageModule","IgoPanelModule","IgoCatalogBrowserModule","IgoMatBadgeIconModule","CatalogLibaryComponent","onCatalogSelect","focused","catalogSelectChange","CatalogLibaryItemComponent","IgoCatalogLibraryModule","IgoCatalogModule","IgoDataSourceModule","FilterableDataSourcePipe","arg","isTimeFilterable","isOgcFilterable","Pipe","TimeFilterService","filterByDate","date","newdateformStart","newdateformEnd","dates","reformatDateTime","filterByYear","year","years","getFullYear","month","getMonth","day","getUTCDate","hour","getUTCHours","minute","getUTCMinutes","OGCFilterService","filterByOgc","filterString","setOgcWFSFiltersOptions","wfsDatasource","olProjection","interfaceOgcFilters","setOgcWMSFiltersOptions","filtered","Predefined","Polygon","Point","Address","Thematics","SpatialFilterService","getKeyByValue","object","loadFilterList","urlPath","urlFilterList","featureCollection","loadThematicsList","name_1","name_2","loadFilterItem","itemType","thematic","urlType","urlItem","SpatialFilterItemType","post","loc","loadItemById","featureType","featureCode","configService","AdmRegion","Arrond","CircFed","CircProv","DirReg","MRC","Mun","RegTour","bornes","hydro","routes","DownloadService","success","DSOptions","outputFormatDownload","baseurl","DownloadButtonComponent","openDownload","downloadService","IgoDownloadModule","FeatureDetailsComponent","_source","detectChanges","_feature","htmlSanitizer","sanitizer","bypassSecurityTrustResourceUrl","isObject","isUrl","filterFeatureProperties","DomSanitizer","IgoFeatureDetailsModule","IgoKeyValueModule","IgoFeatureFormModule","IgoFormModule","IgoFeatureModule","GeometryFormFieldComponent","geometryType$","drawGuide$","value$","formControl","value$$","valueChanges","FormFieldComponent","drawControlIsActive","freehandDrawIsActive","geometryTypeField","geometryTypes","drawGuideField","drawGuidePlaceholder","measure","controlOptions","Length","Area","Meters","Kilometers","Miles","Feet","MeasureLengthUnitAbbreviation","MeasureLengthUnit","SquareMeters","SquareKilometers","SquareMiles","SquareFeet","Hectares","Acres","MeasureAreaUnitAbbreviation","MeasureAreaUnit","metersToKilometers","metersToFeet","metersToMiles","squareMetersToSquareKilometers","squareMetersToSquareMiles","squareMetersToSquareFeet","squareMetersToHectares","squareMetersToAcres","metersToUnit","conversion","squareMetersToUnit","formatMeasure","parts","locale","toLocaleString","minimumFractionDigits","maximumFractionDigits","unitAbbr","computeBestLengthUnit","converted","possibleUnits","computeBestAreaUnit","createMeasureInteractionStyle","createMeasureLayerStyle","measureOlGeometryLength","getFlatCoordinates","olGetLength","measureOlGeometryArea","olGetArea","measureOlGeometry","area","lengths","flatCoordinates","coordinatesLength","olSegment","updateOlGeometryMidpoints","olMidpoints","getOlGeometryMidpoints","midpointsLength","midpointCoordinate","getCoordinateAt","olMidpoint","setCoordinates","expectedNumber","clearOlMidpointTooltip","olTooltip","removeOverlay","updateOlTooltipsAtMidpoints","createOlTooltipAtPoint","setPosition","getOlTooltipsAtMidpoints","updateOlGeometryCenter","olCenter","centerCoordinate","olGetCenter","updateOlTooltipAtCenter","getOlTooltipAtCenter","getTooltipsOfOlGeometry","olTooltips","olCenterTooltip","olPoint","OlOverlay","className","stopEvent","GeometrySliceError","GeometrySliceMultiPolygonError","GeometrySliceLineStringError","GeometrySliceTooManyIntersectionError","createDrawInteractionStyle","createDrawHoleInteractionStyle","sliceOlGeometry","olSlicer","sliceOlPolygon","sliceOlLineString","olLineString","olPolygon","getLinearRingCount","slicer","OlGeoJSON","outerCoordinates","getLinearRing","totalIntersectionCount","segmentCoordinates","segment","lineString","intersections","lineIntersect","intersectionCount","intersection","addLinearRingToOlPolygon","olLinearRing","appendLinearRing","getMousePositionFromOlGeometryEvent","olEvent","DrawControl","olOverlayLayer","clearOlInnerOverlaySource","removeOlInnerOverlayLayer","removeOlDrawInteraction","addOlInnerOverlayLayer","addOlDrawInteraction","olOverlaySource","createOlInnerOverlayLayer","OlVectorLayer","OlVectorSource","olDrawInteraction","freehand$","OlDraw","stopClick","drawStyle","maxPoints","freehand","freehandCondition","onDrawStartKey","onDrawStart","onDrawEndKey","onDrawEnd","onDrawKey","start$","olGeometryEvent","mousePosition","changes$","end$","removeLastPoint","ModifyControl","olLinearRingsLayer","removeOlModifyInteraction","removeOlTranslateInteraction","modify","addOlTranslateInteraction","activateTranslateInteraction","addOlModifyInteraction","activateModifyInteraction","setOlGeometry","createOlLinearRingsLayer","addOlLinearRingsLayer","removeOlLinearRingsLayer","clearOlLinearRingsSource","olLinearRingsSource","olModifyInteraction","OlModify","deactivateModifyInteraction","olModifyInteractionIsActive","onModifyStartKey","onModifyStart","onModifyEndKey","onModifyEnd","onModifyKey","olTranslateInteraction","OlTranslate","deactivateTranslateInteraction","olTranslateInteractionIsActive","onTranslateStartKey","onTranslateStart","onTranslateEndKey","onTranslateEnd","onTranslateKey","olOuterGeometry","getOlGeometry","intersectsCoordinate","subscribeToDrawKeyDown","drawKeyDown$$","unsubscribeToDrawKeyDown","subscribeToDrawKeyUp","activateDrawInteraction","drawKeyUp$$","unsubscribeToDrawKeyUp","deactivateDrawInteraction","olDrawInteractionIsActive","removedOlInteractions","linearRingCoordinates","addLinearRingToOlGeometry","_linearRingCoordinates","updateLinearRingOfOlGeometry","OlLinearRing","newCoordinates","getLinearRings","SliceControl","removeDrawLineControl","addDrawLineControl","drawLineControl","drawLineStart$$","olLine","onDrawLineStart","drawLineEnd$$","onDrawLineEnd","olSlicedGeometries","lineExtent","forEachFeatureInExtent","olParts","error$","MeasurerDialogComponent","onNoClick","dialogRef","MatDialogRef","MAT_DIALOG_DATA","measureAreaUnit","measureLengthUnit","MeasurerComponent","_activeMeasureType","setActiveMeasureType","activeDrawControl","initStore","createDrawLineControl","createDrawPolygonControl","createModifyControl","toggleDrawControl","onToggleTooltips","showTooltips","updateTooltipsOfOlSource","deactivateModifyControl","freezeStore","onMeasureTypeChange","measureType","activeMeasureType","onToggleDrawControl","deactivateDrawControl","showTooltipsOfOlSource","clearTooltipsOfOlSource","onToggleMeasureUnitsAuto","measureUnitsAuto","onLengthUnitChange","activeLengthUnit","table","activeOlGeometry","updateTooltipsOfOlGeometry","onAreaUnitChange","activeAreaUnit","onCalculateClick","selectedFeatures$","sum","perimeter","openDialog","onDeleteClick","deleteMany","onModifyClick","modifyControl","feature_1","_olFeature","activateModifyControl","clearTooltipsOfOlGeometry","dialog","many","onFeatureAddedKey","updateMeasureOfOlGeometry","onFeatureRemovedKey","selectedFeatures$$","deactivateStrategyOfType","olDrawSource","OlStyle","drawPolygonControl","MeasureType","activateDrawControl","drawControl","drawStart$$","drawEnd$$","drawChanges$$","onDrawChanges","clearMeasures","finalizeMeasureOfOlGeometry","addFeatureToStore","measure$","deactivate","modifyStart$$","modifyEnd$$","modifyChanges$$","onModifyChanges","setProperties","_measure","featureId","olMidpointsTooltips","length_1","updateOlTooltip","showTooltipsOfOlGeometry","shouldShowTooltip","addOverlay","forEachFeature","_unit","_type","getElement","innerHTML","computeTooltipInnerHTML","minSegmentLength","MatDialog","tableTemplate","selectMany","selectionCheckbox","columns","MeasureFormatPipe","out","GeometryFormFieldInputComponent","_geometryType","ready","deactivateControl","createDrawControl","toggleControl","_drawControlIsActive","_freehandDrawIsActive","_drawStyle","olGuideStyle","getGuideStyleFromDrawStyle","defaultDrawStyleRadius","_overlayStyle","_value","addGeoJSONToOverlay","onChange","olModify_1","features_","overlayStyle","addOlOverlayLayer","createMeasureTooltip","registerOnChange","fn","registerOnTouched","onTouched","writeValue","updateDrawStyleWithDrawGuide","activeControl","activateControl","control","olGeometryEnds$$","onOlGeometryEnds","olGeometryChanges$$","onOlGeometryChanges","removeMeasureTooltip","updateMeasureTooltip","circleToPoint","olGeoJSON","_radius","cos","lastIndex","lastLength","olLastMidpoint","innerHtml","olStyle","drawGuide","isStyleWithRadius","NgControl","ngControl","IgoGeometryFormFieldModule","ReactiveFormsModule","MatButtonToggleModule","IgoGeometryModule","entryComponents","TimeFilterButtonComponent","header","timeFilterCollapse","TimeFilterFormComponent","valueArray","startDate","endDate","isNaN","valueOf","getStepDefinition","timeInterval","getTimezoneOffset","startYear","initStartYear","endYear","initEndYear","isRange","startListYears","endListYears","listYears","checkFilterValue","yearChange","storeCurrentFilterValue","timeFromWms","newStartListYears","newEndListYears","handleDateChange","setupDateOutput","applyTypeChange","handleYearChange","handleListYearChange","handleListYearStartChange","dateToNumber","setSliderThumbLabel","thumbLabel","findThumbLabel","mySlider","_elementRef","childNodes","textContent","children","toggleFilterState","stopFilter","resetFilter","playFilter","interval","playIcon","that","newMinDateNumber","maxDateNumber","playYear","clearInterval","handleSliderDateChange","handleSliderTooltip","handleSliderYearChange","handleSliderValue","currentDate","getRoundedDate","toDateString","toTimeString","setSeconds","setHours","setMinutes","getDay","selectedHour","getHours","selectedMinute","getMinutes","getRangeMinDate","getRangeMaxDate","atMinute","coeff","moment.duration","asMilliseconds","DateAdapter","MatSlider","dateAdapter","resetIcon","setLocale","TimeFilterItemComponent","timeFilterService","filtersCollapsed","toggleFiltersCollapsed","TimeFilterListComponent","TimeFilterListBindingDirective","WktService","wktToFeature","wkt","wktProj","featureProj","olWKT","extentToWkt","epsgTO","extentProj","currentExtent","roundCoordinateArray","wktLine","wktMultiPoints","coordinateArray","roundArray","array","snrcToWkt","snrc","snrc250kIndex","snrc50kIndex","snrc1m","snrc250k","snrc50k","ar1m","part1m","part250k_1","part50k_1","partEW","partSN","index250kEW_1","index250kSN_1","index50kEW_1","index50kSN_1","increment250kEW","increment250kSN","increment50kEW","increment50kSN","unitPerTypeEW","unitPerTypeSN","ul","1","2","3","4","5","6","7","8","9","10","lr","ur","ll","OgcFilterFormComponent","currentFilter$","currentFilter","updateField","excludeFromOgcFilters","fields$","ogcFilterOperators$","refreshFilters","checked","removeOverlayByID","deleteFilter","changeNumericProperty","changeProperty","overlayId","baseOverlayName","changeOperator","changeCaseSensitive","changeGeometry","checkSNRC50k","checkSNRC250k","checkSNRC1m","wktService","allOgcFilterOperators","igoSpatialSelectors","OgcFilterableFormComponent","OgcFilterableItemComponent","hasPushButton","ogcFilterService","lastRunOgcFilter","hasActiveSpatialFilter","filtersAreEditable","addFilterToSequence","lastLevel","firstFieldName","includedFields","datasourceOptions","firstOperatorName","defaultLogicalParent","force","activeFilters","af","ogcLayer","rebuildFilter","isAdvancedOgcFilters","addFilterDisabled","changeOgcFiltersAdvancedOgcFilters","changeOgcFilterType","OgcFilterableListComponent","OgcFilterableListBindingDirective","OgcFilterButtonComponent","currentPushButtonGroup","gr","cntPushButtons_1","cb","button","ogcFilterCollapse","OgcFilterToggleButtonComponent","getPushButtonsGroups","applyFilters","getToolTip","tt","getButtonColor","background-color","bundleIsVertical","vertical","onChangeGroup","currentOgcPushButton","conditions","SpatialFilterTypeComponent","_store","selectedTypeIndex","spatialType","activeDrawType","eventType","onTypeChange","SpatialFilterType","onQueryTypeChange","eventQueryType","selectedQueryType","onZoneChange","zoneChange","onDrawTypeChange","queryType","FormControl","SpatialFilterListComponent","_queryType","setValue","formValueChanges$$","filterNormalized","displayFn","spatialFilterService","featureGeom","selectedZone","SpatialFilterItemComponent","reset","drawStyle$","radiusFormControl","PointStyle","PolyStyle","overlayStyle$","entities$","items_1","items_1_1","childrens","localeCompare","child","thematics","radiusChanges$$","detach","onItemTypeChange","selectedItemType","itemTypeChange","onMeasureUnitChange","measureUnit","isPredefined","isPolygon","isPoint","hasChild","_","node","treeControl","isExpanded","collapse","isAllSelected","numSelected","numNodes","selectedThematics","hasChildrenSelected","bool","masterToggle","selectedThematicsName","thematicChange","select","childrensToggle","deselect","onToggleChange","nodeSelected","onDrawControlChange","onfreehandControlChange","freehandControl","toggleSearchButton","drawZone","drawZoneEvent","radiusEvent","toggleSearch","clearButton","clearButtonEvent","clearSearch","clearSearchEvent","disableSearchButton","formValue","alert","export","NestedTreeControl","displayedColumns","MatTreeNestedDataSource","SelectionModel","displayedColumnsResults","IgoFilterModule","provide","MAT_DATE_LOCALE","useValue","MatAutocompleteModule","MatTabsModule","MatRadioModule","MatTableModule","MatTreeModule","MatOptionModule","MatDatepickerModule","MatNativeDateModule","MatDatetimepickerModule","MatNativeDatetimeModule","ExportButtonComponent","layerIsExportable","ExportError","ExportInvalidFileError","ExportNothingToExportError","handleFileExportError","handleNothingToExportError","handleFileExportSuccess","ExportFormat","strEnum","ExportService","exportOlFeatures","generateFeature","exportAsync","GPX","aggregateInComment","generateAggratedFeature","comment","observer","nothingToExport","ogreFormats","ogreUrl","noOgreFallbacks","exportToFile","exportWithOgre","featuresText","writeFeatures","fileName","downloadContent","form","display","appendChild","setAttribute","acceptCharset","enctype","geojsonField","outputNameField","outputName","ogreFormat","outputFormatField","submit","removeChild","GML","KML","Shapefile","CSVcomma","CSVsemicolon","gpxAggregateInComment","ImportError","ImportInvalidFileError","ImportUnreadableFileError","ImportNothingToImportError","ImportSizeError","ImportSRSError","addLayerAndFeaturesToMap","floor","olStyle.Stroke","olStyle.Fill","olStyle.Style","olStyle.Circle","addLayerAndFeaturesStyledToMap","styleListService","distance","getStyleList","styleByAttribute_1","clusterParam_1","clusterParam_2","baseStyle_2","handleFileImportSuccess","file","computeLayerTitleFromFile","messageTitle","handleNothingToImportError","handleFileImportError","sizeMb","Invalid file","handleInvalidFileImportError","File is too large","handleSizeFileImportError","Failed to read file","handleUnreadbleFileImportError","Invalid SRS definition","handleSRSImportError","getFileExtension","ImportService","import","importAsync","getFileImporter","extension","allowedMimeTypes","allowedZipMimeTypes","allowedExtensions","importFile","importFileWithOgre","clientSideFileSizeMax","importer","reader","FileReader","parseFeaturesFromFile","readAsText","formData","FormData","append","headers","HttpHeaders","errors","parseFeaturesFromGeoJSON","errMsg","msg","startWith","GeoJSON","olformat.KML","olformat.GML","olformat.GPX","writeFeatureObject","configFileSizeMb","StyleListService","resolve","styleList","baseStyleList","path","injector","Promise","_reject","throwError","styleListResponse","Injector","ImportExportComponent","exportableLayers$","fileSizeMb","exportOptions$$","exportOptions$","skipWhile","exportOptions","patchValue","emitEvent","computeFormats","formLayer$$","handlePreviousLayerSpecs","formats$","loading$","previousSpecs","previousLayerSpecs$","formats$$","formats","exportableLayers$$","exportOptionsChange","specs","importFiles","files","inputProj","espgCodeRegex","importService","onFileImportSuccess","onFileImportError","files_1","files_1_1","handleExportFormSubmit","filename","dSOptions","featureInMapExtent","flatMap","cluster","exportService","onFileExportError","onFileExportSuccess","buildForm","forceNaming","formBuilder","Validators","required","loadConfig","formatsType_1","onlyUrl","onlyVector","vectorAndUrl","validatedListFormat","validateListFormat","tabChanged","tab","selectedTabIndex","onImportExportChange","activeImportExport","FormBuilder","selectedIndex","DragAndDropDirective","DropGeoFileDirective","filesDropped$$","filesDropped","onFilesDropped","onDragOver","onDragLeave","onDrop","HostListener","filesInvalid","STYLELIST_OPTIONS","InjectionToken","provideStyleListOptions","styleListFactory","provideStyleListLoader","APP_INITIALIZER","useFactory","multi","deps","IgoStyleListModule","IgoImportExportModule","IgoSpinnerModule","IgoDrapDropModule","IgoMapModule","IgoConfirmDialogModule","MeasurerItemComponent","_auto","toggleAutoUnit","measureUnitChange","measure$$","computeBestMeasureUnit","IgoMeasurerModule","IgoEntityTableModule","IgoMeasureModule","IgoOverlayModule","html2canvas","_html2canvas","PrintService","print","paperFormat","orientation","doc","jsPDF","dimensions","internal","pageSize","margins","addTitle","showProjection","showScale","addProjScale","addComment","addMap","addLegend","saveDoc","getLayersLegendHtml","getLayersLegendImage","doZipFile","div","useCORS","then","canvas","generateCanvaFileToZip","saveCanvasImageAsFile","parentNode","catch","pageWidth","titleMarginLeft","titleWidth","setFont","setFontSize","heightPixels","textProjScale","imgData","toDataURL","addPage","imageSize","getImageSizeToFitPdf","addImage","addCanvas","rect","timeout","mapSize","widthPixels","once","mapStatus$$","mapStatus","renderMap","defineNbFileToProcess","nbFileToProcess","downloadMapImage","newCanvas","positionHCanvas","positionWProjScale","commentWidth","measureText","positionHProjScale","commentNbLine","positionHComment","fillStyle","fillRect","projText","scaleText","mapScale","nbCommentChar","CommentLengthToCut","commentCurrentLine","positionFirstCutChar","positionLastBlank","tiwContent","getWorldFileInformation","addFileToZip","saveAs","saveFileProcessing","renderSync","save","pageHeight","getHeight","canHeight","canWidth","heightRatio","widthRatio","maxRatio","currentResolution","blobFormat","msSaveBlob","msToBlob","toBlob","zipFile","JSZip","getZipFile","generateAsync","PrintComponent","_outputFormat","_paperFormat","_orientation","_imageFormat","_resolution","handleFormSubmit","isPrintService","printService","imageFormat","PrintOutputFormat","PrintPaperFormat","PrintOrientation","PrintResolution","PrintSaveImageFormat","PrintFormComponent","imageFormatField","Jpeg","onlySelf","Pdf","paperFormatField","Letter","orientationField","landscape","resolutionField","titleField","commentField","showProjectionField","showScaleField","showLegendField","doZipFileField","isValid","submitted","toggleImageSaveProp","outputFormats","paperFormats","orientations","imageFormats","IgoPrintModule","querySearchSourceFactory","provideQuerySearchSource","IgoQueryModule","SearchSourceService","getSources","getEnabledSources","enableSourcesByType","sourceCanSearch","sourceCanReverseSearch","reverseSearch","sourceCanReverseSearchAsSummary","SearchService","termIsValid","getEnabledOnly","searchSourceService","searchType","searchSources","asPointerSummary","reverseSourceFonction","reverseSearchSources","DirectionsSource","DirectionsSourceService","directionsSourceServiceFactory","provideDirectionsSourceService","DirectionsService","directionsOptions","directionsSourceService","routeSource","DirectionsFormService","getStopsCoordinates","stopsCoordinates","stops","stop","stopCoordinates","setStops","getStops","DirectionsFormComponent","changeRoute","showRouteGeometry","prevent","preventDefault","focusOnStop","browserLanguage","getLanguage","stopsForm","directionsType","directionsMode","stopOrderPriority","directionsFixedStartEnd","createStop","initStores","initOlInteraction","subscribeToFormChange","routesQueries$$","stream$","handleTermChanged","unsubscribeRoutesQueries","unlistenSingleClick","freezeStores","writeStopsToFormService","loadingStrategy","stopsStore","stopMarker","routeStore","selectedStopFeature","selectStop","olinteraction.Select","olcondition.pointerMove","translateStop","olinteraction.Translate","getLength","executeTranslation","selectedRoute","olcondition.click","selectCoordinates","addStop","pos","at","handleLocationProposals","addStopOverlay","reverseSearchProposal","overview","firstFeature","translatedPos","translationCoordinates","stopProposals","steps","alternatives","getRoutes","stopIndex","groupedLocations","roundedCoordinates","stopPoint","searchService","resultPos","changeDetectorRefs","directionsText","stopsCounts","raiseStop","moveStop","lowerStop","fromValue","removeStop","insert","directionsFormService","insertIndex","directionsPos","getStopOverlayID","deleteStoreFeatureByID","removeAt","resetForm","routesResults","nbStops","formatStep","formatInstruction","maneuver","modifier","bearing_after","exit","activeRoute","stepPosition","lastStep","directiveFr","directiveEn","directive","cssClass","translatedDirection","translateBearing","translatedModifier","translateModifier","frAggregatedDirection","enAggregatedDirection","coma","instruction","bearing","formatDistance","formatDuration","summary","showSegment","showRouteSegmentGeometry","vertexId","lastPoint","geojsonGeom","previousVertex","previousVertexRevision","vertexFeature","zoomRoute","routeFeature","routeExtent","geometryMapProjection","previousRoute","previousRouteRevision","coords","routeResponse","directionsService","focusKey","olobservable.unByKey","copyLinkToClipboard","Clipboard","copy","getUrl","copyDirectionsToClipboard","activeRouteDirective","wayPointList","wayPointsCnt","localCnt","directionsBody","searchProposals_1","search$$","currentStopIndex","setTerm","keyIsValid","invalidKeys","keyup","handleMapClick","clearStop","chooseProposal","proposal","geomCoord","getFirstCoordinate","getInteriorPoints","focus","indexPos","clickCoordinates","geolocateStop","geolocateCoordinates","stopColor","stopText","stopID","previousStop","previousStopRevision","stopFeature","stopOpacity","directionsKey","directionsCoordKey","directionsUrl","pathname","vertexStyle","stopStyle","routeStyle","DirectionsFormBindingDirective","storedStops","directionsParams","directionsCoordUrl_1","cnt_1","stopCoordinatesFromURL","IgoDirectionsModule","searchSourceServiceFactory","provideSearchSourceService","IChercheSearchResultFormatter","formatResult","IChercheSearchSource","title$","limit","ecmax","computeRequestParams","page","extractResults","getAllowedTypes","typesMatched","hashtagsLieuxToKeep","Set","computeOptionsParam","q","computeTerm","xMin","yMin","xMax","yMax","formatter","dataToResult","computeProperties","titleHtml","highlight","subtitleHtml","title2","subtitleHtml2","title3","dataType","nextPage","removeKeys","propertiesBlacklist","googleMaps","googleMapsNom","googleLinksProperties","GoogleMaps","pointOnFeature","municipalite","regAdmin","GoogleStreetView","some","h","authService","AuthService","authenticate$","IChercheReverseSearchSource","getSubtitle","subtitle","computeExtent","defaultIChercheSearchResultFormatterFactory","provideDefaultIChercheSearchResultFormatter","ichercheSearchSourceFactory","ichercheReverseSearchSourceFactory","CoordinatesSearchResultFormatter","CoordinatesReverseSearchSource","obj","roundedCoordString","coordLonLat","OpenStreetMap","defaultCoordinatesSearchResultFormatterFactory","provideDefaultCoordinatesSearchResultFormatter","CoordinatesReverseSearchSourceFactory","_projectionService","ILayerSearchResultFormatter","allowedKey","newKey","dataR","ILayerSearchSource","computeSearchRequestParams","computeLayerOptions","groupTitle","extractQueryParamsFromSourceUrl","metadataUrl","formatOpt","urls","urlOpt","ilayerSearchResultFormatterFactory","provideILayerSearchResultFormatter","ilayerSearchSourceFactory","SEARCH_TYPES","SearchSelectorComponent","searchType$","setSearchType","searchType$$","onSetSearchType","onSearchTypeChange","getSearchTypeTitle","searchTypeChange","searchTypes","IgoSearchSelectorModule","SearchSettingsComponent","handleKeyboardEvent","pointerSummaryEnabled","pointerSummaryStatus","hasPointerReverseSearchSource","hasReverseSearchSourcesForPointerSummary","getSearchSources","textSearchSources","computeSourcesCheckAllBehavior","settingsValueCheckedCheckbox","settingValue","searchSourceChange","computeSettingCheckAllBehavior","allEnabled","enabledSourcesCnt","disabledSourcesCnt","searchSourcesAllEnabled","checkUncheckAll","stopPropagation","checkUncheckAllSources","settingsValueCheckedRadioButton","onCheckSearchSource","getAvailableValues","getAvailableHashtagsValues","changePointerReverseSearch","fromTitleButton","lastKeyTime","now","IgoSearchSettingsModule","SearchBarComponent","empty$","stream$$","onSetTerm","onKeyup","onClearButtonClick","clearFeature","onSearchSettingsChange","doSearch","searchSettingsChange","slug","minLength","input","searchTermChange","placeholder","placeholder$","researches$$","research","researches","onResearchCompleted","newResults","searchSelector","searchSettings","SearchUrlParamDirective","searchKey","ref","IgoSearchBarModule","Grouped","Flat","SearchResultsComponent","_term","pageIterator","_results$","liftResults","settingsChange$","computeGroupTitle","onResultSelect","resultSelect","groupResults","sortByOrder","r1","r2","displayOrder","grouped","sourceResults","isMoreResults","displayMoreResults","moreResults","searchResultMode","SearchResultMode","mode","withZoomButton","resultFocus","resultUnfocus","resultMouseenter","resultMouseleave","SearchResultsItemComponent","getEntityTitleHtml","onZoomHandler","zoomEvent","SearchResultAddButtonComponent","tooltip$","layersSubcriptions","IgoSearchResultsModule","IgoStopPropagationModule","SearchPointerSummaryDirective","mouseout","subscribeToPointerStore","take","pointerPositionSummaryMarker","ngAfterContentChecked","unsubscribeToPointerStore","unsubscribeReverseSearch","store$$","pointerSearchStore","resultsUnderPointerPosition","entitiesToPointerOverlay","computeSummaryClosestFeature","closestResultByType","prevDistance","summarizedClosestType","processedSummarizedClosestType","typeIndex","addPointerOverlay","reverseSearch$$","igoSearchPointerSummaryEnabled","onSearchCoordinate","igoSearchPointerSummaryDelay","_results","onSearch","searchPointerSummaryFeatureId","pointerSummary","backgroundFill","backgroundStroke","IgoSearchModule","ToastComponent","_expanded","expanded","opened","zoomToFeatureExtent","swipe","SWIPE_ACTION","UP","DOWN","IgoToastModule","IgoFlexibleModule","OgcFilterComponent","onUpdateInputs","cancel","OgcFilterWidget","ogcFilterWidgetFactory","widgetService","provideOgcFilterWidget","WidgetService","IgoOgcFilterModule","WfsWorkspace","Workspace","WfsWorkspaceService","createWorkspace","entityStore","createFeatureStore","actionStore","ActionStore","createTableTemplate","selectionStrategy","WmsWorkspace","WmsWorkspaceService","WorkspaceSelectorDirective","onLayersChange","editableLayers","layerIsEditable","editableLayersIds","workspacesToAdd","getOrCreateWorkspace","workspace","workspacesToRemove","workspaceStore","insertMany","wfsWorkspaceService","wmsWorkspaceService","WorkspaceSelectorComponent","IgoWorkspaceSelectorModule","IgoGeoWorkspaceModule","IgoWidgetModule","IgoWktModule","IgoGeoModule","optionsApiFactory","CadastreSearchSource","endsWith","numero","lot","computeGeometry","NoLot","cadastreSearchSourceFactory","NominatimSearchSource","rxjs","i1","place_id","display_name","osm_type","class","boundingbox","computeTermTags","tag","computeTermSettings","nominatimSearchSourceFactory","StoredQueriesSearchSource","storedqueriesParams","storedQueriesOptions","outputformat","extractWFSData","patternGml3","olformat.WFS","WFS","geojson","wfsfeatures","splitterRegex","splitPrefix","remainingTerm","splittedTerm","storedquery_id","wfsversion","srsname","resultTitle","utils","defaultValue","multipleFieldsQuery","StoredQueriesReverseSearchSource","longLatParams","longField","latField","doc_type","storedqueriesSearchSourceFactory","storedqueriesReverseSearchSourceFactory","DirectionsFormat","SourceDirectionsType","Route","OsrmDirectionsSource","configurable","_name","getRouteParams","extractRoutesData","formatRoute","waypoints","geometries","stepsUI","leg","roadNetworkRoute","legs","sourceType","weight_name","osrmDirectionsSourcesFactory","ExportIonicService","directory_1","externalRootDirectory","fileOpener","fileName_1","Platform","FileOpener","File","ngInjectableDef","i0","defineInjectable","factory","inject","i1$1","i2","i3","i4$1","token","platform","PrintIonicService","setDate","docOutput","charCodeAt","getDate","provideOptionsApi","provideCadastreSearchSource","provideIChercheSearchSource","provideIChercheReverseSearchSource","provideCoordinatesReverseSearchSource","provideILayerSearchSource","provideNominatimSearchSource","provideStoredQueriesSearchSource","provideStoredQueriesReverseSearchSource","provideOsrmDirectionsSource","hideOlFeature","BasicNumericOperator","Basic","BasicAndSpatial","Spatial","All","Time","exportToCSV","rows","csvContent","row","entitiesToRowData","column","EntityTableColumnRenderer","clearOlGeometryMidpoints","featureToSearchResult"],"mappings":"0+PAAA,IAAAA,IAUEA,GAAAC,UAAAC,KAAA,SAAKC,GACCA,EAASC,QACXC,OAAOH,KAAKC,EAASG,IAAK,gCAR/BC,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,6JAGZ,SAAAT,MCRF,IAAAU,IAiBEC,OAAAC,eACIF,GAAAT,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKC,YAEd,SAAUC,GACRF,KAAKC,OAASC,mCAIhBJ,OAAAC,eACIF,GAAAT,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKG,YAEd,SAAUD,GACRF,KAAKG,OAASD,mCAMhBL,GAAAT,UAAAgB,aAAA,SAAad,GACXU,KAAKK,gBAAgBhB,KAAKC,IAG5BQ,OAAAC,eAAIF,GAAAT,UAAA,UAAO,KAAX,WACE,GAAKY,KAAKM,MAGV,OAAON,KAAKM,MAAMC,8DAnCrBC,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,qWAEAC,gBAAiBC,GAAAA,wBAAwBC,iEANlC1B,sCASN2B,GAAAA,qBASAA,GAAAA,SAqBHjB,IAZE,SAAAA,GAAoBQ,GAAAL,KAAAK,gBAAAA,EAFZL,KAAAG,OAAS,UCjCnB,IAAAY,IAyBSA,GAAAC,QAAP,WACE,MAAO,CACLC,SAAUF,GACVG,UAAW,0BAfhBC,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAC,GAAAA,cACAC,GAAAA,gBACAC,GAAAA,iBACAC,GAAAA,mBAEFC,QAAS,CAAC7B,IACV8B,aAAc,CAAC9B,QASjBkB,IAlBA,SAAAA,MCGA,IAAIa,GAAgB,SAASC,EAAGC,GAI5B,OAHAF,GAAgB9B,OAAOiC,gBAClB,CAAEC,UAAW,cAAgBC,OAAS,SAAUJ,EAAGC,GAAKD,EAAEG,UAAYF,IACvE,SAAUD,EAAGC,GAAK,IAAK,IAAII,KAAKJ,EAAOA,EAAEK,eAAeD,KAAIL,EAAEK,GAAKJ,EAAEI,MACpDL,EAAGC,IAG5B,SAAgBM,GAAUP,EAAGC,GAEzB,SAASO,IAAOrC,KAAKsC,YAAcT,EADnCD,GAAcC,EAAGC,GAEjBD,EAAEzC,UAAkB,OAAN0C,EAAahC,OAAOyC,OAAOT,IAAMO,EAAGjD,UAAY0C,EAAE1C,UAAW,IAAIiD,GAG5E,IAAIG,GAAW,WAQlB,OAPAA,GAAW1C,OAAO2C,QAAU,SAAkBC,GAC1C,IAAK,IAAIC,EAAGC,EAAI,EAAGC,EAAIC,UAAUC,OAAQH,EAAIC,EAAGD,IAE5C,IAAK,IAAIV,KADTS,EAAIG,UAAUF,GACO9C,OAAOV,UAAU+C,eAAea,KAAKL,EAAGT,KAAIQ,EAAER,GAAKS,EAAET,IAE9E,OAAOQ,IAEKO,MAAMjD,KAAM8C,YAGhC,SAYgBI,GAAWC,EAAYC,EAAQC,EAAKC,GAChD,IAA2HzB,EAAvH0B,EAAIT,UAAUC,OAAQS,EAAID,EAAI,EAAIH,EAAkB,OAATE,EAAgBA,EAAOxD,OAAO2D,yBAAyBL,EAAQC,GAAOC,EACrH,GAAuB,iBAAZI,SAAoD,mBAArBA,QAAQC,SAAyBH,EAAIE,QAAQC,SAASR,EAAYC,EAAQC,EAAKC,QACpH,IAAK,IAAIV,EAAIO,EAAWJ,OAAS,EAAQ,GAALH,EAAQA,KAASf,EAAIsB,EAAWP,MAAIY,GAAKD,EAAI,EAAI1B,EAAE2B,GAAS,EAAJD,EAAQ1B,EAAEuB,EAAQC,EAAKG,GAAK3B,EAAEuB,EAAQC,KAASG,GAChJ,OAAW,EAAJD,GAASC,GAAK1D,OAAOC,eAAeqD,EAAQC,EAAKG,GAAIA,EAGhE,SAIgBI,GAAWC,EAAaC,GACpC,GAAuB,iBAAZJ,SAAoD,mBAArBA,QAAQpE,SAAyB,OAAOoE,QAAQpE,SAASuE,EAAaC,GAGpH,SAyCgBC,GAASC,GACrB,IAAIC,EAAsB,mBAAXC,QAAyBF,EAAEE,OAAOC,UAAWvB,EAAI,EAChE,OAAIqB,EAAUA,EAAEjB,KAAKgB,GACd,CACHI,KAAM,WAEF,OADIJ,GAAKpB,GAAKoB,EAAEjB,SAAQiB,OAAI,GACrB,CAAE9D,MAAO8D,GAAKA,EAAEpB,KAAMyB,MAAOL,KAKhD,SAAgBM,GAAON,EAAGnB,GACtB,IAAIoB,EAAsB,mBAAXC,QAAyBF,EAAEE,OAAOC,UACjD,IAAKF,EAAG,OAAOD,EACf,IAAmBR,EAAYe,EAA3B3B,EAAIqB,EAAEjB,KAAKgB,GAAOQ,EAAK,GAC3B,IACI,WAAc,IAAN3B,GAAsB,EAANA,QAAcW,EAAIZ,EAAEwB,QAAQC,MAAMG,EAAGC,KAAKjB,EAAEtD,OAExE,MAAOwE,GAASH,EAAI,CAAEG,MAAOA,WAEzB,IACQlB,IAAMA,EAAEa,OAASJ,EAAIrB,EAAU,YAAIqB,EAAEjB,KAAKJ,WAExC,GAAI2B,EAAG,MAAMA,EAAEG,OAE7B,OAAOF,EAGX,SAAgBG,KACZ,IAAK,IAAIH,EAAK,GAAI5B,EAAI,EAAGA,EAAIE,UAAUC,OAAQH,IAC3C4B,EAAKA,EAAGI,OAAON,GAAOxB,UAAUF,KACpC,OAAO4B,EC3IX,OAAA,SAAAK,OCcA,SAAgBC,GAA4BvE,GAS1C,OARmB,CACjBwE,IAAKC,GACLC,KAAMC,GACNC,IAAKC,GACLC,QAASC,GACTC,IAAG,SAAGC,GAAmC,MAAA,QAEdjF,EAAQkF,OAASC,IAC7BnF,GAQnB,SAAgByE,GAA+BzE,OACvCoF,EAASpF,EAAQqF,OAAOC,OAExBC,EAAQ,OADwB,MAA1BvF,EAAQd,IAAIsG,OAAO,GAAavG,OAAOwG,SAASC,OAAS1F,EAAQd,IAAMc,EAAQd,KAC/DkG,EAC5B,OAAOO,EAAAA,IAAIC,QAAQL,GAQrB,SAAgBZ,GAAgC3E,OACxCD,EAAQC,EAAQD,MAChBwF,EAAQ,OAASvF,EAAQd,IAAMa,EACrC,OAAO4F,EAAAA,IAAIC,QAAQL,GAQrB,SAAgBV,GAA+B7E,OACvCuF,EAAQ,MAAQvF,EAAQd,IAC9B,OAAOyG,EAAAA,IAAIC,QAAQL,GAQrB,SAAgBR,GAAmC/E,GACjD,IAAMA,EAAQd,IAAO,OAAOiG,GAAWnF,OACjCuF,EAAQ,UAAYvF,EAAQd,IAClC,OAAOyG,EAAAA,IAAIC,QAAQL,GAOrB,SAAgBJ,GAAWnF,GACzB,OAAO6F,GAAAA,OChET,QAiBYC,GAAAjH,UAAAsG,WAAV,WACE,OAAOZ,GAA4B9E,KAAKO,UAGnC8F,GAAAjH,UAAAkH,UAAP,SAAiBC,EAAgBC,GAC/B,OAAOxG,KAAKyG,OAASzG,KAAKyG,OAAS,IAG9BJ,GAAAjH,UAAAsH,UAAP,SAAiBnG,GASf,OARIA,EAAQd,IACVO,KAAKyG,OAAS,CAAC,CAAEhH,IAAKc,EAAQd,MACrBc,EAAQoG,KACjB3G,KAAKyG,OAAS,CAAC,CAAEE,KAAMpG,EAAQoG,OAE/B3G,KAAKyG,OAAS,GAGTzG,KAAKyG,QAIhBJ,IAhCE,SAAAA,GACS9F,EACGqG,QADH,IAAArG,IAAAA,EAAA,IAAAP,KAAAO,QAAAA,EACGP,KAAA4G,YAAAA,EAEV5G,KAAKO,QAAUA,EACfP,KAAK6G,GAAK7G,KAAKO,QAAQsG,IAAM7G,KAAK0F,aAClC1F,KAAK8G,GAAK9G,KAAK+G,4BCjBoBC,GAAAA,MAAAX,IAG3BY,GAAA7H,UAAA2H,eAAV,eACQG,EAAgB,CACpBC,OAAQnH,KAAKoH,2BAA2BpH,KAAKO,UAG/C,OAAO,IAAI8G,GAAevH,OAAO2C,OAAOyE,EAAelH,KAAKO,WAGpD0G,GAAA7H,UAAAgI,2BAAV,SAAqC7G,GACnC,GAAIA,EAAQ4G,OACV,OAAO5G,EAAQ4G,WAEbG,EACEC,EAAahH,EAAQgH,WAC3B,GAAKA,GAIH,IADAD,EAAcE,GAASD,MACHE,UAClB,MAAM,IAAIC,MAAM,oDAJlBJ,EAAcK,GAAAA,YAQVC,EAAgBrH,EAAQqH,cAQ9B,OANIA,EACO,IAAIN,EAAYM,GAEhB,IAAIN,GAMVL,GAAA7H,UAAAyI,UAAP,aAEA/H,OAAAC,eAAIkH,GAAA7H,UAAA,aAAU,KAAd,WACE,OAAQY,KAAY,QAAS8H,WACxB9H,KAAY,QAAS8H,WACtB,yCAERb,IA5CA,SAAAA,iECDmCD,GAAAA,MAAAX,IAIvB0B,GAAA3I,UAAA2H,eAAV,WAEE,OADA/G,KAAKO,QAAQd,IAAM,iDACZ,IAAIuI,EAAYhI,KAAKO,UAGvBwH,GAAA3I,UAAAyI,UAAP,aACFE,IAVA,SAAAA,iECAmCf,GAAAA,MAAAX,IAIvB4B,GAAA7I,UAAA2H,eAAV,WACE,OAAO,IAAImB,EAAYlI,KAAKO,UAGvB0H,GAAA7I,UAAAyI,UAAP,aAEFI,IAVA,SAAAA,sDCLA,IAAAE,IA0CEA,GAAA/I,UAAAgJ,+BAAA,SACEC,EACAC,EACAC,OACIC,GAAyB,EAc7B,OAbID,GAAuB,QAAZA,IACbC,GAAyB,IAG3BH,EAAoBA,GAAqB,IACvBI,QAAUJ,EAAkBI,UAAYhB,UAAYe,EAAyBH,EAAkBI,QACjHJ,EAAkBK,SAAWL,EAAkBK,WAAajB,UAAYe,EAAyBH,EAAkBK,SACnHL,EAAkBM,aAAeL,EAEjCD,EAAkBO,oBAAqB,EACnCP,EAAkBI,SAAWJ,EAAkBQ,cACjDR,EAAkBO,oBAAqB,GAElCP,GAGFF,GAAA/I,UAAA0J,YAAP,SACEC,EACAC,EACAC,EACAX,OAEIY,EACAC,EAgBJ,GAdEA,GADE,+BAA+BC,KAAKC,KAAKC,UAAUP,IAKnDA,IACFT,EACE,EAAiBK,eAAiBlB,UAC9B,EAAiBkB,aACjBL,GAEJU,GAAUD,IACZG,EAAgBK,EAAAA,KAAcjB,EAAmBU,EAAQC,EAAKO,aAG5DT,EAWF,MAAO,QAAUC,EAAOS,KAAK,KAAO,IAAMR,EAAKO,UAV/CT,EAAU/I,KAAK0J,0BAA0BX,EAAST,EAAmBW,OAajEU,EAAwC,CAC5CC,QAAS,GACTC,UAAW,GACXC,cAAe,GACfC,aAAc,CAAC,gBACfC,OAjBIhB,GAAUG,EACKc,EAAAA,IACff,EACAlJ,KAAKkK,aAAanB,IAGH/I,KAAKkK,aAAanB,GAYrCoB,aAAc,GACdxB,aAAcL,GAGV8B,GAAQ,IAAIC,GAAcC,gBAAgBX,GAKhD,MAAO,WAJK,IAAIY,eAAgBC,kBAAkBJ,GAI3BK,MAHP,iDAGsB,GAAGA,MAFzB,6BAEwC,IAGlDtC,GAAA/I,UAAA8K,aAAR,SAAqBQ,GAArB,IAAAC,EAAA3K,KACE,GAAI0K,aAAwBzI,MAAO,KAC3B2I,EAAe,GAIrB,OAHAF,EAAaG,QAAO,SAACC,GACnBF,EAAanG,KAAKkG,EAAKT,aAAaY,MAE/BF,EAEP,OAAIF,EAAavI,eAAe,WACvBnC,KAAK+K,aAAa,CACvBC,SAAUN,EAAaO,QACvBC,aAAclL,KAAKkK,aAAaQ,EAAa3B,WAEtC2B,EAAavI,eAAe,YAC9BnC,KAAK+K,aAAY,QADnB,GAMH5C,GAAA/I,UAAA2L,aAAR,SAAqBI,OAgCfC,EA/BEJ,EAAWG,EAAcH,SACzBE,EAAeC,EAAcD,aAE7BG,EAAkBF,EAAcG,aAChCC,EAAaJ,EAAcK,QAC3BC,GAAeN,EAAcO,WAC/BP,EAAcO,UAEZC,EAAcR,EAAcS,SAAWT,EAAcS,SAAW,IAChEC,EAAgBV,EAAcW,WAChCX,EAAcW,WACd,IACEC,EAAgBZ,EAAca,WAChCb,EAAca,WACd,IAEEC,EAAmBd,EAAce,cACjCC,EAAmBhB,EAAciB,cAEjCC,EAAkBlB,EAAcxC,aAChC2D,EAAYnB,EAAcnC,OAC1BuD,EAAiBpB,EAAcqB,aAC/BC,EAAatB,EAAcvB,QAC7BuB,EAAcvB,QACd,YAEE8C,EAAWvB,EAAcwB,MACzBC,EAASzB,EAAc0B,IAEvBC,EAAgB3B,EAAc4B,WAWpC,OARIR,IAEFnB,GADY,IAAI4B,IACDC,aAAaV,EAAgB,CAC1CW,eAAgBT,EAChBU,kBAAmBV,GAAc,eAI7BzB,GACN,IAAK,OACH,OAAOzB,EAAAA,KAAc8C,EAAiBC,EAAWG,GACnD,IAAK,oBACH,OAAOW,EAAAA,QACL/B,EACAY,EACAE,GAEJ,IAAK,WACH,OAAOkB,EAAAA,SAAkBhB,EAAiBjB,EAAUqB,GACtD,IAAK,SACH,OAAOa,EAAAA,OAAgBjC,EAAiBqB,EAAUE,GACpD,IAAK,oBACH,OAAOW,EAAAA,QACLlC,EACAyB,EACArB,GAEJ,IAAK,wBACH,OAAO+B,EAAAA,YAAqBnC,EAAiByB,GAC/C,IAAK,iCACH,OAAOW,EAAAA,qBAA8BpC,EAAiByB,GACxD,IAAK,aACH,OAAOY,EAAAA,WAAoBrB,EAAiBjB,EAAUqB,GACxD,IAAK,iBACH,OAAOkB,EAAAA,OAAgBtC,GACzB,IAAK,qBACH,OAAOuC,EAAAA,SAAkBvC,EAAiByB,GAC5C,IAAK,8BACH,OAAOe,EAAAA,kBAA2BxC,EAAiByB,GACrD,IAAK,iBACH,OAAOgB,EAAAA,KACLzC,EACAE,EAAWwC,QAAQ,UAAWlC,GAC9BF,EACAE,EACAE,EACAN,GAEJ,IAAK,uBACH,OAAOuC,EAAAA,WACL3C,EACAyB,EACArB,GAEJ,IAAK,SACH,OAAOwC,EAAAA,OAAgB5B,EAAiBjB,EAAUqB,GAEpD,IAAK,MACH,OAAOxC,EAAAA,IAAahH,MAAM,KAAMiI,GAClC,IAAK,KACH,OAAOgD,EAAAA,GAAYjL,MAAM,KAAMiI,GACjC,IAAK,MACH,OAAOiD,EAAAA,IAAalL,MAAM,KAAMiI,GAElC,QACE,OAAOzD,YAINU,GAAA/I,UAAAgP,8BAAP,SACE1D,EACA/B,EACAsC,EACAoD,GAJF,IAAA1D,EAAA3K,KAkCE,YA/BA,IAAAiL,IAAAA,EAAA,SACA,IAAAoD,IAAAA,GAAS,GAEL3D,aAAwBzI,MAC1ByI,EAAaG,QAAO,SAACC,GACnBH,EAAK2D,eAAe1J,OAClB+F,EAAKyD,8BACHtD,EACAnC,EACAsC,EACAoD,MAKF3D,EAAavI,eAAe,YAC9BkM,GAAgB,EAChBrO,KAAKsO,eAAe1J,OAClB5E,KAAKoO,8BACH1D,EAAa3B,QACbJ,EACA+B,EAAaO,QACboD,KAGK3D,EAAavI,eAAe,aACrCnC,KAAKsO,eAAe7J,KAClBzE,KAAKuO,mBAAmB7D,EAAc/B,EAAc0F,EAAOpD,IAI1DjL,KAAKsO,gBAGPnG,GAAA/I,UAAAoP,wBAAP,SACEC,EACAnD,EACAoD,OAEIC,EADAC,EAAyB,GAE7B,GAAIH,GAAUnD,EAAc,KACpBuD,EAAWJ,EAAOK,KAAI,SAACC,GAAS,OAAAA,EAAMC,OAAS1D,IACrDqD,EAAmBE,GAAYA,EAASI,qBACtCJ,EAASI,qBAAuBP,EAKpC,QAFAC,EAAmBA,GAAsC,mBAEhCO,eACvB,IAAK,MACHN,EAAqB5O,KAAKmP,UAC1B,MACF,IAAK,UACHP,EAAqB,CACnBQ,WAAY,CAAEC,SAAS,EAAMC,cAAe,IAC5CC,OAAQ,CAAEF,SAAS,EAAMC,cAAe,KAE1C,MACF,IAAK,kBACHV,EAAqB,CACnBY,kBAAmB,CAAEH,SAAS,EAAOC,cAAe,IACpDG,qBAAsB,CAAEJ,SAAS,EAAOC,cAAe,IACvDF,WAAY,CAAEC,SAAS,EAAMC,cAAe,IAC5CC,OAAQ,CAAEF,SAAS,EAAMC,cAAe,KAE1C,MACF,IAAK,QACHV,EAAqB,CACnBY,kBAAmB,CAAEH,SAAS,EAAOC,cAAe,IACpDG,qBAAsB,CAAEJ,SAAS,EAAOC,cAAe,KAEzD,MACA,IAAK,OACHV,EAAqB,CACnBc,OAAQ,CAAEL,SAAS,EAAOC,cAAe,KAE3C,MACJ,IAAK,eACHV,EAAqB,CACnBY,kBAAmB,CAAEH,SAAS,EAAOC,cAAe,IACpDG,qBAAsB,CAAEJ,SAAS,EAAOC,cAAe,IACvDK,sBAAuB,CAAEN,SAAS,EAAOC,cAAe,CAAC,WACzDM,+BAAgC,CAAEP,SAAS,EAAOC,cAAe,CAAC,WAClEO,mBAAoB,CAAER,SAAS,EAAOC,cAAe,CAAC,WACtDQ,4BAA6B,CAAET,SAAS,EAAOC,cAAe,CAAC,YAEjE,MACF,QACEV,EAAqB,CACnBY,kBAAmB,CAAEH,SAAS,EAAOC,cAAe,IACpDG,qBAAsB,CAAEJ,SAAS,EAAOC,cAAe,IACvDF,WAAY,CAAEC,SAAS,EAAMC,cAAe,IAC5CC,OAAQ,CAAEF,SAAS,EAAMC,cAAe,KAI9C,OAAOV,GAGFzG,GAAA/I,UAAAmP,mBAAP,SACEwB,EACApH,EACA0F,EACA2B,QADA,IAAA3B,IAAAA,EAAA,QACA,IAAA2B,IAAAA,EAAA,MAGED,EADGA,GACkB,CAAE/E,SAAU,yBAE7BiF,EAAI,CACR3E,aAAc,GACdN,SAAU,GACVkF,OAAQ,GACRC,SAAU/J,GAAAA,OACVuG,MAAO,GACPE,IAAK,GACLX,cAAe,GACfE,cAAe,GACfW,WAAY,GACZvB,QAAS,GACTI,SAAU,IACVE,WAAY,IACZE,WAAY,IACZN,WAAW,EACX0E,mBAAoB,GACpBzH,aAAc,GACdyC,SAAU,GACVoB,aAAc,GACdxD,OAAQ,GACRY,QAAS,GACToG,cAAe,GACf3B,MAAO,GAGT,OAAOvO,OAAO2C,OACZwN,EACA,CACED,cAAaA,EACb3B,MAAKA,EACL1F,aAAYA,GAEdoH,IAIG5H,GAAA/I,UAAAsK,0BAAP,SACEgB,EACApC,EACAW,EACAiH,GAJF,IAAAvF,EAAA3K,UAIE,IAAAkQ,IAAAA,GAAA,OAEMG,EAAc,GACpB,OAAI3F,aAAwBzI,OAC1ByI,EAAaG,QAAO,SAACC,GACnBuF,EAAY5L,KACVkG,EAAKjB,0BAA0BoB,EAASxC,EAAmBW,EAAMiH,MAG9DG,GAEH3F,EAAavI,eAAe,WACvBrC,OAAO2C,OACZ,GACA,CACEwI,QAASP,EAAaO,QACtBlC,QAAS/I,KAAK0J,0BACZgB,EAAa3B,QACbT,EACAW,EACAiH,KAIGxF,EAAavI,eAAe,YAC9BnC,KAAKsQ,oBAAmB,EAE7BhI,EACAW,EACAiH,QALG,GAWH/H,GAAA/I,UAAAkR,oBAAR,SACEP,EACAzH,EACAW,EACAiH,QAAA,IAAAA,IAAAA,GAAA,OAEMC,EAAWJ,EAAmB5N,eAAe,YAC/C4N,EAAmBI,SACnB/J,GAAAA,OACEmK,EAASR,EAAmB5N,eAAe,UAC7C4N,EAAmBG,OACnBA,EAEEtG,EAAUmG,EAAmB5N,eAAe,WAC9C4N,EAAmBnG,QACnBX,EAAOA,EAAKO,UAAY,YAE5B,OAAO1J,OAAO2C,OACZ,GACA,CACE0N,SAAQA,EACRD,OAAQK,EACRH,mBAAoB,cACpBxG,QAAOA,GAETmG,EACA,CAAEpH,aAAcL,KAIbH,GAAA/I,UAAAoR,sCAAP,SACEC,GAEA,GAAIA,aAAoBxO,MAAO,CAC7B,GAAuB,GAAnBwO,EAAS1N,OAAa,KAEpB2N,EAEAC,EAHAC,EAAoBH,EAAS,GAAGT,cAEhCa,EAAe,GAmCnB,OAjCAJ,EAAS5F,QAAO,SAACiG,OACThG,EAAUhL,OAAO2C,OAAO,GAAIqO,GAC5BC,EAAQN,EAASO,QAAQF,GAE7BJ,EADW,GAATK,GAAcA,EAAQN,EAAS1N,OAAS,EAC5B0N,EAASM,EAAQ,GAEjBjG,SAETA,EAAQoF,cACRpF,EAAQqF,gBACRrF,EAAQkF,cACfa,EAAapM,KAAKqG,GAEM,IAApB2F,EAAS1N,OACX4N,EAAsB7F,EACb8F,IAAsBF,EAAYV,gBACf,IAAxBa,EAAa9N,OACfkO,QAAQC,IACN,oDAEEN,EACA,MAGJD,EAAsB7Q,OAAO2C,OAC3B,GACA,CAAEwI,QAAS2F,EAAmB7H,QAAS8H,IAEzCA,EAAe,CAACF,GAChBC,EAAoBF,EAAYV,kBAI/BW,EAEP,OAAOlJ,UAGT,OAAOA,WAIHU,GAAA/I,UAAA+R,qBAAR,SAA6BtI,GAC3B,GAAIA,EAAYuI,OAAOC,MAAK,SAACC,GAAS,OAAAA,EAAMC,kBAAoB9J,YAC9D,OAAOoB,MAEL2I,EACJ,GAAI3I,EAAYuI,QAAUvI,EAAY4I,QAAS,CAC7C,IAAK5I,EAAY4I,QAAQJ,MAAK,SAACK,GAAU,OAAAA,EAAO7K,KAAOY,YACrD,MAAM,IAAIC,MAAM,4DAElB8J,EAAKG,GAAAA,YAAYC,SAAS/I,IACvBuI,OAAOvG,QAAO,SAACyG,GAChBA,EAAMO,MAAQP,EAAMO,MAAQP,EAAMO,MAAQP,EAAMtC,KAChDsC,EAAM7I,UAAU6I,EAAM7I,SAAU6I,EAAM7I,QACtC6I,EAAMC,gBAAkBI,GAAAA,YAAYC,SAASJ,EAAGC,QAAQzH,OAAM,SAAClI,GAAK,OAAAwP,EAAMQ,IAAIC,SAASjQ,EAAE+E,cAEjFgC,EAAYuI,QAAUvI,EAAY4I,SAC5CD,EAAKG,GAAAA,YAAYC,SAAS/I,IACvBuI,OAAS,CAAA,CAAGS,MAAO,SAAU7C,KAAM,SAAUuC,gBAAiBI,GAAAA,YAAYC,SAASJ,EAAGC,WAEzFD,EAAK,CACHC,QAAO,EACPL,OAAQ,EAEJS,MAAO,SAAU7C,KAAM,SACvBuC,gBAAiBI,GAAAA,YAAYC,SAAS/I,MAO9C,OAHK2I,EAAGJ,OAAOtC,KAAI,SAACkD,GAAW,OAAAA,EAAQvJ,YACrC+I,EAAGJ,OAAO,GAAG3I,SAAU,GAElB+I,GAGFrJ,GAAA/I,UAAA6S,6BAAP,SACE1R,EACA+H,EACAU,EACAC,OACMiJ,EAAa3R,EAAQ2R,WAC3B,GAAKA,EAAL,KAGIC,EAA8B,GAC9BC,EAAmC,GACvC,GAAIF,EAAWzJ,SAAWyJ,EAAWrJ,YAAa,CAChDqJ,EAAWrJ,YAAc7I,KAAKmR,qBAAqBe,EAAWrJ,iBACxDwJ,EAAmBH,EAAWrJ,YAAYuI,OAAOtC,KAAI,SAACwD,GAAK,OAAAA,EAAE7J,UAAS8I,gBACtEgB,EAAa,GACnBF,EAAiBG,IAAG,SAACC,OACbC,EAAkB,GACxBD,EAAaE,QACV3I,OAAM,SAAC4I,GAAS,OAAkB,IAAlBA,EAAMnK,UACtBoC,QAAO,SAACgI,GAAa,OAAAH,EAAgBjO,KAAKoO,EAAU9J,WACxB,IAA3B2J,EAAgB3P,OAClBwP,EAAW9N,KAAKiO,EAAgB,IACE,EAAzBA,EAAgB3P,QACzBwP,EAAW9N,KAAK,CAAEwG,QAASwH,EAAaxH,QAASlC,QAAS2J,MAGrC,GAArBH,EAAWxP,SACboP,EAA8BnS,KAAK8I,YACT,IAAtByJ,EAAWxP,OAAewP,EAAW,GAAK,CAAEtH,QAAS,MAAOlC,QAASwJ,GACrEvJ,EACAC,EACAiJ,EAAWvJ,eAKnB,GAAIuJ,EAAWzJ,SAAWyJ,EAAWnJ,QAAS,CAC5CmJ,EAAWvJ,aAAeuJ,EAAWvJ,cAAgBL,MAC/CwK,EAAaZ,EAAWnJ,QAC9BqJ,EAAmCpS,KAAK8I,YAAYgK,EAAY9J,EAAQC,EAAMiJ,EAAWvJ,kBAGvFoK,EAAoBb,EAAWtJ,mBAAqBwJ,EAAmCD,EAQ3F,MAPqB,QAAjB5R,EAAQkF,OACVsN,EAAoB/S,KAAKgT,yBAAyBD,EAAmB,EAAiBnN,OAAOC,SAE1E,QAAjBtF,EAAQkF,OACVsN,EAAoB/S,KAAKgT,yBAAyBD,EAAmB,EAAiBnN,OAAOmE,eAGxFgJ,IAIF5K,GAAA/I,UAAA4T,yBAAP,SACEC,EACAC,OACIC,EAAgB,GAUpB,OAT+B,IAA3BF,EAAgBlQ,SAAoD,IAApCmQ,EAAkBlC,QAAQ,KAC5DmC,EAAgBF,EAEhBC,EAAkBzI,MAAM,KAAKI,QAAO,SAACuI,GACnCD,EAAmBA,EAAa,IAAIF,EAAgBlF,QAAQ,UAAW,IAAG,MAInC,GAD3CoF,EAAgBA,EAAcpF,QAAQ,QAAS,KACbhL,OAAaoQ,EAAcpF,QAAQ,UAAW,IAAMtG,WAG1FU,IAzkBA,SAAAA,KACUnI,KAAAsO,eAA8C,GAC/CtO,KAAAmP,UAAY,CACjBK,kBAAmB,CAAEH,SAAS,EAAOC,cAAe,IACpDG,qBAAsB,CAAEJ,SAAS,EAAOC,cAAe,IACvD+D,eAAgB,CAAEhE,SAAS,EAAOC,cAAe,CAAC,WAClDK,sBAAuB,CAAEN,SAAS,EAAOC,cAAe,CAAC,WACzDM,+BAAgC,CAAEP,SAAS,EAAOC,cAAe,CAAC,WAClEO,mBAAoB,CAAER,SAAS,EAAOC,cAAe,CAAC,WACtDQ,4BAA6B,CAAET,SAAS,EAAOC,cAAe,CAAC,WAC/DgE,kBAAmB,CAAEjE,SAAS,EAAOC,cAAe,CAAC,WACrDI,OAAQ,CAAEL,SAAS,EAAOC,cAAe,IACzCiE,eAAgB,CAAElE,SAAS,EAAOC,cAAe,IACjDF,WAAY,CAAEC,SAAS,EAAMC,cAAe,IAC5CC,OAAQ,CAAEF,SAAS,EAAMC,cAAe,IACxCkE,SAAU,CAAEnE,SAAS,EAAMC,cAAe,KC/B9C,IAAamE,GAAc,YACdC,GAAqB,IACrBC,GAAoB,QACpBC,GAA2B,WAC3BC,GAAW,IAAIC,OAAO,mBACtBC,GAAY,IAAID,OAAO,oBAUpC,SAAgBE,GACdC,EACAC,EACAC,EACAC,OAEMC,EAAgB,QAChB5U,EAAMwU,EAAkBK,OACxBC,EAAYN,EAAkBM,UAC9BC,EAAiBN,GAASR,GAC1Be,EAAWN,GAAQV,GACnBtJ,EAAeoK,EAAUpK,aAC3B,gBAAgBoK,EAAUpK,aAC1B,GACEuK,EAAUH,EAAUG,QACtB,WAAWH,EAAUG,QACrB,WAAWf,GAGT5J,GADJwK,EAAUG,UAAYL,EAAgB,YAAc,YACjB,IAAIE,EAAUxK,aAC7C4K,EACJJ,EAAUG,UAAYL,EAAgB,QAAU,cAC5CO,EAAMV,EACLS,EAAgB,IAAIH,EACvBD,EAAUM,YACPF,EAAgB,IAAIJ,EAAUM,YAC9BF,EAAgB,IAAIH,EACrBM,EAAMX,EACR,WAAWM,EACXF,EAAU3K,QACV,WAAa2K,EAAU3K,QACvB,WAAW6K,EAEXnJ,EAAe,GACfyJ,EAAiB,GACjBX,IACF9I,EAAe,gBAAgB8I,EAC/BW,EAAiB,kBAAkBX,OAE/BY,EAAef,EAAkBe,aACvC,IAAK1J,GAAgB0J,GAAsC,EAAtBA,EAAajS,OAAY,KACtDkS,EAAc,GACpBhB,EAAkBe,aAAanK,QAAO,SAACqK,GACrCD,EAAYxQ,KAAKyQ,EAAYlG,QAE/B1D,EAAe,gBAAgB2J,EAAYxL,KAAK,KAAI,IAClD8K,EAAUjM,sBAKV6M,EAAgB1V,EAAG,mCAAmCiV,EAAO,IAAI3K,EAAY,IACjFoL,GAAiBhL,EAAY,IAAI2K,EAAG,IAAIF,EAAG,IAAItJ,MAE3C8J,EAAsB3V,EAAG,iDAAiD4U,EAAa,IAAItK,EAAY,IAG3G,OAFAqL,GAAoB,IAAIR,EAAG,IAAIG,EAExB,CACL,CAAE/F,KAAM,eAAgB9O,MAAOiK,GAC/B,CAAE6E,KAAM,UAAW9O,MAAOwU,GAC1B,CAAE1F,KAAM,WAAY9O,MAAO6J,GAC3B,CAAEiF,KAAM,QAAS9O,MAAO0U,GACxB,CAAE5F,KAAM,UAAW9O,MAAO4U,GAC1B,CAAE9F,KAAM,eAAgB9O,MAAOoL,GAC/B,CAAE0D,KAAM,iBAAkB9O,MAAO6U,GACjC,CAAE/F,KAAM,kBAAmB9O,OAfFT,EAAG,wCAAwCiV,GAelB3G,QAAQ,MAAO,MACjE,CAAEiB,KAAM,aAAc9O,MAAOiV,EAAWpH,QAAQ,MAAO,MACvD,CAAEiB,KAAM,mBAAoB9O,MAAOkV,EAAiBrH,QAAQ,MAAO,OAYvE,SAAgBsH,GAAeC,EAAsB/M,GAC/CA,GAAuB,QAAZA,IAEb+M,EAAqBf,UAAYe,EAAqB1P,YAYpDuE,EATEoK,EAAYe,EAAqBf,UAiBvC,OAhBAe,EAAqBhB,OACnBgB,EAAqBhB,QAAUgB,EAAqB7V,IAEtD8U,EAAUG,QAAUH,EAAUG,SAAWf,GACzCY,EAAUjM,kBACRiM,EAAUjM,mBAAqBsL,GACjCW,EAAUM,YAAcN,EAAUM,aAAenB,GAG7Ca,EAAUpK,eACZA,EAAeoK,EAAUpK,eAGvB0J,GAASzK,KAAKe,IAAkBA,IAClCoK,EAAUG,QAAU,SAEf5U,OAAO2C,OAAO,GAAI6S,GAG3B,SAAgBC,GACdhV,OAEMoJ,EAAU,EAEZrC,EAAckO,GAAAA,IACZrL,EAAeR,EAAW4K,UAAUpK,aACtCR,EAAW4K,UAAUpK,aACrB1C,UAEJ,OAAK0C,EAIDsL,GAAStL,GAEJ,IADP7C,EAAcmO,GAAStL,IACAR,EAAW/B,eACzBuC,EAAa+E,cAAcwG,MAAM,QAEnC,IADPpO,EAAckO,GAAAA,KACQhT,GAAA,GAAMmH,EAAW/B,cAAmB,CAAE+N,UAAWC,KAC9DzL,EAAa+E,cAAcwG,MAAM,SAEnC,IADPpO,EAAckO,GAAAA,KACQhT,GAAA,GAAMmH,EAAW/B,cAAmB,CAAE+N,UAAWE,KAC9D1L,EAAa+E,cAAcwG,MAAM,QAEnC,IADPpO,EAAckO,GAAAA,KACQhT,GAAA,GAAMmH,EAAW/B,cAAmB,CAAE+N,UAAWG,KAC9D3L,EAAa+E,cAAcwG,MAAM,YAEnC,IADPpO,EAAcyO,GAAAA,UACSpM,EAAW/B,eACzBuC,EAAa+E,cAAcwG,MAAM,WAEnC,IADPpO,EAAc0O,GAAAA,SACSrM,EAAW/B,eACzBuC,EAAa+E,cAAcwG,MAAM,YAEnC,IADPpO,EAAc2O,GAAAA,UACStM,EAAW/B,eACzBuC,EAAa+E,cAAcwG,MAAM,QAEnC,IADPpO,EAAc0O,GAAAA,SACSrM,EAAW/B,eACzBuC,EAAa+E,cAAcwG,MAAM,OAEnC,IADPpO,EAAc4O,GAAAA,KACSvM,EAAW/B,eACzBuC,EAAa+E,cAAcwG,MAAM,OAEnC,IADPpO,EAAc6O,GAAAA,KACSxM,EAAW/B,eACzBuC,EAAa+E,cAAcwG,MAAM,UAEnC,IADPpO,EAAc8O,GACSzM,EAAW/B,eACzBuC,EAAa+E,cAAcwG,MAAM,OAEnC,IADPpO,EAAc+O,GAAAA,KACS1M,EAAW/B,eAG7B,IAAIN,EAzCF,IAAIA,EAAYqC,EAAW/B,0BC1HHZ,GAAAA,MAAAX,IAsBvBiQ,GAAAlX,UAAA2H,eAAV,WAAA,IAAA4D,EAAA3K,KAEE,OAAO,IAAIqH,GAAe,CACxBF,OAAQoO,GAAqBvV,KAAKO,SAClCgW,UAAU,EACV9W,IAAG,SAAGuJ,EAAQwN,EAAYvN,GAExB,OADA0B,EAAKpK,QAAQgU,UAAU3K,QAAUe,EAAKpK,QAAQgU,UAAU3K,SAAWX,EAAKO,UACjEmB,EAAK8L,SACVzN,EACAC,EACC0B,EAAY,QAAoCuH,aAErDwE,SAAUC,EAAAA,QAINL,GAAAlX,UAAAqX,SAAR,SAAiBzN,EAAQC,EAAoBiJ,OAGvCY,EAFEyB,EAAYvU,KAAKO,QAAQgU,UACzBqC,EAAoB5C,GAAqBhU,KAAKO,QAASkH,UAAWzH,KAAKO,QAAQgU,UAAU3K,SAE3FsI,GAAcA,EAAWzJ,UAC3BqK,EAAaZ,EAAWnJ,aAEpB8N,EAAkB,IAAI1O,GACtB2O,EAAcD,EAAgB/N,YAAYgK,EAAY9J,EAAQC,EAAMiJ,EAAWvJ,cACjFoO,EAAeF,EAAgB5E,6BAA6BjS,KAAKO,QAAS2R,EAAWvJ,cAErFqO,EAAS,SACRD,IACHC,EAAS,OACTD,EAAe/N,EAAOS,KAAK,KAAO,IAAMR,EAAKO,WAG/C+K,EAAU0C,UAAY/E,EAAWtJ,mBAAqBkO,EAAiBE,EAAM,IAAID,MAC7EG,EAAUN,EAAkB9H,KAAI,SAACmB,GAAK,MAAW,eAAXA,EAAEjB,OAAuB9O,MAInE,OAFAgX,EADsB,qBACE9N,KAAKmL,EAAU0C,WAAgBC,EAAO,IAAI3C,EAAU0C,UAAcC,EAC1FlX,KAAKO,QAAQ4W,SAAWrX,OAAO2C,OAAO,GAAIzC,KAAKO,QAAQ4W,SAAU,CAAEC,WAAYF,IACxEA,EAAQnJ,QAAQ,MAAO,MAGzBuI,GAAAlX,UAAAyI,UAAP,aACFyO,IA7DE,SAAAA,GACS/V,EACG8W,GAFZ,IAAA1M,EAIE2M,GAAAtU,KAAAhD,KAAMqV,GAAe9U,EAAS,SAAOP,KAH9B2K,EAAApK,QAAAA,EACGoK,EAAA0M,WAAAA,MAIJnF,EAAcvH,EAAY,QAAoCuH,WAC9D5J,EAAoBqC,EAAKpK,QAAQgU,UAAUjM,mBAAqBsL,GAChEiD,EAAkB,IAAI1O,UAC3BwC,EAAY,QAAoCuH,WAC/C2E,EAAgBzO,+BAA+B8J,EAAY5J,GAE1DqC,EAAY,QAAoCuH,WAAWzJ,SAC3DkC,EAAY,QAAoCuH,WAAWxJ,UAE5DiC,EAAK0M,WAAWE,uBAAuB5M,EAAKpK,sBClBlByG,GAAAA,MAAAnC,IAK9B2S,GAAApY,UAAAqY,QAAA,WAEE,OADAxG,QAAQC,IAAI,oCACL,oCAGFsG,GAAApY,UAAAmY,uBAAP,SAA8BtD,GACvBA,EAAkBe,cAA0D,IAA1Cf,EAAkBe,aAAajS,OAOpE/C,KAAK0X,2BAA2BzD,GAAmB0D,UAAS,SAACC,GAC3D3D,EAAkBe,aAAanK,QAAO,SAACqK,GACjCA,EAAY2C,QAAUpQ,YACxByN,EAAY2C,MAAQ3C,EAAYlG,MAE9BkG,EAAY4C,SAAWrQ,WAA2C,IAA9ByN,EAAY4C,OAAO/U,SACzDmS,EAAY4C,OAASF,EAAsB9I,KAAI,SAACiJ,GAAM,OAAAA,EAAG/I,OAASkG,EAAYlG,OAAM8I,aAZ1F7D,EAAkBe,aAAe,GACjChV,KAAK0X,2BAA2BzD,GAAmB0D,UAAS,SAACC,GAC3D3D,EAAkBe,aAAe4C,MAiB/BJ,GAAApY,UAAA4Y,cAAR,SACE/D,EACAgE,EACAxD,EACAnJ,QAFA,IAAA2M,IAAAA,EAAAvE,SACA,IAAAe,IAAAA,EAAAhB,QAIMyD,EADoBlD,GAAqBC,EAAmBgE,EAAIxD,EAAUnJ,GAC9CwD,KAAI,SAACmB,GAAK,MAAW,eAAXA,EAAEjB,OAAuB9O,MAC/DiK,EAAe8J,EAAkBM,UAAUpK,aACjD,OAAI0J,GAASzK,KAAKe,KAAkBA,EAC3BnK,KAAKkY,KAAKC,IAAIjB,EAAS,CAAEkB,aAAc,SAEvCpY,KAAKkY,KAAKC,IAAIjB,IAIzBM,GAAApY,UAAAsY,2BAAA,SACEzD,GADF,IAAAtJ,EAAA3K,KAGE,OAAO,IAAIqY,GAAAA,WAAU,SAACxW,OAEhByW,EACAC,EACAC,EACAC,EAJEzD,EAAe,GAMrByD,EAAYlD,GAAqBtB,GAEjCtJ,EAAKqN,cAAc/D,EAAmB,GAAG0D,UAAS,SAACe,OAC3CC,EAAWF,EAAUG,aAAaF,GACxCJ,EAAYK,EAAS,GAAGE,UACxBN,EAAkBD,EAAUtO,OAAM,SAChC+E,GACE,OAAAA,IAAU4J,EAAS,GAAGG,oBACrB/J,EAAM2G,MAAM,iBAEjB8C,EAAqBD,EAAgB9O,KAAK,KAC1CkB,EAAKqN,cACH/D,EACAA,EAAkBM,UAAUM,aAAenB,GAC3CO,EAAkBM,UAAU3K,QAC5B4O,GACAb,UAAS,SAACoB,OACJC,EAAYP,EAAUG,aAAaG,GACzCpO,EAAKsO,uBAAuBD,GAAWnO,QAAO,SAACC,GAC7CkK,EAAavQ,KAAKqG,KAEpBjJ,EAAEuC,KAAK4Q,GACPnT,EAAEqX,kBAOF1B,GAAApY,UAAA6Z,uBAAR,SAA+BN,OACvBQ,EAAKrZ,OAAO2C,OAAO,GAAIkW,EAAS,GAAGS,wBAClCD,EAAGR,EAAS,GAAGG,0BACfK,EAAGE,cACJrE,EAAe,GACrB,IAAK,IAAMsE,KAAYH,EACrB,GAAIA,EAAGhX,eAAemX,GAAW,KACzBC,EACiC,iBAA9BZ,EAAS,GAAGR,IAAImB,GACnB7R,iBACOkR,EAAS,GAAGR,IAAImB,GAC7BtE,EAAavQ,KAAK,CAChBuK,KAAMsK,EACNzB,MAAOyB,EACP7T,KAAM8T,EACNzB,OAAQ,CAACqB,EAAGG,MAiBlB,OAbAX,EAAStH,MAAK,SAAEvG,OACR0O,EAAoB1O,EAAQsO,2BACvB/V,GACLmW,EAAkBrX,eAAekB,IAAQA,KAAO8V,GAClDnE,EAAahL,OAAM,SAACiG,GAAK,OAAAA,EAAEjB,OAAS3L,IAAKwH,QAAO,SAAC4O,IACG,IAA9CA,EAAE3B,OAAO9G,QAAQwI,EAAkBnW,KACrCoW,EAAE3B,OAAOrT,KAAK+U,EAAkBnW,OAJxC,IAAK,IAAMA,KAAOmW,IAAPnW,GASX,OAAO,IAEF2R,wBAzHVtV,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAdL8Z,GAAAA,mJAiBP,SAAAlC,GAAoBU,GAApB,IAAAvN,EACE2M,GAAAtU,KAAAhD,OAAOA,YADW2K,EAAAuN,KAAAA,eCjBpByB,KAAO,OACPC,KAAO,OACPvQ,KAAO,OACPwQ,QAAU,UACVC,SAAW,WACXC,SAAW,WACXC,KAAO,OACPC,KAAO,OACPC,SAAW,gBAIXP,KAAO,0BACPC,KAAO,gCACPvQ,KAAO,mBACPwQ,QAAU,sBACVC,SAAW,UACXC,SAAW,mBACXC,KAAO,aACPC,KAAO,YACPC,SAAW,iBAIXC,OAAS,SACTC,MAAQ,cCRyBpT,GAAAA,MAAAX,IAGjCvG,OAAAC,eAAIsa,GAAAjb,UAAA,SAAM,KAAV,WACE,OAAOY,KAAKO,QAAc,wCAG5BT,OAAAC,eAAIsa,GAAAjb,UAAA,aAAU,KAAd,WACE,OAAQY,KAAY,QAAS8H,WACxB9H,KAAY,QAAS8H,WACtB,yCAGNhI,OAAAC,eAAIsa,GAAAjb,UAAA,WAAQ,KAAZ,WACE,OAAQY,KAAY,QAASsa,0CAG/Bxa,OAAAC,eAAIsa,GAAAjb,UAAA,kBAAe,KAAnB,WACE,OAAQY,KAAY,QAASua,gBACxBva,KAAY,QAASua,gBACtBC,GAAgBJ,uCAuFtBC,GAAAjb,UAAAqb,QAAA,WACEza,KAAK8G,GAAG4T,aAAa,CAAEC,WAAYC,KAAKC,YAGlCR,GAAAjb,UAAA0b,qCAAR,SAA6CC,GAI3C,OAH0B/G,GAAqB+G,GACTjM,KAAI,SAACmB,GAAK,MAAW,eAAXA,EAAEjB,OAC/C9O,OAIKma,GAAAjb,UAAA2H,eAAV,WACE,OAAO,IAAIiU,EAAiBhb,KAAKO,UAGnC8Z,GAAAjb,UAAAkH,UAAA,SAAUC,EAAgBC,OACpBC,EAAS6Q,GAAAlY,UAAMkH,UAAStD,KAAAhD,MAC5B,GAAoB,EAAhByG,EAAO1D,QAAewD,IAAUkB,YAAcjB,EAChD,OAAOC,MAGHwU,EAAejb,KAAK4F,OAEtBD,EAAS,GACTsV,EAAapV,SAAW4B,YAC1B9B,EAASsV,EAAapV,OAAO4E,MAAM,UAG/ByM,EAAUlX,KAAKO,QAAQd,IAAIsO,QAAQ,MAAO,IAC1CnI,EAAS,CACb,2BACA,cACA,mBACA,oBACA,YAAWqV,EAAaC,SAAW,UAkBrC,OAhBI3U,IAAUkB,WACZ7B,EAAOnB,KAAK,SAAS8B,GAEnBC,IAAUiB,WACZ7B,EAAOnB,KAAK,SAAS+B,GAGvBC,EAASd,EAAO6M,IAAG,SAAElS,OACb6a,EAAYjE,EAAQxB,MAAM,MAAQ,IAAM,IAC9C,MAAO,CACLjW,IAAQyX,EAAUiE,EAAYvV,EAAO6D,KAAK,KAAI,UAAUnJ,EACxDuR,MAAuB,EAAhBlM,EAAO5C,OAAazC,EAAQmH,UACnC2T,aAAc7U,IAAUkB,UAAYA,UAAS,MAO5C4S,GAAAjb,UAAAyI,UAAP,aACFwS,IA5IE,SAAAA,GACS9Z,EACG8W,GAFZ,IAAA1M,EAIE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,KAHP2K,EAAApK,QAAAA,EACGoK,EAAA0M,WAAAA,MAGJ4D,EAAoB1a,EAAQqF,OAE5ByV,EAAMJ,EAAaK,KAAO,GAChCL,EAAaK,IAAMD,EACnBJ,EAAaM,eAAiBF,EAC9BJ,EAAaO,eAAiB,OAASH,EAEnC9a,EAAQkb,oBAAmD,EAA7Blb,EAAQkb,oBACxCC,YAAW,WACT/Q,EAAK8P,WACyB,IAA7Bla,EAAQkb,wBAGTnT,EAAoBsL,GAGxB,GAAIrT,EAAQgU,UAAW,KACfoH,EAAatG,GAAe9U,EAAS,OAC3CoR,GAAAA,YAAYiK,UAAUrb,EAAQgU,UAAWoH,EAAWpH,WAEpDjM,EACE/H,EAAQgU,UAAUjM,mBAAqBA,EAEzC/H,EAAQ4W,SAAWrX,OAAO2C,OAAO,GAAIlC,EAAQ4W,SAAU,CACrDC,WAAYzM,EAAKmQ,qCAAqCva,KAIrDA,EAAQyU,cAAgD,IAAhCzU,EAAQyU,aAAajS,OAGhDxC,EAAQyU,aAAanK,QAAO,SAACgR,GAC3BA,EAAYhE,MAAQgE,EAAYhE,MAC5BgE,EAAYhE,MACZgE,EAAY7M,OALlBzO,EAAQyU,aAAe,OASnB8G,EAAiB,EACpB5J,WACG2E,EAAkB,IAAI1O,GAEvB2T,EAOHA,EAAelT,oBAAqBkT,EAAejT,YANnD,EAA4CqJ,WAAa2E,EAAgBzO,+BACvE0T,EACAxT,EACA,OASsC,EAAxC2S,EAAapV,OAAO4E,MAAM,KAAK1H,QAC/B+Y,GACAA,EAAerT,UAEfwI,QAAQC,IAAI,mCACZD,QAAQC,IACN,iCACE+J,EAAapV,OACb,gEAEJoL,QAAQC,IAAI,oCAGV3Q,EAAQgU,WAAauH,GAAkBA,EAAerT,SAAWqT,EAAepT,UAClFiC,EAAK0M,WAAWE,uBAAuBhX,OAGnCwS,EAAoB8D,EAAgB5E,6BACxC1R,EACA+H,UAEF2S,EAAac,OAAShJ,ICnH1B,SAAgBiJ,GAAsB7H,GAMpC,QAJM8H,GADa9H,EAAO+H,GAAAA,IAAW/H,GAAQ+H,GAAAA,IAAW,cACpBC,YAC9BC,EAAOC,EAAAA,SAAeJ,GAAoB,IAC1CK,EAAc,IAAIra,MAAM,IACxBsa,EAAY,IAAIta,MAAM,IACnBua,EAAI,EAAGA,EAAI,KAAMA,EACxBF,EAAYE,GAAKJ,EAAOxB,KAAK6B,IAAI,EAAGD,GACpCD,EAAUC,GAAKA,EAGjB,OAAO,IAAIE,EAAe,CACxBzW,OAAQ0W,EAAAA,WAAiBV,GACzBK,YAAWA,EACXC,UAASA,eCfuBvV,GAAAA,MAAAX,IAQxBuW,GAAAxd,UAAA2H,eAAV,eACQG,EAAgBpH,OAAO2C,OAC3B,CACEoa,SAAUb,GAAsBhc,KAAKO,QAAkB,aAEzDP,KAAKO,SAGP,OAAO,IAAIuc,EAAa5V,IAGnB0V,GAAAxd,UAAAyI,UAAP,aAEF+U,IAjBE,SAAAA,GAAYrc,UACV+W,GAAAtU,KAAAhD,KAAMO,IAAQP,gBCJmBgH,GAAAA,MAAAX,IAInCvG,OAAAC,eAAIgd,GAAA3d,UAAA,SAAM,KAAV,WACE,OAAOY,KAAKO,QAAc,wCAG5BT,OAAAC,eAAIgd,GAAA3d,UAAA,aAAU,KAAd,WACE,OAAQY,KAAY,QAAS8H,WACxB9H,KAAY,QAAS8H,WACtB,yCAGNhI,OAAAC,eAAIgd,GAAA3d,UAAA,WAAQ,KAAZ,WACE,OAAQY,KAAY,QAASsa,0CAG/Bxa,OAAAC,eAAIgd,GAAA3d,UAAA,kBAAe,KAAnB,WACE,OAAQY,KAAY,QAASua,gBACxBva,KAAY,QAASua,gBACtBC,GAAgBJ,uCAGZ2C,GAAA3d,UAAA2H,eAAV,eACQiW,EAAchd,KAAKO,QAAQyc,YAC7Bhd,KAAKO,QAAQyc,YACb,YACE9V,EAAgBpH,OAAO2C,OAC3B,CACEua,YAAWA,GAEbhd,KAAKO,SAEP,OAAO,IAAI0c,EAAc/V,IAG3B6V,GAAA3d,UAAAkH,UAAA,mBACQG,EAAS6Q,GAAAlY,UAAMkH,UAAStD,KAAAhD,MAC9B,GAAoB,EAAhByG,EAAO1D,OACT,OAAO0D,MAGLyW,EAAa,UACjB,GAA4C,MAAxCld,KAAKO,QAAQ4c,OAAOxX,OAAO,GAAGc,OAchC,OAbAzG,KAAKO,QAAQ4c,OAAOxX,OAAO,GAAGc,OAAO2W,MAAMvS,QAAO,SAACoF,IAC/B,IAAdA,EAAEoN,UACJH,GACE,oCAEAjN,EAAE/P,MACF,gCAEA+P,EAAEjB,KACF,gBAIC,CAAC,CAAErI,KADVuW,GAAc,iBAIRI,EAAetd,KAAKO,QAAQ4c,OAAOxX,OAAO,GAAGpF,YASnD,IAAsB,IAAAgd,EAAAC,GAPR,CACZ,gBACA,eACA,eACA,iBACA,gBAEyBC,EAAAF,EAAAnZ,QAAAqZ,EAAApZ,KAAAoZ,EAAAF,EAAAnZ,OAAE,CAAxB,IAAMsZ,EAAOD,EAAAvd,MAChB,GAAIod,EAAaK,SAAS5L,SAAS2L,GAAU,KACrCjY,EAAO6X,EAAaK,SAASlT,MAAMiT,GAASE,MAC5CC,EAAQpY,EAAKqY,OAAO,EAAGrY,EAAKuL,QAAQ,MAC1C,GAAI6M,EAAM9L,SAAS,QAAS,CAG1B,QAFMgM,EAASF,EAAMpT,MAAM,OAAO,GAAGA,MAAM,KACrCuT,EAAOH,EAAMpT,MAAM,OAAO,GAAGA,MAAM,KAChCwT,EAAI,EAAGA,EAAIF,EAAOhb,OAAQkb,IACjCF,EAAOE,GAAKF,EAAOE,GAAGlQ,QAAQ,UAAW,IACzCiQ,EAAKC,GAAKD,EAAKC,GAAGlQ,QAAQ,UAAW,IACD,MAAhCiQ,EAAKC,GAAGlQ,QAAQ,OAAQ,MAC1BiQ,EAAKC,GAAK,UAEZf,GACE,oCAEAa,EAAOE,GACP,gCAEAD,EAAKC,GACL,aAEJ,UAEMpM,EAAQyL,EAAaY,WACvBZ,EAAaY,WACb,GACJhB,GACE,oCAEAW,EACA,gCAEAhM,EACA,aACF,4GAKN,MAAO,CAAC,CAAElL,KADVuW,GAAc,cAKXH,GAAA3d,UAAAyI,UAAP,aACFkV,IAnHA,SAAAA,iECC0C/V,GAAAA,MAAAX,IAI9B8X,GAAA/e,UAAA2H,eAAV,eACQqX,EAAiB,IAAIC,EAC3B,OAAO,IAAIhX,GAAe,CACxBiX,aAActe,KAAKO,QAAQqF,OAAO0Y,aAClC/H,UAAU,EACVpP,OAAQiX,EACR3e,IAAK,SAASuJ,EAAQwN,EAAYvN,OAC1BiO,EAAUlX,KAAKO,QAAQd,IAAM,IAAMO,KAAKO,QAAQD,MAAQ,UAYxDsF,EAAS,CACb,SACA,YAbe2Y,mBACf,WACEvV,EAAO,GACP,WACAA,EAAO,GACP,WACAA,EAAO,GACP,WACAA,EAAO,GACP,wCAKF,oCACA,cACA,sCACA,cACA,sBACA,gBAEF,GAAIhJ,KAAKO,QAAQqF,OAAO4Y,WAAY,KAC5BC,EAAO,QAAQze,KAAKO,QAAQqF,OAAO8Y,WACzC9Y,EAAOnB,KAAKga,GAOd,OALIze,KAAKO,QAAQqF,OAAO+Y,cACtB3e,KAAKO,QAAQqF,OAAO+Y,aAAa9T,QAAO,SAACC,GACvClF,EAAOnB,KAAKqG,KAGNoM,EAAO,IAAItR,EAAO6D,KAAK,MACjCmV,KAAK5e,MACP0W,SAAUmI,EAAAA,QAIdV,GAAA/e,UAAAkH,UAAA,mBACQwY,EAAa9e,KAAKO,QAAQqF,OAAOkZ,WACjCrY,EAAS6Q,GAAAlY,UAAMkH,UAAStD,KAAAhD,MAC9B,GAAI8e,IAAerX,WAA6B,EAAhBhB,EAAO1D,OACrC,OAAO0D,MAGHI,EAAKkY,SAAS/e,KAAKO,QAAQD,MAAO,IAClC0e,EAAMF,EAAWnZ,OAAOkB,GAC1BqW,EAAa,kBAAoB8B,EAAIC,UAAY,iBAErD,IAAwB,IAAAC,EAAA1B,GAAAwB,EAAIvY,QAAM0Y,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAA/B,IAAMgb,EAASD,EAAAjf,MAOlBgd,GACE,mCAPkBld,KAAKO,QAAQd,IAAIsO,QACnC,gBACA,aAEwB,IAAIiR,EAAIK,QAAO,WAAWD,EAAU3f,IAK5D,yBAJY2f,EAAUE,MAAMvR,QAAQ,SAAU,QAM9C,kHAGJ,MAAO,CAAC,CAAEpH,KADVuW,GAAc,cAITiB,GAAA/e,UAAAyI,UAAP,aACFsW,IA9EA,SAAAA,iECD8CnX,GAAAA,MAAAX,IAI5CvG,OAAAC,eAAIwf,GAAAngB,UAAA,SAAM,KAAV,WACE,OAAOY,KAAKO,QAAc,wCAG5BT,OAAAC,eAAIwf,GAAAngB,UAAA,aAAU,KAAd,WACE,OAAQY,KAAY,QAAS8H,WACxB9H,KAAY,QAAS8H,WACtB,yCAGNhI,OAAAC,eAAIwf,GAAAngB,UAAA,WAAQ,KAAZ,WACE,OAAQY,KAAY,QAASsa,0CAG/Bxa,OAAAC,eAAIwf,GAAAngB,UAAA,kBAAe,KAAnB,WACE,OAAQY,KAAY,QAASua,gBACxBva,KAAY,QAASua,gBACtBC,GAAgBJ,uCAGZmF,GAAAngB,UAAA2H,eAAV,WACE,OAAO,IAAIyY,EAAuBxf,KAAKO,UAGzCgf,GAAAngB,UAAAkH,UAAA,mBACQG,EAAS6Q,GAAAlY,UAAMkH,UAAStD,KAAAhD,MAC9B,GAAIA,KAAKO,QAAQue,aAAerX,WAA6B,EAAhBhB,EAAO1D,OAClD,OAAO0D,MAGHI,EAAKkY,SAAS/e,KAAKO,QAAQD,MAAO,IAClC0e,EAAMhf,KAAKO,QAAQue,WAAWnZ,OAAOkB,GACvCqW,EAAa,kBAAoB8B,EAAIC,UAAY,iBAErD,IAAwB,IAAAC,EAAA1B,GAAAwB,EAAIvY,QAAM0Y,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAA/B,IAAMgb,EAASD,EAAAjf,MAKlBgd,GACE,mCALald,KAAKO,QAAQd,IAAG,IAAIuf,EAAIK,QAAO,WAC5CD,EAAU3f,IAMV,yBAJY2f,EAAUE,MAAMvR,QAAQ,SAAU,QAM9C,kHAGJ,MAAO,CAAC,CAAEpH,KADVuW,GAAc,cAITqC,GAAAngB,UAAAyI,UAAP,aACF0X,IAvDA,SAAAA,iECKyCvY,GAAAA,MAAAC,IAI7BwY,GAAArgB,UAAA2H,eAAV,WAGE,OAFA/G,KAAK0f,kBACL1f,KAAKO,QAAQ4G,OAASnH,KAAKoH,2BAA2BpH,KAAKO,SACpD+W,GAAAlY,UAAM2H,eAAc/D,KAAAhD,OAGrByf,GAAArgB,UAAAsgB,gBAAR,WACE1f,KAAK2f,GAAK,IAAIC,UAAU5f,KAAKO,QAAQd,KACrCO,KAAK2f,GAAGE,UAAY7f,KAAK8f,UAAUlB,KAAK5e,MAEpCA,KAAKO,QAAQwf,UACf/f,KAAK2f,GAAGI,QAAU/f,KAAKggB,QAAQpB,KAAK5e,OAGlCA,KAAKO,QAAQ0f,UACfjgB,KAAK2f,GAAGM,QAAUjgB,KAAKkgB,QAAQtB,KAAK5e,OAGlCA,KAAKO,QAAQ4f,SACfngB,KAAK2f,GAAGQ,OAASngB,KAAKogB,OAAOxB,KAAK5e,QAItCyf,GAAArgB,UAAA0gB,UAAA,SAAUO,OACFC,EAAetgB,KAAKO,QAAQ4G,OAAOoZ,YAAYF,EAAMrC,MAE3D,OAAQhe,KAAKO,QAAQsf,WACnB,IAAK,aAEGW,EAAkBxgB,KAAK8G,GAAG2Z,eAAeH,EAAaI,SACxDF,GACFxgB,KAAK8G,GAAG6Z,cAAcH,GAExBxgB,KAAK8G,GAAG8Z,WAAWN,GACnB,MACF,IAAK,SACHtgB,KAAK8G,GAAG+Z,OAAM,GACd7gB,KAAK8G,GAAG8Z,WAAWN,GACnB,MACF,IAAK,MACL,QACEtgB,KAAK8G,GAAG8Z,WAAWN,KAIzBb,GAAArgB,UAAA4gB,QAAA,SAAQK,KAIRZ,GAAArgB,UAAA8gB,QAAA,SAAQG,KAIRZ,GAAArgB,UAAAghB,OAAA,SAAOC,KAIAZ,GAAArgB,UAAAyI,UAAP,WACE7H,KAAK2f,GAAGmB,SAEZrB,IAhEA,SAAAA,iECFmCzY,GAAAA,MAAAX,IAIvB0a,GAAA3hB,UAAA2H,eAAV,eACMia,EAOJ,MANkC,YAA9BhhB,KAAKO,QAAQ0gB,aACfD,EAAY,IAAIE,EAAY,CAACD,aAAc5b,KAClCrF,KAAKO,QAAQ0gB,eAAiBxZ,YACvCuZ,EAAY,IAAIE,GAElBlhB,KAAKO,QAAQ4G,OAAS6Z,EACf,IAAIG,EAAmBnhB,KAAKO,UAG3BwgB,GAAA3hB,UAAAsG,WAAV,WACE,IAAK1F,KAAKO,QAAQd,IACd,OAAO2G,GAAAA,WAELN,EAAQ,MAAQ9F,KAAKO,QAAQd,IACnC,OAAOyG,EAAAA,IAAIC,QAAQL,IAGdib,GAAA3hB,UAAAyI,UAAP,aACFkZ,IAxBA,SAAAA,iECHuC/Z,GAAAA,MAAAC,IAI3Bma,GAAAhiB,UAAA2H,eAAV,WAGE,OAFA/G,KAAKO,QAAQ4G,OAASnH,KAAKoH,2BAA2BpH,KAAKO,SAC3DP,KAAKO,QAAQ8gB,OAAS/J,GAAAlY,UAAM2H,eAAc/D,KAAAhD,MACnC,IAAIshB,EAAgBthB,KAAKO,UAGxB6gB,GAAAhiB,UAAAsG,WAAV,WACE,OAAOU,GAAAA,QAGFgb,GAAAhiB,UAAAyI,UAAP,aACFuZ,IAfA,SAAAA,sDCPA,IAAaG,GAAU,cAGrBC,KAAA,EACAC,KAAA,EACAC,KAAA,EACAC,QAAA,qFCNF,IAAaC,GAAQ,QCmBrB,SAAgBC,GACdC,EACAC,EACAC,6BAOIC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,OAzBJ,IAAAnB,IAAAA,EAAA,QA6BIoB,EACEC,EAAkB,IAAIvP,OAHF,wBAG4B,KAEhDwP,EAAc,mCACdC,EAAmBD,EAAW,UAAUA,EACxCE,EAAc,IAAI1P,OAAO,IAAIyP,EAAa,IAAK,KAE/CE,EACJ,kGACIC,EAAqBD,EAAQ,sBAAsBA,EAAQ,gBAC3DE,EAAW,IAAI7P,OAAO,IAAI4P,EAAmB,MAE7CE,EACJ,gEACIC,EAAW,IAAI/P,OAAO,IAAI8P,EAAc,MAExCE,EACJ,gEACIC,EAAW,IAAIjQ,OAAO,IAAIgQ,EAAc,MAExCE,EAAU,8BACVC,EAAeD,EAAO,eAAeA,EACrCE,EAAU,IAAIpQ,OAAO,IAAImQ,EAAa,KAEtCE,EACJ,4EACIC,EAAgBD,EAAQ,gBAAgBA,EACxCE,EAAW,IAAIvQ,OAAO,IAAIsQ,EAAc,KAGxCE,EACJ,yQACIC,EAAY,IAAIzQ,OAAO,IAAIwQ,EAAW,IAAK,MAE3CE,EAAU,0BACVC,GAAeD,EAAO,UAAUA,EAChCE,GAAU,IAAI5Q,OAAO,IAAI2Q,GAAS,IAAK,KAEzCE,IAAa,EAUjB,GARA7C,EAAMA,EAAI8C,oBAAoBC,OAG1BxB,EAAgBja,KAAK0Y,IACtBI,GAAD4C,EAAAxgB,GAAAwd,EAAArX,MAAA,KAAA+H,IAAA,kCAAC,GAAU4Q,EAAA0B,EAAA,IAEX5C,EAAWJ,EAET0B,EAAYpa,KAAK8Y,GAGjBC,GAFFjD,EAAA5a,GAAA4d,EAAAxM,MAAA6N,GAAA,IAEE,GACAL,EAAAhE,EAAA,GAEAsD,EAAAtD,EAAA,GACAuD,EAAAvD,EAAA,GACAiE,EAAAjE,EAAA,GAEA4D,EAAA5D,EAAA,GAGFgE,EAAM6B,YAAY5C,GAA4B,IAAMe,EAAM,IAAMV,GAChEW,EAAM4B,YAAYtC,GAA4B,IAAMU,EAAM,IAAML,QAC3D,GAAIa,EAASva,KAAK8Y,GAGrBE,GAFFjD,EAAA7a,GAAA4d,EAAAxM,MAAAgO,GAAA,IAEE,GACArB,EAAAlD,EAAA,GACAmD,EAAAnD,EAAA,GACAoD,EAAApD,EAAA,GACAuD,EAAAvD,EAAA,GACAwD,EAAAxD,EAAA,GACAyD,EAAAzD,EAAA,GACA0D,EAAA1D,EAAA,GAGmB,MAAjBoD,GAAyC,MAAjBA,IAC1BH,EAAa,CAACM,EAAaA,EAAaN,GAAa,GACrDC,EAAa,CAACM,EAAaA,EAAaN,GAAa,GACrDC,EAAa,CAACM,EAAaA,EAAaN,GAAa,GACrDC,EAAe,CAACM,EAAeA,EAAeN,GAAe,IAG/DW,EAAM8B,GACJD,WAAW3C,GACX2C,WAAW1C,GACX0C,WAAWzC,GACXC,GAEFY,EAAM6B,GACJD,WAAWrC,GACXqC,WAAWpC,GACXoC,WAAWnC,GACXC,QAEG,GAAIgB,EAASza,KAAK8Y,GAAW,CAClCyC,IAAa,EACR5B,GAALkC,EAAA3gB,GAAA4d,EAAAxM,MAAAkO,GAAA,IAAK,GAAMV,EAAA+B,EAAA,GAAK9B,EAAA8B,EAAA,OACVC,GAAUC,OAAOpC,GAAQ,GAAK,YAAYA,EAAS,WAAWA,EACnEG,GAADkC,EAAA9gB,GAAA+gB,GAAAC,UAAA,CAAAP,WAAA7B,GAAA6B,WAAA5B,IAAA+B,GAAA,aAAA,IAAC,GAAK/B,EAAAiC,EAAA,QAKD,GAAIrB,EAAS3a,KAAK8Y,GAAW,CAClCyC,IAAa,EACR5B,GAALwC,EAAAjhB,GAAA4d,EAAAxM,MAAAoO,GAAA,IAAK,GAAMZ,EAAAqC,EAAA,GAAKpC,EAAAoC,EAAA,OACVC,GACJL,OAAOpC,GAAQ,GAAK,YAAYA,EAAS,YAAW,GAAKoC,OAAOpC,IACjEG,GAADuC,EAAAnhB,GAAA+gB,GAAAC,UAAA,CAAAP,WAAA7B,GAAA6B,WAAA5B,IAAAqC,GAAA,aAAA,IAAC,GAAKrC,EAAAsC,EAAA,QAKD,GAAIpB,EAASjb,KAAK8Y,GAGrBC,GAFFuD,EAAAphB,GAAA4d,EAAAxM,MAAA0O,GAAA,KAEE,GACAhC,EAAAsD,EAAA,GACArD,EAAAqD,EAAA,GACApD,EAAAoD,EAAA,GACAlD,EAAAkD,EAAA,GACAjD,EAAAiD,EAAA,GACAhD,EAAAgD,EAAA,GACA/C,EAAA+C,EAAA,GACA9C,EAAA8C,EAAA,GACA5C,EAAA4C,EAAA,IAGFxC,EAAM8B,GACJD,YAAY5C,GAA4B,IAAMC,GAC9C2C,WAAW1C,GACX0C,WAAWzC,GACXC,GAEFY,EAAM6B,GACJD,YAAYtC,GAA4B,IAAMC,GAC9CqC,WAAWpC,GACXoC,WAAWnC,GACXC,QAEG,GAAIqB,EAAQ9a,KAAK8Y,GAGpBC,GAFFwD,EAAArhB,GAAA4d,EAAAxM,MAAAuO,GAAA,IAEE,GACA7B,EAAAuD,EAAA,GACAnD,EAAAmD,EAAA,GACAlD,EAAAkD,EAAA,GACAjD,EAAAiD,EAAA,GACA7C,EAAA6C,EAAA,GAGFzC,EAAM8B,GACJD,YAAY5C,GAA4B,IAAMC,GAC9C2C,WAAW1C,GACX0C,WAAWzC,GACXC,GAEFY,EAAM6B,GACJD,YAAYtC,GAA4B,IAAMC,GAC9CqC,WAAWpC,GACXoC,WAAWnC,GACXC,QAEG,GAAI0B,EAAUnb,KAAK8Y,GAGtBO,GAFFmD,EAAAthB,GAAA4d,EAAAxM,MAAA4O,GAAA,KAEE,GACA5B,EAAAkD,EAAA,GACAjD,EAAAiD,EAAA,GACAhD,EAAAgD,EAAA,GAEA/C,EAAA+C,EAAA,GACAzD,EAAAyD,EAAA,GACAxD,EAAAwD,EAAA,GACAvD,EAAAuD,EAAA,GACAtD,EAAAsD,EAAA,IAEArD,EAAAqD,EAAA,IACA5C,EAAA4C,EAAA,IACA3C,EAAA2C,EAAA,IAKArD,EADGA,GACY,IAKfW,EADEb,GAAkC,EAApBA,EAAWtf,OACrBgiB,YACH5C,GAA4B,IAAMC,EAAa,IAAMC,GAGlD2C,GACJD,WAAW3C,GACX2C,WAAW1C,GACX0C,WAAWzC,GACXC,GAKFY,EADER,GAAkC,EAApBA,EAAW5f,OACrBgiB,YACHtC,GAA4B,IAAMC,EAAa,IAAMC,GAGlDqC,GACJD,WAAWrC,GACXqC,WAAWpC,GACXoC,WAAWnC,GACXC,OAGC,CAAA,IAAI6B,GAAQtb,KAAK8Y,GAYtB,MAAO,CACLD,OAAQxa,UACRoe,QAAS,GACT7C,OAAQvb,UACRwb,KAAMxb,WAfRkd,IAAa,EACVzB,GAAH4C,EAAAxhB,GAAA4d,EAAAxM,MAAA+O,IAAA,IAAG,GAAKjC,EAAAsD,EAAA,GAAY3C,EAAA2C,EAAA,GAAKhD,EAAAgD,EAAA,GAErBtD,IACFU,EAAM6B,WAAW7B,EAAM,IAAMV,IAG3BM,IACFK,EAAM4B,WAAW5B,EAAM,IAAML,IA8BjC,GAnBId,EAAK+D,UAAYpB,KAET,EAANzB,GAAiB,EAANC,IACHA,EAAND,EACFA,GAAOA,EAEPC,GAAOA,GAKDA,EAAND,IACFA,EAAM,CAACC,EAAMA,EAAMD,GAAM,KAI7BjB,EAAM,CAAIkD,OAAOjC,GAAMiC,OAAOhC,IAI3BC,IAAkB3b,WA/PA,SA+Pa2b,GACnB,IAAZnB,EAAO,IAAYA,EAAO,IAAM,KACpB,GAAZA,EAAO,IAAWA,EAAO,IAAM,GAChC,KACMZ,GAAS+B,EAAgB,QAAUA,EAAgBrB,EAGzD,IACEE,EAAS+D,GAAAA,UAAiB/D,EAAQZ,GAHvB,aAIX,MAAO9c,IACP,MAAO,CACL0d,OAAQxa,UACRoe,QAAS,cAAgBxE,GAAS,iBAClC2B,OAAQvb,UACRwb,KAAMxb,YAKZ,MAAO,CACLwa,OAAMA,EACN4D,QAAS,GACT7C,OAAQA,EAASjE,SAASiE,EAAQ,IAAMvb,UACxCwb,KAAMA,EAAOlE,SAASkE,EAAM,IAAMxb,WAWtC,SAASud,GACPiB,EACAC,EACAC,EACAC,OAIIC,EAAKJ,GAFTC,EAAUA,GAAW,GAEQ,IAD7BC,EAAUA,GAAW,GACuB,KAK5C,MAHkB,MAAdC,GAAmC,MAAdA,IACvBC,GAAMA,GAEDA,EAST,SAAgBC,GACdC,EACAC,GAEA,GAAID,IAAW9e,WAAa+e,IAAW/e,UACrC,OAAO,EAIT,OACE8e,EAAOE,OAASD,EAAOC,MACvB7L,KAAK8L,MAAMH,EAAOI,OAAO,GAHT,QAId/L,KAAK8L,MAAMF,EAAOG,OAAO,GAJX,OAKhB/L,KAAK8L,MAAMH,EAAOI,OAAO,GALT,QAMd/L,KAAK8L,MAAMF,EAAOG,OAAO,GANX,MAepB,SAAgBC,GAAYpgB,GAE1B,OADAA,EAAQoU,KAAKiM,MAAMrgB,IACP,IACHA,EAAQ,IAGjBA,EAAQoU,KAAKiM,MAAMrgB,EAAQ,MACf,IACHA,EAAQ,KAGjBA,EAAQoU,KAAKiM,MAAMrgB,EAAQ,MACZ,IASjB,SAAgBsgB,GACdtgB,EACA6U,QAAA,IAAAA,IAAAA,EAAA,IAGA,OAAO7U,GADgB,QACU6U,GAQnC,SAAgB0L,GACdvQ,EACAwQ,EACA3L,QADA,IAAA2L,IAAAA,EAAA,UACA,IAAA3L,IAAAA,EAAA,IAGA,OAAO7E,EAAayQ,GAAAA,gBAAuBD,GADpB,QAC6C3L,EAQtE,SAAgB6L,GAAY7G,OACpB8G,EAAgB9G,EAAM8G,cAC5B,OACGA,EAAcC,SACdC,EAAAA,IAAMF,EAAcG,QAAUH,EAAcI,WAC5CJ,EAAcK,SAInB,SAAgBC,GAAaC,EAAyBC,GACpD,YADoD,IAAAA,IAAAA,EAAA,GAC7C,CAACD,EAAM,GAAGE,QAAQD,GAAUD,EAAM,GAAGE,QAAQD,IAWtD,SAAgBE,GACd5F,EACA6F,OAOMC,EAAe/B,GAAAA,UAAiB/D,EAAQ,YAAa,aACrD+F,EAAkB,CACtB,CACEC,KAAM,YACNpQ,MAAO,eACP6P,MAAOK,EACPG,gBAAoBT,GAAaM,GAActe,KAAK,MAAK,YAKvD0e,EAAUC,GAAkBnG,GAC5BiD,EAAUiD,EAAU,GAAK,YAAYA,EAAY,WAAWA,EAC5DE,EAAU,OAAOF,EACjBG,EAActC,GAAAA,UAAiB/D,EAAQ,YAAaiD,GAC1D8C,EAAgBvjB,KAAK,CACnBwjB,KAAM/C,EACNrN,MAAO,MACP6P,MAAOY,EACPJ,gBAAoBG,EAAO,IAAIZ,GAAaa,GAAa7e,KAAK,YAI1D8e,EAAUC,GAAkBvG,GAClC,GAAIsG,EAAS,KACL/C,EACJ+C,EAAU,GAAK,YAAYA,EAAY,YAAW,GAAKA,GACnDE,EAAU,OAAOF,EACjBG,EAAc1C,GAAAA,UAAiB/D,EAAQ,YAAauD,GAC1DwC,EAAgBvjB,KAAK,CACnBwjB,KAAMzC,EACN3N,MAAO,MACP6P,MAAOgB,EACPR,gBAAoBO,EAAO,IAAIhB,GAAaiB,GAAajf,KAAK,QAiBlE,OAbAqe,EAAYjd,QAAO,SAAC8d,OACZC,EAAW5C,GAAAA,UAAiB/D,EAAQ,YAAa0G,EAAWV,MAC5DY,EAAkBF,EAAWV,KAAKxd,MAAM,KAAK,GACnDud,EAAgBvjB,KAAK,CACnBwjB,KAAMU,EAAWV,KACjBpQ,MAAO8Q,EAAW9Q,OAAS8Q,EAAWV,KACtCP,MAAOkB,EACPV,gBAAoBT,GAAamB,GAAUnf,KACzC,MACD,MAAMof,MAIJb,EAQT,SAAgBI,GAAkBnG,GAChC,OAAOrH,KAAKkO,MAAM7G,EAAO,GAAK,KAAO,GAQvC,SAAgBuG,GAAkBvG,OAE5BsG,EADEQ,EAAO9G,EAAO,GAgCpB,OA9BI8G,GAAQ,KAAc,GAARA,IAChBR,EAAU,GAERQ,GAAQ,KAAc,GAARA,IAChBR,EAAU,GAERQ,GAAQ,KAAc,GAARA,IAChBR,EAAU,GAERQ,GAAQ,KAAc,GAARA,IAChBR,EAAU,GAERQ,GAAQ,KAAc,GAARA,IAChBR,EAAU,GAERQ,GAAQ,KAAc,GAARA,IAChBR,EAAU,GAERQ,GAAQ,KAAc,GAARA,IAChBR,EAAU,GAERQ,GAAQ,KAAc,GAARA,IAChBR,EAAU,GAERQ,GAAQ,KAAc,GAARA,IAChBR,EAAU,GAERQ,GAAQ,KAAc,GAARA,IAChBR,EAAU,IAELA,EC9hBT,QAYEzoB,OAAAC,eAAIipB,GAAA5pB,UAAA,KAAE,KAAN,WACE,OAAOY,KAAKO,QAAQsG,IAAM7G,KAAKipB,WAAWpiB,oCAG5C/G,OAAAC,eAAIipB,GAAA5pB,UAAA,QAAK,KAAT,WACE,OAAOY,KAAKO,QAAQsX,uCAGtB/X,OAAAC,eAAIipB,GAAA5pB,UAAA,QAAK,KAAT,WACE,OAAOY,KAAKO,QAAQsR,WAGtB,SAAUA,GACR7R,KAAKO,QAAQsR,MAAQA,mCAGvB/R,OAAAC,eAAIipB,GAAA5pB,UAAA,SAAM,KAAV,WACE,OAAOY,KAAK8G,GAAGoiB,iBAGjB,SAAWC,GACTnpB,KAAK8G,GAAGsiB,UAAUD,oCAGpBrpB,OAAAC,eAAIipB,GAAA5pB,UAAA,YAAS,KAAb,WACE,OAAOY,KAAKO,QAAQ8oB,eAGtB,SAAcA,GACZrpB,KAAKO,QAAQ8oB,UAAYA,mCAG3BvpB,OAAAC,eAAIipB,GAAA5pB,UAAA,UAAO,KAAX,WACE,OAAOY,KAAK8G,GAAGqR,IAAI,gBAGrB,SAAYmR,GACVtpB,KAAK8G,GAAGyiB,WAAWD,oCAGrBxpB,OAAAC,eAAIipB,GAAA5pB,UAAA,uBAAoB,KAGxB,WACE,OAAOY,KAAKwpB,sBAAsBtpB,WAJpC,SAAyBA,GACvBF,KAAKwpB,sBAAsBplB,KAAKlE,oCASlCJ,OAAAC,eAAIipB,GAAA5pB,UAAA,gBAAa,KAIjB,WACE,OAAOY,KAAK8G,GAAG2iB,wBALjB,SAAkBvpB,GAChBF,KAAK8G,GAAG4iB,iBAAiBxpB,GAASypB,UAClC3pB,KAAK4pB,4DAMP9pB,OAAAC,eAAIipB,GAAA5pB,UAAA,gBAAa,KAIjB,WACE,OAAOY,KAAK8G,GAAG+iB,wBALjB,SAAkB3pB,GAChBF,KAAK8G,GAAGgjB,iBAAiB5pB,GAAS,GAClCF,KAAK4pB,4DAMP9pB,OAAAC,eAAIipB,GAAA5pB,UAAA,UAAO,KAIX,WACE,OAAOY,KAAK+pB,SAAS7pB,WALvB,SAAYA,GACVF,KAAK8G,GAAGkjB,WAAW9pB,GACnBF,KAAK+pB,SAAS3lB,KAAKlE,oCAOrBJ,OAAAC,eAAIipB,GAAA5pB,UAAA,YAAS,KAAb,WACE,OAAOY,KAAKqd,SAAWrd,KAAKiqB,sDAO9BnqB,OAAAC,eAAIipB,GAAA5pB,UAAA,kBAAe,KAAnB,WACE,OAAwC,IAAjCY,KAAKO,QAAQ2pB,iDA0CtBlB,GAAA5pB,UAAA+qB,OAAA,SAAOC,GACLpqB,KAAKwS,IAAM4X,EAEXpqB,KAAKqqB,sBACDD,IAAW3iB,WACbzH,KAAKsqB,qBAIDtB,GAAA5pB,UAAAkrB,kBAAR,WAAA,IAAA3f,EAAA3K,KACEA,KAAKuqB,aAAevqB,KAAKwS,IAAIgY,eAAeC,YAAY9S,UAAS,WAC/D,OAAAhN,EAAKif,8BAIDZ,GAAA5pB,UAAAirB,oBAAR,WACMrqB,KAAKuqB,eAAiB9iB,YACxBzH,KAAKuqB,aAAaG,cAClB1qB,KAAKuqB,aAAe9iB,YAIhBuhB,GAAA5pB,UAAAwqB,yBAAR,WACE,GAAI5pB,KAAKwS,MAAQ/K,UAAW,KACpB+O,EAAaxW,KAAKwS,IAAIgY,eAAeG,gBACrCC,EAAgB5qB,KAAK4qB,cACrBC,EAAgB7qB,KAAK6qB,gBAAkBpjB,UAAYkiB,SAAW3pB,KAAK6qB,cACzE7qB,KAAKiqB,qBAAqCW,GAAdpU,GAA+BA,GAAcqU,OAEzE7qB,KAAKiqB,sBAAuB,GAGlCjB,IAvEE,SAAAA,GACSzoB,EACGuqB,GADH9qB,KAAAO,QAAAA,EACGP,KAAA8qB,gBAAAA,EAjGL9qB,KAAA+qB,iBAA2B,EAC3B/qB,KAAAgrB,oBAA8B,EAqD5BhrB,KAAAwpB,sBAEL,IAAIyB,GAAAA,iBAAgB,GAyBfjrB,KAAA+pB,SAAqC,IAAIkB,GAAAA,gBAAgBxjB,WAKzDzH,KAAAkrB,WAAkCC,GAAAA,cAAc,CACvDnrB,KAAKwpB,sBACLxpB,KAAK+pB,WACJqB,KAAK5Y,GAAAA,IAAG,SAAE6Y,GAA8B,OAAAA,EAAM,IAAMA,EAAM,MAU3DrrB,KAAKipB,WAAa1oB,EAAQ8gB,OAE1BrhB,KAAK8G,GAAK9G,KAAKsrB,gBACX/qB,EAAQ4oB,SAAW1hB,YACrBzH,KAAKmpB,OAAS5oB,EAAQ4oB,QAGpB5oB,EAAQ8oB,WAAa9oB,EAAQ8c,UAAY5V,YAC3ClH,EAAQ8c,SAAU,GAGpBrd,KAAK6qB,cAAgBtqB,EAAQsqB,eAAiB/D,GAAuB3B,OAAO5kB,EAAQgrB,gBACpFvrB,KAAK4qB,cAAgBrqB,EAAQqqB,eAAiB9D,GAAuB3B,OAAO5kB,EAAQirB,gBAEpFxrB,KAAKqd,QAAU9c,EAAQ8c,UAAY5V,WAAmBlH,EAAQ8c,QAC9Drd,KAAKspB,QAAU/oB,EAAQ+oB,UAAY7hB,UAAY,EAAIlH,EAAQ+oB,QAGzD/oB,EAAQkrB,gBACPlrB,EAAQkrB,cAAchsB,KAAOc,EAAQkrB,cAAc9kB,QAEpD3G,KAAKyG,OAASzG,KAAKipB,WAAWviB,UAAUnG,EAAQkrB,gBAGlDzrB,KAAK+qB,iBAAkBxqB,EAAQkrB,iBAC3BlrB,EAAQkrB,cAAcC,WACpBnrB,EAAQkrB,cAAcC,WAI5B1rB,KAAK8G,GAAG6kB,IAAI,SAAU3rB,MAAM,cChH9B4rB,MAAQ,QACRC,SAAW,WACXC,OAAS,cCtCuB9kB,GAAAA,MAAA+kB,GAAAA,SAatBC,GAAA5sB,UAAA6sB,MAAV,WAAA,IAAAthB,EAAA3K,KACEA,KAAKqhB,OAAO6K,GAAG,iBAAgB,SAAE3nB,GAAK,OAAAoG,EAAKwhB,gBAAgB5nB,KAC3DvE,KAAKqhB,OAAO6K,GAAG,eAAc,SAAE3nB,GAAK,OAAAoG,EAAKyhB,cAAc7nB,KACvDvE,KAAKqhB,OAAO6K,GAAG,iBAAgB,SAAE3nB,GAAK,OAAAoG,EAAKyhB,cAAc7nB,MAGjDynB,GAAA5sB,UAAAitB,QAAV,WAAA,IAAA1hB,EAAA3K,KACEA,KAAKqhB,OAAOiL,GAAG,iBAAgB,SAAE/nB,GAAK,OAAAoG,EAAKwhB,gBAAgB5nB,KAC3DvE,KAAKqhB,OAAOiL,GAAG,eAAc,SAAE/nB,GAAK,OAAAoG,EAAKyhB,cAAc7nB,KACvDvE,KAAKqhB,OAAOiL,GAAG,iBAAgB,SAAE/nB,GAAK,OAAAoG,EAAKyhB,cAAc7nB,MAGnDynB,GAAA5sB,UAAA+sB,gBAAR,SAAwB9L,GACjBA,EAAMkM,MAAMC,eACfnM,EAAMkM,MAAMC,aAAe,IAE7BnM,EAAMkM,MAAMC,aAAa/nB,KAAKzE,KAAK6G,IAEnC7G,KAAKysB,SAAW,EAChBzsB,KAAKuQ,OAASmc,GAAAA,cAAcC,SAGtBX,GAAA5sB,UAAAgtB,cAAR,SAAsB/L,GACpB,GAAKA,EAAMkM,MAAMC,aAAjB,KAIMI,EAAevM,EAAMkM,MAAMC,aAAaxb,QAAQhR,KAAK6G,IAC3D,KAAI+lB,EAAe,GAAnB,CAIAvM,EAAMkM,MAAMC,aAAaK,OAAOD,EAAc,GAE9C5sB,KAAK8sB,QAAU,MAETL,EAAUzsB,KAAKysB,QACjBzsB,KAAK8sB,QAAUL,GACbA,IAAYzsB,KAAKysB,UACnBzsB,KAAKuQ,OAASmc,GAAAA,cAAcK,KAC5B/sB,KAAK8sB,OAAS9sB,KAAKysB,QAAU,MAIrCT,IAlDE,SAAAA,GAAY1rB,GAAZ,IAAAqK,EACE2M,GAAAtU,KAAAhD,OAAOA,YANC2K,EAAAmiB,OAAS,EACTniB,EAAA8hB,QAAU,EAMlB9hB,EAAK0W,OAAS/gB,EAAMC,QAAQ8gB,OAAOva,GACnC6D,EAAK9D,GAAKT,GAAAA,oBCTmBY,GAAAA,MAAA+kB,GAAAA,SAarBiB,GAAA5tB,UAAA6sB,MAAV,WAAA,IAAAthB,EAAA3K,KACEA,KAAKqhB,OAAO6K,GAAG,gBAAe,SAAE3nB,GAAK,OAAAoG,EAAKwhB,gBAAgB5nB,KAC1DvE,KAAKqhB,OAAO6K,GAAG,cAAa,SAAE3nB,GAAK,OAAAoG,EAAKyhB,cAAc7nB,KACtDvE,KAAKqhB,OAAO6K,GAAG,gBAAe,SAAE3nB,GAAK,OAAAoG,EAAKyhB,cAAc7nB,MAGhDyoB,GAAA5tB,UAAAitB,QAAV,WAAA,IAAA1hB,EAAA3K,KACEA,KAAKqhB,OAAOiL,GAAG,gBAAe,SAAE/nB,GAAK,OAAAoG,EAAKwhB,gBAAgB5nB,KAC1DvE,KAAKqhB,OAAOiL,GAAG,cAAa,SAAE/nB,GAAK,OAAAoG,EAAKyhB,cAAc7nB,KACtDvE,KAAKqhB,OAAOiL,GAAG,gBAAe,SAAE/nB,GAAK,OAAAoG,EAAKyhB,cAAc7nB,MAGlDyoB,GAAA5tB,UAAA+sB,gBAAR,SAAwB9L,GAIjBA,EAAM4M,KAAKT,eACdnM,EAAM4M,KAAKT,aAAe,IAE5BnM,EAAM4M,KAAKT,aAAa/nB,KAAKzE,KAAK6G,IAElC7G,KAAKysB,SAAW,EAChBzsB,KAAKuQ,OAASmc,GAAAA,cAAcC,SAGtBK,GAAA5tB,UAAAgtB,cAAR,SAAsB/L,GACpB,GAAKA,EAAM4M,KAAKT,aAAhB,KAIMI,EAAevM,EAAM4M,KAAKT,aAAaxb,QAAQhR,KAAK6G,IAC1D,KAAI+lB,EAAe,GAAnB,CAIAvM,EAAM4M,KAAKT,aAAaK,OAAOD,EAAc,GAE7C5sB,KAAK8sB,QAAU,MAETL,EAAUzsB,KAAKysB,QACjBzsB,KAAK8sB,QAAUL,GACbA,IAAYzsB,KAAKysB,UACnBzsB,KAAKuQ,OAASmc,GAAAA,cAAcK,KAC5B/sB,KAAK8sB,OAAS9sB,KAAKysB,QAAU,MAIrCO,IArDE,SAAAA,GAAY1sB,GAAZ,IAAAqK,EACE2M,GAAAtU,KAAAhD,OAAOA,YAND2K,EAAAmiB,OAAS,EACTniB,EAAA8hB,QAAU,EAMhB9hB,EAAK0W,OAAS/gB,EAAMC,QAAQ8gB,OAAOva,GACnC6D,EAAK9D,GAAKT,GAAAA,SCTd,SAAgB8mB,GAAiBvnB,EAAiBa,eAC1C2mB,EAAU,GAEVC,EADYC,SAASC,cAAc,UACZC,WAAW,MACxCH,EAAWI,KAAO,mBAEdC,EAAY,MAChB,IAAoB,IAAAC,EAAAlQ,GAAA7X,GAAMgoB,EAAAD,EAAAtpB,QAAAupB,EAAAtpB,KAAAspB,EAAAD,EAAAtpB,OAAE,CAAvB,IAAM9D,EAAKqtB,EAAAztB,MACd,IAAsB,IAAlBI,EAAM+c,QAAV,KAEMuQ,EAAattB,EAAM2oB,WAAW3iB,UAAUmB,UAAWjB,IAAU,cACxDqnB,GACT,GAAIA,EAAUpuB,MAAQgI,+BAEhBoK,EAAQvR,EAAMuR,MAEdic,EAAc,IAAIC,MACxBD,EAAY9Q,YAAc,YAC1B8Q,EAAYE,IAAMH,EAAUpuB,IAC5BquB,EAAYG,OAAM,WAChBb,EAAWc,SAASrc,EAAO,EAAG4b,GAC9BL,EAAWe,UAAUL,EAAa,EAAGL,EAAY,IACjDA,GAAaK,EAAYM,OAAS,GAGpCjB,EAAQ1oB,KAAK,CACXoN,MAAKA,EACLpS,IAAKouB,EAAUpuB,IACf8sB,MAAOuB,SAjBX,IAAwB,IAAAO,EAAA7Q,GAAAoQ,GAAUU,EAAAD,EAAAjqB,QAAAkqB,EAAAjqB,KAAAiqB,EAAAD,EAAAjqB,OAAA,GAAdkqB,EAAApuB,mNAsBtB,OAAOitB,aCnC0BnmB,GAAAA,MAAA+kB,GAAAA,SAavBwC,GAAAnvB,UAAA6sB,MAAV,aAGUsC,GAAAnvB,UAAAitB,QAAV,WACErsB,KAAKM,MAAMuH,aAEf0mB,IAZE,SAAAA,GAAYjuB,GAAZ,IAAAqK,EACE2M,GAAAtU,KAAAhD,OAAOA,YAND2K,EAAAmiB,OAAS,EACTniB,EAAA8hB,QAAU,EAMhB9hB,EAAKrK,MAAQA,EACbqK,EAAK9D,GAAKT,GAAAA,oBCFkBY,GAAAA,MAAAgiB,IAgBpBwF,GAAApvB,UAAAksB,cAAV,WAAA,IAAA3gB,EAAA3K,KACQyuB,EAAY3uB,OAAO2C,OAAO,GAAIzC,KAAKO,QAAS,CAChD8gB,OAAQrhB,KAAKO,QAAQ8gB,OAAS,KAG1BkL,EAAQ,IAAImC,EAAaD,GAO/B,OANIzuB,KAAK8qB,iBACNyB,EAAMoC,YAAoBC,qBAAoB,SAAE3B,EAAMe,GACrDrjB,EAAKkkB,aAAa5B,EAAMe,KAIrBzB,GAGFiC,GAAApvB,UAAA+qB,OAAP,SAAc3X,GACRA,IAAQ/K,UACVzH,KAAK8uB,QAAQpE,cAEb1qB,KAAK8uB,QAAQnX,UAAS,cAExBL,GAAAlY,UAAM+qB,OAAMnnB,KAAAhD,KAACwS,IAGPgc,GAAApvB,UAAAyvB,aAAR,SAAqB5B,EAAMe,OACnBe,EAAM,IAAIC,eAIhB,GAHAD,EAAI1vB,KAAK,MAAO2uB,IAEIhuB,KAAK8qB,gBAAgBmE,aAAaF,EAAKf,GAIzD,OAFAe,EAAIG,aACJjC,EAAKkC,WAAWnB,IAAMA,GAIxBe,EAAI3W,aAAe,cAEnB2W,EAAId,OAAM,eACFmB,EAAkB,IAAIC,WAAW,KAAcC,UAC/CC,EAAO,IAAIC,KAAK,CAACJ,GAAkB,CAAE3pB,KAAM,cAE3CgqB,EADajwB,OAAOkwB,IACEC,gBAAgBJ,GAC5CtC,EAAKkC,WAAWnB,IAAMyB,GAExBV,EAAIa,QAERpB,IAvDE,SAAAA,GACEjuB,EACOuqB,GAFT,IAAAngB,EAIE2M,GAAAtU,KAAAhD,KAAMO,EAASuqB,IAAgB9qB,YAFxB2K,EAAAmgB,gBAAAA,EAGPngB,EAAKmkB,QAAU,IAAI9C,GAAarhB,GAChCA,EAAKklB,QAAUllB,EAAKmkB,QAAQe,qBCXD7oB,GAAAA,MAAAgiB,IAmBnB8G,GAAA1wB,UAAAksB,cAAV,eACQmD,EAAY3uB,OAAO2C,OAAO,GAAIzC,KAAKO,QAAS,CAChD8gB,OAAQrhB,KAAKO,QAAQ8gB,OAAS,KAGhC,OAAO,IAAI0O,EAAYtB,IAGlBqB,GAAA1wB,UAAA+qB,OAAP,SAAc3X,GACRA,IAAQ/K,UACVzH,KAAK8uB,QAAQpE,cAEb1qB,KAAK8uB,QAAQnX,UAAS,cAExBL,GAAAlY,UAAM+qB,OAAMnnB,KAAAhD,KAACwS,IAEjBsd,IAvBE,SAAAA,GAAYvvB,GAAZ,IAAAoK,EACE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YAEd2K,EAAKmkB,QAAU,IAAI9B,GAAYriB,GAC/BA,EAAKklB,QAAUllB,EAAKmkB,QAAQe,qBCdC7oB,GAAAA,MAAAgiB,IAY/BlpB,OAAAC,eAAIiwB,GAAA5wB,UAAA,YAAS,KAAb,WACE,OAAkC,IAA3BY,KAAKO,QAAQ0vB,2CAGtBnwB,OAAAC,eAAIiwB,GAAA5wB,UAAA,aAAU,KAAd,WACE,OAAmC,IAA5BY,KAAKO,QAAQ2vB,4CASZF,GAAA5wB,UAAAksB,cAAV,eACQmD,EAAY3uB,OAAO2C,OAAO,GAAIzC,KAAKO,QAAS,CAChD8gB,OAAQrhB,KAAKO,QAAQ8gB,OAAS,KAgBhC,OAbIrhB,KAAKO,QAAQ4vB,WACfnwB,KAAKipB,WAAWniB,GAAGolB,GACjB,aACA,SAAS3nB,GACPvE,KAAKowB,MAAM7rB,EAAEc,UACbuZ,KAAK5e,OAIPA,KAAKO,QAAQ8vB,cACfrwB,KAAKswB,mBAAmBtwB,KAAKO,QAAQ8vB,cAGhC,IAAIE,GAAc9B,IAGjBuB,GAAA5wB,UAAAgxB,MAAV,SAAgB/qB,OACRmrB,GAAQ,IAAIC,MAAOC,UACnBC,EAAc3wB,KAAKwS,IAAI1L,GAAGolB,GAAG,cAEnC,SAAS0E,EAAQvQ,OACTwQ,EAAgBxQ,EAAMwQ,cACtBC,EAAazQ,EAAMyQ,WACnBC,EAAY1rB,EAAQ2rB,cAAcC,QAClCC,EAAUJ,EAAWrS,KAAO+R,EAC5BW,EAAeD,EAAUlxB,KAAKO,QAAQ4vB,UAAUiB,SAChD9H,EAAU+H,EAAAA,QAAQ,EAAIF,GACtBG,EAAWC,EAAAA,QAAavxB,KAAKO,QAAQ4vB,UAAUtS,OAAS,OAC9DyT,EAAS,GAAKhI,MACV/iB,EAAQvG,KAAK8G,GACd0qB,mBACAxuB,KAAKhD,KAAMqF,GACXyJ,KAAI,SAAC2iB,GACJ,OAAOA,EAAOtC,aAKZuC,GAFJnrB,EADGA,GACKvG,KAAK8G,GAAG0qB,mBAAmBxuB,KAAKhD,KAAMqF,GAAS,IAEhC4rB,QAEzB,OAAQ5rB,EAAQ2rB,cAAcW,WAC5B,IAAK,YACG3O,EACJqO,EAAAA,QAAQF,IAAqD,EAApCO,EAAWvC,WAAWyC,aACjDF,EAAWvC,WAAW0C,UAAU7O,GAChC0O,EAAWvC,WAAW5F,WAAWD,GACjC,MACF,IAAK,aAECoI,EAAWvC,aACbuC,EACGvC,WACA2C,YACAC,SAAST,GACZI,EACGvC,WACA2C,YACAE,SACCX,EAAAA,QAAQF,IAKJ,EAJDO,EACEvC,WACA2C,YACAG,cAIPP,EAAWI,cACbJ,EAAWI,YAAYC,SAAST,GAChCI,EACGI,YACAE,SACCX,EAAAA,QAAQF,IAAqD,EAApCO,EAAWI,YAAYG,cAGtD,MACF,IAAK,UAECP,EAAWvC,YACbuC,EACGvC,WACA+C,UACAH,SAAST,GAEVI,EAAWQ,WACbR,EAAWQ,UAAUH,SAAST,GASpC,GAJAI,EAAWS,QAAQ,IACnBtB,EAAcuB,SAASV,GACvBb,EAAcwB,aAAatB,GAEvBG,EAAUlxB,KAAKO,QAAQ4vB,UAAUiB,SAKnC,OAJAkB,GAAAA,QAAQ3B,QAGR3wB,KAAKwS,IAAI1L,GAAGyrB,SAIdvyB,KAAKwS,IAAI1L,GAAGyrB,UAnF4C3T,KAAK5e,QAuF1DgwB,GAAA5wB,UAAA+qB,OAAP,SAAc3X,GACRA,IAAQ/K,UACVzH,KAAK8uB,QAAQpE,cAEb1qB,KAAK8uB,QAAQnX,UAAS,cAExBL,GAAAlY,UAAM+qB,OAAMnnB,KAAAhD,KAACwS,IAGRwd,GAAA5wB,UAAAyI,UAAP,WACE7H,KAAKipB,WAAWphB,YAChB7H,KAAKwyB,iBAGAxC,GAAA5wB,UAAAozB,cAAP,WACExyB,KAAKipB,WAAWniB,GAAGwlB,GACjB,aACA,SAAS/nB,GACHvE,KAAKqd,SACPrd,KAAKowB,MAAM7rB,EAAEc,UAEfuZ,KAAK5e,QAIJgwB,GAAA5wB,UAAAkxB,mBAAP,SAA0BzpB,GACxB7G,KAAKyyB,uBAAyBzyB,KAAKipB,WAAWniB,GAAGolB,GAC/C,aACAlsB,KAAKqwB,aAAazR,KAAK5e,KAAM6G,KAG1BmpB,GAAA5wB,UAAAszB,mBAAP,SAA0B7rB,OAClB8rB,EAAO3yB,KAAKipB,WAAWniB,GAAG2Z,eAAe5Z,GAC3C8rB,GACF3yB,KAAKwS,IAAI1L,GAAG8rB,UAAUC,UAAUF,EAAK3B,cAAc8B,mBAIhD9C,GAAA5wB,UAAAixB,aAAP,SAAoBxpB,EAAI8rB,GAClBA,EAAKttB,QAAQqb,UAAY7Z,GAAM7G,KAAKqd,SACtCrd,KAAK0yB,mBAAmB7rB,IAIrBmpB,GAAA5wB,UAAA2zB,oBAAP,SAA2BlsB,GACzByrB,GAAAA,QAAQtyB,KAAKyyB,yBAEjBzC,IAnKE,SAAAA,GAAYzvB,GAAZ,IAAAoK,EACE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YACd2K,EAAKmkB,QAAU,IAAIP,GAAc5jB,GACjCA,EAAKklB,QAAUllB,EAAKmkB,QAAQe,qBC/BK7oB,GAAAA,MAAAgiB,IAazBgK,GAAA5zB,UAAAksB,cAAV,eACQmD,EAAY3uB,OAAO2C,OAAO,GAAIzC,KAAKO,QAAS,CAChD8gB,OAAQrhB,KAAKO,QAAQ8gB,OAAS,KAGhC,OAAO,IAAI4R,EAAkBxE,IAEjCuE,IAbE,SAAAA,GAAYzyB,GAAZ,IAAAoK,EACE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YACd2K,EAAKmkB,QAAU,IAAI9B,GAAYriB,GAC/BA,EAAKklB,QAAUllB,EAAKmkB,QAAQe,UCnBhC,IAAAqD,IA0BEpzB,OAAAC,eACImzB,GAAA9zB,UAAA,OAAI,KADR,WAC6B,OAAOY,KAAKmzB,WACzC,SAASjzB,GACPF,KAAKmzB,MAAQjzB,EACTF,KAAKwS,MAAQ/K,WACfzH,KAAKwS,IAAI4gB,WAAWlzB,oCASxBgzB,GAAA9zB,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKszB,SAAWtzB,KAAKwS,IAAIqd,QAAQlY,UAAS,SAACpH,GACzC,OAAA5F,EAAK4oB,mBAAmBhjB,MAI5B2iB,GAAA9zB,UAAAo0B,gBAAA,WACExzB,KAAKwS,IAAIihB,UAAUzzB,KAAK6G,KAG1BqsB,GAAA9zB,UAAAs0B,YAAA,WACE1zB,KAAKwS,IAAIihB,UAAUhsB,WACnBzH,KAAK2zB,gBAAgBC,WAAW5zB,KAAK6zB,YACrC7zB,KAAKszB,SAAS5I,eAGRwI,GAAA9zB,UAAAm0B,mBAAR,SAA2BhjB,GACrBA,IAAWmc,GAAAA,cAAcC,SAAW3sB,KAAK6zB,aAAepsB,UAC1DzH,KAAK6zB,WAAa7zB,KAAK2zB,gBAAgBG,WAC9BvjB,IAAWmc,GAAAA,cAAcK,MAAQ/sB,KAAK6zB,aAAepsB,YAC9DzH,KAAK2zB,gBAAgBC,WAAW5zB,KAAK6zB,YACrC7zB,KAAK6zB,WAAapsB,iCA/CvBjH,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,kBACVC,SAAA,+yDANOqzB,GAAAA,iDAcNjzB,GAAAA,oBAEAA,GAAAA,SAsCHoyB,IA1BE,SAAAA,GAAoBS,GAAA3zB,KAAA2zB,gBAAAA,EAFb3zB,KAAA6G,GAAK,mBAAkB,IAAI4pB,MAAOC,kBCnCvClP,KAAA,EACAC,KAAA,EACAC,KAAA,EACAsS,mBAAA,2GCJJ,IAAAC,IAkBEA,GAAA70B,UAAA80B,YAAA,SAAYvb,EAAqBwb,QAAA,IAAAA,IAAAA,EAAwBC,GAAc5S,MACrExhB,KAAKq0B,UAAUjwB,KAAK,CAACuU,EAAUwb,KAGjCF,GAAA70B,UAAAyhB,MAAA,WACE7gB,KAAKq0B,UAAUjwB,KAAK,CAAC,GAAIgwB,GAAc5S,6BAhB1C9hB,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,6JAQZ,SAAAq0B,KALOj0B,KAAAq0B,UAAY,IAAIpJ,GAAAA,gBAA4C,CACjE,GACAxjB,YCbJ,IAAA6sB,IAqBEx0B,OAAAC,eAAIu0B,GAAAl1B,UAAA,MAAG,KAAP,WACE,OAAOY,KAAKu0B,UAAU/hB,qCAQxB8hB,GAAAl1B,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKw0B,WAAax0B,KAAKy0B,eAAeJ,UAAU1c,UAAS,SAAC+c,GACxD,OAAA/pB,EAAKgqB,eAAeD,EAAI,GAAIA,EAAI,OAIpCJ,GAAAl1B,UAAAs0B,YAAA,WACE1zB,KAAKw0B,WAAW9J,eAGV4J,GAAAl1B,UAAAu1B,eAAR,SAAuBhc,EAAqBwb,0BA1B7CS,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,6DAPHyyB,GAAmB/vB,WAAA,CAAA,CAAAsC,KAkBvBovB,GAAAA,cAfIZ,MA8BTK,IAhBE,SAAAA,GACkBC,EACRE,GADQz0B,KAAAu0B,UAAAA,EACRv0B,KAAAy0B,eAAAA,EARFz0B,KAAAmH,OAAS,IAAI2tB,GCTvB,SAAgBC,SACRC,EAAoB,IAAI/tB,GAC9B,OAAO,IAAI+oB,GAAY,CACrBne,MAAO,UACPsX,OAAQ,IACR9H,OAAQ2T,EACRzuB,MASJ,SAAS0uB,QAIH1uB,EAHE2uB,EAAeC,KACfC,EAAcC,KAIpB,OAAA,SAAQC,GACN,GAA0B,kBAAtBA,EAAU5U,QAEZ,OADAna,EAkKN,SAASgvB,EACPC,EACAC,EACAC,EACAC,QAHA,IAAAH,IAAAA,EAAA,CAAgD,EAAG,IAAK,IAAK,SAC7D,IAAAC,IAAAA,EAAA,QACA,IAAAC,IAAAA,EAAA,CAA8C,EAAG,IAAK,IAAK,UAGrDE,EAAS,IAAIC,GAAAA,OAAe,CAChCC,MAAOL,EACP5X,MAAO2X,IAGHO,EAAO,IAAIF,GAAAA,OAAe,CAC9BhY,MAAO6X,IAGT,OAAO,IAAIM,GAAAA,MAAc,CACvBJ,OAAMA,EACNG,KAAIA,EACJxJ,MAAO,IAAI0J,GAAAA,OAAe,CACxBjT,OAAQ,EACR4S,OAAMA,EACNG,KAAIA,IAENG,KAAM,IAAIC,GAAAA,KAAa,CACrB3I,KAAM,0BACN0I,KAAMP,EACNI,KAAM,IAAIK,GAAAA,KAAa,CAAEvY,MAAO,SAChC+X,OAAQ,IAAIC,GAAAA,OAAe,CAAEhY,MAAO,OAAQiY,MAAO,IACnDO,UAAU,MA9LFd,CAAkBD,EAAUnd,IAAI,gBAAiB,EAAGmd,EAAUnd,IAAI,cAAemd,EAAUnd,IAAI,mBAGjGme,EAAchB,EAAUnd,IAAI,UAClC,GAAIme,EAEF,OADqB,IAAIC,IACLC,YAAYF,OAE5BG,EAAenB,EAAUtE,cAAcW,UAG7C,OAFAprB,EAAyB,UAAjBkwB,EAA2BrB,EAAcF,GAC3CwB,UAAUvE,QAAQmD,EAAUnd,IAAI,cAC/B5R,GA5BF0uB,KAqCX,SAAgBE,GACdrQ,OAAA5F,OAAA,IAAA4F,EAAA,GAAAA,EAACoR,EAAAhX,EAAAgX,KAAMS,EAAAzX,EAAAyX,YAAaxX,EAAAD,EAAAuW,YAAAA,OAAA,IAAAtW,EAAA,EAAAA,EAAiByX,EAAA1X,EAAA0X,cAAe3R,EAAA/F,EAAArB,MAAAA,OAAAA,IAAAA,EAAAA,CAAAA,EAAAA,IAAAA,IAAAA,IAAAA,EAA4BgZ,EAAA3X,EAAA2X,YAG1EC,EAAkBjZ,EAAMkZ,MAAM,GAC9BC,EAAoBnZ,EAAMkZ,MAAM,GACtCC,EAAkB,GAAK,EACnBL,IACFG,EAAgB,GAAKH,GAEnBC,IACFI,EAAkB,GAAKJ,GAErBC,IACFG,EAAkB,GAAKH,EAAY,GACnCG,EAAkB,GAAKH,EAAY,GACnCG,EAAkB,GAAKH,EAAY,QAG/BjB,EAAS,IAAIC,GAAAA,OAAe,CAChCC,MAAOL,EACP5X,MAAOmZ,IAGHjB,EAAO,IAAIK,GAAAA,KAAa,CAC5BvY,MAAOiZ,IAGT,OAAO,IAAId,GAAAA,MAAc,CACvBJ,OAAMA,EACNG,KAAIA,EACJxJ,MAAO,IAAI0J,GAAAA,OAAe,CACxBjT,OAAQ,EACR4S,OAAMA,EACNG,KAAIA,IAENG,KAAM,IAAIC,GAAAA,KAAa,CACrBD,KAAIA,EACJ1I,KAAM,0BACNuI,KAAM,IAAIK,GAAAA,KAAa,CAAEvY,MAAO,SAChC+X,OAAQ,IAAIC,GAAAA,OAAe,CAAEhY,MAAO,OAAQiY,MAAO,IACnDO,UAAU,MAShB,SAAgBhB,GACdvQ,OAGImS,EACAC,EACAC,EACAC,EANJlY,OAAA,IAAA4F,EAAA,GAAAA,EAACoR,EAAAhX,EAAAgX,KAAM/W,EAAAD,EAAAoK,QAAAA,OAAA,IAAAnK,EAAA,EAAAA,EAAa8F,EAAA/F,EAAArB,MAAAA,OAAAA,IAAAA,EAAAA,OAAAA,EAAgBwZ,EAAAnY,EAAAmY,aAQ9BC,EAAO,2BAA2BluB,KAAK5J,OAAO+3B,UAAUC,WAE9D,OAAQ3Z,GACN,IAAK,OACHqZ,EAAe,mBACfD,EAAYpZ,EACZ,MACF,IAAK,MACHqZ,EAAe,mBACfD,EAAYpZ,EACZ,MACF,IAAK,SACHqZ,EAAe,mBACfD,EAAYpZ,EACZ,MACF,IAAK,QACHqZ,EAAe,iBACfD,EAAYpZ,EACZ,MACF,QACEqZ,EAAe,mBACfD,EAAY,OAIhB,GAAII,EAAc,CAIhB,OAHIA,aAAwBp1B,QAC1Bk1B,EAAkB,OAASE,EAAa,GAAK,IAAMA,EAAa,GAAK,IAAMA,EAAa,GAAK,KAEvFA,GACN,IAAK,OACHF,EAAkB,iBAClB,MACF,IAAK,MACHA,EAAkB,iBAClB,MACF,IAAK,SACHA,EAAkB,iBAClB,MACF,IAAK,QACHA,EAAkB,eAGtBC,EAAM,+GACgBF,EAAe,YAAcC,EAAkB,8tIAIvE,OAAKG,EAiBI,IAAItB,GAAAA,MAAc,CACvBzJ,MAAO,IAAIkL,GAAAA,KAAa,CACtBzJ,IAAK,iCAAmCiJ,EAAY,YACpD3N,QAAOA,EACPoO,QAAS,CAAC,GAAI,IACdC,OAAQ,CAAC,GAAK,OAEhBzB,KAAM,IAAIC,GAAAA,KAAa,CACrBD,KAAIA,EACJ1I,KAAM,0BACNuI,KAAM,IAAIK,GAAAA,KAAa,CAAEvY,MAAO,SAChC+X,OAAQ,IAAIC,GAAAA,OAAe,CAAEhY,MAAO,OAAQiY,MAAO,IACnDO,UAAU,MA5BP,IAAIL,GAAAA,MAAc,CACvBzJ,MAAO,IAAIkL,GAAAA,KAAa,CACtBzJ,IAAKoJ,EAAM,2BAA6BA,EAAM,iCAAmCH,EAAY,YAC7F3N,QAAOA,EACPoO,QAAS,CAAC,GAAI,IACdC,OAAQ,CAAC,GAAK,OAEhBzB,KAAM,IAAIC,GAAAA,KAAa,CACrBD,KAAIA,EACJ1I,KAAM,0BACNuI,KAAM,IAAIK,GAAAA,KAAa,CAAEvY,MAAO,SAChC+X,OAAQ,IAAIC,GAAAA,OAAe,CAAEhY,MAAO,OAAQiY,MAAO,IACnDO,UAAU,cC9JhBE,GAAAn3B,UAAAo3B,YAAA,SAAYj2B,GACV,OAAKA,EAGkB,mBAAZA,GAA0BA,aAAmBy1B,GAAAA,MAC/Cz1B,EAEFP,KAAK43B,WAAW,QAASr3B,GALvB80B,MAQHkB,GAAAn3B,UAAAw4B,WAAR,SAAmBv0B,EAAanD,GAAhC,IAAAyK,EAAA3K,KACQ63B,EAAe,GACfC,EAAQ93B,KAAK+3B,SAAS10B,GAE5B,OAAIy0B,GAAS53B,aAAiBJ,QAC5BA,OAAOk4B,KAAK93B,GAAO2K,QAAO,SAACotB,OACnBC,EAAQvtB,EAAKwtB,SAASF,GAC5BJ,EAAaK,GAASvtB,EAAKitB,WAAWK,EAAM/3B,EAAM+3B,MAE7C,IAAIH,EAAMD,IAEV33B,GAIHq2B,GAAAn3B,UAAA+4B,SAAR,SAAiB90B,OACX60B,EACJ,OAAQ70B,EAAI6L,eACV,IAAK,SACL,IAAK,eACL,IAAK,OACHgpB,EAAQ,QAMZ,OAAOA,GAAS70B,GAGVkzB,GAAAn3B,UAAA24B,SAAR,SAAiB10B,OACXy0B,EAAQM,GAAQ/0B,EAAI0C,OAAO,GAAGsyB,cAAgBh1B,EAAI0zB,MAAM,IAW5D,MAVY,iBAAR1zB,IACFy0B,EAAQQ,GAAAA,cAEE,mBAARj1B,IACFy0B,EAAQ1B,GAAAA,MAEE,qBAAR/yB,IACFy0B,EAAQjC,GAAAA,QAGHiC,GAGTvB,GAAAn3B,UAAAm5B,uBAAA,SAAuBlzB,EAASmzB,OAExB/yB,EAAO+yB,EAAiB/yB,KACxBgzB,EAAYD,EAAiBC,UAC7Bza,EAAOwa,EAAiBxa,KACxB4X,EAAS4C,EAAiB5C,OAC1BE,EAAQ0C,EAAiB1C,MACzBC,EAAOyC,EAAiBzC,KACxB/S,EAASwV,EAAiBxV,OAC1B0V,EAAOF,EAAiBE,KACxBlyB,EAAQgyB,EAAiBhyB,MACzB4V,EAAO4B,EAAKjb,OACZuc,EAAQkZ,EAAiBlZ,MAAMmZ,WAAaD,EAAiBlZ,MAC7DqZ,EACJ34B,KAAK43B,WAAW,OAAQY,EAAiBlZ,MAAM/Y,QAC/C,IAAI4vB,GAAAA,KACNwC,EAAWxG,QAAQnyB,KAAK44B,SAASvzB,EAASia,QACpCuZ,EAAYL,EAAiBK,UACnC,GAAa,WAATpzB,EAAmB,CACrB,IAAK,IAAI7C,EAAI,EAAGA,EAAIwZ,EAAMxZ,IAKxB,IAJMk2B,OAC8B,IAA3BzzB,EAAQ8S,IAAIsgB,GACfpzB,EAAQ8S,IAAIsgB,GACZ,MACMza,EAAKpb,IAAMk2B,EAAIC,WAAWrjB,MAAMsI,EAAKpb,IAC/C,OAAI81B,EACM,CACN,IAAI1C,GAAAA,MAAc,CAChBzJ,MAAO,IAAIkL,GAAAA,KAAa,CACtBzJ,IAAK0K,EAAK91B,GACV4D,MAAOA,EAAQA,EAAM5D,GAAK,OAM1B,CACN,IAAIozB,GAAAA,MAAc,CAChBzJ,MAAO,IAAI0J,GAAAA,OAAe,CACxBjT,OAAQA,EAASA,EAAOpgB,GAAK,EAC7BgzB,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAO+X,EAASA,EAAOhzB,GAAK,QAC5BkzB,MAAOA,EAAQA,EAAMlzB,GAAK,IAE5BmzB,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAOkY,EAAOA,EAAKnzB,GAAK,YAG5BszB,KAAMyC,KAMd,IAAKtzB,EAAQ2zB,WAcX,MAbQ,CACN,IAAIhD,GAAAA,MAAc,CAChBzJ,MAAO,IAAI0J,GAAAA,OAAe,CACxBjT,OAAQ,EACR4S,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAO,UAETkY,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAO,sBAOZ,GAAa,YAATpY,EAAoB,CAC7B,IAAS7C,EAAI,EAAGA,EAAIwZ,EAAMxZ,IAAK,KACvBk2B,EAIN,IAJMA,OAC8B,IAA3BzzB,EAAQ8S,IAAIsgB,GACfpzB,EAAQ8S,IAAIsgB,GACZ,MACMza,EAAKpb,IAAMk2B,EAAIC,WAAWrjB,MAAMsI,EAAKpb,IAa/C,MAZQ,CACN,IAAIozB,GAAAA,MAAc,CAChBJ,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAO+X,EAASA,EAAOhzB,GAAK,QAC5BkzB,MAAOA,EAAQA,EAAMlzB,GAAK,IAE5BmzB,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAOkY,EAAOA,EAAKnzB,GAAK,0BAE1BszB,KAAMyC,KAMd,GAAItzB,aAAmB4zB,KAChB5zB,EAAQ2zB,WACX,OAAIH,EACM74B,KAAKw2B,YAAYqC,GAGnB,CACN,IAAI7C,GAAAA,MAAc,CAChBJ,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAO,UAETkY,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAO,iBAUrB0Y,GAAAn3B,UAAA85B,mBAAA,SAAmB7zB,EAAS8zB,EAAiCC,WACvD7yB,OADsB,IAAA4yB,IAAAA,EAAA,QAEpB/c,EAAO/W,EAAQ8S,IAAI,YAAYpV,OACrC,GAAa,IAATqZ,EAAY,CACd,GAAI+c,EAAaE,kBACf,IAAgB,IAAAna,EAAA1B,GAAA2b,EAAaE,eAAala,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAAvC,IAAMZ,EAAC2b,EAAAjf,MACV,KACIsD,EAAE81B,WAAa91B,EAAE81B,WAAald,MAC9B5Y,EAAE+1B,WAAa/1B,EAAE+1B,WAAand,GAChC,CAGA,GAFA7V,EAAQvG,KAAKw2B,YAAYhzB,EAAE+C,OAEvB/C,EAAEg2B,UAAW,KACTtD,EAAO,IAAIC,GAAAA,KAAa,CAC5BD,KAAM9Z,EAAK2c,WACXhD,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAO,WAGXtX,EAAM4rB,QAAQ+D,GAGhB,GAAI1yB,EAAEi2B,cAAe,KACfC,OAAa,EACXC,EAAYpzB,EAAMqzB,OAAOhI,aAC/B8H,EAAgB,EAAI9e,KAAK1J,IAAIkL,IACTud,IAClBD,EAAgBC,GAElBpzB,EAAMqzB,OAAO/H,UAAU6H,GAEzB,4GAKDnzB,IACCmzB,OAAa,EACbP,EAAaU,WACfH,EAAgBP,EAAaU,WAAWzd,IAElCud,EAAY,GAClBD,EAAgB,EAAI9e,KAAK1J,IAAIkL,IACTud,IAClBD,EAAgBC,IAIpBpzB,EAAQ,CACN,IAAIyvB,GAAAA,MAAc,CAChBzJ,MAAO,IAAI0J,GAAAA,OAAe,CACxBjT,OAAQ0W,EACRpQ,QAAS,GACTsM,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAO,UAETkY,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAO,6BAGXqY,KAAM,IAAIC,GAAAA,KAAa,CACrBD,KAAM9Z,EAAK2c,WACXhD,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAO,oBAOjBtX,EAAQvG,KAAKw2B,YAAY4C,GAE3B,OAAO7yB,GAGTgwB,GAAAn3B,UAAAw5B,SAAA,SAASvzB,EAASy0B,OACZxa,EAAQwa,EACNC,EAAa93B,MAAM+3B,KAAKF,EAAWG,SAAS,sBAWlD,OATAF,EAAWlvB,QAAO,SAAC4O,GACjB6F,EAAQA,EAAMvR,QAAQ0L,EAAE,GAAIpU,EAAQ8S,IAAIsB,EAAE,OAIlB,IAAtBsgB,EAAWh3B,QAAgBuc,IAAUwa,IACvCxa,EAAQja,EAAQ8S,IAAI2hB,IAAeA,GAG9Bxa,wBAvQV5f,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,sHADd,SAAA22B,MCCA,SAAgB2D,GAAiB55B,GAE/B,OAAwC,IADrBA,EAAgB,WACjBC,QAAQ45B,UAQ5B,SAAgBC,GAAmBC,OAC3B/5B,EAAQ+5B,EAAQliB,IAAI,UAC1B,OAAO7X,IAAUmH,WAAoByyB,GAAiB55B,GCtBxD,IAAAg6B,IA4BEx6B,OAAAC,eACIu6B,GAAAl7B,UAAA,cAAW,KADf,WAEE,OAAOY,KAAKu6B,kBAEd,SAAgBr6B,GACVA,GAASF,KAAKM,OAASJ,EAAM2G,KAAO7G,KAAKM,MAAMuG,KAAO7G,KAAKw6B,eAC7Dx6B,KAAKy6B,WAAWr2B,MAAK,GACrBpE,KAAK06B,SAASC,SAAS36B,KAAK46B,MAAMC,cAAe76B,KAAK86B,aAEtD96B,KAAK06B,SAASK,YAAY/6B,KAAK46B,MAAMC,cAAe76B,KAAK86B,6CAiB7Dh7B,OAAAC,eACIu6B,GAAAl7B,UAAA,YAAS,KADb,WAEE,OAAOY,KAAKg7B,gBAEd,SAAc96B,IAEE,KADdF,KAAKg7B,WAAa96B,KAEhBF,KAAKi7B,YAAa,oCAWtBn7B,OAAAC,eACIu6B,GAAAl7B,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKC,YAEd,SAAUC,GACRF,KAAKC,OAASC,EACdF,KAAKk7B,QAAQ92B,KAAKlE,oCAoBpBJ,OAAAC,eAAIu6B,GAAAl7B,UAAA,YAAS,KAAb,WACE,OAAwC,IAAjCY,KAAKM,MAAMC,QAAQ46B,2CAG5Br7B,OAAAC,eAAIu6B,GAAAl7B,UAAA,UAAO,KAAX,WACE,OAA4B,IAArBY,KAAKM,MAAMgpB,aAEpB,SAAYA,GACVtpB,KAAKM,MAAMgpB,QAAUA,EAAU,qCAcjCgR,GAAAl7B,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KAEIA,KAAKM,MAAM+c,SACXrd,KAAKo7B,wBAC6B,IAAlCp7B,KAAKM,MAAM0qB,qBAEXhrB,KAAKM,MAAM0qB,oBAAqB,EAChChrB,KAAKM,MAAMyqB,iBAAkB,GAE/B/qB,KAAKq7B,aAAar7B,KAAKM,MAAMyqB,iBAC7B/qB,KAAKs7B,uBAEC7Q,EAAczqB,KAAKM,MAAMkS,IAAIgY,eAAeC,YAClDzqB,KAAKuqB,aAAeE,EAAY9S,UAAS,WACvChN,EAAK4wB,uBAEPv7B,KAAKw7B,YAAcx7B,KAAKy7B,iBAExBz7B,KAAK07B,eAAeC,eAAehkB,UAAS,SAAEikB,GAC5CjxB,EAAKixB,MAAQA,EACbjxB,EAAK4wB,uBAGPv7B,KAAKk7B,QAAQvjB,UAAS,WAChBhN,EAAKrK,OAASqK,EAAKrK,MAAMC,QAAQ2P,SACnCvF,EAAK8vB,WAAWr2B,MAAK,GACrBuG,EAAK+vB,SAASC,SAAShwB,EAAKiwB,MAAMC,cAAelwB,EAAKmwB,gBAK5DR,GAAAl7B,UAAAs0B,YAAA,WACE1zB,KAAKuqB,aAAaG,eAGpB4P,GAAAl7B,UAAAi8B,aAAA,SAAa3P,GACX1rB,KAAKM,MAAMyqB,gBAAkBW,EAC7B1rB,KAAK67B,YAAYz3B,MAAMsnB,IAGzB4O,GAAAl7B,UAAA08B,oBAAA,WACE97B,KAAKq7B,aAAar7B,KAAK67B,YAAY37B,QAGrCo6B,GAAAl7B,UAAA28B,iBAAA,WACE/7B,KAAKM,MAAM+c,SAAWrd,KAAKM,MAAM+c,QAC7Brd,KAAKg8B,gCACPh8B,KAAKq7B,cAAcr7B,KAAKM,MAAM+c,SAEhCrd,KAAKs7B,oBAGPhB,GAAAl7B,UAAAq8B,eAAA,eACQne,EAAetd,KAAKM,MAAMC,QAChC,IAAK+c,EAAa2e,QAChB,OAAOj8B,KAAKM,MAAMuR,UAEdqqB,EAAe5e,EAAa2e,QAC5BE,EAAgB,EAAuC78B,SAC7D,OAAQge,EAAa2e,QAAQx2B,MAC3B,KAAK22B,GAAYxQ,MACf,OAAO5rB,KAAKM,MAAMuR,MACpB,KAAKuqB,GAAYvQ,SACf,OAAIsQ,GAAiBA,EAAcE,YAC1BF,EAAcE,YAEdr8B,KAAKM,MAAMuR,MAEtB,KAAKuqB,GAAYtQ,OACf,OAAIoQ,GAAgBA,EAAahG,KACxBgG,EAAahG,KAEbl2B,KAAKM,MAAMuR,MAEtB,QACE,OAAO7R,KAAKM,MAAMuR,QAIhByoB,GAAAl7B,UAAAm8B,mBAAR,eACQe,EAAoBt8B,KAAKM,MAAM2pB,sBAEb,IAAtBqS,IACwC,IAAxCt8B,KAAKu8B,gCAELv8B,KAAKq7B,cAAa,GAEpBr7B,KAAKw8B,mBAAmBp4B,KAAKk4B,IAGvBhC,GAAAl7B,UAAAk8B,iBAAR,eACQmB,GACgB,IAApBz8B,KAAK08B,aACkB,IAAvB18B,KAAKM,MAAM+c,UACV6c,GAAiBl6B,KAAKM,OACzBN,KAAK28B,kBAAkBv4B,KAAKq4B,IAG9BnC,GAAAl7B,UAAAw9B,gBAAA,WACE58B,KAAKy6B,WAAWr2B,MAAMpE,KAAKy6B,WAAWoC,aACH,IAA/B78B,KAAKy6B,WAAWoC,WAClB78B,KAAK06B,SAASC,SAAS36B,KAAK46B,MAAMC,cAAe76B,KAAK86B,YAEtD96B,KAAK06B,SAASK,YAAY/6B,KAAK46B,MAAMC,cAAe76B,KAAK86B,YAE3D96B,KAAKm0B,OAAO2I,KAAK98B,KAAKM,QAGjBg6B,GAAAl7B,UAAA29B,MAAP,WACE/8B,KAAKi7B,YAAcj7B,KAAKi7B,WACxBj7B,KAAKg9B,SAASF,KAAK,CAACx8B,MAAON,KAAKM,MAAOy8B,MAAO/8B,KAAKi7B,mCApNtDz6B,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,iBACVC,SAAA,y5EAEAC,gBAAiBC,GAAAA,wBAAwBC,gdANlCo8B,GAAAA,sBARPC,GAAAA,iBACAC,GAAAA,oDAmBCr8B,GAAAA,yBA0BAA,GAAAA,0BAYAA,GAAAA,qBAMAA,GAAAA,8CAUAA,GAAAA,qCAEAA,GAAAA,8CAEAA,GAAAA,yBAEAA,GAAAA,6BAEAA,GAAAA,6BAEAA,GAAAA,0BAEAA,GAAAA,6BAEAA,GAAAA,sBAaAs8B,GAAAA,yBACAA,GAAAA,UA0HH9C,IArHE,SAAAA,GACUoB,EACAhB,EACAE,GAFA56B,KAAA07B,eAAAA,EACA17B,KAAA06B,SAAAA,EACA16B,KAAA46B,MAAAA,EA5FH56B,KAAA86B,WAAa,yBAgBpB96B,KAAAy6B,WAAuC,IAAIxP,GAAAA,iBAAgB,GAE3DjrB,KAAA67B,YAAwC,IAAI5Q,GAAAA,iBAAgB,GAE5DjrB,KAAAw8B,mBAA+C,IAAIvR,GAAAA,iBAAgB,GAEnEjrB,KAAA28B,kBAA8C,IAAI1R,GAAAA,iBAAgB,GAgB1DjrB,KAAAg7B,YAAa,EAMrBh7B,KAAAk7B,QAAkC,IAAIjQ,GAAAA,gBAAuBxjB,WAYpDzH,KAAAg8B,gCAA0C,EAE1Ch8B,KAAAo7B,uBAAiC,EAEjCp7B,KAAAu8B,gCAA0C,EAE1Cv8B,KAAAq9B,WAAqB,EAErBr9B,KAAAs9B,eAAyB,EAEzBt9B,KAAAu9B,eAAyB,EAEzBv9B,KAAA08B,YAAsB,EAerB18B,KAAAm0B,OAA8B,IAAIqJ,GAAAA,aAAoB/1B,WACtDzH,KAAAg9B,SAAW,IAAIQ,GAAAA,aC9G3B,IAAAC,IAmEEA,GAAAr+B,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACM09B,EAAc19B,KAAKM,MAAMmG,OAC7BzG,KAAK29B,OAAS39B,KAAK49B,iBACb12B,EAAgBlH,KAAKM,MAAMC,QAAQ8gB,OAAc,QAiBvD,GAfEna,GACAA,EAActB,QACdsB,EAActB,OAAOi4B,OAErB79B,KAAKob,aAAepb,KAAK29B,OAAO7uB,KAAI,SAACvI,GAAS,OAAAA,EAAMyI,OAAS9H,EAActB,OAAOi4B,SAAQ7uB,KAChFhP,KAAKM,MAAMmG,OAKZzG,KAAK29B,QAA+B,EAArB39B,KAAK29B,OAAO56B,SACpC/C,KAAKob,aAAesiB,EAAY,GAAGtiB,cAJ/Bpb,KAAK29B,QAA+B,EAArB39B,KAAK29B,OAAO56B,SAC7B/C,KAAKob,aAAepb,KAAK29B,OAAO,GAAG3uB,MAMvC0uB,EAAc19B,KAAKM,MAAM2oB,WAAW3iB,UAAUtG,KAAKob,aAAcpb,KAAKwG,QAC1B,IAAxCxG,KAAKu8B,+BAAyC,KAC1C9R,EAAczqB,KAAKM,MAAMkS,IAAIgY,eAAeC,YAClDzqB,KAAKuqB,aAAeE,EAAY9S,UAAS,SAAEnB,GAAuB,OAAA7L,EAAK4wB,mBAAmB/kB,UAC1D,IAAvBknB,EAAY36B,QACrB/C,KAAK89B,aAAa15B,KAAKs5B,IAO3BD,GAAAr+B,UAAAs0B,YAAA,WACM1zB,KAAKuqB,eAAiB9iB,WACxBzH,KAAKuqB,aAAaG,eAItB+S,GAAAr+B,UAAA2+B,iBAAA,SAAiBrS,EAAoBsS,GACnCA,EAAKtS,UAAYA,GAGX+R,GAAAr+B,UAAA6+B,0BAAR,SAAkCC,GAGhC,QAFMC,EAAuBD,EACvBE,EAAcp+B,KAAKM,MAAMmG,OACtB7D,EAAI,EAAGA,EAAIw7B,EAAYr7B,OAAQH,IACtCu7B,EAAWv7B,GAAG8oB,UAAY0S,EAAYx7B,GAAG8oB,UAE3C,OAAOyS,GAGTV,GAAAr+B,UAAAi/B,iBAAA,SAAiBC,OACThhB,EAAetd,KAAKM,MAAM2oB,WAAkB,QAClD,GAA0B,QAAtB3L,EAAa7X,KACf,OAAO84B,GAAAA,GAAGD,EAAYzsB,WAGlBlM,EAAS2X,EAAa1X,OAAOC,OAAO4E,MAAM,KAC1C+zB,EAAoBn1B,KAAKo1B,MAAMp1B,KAAKC,UAAUgU,IAEpD,OADAkhB,EAAkB54B,OAAOC,OAASF,EAAOmJ,KAAI,SAACxO,GAAS,OAAAA,IAAUg+B,EAAYzsB,QACtE7R,KAAK0+B,oBACTC,cAAcH,GACdpT,KAAK5Y,GAAAA,IAAG,SAACosB,GACR,OAAOA,EAAqBC,wBAAwBhtB,UASlD4rB,GAAAr+B,UAAAm8B,mBAAR,SAA2B/kB,GACzBxW,KAAKwG,MAAQxG,KAAKM,MAAMkS,IAAIgY,eAAesU,WAC3C9+B,KAAK++B,gBAMCtB,GAAAr+B,UAAA2/B,aAAR,eACMC,EAAch/B,KAAKM,MAAM2oB,WAAW3iB,UAAUtG,KAAKob,aAAcpb,KAAKwG,OACtExG,KAAKM,MAAMmG,QAAqC,EAA3BzG,KAAKM,MAAMmG,OAAO1D,SAAci8B,EAAch/B,KAAKi+B,0BAA0Be,IAG3E,KAF3Bh/B,KAAKM,MAAMmG,OAASu4B,GAEJj8B,QAAmD,IAAnC/C,KAAK89B,aAAa59B,MAAM6C,QAGxD/C,KAAK89B,aAAa15B,KAAK46B,IAGjBvB,GAAAr+B,UAAAw+B,WAAR,eACQtgB,EAAetd,KAAKM,MAAMC,QAChC,GAAI+c,GAAgBA,EAAamO,cAAe,KAGxCwT,EAAmB,CAAA,CAAGjwB,KAAM,GAAI6C,MAFpB7R,KAAKk/B,gBAAgBC,UACfC,QAAQ,kCAE7Bx6B,OAAO0Y,EAAamO,cAAcwT,gBAAgBj1B,OAAM,SAACq1B,GAAM,MACA,YAA9DA,EAAGrwB,KAAKswB,UAAU,OAAOvxB,QAAQ,oBAAqB,KACQ,WAA9DsxB,EAAGrwB,KAAKswB,UAAU,OAAOvxB,QAAQ,oBAAqB,OAE1D,OADAkxB,EAAgBzsB,IAAG,SAAC7P,GAAK,OAAAA,EAAEkP,MAAQlP,EAAEkP,MAAM9L,OAAO,GAAGsyB,cAAgB11B,EAAEkP,MAAMklB,MAAM,GAAGhpB,QAAQ,KAAM,OAC7FkxB,IAKXxB,GAAAr+B,UAAAmgC,cAAA,WAAA,IAAA50B,EAAA3K,KACEA,KAAK++B,mBACDlB,EAAS,GACb79B,KAAKM,MAAM2oB,WAAWniB,GAAG04B,YAAY35B,OAAO4E,MAAM,KAAK+H,IAAG,SAAClS,GACzD,OAAAu9B,GAAUlzB,EAAKyQ,aAAe,MAEhCyiB,EAASA,EAAO9G,MAAM,GAAI,GAC1B/2B,KAAKM,MAAM2oB,WAAWniB,GAAG4T,aAAa,CAACmjB,OAAMA,KAG/CJ,GAAAr+B,UAAAqgC,YAAA,SAAY54B,OACN64B,EAEFA,EADkC,IAAhC1/B,KAAK2/B,gBAAgB58B,OACb/C,KAAK2/B,gBAAgBC,MAAmB,cAExC5/B,KAAK2/B,gBAAgB7wB,KAAI,SAAC+wB,GAAkB,OAAAA,EAAehF,cAAch0B,KAAOA,IAAiB,cAE7G7G,KAAK8/B,aAAaj5B,GAAM64B,EAAQtR,6BAnLnC5tB,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,mBACVC,SAAA,4nEAEAC,gBAAiBC,GAAAA,wBAAwBC,iqBARlCk/B,UAEAC,GAAAA,4EAUNl/B,GAAAA,+BA8BAm/B,GAAAA,aAAYtgC,KAAA,CAAC,iCAUbmB,GAAAA,SAqIH28B,IAnIE,SAAAA,GACUiB,EACAQ,GADAl/B,KAAA0+B,oBAAAA,EACA1+B,KAAAk/B,gBAAAA,EA5CDl/B,KAAAu8B,gCAA0C,EAKnDv8B,KAAA89B,aAA0C,IAAI7S,GAAAA,gBAAgB,IAoBtDjrB,KAAAwG,MAAgBiB,UAUjBzH,KAAA8/B,aAA6C,GCrDtD,IAAAI,IAmCEA,GAAA9gC,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKM,MAAMyqB,iBAAkB,MAEvBN,EAAczqB,KAAKM,MAAMkS,IAAIgY,eAAeC,YAClDzqB,KAAKuqB,aAAeE,EAAY9S,UAAS,WACvChN,EAAK4wB,uBAEPv7B,KAAKw7B,YAAcx7B,KAAKy7B,iBAExBz7B,KAAK07B,eAAeC,eAAehkB,UAAS,SAAEikB,GAC5CjxB,EAAKixB,MAAQA,EACbjxB,EAAK4wB,wBAIT2E,GAAA9gC,UAAAs0B,YAAA,WACE1zB,KAAKuqB,aAAaG,eAGpBwV,GAAA9gC,UAAAq8B,eAAA,eACQne,EAAetd,KAAKM,MAAMC,QAChC,IAAK+c,EAAa2e,QAChB,OAAOj8B,KAAKM,MAAMuR,UAEdqqB,EAAe5e,EAAa2e,QAC5BE,EAAgB,EAAuC78B,SAC7D,OAAQge,EAAa2e,QAAQx2B,MAC3B,KAAK22B,GAAYxQ,MACf,OAAO5rB,KAAKM,MAAMuR,MACpB,KAAKuqB,GAAYvQ,SACf,OAAIsQ,GAAiBA,EAAcE,YAC1BF,EAAcE,YAEdr8B,KAAKM,MAAMuR,MAEtB,KAAKuqB,GAAYtQ,OACf,OAAIoQ,GAAgBA,EAAahG,KACxBgG,EAAahG,KAEbl2B,KAAKM,MAAMuR,MAEtB,QACE,OAAO7R,KAAKM,MAAMuR,QAIhBquB,GAAA9gC,UAAAm8B,mBAAR,eACQe,EAAoBt8B,KAAKM,MAAM2pB,qBACrCjqB,KAAKw8B,mBAAmBp4B,KAAKk4B,yBAtEhC97B,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,wBACVC,SAAA,6YAEAC,gBAAiBC,GAAAA,wBAAwBC,wgBANlCo8B,GAAAA,kDAkBNn8B,GAAAA,8CAEAA,GAAAA,SAsDHo/B,IApDE,SAAAA,GAAoBxE,GAAA17B,KAAA07B,eAAAA,EAZpB17B,KAAAw8B,mBAA+C,IAAIvR,GAAAA,iBAAgB,GAU1DjrB,KAAAu8B,gCAA0C,EC/BrD,IAAA4D,IAqBErgC,OAAAC,eACIogC,GAAA/gC,UAAA,SAAM,KAIV,WACE,OAAOY,KAAKogC,aANd,SACWlgC,GACTF,KAAKogC,QAAUlgC,EACfF,KAAKoE,wCAiBP+7B,GAAA/gC,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKqgC,SAAWrgC,KAAKsgC,QAClBlV,KAAKmV,GAAAA,SAAQ,WACZ,OAA8B,IAAvB51B,EAAKhF,OAAO5C,OAAey9B,GAAAA,MAAQC,GAAAA,MAAM,OAEjD9oB,UAAS,eACFhS,EAASgF,EAAK+1B,mBAAmB/1B,EAAKhF,OAAOoxB,MAAM,IACzDpsB,EAAKuwB,QAAQ92B,KAAKuB,GAClBgF,EAAKg2B,2BAA2Bv8B,KAGyD,EAFvFuG,EAAKhF,OAAOoxB,MAAM,GACf/sB,OAAM,SAAC1J,GAAS,OAAoB,IAApBA,EAAM+oB,YACtBrf,OAAM,SAAC1J,GAAS,OAAAA,EAAMypB,SAAS7pB,OAASI,EAAMkpB,sBAAsBtpB,QAAO6C,QAEhF4H,EAAKi2B,+BAA+Bx8B,KAGsD,EAFxFuG,EAAKhF,OAAOoxB,MAAM,GACf/sB,OAAM,SAAC1J,GAAS,OAAoB,IAApBA,EAAM+oB,YACtBrf,OAAM,SAAC1J,GAAS,OAAAA,EAAMypB,SAAS7pB,QAAUI,EAAMkpB,sBAAsBtpB,QAAO6C,QAGjF4H,EAAKk2B,YAAYz8B,KACfuG,EAAKhF,OAAOoxB,MAAM,GAAG/sB,OAAM,SAAC1J,GAAS,SAA0B,IAA1BA,EAAM4pB,iBAA+Bvf,EAAKm2B,mBAAsBxgC,EAAM+oB,iBAKnH8W,GAAA/gC,UAAAs0B,YAAA,WACE1zB,KAAKqgC,SAAS3V,eAERyV,GAAA/gC,UAAAgF,KAAR,WACEpE,KAAKsgC,QAAQl8B,QAEP+7B,GAAA/gC,UAAAshC,mBAAR,SAA2B/6B,OACrBo7B,EAAcp7B,EAAOqE,OAAM,SAAE1J,GAAiB,OAAAA,EAAM+c,SAAW/c,EAAM2pB,uBAIzE,OAHIjqB,KAAKghC,sBACPD,EAAcp7B,GAET3F,KAAKihC,mBAAmBF,IAEzBZ,GAAA/gC,UAAA6hC,mBAAR,SAA2Bt7B,GACzB,OAAOA,EAAOu7B,KAAI,SAAEC,EAAQC,GAAW,OAAAA,EAAOjY,OAASgY,EAAOhY,UAGhEgX,GAAA/gC,UAAAiiC,qBAAA,SAAqBC,GACjBthC,KAAKghC,oBAAsBM,EAC3BthC,KAAKoE,OACLpE,KAAKuhC,gBAAgBzE,KAAKwE,yBAjF/B9gC,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,wBACVC,SAAA,y+DAEAC,gBAAiBC,GAAAA,wBAAwBC,2RAYxCC,GAAAA,iCASAA,GAAAA,8CAEAA,GAAAA,mCAEAA,GAAAA,mCAEAA,GAAAA,+BAEAs8B,GAAAA,UAkDH+C,IAhDE,SAAAA,KA5BAngC,KAAAq9B,WAAY,EAEZr9B,KAAA2gC,2BAAuD,IAAI1V,GAAAA,iBAAgB,GAC3EjrB,KAAA4gC,+BAA2D,IAAI3V,GAAAA,iBAAgB,GAC/EjrB,KAAA6gC,YAAwC,IAAI5V,GAAAA,gBAAgB,IAC5DjrB,KAAAk7B,QAAoC,IAAIjQ,GAAAA,gBAAgB,IACxDjrB,KAAAwhC,eAA0B,EACnBxhC,KAAAsgC,QAAU,IAAImB,GAAAA,cAAoB,GAWhCzhC,KAAA8gC,mBAA6B,EAE7B9gC,KAAAu8B,gCAA0C,EAE1Cv8B,KAAA0hC,qBAA+B,EAE/B1hC,KAAAghC,qBAA+B,EAE9BhhC,KAAAuhC,gBAAkB,IAAI/D,GAAAA,cAAsB,WCrCtDmE,OAAS,SACTC,MAAQ,QACRC,UAAU,WC6BZC,IAgCEhiC,OAAAC,eACI+hC,GAAA1iC,UAAA,MAAG,KADP,WAEE,OAAOY,KAAK+hC,UAEd,SAAQ7hC,GACNF,KAAK+hC,KAAO7hC,mCAIdJ,OAAAC,eACI+hC,GAAA1iC,UAAA,SAAM,KAIV,WACE,OAAOY,KAAKogC,aANd,SACWlgC,GACTF,KAAKogC,QAAUlgC,EACfF,KAAKoE,wCAOPtE,OAAAC,eAAI+hC,GAAA1iC,UAAA,cAAW,KAIf,WACE,OAAOY,KAAKu6B,kBALd,SAAgBr6B,GACdF,KAAKu6B,aAAer6B,EACpBF,KAAKgiC,aAAa59B,KAAKlE,oCAuBzBJ,OAAAC,eAAI+hC,GAAA1iC,UAAA,UAAO,KAAX,WACE,OAAOY,KAAKiiC,cAEd,SAAY/hC,GACVF,KAAKiiC,SAAW/hC,EAChBF,KAAKoE,wCAIPtE,OAAAC,eAAI+hC,GAAA1iC,UAAA,cAAW,KAAf,WACE,OAAOY,KAAKkiC,kBAEd,SAAgBhiC,GACdF,KAAKkiC,aAAehiC,EACpBF,KAAKoE,wCAIPtE,OAAAC,eAAI+hC,GAAA1iC,UAAA,YAAS,KAAb,WACE,OAAOY,KAAKmiC,kBAEd,SAAcjiC,GACZF,KAAKmiC,aAAejiC,EACpBF,KAAKoE,wCAIPtE,OAAAC,eAAI+hC,GAAA1iC,UAAA,UAAO,KAAX,WACE,OAAOwb,KAAKiM,MAA6C,IAAvC7mB,KAAKgiC,aAAanF,WAAWvT,cAEjD,SAAYA,GACVtpB,KAAKgiC,aAAanF,WAAWvT,QAAUA,EAAU,qCAGnDxpB,OAAAC,eAAI+hC,GAAA1iC,UAAA,eAAY,KAAhB,WACE,GAAqB,MAAjBY,KAAKspB,QAGT,OAAOtpB,KAAKspB,yCAGdxpB,OAAAC,eAAI+hC,GAAA1iC,UAAA,gBAAa,KAAjB,WACE,QAAKY,KAAKq9B,YAAar9B,KAAKoiC,YAAY/Y,WAAarpB,KAAKqiC,gBAAgBx7B,KAAO7G,KAAKoiC,YAAYv7B,KAC9F7G,KAAKsiC,iBAAiBtiC,KAAKoiC,+CAMjCtiC,OAAAC,eAAI+hC,GAAA1iC,UAAA,gBAAa,KAAjB,WACE,QAAKY,KAAKq9B,YAAar9B,KAAKoiC,YAAY/Y,WAAarpB,KAAKuiC,gBAAgB17B,KAAO7G,KAAKoiC,YAAYv7B,KAC9F7G,KAAKwiC,iBAAiBxiC,KAAKoiC,+CAMjCtiC,OAAAC,eAAI+hC,GAAA1iC,UAAA,yBAAsB,KAA1B,WACE,OAAkC,IAA9BY,KAAKyiC,cAAc1/B,SAAiB/C,KAAKq9B,YAAcr9B,KAAK0iC,eAAe1iC,KAAKyiC,iBAA0C,IAAxBziC,KAAK2iC,gDAM7G7iC,OAAAC,eAAI+hC,GAAA1iC,UAAA,yBAAsB,KAA1B,WACE,OAAkC,IAA9BY,KAAKyiC,cAAc1/B,SAAiB/C,KAAKq9B,YAAcr9B,KAAK4iC,gBAAgB5iC,KAAKyiC,iBAA0C,IAAxBziC,KAAK2iC,gDAM9G7iC,OAAAC,eAAI+hC,GAAA1iC,UAAA,eAAY,KAAhB,WACE,OAAqC,IAA9BY,KAAK6iC,4BAEd,SAAiBvZ,eACf,IAAoB,IAAApK,EAAA1B,GAAAxd,KAAKyiC,eAAatjB,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAtB+a,EAAAjf,MACRopB,QAAUA,EAAU,0IAkB9BwY,GAAA1iC,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKqgC,SAAWrgC,KAAKsgC,QAClBlV,KACCmV,GAAAA,SAAQ,WACN,OAA8B,IAAvB51B,EAAKhF,OAAO5C,OAAey9B,GAAAA,MAAQC,GAAAA,MAAM,OAGnD9oB,UAAS,WACRhN,EAAKm4B,aAAa1+B,KAAKuG,EAAKo4B,sBAC5Bp4B,EAAKuwB,QAAQ92B,KAAKuG,EAAKq4B,cAAcr4B,EAAKhF,OAAOoxB,MAAM,KACvDpsB,EAAKs4B,qBAAqBnG,KAAK,CAC7BoG,QAASv4B,EAAKu4B,QACdC,UAAWx4B,EAAKw4B,UAChBC,YAAaz4B,EAAKy4B,gBAIxBpjC,KAAKqjC,iBAAmBrjC,KAAKsjC,gBAAgB3rB,UAAS,SAAEzX,GACtDyK,EAAKg4B,eAAiBziC,IAGxBF,KAAKk7B,QAAQvjB,UAAS,mBACpB,GAAIhN,EAAKhF,OAAQ,KACX49B,EAAS,MACb,IAAoB,IAAArkB,EAAA1B,GAAA7S,EAAKhF,QAAMwZ,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAA5B,IAAM9D,EAAK6e,EAAAjf,MACVI,EAAMC,QAAQ2P,SAChBvF,EAAKy3B,YAAc9hC,EACnBqK,EAAK64B,WAAY,GAEfljC,EAAMC,QAAQw8B,QAChBwG,GAAU,wGAGV54B,EAAKm2B,kBACPn2B,EAAKg4B,eAAiBY,IAAW54B,EAAKhF,OAAOqE,OAAM,SAACy5B,GAAO,OAAkB,IAAlBA,EAAIpa,WAAsBoa,EAAIvZ,kBAAiBnnB,OAE1G4H,EAAKg4B,eAAiBY,IAAW54B,EAAKhF,OAAOqE,OAAM,SAACy5B,GAAO,OAAAA,EAAIvZ,kBAAiBnnB,WAMxF++B,GAAA1iC,UAAAs0B,YAAA,WACE1zB,KAAKqgC,SAAS3V,eAGhBoX,GAAA1iC,UAAAskC,aAAA,WACE1jC,KAAKkjC,QAAUz7B,WAGjBq6B,GAAA1iC,UAAAmjC,cAAA,WACE,OAAOviC,KAAK2F,OACTqE,OAAM,SAAC25B,GAAK,OAACA,EAAEta,YACfua,OAAM,SACJC,EAAMC,GACL,OAAOD,EAAK1a,OAAS2a,EAAQ3a,OAAS0a,EAAOC,GAE/C,CAAE3a,OAAQ1hB,UAAWZ,GAAIY,aAI/Bq6B,GAAA1iC,UAAAojC,iBAAA,SAAiBliC,OACTyQ,EAAQ/Q,KAAK2F,OAAOo+B,UAAS,SAACN,GAAO,OAAAnjC,EAAMuG,KAAO48B,EAAI58B,KAC5D,SAAI7G,KAAK2F,SAAU3F,KAAK2F,OAAOoL,EAAQ,KAA2C,IAArC/Q,KAAK2F,OAAOoL,EAAQ,GAAGsY,YAMtEyY,GAAA1iC,UAAAijC,cAAA,WACE,OAAOriC,KAAK2F,OACTqE,OAAM,SAAC25B,GAAK,OAACA,EAAEta,YACfua,OAAM,SACJC,EAAMC,GACL,OAAOD,EAAK1a,OAAS2a,EAAQ3a,OAAS0a,EAAOC,GAE/C,CAAE3a,OAAQ1hB,UAAWZ,GAAIY,aAI/Bq6B,GAAA1iC,UAAAkjC,iBAAA,SAAiBhiC,OACTyQ,EAAQ/Q,KAAK2F,OAAOo+B,UAAS,SAACN,GAAO,OAAAnjC,EAAMuG,KAAO48B,EAAI58B,KAC5D,SAAI7G,KAAK2F,SAAU3F,KAAK2F,OAAOoL,EAAQ,KAA2C,IAArC/Q,KAAK2F,OAAOoL,EAAQ,GAAGsY,YAStEyY,GAAA1iC,UAAAsjC,eAAA,SAAe/8B,WACT2pB,GAAW,EACX0U,EAAO,aACA1jC,OACH2jC,EAAWC,EAAKv+B,OAAOo+B,UAAS,SAACN,GAAO,OAAAnjC,EAAMuG,KAAO48B,EAAI58B,KACzDs9B,EAAeD,EAAKv+B,OAAOs+B,GAC7BE,EAAa9a,YACf2a,GAAQ,OAGJI,EAAgBF,EAAKv+B,OAAOs+B,EAAW,GACzCG,IAA6C,IAA5BA,EAAc/a,YAAuB1jB,EAAOmJ,KAAI,SAAC20B,GAAO,OAAAW,EAAcv9B,KAAO48B,EAAI58B,OACrE,IAA3Bs9B,EAAa9a,YACjBiG,GAAW,eAVf,IAAoB,IAAA5B,EAAAlQ,GAAA7X,GAAMgoB,EAAAD,EAAAtpB,QAAAupB,EAAAtpB,KAAAspB,EAAAD,EAAAtpB,SAAVupB,EAAAztB,2GAiBhB,OAHmC,IAA9BF,KAAKyiC,cAAc1/B,QAAgB/C,KAAKyiC,cAAc,GAAGpZ,WAAc2a,IAAShkC,KAAKyiC,cAAc1/B,UACtGusB,GAAW,GAENA,GAMTwS,GAAA1iC,UAAAilC,cAAA,SAActzB,GACZ,QAAIA,EAAQ,MAIR/Q,KAAK2F,OAAOoL,EAAQ,GAAGxQ,QAAQw8B,OAC1B/8B,KAAKqkC,cAActzB,EAAQ,KAKtC+wB,GAAA1iC,UAAAklC,YAAA,SAAY3+B,GAAZ,QAAAgF,EAAA3K,KACQukC,EAAgB,cACXjkC,OACHyQ,EAAQyzB,EAAK7+B,OAAOo+B,UAAS,SAACN,GAAO,OAAAA,EAAI58B,KAAOvG,EAAMuG,KACxD29B,EAAKH,cAActzB,IACrBwzB,EAAc9/B,KAAKnE,eAHvB,IAAoB,IAAAmkC,EAAAjnB,GAAA7X,GAAM++B,EAAAD,EAAArgC,QAAAsgC,EAAArgC,KAAAqgC,EAAAD,EAAArgC,SAAVsgC,EAAAxkC,2GAMhBF,KAAKwS,IAAI8xB,YAAYC,GACrBI,WAAU,eACFC,EAAWj6B,EAAKk6B,oBACjBl6B,EAAKm6B,mBAAmBF,EAAS,GAAIA,EAAS,GAAGG,gBACpDH,EAAS,GAAGI,UAAYJ,EAAS,GAAGG,aAAaE,YAElD,MAMLnD,GAAA1iC,UAAAwjC,gBAAA,SAAgBj9B,WACV2pB,GAAW,EACX0U,EAAO,aACA1jC,OACH2jC,EAAWiB,EAAKv/B,OAAOo+B,UAAS,SAACN,GAAO,OAAAnjC,EAAMuG,KAAO48B,EAAI58B,KAC1Cq+B,EAAKv/B,OAAOs+B,GAChB5a,YACf2a,GAAQ,OAGJmB,EAAYD,EAAKv/B,OAAOs+B,EAAW,GACrCkB,IAAqC,IAAxBA,EAAU9b,YAAuB1jB,EAAOmJ,KAAI,SAAC20B,GAAO,OAAA0B,EAAUt+B,KAAO48B,EAAI58B,OACxFyoB,GAAW,eATf,IAAoB,IAAA8V,EAAA5nB,GAAA7X,GAAM0/B,EAAAD,EAAAhhC,QAAAihC,EAAAhhC,KAAAghC,EAAAD,EAAAhhC,SAAVihC,EAAAnlC,2GAgBhB,OAHmC,IAA9BF,KAAKyiC,cAAc1/B,QAAgB/C,KAAKyiC,cAAc,GAAGpZ,WAAc2a,IAAShkC,KAAKyiC,cAAc1/B,UACtGusB,GAAW,GAENA,GAMTwS,GAAA1iC,UAAAkmC,eAAA,SAAev0B,GACb,QAAIA,EAAQ/Q,KAAK2F,OAAOqE,OAAM,SAACy5B,GAAO,OAAkB,IAAlBA,EAAIpa,YAAoBtmB,OAAS,MAInE/C,KAAK2F,OAAOoL,EAAQ,GAAGxQ,QAAQw8B,OAC1B/8B,KAAKslC,eAAev0B,EAAQ,KAKvC+wB,GAAA1iC,UAAAmmC,YAAA,SAAY5/B,GAAZ,QAAAgF,EAAA3K,KACQwlC,EAAgB,cACXllC,OACHyQ,EAAQ00B,EAAK9/B,OAAOo+B,UAAS,SAACN,GAAO,OAAAA,EAAI58B,KAAOvG,EAAMuG,KACxD4+B,EAAKH,eAAev0B,IACtBy0B,EAAc/gC,KAAKnE,eAHvB,IAAoB,IAAAolC,EAAAloB,GAAA7X,GAAMggC,EAAAD,EAAAthC,QAAAuhC,EAAAthC,KAAAshC,EAAAD,EAAAthC,SAAVuhC,EAAAzlC,2GAMhBF,KAAKwS,IAAI+yB,YAAYC,GACrBb,WAAU,eACFC,EAAWj6B,EAAKk6B,kBAAkB,SACnCl6B,EAAKm6B,mBAAmBF,EAAS,GAAIA,EAAS,GAAGG,gBACpDH,EAAS,GAAGI,UAAYJ,EAAS,GAAGG,aAAaE,UAAYL,EAAS,GAAGG,aAAaa,aAAehB,EAAS,GAAGiB,eAElH,MAGG/D,GAAA1iC,UAAAgF,KAAR,WACEpE,KAAKsgC,QAAQl8B,QAGP09B,GAAA1iC,UAAA4jC,cAAR,SAAsBr9B,OAChBmgC,EAAY9lC,KAAK+lC,aAAapgC,GAMlC,OAJEmgC,EADE9lC,KAAKmjC,UACKnjC,KAAKgmC,kBAAkBF,GAEvB9lC,KAAKihC,mBAAmB6E,IAKxChE,GAAA1iC,UAAA6mC,gBAAA,SAAgBC,GACdlmC,KAAKkjC,QAAUgD,GAGjBpE,GAAA1iC,UAAA+mC,6BAAA,SAA6BhzB,GAC3BnT,KAAKkjC,QAAU/vB,EAAc+vB,QAC7BljC,KAAKojC,YAAcjwB,EAAciwB,YACjCpjC,KAAKmjC,UAAYhwB,EAAcgwB,WAGzBrB,GAAA1iC,UAAA2mC,aAAR,SAAqBpgC,GAArB,IAAAgF,EAAA3K,KACE,GACEA,KAAKomC,0BAA0BC,cAAgBC,GAAsB1E,MAErE,OAAOj8B,EAET,IAAK3F,KAAKkjC,UAAYljC,KAAKojC,YACzB,OAAOz9B,MAGH4gC,EAAe5gC,EAAO6M,IAAG,SAAElS,GAAiB,OAAAA,EAAMuG,KA2CxD,OAzCAlB,EAAOkF,QAAO,SAAEvK,OACRgd,EAAgBhd,EAAa,SAA6B,GAC1D2T,EAAoB3T,EAAM2oB,WAAW1oB,SAAW,GAGhDimC,IAFWlpB,EAAahe,UAAQ,IACZmnC,aAAe,IACVj0B,IAAG,SAAEk0B,GAClC,OAAOA,EAAGpH,UAAU,OAAOvxB,QAAQ,mBAAoB,MAGzD,GAAIpD,EAAKu4B,SAAW5iC,EAAMuR,MAAO,KAiBvBd,EAhBF41B,EAAeh8B,EAAKu4B,QACvB5D,UAAU,OACVvxB,QAAQ,mBAAoB,IACzB64B,EAAatmC,EAAMuR,MACtBytB,UAAU,OACVvxB,QAAQ,mBAAoB,IACzB84B,EAAiB5yB,EAAkBxO,MAAQ,GAC3CqhC,EAAe,IAAIhzB,OAAO6yB,EAAc,MACxCI,EACJP,EAAc13B,KAAI,SAAE43B,GAAe,OAAAI,EAAa19B,KAAKs9B,OACrDj/B,UAECq/B,EAAa19B,KAAKw9B,IACjBj8B,EAAKu4B,QAAQh0B,gBAAkB23B,EAAe33B,eAC/C63B,IAGY,GADPh2B,EAAQw1B,EAAav1B,QAAQ1Q,EAAMuG,MAEvC0/B,EAAa1Z,OAAO9b,EAAO,GAK7BpG,EAAKy4B,cAAiC,IAAlB9iC,EAAM+c,UAEf,GADPtM,EAAQw1B,EAAav1B,QAAQ1Q,EAAMuG,MAEvC0/B,EAAa1Z,OAAO9b,EAAO,KAK1BpL,EAAOqE,OAAM,SACjB1J,GAAiB,OAAoC,IAApCimC,EAAav1B,QAAQ1Q,EAAMuG,OAIzCi7B,GAAA1iC,UAAA6hC,mBAAR,SAA2Bt7B,GACzB,OAAOA,EAAOu7B,KAAI,SAAEC,EAAQC,GAAW,OAAAA,EAAOjY,OAASgY,EAAOhY,UAGxD2Y,GAAA1iC,UAAA4mC,kBAAR,SAA0BrgC,GAA1B,IAAAgF,EAAA3K,KACE,OAAO2F,EAAOu7B,KAAI,SAAE8F,EAAGllC,GACrB,OAAI6I,EAAK20B,UAAU0H,EAAEn1B,OAASlH,EAAK20B,UAAUx9B,EAAE+P,QACrC,EAENlH,EAAK20B,UAAU0H,EAAEn1B,OAASlH,EAAK20B,UAAUx9B,EAAE+P,OACtC,EAEF,KAIHiwB,GAAA1iC,UAAAkgC,UAAR,SAAkBxd,GAChB,OAAOA,EAAIwd,UAAU,OAAOvxB,QAAQ,mBAAoB,IAAImB,eAGtD4yB,GAAA1iC,UAAA2jC,mBAAR,WACE,OAAQ/iC,KAAKomC,0BAA0BC,aACrC,KAAKC,GAAsB3E,OACzB,OAAO,EACT,KAAK2E,GAAsB1E,MACzB,OAAO,EACT,QACE,SACE5hC,KAAK2F,OAAO5C,QAAU/C,KAAKinC,0BAC3BjnC,KAAKkjC,SACLljC,KAAKojC,eAQbtB,GAAA1iC,UAAAw9B,gBAAA,SAAgBt8B,WACdN,KAAKknC,eAAgB,EACjBlnC,KAAKwjC,WAAaljC,IAAUN,KAAKoiC,YACnCpiC,KAAKwjC,WAAY,EAEjBxjC,KAAKwjC,WAAY,MAGnB,IAAkB,IAAAtkB,EAAA1B,GAAAxd,KAAK2F,QAAMwZ,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAf+a,EAAAjf,MACRK,QAAQ2P,QAAS,sGAEvB5P,EAAMC,QAAQ2P,QAAS,EACvBlQ,KAAKoiC,YAAc9hC,GAIrBwhC,GAAA1iC,UAAA+nC,aAAA,SAAaxhC,WACX,GAAIA,GAA0B,EAAhBA,EAAO5C,OAAY,KAC/B,IAAoB,IAAAqkC,EAAA5pB,GAAA7X,GAAM0hC,EAAAD,EAAAhjC,QAAAijC,EAAAhjC,KAAAgjC,EAAAD,EAAAhjC,OAAE,CAAvB,IAAM9D,EAAK+mC,EAAAnnC,MACdI,EAAMkS,IAAI80B,YAAYhnC,wGAExBN,KAAKyiC,cAAgB,QACX98B,IACV3F,KAAKoiC,YAAY5vB,IAAI80B,YAAYtnC,KAAKoiC,aACtCpiC,KAAKwjC,WAAY,IAKrB1B,GAAA1iC,UAAAmoC,YAAA,SAAYlnB,WAEV,GADAA,EAAM/f,MAAMC,QAAQw8B,MAAQ1c,EAAM0c,OACd,IAAhB1c,EAAM0c,MAAgB,KAClByK,EAAgBxnC,KAAK2F,OAAOo+B,UAAS,SAACzjC,GAAS,OAAA+f,EAAM/f,MAAMuG,KAAOvG,EAAMuG,gBACnEvG,OACH2jC,EAAWwD,EAAK9hC,OAAOo+B,UAAS,SAACN,GAAO,OAAAnjC,EAAMuG,KAAO48B,EAAI58B,KAC/D,GAAI2gC,EAAgBvD,SAClBwD,EAAKhF,cAAc5V,OAAO4a,EAAKhF,cAAcsB,UAAS,SAACN,GAAO,OAAAnjC,EAAMuG,KAAO48B,EAAI58B,KAAK,EAAGwZ,EAAM/f,OAEzFmnC,EAAK3G,kBACH2G,EAAKhF,cAAc1/B,SAAW0kC,EAAK9hC,OAAOqE,OAAM,SAACy5B,GAAO,OAAmB,IAAlBA,EAAIpa,WAAsBoa,EAAIvZ,kBAAkBnnB,OAC3G0kC,EAAK9E,gBAAiB,EAEtB8E,EAAK9E,gBAAiB,EAEd8E,EAAK3G,oBACX2G,EAAKhF,cAAc1/B,SAAW0kC,EAAK9hC,OAAOqE,OAAM,SAACy5B,GAAO,OAAAA,EAAIvZ,kBAAiBnnB,OAC/E0kC,EAAK9E,gBAAiB,EAEtB8E,EAAK9E,gBAAiB,8BAf9B,IAAoB,IAAAzjB,EAAA1B,GAAAxd,KAAKyiC,eAAatjB,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAA,CAAjC,QAAW+a,EAAAjf,iJAqBhBF,KAAKyiC,cAAch+B,KAAK4b,EAAM/f,WACzB,KACCyQ,EAAQ/Q,KAAKyiC,cAAcsB,UAAS,SAACzjC,GAAS,OAAA+f,EAAM/f,MAAMuG,KAAOvG,EAAMuG,KAC7E7G,KAAKyiC,cAAc5V,OAAO9b,EAAO,GAG/B/Q,KAAK8gC,kBACH9gC,KAAKyiC,cAAc1/B,SAAW/C,KAAK2F,OAAOqE,OAAM,SAACy5B,GAAO,OAAmB,IAAlBA,EAAIpa,WAAsBoa,EAAIvZ,kBAAkBnnB,OAC3G/C,KAAK2iC,gBAAiB,EAEtB3iC,KAAK2iC,gBAAiB,EAEd3iC,KAAK8gC,oBACX9gC,KAAKyiC,cAAc1/B,SAAW/C,KAAK2F,OAAOqE,OAAM,SAACy5B,GAAO,OAAAA,EAAIvZ,kBAAiBnnB,OAC/E/C,KAAK2iC,gBAAiB,EAEtB3iC,KAAK2iC,gBAAiB,IAK5Bb,GAAA1iC,UAAAsoC,oBAAA,SAAoBxnC,WAGlB,GAFAF,KAAK2nC,UAAYznC,EACjBF,KAAKoiC,YAAc36B,WACL,IAAVvH,EAAgB,CAClBF,KAAKwjC,WAAY,MACjB,IAAoB,IAAAtkB,EAAA1B,GAAAxd,KAAK2F,QAAMwZ,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAA5B,IAAM9D,EAAK6e,EAAAjf,MACVI,EAAMC,QAAQw8B,OAChB/8B,KAAKyiC,cAAch+B,KAAKnE,2GAMhCwhC,GAAA1iC,UAAAyjC,qBAAA,mBACE,GAAgC,EAA5B7iC,KAAKyiC,cAAc1/B,OACrB,OAAO,MAEDumB,EAAU,OAChB,IAAoB,IAAApK,EAAA1B,GAAAxd,KAAKyiC,eAAatjB,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAAnC,IAAM9D,EAAK6e,EAAAjf,MACdopB,EAAQ7kB,KAAKnE,EAAMgpB,8GAErB,OAAOA,GAIXwY,GAAA1iC,UAAAwoC,UAAA,uBACE,GAAK5nC,KAAK2iC,eAWH,KACL,IAAoB,IAAAvd,EAAA5H,GAAAxd,KAAK2F,QAAM4f,EAAAH,EAAAhhB,QAAAmhB,EAAAlhB,KAAAkhB,EAAAH,EAAAhhB,QAApB9D,EAAKilB,EAAArlB,OACRK,QAAQw8B,OAAQ,sGAExB/8B,KAAKyiC,cAAgB,GACrBziC,KAAKsjC,gBAAgBl/B,MAAK,OAhBF,KACxB,IAAoB,IAAA+a,EAAA3B,GAAAxd,KAAK2F,QAAMsf,EAAA9F,EAAA/a,QAAA6gB,EAAA5gB,KAAA4gB,EAAA9F,EAAA/a,OAAE,CAA5B,IAAM9D,EAAK2kB,EAAA/kB,MACVF,KAAK8gC,oBAAyC,IAApBxgC,EAAM+oB,WAAsB/oB,EAAM4pB,iBAC9D5pB,EAAMC,QAAQw8B,OAAQ,EACtB/8B,KAAKyiC,cAAch+B,KAAKnE,KACdN,KAAK8gC,mBAAqBxgC,EAAM4pB,kBAC1C5pB,EAAMC,QAAQw8B,OAAQ,EACtB/8B,KAAKyiC,cAAch+B,KAAKnE,yGAG5BN,KAAKsjC,gBAAgBl/B,MAAK,KAU9B09B,GAAA1iC,UAAA0lC,mBAAA,SAAmB+C,EAAYC,OACvBC,EAAaF,EAAW7C,UACxBgD,EAAgBD,EAAaF,EAAWhC,aAExCoC,EAAUH,EAAK7C,UAErB,OADmBgD,EAAUH,EAAKjC,cACXmC,GAA8BD,GAAXE,GAG5CnG,GAAA1iC,UAAAylC,kBAAA,SAAkBp/B,OACVyiC,EAAaloC,KAAK46B,MAAMC,cAAcsN,uBAAuB,wBAC7DC,EAAqB,UAAT3iC,EAAmBzF,KAAK46B,MAAMC,cAAcsN,uBAAuB,wBAAwBD,EAAWnlC,OAAS,GAC/H/C,KAAK46B,MAAMC,cAAcsN,uBAAuB,wBAAwB,GAG1E,MAAO,CAFSnoC,KAAK46B,MAAMC,cAAcwN,qBAAqB,YAAY,GAEzDD,yBAnnBpB5nC,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,iBACVC,SAAA,02PAEAC,gBAAiBC,GAAAA,wBAAwBC,2pBA1BzCs8B,GAAAA,6DA8CCmL,GAAAA,aAAY3oC,KAAA,CAAC,oDAEbmB,GAAAA,yBAEAA,GAAAA,0BAEAA,GAAAA,mBAEAA,GAAAA,sBASAA,GAAAA,0BAmBAA,GAAAA,yCAEAA,GAAAA,iCAEAA,GAAAA,8CAEAA,GAAAA,2CAEAA,GAAAA,8CAEAA,GAAAA,0BAEAA,GAAAA,oCAEAs8B,GAAAA,UA2iBH0E,IAndE,SAAAA,GACUlH,GAAA56B,KAAA46B,MAAAA,EA5JV56B,KAAAq9B,WAAY,EACZr9B,KAAAinC,yBAA2B,EAE3BjnC,KAAAk7B,QAAoC,IAAIjQ,GAAAA,gBAAgB,IAExDjrB,KAAAsgC,QAAU,IAAImB,GAAAA,cAAoB,GAElCzhC,KAAA8iC,aAAyC,IAAI7X,GAAAA,iBAAgB,GAG7DjrB,KAAAgiC,aAAuC,IAAI/W,GAAAA,gBAAgBxjB,WAE3DzH,KAAAyiC,cAAyB,GAOhBziC,KAAAuoC,qBAA+B,EAE/BvoC,KAAAwoC,WAAqB,EAErBxoC,KAAAyoC,YAAsB,EA8BtBzoC,KAAA0oC,WAA6B,OAE7B1oC,KAAAomC,0BAAsD,GAEtDpmC,KAAA8gC,mBAA6B,EAE7B9gC,KAAAg8B,gCAA0C,EAE1Ch8B,KAAA2oC,6BAAuC,EAEvC3oC,KAAAu8B,gCAA0C,EAE1Cv8B,KAAA08B,YAAsB,EAErB18B,KAAAijC,qBAAuB,IAAIzF,GAAAA,aAS7Bx9B,KAAAiiC,SAAWx6B,UASXzH,KAAAkiC,cAAe,EASfliC,KAAAmiC,cAAe,EAuDhBniC,KAAAknC,eAAgB,EAEhBlnC,KAAAsjC,gBAAkB,IAAIrY,GAAAA,gBAAyBxjB,WCjLxD,IAAAmhC,IAQEA,GAAAxpC,UAAAypC,OAAA,WACE,OAAO7oC,KAAKwS,KAGdo2B,GAAAxpC,UAAA+qB,OAAA,SAAO3X,GACLxS,KAAKwS,IAAMA,wBAbd9S,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,6JAKZ,SAAAgpC,MCnBF,IAAAE,IAyBEA,GAAA1pC,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KAGEA,KAAK+oC,2BAA6B5d,GAAAA,cAAc,CAC9CnrB,KAAKgpC,WAAWH,SAAS3N,QACzBl7B,KAAKgpC,WAAWH,SAASre,eAAeC,cACxCW,KACA6d,GAAAA,aAAa,KACbtxB,UAAS,SAAE0T,OACL0V,EAAc1V,EAAM,GAAGrhB,OAAM,SAAE1J,GACnC,OAAiC,IAA1BA,EAAM4pB,kBAEfvf,EAAK4pB,UAAU5uB,OAASo7B,EACxBp2B,EAAKu+B,0BAA0BnI,EAAap2B,EAAK4pB,UAAUuM,sBAIvDgI,GAAA1pC,UAAA8pC,0BAAR,SAAkCvjC,EAAiBm7B,GAAnD,IAAAn2B,EAAA3K,KACMA,KAAKmpC,qBAAuB1hC,YAC9BzH,KAAKmpC,mBAAmBze,cACxB1qB,KAAKmpC,mBAAqB1hC,WAE5BzH,KAAKmpC,mBAAqBhe,GAAAA,cAAcxlB,EACrCqE,OAAM,SAAC1J,GAAS,OAAAA,EAAM+oB,YAAcyX,IACpCtuB,IAAG,SAAElS,GAAiB,OAAAA,EAAMypB,YAC5BqB,KAAK5Y,GAAAA,IAAG,SAAE42B,GAAwB,OAAAA,EAAS/3B,MAAMg4B,YACjD1xB,UAAS,SAAE2xB,GACV,OAAA3+B,EAAK4pB,UAAUgU,oBAAsBe,KAG3CR,GAAA1pC,UAAAs0B,YAAA,WACE1zB,KAAK+oC,2BAA2Bre,cAC5B1qB,KAAKmpC,qBAAuB1hC,YAC9BzH,KAAKmpC,mBAAmBze,cACxB1qB,KAAKmpC,mBAAqB1hC,iCAlD/BmtB,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,sEALHqhC,GAAkB3+B,WAAA,CAAA,CAAAsC,KAatBovB,GAAAA,cAdI+T,UADAW,GAAAA,aAAYpmC,WAAA,CAAA,CAAAsC,KAiBhB+jC,GAAAA,cA2CLV,IA9CE,SAAAA,GACUvU,EACAyU,EACYS,GADZzpC,KAAAgpC,WAAAA,EACYhpC,KAAAypC,MAAAA,EAEpBzpC,KAAKu0B,UAAYA,ECtBrB,IAAAmV,IAoCE5pC,OAAAC,eACI2pC,GAAAtqC,UAAA,cAAW,KAGf,WACE,OAAOY,KAAK2pC,aAAazpC,WAL3B,SACgBA,GACdF,KAAK2pC,aAAavlC,KAAKlE,oCAMzBJ,OAAAC,eACI2pC,GAAAtqC,UAAA,YAAS,KAGb,WACE,OAAOY,KAAK4pC,WAAW1pC,WALzB,SACcA,GACZF,KAAK4pC,WAAWxlC,KAAKlE,oCAMvBJ,OAAAC,eACI2pC,GAAAtqC,UAAA,OAAI,KAGR,WACE,OAAOY,KAAK6pC,MAAM3pC,WALpB,SACSA,GACPF,KAAK6pC,MAAMzlC,KAAKlE,oCAWlBwpC,GAAAtqC,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAK8pC,OAAS9pC,KAAK6pC,MAAMlyB,UAAS,SAACurB,GACjCv4B,EAAKs4B,qBAAqBnG,KAAK,CAC7BoG,QAAOA,EACPE,YAAaz4B,EAAKy4B,YAClBD,UAAWx4B,EAAKw4B,cAGpBnjC,KAAK+pC,cAAgB/pC,KAAK2pC,aAAahyB,UAAS,SAACyrB,GAC/Cz4B,EAAKs4B,qBAAqBnG,KAAK,CAC7BoG,QAASv4B,EAAKu7B,KACd9C,YAAWA,EACXD,UAAWx4B,EAAKw4B,cAEpBnjC,KAAKgqC,YAAchqC,KAAK4pC,WAAWjyB,UAAS,SAACwrB,GAC3Cx4B,EAAKs4B,qBAAqBnG,KAAK,CAC7BoG,QAASv4B,EAAKu7B,KACd9C,YAAaz4B,EAAKy4B,YAClBD,UAASA,OAIfuG,GAAAtqC,UAAAs0B,YAAA,WACE1zB,KAAK+pC,cAAcrf,cACnB1qB,KAAKgqC,YAAYtf,cACjB1qB,KAAK8pC,OAAOpf,eAGdgf,GAAAtqC,UAAA6qC,UAAA,WACEjqC,KAAKkmC,KAAOz+B,WAEdiiC,GAAAtqC,UAAA8qC,gBAAA,WACElqC,KAAKmjC,WAAanjC,KAAKmjC,WAGzBuG,GAAAtqC,UAAA+qC,kBAAA,WACEnqC,KAAKojC,aAAepjC,KAAKojC,aAG3BsG,GAAAtqC,UAAAsoC,oBAAA,WACE1nC,KAAKw6B,eAAiBx6B,KAAKw6B,cAC3Bx6B,KAAK2nC,UAAU7K,KAAK98B,KAAKw6B,qCAzF5Bh6B,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,6nEAEAC,gBAAiBC,GAAAA,wBAAwBC,yIAWxCC,GAAAA,0BAEAA,GAAAA,2BAEAA,GAAAA,yBAQAA,GAAAA,oBAQAA,GAAAA,oCAUAs8B,GAAAA,0BACAA,GAAAA,UA6CHsM,IA3FA,SAAAA,KAQS1pC,KAAA2pC,aAAyC,IAAI1e,GAAAA,iBAAgB,GAC7DjrB,KAAA4pC,WAAuC,IAAI3e,GAAAA,iBAAgB,GAC3DjrB,KAAA6pC,MAAiC,IAAI5e,GAAAA,gBAAgBxjB,WAKnDzH,KAAAuoC,qBAA+B,EAE/BvoC,KAAA0oC,WAA6B,OA0B/B1oC,KAAAw6B,eAAgB,EAEbx6B,KAAAijC,qBAAuB,IAAIzF,GAAAA,aAC3Bx9B,KAAA2nC,UAAY,IAAInK,GAAAA,iBC/D5B4M,yBAEC1qC,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,6JAYZ,SAAAwqC,KAROpqC,KAAAmjC,WAAY,EACZnjC,KAAAojC,aAAc,EACdpjC,KAAAqqC,aAAc,EACdrqC,KAAAsqC,oBAAqB,EACrBtqC,KAAAuqC,wBAAyB,EACzBvqC,KAAAwqC,wBAAyB,EACzBxqC,KAAAyqC,wBAAyB,ECblC,IAAAC,IAiBE5qC,OAAAC,eAAI2qC,GAAAtrC,UAAA,UAAO,KAAX,WACE,GAAKY,KAAKM,MAGV,OAAON,KAAKM,MAAMC,yCAOpBmqC,GAAAtrC,UAAAi0B,SAAA,WACErzB,KAAK6d,MAAQ7d,KAAKqwB,aAAe,UAAY,SAG/Cqa,GAAAtrC,UAAAurC,mBAAA,WACM3qC,KAAKqwB,cACPrwB,KAAKM,MAAMyyB,oBAAoB/yB,KAAKM,MAAMC,QAAQ8vB,cAClDrwB,KAAK6d,MAAQ,UAEb7d,KAAKM,MAAMgwB,mBAAmBtwB,KAAKM,MAAMC,QAAQ8vB,cACjDrwB,KAAK6d,MAAQ,WAEf7d,KAAKqwB,cAAgBrwB,KAAKqwB,mCAnC7B7vB,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,2BACVC,SAAA,8UAEAC,gBAAiBC,GAAAA,wBAAwBC,8FAIxCC,GAAAA,4BAEAA,GAAAA,SA2BH4pC,IAhBE,SAAAA,KAXS1qC,KAAAqwB,cAAe,EASjBrwB,KAAA6d,MAAgB,UCRzB,WAAiD7W,GAAAA,MAAA4jC,GAAAA,qBAkB/CC,GAAAzrC,UAAA0rC,UAAA,SAAUC,GACRzzB,GAAAlY,UAAM0rC,UAAS9nC,KAAAhD,KAAC+qC,IACI,IAAhB/qC,KAAKkQ,QACPlQ,KAAKgrC,WAAWD,IAQpBF,GAAAzrC,UAAA6rC,YAAA,SAAYF,GACVzzB,GAAAlY,UAAM6rC,YAAWjoC,KAAAhD,KAAC+qC,IACE,IAAhB/qC,KAAKkQ,QACPlQ,KAAKkrC,aAAaH,IAQtBF,GAAAzrC,UAAA+rC,UAAA,SAAUC,GACRprC,KAAKorC,OAASA,GAONP,GAAAzrC,UAAAisC,WAAV,WAAA,IAAA1gC,EAAA3K,KACEA,KAAKsrC,OAAOzgC,QAAO,SAAEkgC,GAAwB,OAAApgC,EAAKqgC,WAAWD,MAOrDF,GAAAzrC,UAAAmsC,aAAV,WACEvrC,KAAKwrC,cAUCX,GAAAzrC,UAAA4rC,WAAR,SAAmBD,GAAnB,IAAApgC,EAAA3K,KACE,IAAIA,KAAKyrC,SAASC,IAAIX,GAAtB,KAIMY,EAAeZ,EAAMa,KAAKC,OAC7Bl0B,UAAS,SAAEgB,GAAwB,OAAAhO,EAAKmhC,iBAAiBnzB,EAAUoyB,KACtE/qC,KAAKyrC,SAAS9f,IAAIof,EAAOY,KAOnBd,GAAAzrC,UAAA8rC,aAAR,SAAqBH,OACbY,EAAe3rC,KAAKyrC,SAAStzB,IAAI4yB,GACnCY,IAAiBlkC,YACnBkkC,EAAajhB,cACb1qB,KAAKyrC,SAASM,UAAOhB,KAOjBF,GAAAzrC,UAAAosC,WAAR,WACEvpC,MAAM+3B,KAAKh6B,KAAKyrC,SAASO,WAAWnhC,QAAO,SAAEmhC,GAC3CA,EAAQ,GAAGthB,gBAEb1qB,KAAKyrC,SAAS5qB,SAQRgqB,GAAAzrC,UAAA0sC,iBAAR,SAAyBnzB,EAAqBoyB,GACpB,IAApBpyB,EAAS5V,OACXgoC,EAAMkB,aAENlB,EAAMmB,iBACJvzB,EACA3Y,KAAKmsC,aAAapB,GAClB/qC,KAAKO,QAAQ6rC,UACbpsC,KAAKO,QAAQ8rC,UACbrsC,KAAKO,QAAQ+rC,eAUXzB,GAAAzrC,UAAA+sC,aAAR,SAAqBpB,GACnB,OAAI/qC,KAAKorC,SAAW3jC,UAAoBzH,KAAKorC,QAEtB,IAAnBL,EAAMwB,SAEDC,GAAc7qB,QACZopB,EAAM72B,MAAQ62B,EAAMa,KAAK13B,MAE3Bs4B,GAAc7qB,QAGd6qB,GAAchrB,MAG3BqpB,IAhIE,SAAAA,GAAsBtqC,GAAtB,IAAAoK,EACE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YADM2K,EAAApK,QAAAA,EAJdoK,EAAA8gC,SAAW,IAAIgB,IAMrB9hC,EAAKwgC,UAAU5qC,EAAQ6qC,UCX3B,WAAsDpkC,GAAAA,MAAA4jC,GAAAA,qBAepD8B,GAAAttC,UAAA0rC,UAAA,SAAUC,GACRzzB,GAAAlY,UAAM0rC,UAAS9nC,KAAAhD,KAAC+qC,IACI,IAAhB/qC,KAAKkQ,QACPlQ,KAAKgrC,WAAWD,IAQpB2B,GAAAttC,UAAA6rC,YAAA,SAAYF,GACVzzB,GAAAlY,UAAM6rC,YAAWjoC,KAAAhD,KAAC+qC,IACE,IAAhB/qC,KAAKkQ,QACPlQ,KAAKkrC,aAAaH,IAQZ2B,GAAAttC,UAAAisC,WAAV,WAAA,IAAA1gC,EAAA3K,KACEA,KAAKsrC,OAAOzgC,QAAO,SAAEkgC,GAAwB,OAAApgC,EAAKqgC,WAAWD,MAOrD2B,GAAAttC,UAAAmsC,aAAV,WACEvrC,KAAKwrC,cAOCkB,GAAAttC,UAAA4rC,WAAR,SAAmBD,GAAnB,IAAApgC,EAAA3K,KACMA,KAAKyrC,SAASC,IAAIX,KAItB/qC,KAAK2sC,gBAAgB5B,GACJA,EAAMzqC,MAAMwG,GAAG6nB,YACvBzC,GAAG,SAAQ,SAAG7L,GACrB1V,EAAKgiC,gBAAgB5B,OAQjB2B,GAAAttC,UAAA8rC,aAAR,SAAqBH,OACb1nC,EAAMrD,KAAKyrC,SAAStzB,IAAI4yB,GAC1B1nC,IAAQoE,YACV6qB,GAAAA,QAAQjvB,GACRrD,KAAKyrC,SAASM,UAAOhB,KAOjB2B,GAAAttC,UAAAosC,WAAR,WACEvpC,MAAM+3B,KAAKh6B,KAAKyrC,SAASO,WAAWnhC,QAAO,SAAEmhC,GAC3C1Z,GAAAA,QAAQ0Z,EAAQ,MAElBhsC,KAAKyrC,SAAS5qB,SAQR6rB,GAAAttC,UAAAutC,gBAAR,SAAwB5B,OAChB6B,EAAa7B,EAAMzqC,MAAMwG,GAAG6nB,YAAYke,cACpB,IAAtBD,EAAW7pC,OACbgoC,EAAMlqB,QAENkqB,EAAM+B,mBAAmBF,IAG/BF,IA7FE,SAAAA,GAAsBnsC,GAAtB,IAAAoK,EACE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YADM2K,EAAApK,QAAAA,EAFdoK,EAAA8gC,SAAW,IAAIgB,MCAzB,WAA+DzlC,GAAAA,MAAA+lC,GAAAA,aAe7DjtC,OAAAC,eAAIitC,GAAA5tC,UAAA,SAAM,KAAV,WACE,OAAOY,KAAKM,MAAQN,KAAKM,MAAgB,WAAwBmH,2CAanEulC,GAAA5tC,UAAA6tC,UAAA,SAAU3sC,GAER,OADAN,KAAKM,MAAQA,EACNN,MASTgtC,GAAA5tC,UAAA8sC,iBAAA,SACEvzB,EACAyyB,EACAgB,EACAC,EACA3rB,GALF,IAAA/V,EAAA3K,UAEE,IAAAorC,IAAAA,EAAwBoB,GAAc7qB,SAKtCjB,EAAQA,GAAgBwsB,GAAAA,YACxBltC,KAAKmtC,iBAECP,EAAaj0B,EAChBnG,IAAG,SAAEnN,GAAqB,OAAA+nC,GAAY/nC,EAASsF,EAAK6H,IAAImW,WAAYjI,KACvE1gB,KAAKqtC,mBAAmBT,EAAYxB,EAAQgB,EAAWC,IAOzDW,GAAA5tC,UAAA0tC,mBAAA,SAAmBF,GAAnB,IAAAjiC,EAAA3K,KACEA,KAAKmtC,iBAECx0B,EAAWi0B,EAAWp6B,IAAG,SAAE8iB,GAE/B,OADAA,EAAU3J,IAAI,gBAAiBhhB,GAAM,GAC9B2iC,GAAchY,EAAW3qB,EAAKrK,MAAMkS,IAAImW,cAEjD3oB,KAAKutC,KAAI,IAMXP,GAAA5tC,UAAA6sC,WAAA,WACEjsC,KAAKmtC,aACLntC,KAAKqhB,OAAOva,GAAG+Z,SAMTmsB,GAAA5tC,UAAA+tC,WAAR,WACE,GAAIntC,KAAKM,QAAUmH,UACjB,MAAM,IAAIC,MAAM,+CASZslC,GAAA5tC,UAAAiuC,mBAAR,SACET,EACAxB,EACAgB,EACAC,QAFA,IAAAjB,IAAAA,EAAwBoB,GAAc7qB,aAKhC6rB,EAAOC,GADIztC,KAAKM,MAAMwG,GAAG6nB,YACake,cAAeD,GAClC,EAArBY,EAAKE,OAAO3qC,QACd/C,KAAK2tC,0BAA0BH,EAAKE,QAGhB,EAAlBF,EAAKI,IAAI7qC,QACX/C,KAAK6tC,qBAAqBL,EAAKI,KAGX,EAAlBJ,EAAKI,IAAI7qC,OAEX+qC,GAAiB9tC,KAAKwS,IAAKg7B,EAAKI,IAAKxC,EAAQgB,EAAWC,GAC1B,EAArBmB,EAAKE,OAAO3qC,QAErB+qC,GAAiB9tC,KAAKwS,IAAKo6B,EAAYxB,EAAQgB,EAAWC,IAQtDW,GAAA5tC,UAAAyuC,qBAAR,SAA6BjB,GAA7B,IAAAjiC,EAAA3K,KACE4sC,EAAW/hC,QAAO,SAAEyqB,GAClBA,EAAU3J,IAAI,gBAAiBhhB,GAAM,KAEvC3K,KAAKqhB,OAAOva,GAAGinC,YAAYnB,IAOrBI,GAAA5tC,UAAAuuC,0BAAR,SAAkCf,GAAlC,IAAAjiC,EAAA3K,KACE4sC,EAAW/hC,QAAO,SAAEyqB,GAClB3qB,EAAK0W,OAAOva,GAAG6Z,cAAc2U,MAInC0X,IAtHE,SAAAA,GAAYgB,EAAeztC,GAA3B,IAAAoK,EACE2M,GAAAtU,KAAAhD,KAAMguC,EAAUztC,IAAQP,YACxB2K,EAAK6H,IAAMjS,EAAQiS,MCtBvB,IAAA8E,GAAA22B,IAAsCjnC,GAAAA,GAAtCsQ,GAAsC42B,IAItCD,IAHE,SAAAA,GAAY1tC,UACV+W,GAAAtU,KAAAhD,KAAMO,IAAQP,KAclB,WAAmDgH,GAAAA,MAAA4jC,GAAAA,qBAsBjD9qC,OAAAC,eAAIouC,GAAA/uC,UAAA,MAAG,KAAP,WAAoB,OAAOY,KAAKO,QAAQiS,qCAMxC1S,OAAAC,eAAIouC,GAAA/uC,UAAA,eAAY,KAAhB,WAAmC,OAAOY,KAAKouC,+CAc/CD,GAAA/uC,UAAA0rC,UAAA,SAAUC,GACRzzB,GAAAlY,UAAM0rC,UAAS9nC,KAAAhD,KAAC+qC,IACI,IAAhB/qC,KAAKkQ,QAEPlQ,KAAKquC,YASTF,GAAA/uC,UAAA6rC,YAAA,SAAYF,GACVzzB,GAAAlY,UAAM6rC,YAAWjoC,KAAAhD,KAAC+qC,IACE,IAAhB/qC,KAAKkQ,QAEPlQ,KAAKquC,YAQTF,GAAA/uC,UAAA+rC,UAAA,SAAUC,GACRprC,KAAKorC,OAASA,GAMhB+C,GAAA/uC,UAAAkvC,YAAA,WACEtuC,KAAKsrC,OAAOzgC,QAAO,SAAEkgC,GACnBA,EAAMnP,MAAM2S,UAAU,CAACC,UAAU,OAOrCL,GAAA/uC,UAAAyhB,MAAA,WACE7gB,KAAKyuC,aAAaptB,OAAOva,GAAG+Z,QAC5B7gB,KAAKyuC,aAAa5tB,SAOpBstB,GAAA/uC,UAAAsvC,oBAAA,WACE1uC,KAAK2uC,qBACL3uC,KAAK4uC,2BACL5uC,KAAKwrC,cAQG2C,GAAA/uC,UAAAisC,WAAV,WACErrC,KAAK6uC,kBACL7uC,KAAK8uC,oBACwB,IAAzB9uC,KAAKO,QAAQwuC,SACf/uC,KAAKgvC,wBAEPhvC,KAAKivC,YAQGd,GAAA/uC,UAAAmsC,aAAV,WACEvrC,KAAK0uC,sBACL1uC,KAAKkvC,sBASCf,GAAA/uC,UAAA6vC,SAAR,WAAA,IAAAtkC,EAAA3K,KACEA,KAAKwrC,iBAEC2D,EAAUnvC,KAAKsrC,OAAO94B,IAAG,SAAEu4B,GAC/B,OAAOA,EAAMqE,UAAUC,QAAO,SAAEC,GAC9B,OAAiC,IAA1BA,EAAO1T,MAAM4S,WACnBpjB,KACD5Y,GAAAA,IAAG,SAAE+8B,GAAqC,OAAAA,EAAQ/8B,IAAG,SAAC88B,GAAU,OAAAA,EAAOE,cAG3ExvC,KAAKyrC,SAAWtgB,GAAAA,cAAcgkB,GAC3B/jB,KACC6d,GAAAA,aAAa,GACbwG,GAAAA,KAAK,GACLj9B,GAAAA,IAAG,SAAEmG,GAA+B,OAAAA,EAASirB,OAAM,SAAEoD,EAAGllC,GAAM,OAAAklC,EAAEpiC,OAAO9C,QACvE6V,UAAS,SAAEgB,GAAwB,OAAAhO,EAAK+kC,kBAAkB/2B,MAMxDw1B,GAAA/uC,UAAAosC,WAAR,WACMxrC,KAAKyrC,WAAahkC,WACpBzH,KAAKyrC,SAAS/gB,eASVyjB,GAAA/uC,UAAA0vC,iBAAR,WAAA,IAAAnkC,EAAA3K,KACEA,KAAK2vC,iBAAmB3vC,KAAKwS,IAAI1L,GAAGolB,GAAG,cAAa,SAAG7L,GACrD1V,EAAKilC,WAAWvvB,MAOZ8tB,GAAA/uC,UAAAuvC,mBAAR,WACM3uC,KAAK2vC,mBAAqBloC,WAC5BzH,KAAKwS,IAAI1L,GAAGwlB,GACVtsB,KAAK2vC,iBAAiBlqC,KACtBzF,KAAK2vC,iBAAiBE,WASpB1B,GAAA/uC,UAAAwwC,WAAR,SAAmBvvB,GAAnB,IAAA1V,EAAA3K,KACQ8vC,GAAa5oB,GAAY7G,GACzB0vB,GAAWD,EACXlD,EAAavsB,EAAM7N,IAAIw9B,mBAAmB3vB,EAAM4vB,MAAO,CAC3DC,aAAclwC,KAAKO,QAAQ2vC,cAAgB,EAC3CC,YAAW,SAAG9V,GAIZ,OAHqB1vB,EAAK2gC,OAAOx8B,KAAI,SAAEi8B,GACrC,OAAOA,EAAMzqC,MAAMwG,KAAOuzB,MAEJ5yB,aAG5BzH,KAAKowC,gBAAgBxD,EAAYkD,EAAWC,IAMtC5B,GAAA/uC,UAAA4vC,sBAAR,WAAA,QACMqB,EADN1lC,EAAA3K,KAEQswC,EAAiBtwC,KAAKwS,IAAI1L,GAAGypC,kBAAkBC,eAKrD,IAA4B,IAAAC,EAAAjzB,GAAA8yB,GAAcI,EAAAD,EAAArsC,QAAAssC,EAAArsC,KAAAqsC,EAAAD,EAAArsC,OAAE,CAAvC,IAAMusC,EAAaD,EAAAxwC,MACtB,GAAIywC,aAAyB1C,GAAyB,CACpDoC,EAA0BM,EAC1B,4GAIAN,IAA4B5oC,YAC9B4oC,EAA0B,IAAIpC,GAAwB,CACpD2C,UAAW1pB,KAEblnB,KAAKwS,IAAI1L,GAAG+pC,eAAeR,GAC3BrwC,KAAKqwC,wBAA0BA,GAGjCrwC,KAAK8wC,8BAAgCT,EAAwBnkB,GAC3D,SAAQ,SACP7L,GAAoC,OAAA1V,EAAKomC,aAAa1wB,MAOnD8tB,GAAA/uC,UAAAwvC,yBAAR,WACM5uC,KAAK8wC,gCAAkCrpC,WACzC6qB,GAAAA,QAAQtyB,KAAK8wC,+BAEX9wC,KAAKqwC,0BAA4B5oC,WACnCzH,KAAKwS,IAAI1L,GAAGkqC,kBAAkBhxC,KAAKqwC,yBAErCrwC,KAAKqwC,wBAA0B5oC,WAOzB0mC,GAAA/uC,UAAA2xC,aAAR,SAAqB1wB,OACbyvB,GAAa5oB,GAAY7G,EAAM4wB,iBAC/BjoC,EAASqX,EAAMjd,OAAO4tB,cAAc7U,YACpCywB,EAAa5sC,KAAKsrC,OAAO1H,OAAM,SAAEsN,EAAkBnG,OACjDoG,EAAWpG,EAAMzqC,MAAMwG,GAAG6nB,YAEhC,OADAuiB,EAAIzsC,KAAIxB,MAARiuC,EAAGvsC,GAASwsC,EAASC,oBAAoBpoC,KAClCkoC,GACN,IACHlxC,KAAKowC,gBAAgBxD,EAAYkD,GAAW,IAQtC3B,GAAA/uC,UAAAswC,kBAAR,SAA0B/2B,OAMpB04B,EALEjG,EAASprC,KAAKorC,OAEdkG,EADoBtxC,KAAKyuC,aAAanuC,MAAMwG,GAAG6nB,YAAYke,cACnBr6B,IAAG,SAAE8iB,GAAyB,OAAAA,EAAU5U,UAChF6wB,EAAe54B,EAASnG,IAAIxS,KAAKyuC,aAAa+C,QAIlDH,EADsB,IAApB14B,EAAS5V,SAGAuuC,EAAoBvuC,SAAWwuC,EAAaxuC,SACpDuuC,EAAoBjgC,MAAK,SAAEhO,GAAmB,OAA6B,GAA7BkuC,EAAavgC,QAAQ3N,MAGxErD,KAAKyuC,aAAavC,iBAChBvzB,EACA04B,EAAWjG,EAASoB,GAAchrB,KAClCxhB,KAAKO,QAAQ6rC,UACbpsC,KAAKO,QAAQ8rC,UACbrsC,KAAKO,QAAQ+rC,eAST6B,GAAA/uC,UAAAgxC,gBAAR,SAAwBxD,EAAyBkD,EAAoBC,GAArE,IAAAplC,EAAA3K,KACQyxC,EAAkBzxC,KAAK0xC,qBAAqB9E,GAElD5sC,KAAKsrC,OAAOzgC,QAAO,SAAEkgC,OACbpyB,EAAW84B,EAAgBt5B,IAAI4yB,GACjCpyB,IAAalR,YAA2B,IAAdqoC,EAC5BnlC,EAAKgnC,6BAA6B5G,GACzBpyB,IAAalR,YAA2B,IAAdqoC,GAGnCnlC,EAAKinC,wBAAwB7G,EAAOpyB,EAAUm3B,EAAWC,MAUvD5B,GAAA/uC,UAAAwyC,wBAAR,SAAgC7G,EAAqBpyB,EAAqBm3B,EAAoBC,IAC5E,IAAZA,EACFhF,EAAMnP,MAAMiW,YAAYl5B,EAAU,CAAC,aAEnCoyB,EAAMnP,MAAMkW,WAAWn5B,EAAU,CAAC61B,UAAU,GAAOsB,IAQ/C3B,GAAA/uC,UAAAuyC,6BAAR,SAAqC5G,GACnCA,EAAMnP,MAAM2S,UAAU,CAACC,UAAU,KAU3BL,GAAA/uC,UAAAsyC,qBAAR,SAA6B9E,OACrB6E,EAAkB,IAAIhF,IAC5B,OAAmB,OAAfG,GAAuBA,IAAenlC,WAI1CmlC,EAAW/hC,QAAO,SAAEyqB,OACZyV,EAAQzV,EAAUnd,IAAI,iBAC5B,GAAI4yB,IAAUtjC,UAAd,KAEIkR,EAAW84B,EAAgBt5B,IAAI4yB,GAC/BpyB,IAAalR,YACfkR,EAAW,GACX84B,EAAgB9lB,IAAIof,EAAOpyB,QAGvBtT,EAAU0lC,EAAM5yB,IAAImd,EAAU5U,SAChCrb,IAAYoC,WACdkR,EAASlU,KAAKY,MAfTosC,GA0BHtD,GAAA/uC,UAAA2yC,mBAAR,eACQC,EAAehyC,KAAKO,QAAQD,MAC9BN,KAAKO,QAAQD,MACbN,KAAK+0B,qBACT,OAAO,IAAIiY,GAAa,GAAI,CAACx6B,IAAKxS,KAAKwS,MAAMy6B,UAAU+E,IAOjD7D,GAAA/uC,UAAA21B,mBAAR,WACE,OAAO,IAAI/E,GAAY,CACrB7G,OAAQ,IACR9H,OAAQ,IAAIpa,GACZV,MAAOkB,UACPyiB,iBAAiB,EACjBgG,YAAY,EACZD,WAAW,KAQPke,GAAA/uC,UAAAyvC,gBAAR,WACM7uC,KAAKyuC,aAAanuC,MAAMkS,MAAQ/K,WAClCzH,KAAKwS,IAAIy/B,SAASjyC,KAAKyuC,aAAanuC,QAOhC6tC,GAAA/uC,UAAA8vC,mBAAR,WACElvC,KAAKyuC,aAAaptB,OAAOva,GAAG+Z,QAC5B7gB,KAAKwS,IAAI80B,YAAYtnC,KAAKyuC,aAAanuC,QAE3C6tC,IAjXE,SAAAA,GAAsB5tC,GAAtB,IAAAoK,EACE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YADM2K,EAAApK,QAAAA,EAEpBoK,EAAKwgC,UAAU5qC,EAAQ6qC,QACvBzgC,EAAKyjC,cAAgBzjC,EAAKonC,uBC9B9B,SAAgB3E,GACd/nC,EACA6sC,EACAxxB,GAEAA,EAAQA,GAAgBwsB,GAAAA,gBAGlB5X,GADW,IAAI6c,IACM5xB,YAAYlb,EAAS,CAC9C6H,eAAgB7H,EAAQsjB,WACxBxb,kBAAmB+kC,IAGrB5c,EAAU8c,MAAM1xB,EAAMrb,QAEhBwM,EAAQwgC,GAAAA,eAAehtC,GACzBwM,IAAUpK,WACZ6tB,EAAU3J,IAAI,SAAU9Z,GAAO,GAG7BxM,EAAQ2D,SAAWvB,WACrB6tB,EAAU3J,IAAI,UAAWtmB,EAAQ2D,QAAQ,GAGvC3D,EAAQsjB,aAAelhB,WACzB6tB,EAAU3J,IAAI,cAAetmB,EAAQsjB,YAAY,OAG7C2pB,EAAWC,GAAAA,kBAAkBltC,EAAS,iBACxCitC,IAAa7qC,WACf6tB,EAAU3J,IAAI,YAAa2mB,GAAU,GAGvChd,EAAU3J,IAAI,kBAAmB6mB,GAAAA,kBAAkBntC,IAAU,OAEvDqzB,EAAO+Z,GAAAA,cAAcptC,GAa3B,OAZIqzB,IAASjxB,WACX6tB,EAAU3J,IAAI,QAAS+M,GAAM,GAG3BrzB,EAAQqtC,MAAQrtC,EAAQqtC,KAAKnsC,OAC/B+uB,EAAU3J,IAAI,SAAUtmB,EAAQqtC,KAAKnsC,OAAO,GAG1ClB,EAAQstC,UACVrd,EAAU3J,IAAI,YAAatmB,EAAQstC,UAAU,GAGxCrd,EAGT,SAAgBsd,GACdC,EACAC,EACAzY,EACA6X,OAEMa,EACAlhC,EACAmhC,EACAC,OALN,IAAAf,IAAAA,EAAA,aAOM7X,GACFxoB,EAAQwoB,EAAQliB,IAAI,SAChBkiB,EAAQliB,IAAI,mBACd66B,EAAU3Y,EAAQliB,IAAI,iBAAiB+6B,iBACvCD,EAAiB5Y,EAAQliB,IAAI,iBAAiBg7B,0BAGhDthC,EAAQghC,EAAgB16B,IAAI,cAGxBi7B,EAAW,IAAIjB,GACf/9B,EAAay+B,EAAgBz5B,gBAC7Bqd,EAAeoc,EAAgBlhB,UAErC,GAAqB,YAAjB8E,EAA4B,KACxB4c,EAAOR,EAAgBS,MAC7BP,EAAO,IAAIQ,GAAUV,EAAgBW,iBAAkBC,EAAiBC,GAAIL,OAClD,UAAjB5c,EACTsc,EAAO,IAAIY,EAAQd,EAAgBW,iBAAkBC,EAAiBC,IAC5C,eAAjBjd,IACTsc,EAAO,IAAIa,EAAaf,EAAgBW,iBAAkBC,EAAiBC,SAGvEtoC,EAAWgoC,EAASS,oBAAoBd,EAAM,CAClD7lC,eAAgBglC,EAChB/kC,kBAAmB2lC,IAGfjsC,EAAKgsC,EAAgBnyB,QAAUmyB,EAAgBnyB,QAAUta,GAAAA,OACzDksC,EAAWO,EAAgB16B,IAAI,aAErC,MAAO,CACL1S,KAAM8b,GACNoH,WAAYupB,EACZlpC,OAAQ6pC,EAAgB12B,YACxBu2B,KAAM,CACJ7rC,GAAEA,EACFgL,MAAOA,IAAgBygC,GAAsBzrC,GAC7CyrC,SAAQA,EACRY,iBAAkBF,EAClBG,wBAAyBF,GAE3B7+B,WAAUA,EACVhJ,SAAQA,EACRtE,GAAI+rC,GAYV,SAAgBvF,GACdhY,EACAwd,EACAzY,EACA6X,OAEIrgC,EACAmhC,EACAC,OAJJ,IAAAf,IAAAA,EAAA,iBAKMkB,EAAW,IAAIjB,GAKf/9B,EAHOkhB,EAAUzc,UAAU7O,OAAM,SAAE3G,GACvC,OAAQA,EAAIywC,WAAW,MAAgB,aAARzwC,IAETugC,OAAM,SAAEsN,EAAa7tC,GAE3C,OADA6tC,EAAI7tC,GAAOiyB,EAAUnd,IAAI9U,GAClB6tC,GACN,IAEG9lC,EAAWgoC,EAASS,oBAAoBve,EAAUtE,cAAe,CACrE9jB,eAAgBglC,EAChB/kC,kBAAmB2lC,IAGjBzY,GACFxoB,EAAQwoB,EAAQliB,IAAI,SAChBkiB,EAAQliB,IAAI,mBACd66B,EAAU3Y,EAAQliB,IAAI,iBAAiB+6B,iBACvCD,EAAiB5Y,EAAQliB,IAAI,iBAAiBg7B,0BAGhDthC,EAAQyjB,EAAUnd,IAAI,cAElBm6B,EAAWhd,EAAUnd,IAAI,aACzBtR,EAAKyuB,EAAU5U,QAAU4U,EAAU5U,QAAUta,GAAAA,OAEnD,MAAO,CACLX,KAAM8b,GACNoH,WAAYupB,EACZlpC,OAAQssB,EAAUnd,IAAI,WACtBu6B,KAAM,CACJ7rC,GAAEA,EACFgL,MAAOA,IAAgBygC,GAAsBzrC,GAC7CyrC,SAAQA,EACRyB,SAAUze,EAAU0e,cACpBztC,MAAO+uB,EAAUnd,IAAI,UACrB+6B,iBAAkBF,EAClBG,wBAAyBF,GAE3B7+B,WAAUA,EACVhJ,SAAQA,EACRtE,GAAIwuB,GAUR,SAAgB2e,GACdzhC,EACA8iB,OAEI4e,EAAWC,EAAAA,cAETC,EAAkB9e,EAAUnd,IAAI,WAChCk8B,EAAsB/e,EAAUnd,IAAI,eAC1C,GAAIi8B,IAAoB3sC,WAAa4sC,IAAwB5sC,UAC3DysC,EAAWI,GAAAA,gBACTF,EACAC,EACA7hC,EAAImW,gBAED,KACC4rB,EAAajf,EAAUtE,cACV,OAAfujB,IACFL,EAAWK,EAAWp4B,aAI1B,OAAO+3B,EAST,SAAgBM,GACdhiC,EACAo6B,OAEM5jC,EAASmrC,EAAAA,cAOf,OALAvH,EAAW/hC,QAAO,SAAEyqB,OACZmf,EAAgBR,GAAuBzhC,EAAK8iB,GAClDof,EAAAA,OAAgB1rC,EAAQyrC,KAGnBzrC,EAST,SAAgB2rC,GACd3rC,EACAxC,GAEM,IAAAse,EAAAxgB,GAAAswC,EAAAC,QAAA7rC,GAAA,GAAC8sB,EAAAhR,EAAA,GAAOsJ,EAAAtJ,EAAA,GACd,MAAO,CACLte,EAAM,GAAKwC,EAAO,GAAK8sB,EAAQtvB,EAAM,GAAKwC,EAAO,GACjDxC,EAAM,GAAKwC,EAAO,GAAKolB,EAAS5nB,EAAM,GAAKwC,EAAO,GAClDxC,EAAM,GAAKwC,EAAO,GAAK8sB,EAAQtvB,EAAM,GAAKwC,EAAO,GACjDxC,EAAM,GAAKwC,EAAO,GAAKolB,EAAS5nB,EAAM,GAAKwC,EAAO,IAYtD,SAAgB8rC,GACdtiC,EACAuiC,OAEMC,EAAYxiC,EAAIgY,eAAerO,YAG/B84B,EAAaN,GAAYK,EADjB,EAAE,GAAI,GAAI,GAAI,GAAGxiC,IAAG,SAAC0iC,GAAK,MADtB,IACsBA,KAQxC,OAAQC,EAAAA,eAAwBF,EAAYF,GAa9C,SAAgBK,GACd5iC,EACAuiC,EACA1I,GAIAA,EAAYA,GAAwB,SAC9B2I,EAAYxiC,EAAIgY,eAAerO,YAC/Bk5B,EAAgBC,EAAAA,QAAiBN,GACjCO,EAAqBD,EAAAA,QAAiBP,GAE5C,QAA2B,IAAvBQ,GAA2D,GAA/B/iC,EAAIgY,eAAegrB,YAI5CD,EAAqBF,EAAgBhJ,EAY9C,SAAgByB,GACdt7B,EACAo6B,EACAxB,EACA5kC,EACA6lC,QAFA,IAAAjB,IAAAA,EAAwBoB,GAAc7qB,aAIhCozB,EAAiBP,GAAwBhiC,EAAKo6B,GAChDqI,EAAaF,EACbvuC,IAAUiB,YACZwtC,EAAaN,GAAYM,EAAYzuC,IAGnC4kC,IAAWoB,GAAc9qB,KAC3BlP,EAAIgY,eAAeirB,aAAaR,GACvB7J,IAAWoB,GAAc/qB,KAClCjP,EAAIgY,eAAekrB,aAAaT,GACvB7J,IAAWoB,GAAc7qB,UAEhCmzB,GAAqBtiC,EAAKuiC,IAC1BK,GAAyB5iC,EAAKuiC,EAAgB1I,KAE9C75B,EAAIgY,eAAeirB,aAAaR,GAoBtC,SAAgBU,GAAkB5K,EAAqBzqC,GACjDyqC,EAAMzqC,QAAUmH,YAOpBnH,EAAQA,GAEJ,IAAI0vB,GAAY,CACd3O,OAAQ,IAAIpa,KAElB8jC,EAAMkC,UAAU3sC,IACZyqC,EAAMzqC,MAAMkS,MAAQ/K,WACtBsjC,EAAMv4B,IAAIy/B,SAASlH,EAAMzqC,OAU7B,SAAgBs1C,GACd7K,EACAr0B,GAEIq0B,EAAM8K,kBAAkBhL,MAAiCpjC,WAK7DiP,EAAWA,GAAsB,IAAIm0B,GAA4B,IACjEE,EAAM+K,YAAYp/B,GAClBA,EAAS23B,YANPtD,EAAMgL,uBAAuBlL,IAejC,SAAgBmL,GACdjL,EACAr0B,GAEIq0B,EAAM8K,kBAAkB1H,MAAmC1mC,WAI/DiP,EAAWA,GAEP,IAAIy3B,GAA8B,CAChC37B,IAAKu4B,EAAMv4B,MAEjBu4B,EAAM+K,YAAYp/B,GAClBA,EAAS23B,YATPtD,EAAMgL,uBAAuB5H,IAkBjC,SAAgBV,GACdpsB,EACAje,OAKM6yC,EAAgB,IAAIxJ,IAC1BrpC,EAAOyH,QAAO,SAAEyqB,GACd2gB,EAActqB,IAAI2J,EAAU5U,QAAS4U,SAGjC4gB,EAAqB,GAC3B70B,EAAOxW,QAAO,SAAEyqB,OACR6gB,EAAeF,EAAc99B,IAAImd,EAAU5U,SAC7Cy1B,IAAiB1uC,UACnByuC,EAAmBzxC,KAAK6wB,GAExB6gB,EAAah+B,IAAI,qBAAuBmd,EAAUnd,IAAI,mBAEtD+9B,EAAmBzxC,KAAK6wB,GAExB2gB,EAAclK,UAAOoK,EAAaz1B,eAIhC01B,EAAqBn0C,MAAM+3B,KAAKic,EAAcje,QAKpD,MAAO,CACL4V,IALsBxqC,EAAO4G,OAAM,SAAEsrB,GACrC,OAAwD,GAAjD8gB,EAAmBplC,QAAQskB,EAAU5U,WAK5CgtB,OAAQwI,GChdZ,IAAAG,IAgBEv2C,OAAAC,eACIs2C,GAAAj3C,UAAA,UAAO,KACX,WAAqC,OAAOY,KAAKs2C,SAASp2C,WAF1D,SACYA,GAA8BF,KAAKs2C,SAASlyC,KAAKlE,oCAkB7Dm2C,GAAAj3C,UAAAm3C,SAAA,SAASv4B,OACD3Y,EAAUrF,KAAKw2C,kBAAkBx4B,GACvChe,KAAKy2C,WAAW3Z,KAAKz3B,IAGvBgxC,GAAAj3C,UAAAqY,QAAA,WACE,OAAOzX,KAAKw2C,kBAAkBx2C,KAAK02C,QAAQj/B,YAQrC4+B,GAAAj3C,UAAAo3C,kBAAR,SAA0Bx4B,OAClB5J,EAAa,GACbs+B,EAAO,GACT1yC,KAAKqF,UAAYoC,UACnB,EAAcZ,GAAKT,GAAAA,QAEnBtG,OAAO2C,OAAO2R,EAAYpU,KAAKqF,QAAQ+O,YACvCtU,OAAO2C,OAAOiwC,EAAM1yC,KAAKqF,QAAQqtC,KAAM,CACrCqB,SAAUvB,GAAAA,kBAAkBxyC,KAAKqF,SAAW,SAI1CsxC,EAAiB,cACvB72C,OAAOksC,QAAQhuB,GAAMnT,QAAO,SAAE+rC,GACtB,IAAA9xB,EAAAxgB,GAAAsyC,EAAA,GAACvzC,EAAAyhB,EAAA,GAAK5kB,EAAA4kB,EAAA,GACZ,GAAIzhB,EAAIywC,WAAW6C,GAAiB,KAC5Br9B,EAAWjW,EAAIya,OAAO64B,EAAe5zC,QAC3CqR,EAAWkF,GAAYpZ,SAIvBkL,EAAW4S,EAAK5S,SAKpB,OAJIA,IAAa3D,WAAazH,KAAKqF,UAAYoC,YAC7C2D,EAAWpL,KAAKqF,QAAQ+F,UAGnB,CACLsnC,KAAI,EACJjtC,KAAM8b,GACNnW,SAAQA,EACRud,WAAY,YACZvU,WAAUA,yBAhFf5T,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,mBACVC,SAAA,8PAEAC,gBAAiBC,GAAAA,wBAAwBC,sIAOxCC,GAAAA,uBAKAA,GAAAA,0BAQAs8B,GAAAA,wBAEAyZ,GAAAA,UAASl3C,KAAA,CAAC,cAyDb02C,IAvDE,SAAAA,KATSr2C,KAAAs2C,SAAqC,IAAIrrB,GAAAA,gBAAgBxjB,WAKxDzH,KAAAy2C,WAAa,IAAIjZ,GAAAA,aC3B7B,QAcE19B,OAAAC,eAAI+2C,GAAA13C,UAAA,aAAU,KAAd,WACE,OAAOY,KAAKM,MAAgB,4CAY9Bw2C,GAAA13C,UAAA+qB,OAAA,SAAO3X,GACDA,IAAQ/K,UACNzH,KAAKwS,MAAQ/K,WACfzH,KAAKwS,IAAI1L,GAAGwgC,YAAYtnC,KAAKM,MAAMwG,IAGrC0L,EAAI1L,GAAGmrC,SAASjyC,KAAKM,MAAMwG,IAE7B9G,KAAKwS,IAAMA,GASbskC,GAAA13C,UAAA80B,YAAA,SACEvb,EACAyyB,EACAuH,WAEA,QAHA,IAAAvH,IAAAA,EAAwBoB,GAAc7qB,SAGlCgxB,MACF,IAAwB,IAAAzzB,EAAA1B,GAAAxd,KAAKipB,WAAWniB,GAAG+lC,eAAa1tB,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAArD,IAAMkxB,EAASnW,EAAAjf,MACdo1B,EAAUnd,IAAI,eAAiBw6B,GACjC3yC,KAAK+2C,gBAAgBzhB,6GAIzBt1B,KAAK6gB,QAEP7gB,KAAK+tC,YAAYp1B,EAAUyyB,IAQ7B0L,GAAA13C,UAAAwhB,WAAA,SAAWvb,EAAkB+lC,QAAA,IAAAA,IAAAA,EAAwBoB,GAAc7qB,SACjE3hB,KAAK+tC,YAAY,CAAC1oC,GAAU+lC,IAQ9B0L,GAAA13C,UAAA2uC,YAAA,SACEp1B,EACAyyB,GAFF,IAAAzgC,EAAA3K,UAEE,IAAAorC,IAAAA,EAAwBoB,GAAc7qB,aAEhCirB,EAAa,GACnBj0B,EAAS9N,QAAO,SAAExF,OACViwB,EAAY8X,GAAY/nC,EAASsF,EAAK6H,IAAImW,YAE7B,OADA2M,EAAUtE,eAI7B4b,EAAWnoC,KAAK6wB,KAGlBt1B,KAAKg3C,cAAcpK,EAAYxB,IAQjC0L,GAAA13C,UAAA63C,aAAA,SACE3hB,EACA8V,QAAA,IAAAA,IAAAA,EAAwBoB,GAAc7qB,SAEtC3hB,KAAKg3C,cAAc,CAAC1hB,GAAY8V,IAQlC0L,GAAA13C,UAAA43C,cAAA,SACEpK,EACAxB,QAAA,IAAAA,IAAAA,EAAwBoB,GAAc7qB,SAEtC3hB,KAAKipB,WAAWniB,GAAGinC,YAAYnB,GAC/BkB,GAAiB9tC,KAAKwS,IAAKo6B,EAAYxB,IAOzC0L,GAAA13C,UAAAuhB,cAAA,SAActb,GACZrF,KAAKk3C,eAAe,CAAC7xC,KAOvByxC,GAAA13C,UAAA83C,eAAA,SAAev+B,GAAf,IAAAhO,EAAA3K,KACE2Y,EAAS9N,QAAO,SAAExF,GACZA,EAAQqtC,MACN/nC,EAAKse,WAAWniB,GAAG2Z,eAAepb,EAAQqtC,KAAK7rC,KACjD8D,EAAKosC,gBAAgBpsC,EAAKse,WAAWniB,GAAG2Z,eAAepb,EAAQqtC,KAAK7rC,QAU5EiwC,GAAA13C,UAAA23C,gBAAA,SAAgBzhB,GACdt1B,KAAKipB,WAAWniB,GAAG6Z,cAAc2U,IAMnCwhB,GAAA13C,UAAAyhB,MAAA,WACE7gB,KAAKipB,WAAWniB,GAAG+Z,SAEvBi2B,IAvIE,SAAAA,GAAYtkC,GACVxS,KAAKM,MAAQy0B,KACb/0B,KAAKmqB,OAAO3X,GCnChB,IAAA8E,GAAA6/B,IAAkCnwC,GAAAA,GAAlCsQ,GAAkCyU,GAAAA,SAUhCorB,GAAA/3C,UAAA6sB,MAAA,aAEAkrB,GAAA/3C,UAAAitB,QAAA,WAAA,IAAA1hB,EAAA3K,KACEA,KAAK2F,OAAOkF,QAAO,SAACvK,GAAS,OAAAqK,EAAKysC,aAAa92C,IAAQN,OAGzDm3C,GAAA/3C,UAAAi4C,WAAA,SAAW/2C,GAAX,IAAAqK,EAAA3K,KACE,GAAIM,EAAMuvB,UAAYpoB,UAAtB,CAIAzH,KAAK2F,OAAOlB,KAAKnE,OAEXg3C,EAAUh3C,EAAMuvB,QACnBzE,KAAKmsB,GAAAA,wBACL5/B,UAAS,SAACpH,GACLA,IAAWmc,GAAAA,cAAcC,QAC3BhiB,EAAK8hB,SAAW,EACPlc,IAAWmc,GAAAA,cAAcK,OAClCpiB,EAAKmiB,QAAU,GAGbniB,EAAKmiB,QAAUniB,EAAK8hB,SACtB9hB,EAAK8hB,QAAU9hB,EAAKmiB,OAAS,EAC7BniB,EAAK4F,OAASmc,GAAAA,cAAcK,MACJ,EAAfpiB,EAAK8hB,UACd9hB,EAAK4F,OAASmc,GAAAA,cAAcC,WAIlC3sB,KAAKw3C,cAAc/yC,KAAK6yC,KAG1BH,GAAA/3C,UAAAg4C,aAAA,SAAa92C,GACXA,EAAMuvB,QAAQzrB,KAAKsoB,GAAAA,cAAcK,UAC3Bhc,EAAQ/Q,KAAK2F,OAAOqL,QAAQ1Q,GAClC,GAAa,GAATyQ,EAAY,KACR0mC,EAAS,EAAe3oB,QAAQve,QAEgC,IAApE,CAACmc,GAAAA,cAAcC,QAASD,GAAAA,cAAcgrB,SAAS1mC,QAAQymC,KAEvDz3C,KAAK8sB,QAAU,GAEjB9sB,KAAKw3C,cAAczmC,GAAO2Z,cAC1B1qB,KAAKw3C,cAAc3qB,OAAO9b,EAAO,GACjC/Q,KAAK2F,OAAOknB,OAAO9b,EAAO,GAC1B,EAAe+d,QAAQzC,YAG7B8qB,IArDE,SAAAA,KAAA,IAAAxsC,EACE2M,GAAAtU,KAAAhD,OAAOA,YAND2K,EAAAmiB,OAAS,EACTniB,EAAA8hB,QAAU,EACV9hB,EAAAhF,OAAkB,GAClBgF,EAAA6sC,cAAgC,aCTxC/1B,KAAA,EACAC,KAAA,yCCIF,QAgBEi2B,GAAAv4C,UAAAw4C,SAAA,WACE,OAAO53C,KAAK63C,OAOdF,GAAAv4C,UAAA04C,SAAA,SAASD,GACP,GAAIA,IAAUpwC,WAAazH,KAAK43C,aAAenwC,UAC7C,MAAM,IAAIC,MAAM,8CAGlB,GAAImwC,IAAUpwC,UAGZ,OAFAzH,KAAK+3C,yBACL/3C,KAAK63C,MAAQA,GAIf73C,KAAK63C,MAAQA,GAMfF,GAAAv4C,UAAA24C,kBAAA,WACE/3C,KAAKg4C,aAAantC,QAAO,SAAExH,GAAgB,OAAAivB,GAAAA,QAAQjvB,KACnDrD,KAAKg4C,aAAe,IAGxBL,IA9CA,SAAAA,KAUY33C,KAAAg4C,aAAyB,GCOrC,WAAuChxC,GAAAA,MAAA2wC,IA4CrC73C,OAAAC,eAAIk4C,GAAA74C,UAAA,eAAY,KAAhB,WACE,QAAOY,KAAKO,UAAwC,IAA9BP,KAAKO,QAAQ23C,8CAMrCp4C,OAAAC,eAAIk4C,GAAA74C,UAAA,SAAM,KAAV,WACE,OAAOY,KAAK63C,MAAMjlB,2CAWpBqlB,GAAA74C,UAAA04C,SAAA,SAASD,GACPvgC,GAAAlY,UAAM04C,SAAQ90C,KAAAhD,KAAC63C,GACf73C,KAAKm4C,kBAMPF,GAAA74C,UAAA+4C,eAAA,WAAA,IAAAxtC,EAAA3K,MAC4B,IAAtBA,KAAKk4C,cACPl4C,KAAKg4C,aAAavzC,KAChBzE,KAAK63C,MAAM3rB,GAAG,UAAS,SAAG7L,GAAsB,OAAA1V,EAAKytC,UAAU/3B,MAInErgB,KAAKq4C,SAAWr4C,KAAKs4C,QAClBltB,KAAK6d,GAAAA,aAAa,KAClBtxB,UAAS,SAAEzX,GACVyK,EAAK4tC,UAAUr4C,EAAM8I,OAAQ9I,EAAMi0B,WAOzC8jB,GAAA74C,UAAA24C,kBAAA,WACEzgC,GAAAlY,UAAM24C,kBAAiB/0C,KAAAhD,MACnBA,KAAKq4C,WAAa5wC,YACpBzH,KAAKq4C,SAAS3tB,cACd1qB,KAAKq4C,SAAW5wC,YAQpBwwC,GAAA74C,UAAAo5C,gBAAA,WACE,OAAOx4C,KAAKy4C,OAAOC,iBAQrBT,GAAA74C,UAAAu5C,UAAA,SAAUhwB,OACJhC,EAAS3mB,KAAKy4C,OAAOE,YAIzB,OAHIhwB,GAAchC,IAChBA,EAASX,GAAAA,UAAiBW,EAAQ3mB,KAAKw4C,kBAAmB7vB,IAErDhC,GAQTsxB,GAAA74C,UAAA+c,UAAA,SAAUwM,OACJ3f,EAAShJ,KAAKy4C,OAAOG,gBAAgB54C,KAAK63C,MAAMhD,WAQpD,OAPIlsB,GAAc3f,IAChBA,EAASsrC,GAAAA,gBACPtrC,EACAhJ,KAAKw4C,kBACL7vB,IAGG3f,GAQTivC,GAAA74C,UAAA0/B,SAAA,SAASzjB,GACP,YADO,IAAAA,IAAAA,EAAA,IACA0L,GACL/mB,KAAK2qB,gBACL3qB,KAAKw4C,kBAAkBK,WACvBx9B,IAQJ48B,GAAA74C,UAAAurB,cAAA,WACE,OAAO3qB,KAAKy4C,OAAO9tB,iBAOrBstB,GAAA74C,UAAAo2C,QAAA,WACE,OAAO56B,KAAKiM,MAAM7mB,KAAKy4C,OAAOjD,YAMhCyC,GAAA74C,UAAA05C,OAAA,WACE94C,KAAK+4C,OAAO/4C,KAAKy4C,OAAOjD,UAAY,IAMtCyC,GAAA74C,UAAA45C,QAAA,WACEh5C,KAAK+4C,OAAO/4C,KAAKy4C,OAAOjD,UAAY,IAOtCyC,GAAA74C,UAAA25C,OAAA,SAAOtyB,GACLzmB,KAAKy4C,OAAOQ,mBACZj5C,KAAKy4C,OAAO7nB,QAAQ,CAClBnK,KAAIA,EACJ2K,SAAU,IACV8nB,OAAQC,EAAAA,WASZlB,GAAA74C,UAAAs2C,aAAA,SAAa1sC,GACXhJ,KAAKs4C,QAAQl0C,KAAK,CAAE4E,OAAMA,EAAEmrB,OAAQilB,GAAc33B,QAQpDw2B,GAAA74C,UAAAq2C,aAAA,SAAazsC,GACXhJ,KAAKs4C,QAAQl0C,KAAK,CAAE4E,OAAMA,EAAEmrB,OAAQilB,GAAc13B,QAOpDu2B,GAAA74C,UAAAi6C,YAAA,WACE,OAAOr5C,KAAKy4C,OAAOY,eAMrBpB,GAAA74C,UAAAk6C,cAAA,WACEt5C,KAAKy4C,OAAO7nB,QAAQ,CAAE2oB,SAAU,KAOlCtB,GAAA74C,UAAAo6C,iBAAA,WACE,OAA4B,EAArBx5C,KAAKy5C,OAAO12C,QAAgC,EAAlB/C,KAAK05C,YAOxCzB,GAAA74C,UAAAu6C,aAAA,WACE,OAA4B,EAArB35C,KAAKy5C,OAAO12C,QAAc/C,KAAK05C,WAAa15C,KAAKy5C,OAAO12C,OAAS,GAM1Ek1C,GAAA74C,UAAAw6C,cAAA,WACM55C,KAAKw5C,oBACPx5C,KAAK65C,cAAc75C,KAAK05C,WAAa,IAOzCzB,GAAA74C,UAAA06C,UAAA,WACM95C,KAAK25C,gBACP35C,KAAK65C,cAAc75C,KAAK05C,WAAa,IAOzCzB,GAAA74C,UAAA26C,kBAAA,WACE/5C,KAAKy5C,OAAS,GACdz5C,KAAK05C,WAAa,GAMpBzB,GAAA74C,UAAA46C,gBAAA,WAC2B,EAArBh6C,KAAKy5C,OAAO12C,QACd/C,KAAK65C,cAAc,IAUf5B,GAAA74C,UAAAm5C,UAAR,SACEvvC,EACAmrB,EACAhE,QAAA,IAAAA,IAAAA,GAAA,OAEMsoB,EAASz4C,KAAKy4C,OACpBA,EAAOQ,uBACD7nB,EAAWjB,EAAY,IAAM,EAC7B1J,EAAOgyB,EAAOjD,UAEdyE,EAAaxB,EAAOE,YACpBuB,EAAW,CACflxC,EAAO,IAAMA,EAAO,GAAKA,EAAO,IAAM,EACtCA,EAAO,IAAMA,EAAO,GAAKA,EAAO,IAAM,GAElCmxC,EAAav/B,KAAKw/B,KACtBx/B,KAAK6B,IAAIw9B,EAAW,GAAKC,EAAS,GAAI,GACpCt/B,KAAK6B,IAAIw9B,EAAW,GAAKC,EAAS,GAAI,IAEpCG,EAAa5B,EAAOG,kBACpB0B,EAAW1/B,KAAKw/B,KACpBx/B,KAAK6B,IAAI49B,EAAW,GAAKA,EAAW,GAAI,GACtCz/B,KAAK6B,IAAI49B,EAAW,GAAKA,EAAW,GAAI,IAMtCE,EAAQJ,IAJCv/B,KAAKw/B,KAClBx/B,KAAK6B,IAAIzT,EAAO,GAAKA,EAAO,GAAI,GAAK4R,KAAK6B,IAAIzT,EAAO,GAAKA,EAAO,GAAI,IAE7CsxC,GAAY,GAGhCE,EACJrmB,IAAWilB,GAAc33B,MAAQgF,EAAOzmB,KAAKy6C,gBACzCh0B,EACAzmB,KAAKy6C,gBAEXhC,EAAOiC,IAAI1xC,EAAQ,CACjBwxC,QAAOA,EACPG,QAAS36C,KAAK26C,QACdvpB,SAAkB,EAARmpB,EAAY,EAAInpB,KAQtB6mB,GAAA74C,UAAAy6C,cAAR,SAAsB9oC,GACpB/Q,KAAK05C,WAAa3oC,EAClB/Q,KAAK46C,SAAS56C,KAAKy5C,OAAO1oC,KAOpBknC,GAAA74C,UAAAw7C,SAAR,SAAiBhf,GACf57B,KAAKy4C,OAAO7nB,QAAQ,CAClBpa,WAAYolB,EAAMplB,WAClBmQ,OAAQiV,EAAMjV,OACdyK,SAAU,KAQN6mB,GAAA74C,UAAAg5C,UAAR,SAAkB/3B,OACV7J,EAAaxW,KAAK2qB,gBACpB3qB,KAAKyqB,YAAYvqB,QAAUsW,GAC7BxW,KAAKyqB,YAAYrmB,KAAKoS,OAGlBolB,EAAQ,CACZplB,WAAUA,EACVmQ,OAAQ3mB,KAAK24C,YACblyB,KAAMzmB,KAAKw1C,WAGb,IAA0B,IAAtBx1C,KAAKk4C,aAAuB,KACxBwB,EAAa15C,KAAK05C,WAGnBpzB,GAAmBsV,EADC,IAAvB57B,KAAKy5C,OAAO12C,OAAe0E,UAAYzH,KAAKy5C,OAAOC,MAEnD15C,KAAKy5C,OAASz5C,KAAKy5C,OAAO1iB,MAAM,EAAG2iB,EAAa,GAAG90C,OAAO,CAACg3B,IAC3D57B,KAAK05C,WAAa15C,KAAKy5C,OAAO12C,OAAS,GAI3C/C,KAAK66C,OAAOz2C,KAAKw3B,IAErBqc,IA5TE,SAAAA,GAAoB13C,GAApB,IAAAoK,EACE2M,GAAAtU,KAAAhD,OAAOA,YADW2K,EAAApK,QAAAA,EAnDpBoK,EAAA8f,YAAc,IAAIQ,GAAAA,gBAAwBxjB,WAK1CkD,EAAAkwC,OAAS,IAAI5vB,GAAAA,gBAA8BxjB,WAK3CkD,EAAAgwC,QAAU,CAAC,EAAG,EAAG,EAAG,GAKpBhwC,EAAA8vC,gBAAkB,GAKV9vC,EAAA2tC,QAAU,IAAIwC,GAAAA,QAUdnwC,EAAA8uC,OAAyB,GAKzB9uC,EAAA+uC,WAAqB,IC5B/B,QA0BE55C,OAAAC,eAAIg7C,GAAA37C,UAAA,SAAM,KAAV,WACE,OAAOY,KAAKk7B,QAAQh7B,uCAGtBJ,OAAAC,eAAIg7C,GAAA37C,UAAA,aAAU,KAAd,WACE,OAAOY,KAAKwqB,eAAeguB,kBAAkBhvC,2CAW/CuxC,GAAA37C,UAAA47C,KAAA,eACQC,EAAW,GACjB,GAAIj7C,KAAKO,QAAQ06C,SAAU,CACzB,GAAIj7C,KAAKO,QAAQ06C,SAASC,YAAa,KAC/BC,GAAwD,IAAtCn7C,KAAKO,QAAQ06C,SAASC,YAC1C,GACAl7C,KAAKO,QAAQ06C,SAASC,YAC1BD,EAASx2C,KAAK,IAAI22C,EAAqBD,IAEzC,GAAIn7C,KAAKO,QAAQ06C,SAASI,UAAW,KAC7BC,GAAoD,IAApCt7C,KAAKO,QAAQ06C,SAASI,UACxC,GACAr7C,KAAKO,QAAQ06C,SAASI,UAC1BJ,EAASx2C,KAAK,IAAI82C,EAAmBD,SAGrCE,EAAe,IACe,IAA9Bx7C,KAAKO,QAAQi7C,eACfA,EAAe,CACbC,oBAAoB,EACpBC,iBAAiB,EACjBC,UAAU,EACVC,gBAAgB,EAChBC,eAAe,EACfC,SAAS,EACTC,aAAa,EACbC,WAAW,IAIfh8C,KAAK8G,GAAK,IAAI+wC,EAAM,CAClB2D,aAAcS,GAAAA,SAAuBT,GACrCP,SAAQA,IAGVj7C,KAAKk8C,QAAQl8C,KAAKO,QAAQqrC,MAAQ,IAClC5rC,KAAKwqB,eAAiB,IAAIytB,GAAkB,CAC1CC,cAAc,IAEhBl4C,KAAKwqB,eAAestB,SAAS93C,KAAK8G,IAClC9G,KAAKm8C,QAAU,IAAIrF,GAAQ92C,MAC3BA,KAAKo8C,OAAS,IAAItF,GAAQ92C,OAG5B+6C,GAAA37C,UAAAq0B,UAAA,SAAU5sB,GACR7G,KAAK8G,GAAG2sB,UAAU5sB,GACdA,IAAOY,UACTzH,KAAKq8C,aAAa1kC,UAAS,aAAW,MAEtC3X,KAAKq8C,aAAa3xB,eAItBqwB,GAAA37C,UAAAg0B,WAAA,SAAW7yB,OACH+7C,EAAct8C,KAAK8G,GAAG8rB,UACtB2pB,EAAcz8C,OAAO2C,OACzB,CACEgkB,KAAM61B,EAAY9G,WAEpB8G,EAAYljC,iBAGdpZ,KAAKk8C,QAAQp8C,OAAO2C,OAAO85C,EAAah8C,IACpCA,EAAQk6C,kBACVz6C,KAAKwqB,eAAeiwB,gBAAkBl6C,EAAQk6C,kBAQlDM,GAAA37C,UAAA88C,QAAA,SAAQ37C,GACFP,KAAKwqB,iBAAmB/iB,WAC1BzH,KAAKwqB,eAAeuvB,wBAGhBnO,EAAO,IAAI6M,EAAOl4C,GAIxB,GAHAP,KAAK8G,GAAGo1C,QAAQtQ,GAEhB5rC,KAAKw8C,uBACDj8C,EAAS,CACX,GAAIA,EAAQomB,OAAQ,KACZgC,EAAaijB,EAAK8M,gBAAgBlvC,UAClCmd,EAAS81B,GAAAA,WAAkBl8C,EAAQomB,OAAQgC,GACjDijB,EAAK/Y,UAAUlM,GAGbpmB,EAAQm8C,WACV18C,KAAK08C,WAAU,GAGbn8C,EAAQo8C,iBACV38C,KAAK28C,gBAAiB,KAS5B5B,GAAA37C,UAAAu5C,UAAA,SAAUhwB,GACR,OAAO3oB,KAAKwqB,eAAemuB,UAAUhwB,IAOvCoyB,GAAA37C,UAAA+c,UAAA,SAAUwM,GACR,OAAO3oB,KAAKwqB,eAAerO,UAAUwM,IAIvCoyB,GAAA37C,UAAAo2C,QAAA,WACE,OAAOx1C,KAAKwqB,eAAegrB,WAG7BuF,GAAA37C,UAAAw9C,gBAAA,SAAgBvzB,WACd,GAAKA,EAAL,KAIA,IAAiB,IAAAnK,EAAA1B,GAAAxd,KAAK68C,iBAAe19B,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAxB+a,EAAAjf,MACRmd,SAAU,sGAGfgM,EAAUhM,SAAU,EAEpBrd,KAAKwqB,eAAeiuB,OAAOqE,WACzBzzB,EAAUJ,WAAW1oB,QAAQw8C,UAAY/8C,KAAKO,QAAQqrC,MAAQ,IAAImR,SAEpE/8C,KAAKwqB,eAAeiuB,OAAOuE,WACzB3zB,EAAUJ,WAAW1oB,QAAQi6C,UAAYx6C,KAAKO,QAAQqrC,MAAQ,IAAI4O,WAItEO,GAAA37C,UAAAy9C,cAAA,WACE,OAAO78C,KAAK2F,OAAOqE,OAAM,SAAE1J,GAAiB,OAAoB,IAApBA,EAAM+oB,aAGpD0xB,GAAA37C,UAAA69C,aAAA,SAAap2C,GACX,OAAO7G,KAAK2F,OAAOmJ,KAAI,SAAExO,GAAiB,OAAAA,EAAMuG,IAAMvG,EAAMuG,KAAOA,KAGrEk0C,GAAA37C,UAAA89C,gBAAA,SAAgBrlC,GACd,OAAO7X,KAAK2F,OAAOmJ,KAAI,SACpBxO,GAAiB,OAAAA,EAAMuX,OAASvX,EAAMuX,QAAUA,KASrDkjC,GAAA37C,UAAA6yC,SAAA,SAAS3xC,EAAcmE,QAAA,IAAAA,IAAAA,GAAA,GACrBzE,KAAKm9C,UAAU,CAAC78C,KAQlBy6C,GAAA37C,UAAA+9C,UAAA,SAAUx3C,EAAiBlB,GAA3B,IAAAkG,EAAA3K,UAA2B,IAAAyE,IAAAA,GAAA,OACrB24C,EAAe,EACfC,EAAwB,EACtBC,EAAc33C,EACjB6M,IAAG,SAAElS,OACEi9C,EAASj9C,EAAM6oB,OACjB,EACA7oB,EAAM+oB,UACNg0B,IACAD,IACJ,OAAOzyC,EAAK6yC,WAAWl9C,EAAOi9C,KAE/BvzC,OAAM,SAAE1J,GAA6B,OAAAA,IAAUmH,YAClDzH,KAAKy9C,UAAU,GAAG74C,OAAO5E,KAAK2F,OAAQ23C,KAOxCvC,GAAA37C,UAAAkoC,YAAA,SAAYhnC,GACVN,KAAKmnC,aAAa,CAAC7mC,KAOrBy6C,GAAA37C,UAAA+nC,aAAA,SAAaxhC,GAAb,IAAAgF,EAAA3K,KACQ09C,EAAY19C,KAAKk7B,QAAQh7B,MAAM62B,MAAM,GACrC4mB,EAAiB,GACvBh4C,EAAOkF,QAAO,SAAEvK,OACRyQ,EAAQ2sC,EAAU1sC,QAAQ1Q,GACnB,GAATyQ,IACF4sC,EAAel5C,KAAKnE,GACpBo9C,EAAU7wB,OAAO9b,EAAO,MAI5B4sC,EAAe9yC,QAAO,SAAEvK,GAAiB,OAAAqK,EAAKizC,cAAct9C,KAC5DN,KAAKy9C,UAAUC,IAMjB3C,GAAA37C,UAAAy+C,gBAAA,WAAA,IAAAlzC,EAAA3K,KACEA,KAAK2F,OAAOkF,QAAO,SAAEvK,GAAiB,OAAAqK,EAAKizC,cAAct9C,KACzDN,KAAKk7B,QAAQ92B,KAAK,KAGpB22C,GAAA37C,UAAA0+C,WAAA,SAAWx9C,OACHyQ,EAAQ/Q,KAAK+9C,cAAcz9C,GACrB,EAARyQ,GACF/Q,KAAKg+C,UAAU19C,EAAOyQ,EAAOA,EAAQ,IAIzCgqC,GAAA37C,UAAAklC,YAAA,SAAY3+B,eACV,IAAoB,IAAA+nB,EAAAlQ,GAAA7X,GAAMgoB,EAAAD,EAAAtpB,QAAAupB,EAAAtpB,KAAAspB,EAAAD,EAAAtpB,OAAE,CAAvB,IAAM9D,EAAKqtB,EAAAztB,MACdF,KAAK89C,WAAWx9C,0GAIpBy6C,GAAA37C,UAAA6+C,WAAA,SAAW39C,OACHyQ,EAAQ/Q,KAAK+9C,cAAcz9C,GAC7ByQ,EAAQ/Q,KAAK2F,OAAO5C,OAAS,GAC/B/C,KAAKg+C,UAAU19C,EAAOyQ,EAAOA,EAAQ,IAIzCgqC,GAAA37C,UAAAmmC,YAAA,SAAY5/B,WACJu4C,EAAgBv4C,EAAOoqC,cAC7B,IAAoB,IAAAoO,EAAA3gC,GAAA0gC,GAAaE,EAAAD,EAAA/5C,QAAAg6C,EAAA/5C,KAAA+5C,EAAAD,EAAA/5C,OAAE,CAA9B,IAAM9D,EAAK89C,EAAAl+C,MACdF,KAAKi+C,WAAW39C,0GAIpBy6C,GAAA37C,UAAA4+C,UAAA,SAAU19C,EAAc05B,EAAcqkB,OAC9BC,EAAUt+C,KAAK2F,OAAO04C,GACtBE,EAAWD,EAAQn1B,OACnBq1B,EAAal+C,EAAM6oB,OAErBm1B,EAAQj1B,WAAa/oB,EAAM+oB,YAI/B/oB,EAAM6oB,OAASo1B,EACfD,EAAQn1B,OAASq1B,EAEjBx+C,KAAK2F,OAAO04C,GAAM/9C,EAClBN,KAAK2F,OAAOq0B,GAAQskB,EACpBt+C,KAAKk7B,QAAQ92B,KAAKpE,KAAK2F,OAAOoxB,MAAM,MAS9BgkB,GAAA37C,UAAAo+C,WAAR,SAAmBl9C,EAAc88C,GAC3B98C,EAAM+oB,WAAa/oB,EAAM+c,SAC3Brd,KAAK48C,gBAAgBt8C,OAGjBm+C,EAAgBz+C,KAAKi9C,aAAa38C,EAAMuG,IAC9C,GAAI43C,IAAkBh3C,UAAtB,CASA,IAJKnH,EAAM+oB,WAAa/oB,EAAM6oB,SAC5B7oB,EAAM6oB,QAAU,IAGd7oB,EAAM6oB,SAAW1hB,WAA8B,IAAjBnH,EAAM6oB,OAAc,KAC9Cu1B,EAAY9jC,KAAK+jC,IAAG17C,MAAR2X,KAAIjW,GAAA,CACpBrE,EAAM+oB,UAAY,EAAI,IACnBrpB,KAAK2F,OACLqE,OAAM,SACL25B,GAAK,OAAAA,EAAEta,YAAc/oB,EAAM+oB,WAAasa,EAAExa,OAAS,MAEpD3W,IAAG,SAACmxB,GAAK,OAAAA,EAAExa,WAEhB7oB,EAAM6oB,OAASu1B,EAAY,EAAItB,EAWjC,OARI98C,EAAM+oB,WAA4B,EAAf/oB,EAAM6oB,SAC3B7oB,EAAM6oB,OAAS,IAGjB7oB,EAAM6pB,OAAOnqB,MACbA,KAAKq8C,aAAahF,WAAW/2C,GAC7BN,KAAK8G,GAAGmrC,SAAS3xC,EAAMwG,IAEhBxG,EA5BLm+C,EAAcphC,SAAU,GAmCpB09B,GAAA37C,UAAAw+C,cAAR,SAAsBt9C,GACpBN,KAAKq8C,aAAajF,aAAa92C,GAC/BN,KAAK8G,GAAGwgC,YAAYhnC,EAAMwG,IAC1BxG,EAAM6pB,OAAO1iB,YAOPszC,GAAA37C,UAAAq+C,UAAR,SAAkB93C,GAChB3F,KAAKk7B,QAAQ92B,KAAKpE,KAAK4+C,mBAAmBj5C,GAAQoxB,MAAM,KAQlDgkB,GAAA37C,UAAAw/C,mBAAR,SAA2Bj5C,GAEzB,OAAOA,EAAOu7B,KAAI,SACfC,EAAeC,GAAkB,OAAAA,EAAOjY,OAASgY,EAAOhY,UASrD4xB,GAAA37C,UAAA2+C,cAAR,SAAsBz9C,GACpB,OAAON,KAAK2F,OAAOo+B,UAAS,SAAE9jC,GAAkB,OAAAA,IAAWK,KAI7Dy6C,GAAA37C,UAAAs9C,UAAA,SAAUmC,GAAV,IAAAl0C,EAAA3K,UAAU,IAAA6+C,IAAAA,GAAA,OACJjf,GAAQ,EACR5/B,KAAK8+C,gBACPD,EAAQ7+C,KAAK++C,YAAYC,cACzBh/C,KAAKw8C,wBAEPx8C,KAAKi/C,mBAELj/C,KAAK8+C,cAAgB9+C,KAAKk/C,aAAavnC,UAAS,SAAConC,GAC/C,GAAKA,EAAL,CAIA,GADiBA,EAAYI,cACd,IAAO,KACd/zC,EAAW2zC,EAAYK,sBACvBp2C,EAASoC,EAAS+Q,YAwBxB,GAtBExR,EAAK00C,oBACL10C,EAAKwxC,QAAQlzB,WAAWniB,GAAG2Z,eACzB9V,EAAK00C,mBAAmB3+B,UAG1B/V,EAAKwxC,QAAQlzB,WAAWniB,GAAG6Z,cAAchW,EAAK00C,oBAG5C10C,EAAK20C,eACP30C,EAAKyxC,OAAOnzB,WAAWniB,GAAG6Z,cAAchW,EAAK20C,eAG/C30C,EAAK00C,mBAAqB,IAAI/pB,GAAU,CAAElqB,SAAQA,IAClDT,EAAK00C,mBAAmBjN,MAAM,uBACzBznC,EAAK40C,kBAAoB50C,EAAKgyC,eACjChyC,EAAKwxC,QAAQlF,aAAatsC,EAAK00C,mBAAoB7S,GAAchrB,MACxD7W,EAAK40C,kBAAoB50C,EAAKgyC,eACvChyC,EAAKwxC,QAAQlF,aAAatsC,EAAK00C,mBAAoB7S,GAAc/qB,MAEjE9W,EAAKwxC,QAAQlF,aAAatsC,EAAK00C,oBAG7B10C,EAAK7D,GAAG8rB,UAAU4sB,SAASpD,OAAQ,KAC/BzmB,EAAehrB,EAAK7D,GAAG8rB,UAAU4sB,SAASpD,OAAOzmB,aACjD8pB,EAAcV,EAAYW,cAChC/0C,EAAKg1C,WAAa,IAAIC,EAASH,EAAa9pB,OACtCkqB,EAAel1C,EAAK7D,GAAG8rB,UAAU4sB,SAASpD,OAAOyD,aACjDC,EAAan1C,EAAK7D,GAAG8rB,UAAU4sB,SAASpD,OAAO0D,WAEjDC,OAAU,EAEZA,EADEp1C,EAAK7D,GAAG8rB,UAAU4sB,SAASpD,OAAO4D,iBACvBrqB,EAAaoD,WAAa,IAE1B,GAGfpuB,EAAK20C,cAAgB,IAAIhqB,GAAU3qB,EAAKg1C,YACxCh1C,EAAK20C,cAAclN,MAAM,iBACzBznC,EAAK20C,cAAc3zB,IAAI,eAAgBk0B,GACvCl1C,EAAK20C,cAAc3zB,IAAI,aAAcm0B,GACrCn1C,EAAK20C,cAAc3zB,IAAI,aAAco0B,GACrCp1C,EAAKyxC,OAAOnF,aAAatsC,EAAK20C,cAAe9S,GAAchrB,MAEzDoe,IACFj1B,EAAK6f,eAAeirB,aAAazsC,GACjC2B,EAAK40C,kBAAoB50C,EAAK40C,uBAE3B,GAAI3f,EAAO,KACVgM,EAAOjhC,EAAK7D,GAAG8rB,UACf6sB,EAAcV,EAAYW,cAChC9T,EAAK/Y,UAAU4sB,GACf7T,EAAKqU,QAAQ,IAEXpB,IAAUl0C,EAAKgyC,gBACjBhyC,EAAK6xC,uBAEP5c,GAAQ,MAIZmb,GAAA37C,UAAAo9C,qBAAA,WACEx8C,KAAKkgD,kBACDlgD,KAAK8+C,gBACP9+C,KAAK8+C,cAAcp0B,cACnB1qB,KAAK8+C,cAAgBr3C,YAIjBszC,GAAA37C,UAAA6/C,iBAAR,WAAA,IAAAt0C,EAAA3K,KACOA,KAAK++C,YAaR/+C,KAAK++C,YAAYoB,aAAY,IAZ7BngD,KAAK++C,YAAc,IAAIqB,EAAc,CACnCC,gBAAiB,CACfC,oBAAoB,GAEtB33B,WAAY3oB,KAAK2oB,WACjB43B,UAAU,IAGZvgD,KAAK++C,YAAY7yB,GAAG,SAAQ,SAAEs0B,GAC5B71C,EAAKu0C,aAAa96C,KAAKuG,EAAKo0C,iBAO1BhE,GAAA37C,UAAA8gD,gBAAR,WACMlgD,KAAK++C,aACP/+C,KAAK++C,YAAYoB,aAAY,IAIjCpF,GAAA37C,UAAAqhD,gBAAA,SAAgBC,GACd1gD,KAAK2gD,qBAAqBv8C,KAAKs8C,IAEnC3F,IAjdE,SAAAA,GAAYx6C,GAhCLP,KAAA2gD,qBAAuB,IAAI11B,GAAAA,iBAAyB,GACpDjrB,KAAAk7B,QAAU,IAAIjQ,GAAAA,gBAAyB,IAGvCjrB,KAAAu/C,kBAA4B,EAC5Bv/C,KAAAk/C,aAAe,IAAIj0B,GAAAA,gBAA+BxjB,WAejDzH,KAAA4gD,eAAsC,CAC5C3F,SAAU,CAAEC,aAAa,IAYzBl7C,KAAKO,QAAUT,OAAO2C,OAAO,GAAIzC,KAAK4gD,eAAgBrgD,GACtDP,KAAKq8C,aAAe,IAAIlF,GACxBn3C,KAAK6vB,QAAU7vB,KAAKq8C,aAAaxsB,QACjCgxB,EAAAA,SAAiBC,GACjB9gD,KAAKg7C,OCzET,IAAA+F,IA6BEjhD,OAAAC,eAAIghD,GAAA3hD,UAAA,MAAG,KAAP,WACE,OAAOY,KAAKu0B,UAAU/hB,qCAYtBuuC,GAAA3hD,UAAAo0B,gBAAA,WAAA,IAAA7oB,EAAA3K,KACEA,KAAKwS,IAAImuC,qBAAqBhpC,UAAS,SAAEqpC,GACvCr2C,EAAKs2C,oBAAsBD,MACrB7hB,EAAYx0B,EAAKu0B,gBAAgBC,UACvC,GAAIx0B,EAAKs2C,qBAAuBt2C,EAAKu2C,aAAaC,WAAY,KACtDt7B,EAAUsZ,EAAUC,QAAQ,mCAC5BvtB,EAAQstB,EAAUC,QAAQ,iCAChCz0B,EAAKy2C,eAAeC,KAAKx7B,EAAShU,GAClClH,EAAK22C,mBAAmBH,YAAa,EACrCx2C,EAAK42C,mBACA,GAAK52C,EAAKs2C,qBAAwBt2C,EAAKu2C,aAAaC,YAMpD,IAAKx2C,EAAKs2C,qBAAuBt2C,EAAKu2C,aAAaC,WAAY,KAChEK,EACAC,EACEC,EAAaviB,EAAUhnB,IAAI,kCAC3BwpC,EAAWxiB,EAAUhnB,IAAI,gCAC/BupC,EAAW/pC,UAAS,SAAEiqC,GACpBJ,EAAUI,IAEZD,EAAShqC,UAAS,SAAEkqC,GAClBJ,EAAQI,IAEVl3C,EAAKy2C,eAAeC,KAAKG,EAASC,GAClC92C,EAAK22C,mBAAmBH,YAAa,EACrCx2C,EAAK42C,oBAlBC17B,EAAUsZ,EAAUC,QAAQ,mCAC5BvtB,EAAQstB,EAAUC,QAAQ,iCAChCz0B,EAAKy2C,eAAeC,KAAKx7B,EAAShU,GAClClH,EAAK22C,mBAAmBH,YAAa,EACrCx2C,EAAK42C,gBAkBTvhD,KAAK07B,eAAeC,eAAehkB,UAAS,SAAEikB,GAC5CjxB,EAAKu2C,aAAetlB,EACfjxB,EAAKs2C,qBACRt2C,EAAK42C,gBAITvhD,KAAKwS,IAAI0oB,QAAQvjB,UAAS,SAAEhS,GAC1BgF,EAAK42C,iBAIHR,GAAA3hD,UAAAmiD,YAAR,WAAA,IACMr6C,EADNyD,EAAA3K,KAEoBA,KAAKwS,IAAI0oB,QAAQh7B,MACzB2K,QAAO,SAACvK,GAChB,GAAIA,EAAMC,QAAQ8gB,kBAAkBN,GAClC7Z,EAAiB5G,EAAMC,QAAqB,cAC5CD,EAAMwG,GAAG6nB,YAAY9N,aAChB,GAAIvgB,EAAMC,QAAQ8gB,kBAAkBpZ,GACzCf,EAAiB5G,EAAMC,QAAqB,mBACvC,GAAID,EAAMC,QAAQ8gB,kBAAkBD,GACzCla,EAAiB5G,EAAMC,QAAqB,mBACvC,GAAID,EAAMC,QAAQ8gB,kBAAkBpa,GACzCC,EAAiB5G,EAAMC,QAAqB,kBACvC,CACL,IAAqC,IAAjCoK,EAAKu2C,aAAaC,aAA+D,IAAvCx2C,EAAK22C,mBAAmBH,WAEpE,YADA7gD,EAAMwG,GAAG4iB,iBAAiB,GAErB,IAAqC,IAAjC/e,EAAKu2C,aAAaC,aAA8D,IAAvCx2C,EAAK22C,mBAAmBH,WAE1E,YADA7gD,EAAMwG,GAAG4iB,iBAAiBC,UAK9B,GAAIziB,EACF,GAAIA,EAAc46C,cAAgD,IAAjCn3C,EAAKu2C,aAAaC,YACjDj6C,EAAc46C,cAAsD,IAAvCn3C,EAAK22C,mBAAmBH,WAAsB,CACzE,GAA2B,WAAvBj6C,EAAczB,MAA4C,YAAvByB,EAAczB,KACnD,OAEFnF,EAAMwG,GAAG6nB,YAAYozB,OAAO76C,EAAc46C,kBACvC,GAAI56C,EAAc46C,cAAgD,IAAjCn3C,EAAKu2C,aAAaC,YACxDj6C,EAAc46C,cAAsD,IAAvCn3C,EAAK22C,mBAAmBH,WAAqB,CACxE,GAA2B,WAAvBj6C,EAAczB,MAA4C,YAAvByB,EAAczB,KACnD,OAEFnF,EAAMwG,GAAG6nB,YAAYozB,OAAO76C,EAAczH,UAEP,IAAjCkL,EAAKu2C,aAAaC,aAA+D,IAAvCx2C,EAAK22C,mBAAmBH,WACpE7gD,EAAMwG,GAAG4iB,iBAAiB,IACgB,IAAjC/e,EAAKu2C,aAAaC,aAA8D,IAAvCx2C,EAAK22C,mBAAmBH,YAC1E7gD,EAAMwG,GAAG4iB,iBAAiBC,eAIO,IAAjChf,EAAKu2C,aAAaC,aAA+D,IAAvCx2C,EAAK22C,mBAAmBH,WACpE7gD,EAAMwG,GAAG4iB,iBAAiB,IACgB,IAAjC/e,EAAKu2C,aAAaC,aAA8D,IAAvCx2C,EAAK22C,mBAAmBH,YAC1E7gD,EAAMwG,GAAG4iB,iBAAiBC,kCAvHnCiL,GAAAA,UAASj1B,KAAA,CAAC,CACPc,SAAU,gEAZLyyB,UAHA+J,GAAAA,sBAAiC+kB,GAAAA,sBAAgBhiB,GAAAA,mBA0I1D+gB,IA1GE,SAAAA,GACExsB,EACQmH,EACA0lB,EACAliB,GAFAl/B,KAAA07B,eAAAA,EACA17B,KAAAohD,eAAAA,EACAphD,KAAAk/B,gBAAAA,EAhBFl/B,KAAAihD,qBAA+B,EAC/BjhD,KAAAkhD,aAAgC,CACtCC,YAAY,GAENnhD,KAAAshD,mBAAsC,CAC5CH,YAAY,GAaVnhD,KAAKu0B,UAAYA,EChBvB,IAAA0tB,IA+BEniD,OAAAC,eAAIkiD,GAAA7iD,UAAA,MAAG,KAAP,WACE,OAAOY,KAAKu0B,UAAU/hB,qCAGxB1S,OAAAC,eAAIkiD,GAAA7iD,UAAA,gBAAa,KAAjB,WACE,OAAQY,KAAKu0B,UAAa,IAAY5L,4CAYxCs5B,GAAA7iD,UAAAi0B,SAAA,WACErzB,KAAKkiD,yBACLliD,KAAK8uC,oBAOPmT,GAAA7iD,UAAAs0B,YAAA,WACE1zB,KAAKmiD,2BACLniD,KAAK2uC,sBAMCsT,GAAA7iD,UAAA8iD,uBAAR,WAAA,IAAAv3C,EAAA3K,KACEA,KAAKoiD,oBAAsBpiD,KAAKwS,IAAI1L,GAAGolB,GACrC,cAAa,SACZ7L,GAAoC,OAAA1V,EAAK03C,eAAehiC,EAAO1V,EAAK23C,yBAOjEL,GAAA7iD,UAAA0vC,iBAAR,WAAA,IAAAnkC,EAAA3K,KACEA,KAAK2vC,iBAAmB3vC,KAAKwS,IAAI1L,GAAGolB,GAClC,cAAa,SACZ7L,GAAoC,OAAA1V,EAAK03C,eAAehiC,EAAO,MAO5D4hC,GAAA7iD,UAAA+iD,yBAAR,WACEniD,KAAKwS,IAAI1L,GAAGwlB,GAAGtsB,KAAKoiD,oBAAoB38C,KAAMzF,KAAKoiD,oBAAoBvS,UACvE7vC,KAAKoiD,oBAAsB36C,WAMrBw6C,GAAA7iD,UAAAuvC,mBAAR,WACE3uC,KAAKwS,IAAI1L,GAAGwlB,GAAGtsB,KAAK2vC,iBAAiBlqC,KAAMzF,KAAK2vC,iBAAiBE,UACjE7vC,KAAK2vC,iBAAmBloC,WAOlBw6C,GAAA7iD,UAAAijD,eAAR,SAAuBhiC,EAAiCkiC,GAAxD,IAAA53C,EAAA3K,KACE,IAAIqgB,EAAMmiC,WAAYxiD,KAAKyiD,aAAaC,gBAAxC,CACuC,oBAA5B1iD,KAAK2iD,oBACdC,aAAa5iD,KAAK2iD,wBAGdE,EAASv9B,GAAAA,UAAUjF,EAAMyiC,WAAY9iD,KAAK+hB,cAAe,aAC/D/hB,KAAK2iD,mBAAqBhe,WAAU,WAClCh6B,EAAKo4C,qBAAqBjmB,KAAK+lB,IAC9BN,0BA/GN3tB,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,qEAVHyyB,GAAmB/vB,WAAA,CAAA,CAAAsC,KAiDvBovB,GAAAA,cA9CImuB,GAAAA,+DA0BNliD,GAAAA,oCAKAs8B,GAAAA,UAwFH6kB,IA1EE,SAAAA,GACkB1tB,EACRkuB,GADQziD,KAAAu0B,UAAAA,EACRv0B,KAAAyiD,aAAAA,EArBDziD,KAAAsiD,qBAA+B,IAK9BtiD,KAAA+iD,qBAAuB,IAAIvlB,GAAAA,aCvBvC,IAAAylB,IAwCEnjD,OAAAC,eAAIkjD,GAAA7jD,UAAA,MAAG,KAAP,WACE,OAAOY,KAAKu0B,UAAU/hB,qCAGxB1S,OAAAC,eAAIkjD,GAAA7jD,UAAA,gBAAa,KAAjB,WACE,OAAQY,KAAKu0B,UAAa,IAAY5L,4CAYxCs6B,GAAA7jD,UAAAi0B,SAAA,WACErzB,KAAKkiD,yBACLliD,KAAK8uC,mBACL9uC,KAAKkjD,qBACLljD,KAAKmjD,oBAOPF,GAAA7jD,UAAAs0B,YAAA,WACE1zB,KAAKmiD,2BACLniD,KAAK2uC,qBACL3uC,KAAKojD,uBACLpjD,KAAKqjD,sBAMCJ,GAAA7jD,UAAA8iD,uBAAR,WAAA,IAAAv3C,EAAA3K,KACEA,KAAKoiD,oBAAsBpiD,KAAKwS,IAAI1L,GAAGolB,GACrC,cAAa,SACZ7L,GAAoC,OAAA1V,EAAK03C,eAAehiC,EAAO1V,EAAK24C,8BAOjEL,GAAA7jD,UAAA0vC,iBAAR,WAAA,IAAAnkC,EAAA3K,KACEA,KAAK2vC,iBAAmB3vC,KAAKwS,IAAI1L,GAAGolB,GAClC,cAAa,SACZ7L,GAAoC,OAAA1V,EAAK03C,eAAehiC,EAAO,MAO5D4iC,GAAA7jD,UAAA8jD,mBAAR,WAAA,IAAAv4C,EAAA3K,KACEA,KAAKojD,uBACLpjD,KAAKujD,UAAYC,GAAAA,UAAUn2B,SAAU,WACpC1V,UAAS,SAAE0I,GAENA,EAAMojC,UAAY94C,EAAK+4C,0BACzB/4C,EAAKg5C,kBAAkBv/C,MAAK,MAQ1B6+C,GAAA7jD,UAAA+jD,iBAAR,WAAA,IAAAx4C,EAAA3K,KACEA,KAAKqjD,qBACLrjD,KAAK4jD,QAAUJ,GAAAA,UAAUn2B,SAAU,SAClC1V,UAAS,SAAE0I,GAENA,EAAMojC,UAAY94C,EAAK+4C,0BACzB/4C,EAAKg5C,kBAAkBv/C,MAAK,MAS1B6+C,GAAA7jD,UAAA+iD,yBAAR,WACEniD,KAAKwS,IAAI1L,GAAGwlB,GAAGtsB,KAAKoiD,oBAAoB38C,KAAMzF,KAAKoiD,oBAAoBvS,UACvE7vC,KAAKoiD,oBAAsB36C,WAMrBw7C,GAAA7jD,UAAAuvC,mBAAR,WACE3uC,KAAKwS,IAAI1L,GAAGwlB,GAAGtsB,KAAK2vC,iBAAiBlqC,KAAMzF,KAAK2vC,iBAAiBE,UACjE7vC,KAAK2vC,iBAAmBloC,WAMlBw7C,GAAA7jD,UAAAgkD,qBAAR,WACMpjD,KAAKujD,YAAc97C,YACrBzH,KAAKujD,UAAU74B,cACf1qB,KAAKujD,UAAY97C,YAObw7C,GAAA7jD,UAAAikD,mBAAR,WACMrjD,KAAK4jD,UAAYn8C,YACnBzH,KAAK4jD,QAAQl5B,cACb1qB,KAAK4jD,QAAUn8C,YASXw7C,GAAA7jD,UAAAijD,eAAR,SAAuBhiC,EAAiCkiC,GAAxD,IAAA53C,EAAA3K,KACE,IAAIqgB,EAAMmiC,WAAYxiD,KAAKyiD,aAAaC,kBACD,oBAA5B1iD,KAAK2iD,oBACdC,aAAa5iD,KAAK2iD,oBAGhB3iD,KAAK2jD,kBAAkBzjD,OAAO,KAC5B2jD,EAASv+B,GAAAA,UAAUjF,EAAMyiC,WAAY9iD,KAAK+hB,cAAe,aAC/D/hB,KAAK2iD,mBAAqBhe,WAAU,WAClCh6B,EAAKm5C,0BAA0BhnB,KAAK+mB,IACnCtB,0BA/KN3tB,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,0EAZHyyB,GAAmB/vB,WAAA,CAAA,CAAAsC,KA4DvBovB,GAAAA,cAxDImuB,GAAAA,oEA+BNliD,GAAAA,wCAKAA,GAAAA,yCAKAs8B,GAAAA,UAgJH6lB,IAlIE,SAAAA,GACkB1uB,EACRkuB,GADQziD,KAAAu0B,UAAAA,EACRv0B,KAAAyiD,aAAAA,EA3CFziD,KAAA2jD,kBAA8C,IAAI14B,GAAAA,iBAAgB,GAiBjEjrB,KAAAsjD,0BAAoC,IAKpCtjD,KAAA0jD,yBAAmC,GAKlC1jD,KAAA8jD,0BAA4B,IAAItmB,GAAAA,aC5C5C,IAAAumB,IAyCEA,GAAA3kD,UAAA4kD,mBAAA,SAAmBr7B,GACjBm4B,EAAMmD,KAAKt7B,EAAWV,KAAMU,EAAWu7B,KACvCrD,EAAAA,SAAiBC,GACbn4B,EAAW3f,QACbkT,GAAAA,IAAWyM,EAAWV,MAAMswB,UAAU5vB,EAAW3f,8BA7CtDtJ,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAVLukD,GAAAA,yJAcP,SAAAJ,GAAoB5mC,GAApB,IAAAxS,EAAA3K,KAAoBA,KAAAmd,OAAAA,GACEnd,KAAKmd,OAAOinC,UAAU,gBAAkB,IAChDv5C,QAAO,SAAE8d,GACnBA,EAAW9Q,MAAQ8Q,EAAW9Q,MAAQ8Q,EAAW9Q,MAAQ8Q,EAAWV,KACpEtd,EAAKq5C,mBAAmBr7B,KAI1B,IAAK,IAAIR,EAAU,EAAGA,EAAU,GAAIA,IAAW,KAGvClf,EAAmB,CAAEgf,KAFdE,EAAU,GAAK,YAAYA,EAAY,WAAWA,EAE9B+7B,IADrB,mBAAmB/7B,EAAO,kCACAnf,OAASvB,WAC/CzH,KAAKgkD,mBAAmB/6C,GAI1B,IAAK,IAAIsf,EAAU,EAAGA,EAAU,GAAIA,IAAW,CAWvCtf,EAAmB,CAAEgf,KAVdM,EAAU,GAAK,YAAYA,EAAY,YAAW,GAAKA,GAUnC27B,IADrB,gCAPR/+B,OAAOoD,IAAY,GACb,GAAuB,EAAlBpD,OAAOoD,GACQ,IAAnBpD,OAAOoD,IACR,GAA8B,GAAxBpD,OAAOoD,GAAW,KAExB,KAAyB,EAAlBpD,OAAOoD,IAEuB,uFACTvf,OAASvB,WAC/CzH,KAAKgkD,mBAAmB/6C,IChD9B,IAAAo7C,IAeEvkD,OAAAC,eAAIskD,GAAAjlD,UAAA,OAAI,KAAR,WAAqB,OAAOY,KAAKwS,IAAIgY,eAAegrB,2CAEpD11C,OAAAC,eAAIskD,GAAAjlD,UAAA,UAAO,KAAX,WAAwB,OAAOY,KAAKwS,IAAIgY,eAAeiuB,OAAO6L,cAAgB,mCAE9ExkD,OAAAC,eAAIskD,GAAAjlD,UAAA,UAAO,KAAX,WAAwB,OAAOY,KAAKwS,IAAIgY,eAAeiuB,OAAO8L,mEAf/D/jD,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,kBACVC,SAAA,wiCAKCI,GAAAA,qBAEAA,GAAAA,SASHujD,IADE,SAAAA,MCrBF,IAAAG,IAUE1kD,OAAAC,eACIykD,GAAAplD,UAAA,MAAG,KADP,WAEE,OAAOY,KAAK+hC,UAEd,SAAQ7hC,GACNF,KAAK+hC,KAAO7hC,mCAIdJ,OAAAC,eACIykD,GAAAplD,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKG,YAEd,SAAUD,GACRF,KAAKG,OAASD,wDApBjBM,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,uBACVC,SAAA,ulBAICI,GAAAA,qBASAA,GAAAA,SAUH0jD,IADE,SAAAA,MC5BF,IAAAC,IAmBE3kD,OAAAC,eACI0kD,GAAArlD,UAAA,MAAG,KADP,WAEE,OAAOY,KAAK+hC,UAEd,SAAQ7hC,GACNF,KAAK+hC,KAAO7hC,mCAIdJ,OAAAC,eACI0kD,GAAArlD,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKG,YAEd,SAAUD,GACRF,KAAKG,OAASD,mCAMhBJ,OAAAC,eAAI0kD,GAAArlD,UAAA,UAAO,KAAX,WACE,OAAOY,KAAK+8B,uCAWd0nB,GAAArlD,UAAAslD,SAAA,WACE1kD,KAAK+8B,OAAS/8B,KAAK+8B,MACf/8B,KAAK+8B,MACP/8B,KAAK2kD,SAAW,cAEhB3kD,KAAK2kD,SAAW,kCAlDrBnkD,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,qBACVC,SAAA,2wBAJOyjD,GAAAA,kDAaN/mB,GAAAA,oBAEAt8B,GAAAA,qBASAA,GAAAA,qBASAA,GAAAA,SAsBH2jD,IAdE,SAAAA,GACUtnC,GAAAnd,KAAAmd,OAAAA,EAhCVnd,KAAA2kD,SAAmB,YACnB3kD,KAAA4kD,SAAmB,mBAET5kD,KAAA6kD,OAAS,IAAIrnB,GAAAA,aAoBPx9B,KAAA+8B,OAAiB,EAM1B/8B,KAAAqd,SAAU,EAKfrd,KAAKqd,UAAUrd,KAAKmd,OAAOinC,UAAU,iBCvCzC,SAAgBU,KACd,OAAOC,EAAAA,QAAQ,yBAA0B,CACvCnpB,EAAAA,MACE,eACAr1B,EAAAA,MAAM,CACJ6nB,OAAQ,OACR0H,MAAO,OACPO,SAAU,YAGduF,EAAAA,MACE,cACAr1B,EAAAA,MAAM,CACJ6nB,OAAQ,OACRiI,SAAU,YAGduF,EAAAA,MACE,SACAr1B,EAAAA,MAAM,CACJ8vB,SAAU,YAGd2uB,EAAAA,WAAW,qBAAsBp0B,EAAAA,QAAQ,UACzCo0B,EAAAA,WAAW,qBAAsBp0B,EAAAA,QAAQ,YCjC7C,IAAAq0B,IAeEnlD,OAAAC,eACIklD,GAAA7lD,UAAA,MAAG,KADP,WAEE,OAAOY,KAAK+hC,UAEd,SAAQ7hC,GACNF,KAAK+hC,KAAO7hC,mCAIdJ,OAAAC,eACIklD,GAAA7lD,UAAA,gBAAa,KADjB,WAEE,OAAOY,KAAKklD,oBAEd,SAAkBhlD,GAChBF,KAAKklD,eAAiBhlD,mCAiBxB+kD,GAAA7lD,UAAAo0B,gBAAA,WAAA,IAAA7oB,EAAA3K,KACEA,KAAKmlD,SAAWnlD,KAAKwS,IAAI0oB,QAAQvjB,UAAS,SAACytC,GACzCz6C,EAAK06C,YAAcD,EAAYp7C,OAAM,SAAC25B,GAAK,OAAAA,EAAEta,eAIjD47B,GAAA7lD,UAAAs0B,YAAA,WACE1zB,KAAKmlD,SAASz6B,eAGhBu6B,GAAA7lD,UAAAkmD,iBAAA,WAC+B,EAAzBtlD,KAAKulD,WAAWxiD,QAAc/C,KAAKwlD,cACrCxlD,KAAKylD,QAAUzlD,KAAKylD,OAEpBzlD,KAAKylD,QAAS,GAIlB3lD,OAAAC,eAAIklD,GAAA7lD,UAAA,aAAU,KAAd,eACQsmD,EAAgB1lD,KAAKwS,IAAIgY,eAAeG,gBACxCg7B,EAAU3lD,KAAKwS,IAAIgY,eAAegrB,UAElCoQ,EAAK5lD,KAAKqlD,YAAYr7C,OAAM,SAAC25B,GACjC,QACIA,EAAEpjC,QAAQsqB,eACV66B,GAAiB/hB,EAAEpjC,QAAQsqB,kBAC3B8Y,EAAEpjC,QAAQqqB,eAAiB86B,GAAiB/hB,EAAEpjC,QAAQqqB,kBACtD+Y,EAAEpjC,QAAQ8gB,OAAO9gB,QAAQi6C,SAAWmL,GAAWhiB,EAAEpjC,QAAQ8gB,OAAO9gB,QAAQi6C,YACxE7W,EAAEpjC,QAAQ8gB,OAAO9gB,QAAQw8C,SAAW4I,GAAWhiB,EAAEpjC,QAAQ8gB,OAAO9gB,QAAQw8C,WAIxE8I,EAAWD,EAAG57C,OAAM,SAAC25B,GAAK,OAACA,EAAEtmB,UACnC,OAAOwoC,EAAS9iD,OAAS,IAAM6iD,EAAG7iD,OAAS8iD,EAAWD,wDAvEzDplD,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,0BACVC,SAAA,w3CAEAolD,WAAY,CAAChB,ohBATN9B,GAAAA,8CAYNliD,GAAAA,6BASAA,GAAAA,SAyDHmkD,IA1CE,SAAAA,GAAoBxC,GAAAziD,KAAAyiD,aAAAA,EANbziD,KAAAqlD,YAAuB,GACvBrlD,KAAAylD,QAAS,EACTzlD,KAAA+lD,YAAa,EAKJ/lD,KAAKyiD,aAAauD,OAAO9lD,QACzB+lD,GAAAA,MAAMC,QAAUlmD,KAAKwlD,gBAAkB/9C,YACnDzH,KAAKwlD,eAAgB,GC1C3B,IAAAW,IAkBErmD,OAAAC,eACIomD,GAAA/mD,UAAA,MAAG,KADP,WAEE,OAAOY,KAAK+hC,UAEd,SAAQ7hC,GACNF,KAAK+hC,KAAO7hC,EACZF,KAAKomD,iDAIPtmD,OAAAC,eACIomD,GAAA/mD,UAAA,YAAS,KADb,WAEE,OAAOY,KAAKqmD,gBAEd,SAAcnmD,GACZF,KAAKqmD,WAAanmD,EAClBF,KAAKsmD,uBAAuBpmD,oCAI9BJ,OAAAC,eACIomD,GAAA/mD,UAAA,WAAQ,KADZ,WAEE,OAAOY,KAAKumD,eAEd,SAAarmD,GACXF,KAAKumD,UAAYrmD,mCAInBJ,OAAAC,eACIomD,GAAA/mD,UAAA,UAAO,KADX,WAEE,OAAOY,KAAKwmD,cAEd,SAAYtmD,GACVF,KAAKwmD,SAAWtmD,mCAgBlBimD,GAAA/mD,UAAAo0B,gBAAA,WAAA,IAAA7oB,EAAA3K,KACEA,KAAKwS,IAAI1L,GAAGolB,GAAG,UAAS,WAAQ,OAAAvhB,EAAKy7C,kBACrCpmD,KAAKomD,iBAGPD,GAAA/mD,UAAAs0B,YAAA,WAAA,IAAA/oB,EAAA3K,KACEA,KAAKwS,IAAI1L,GAAGwlB,GAAG,UAAS,WAAQ,OAAA3hB,EAAKy7C,mBAGvCD,GAAA/mD,UAAAw9C,gBAAA,SAAgBvzB,GACVrpB,KAAKymD,WAGTzmD,KAAKwS,IAAIoqC,gBAAgBvzB,GACzBrpB,KAAK0mD,OAAOC,SAGNR,GAAA/mD,UAAAgnD,cAAR,WACEpmD,KAAK4mD,QAAQ9/C,GAAGo1C,QAAQl8C,KAAKwS,IAAI1L,GAAG8rB,YAG9BuzB,GAAA/mD,UAAAknD,uBAAR,SAA+BO,GAC7B7mD,KAAK4mD,QAAQ/I,sBAEPt9C,EAAeT,OAAO2C,OAC1B3C,OAAOyC,OAAOskD,EAAUtmD,SACxBsmD,EAAUtmD,QACV,CACE8c,SAAS,EACTgM,WAAW,IAIT/oB,EAAQN,KAAK8mD,aAAaC,YAAYxmD,GAC5CP,KAAK4mD,QAAQ3U,SAAS3xC,yBA1FzBE,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,mBACVC,SAAA,i9BALOsmD,UAJPC,GAAAA,gDAaCnmD,GAAAA,yBAUAA,GAAAA,wBAUAA,GAAAA,uBASAA,GAAAA,qBAcAA,GAAAA,SA2CHqlD,IAzCE,SAAAA,GACUW,EACAJ,GADA1mD,KAAA8mD,aAAAA,EACA9mD,KAAA0mD,OAAAA,EATH1mD,KAAA4mD,QAAU,IAAI7L,GAAO,CAC1BE,SAAU,GACVO,cAAc,IC1DlB,IAAA0L,IAUEpnD,OAAAC,eACImnD,GAAA9nD,UAAA,MAAG,KADP,WAEE,OAAOY,KAAK+hC,UAEd,SAAQ7hC,GACNF,KAAK+hC,KAAO7hC,mCAIdJ,OAAAC,eACImnD,GAAA9nD,UAAA,mBAAgB,KADpB,WAEE,OAAOY,KAAKmnD,uBAEd,SAAqBjnD,GACnBF,KAAKmnD,kBAAoBjnD,mCAI3BJ,OAAAC,eACImnD,GAAA9nD,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKG,YAEd,SAAUD,GACRF,KAAKG,OAASD,mCAIhBJ,OAAAC,eAAImnD,GAAA9nD,UAAA,UAAO,KAAX,WACE,OAAiD,IAA1CY,KAAKwS,IAAIgY,eAAe6uB,+CAKjC6N,GAAA9nD,UAAAgoD,cAAA,SAAcC,GAEZ,MAAO,CACL/hC,UAFe,UAAY+hC,EAAU,8BAxC1C7mD,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,wgDAICI,GAAAA,gCASAA,GAAAA,qBASAA,GAAAA,SAqBHomD,IARE,SAAAA,MCzCF,IAAAI,IAmBSA,GAAAC,qBAAP,SAA4BC,GAC1B,OAAOA,EAAQ,KAEVF,GAAAG,gBAAP,SAAuB5pC,GAErB,MAAO,CAACA,EAAM,GAAIA,EAAM,GAAIA,EAAM,GAAIA,EAAM,GAAK,MAG5CypC,GAAAI,uBAAP,SAA8BlhD,EAAOmhD,OAE7BC,EAAM3gC,GAAAA,gBAAuB0gC,GAEnC,OAAO5iC,WAAWve,IADK,QACKohD,EAHhB,KAOPN,GAAAO,eAAP,SAAsBC,OACdvO,EAAW+N,GAAmBS,gBAAgBD,EAAOE,OACrD9xB,EAAO4xB,EAAO5xB,OAASzuB,UAAYqgD,EAAO5xB,KAAOzuB,UACvD,OAAO,IAAIuuB,GAAAA,MAAc,CACvBE,KAAM,IAAIC,GAAAA,KAAa,CACrBJ,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAOypC,GAAmBG,gBAAgBK,EAAOjqC,SAEnD2P,KACEs6B,EAAOt6B,KAAKjnB,MACZ,IACAuhD,EAAOt6B,KAAKy6B,OACZ,IACAH,EAAOt6B,KAAKpR,KACZ,OACA0rC,EAAOt6B,KAAK06B,OACdC,aAAcL,EAAOM,kBACrBC,UAAWP,EAAOQ,oBAClBC,QAASjB,GAAmBC,qBAAqBO,EAAOU,SACxDC,QAASnB,GAAmBC,qBAAqBO,EAAOY,SACxDnP,SAAQA,EACRrjB,KAAIA,OAKHoxB,GAAAqB,gBAAP,SAAuBb,OACf95B,EAAM,QAAU85B,EAAOc,YAAc,YAAcd,EAAOe,UAC1DtP,EAAW+N,GAAmBS,gBAAgBD,EAAOE,OAE3D,OAAO,IAAIhyB,GAAAA,MAAc,CACvBzJ,MAAO,IAAIkL,GAAAA,KAAa,CACtBzJ,IAAGA,EACHurB,SAAQA,OAKP+N,GAAAwB,gBAAP,SAAuBhB,OAEf/xB,EAAO,IAAIK,GAAAA,KAAa,CAC5BvY,MAAOypC,GAAmBG,gBAAgBK,EAAOjqC,SAE7C+X,EAASkyB,EAAOiB,QAClBzB,GAAmB0B,gBAAgBlB,EAAOiB,SAC1CthD,UACJ,OAAO,IAAIuuB,GAAAA,MAAc,CACvBD,KAAIA,EACJH,OAAMA,KAGH0xB,GAAA0B,gBAAP,SAAuBD,OACjBE,EACEprC,EAAQypC,GAAmBG,gBAAgBsB,EAAQlrC,OAazD,MAZsB,gBAAlBkrC,EAAQxiD,MACV0iD,EAAW,CAAC,GACe,mBAAlBF,EAAQxiD,MACjB0iD,EAAW,CAAC,EAAG,EAAG,EAAG,GACM,sBAAlBF,EAAQxiD,MACjB0iD,EAAW,CAAC,EAAG,EAAG,EAAG,EAAG,EAAG,GACA,eAAlBF,EAAQxiD,MACjB0iD,EAAW,CAAC,EAAG,GACY,gBAAlBF,EAAQxiD,QAEjBsX,EAAM,GAAK,GAEN,IAAIgY,GAAAA,OAAe,CACxBhY,MAAKqrC,EACLD,SAAQA,EACRnzB,MAAOwxB,GAAmBC,qBAAqBwB,EAAQjzB,UAIpDwxB,GAAA6B,gBAAP,SAAuBrB,GACrB,OAAO,IAAI9xB,GAAAA,MAAc,CACvBJ,OAAQ0xB,GAAmB0B,gBAAgBlB,MAGxCR,GAAAS,gBAAP,SAAuBC,GACrB,GAAc,IAAVA,GAAeA,IAAUvgD,UAC3B,OAAOA,cAGH2hD,GADapB,EAAQptC,KAAKyuC,GAAM,IACVzuC,KAAKyuC,GAAK,EACtC,OAAID,EAAS,EACJ,EAAIxuC,KAAKyuC,GAAKD,EAEdA,GAIJ9B,GAAAgC,gBAAP,SAAuBxB,OACf/xB,EAAO,IAAIK,GAAAA,KAAa,CAC5BvY,MAAOypC,GAAmBG,gBAAgBK,EAAOjqC,SAE7C+X,EAASkyB,EAAOiB,QAClBzB,GAAmB0B,gBAAgBlB,EAAOiB,SAC1CthD,UACEub,EAASskC,GAAmBC,qBAAqBO,EAAO1rC,MAAQ,EAChEm9B,EAAW+N,GAAmBS,gBAAgBD,EAAOE,OAC3D,MAAqB,kBAAjBF,EAAOvhD,MACF,IAAIyvB,GAAAA,MAAc,CACvBzJ,MAAO,IAAI0J,GAAAA,OAAe,CACxBjT,OAAMA,EACN+S,KAAIA,EACJH,OAAMA,MAGgB,iBAAjBkyB,EAAOvhD,MACT,IAAIyvB,GAAAA,MAAc,CACvBzJ,MAAO,IAAI+L,GAAAA,aAAqB,CAC9BvC,KAAIA,EACJH,OAAMA,EACN2zB,OAAQ,EACRvmC,OAAMA,EACNwmC,QAAS,EACTxB,MAAO,EACPzO,SAAQA,MAGc,mBAAjBuO,EAAOvhD,MACT,IAAIyvB,GAAAA,MAAc,CACvBzJ,MAAO,IAAI+L,GAAAA,aAAqB,CAC9BvC,KAAIA,EACJH,OAAMA,EACN2zB,OAAQ,EACRvmC,OAAMA,EACNu2B,SAAQA,MAGc,kBAAjBuO,EAAOvhD,MACT,IAAIyvB,GAAAA,MAAc,CACvBzJ,MAAO,IAAI+L,GAAAA,aAAqB,CAC9BvC,KAAIA,EACJH,OAAMA,EACN2zB,OAAQ,EACRvmC,OAAMA,EACNglC,MAAOptC,KAAKyuC,GAAK,EACjB9P,SAAQA,MAGc,aAAjBuO,EAAOvhD,MACT,IAAIyvB,GAAAA,MAAc,CACvBzJ,MAAO,IAAI+L,GAAAA,aAAqB,CAC9BvC,KAAIA,EACJH,OAAMA,EACN2zB,OAAQ,EACRvmC,OAAMA,EACNwmC,QAAS,EACTxB,MAAOptC,KAAKyuC,GAAK,EACjB9P,SAAQA,MAGc,oBAAjBuO,EAAOvhD,MACT,IAAIyvB,GAAAA,MAAc,CACvBzJ,MAAO,IAAI+L,GAAAA,aAAqB,CAC9BvC,KAAIA,EACJH,OAAMA,EACN2zB,OAAQ,EACRvmC,OAAMA,EACNglC,MAAO,EACPzO,SAAQA,WARP,GAcT+N,GAAAloD,UAAAqqD,qBAAA,SAAqBC,EAAcC,GAEjC,QADMhsB,EAAS,GACN/6B,EAAI,EAAGgnD,EAAKF,EAAa3mD,OAAQH,EAAIgnD,IAAMhnD,EAAG,KAC/CinD,EAAkBH,EAAa9mD,GAAGinD,gBAElC96C,EAAQ86C,EAAgB/rC,OAC5B+rC,EAAgB74C,QAAQ,KAAO,EAC/B64C,EAAgB74C,QAAQ,KAAO,GAE3B82C,EAAS4B,EAAa9mD,GAAGklD,OACzBgC,EAAWJ,EAAa9mD,GAAGknD,SAC3BC,EAAWL,EAAa9mD,GAAGmnD,SAC7Bn/B,EAAgB,KACH,IAAbk/B,IACFl/B,EAAgB08B,GAAmBI,uBACjCoC,EACAH,QAGA9+B,EAAgB,KACH,IAAbk/B,IACFl/B,EAAgBy8B,GAAmBI,uBACjCqC,EACAJ,QAGEpjD,EAAQvG,KAAKgqD,YAAYlC,EAAOriD,MAAMzC,KAAKhD,KAAM8nD,GACvDnqB,EAAOl5B,KAEH,SAAgBY,EAASmR,OACnB6G,GAAU,EAUd,GAT2B,OAAvBrd,KAAK4qB,eAAiD,OAAvB5qB,KAAK6qB,cACtCxN,EACE7G,EAAaxW,KAAK6qB,eAClBrU,GAAcxW,KAAK4qB,cACW,OAAvB5qB,KAAK4qB,cACdvN,EAAU7G,GAAcxW,KAAK4qB,cACG,OAAvB5qB,KAAK6qB,gBACdxN,EAAU7G,EAAaxW,KAAK6qB,eAE1BxN,EAAS,KACLnd,EAAQmF,EAAQ8S,IAAInY,KAAK+O,OAE/B,OADA/O,KAAKuG,MAAMmwB,UAAUvE,QAAQjyB,GACtB,CAACF,KAAKuG,SAGdqY,KAAK,CACRgM,cAAaA,EACbC,cAAaA,EACb9b,MAAKA,EACLxI,MAAKA,KAIX,OAAOo3B,GAGT2pB,GAAAloD,UAAA6qD,cAAA,SAAcvvB,OACNn0B,EAAQvG,KAAKgqD,YAAYtvB,EAASotB,OAAOriD,MAAMzC,KACnDhD,KACA06B,EAASotB,QAEX,OACE,WACE,MAAO,CAACvhD,KAId+gD,GAAAloD,UAAA8qD,mBAAA,SAAmBxvB,GAQjB,QAPMyvB,EAAgBzvB,EAASyvB,cACzBj1B,EAAel1B,KAAKgqD,YAAYG,EAAc1kD,MAAMzC,KACxDhD,KACAmqD,GAEIp7C,EAAQ2rB,EAAS3rB,MACjBq7C,EAAU,GACPxnD,EAAI,EAAGgnD,EAAKlvB,EAAS2vB,gBAAgBtnD,OAAQH,EAAIgnD,IAAMhnD,EAAG,KAC3D0nD,EAAiB5vB,EAAS2vB,gBAAgBznD,GAC5C2nD,OAAG,EAMHA,EAJ+B,OAAjCD,EAAeE,eACfF,EAAeE,gBAAkB/iD,UAEvB,IAAN7E,EACI83B,EAAS+vB,SAET/vB,EAAS2vB,gBAAgBznD,EAAI,GAAG8nD,cAGlCJ,EAAeE,kBAEjB7L,EAAM2L,EAAeI,cACrB5C,EAASwC,EAAexC,OACxBvhD,EAAQvG,KAAKgqD,YAAYlC,EAAOriD,MAAMzC,KAAKhD,KAAM8nD,GACvDsC,EAAQ3lD,KAAK,CAAE8lD,IAAGA,EAAE5L,IAAGA,EAAEp4C,MAAKA,IAEhC,OACE,SAAQlB,GAEN,QADMnF,EAAQmF,EAAQ8S,IAAIpJ,GACjBnM,EAAI,EAAGgnD,EAAKQ,EAAQrnD,OAAQH,EAAIgnD,IAAMhnD,EAO7C,GALU,IAANA,EACU1C,GAASkqD,EAAQxnD,GAAG2nD,KAAOrqD,GAASkqD,EAAQxnD,GAAG+7C,IAE/Cz+C,EAAQkqD,EAAQxnD,GAAG2nD,KAAOrqD,GAASkqD,EAAQxnD,GAAG+7C,IAG1D,MAAO,CAACyL,EAAQxnD,GAAG2D,OAGvB,MAAO,CAAC2uB,KAIdoyB,GAAAloD,UAAAurD,mBAAA,SAAmBjwB,OACXyvB,EAAgBzvB,EAASyvB,cAC3Bj1B,EAAe,GACfi1B,IACFj1B,EAAe,CACbl1B,KAAKgqD,YAAYG,EAAc1kD,MAAMzC,KAAKhD,KAAMmqD,SAG9Cp7C,EAAQ2rB,EAASkwB,OACjBC,EAAQnwB,EAASowB,iBACjBC,EAAK/qD,KACX,OAAO,WAEL,QADMgrD,EAAO,GACJpoD,EAAI,EAAGgnD,EAAKiB,EAAM9nD,OAAQH,EAAIgnD,IAAMhnD,EAAG,KACxCy+C,EAAOwJ,EAAMjoD,GACbklD,EAASzG,EAAKyG,OACpBkD,EAAK3J,EAAKnhD,OAAS,CAAC6qD,EAAGf,YAAYlC,EAAOriD,MAAMzC,KAAK+nD,EAAIjD,IAG3D,OAAA,SAAQziD,OACAkB,EAAQykD,EAAK3lD,EAAQ8S,IAAIpJ,IAC/B,OAAOxI,GAAgB2uB,GAVpB,IAcToyB,GAAAloD,UAAA6rD,cAAA,SAAcC,EAAWvB,OACjBwB,EAAcD,EAAUC,YAC1BC,EAAiB,GACfC,EAAmBrrD,KAAKsrD,WAAWH,EAAYzwB,SAASj1B,MAAMzC,KAClEhD,KACAmrD,EAAYzwB,UAKd,GAHI2wB,IAAqB5jD,WACvB2jD,EAAe3mD,KAAK4mD,GAElBH,EAAUxB,aAAc,KACpB6B,EAA6BvrD,KAAKypD,qBACtCyB,EAAUxB,aACVC,GAEFyB,EAAiBA,EAAexmD,OAAO2mD,GAEzC,OAA8B,IAA1BH,EAAeroD,OACVqoD,EAAe,GAGpB,SAAQ/lD,EAASmR,GAEf,QADImnB,EAAS,GACJ/6B,EAAI,EAAGgnD,EAAKwB,EAAeroD,OAAQH,EAAIgnD,IAAMhnD,EAAG,KACjD4oD,EAASJ,EAAexoD,GAAGI,KAAK,KAAMqC,EAASmR,GACjDg1C,IACF7tB,EAASA,EAAO/4B,OAAO4mD,IAG3B,OAAO7tB,IAKjB2pB,IAhXE,SAAAA,KACEtnD,KAAKgqD,YAAc,GACnBhqD,KAAKgqD,YAAYyB,QAAUnE,GAAmBqB,gBAC9C3oD,KAAKgqD,YAAY0B,QAAUpE,GAAmBwB,gBAC9C9oD,KAAKgqD,YAAY2B,QAAUrE,GAAmB6B,gBAC9CnpD,KAAKgqD,YAAY4B,QAAUtE,GAAmBgC,gBAC9CtpD,KAAKgqD,YAAY6B,OAASvE,GAAmBO,eAC7C7nD,KAAKsrD,WAAa,GAClBtrD,KAAKsrD,WAAWQ,YAAc9rD,KAAK2qD,mBACnC3qD,KAAKsrD,WAAWS,OAAS/rD,KAAKiqD,cAC9BjqD,KAAKsrD,WAAWU,YAAchsD,KAAKkqD,2BChBnC+B,KAAO,OACPC,KAAO,OACPC,SAAW,WACXC,KAAO,YAIPC,SAAW,WACXC,OAAS,cC0BXvnD,IAAM,MACNE,KAAO,YAgBP86B,GAAA3gC,UAAAu/B,cAAA,SACE4tB,GADF,IAAA5hD,EAAA3K,KAGQP,EAAM8sD,EAAY9sD,IAClBiV,EAAW63C,EAAkB,OAASrxC,QAE5C,OAAOlb,KAAKwsD,gBAAgB,MAAO/sD,EAAKiV,GAAS0W,KAC/C5Y,GAAAA,IAAG,SAAEi6C,GACH,OAAOA,EACH9hD,EAAK+hD,gBAAgBH,EAAaE,GAClChlD,cAKVs4B,GAAA3gC,UAAAutD,eAAA,SACEJ,GADF,IAAA5hD,EAAA3K,KAGQP,EAAM8sD,EAAY9sD,IAClBiV,EAAU63C,EAAY73C,QAU5B,OARgB1U,KAAKwsD,gBAAgB,OAAQ/sD,EAAKiV,GAAS0W,KACzD5Y,GAAAA,IAAG,SAAEi6C,GACH,OAAOA,EACH9hD,EAAKiiD,iBAAiBL,EAAaE,GACnChlD,cAOVs4B,GAAA3gC,UAAAytD,gBAAA,SACEN,GADF,IAAA5hD,EAAA3K,KAGQkX,EACJ,WACAq1C,EAAYO,QACZ,yBACAP,EAAYQ,MACZ,YAEF,OAAO/sD,KAAKkY,KACT80C,MAAM91C,EAAS,YACfkU,KACC5Y,GAAAA,IAAG,SAAEy6C,GACH,OAAAtiD,EAAKuiD,kBAAkBX,EAAaU,OAK5CltB,GAAA3gC,UAAA+tD,iBAAA,SACEZ,GADF,IAAA5hD,EAAA3K,KAGQkX,EAAUq1C,EAAY9sD,IAAM,IAAM8sD,EAAYjsD,MAAQ,UAEtDutB,EADc0+B,EAAY9sD,IAAIsO,QAAQ,gBAAiB,aAC7B,iBAC1Bq/C,EAAgBptD,KAAKkY,KAAKC,IAAIjB,GAC9BzQ,EAASzG,KAAKkY,KAAKC,IAAI0V,GAAWzC,KACtC5Y,GAAAA,IAAG,SAAEkiB,GAAa,OAAAA,IAClB24B,GAAAA,WAAU,SAACC,GAET,OADAr8C,QAAQC,IAAI,kDACLqtB,GAAAA,GAAG+uB,MAGd,OAAOC,GAAAA,SAAS,CAACH,EAAe3mD,IAAS2kB,KACvC5Y,GAAAA,IAAG,SAAEkiB,GACH,OAAO/pB,EAAK6iD,mBAAmBjB,EAAa73B,EAAI,GAAIA,EAAI,QAK9DqL,GAAA3gC,UAAAquD,qBAAA,SACElB,GADF,IAAA5hD,EAAA3K,KAGQkX,EAAUq1C,EAAY9sD,IAAM,IAAM8sD,EAAYjsD,MAAQ,UACtDutB,EAAY0+B,EAAY9sD,IAAM,iBAC9B2tD,EAAgBptD,KAAKkY,KAAKC,IAAIjB,GAC9B4H,EAAa9e,KAAKkY,KAAKC,IAAI0V,GAEjC,OAAO0/B,GAAAA,SAAS,CAACH,EAAetuC,IAAasM,KAC3C5Y,GAAAA,IAAG,SAAEkiB,GACH,OAAA/pB,EAAK+iD,uBAAuBnB,EAAa73B,EAAI,GAAIA,EAAI,QAQ3DqL,GAAA3gC,UAAAotD,gBAAA,SACEmB,EACAz2C,EACAxC,GANF,IAAA/J,EAAA3K,KAQQ4F,EAAS,IAAIgoD,GAAAA,WAAW,CAC5BC,WAAY,CACVC,QAAS,kBACTH,QAASA,EAAQt1B,cACjB3jB,QAASA,GAAW,QACpBq5C,GAAI,UASR,OALgB/tD,KAAKkY,KAAKC,IAAIjB,EAAS,CACrCtR,OAAMA,EACNwS,aAAc,SAGDgT,KACb5Y,GAAAA,IAAG,SAACkiB,GACF,IACE,OAAO/pB,EAAKqjD,QAAQL,GAASM,KAAKv5B,GAClC,MAAOnwB,GACP,OAAOkD,aAGX4lD,GAAAA,WAAU,SAAC9oD,GAET,MADAA,EAAEG,MAAMwpD,QAAS,EACX3pD,MAKJw7B,GAAA3gC,UAAAstD,gBAAR,SACEH,EACAE,WAEM9mD,EAAU4mD,EAAkB,OAAS1mD,OACrCvF,EAAQN,KAAKmuD,6BACjB1B,EAAa2B,WAAWplC,MACxBrjB,GAGF,IAAKrF,EACH,KAAM,CACJoE,MAAO,CACLmhB,QAAS,wBAYXwoC,EARE/uD,EAAWgB,EAAMguD,QAAUhuD,EAAMguD,QAAQ,GAAK7mD,UAC9C40B,EAAW/7B,EAAMiuD,SAAWjuD,EAAMiuD,SAAW9mD,UAC7Cg/B,EAAcnmC,EAAMkuD,YAAcluD,EAAMkuD,YAAc/mD,UACxD0yB,EAAY75B,EAAM65B,UAChB3b,EAAaxe,KAAKyuD,cAAcnuD,GAChCouD,EAAiBlwC,GAA+C,EAAjC1e,OAAOk4B,KAAKxZ,GAAYzb,OACvD0oB,EAAgBnrB,EAAMquD,MAAQ3uD,KAAKg5B,SAAS14B,EAAMquD,OAASlnD,UAG3DmnD,EAA8B,CAClCC,GAAoBh1C,QACpBg1C,GAAoB/0C,SACpB+0C,GAAoBj1C,KACpBi1C,GAAoBl1C,KACpBk1C,GAAoBxlD,KACpBwlD,GAAoB50C,iBAGX60C,GACT,IAGS,IAFPrC,EAAa2B,WAAWW,QAAQC,eAAeC,OAAOj+C,QACpD89C,GAEF,KACMI,EAAUpvD,OAAOk4B,KAAK62B,IAAqB//C,KAAI,SACnDzL,GAAO,OAAAwrD,GAAoBxrD,KAASyrD,WAEtCT,EAAcc,GAAYD,iBAT9B,IAAuB,IAAAE,EAAA5xC,GAAAoxC,GAA2BS,EAAAD,EAAAhrD,QAAAirD,EAAAhrD,kBAA/BgrD,EAAAnvD,OAA+BmvD,EAAAD,EAAAhrD,6GAa7CiqD,IACHl0B,GAAY,OAGR55B,EAAgCoR,GAAAA,YAAY29C,gBAAgB,CAChEzwB,wBAAyB,CACvBhtB,MAAOvR,EAAMivD,MACb1kC,cAAe/D,GAAuBxmB,EAAMkvD,qBAC5C5kC,cAAe9D,GAAuBxmB,EAAMmvD,qBAC5CnwD,SAAU,CACRG,IAAKH,EAAWA,EAASowD,eAAiBjoD,UAC1ClI,SAAQD,GAAkBmI,UAC1B40B,WAAQA,EACRoK,YAAWA,GAEbhb,cAAaA,GAEf0O,UAASA,EACTk0B,YAAWA,EACX7vC,WAAYkwC,EAAiBlwC,EAAa/W,UAC1CinD,iBAAgBA,GAAwBjnD,YAG1C,OAAOkK,GAAAA,YAAYiK,UAAUrb,EAASgsD,IAGhCxsB,GAAA3gC,UAAAwtD,iBAAR,SACEL,EACAE,OAIMnsD,EAAQmsD,EAAakD,SAAS3mC,MAAMla,KAAI,SAAC8gD,GAAM,OAAAA,EAAGC,aAAetD,EAAYjsD,QAE7EC,EAAUuvD,EAAAA,wBAAwBrD,EAAcF,GAEhDwD,EAAejwD,OAAO2C,OAAOlC,EAASgsD,GACtCrlD,EAAgByK,GAAAA,YAAY29C,gBAAgB,CAChDzwB,wBAAyB,CACvBhtB,MAAOvR,EAAMivD,SAEjB,OAAO59C,GAAAA,YAAYiK,UAAU1U,EAAe6oD,IAGtChwB,GAAA3gC,UAAA8tD,kBAAR,SACEX,EACAU,OAEMtnD,EAAS,GACTC,EAASqnD,EAAatnD,OAAO,GAAGpF,QAAQyvD,iBAC9CpqD,EAAOD,OAAOkF,QAAO,SAACC,GACpBnF,EAAOlB,KAAK,CACVgB,KAAMqF,EAAQrF,KAAKyJ,cACnB3O,QAASuK,EAAQvK,QACjBkG,OAAQqE,EAAQrE,eAGdlG,EAAUoR,GAAAA,YAAY29C,gBAAgB,CAC1CnyC,OAAQ,CACNzI,QAAS9O,EAAO8O,QAChB/O,OAAMA,KAGV,OAAOgM,GAAAA,YAAYiK,UAAUrb,EAASgsD,IAGhCxsB,GAAA3gC,UAAAouD,mBAAR,SACEjB,EACAa,EACA3mD,OASIiY,EACAF,EAREM,EAAarY,EAAOd,OAASc,EAASgB,UACtCwoD,EAAiB,IAAI3I,GACrBK,EAAgC,eAAxByF,EAAczF,MAAyB,IAAM,UACrDphD,EAAQ0pD,EAAehF,cAAcmC,EAAezF,GACpDrpC,EAAe,IAAI4xC,EAAc,CACrCvpD,KAAMymD,EAAc+C,gBAItB,GAAI/C,EAAcgD,SAAU,KACpB3xC,EAAO2uC,EAAcgD,SAAS1xC,WACpCA,EAAaD,EAAK,GAAK,IAAMA,EAAK,OAC5B8rC,EAAM,IAAI95B,KAChB85B,EAAI8F,QAAQ5xC,EAAK,QACXkgC,EAAM,IAAIluB,KAChBkuB,EAAI0R,QAAQ5xC,EAAK,IACjBD,EAAa,CACX+rC,IAAKA,EAAI+F,cACT3R,IAAKA,EAAI2R,cACTC,OAAO,EACP9qD,KAAM+qD,GAAerE,SACrB5lD,MAAOkqD,GAAgBpE,cAGrBzmD,EAAS9F,OAAO2C,OACpB,GACA,CACEqc,WAAUA,EACVvY,MAAKA,EACLiY,WAAUA,EACVE,WAAUA,EACVJ,aAAYA,IAGV/d,EAAUoR,GAAAA,YAAY29C,gBAAgB,CAC1C1pD,OAAMA,IAER,OAAO+L,GAAAA,YAAYiK,UAAUrb,EAASgsD,IAGhCxsB,GAAA3gC,UAAAsuD,uBAAR,SACEnB,EACAa,EACA3mD,OAMIiY,EACAF,EALEM,EAAarY,EAAOd,OAASc,EAASgB,UACtC6W,EAAe,IAAI4xC,EAAc,CACrCvpD,KAAMymD,EAAc+C,gBAItB,GAAI/C,EAAcgD,SAAU,KACpB3xC,EAAO2uC,EAAcgD,SAAS1xC,WACpCA,EAAaD,EAAK,GAAK,IAAMA,EAAK,OAC5B8rC,EAAM,IAAI95B,KAChB85B,EAAI8F,QAAQ5xC,EAAK,QACXkgC,EAAM,IAAIluB,KAChBkuB,EAAI0R,QAAQ5xC,EAAK,IACjBD,EAAa,CACX+rC,IAAKA,EAAI+F,cACT3R,IAAKA,EAAI2R,cACTC,OAAO,EACP9qD,KAAM+qD,GAAerE,SACrB5lD,MAAOkqD,GAAgBpE,cAGrBzmD,EAAS9F,OAAO2C,OACpB,GACA,CACEkD,OAAQ,QAAU4mD,EAAYjsD,MAC9Bme,KAAMC,IAGJne,EAAUoR,GAAAA,YAAY29C,gBAAgB,CAC1C1pD,OAAMA,EACNkZ,WAAUA,EACVN,WAAUA,EACVF,aAAYA,IAEd,OAAO3M,GAAAA,YAAYiK,UAAUrb,EAASgsD,IAGhCxsB,GAAA3gC,UAAA+uD,6BAAR,SAAqCuC,EAAY1hD,GAAjD,IAEQ2hD,EAFRhmD,EAAA3K,KACE,OAAIiC,MAAM2uD,QAAQF,IAEhBA,EAAW5hD,KAAI,SAAC5O,GAEd,OADAywD,EAAQhmD,EAAKwjD,6BAA6BjuD,EAAO8O,MAChCvH,WAChBzH,MAEI2wD,GACED,EAAW1nC,MACbhpB,KAAKmuD,6BAA6BuC,EAAW1nC,MAAOha,GAEvD0hD,EAAWG,MAAQH,EAAWG,OAAS7hD,EAClC0hD,EAEFjpD,WAIXs4B,GAAA3gC,UAAAqvD,cAAA,SAAcnuD,OACRwwD,EAEJ,GAAIxwD,EAAMywD,UAAW,KACbvyC,EAAkB,GAGxB,IAFAsyC,EAAYxwD,EAAMywD,UAAU,IAEdj5C,OAAQ,KACdk5C,EAAYF,EAAUh5C,OAAOrN,MAAM,KACzC+T,EAAW+rC,IAAMyG,EAAU,KAAOvpD,UAAYupD,EAAU,GAAKvpD,UAC7D+W,EAAWmgC,IAAMqS,EAAU,KAAOvpD,UAAYupD,EAAU,GAAKvpD,UAC7D+W,EAAWyyC,KAAOD,EAAU,KAAOvpD,UAAYupD,EAAU,GAAKvpD,UAMhE,OAHIqpD,EAAUjvB,aACZrjB,EAAWte,MAAQ4wD,EAAUjvB,YAExBrjB,IAIXuhB,GAAA3gC,UAAA45B,SAAA,SAAS21B,GAkBP,MAJmB,CACjB1vB,gBAduC0vB,EAAMn8C,IAAG,SAACjM,GACjD,MAAO,CACLyI,KAAMzI,EAAMsqD,KACZh/C,MAAOtL,EAAMgpD,SAIdvlD,OAAM,SACJg0B,EAAMjtB,EAAOmgD,GACZ,OAAAA,EAAKntB,UAAS,SAAEnhC,GAAwB,OAAAA,EAAEoM,OAASgvB,EAAKhvB,SACxD+B,2BAnYTrR,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAzCL8Z,GAAAA,+IA6IPy3C,GAAAA,CAHCC,EAAAA,UAAU,CACTC,cAAe,sGAMdh5C,GAAAA,sDAhGH,SAAA0nB,GAAoB7nB,GAAAlY,KAAAkY,KAAAA,EALZlY,KAAAguD,QAAU,CAChBjpD,IAAK,IAAIusD,GAAAA,gBACTrsD,KAAM,IAAIssD,GAAAA,kBC3Cd,OAAA,SAAAC,OCJAC,IAqDEA,GAAAryD,UAAAsyD,sBAAA,SAAsBC,GACpB,IAAKA,EAAQlsD,KAEX,MADAwL,QAAQvM,MAAMitD,GACR,IAAIjqD,MAAM,+BAEduhB,EACJ,OAAQ0oC,EAAQlsD,KAAKyJ,eACnB,IAAK,MACH+Z,EAAajpB,KAAK4xD,oBAAmB,GACrC,MACF,IAAK,SACH3oC,EAAajpB,KAAK6xD,wBAAuB,GAGzC,MACF,IAAK,MACH5oC,EAAajpB,KAAK8xD,oBAAmB,GACrC,MACF,IAAK,UACGC,EAAU,EAChBpgD,GAAAA,YAAYqgD,+BAA+BD,EAAWnsD,QACtDqjB,EAAajpB,KAAKiyD,oBAAoBF,GACtC,MACF,IAAK,OACH9oC,EAAajpB,KAAKkyD,qBAAoB,GAGtC,MACF,IAAK,MACHjpC,EAAajpB,KAAKmyD,oBAAmB,GACrC,MACF,IAAK,QACHlpC,EAAajpB,KAAKoyD,sBAAqB,GAGvC,MACF,IAAK,aACHnpC,EAAajpB,KAAKqyD,2BAA0B,GAG5C,MACF,IAAK,YACHppC,EAAajpB,KAAKsyD,0BAAyB,GAG3C,MACF,IAAK,MACHrpC,EAAajpB,KAAKuyD,oBAAmB,GACrC,MACF,IAAK,iBACHtpC,EAAajpB,KAAKwyD,+BAA8B,GAGhD,MACF,IAAK,UACHvpC,EAAajpB,KAAKyyD,wBAAuB,GAGzC,MACF,QAEE,MADAxhD,QAAQvM,MAAMitD,GACR,IAAIjqD,MAAM,2BAKpB,OAFA1H,KAAK0yD,aAAatuD,KAAKpE,KAAK0yD,aAAaxyD,MAAM0E,OAAO,CAACqkB,KAEhDA,GAGDwoC,GAAAryD,UAAAwyD,oBAAR,SACED,GAEA,OAAO,IAAIt5C,GAAAA,WAAU,SAACxW,GAAK,OAAAA,EAAEuC,KAAK,IAAI2D,GAAc4pD,OAG9CF,GAAAryD,UAAAyyD,wBAAR,SACEF,GAEA,OAAO,IAAIt5C,GAAAA,WAAU,SAACxW,GAAK,OAAAA,EAAEuC,KAAK,IAAI6C,GAAkB0qD,OAGlDF,GAAAryD,UAAAkzD,0BAAR,SACEX,GAEA,OAAO,IAAIt5C,GAAAA,WAAU,SAACxW,GAAK,OAAAA,EAAEuC,KAAK,IAAIqb,GAAoBkyC,OAGpDF,GAAAryD,UAAA0yD,oBAAR,SACEH,GADF,IAAAhnD,EAAA3K,KAGE,OAAO,IAAIqY,GAAAA,WAAU,SAACxW,GACpB,OAAAA,EAAEuC,KAAK,IAAIkS,GAAcq7C,EAAShnD,EAAKgoD,0BAInClB,GAAAryD,UAAA6yD,oBAAR,SAA4BN,GAA5B,IAAAhnD,EAAA3K,KACQ4yD,EAAc,GAuCpB,OAtCIjB,EAAQ7B,yBACV8C,EAAYnuD,KACVzE,KAAK0+B,oBAAoBC,cAAcgzB,GAASvmC,KAC9CiiC,GAAAA,WAAU,SAAC9oD,OACHsN,EAAQlH,EAAKu0B,gBAAgBC,UAAUC,QAC3C,uCAEIvZ,EAAUlb,EAAKu0B,gBAAgBC,UAAUC,QAC7C,iCACA,CAAEl/B,MAAOyxD,EAAQ/rD,OAAOC,SAI1B,MADA8E,EAAKy2C,eAAe18C,MAAMmhB,EAAShU,GAC7BtN,MAMVvE,KAAK6yD,iBAA6C,IAA3BlB,EAAQmB,gBACjCF,EAAYnuD,KACVzE,KAAK6yD,eAAel0B,cAAcgzB,GAASvmC,KACzCiiC,GAAAA,WAAU,SAAC9oD,GAQT,OAPAA,EAAEG,MAAMquD,WAAY,EACpBxuD,EAAEG,MAAMmN,MAAQlH,EAAKu0B,gBAAgBC,UAAUC,QAC7C,uCAEF76B,EAAEG,MAAMmhB,QAAUlb,EAAKu0B,gBAAgBC,UAAUC,QAC/C,4CAEKb,GAAAA,GAAG,QAMlBq0B,EAAYnuD,KAAK85B,GAAAA,GAAGozB,IAEbpE,GAAAA,SAASqF,GAAaxnC,KAC3B5Y,GAAAA,IAAG,SAAEjS,OACGyyD,EAAgBzyD,EAAQqjC,OAAM,SAAEoD,EAAGllC,GACvC,OAAA6P,GAAAA,YAAYiK,UAAUorB,EAAGllC,KAE3B,OAAO,IAAIuY,GAAc24C,EAAeroD,EAAKgoD,wBAE/CtF,GAAAA,WAAU,WACR,OAAO9uB,GAAAA,GAAG92B,eAKRgqD,GAAAryD,UAAA8yD,qBAAR,SACEP,GADF,IAAAhnD,EAAA3K,KAGE,OAAI2xD,EAAQ7B,wBACH9vD,KAAK0+B,oBAAoBiuB,eAAegF,GAASvmC,KACtD5Y,GAAAA,IAAG,SAAEjS,GACH,OAAOA,EAAU,IAAIqc,GAAerc,GAAWkH,YAEjD4lD,GAAAA,WAAU,eACFx7C,EAAQlH,EAAKu0B,gBAAgBC,UAAUC,QAC3C,uCAEIvZ,EAAUlb,EAAKu0B,gBAAgBC,UAAUC,QAC7C,iCACA,CAAEl/B,MAAOyxD,EAAQrxD,QAInB,OADAqK,EAAKy2C,eAAe18C,MAAMmhB,EAAShU,GAC5B0sB,GAAAA,GAAG92B,cAKT,IAAI4Q,GAAAA,WAAU,SAACxW,GAAK,OAAAA,EAAEuC,KAAK,IAAIwY,GAAe+0C,OAG/CF,GAAAryD,UAAA+yD,oBAAR,SACER,GAEA,OAAO,IAAIt5C,GAAAA,WAAU,SAACxW,GAAK,OAAAA,EAAEuC,KAAK,IAAI6D,GAAc0pD,OAG9CF,GAAAryD,UAAAgzD,sBAAR,SACET,GAEA,OAAIA,EAAQ5E,MACH/sD,KAAK0+B,oBACTmuB,gBAAgB8E,GAChBvmC,KACC5Y,GAAAA,IAAG,SAAEjS,GAAoC,OAAA,IAAIwc,GAAgBxc,MAG5D,IAAI8X,GAAAA,WAAU,SAACxW,GAAK,OAAAA,EAAEuC,KAAK,IAAI2Y,GAAgB40C,OAGhDF,GAAAryD,UAAAizD,2BAAR,SACEV,GAEA,OAAO3xD,KAAK0+B,oBACTyuB,iBAAiBwE,GACjBvmC,KACC5Y,GAAAA,IAAG,SACAjS,GACC,OAAA,IAAI4d,GAAqB5d,OAK3BkxD,GAAAryD,UAAAozD,+BAAR,SACEb,GAEA,OAAO3xD,KAAK0+B,oBACT+uB,qBAAqBkE,GACrBvmC,KACC5Y,GAAAA,IAAG,SACAjS,GACC,OAAA,IAAIgf,GAAyBhf,OAK/BkxD,GAAAryD,UAAAmzD,oBAAR,SACEZ,GAEA,OAAO,IAAIt5C,GAAAA,WAAU,SAACxW,GAAK,OAAAA,EAAEuC,KAAK,IAAI2c,GAAc4wC,OAG9CF,GAAAryD,UAAAqzD,wBAAR,SACEd,GAEA,OAAO,IAAIt5C,GAAAA,WAAU,SAACxW,GAAK,OAAAA,EAAEuC,KAAK,IAAIgd,GAAkBuwC,4BAnP3DjyD,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAnCLmgC,UACAyxB,GAAcruD,WAAA,CAAA,CAAAsC,KAyClB+jC,GAAAA,kBAxCIhyB,UA6BAwoB,GAAAA,uBAAiBgiB,GAAAA,sBACjB+B,uOAQP,SAAA0N,GACU/yB,EACYm0B,EACZF,EACAzzB,EACAkiB,EACA6R,GALAjzD,KAAA0+B,oBAAAA,EACY1+B,KAAA6yD,eAAAA,EACZ7yD,KAAA2yD,qBAAAA,EACA3yD,KAAAk/B,gBAAAA,EACAl/B,KAAAohD,eAAAA,EACAphD,KAAAizD,kBAAAA,EARHjzD,KAAA0yD,aAAe,IAAIznC,GAAAA,gBAA8B,eC9BnBjkB,GAAAA,MAAAwqD,IAWrC0B,GAAA9zD,UAAAu/B,cAAA,SACE4tB,GAEA,IAAKvsD,KAAKmzD,OACR,OAAO50B,GAAAA,GAAE,QAEL34B,EAAS,IAAIgoD,GAAAA,WAAW,CAC5BC,WAAY,CACVpoD,KAAM8mD,EAAY9mD,KAClBhG,IAAK8sD,EAAY9sD,IACjBkG,OAAQ4mD,EAAY3mD,OAAOC,UAQ/B,OAJgB7F,KAAKkY,KAAKC,IAAInY,KAAKmzD,OAAQ,CACzCvtD,OAAMA,IAGOwlB,KACb5Y,GAAAA,IAAG,SACAkiB,GAIC,OAAKA,GAAQA,EAAIxtB,eAGjBwtB,EAAIxtB,cAAc23B,wBAA0BnK,EAAIpX,aACzCoX,EAAIxtB,eAHT,4BAvCXxH,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDATL8Z,GAAAA,8CAgBJ05C,GAAAA,OAAMzzD,KAAA,CAAC,0KAFV,SAAAuzD,GACUh7C,EACW3X,QAAnB,IAAAA,IAAAA,EAAA,IAFF,IAAAoK,EAIE2M,GAAAtU,KAAAhD,OAAOA,YAHC2K,EAAAuN,KAAAA,EAIRvN,EAAKwoD,OAAS5yD,EAAQd,KAAOkL,EAAKwoD,SCpBtC,IAAAnM,IAmDEA,GAAA5nD,UAAA2nD,YAAA,SAAYzpC,GACV,GAAKA,EAAa+D,OAAlB,KAcI/gB,EACJ,OAVEgd,EAAa+D,OAAO9gB,SACpB+c,EAAa+D,OAAO9gB,QAAQs+B,0BAE5BvhB,EAAe3L,GAAAA,YAAYiK,UACzB0B,EAAa+D,OAAO9gB,QAAQs+B,wBAC5BvhB,GAAgB,KAKZA,EAAa+D,OAAO/e,aAC1B,KAAKyF,GACL,KAAK6U,GACL,KAAK3U,GACL,KAAK8U,GACL,KAAKwC,GACHjf,EAAQN,KAAKqzD,gBAAe,GAC5B,MACF,KAAKpsD,GACL,KAAKqP,GACL,KAAK6H,GACL,KAAKsB,GACL,KAAK2B,GACH9gB,EAAQN,KAAKszD,kBAAiB,GAC9B,MACF,KAAKj5C,GACH/Z,EAAQN,KAAKuzD,iBAAgB,GAC7B,MACF,KAAKxyC,GACHzgB,EAAQN,KAAKwzD,sBAAqB,GAQtC,OAAOlzD,IAGT0mD,GAAA5nD,UAAAq0D,iBAAA,SAAiBn2C,GAAjB,IAAA3S,EAAA3K,KACE,OAAIsd,EAAa+D,OACR,IAAIhJ,GAAAA,WAAU,SAACxW,GAAK,OAAAA,EAAEuC,KAAKuG,EAAKo8C,YAAYzpC,MAG9Ctd,KAAK0zD,kBACThC,sBAAsBp0C,EAAapW,eACnCkkB,KACC5Y,GAAAA,IAAG,SAAC6O,GACF,OAAIA,IAAW5Z,UACNA,UAEFkD,EAAKo8C,YAAYjnD,OAAO2C,OAAO6a,EAAc,CAAE+D,OAAMA,SAK5D2lC,GAAA5nD,UAAAm0D,iBAAR,SAAyBj2C,GACvB,OAAO,IAAIkR,GAAWlR,EAActd,KAAK8qB,kBAGnCk8B,GAAA5nD,UAAAi0D,gBAAR,SAAwB/1C,GACtB,OAAO,IAAIwS,GAAUxS,IAGf0pC,GAAA5nD,UAAAk0D,kBAAR,SAA0Bh2C,OACpB/W,EACA8zB,EAKJ,GAJI/c,EAAa/W,QAAUkB,YACzBlB,EAAQvG,KAAK2zD,aAAan9B,YAAYlZ,EAAa/W,QAGjD+W,EAAa+D,kBAAkBlD,GAEjC5X,EADe+W,EAAmB,OACnB/c,QAAQqF,OAAOW,WACzB,GAAI+W,EAAakb,iBAAkB,KAClCo7B,EAAe5zD,KAAK2zD,aAC1Br2C,EAAa/W,MAAK,SAAGlB,GACnB,OAAOuuD,EAAar7B,uBAClBlzB,EACAiY,EAAakb,mBAGjB6B,EAAU,IAAIrK,GAAY1S,GAG5B,GAAIA,EAAa+D,kBAAkBD,GAAmB,KAC9CyyC,EAAe7zD,KAAK2zD,aACpBG,EAAYx2C,EAAay2C,iBAC/Bz2C,EAAa/W,MAAK,SAAGlB,GACnB,OAAOwuD,EAAa36B,mBAClB7zB,EACAiY,EAAa6b,aACb26B,IAGJz5B,EAAU,IAAIrK,GAAY1S,OAGtB02C,EAAiBl0D,OAAO2C,OAAO,GAAI6a,EAAc,CACrD/W,MAAKA,IASP,OALE8zB,EADGA,GACO,IAAIrK,GAAYgkC,GAG5Bh0D,KAAKi0D,iBAAiB55B,EAAS25B,GAExB35B,GAGD2sB,GAAA5nD,UAAAo0D,sBAAR,SACEl2C,OAEI/W,EACA8zB,EAMJ,GAJI/c,EAAa/W,QAAUkB,YACzBlB,EAAQvG,KAAK2zD,aAAan9B,YAAYlZ,EAAa/W,QAGjD+W,EAAakb,iBAAkB,KAC3B07B,EAAel0D,KAAK2zD,aAC1Br2C,EAAa/W,MAAK,SAAGlB,GACnB,OAAO6uD,EAAa37B,uBAClBlzB,EACAiY,EAAakb,mBAGjB6B,EAAU,IAAIrH,GAAgB1V,OAG1B02C,EAAiBl0D,OAAO2C,OAAO,GAAI6a,EAAc,CACrD/W,MAAKA,IAQP,OAJE8zB,EADGA,GACO,IAAIrH,GAAgBghC,GAGhCh0D,KAAKi0D,iBAAiB55B,EAAS25B,GACxB35B,GAGD2sB,GAAA5nD,UAAA60D,iBAAR,SAAyB3zD,EAAcgd,GACjCA,EAAa62C,aACfn0D,KAAKo0D,iBAAiB92C,EAAa62C,YAAY10D,KAAKkY,UAAS,SAAC+c,GAC5D2/B,EAAc/zD,EAAMwG,GAAI4tB,EAAKpX,EAAa62C,YAAY9yC,WAKrD2lC,GAAA5nD,UAAAg1D,iBAAP,SAAwB30D,GACtB,OAAOO,KAAKkY,KAAKC,IAAI1Y,GAAK2rB,KACxB5Y,GAAAA,IAAG,SAAEkiB,GAAa,OAAAA,IAClB24B,GAAAA,WAAU,SAACC,GAET,OADAr8C,QAAQC,IAAI,sBACLqtB,GAAAA,GAAG+uB,4BA/KjB5tD,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAxCL8Z,GAAAA,kBAqCA6c,UAfAk7B,UAlBA6C,GAAAA,gBAAenxD,WAAA,CAAA,CAAAsC,KA2CnB+jC,GAAAA,+MAJH,SAAAwd,GACU9uC,EACAy7C,EACAD,EACY5oC,GAHZ9qB,KAAAkY,KAAAA,EACAlY,KAAA2zD,aAAAA,EACA3zD,KAAA0zD,kBAAAA,EACY1zD,KAAA8qB,gBAAAA,UC/CtB9B,MAAQ,QACRurC,MAAQ,aAIRxvD,IAAA,EAAKE,KAAA,EAAMuvD,WAAA,EAAYC,UAAA,mGCIzB,IAmCAn9C,MARI,SAAAo9C,GAAYn0D,EAAkBotD,GAC1B7tD,OAAO2C,OAAOzC,KAAMO,GACpBP,KAAK20D,eAAiBhH,GAM9BiH,IAAyB5tD,GAAAA,GAAzBsQ,GAAyBo9C,IAOdE,GAAAx1D,UAAAy1D,oBAAP,WACI,OAAO70D,KAAK20D,eAAeG,yBAAyB90D,OAE5D40D,IATI,SAAAA,GAAYr0D,EAAkBotD,GAA9B,IAAAhjD,EACI2M,GAAAtU,KAAAhD,KAAMO,EAASotD,IAAQ3tD,KACjB+0D,EAAgBC,GAAYA,GAAYjwD,YAC9C4F,EAAKlF,KAAQuvD,GAAYD,KAQjC,IAAAz9C,GAAA29C,IAA0BjuD,GAAAA,GAA1BsQ,GAA0Bo9C,IAOfO,GAAA71D,UAAAy1D,oBAAP,WACI,OAAO70D,KAAK20D,eAAeO,0BAA0Bl1D,OAE7Di1D,IATI,SAAAA,GAAY10D,EAAkBotD,GAA9B,IAAAhjD,EACI2M,GAAAtU,KAAAhD,KAAMO,EAASotD,IAAQ3tD,KACjB+0D,EAAgBC,GAAYA,GAAY/vD,aAC9C0F,EAAKlF,KAAQuvD,GAAYD,KAQjC,IAAAz9C,GAAA69C,IAAgCnuD,GAAAA,GAAhCsQ,GAAgCo9C,IAOrBS,GAAA/1D,UAAAy1D,oBAAP,WACI,OAAO70D,KAAK20D,eAAeS,0BAA0Bp1D,OAE7Dm1D,IATI,SAAAA,GAAY50D,EAAkBotD,GAA9B,IAAAhjD,EACI2M,GAAAtU,KAAAhD,KAAMO,EAASotD,IAAQ3tD,KACjB+0D,EAAgBC,GAAYA,GAAYR,mBAC9C7pD,EAAKlF,KAAQuvD,GAAYD,KAQjC,IAAAz9C,GAAA+9C,IAAsCruD,GAAAA,GAAtCsQ,GAAsCo9C,IAU3BW,GAAAj2D,UAAAy1D,oBAAP,WACI,OAAO70D,KAAK20D,eAAeW,+BAA+Bt1D,OAElEq1D,IAVI,SAAAA,GAAY90D,EAAkBotD,GAA9B,IAAAhjD,EACI2M,GAAAtU,KAAAhD,KAAMO,EAASotD,IAAQ3tD,KACjB+0D,EAAgBC,GAAYA,GAAYP,kBAC9C9pD,EAAKlF,KAAQuvD,GAAYD,GACzBpqD,EAAKlL,IAAM,eAUD81D,GAAAC,sBAAd,SAAoCj1D,EAAkBotD,GAalD,OAVIptD,EAAQ4B,eAAe,aACb,IAAIkzD,GAAiB90D,EAASotD,GACjCptD,EAAQkF,OAASuvD,GAAYA,GAAYR,YACtC,IAAIW,GAAkB50D,EAASotD,GAClCptD,EAAQkF,OAASuvD,GAAYA,GAAY/vD,MACtC,IAAIgwD,GAAY10D,EAASotD,GAEzB,IAAIiH,GAAWr0D,EAASotD,IAK9C4H,IAjBA,SAAAA,cCrDEE,GAAAr2D,UAAAgL,MAAA,SAAMzE,EAAiBpF,GAAvB,IAAAoK,EAAA3K,KACE,OAAO2F,EACJqE,OAAM,SAAE1J,GAAiB,OAAAA,EAAM+c,SAAW/c,EAAM2pB,uBAChDzX,IAAG,SAAElS,GAAiB,OAAAqK,EAAK+qD,WAAWp1D,EAAOC,MAGlDk1D,GAAAr2D,UAAAs2D,WAAA,SAAWp1D,EAAcC,GAAzB,IAAAoK,EAAA3K,KACQP,EAAMO,KAAK21D,YAAYr1D,EAAM2oB,WAAY1oB,GAC/C,IAAKd,EACH,OAAO8+B,GAAAA,GAAG,IAGZ,GACGj+B,EAAgB,WAAyBC,QAAQ8tD,cAClDc,GAAYj1C,SAkBd,OADgBla,KAAKkY,KAAKC,IAAI1Y,EAAK,CAAE2Y,aAAc,SACpCgT,KAAK5Y,GAAAA,IAAG,SAACkiB,GAAO,OAAA/pB,EAAKirD,YAAYlhC,EAAKp0B,EAAOC,EAASd,UAhB7Do2D,EAAS71D,KAAK21D,YAAYr1D,EAAM2oB,WAAY1oB,GAAS,GAC3D,OAAOP,KAAKkY,KAAKC,IAAI09C,EAAQ,CAAEz9C,aAAc,SAAUgT,KACrD0qC,GAAAA,SAAQ,SAACC,OACDC,EAAcrrD,EAAKsrD,SAASF,EAAQt2D,GAC1C,OAAOkL,EAAKuN,KACTC,IAAI1Y,EAAK,CAAE2Y,aAAc,SACzBgT,KACC5Y,GAAAA,IAAG,SAACkiB,GACF,OAAA/pB,EAAKirD,YAAYlhC,EAAKp0B,EAAOC,EAASd,EAAKu2D,UAWjDP,GAAAr2D,UAAA62D,SAAR,SAAiBF,EAAQt2D,OACnBy2D,EAAS,IAAItgD,EACb+C,EAAWu9C,EAAOt9C,aAAam9C,GAEX,IAApBp9C,EAAS5V,SAEX4V,GADAu9C,EAAS,IAAIC,GAAAA,mBACKv9C,aAAam9C,QAG7BK,EAGAC,EAkDAC,EAtDEC,EAAU,IAAIC,GAAAA,gBAAuB,IAErCC,EAAW,GACbC,EAAU,IAAIC,GAAAA,aAAoB,IAEhCC,EAAaj+C,EAAS5V,OAMtB8zD,EAFoB72D,KAAK82D,eAAer3D,EAAIyP,eACrB2nD,KACRpsD,MAAM,KACrBssD,EAAa5iB,EAAAA,cAuDnB,OAtDAO,EAAAA,OAAgBqiB,EAAYF,GAE5Bl+C,EAASnG,IAAG,SAACnN,OAKL2xD,EAA6B3xD,EAAQ2rB,cAAc8B,iBACnDmkC,EAAsB5xD,EAAQ2rB,cAAcW,UAMhD,OAHA0kC,EADGA,GACgBY,EAGXA,GACN,IAAK,QACgB,IAAfL,EACFR,EAAM,IAAIc,GAAAA,MAAaF,EAA4B,MAEnDP,EAAShyD,KAAKuyD,GAEhB,MACF,IAAK,aACHT,EAAQY,iBACN,IAAIC,GAAAA,WAAkBJ,EAA4B,OAEpD,MACF,IAAK,UACHN,EAAQW,cACN,IAAIC,GAAAA,QAAeN,EAA4B,OAEjD,MACF,IAAK,eACHN,EAAU,IAAIC,GAAAA,aAAoBK,EAA4B,MAC9D,MACF,QACE,UAONV,EADsB,IAApBG,EAAS1zD,QAAgBqzD,EAClB,CACP3wD,KAAM2wD,EAAIzkC,UACV8tB,YAAa2W,EAAItjC,kBAGV,CACPrtB,KAAM,UACNg6C,YAAa,CAACz/C,KAAKu3D,WAAWd,KAI1BJ,GACN,IAAK,aACH,MAAO,CACL5wD,KAAM8wD,EAAQ5kC,UACd8tB,YAAa8W,EAAQzjC,kBAEzB,IAAK,QACH,OAAOwjC,EACT,IAAK,UAKL,IAAK,eACH,MAAO,CACL7wD,KAAMixD,EAAQ/kC,UACd8tB,YAAaiX,EAAQ5jC,kBAEzB,QACE,SAIN2iC,GAAAr2D,UAAAo4D,MAAA,SAAMxwB,EAAGllC,EAAGkC,GACV,OAAQgjC,EAAE,GAAKhjC,EAAE,KAAOlC,EAAE,GAAKkC,EAAE,KAAOgjC,EAAE,GAAKhjC,EAAE,KAAOlC,EAAE,GAAKkC,EAAE,KAQnEyxD,GAAAr2D,UAAAm4D,WAAA,SAAWhO,WACTA,EAAOroB,KAAI,SAAE8F,EAAGllC,GACd,OAAOklC,EAAE,KAAOllC,EAAE,GAAKklC,EAAE,GAAKllC,EAAE,GAAKklC,EAAE,GAAKllC,EAAE,SAG1C21D,EAAQ,OACd,IAAoB,IAAAC,EAAAl6C,GAAA+rC,GAAMoO,EAAAD,EAAAtzD,QAAAuzD,EAAAtzD,KAAAszD,EAAAD,EAAAtzD,OAAE,CAC1B,IADG,IAAMojD,EAAKmQ,EAAAz3D,MAEI,GAAhBu3D,EAAM10D,QACN/C,KAAKw3D,MAAMC,EAAMA,EAAM10D,OAAS,GAAI00D,EAAMA,EAAM10D,OAAS,GAAIykD,IAAU,GAEvEiQ,EAAM75C,MAER65C,EAAMhzD,KAAK+iD,wGAIb,QADMoQ,EAAQ,GACLh1D,EAAI2mD,EAAOxmD,OAAS,EAAQ,GAALH,EAAQA,IAAK,CAC3C,KACkB,GAAhBg1D,EAAM70D,QACN/C,KAAKw3D,MACHI,EAAMA,EAAM70D,OAAS,GACrB60D,EAAMA,EAAM70D,OAAS,GACrBwmD,EAAO3mD,KACJ,GAELg1D,EAAMh6C,MAERg6C,EAAMnzD,KAAK8kD,EAAO3mD,IAKpB,OAFAg1D,EAAMh6C,MACN65C,EAAM75C,MACC65C,EAAM7yD,OAAOgzD,IAGdnC,GAAAr2D,UAAAw2D,YAAR,SACElhC,EACAp0B,EACAC,EACAd,EACAo4D,GALF,QAAAltD,EAAA3K,KAOQ83D,EAAkBx3D,EAAgB,WAElCy3D,EAAwB/3D,KAAKg4D,yBAAyB13D,GACxDqY,EAAW,GACf,OAAQm/C,EAAgBv3D,QAAQ8tD,aAC9B,KAAKc,GAAYv1C,KACfjB,EAAW3Y,KAAKi4D,gBACdvjC,EACAp0B,EAAM6oB,OACN4uC,GAEF,MACF,KAAK5I,GAAY9lD,KACjB,KAAK8lD,GAAYt1C,QACjB,KAAKs1C,GAAYr1C,SACfnB,EAAW3Y,KAAKk4D,mBAAmBxjC,GACnC,MACF,KAAKy6B,GAAYp1C,SACfpB,EAAW3Y,KAAKm4D,oBAAoBzjC,EAAKp0B,EAAM6oB,QAC/C,MACF,KAAKgmC,GAAYn1C,KACfrB,EAAW3Y,KAAKo4D,gBAAgB1jC,GAChC,MACF,KAAKy6B,GAAYl1C,KACftB,EAAW3Y,KAAKq4D,gBACd3jC,EACAojC,EAAgBv9C,gBAChB9a,GAEF,MACF,KAAK0vD,GAAYj1C,SACfvB,EAAW3Y,KAAKq4D,gBACd3jC,EACAojC,EAAgBv9C,gBAChB9a,EACAo4D,GAEF,MACF,KAAK1I,GAAYx1C,KACjB,QACEhB,EAAW3Y,KAAKs4D,gBAAgB5jC,EAAKp0B,EAAOy3D,GAIhD,GAAsB,EAAlBp/C,EAAS5V,QAAsC,MAAxB4V,EAAS,GAAGvN,SAAkB,KACjDmtD,EAAYv4D,KAAKw4D,2BAA2B/4D,OAElD,IAAsB,IAAAg5D,EAAAj7C,GAAA7E,GAAQ+/C,EAAAD,EAAAr0D,QAAAs0D,EAAAr0D,KAAAq0D,EAAAD,EAAAr0D,OAAZs0D,EAAAx4D,MACRkL,SAAWmtD,uGAIvB,OAAO5/C,EAASnG,IAAG,SAAEnN,EAAkB0L,OAGjCiiC,EAFE14B,EAAWjV,EAAQ+O,WAAW0jD,EAAgBx9C,UAGpD,GAAyC,QAArCha,EAAMC,QAAQ2G,cAAczB,KAAgB,KACxCyB,EAAgB5G,EAAMC,QACZ,cAChByyC,EAAU9rC,EAAgBA,EAAcgsC,iBAAmBzrC,cAGzDoK,EAAQlH,EAAKguD,cAActzD,EAAS/E,GAEtCuR,GADGA,GAA2B,EAAlB8G,EAAS5V,OACVzC,EAAMuR,MAAK,MAAKd,EAAQ,GAAC,IAC1Bc,GACFvR,EAAMuR,UAGV6gC,EAAO5yC,OAAO2C,OAAO,GAAI4C,EAAQqtC,MAAQ,GAAI,CACjD7rC,GAAIT,GAAAA,OACJyL,MAAKA,EACLygC,SAAUh4B,EACVs+C,YAAat4D,EAAMuR,MACnBgnD,MAAO,IAAOv4D,EAAM6oB,OACpB+pB,iBAAkBF,IAGpB,OAAOlzC,OAAO2C,OAAO4C,EAAS,CAC5BqtC,KAAIA,EACJ/pB,WACmC,UAAjCmvC,EAAgBv3D,QAAQkF,KACpB,YACAlF,EAAQooB,gBAKZ8sC,GAAAr2D,UAAAo5D,2BAAR,SAAmC/4D,OAC3Bq5D,EAAoB94D,KAAK82D,eAAer3D,EAAIyP,eAC5C6pD,EAAUD,EAAajC,KACvB/gC,EAAQ/W,SAAS+5C,EAAahjC,MAAO,IACrC1H,EAASrP,SAAS+5C,EAAa1qC,OAAQ,IACvC4qC,EAAYj6C,SAAS+5C,EAAal2D,GAAKk2D,EAAa5jB,EAAG,IACvD+jB,EAAYl6C,SAAS+5C,EAAa76C,GAAK66C,EAAaI,EAAG,IAGvDrC,GAFaiC,EAAaK,KAAOL,EAAahkD,IAEvCikD,EAAQtuD,MAAM,MACvB2uD,EACgE,KAAjEx+C,KAAKy+C,IAAIt0C,WAAW8xC,EAAK,KAAOj8C,KAAKy+C,IAAIt0C,WAAW8xC,EAAK,MAGxDj8C,KAAKy+C,IAAIt0C,WAAW8xC,EAAK,KAAO,MAClCuC,EAAY,UAERE,EACJv0C,WAAW8xC,EAAK,IACfj8C,KAAKy+C,IAAIt0C,WAAW8xC,EAAK,IAAM9xC,WAAW8xC,EAAK,KAAOmC,EACrDljC,EACFsjC,EACIG,EACJx0C,WAAW8xC,EAAK,IACfj8C,KAAKy+C,IAAIt0C,WAAW8xC,EAAK,IAAM9xC,WAAW8xC,EAAK,KAAOoC,EACrD7qC,EACFgrC,EACII,EAAUF,EAAqB,EAAZF,EACnBK,EAAUF,EAAqB,EAAZH,EAEnBM,EACJ,YACAJ,EACA,IACAC,EACA,KACAD,EACA,IACAG,EACA,KACAD,EACA,IACAC,EACA,KACAD,EACA,IACAD,EACA,KACAD,EACA,IACAC,EACA,KAIItpD,GAFS,IAAI0pD,GAAAA,KACgBp5C,YAAYm5C,GACjB1oC,cAO9B,MALgB,CACdvrB,KAAMwK,EAAE0hB,UACR8tB,YAAaxvC,EAAE6iB,mBAMX2iC,GAAAr2D,UAAAk5D,gBAAR,SAAwB5jC,EAAKvL,EAAQ4uC,GAArC,IAAAptD,EAAA3K,KACMk2D,EAAS,IAAItgD,EACb+C,EAAWu9C,EAAOt9C,aAAa8b,GAEnC,GAAwB,IAApB/b,EAAS5V,OAAc,CACzBmzD,EAAS,IAAIC,GAAAA,kBACb,IACEx9C,EAAWu9C,EAAOt9C,aAAa8b,GAC/B,MAAOnwB,GACP0M,QAAQ2oD,KACN,6FAKN,OAAOjhD,EAASnG,IAAG,SAACnN,GAClB,OAAAsF,EAAKkvD,gBAAgBx0D,EAAS8jB,EAAQ4uC,MAIlCtC,GAAAr2D,UAAA64D,gBAAR,SAAwBvjC,EAAKvL,EAAQ4uC,GAArC,IAAAptD,EAAA3K,KACQk2D,EAAS,IAAIpgD,EACf6C,EAAW,GACf,IACEA,EAAWu9C,EAAOt9C,aAAa8b,GAC/B,MAAOnwB,GACP0M,QAAQ2oD,KAAK,6CAEf,OAAOjhD,EAASnG,IAAG,SAACnN,GAClB,OAAAsF,EAAKkvD,gBAAgBx0D,EAAS8jB,EAAQ4uC,MAIlCtC,GAAAr2D,UAAA84D,mBAAR,SAA2BxjC,OACrB/b,EAAW,GACf,IACEA,EAAWtP,KAAKo1B,MAAM/J,GAAK/b,SAC3B,MAAOpU,GACP0M,QAAQ2oD,KAAK,yCAA0C,KAAMllC,GAE/D,OAAO/b,GAGD88C,GAAAr2D,UAAA+4D,oBAAR,SAA4BzjC,EAAKvL,GAAjC,IAAAxe,EAAA3K,KAIE,OAHe,IAAIqe,GACKzF,aAAa8b,GAErBliB,IAAG,SAACnN,GAAW,OAAAsF,EAAKkvD,gBAAgBx0D,EAAS8jB,MAGvDssC,GAAAr2D,UAAAg5D,gBAAR,SAAwB1jC,GAEtB,MAAO,IAGD+gC,GAAAr2D,UAAAi5D,gBAAR,SACE3jC,EACAolC,EACAr6D,EACAo4D,OAEMiB,EAAoB94D,KAAK82D,eAAer3D,EAAIyP,eAC5CyZ,EAAamwC,EAAaK,KAAOL,EAAahkD,KAAO,YACrDyjD,EAAYv4D,KAAKw4D,2BAA2B/4D,GAGhDq6D,IAAet/C,GAAgBJ,OAC/B0/C,IAAet/C,GAAgBL,SAE/B2/C,EAAat/C,GAAgBL,YAGzB4/C,EAAerlC,EAAIxlB,cAAc8B,QAAQ,UACzCgpD,EAAatlC,EAAIxlB,cAAc+qD,YAAY,WAAa,EAG9D,MAAa,kBADAvlC,EAAIqC,MAAMgjC,EAAcC,GAAYjsD,QAAQ,cAAe,KAChC,KAAR2mB,EACvB,GAGF,CACL,CACEjvB,KAAM8b,GACNoH,WAAUA,EACVvU,WAAY,CAAEhR,OAAQ02D,EAAYI,KAAMxlC,EAAKj1B,IAAGA,GAChD2L,SAAUysD,GAAmBU,KAK3B9C,GAAAr2D,UAAA03D,eAAR,SAAuBr3D,OACf06D,EAAc16D,EAAIgL,MAAM,KAC9B,GAAK0vD,EAAY,GAAjB,KAGMC,EAAQD,EAAY,GAAG1vD,MAAM,KAE7B+gD,EAAS,GAKf,OAJA4O,EAAMvvD,QAAO,SAACwvD,GACZA,EAAOA,EAAK5vD,MAAM,KAClB+gD,EAAO6O,EAAK,IAAMC,mBAAmBD,EAAK,IAAM,MAE3C7O,IAGFiK,GAAAr2D,UAAAy6D,gBAAP,SACEU,EACApxC,EACA4uC,OAUI3sD,EAREovD,EAAkBD,EAAUvpC,cAC5B5c,EAAkBtU,OAAO2C,OAAO,GAAI83D,EAAUnhD,iBAepD,cAdOhF,EAAWhJ,gBACXgJ,EAAWiF,iBACXjF,EAAWqmD,aACXrmD,EAAWsmD,aACXtmD,EAAWumD,SAGdH,IAAoB/yD,YACtB2D,EAAW,CACT3F,KAAM+0D,EAAgB7oC,UACtB8tB,YAAa+a,EAAgB1nC,mBAI1B,CACLrtB,KAAM8b,GACNoH,WAAYlhB,UACZ2M,WAAUA,EACVhJ,SAAQA,EACRsnC,KAAM,CACJ7rC,GAAIT,GAAAA,OACJyyD,MAAO,IAAO1vC,EACdtR,MAAOkgD,KAKLtC,GAAAr2D,UAAAu2D,YAAR,SACEiF,EACAr6D,EACAs6D,OAEIp7D,EACJ,YAHA,IAAAo7D,IAAAA,GAAA,GAGQD,EAAWt4D,aACjB,KAAK+X,OACGygD,EAAa,EAEbC,EAA2B,CAC/BC,YACEF,EAAcl1D,OAAOo1D,aACrBh7D,KAAKi7D,kBAAkBL,EAAWr6D,QAAQ8tD,aAC5C6M,aAAcJ,EAAcl1D,OAAOC,OACnCs1D,cAAeL,EAAcl1D,OAAOu1D,eAAiB,KAGnDN,IACFE,EAAyBC,YAAch7D,KAAKi7D,kBAC1C9L,GAAYx1C,OAIhBla,EAAMq7D,EAAch0D,GAAGs0D,qBACrB76D,EAAQk/C,YACRl/C,EAAQiW,WACRjW,EAAQooB,WACRoyC,GAUF,MACF,KAAKh+C,OACGs+C,EAAe,EACfnkD,EACJ,WACAmkD,EAAgB96D,QAAQusD,QACxB,yBAEIwO,EACJ,MAAQD,EAAgB96D,QAAQ4c,OAAOxX,OAAO,GAAGpF,QAAQ+6D,IAGrDC,EAASF,EAAgB96D,QAAQi7D,eACnCH,EAAgB96D,QAAQi7D,eACxB,OASJ/7D,EAASyX,EAhBM,iBAgBaokD,EAZ1B,2EAKA/6D,EAAQk/C,YAAY,GACpB,IACAl/C,EAAQk/C,YAAY,GACpB,WACA8b,EACA,KAGF,MACF,KAAKh8C,OACGk8C,EAAwB,EAC1BzyD,EAAS0yD,EAAAA,eAAwB,CAACn7D,EAAQk/C,cAC1Cgc,EAAyBl7D,QAAQi7D,iBACnCxyD,EAAS2yD,EAAAA,OACP3yD,EACAyyD,EAAyBl7D,QAAQi7D,iBA6BrC/7D,EAzBEg8D,EAAyBl7D,QAAQd,IACjC,IACAg8D,EAAyBl7D,QAAQD,MACjC,WAYa,CACb,SACA,YAbeie,mBACf,WACEvV,EAAO,GACP,WACAA,EAAO,GACP,WACAA,EAAO,GACP,WACAA,EAAO,GACP,wCAKF,oCACA,cACA,sCACA,cACA,sBACA,gBAE4BS,KAAK,KAMvC,OAAOhK,GAGDg2D,GAAAr2D,UAAA67D,kBAAR,SAA0B5M,OACpBuN,EAAO,0BACL1M,EAAUpvD,OAAOk4B,KAAKm3B,IAAargD,KAAI,SAC3CzL,GAAO,OAAA8rD,GAAY9rD,KAASgrD,IAM9B,OAJIa,IACF0M,EAAO/M,GAAoBK,IAGtB0M,GAGTnG,GAAAr2D,UAAA44D,yBAAA,SAAyB13D,OACnBy3D,EAcJ,OAZEz3D,EAAMC,SACND,EAAMC,QAAQ8gB,QACd/gB,EAAMC,QAAQ8gB,OAAO9gB,SACrBD,EAAMC,QAAQ8gB,OAAO9gB,QAAQyU,cACuB,GAApD1U,EAAMC,QAAQ8gB,OAAO9gB,QAAQyU,aAAajS,SAE1Cg1D,EAAwB,GACxBz3D,EAAMC,QAAQ8gB,OAAO9gB,QAAQyU,aAAanK,QAAO,SAACgR,OAC1ChE,EAAQgE,EAAYhE,MAAQgE,EAAYhE,MAAQgE,EAAY7M,KAClE+oD,EAAsBl8C,EAAY7M,MAAQ6I,KAGvCkgD,GAGTtC,GAAAr2D,UAAAu5D,cAAA,SAActzD,EAAkB/E,OAC1BuR,EACJ,GAAIvR,EAAMC,SAAWD,EAAMC,QAAQ8gB,QAAU/gB,EAAMC,QAAQ8gB,OAAO9gB,QAAS,KACnE0T,EAAoB3T,EAAMC,QAAQ8gB,OAC9B,QACNpN,EAAkBnM,aACpB+J,EAAQ7R,KAAK67D,cAAcx2D,EAAS4O,EAAkBnM,aAI1D,OAAO+J,GAGT4jD,GAAAr2D,UAAAy8D,cAAA,SAAcx2D,EAAkBy0B,OAC1Bxa,EAAQwa,EACNC,EAAa93B,MAAM+3B,KAAKF,EAAWG,SAAS,sBAWlD,OATAF,EAAWlvB,QAAO,SAAC4O,GACjB6F,EAAQA,EAAMvR,QAAQ0L,EAAE,GAAIpU,EAAQ+O,WAAWqF,EAAE,OAIzB,IAAtBsgB,EAAWh3B,QAAgBuc,IAAUwa,IACvCxa,EAAQja,EAAQ+O,WAAW0lB,IAAeA,GAGrCxa,wBAxoBV5f,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAnCL8Z,GAAAA,mJAwCP,SAAA+7C,GAAoBv9C,GAAAlY,KAAAkY,KAAAA,EAFblY,KAAA87D,cAAe,ECJxB,IAAAC,IAwDEj8D,OAAAC,eAAIg8D,GAAA38D,UAAA,MAAG,KAAP,WACE,OAAQY,KAAKu0B,UAAa,qCAY5BwnC,GAAA38D,UAAAo0B,gBAAA,WACExzB,KAAK8uC,oBAOPitB,GAAA38D,UAAAs0B,YAAA,WACE1zB,KAAKg8D,uBACLh8D,KAAK2uC,sBAMCotB,GAAA38D,UAAA0vC,iBAAR,WAAA,IAAAnkC,EAAA3K,KACEA,KAAK2vC,iBAAmB3vC,KAAKwS,IAAI1L,GAAGolB,GAClC,cAAa,SACZ7L,GAAoC,OAAA1V,EAAKsxD,WAAW57C,MAOjD07C,GAAA38D,UAAAuvC,mBAAR,WACE3uC,KAAKwS,IAAI1L,GAAGwlB,GAAGtsB,KAAK2vC,iBAAiBlqC,KAAMzF,KAAK2vC,iBAAiBE,UACjE7vC,KAAK2vC,iBAAmBloC,WAOlBs0D,GAAA38D,UAAA68D,WAAR,SAAmB57C,GAAnB,IAAA1V,EAAA3K,KAEE,GADAA,KAAKg8D,uBACAh8D,KAAKk8D,aAAaJ,aAAvB,KAIMK,EAAW,GACbn8D,KAAKo8D,eACPD,EAAS13D,KAAKzE,KAAKq8D,gBAAgBh8C,QAG/B7J,EAAaxW,KAAKwS,IAAI1L,GAAG8rB,UAAUjI,gBACnC2xC,EAAct8D,KAAKwS,IAAI7M,OAAOqE,OAAOkwB,IAC3CiiC,EAAS13D,KAAIxB,MAAbk5D,EAAQx3D,GACH3E,KAAKk8D,aAAa9xD,MAAMkyD,EAAa,CACtC7c,YAAap/B,EAAMyiC,WACnBn6B,WAAY3oB,KAAKwS,IAAImW,WACrBnS,WAAUA,MAIU,IAApB2lD,EAASp5D,SAIT/C,KAAKu8D,kBACPv8D,KAAKw8D,UAAU/3D,KACbg4D,GAAAA,IAAGx5D,WAAA,EAAA0B,GAAIw3D,IAAUxkD,UAAS,SAAE+kD,OACpB/jD,EAAW,GAAG/T,OAAM3B,MAAT,GAAE0B,GAAW+3D,IAC9B/xD,EAAKP,MAAM0yB,KAAK,CAAEnkB,SAAQA,EAAE0H,MAAKA,OAIrCrgB,KAAKw8D,UAAYL,EAAS3pD,IAAG,SAAEmqD,GAC7B,OAAOA,EAAOhlD,UAAS,SAAEgB,GACvBhO,EAAKP,MAAM0yB,KAAK,CAAEnkB,SAAQA,EAAE0H,MAAKA,WAUjC07C,GAAA38D,UAAAi9D,gBAAR,SACEh8C,GADF,IAAA1V,EAAA3K,KAGQ48D,EAAkB,GAExB58D,KAAKwS,IAAI1L,GAAG+1D,sBACVx8C,EAAM4vB,MAAK,SACVsqB,EAAsBuC,WACrB,GAAIvC,EACF,GAAIA,EAAUpiD,IAAI,gBAChB,IAAsB,IAAA+G,EAAA1B,GAAA+8C,EAAUpiD,IAAI,aAAWgH,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAA5C,IACG24D,EAAazvB,GADVjoC,EAAO8Z,EAAAjf,MAC0ByK,EAAK6H,IAAImW,YACnDo0C,EAAWrqB,KAAO,CAChB7gC,MAAOxM,EAAQ23D,QAAQC,IACvBp2D,GAAIxB,EAAQ63D,IACZxkC,KAAMrzB,EAAQ23D,QAAQG,MACtBvE,YAAakE,EAAQE,QAAQnrD,OAE/B+qD,EAAgBn4D,KAAKs4D,6GAElB,GAAIxC,aAAqB6C,EAAiB,KAEzC/3D,EAAUutC,GACd2nB,EACA5vD,EAAK6H,IAAImW,WACTm0C,GAEFF,EAAgBn4D,KAAKY,QAEfA,EAAUioC,GACditB,EACA5vD,EAAK6H,IAAImW,WACTm0C,GAEFF,EAAgBn4D,KAAKY,IAI3B,CACE6qC,aAAclwC,KAAKq9D,2BAA6B,EAChDltB,YAAanwC,KAAKs9D,uBACdt9D,KAAKs9D,uBACLljC,SAIFmjC,EAAkBv9D,KAAKwS,IAAI7M,OAAOqE,OAAOkwB,IAa/C,OAZA0iC,EAAgB/xD,QAAO,SAAExF,GACvBk4D,EAAgB1yD,QAAO,SAAEvK,GACwB,oBAApCA,EAAMwG,GAAG6nB,YAAY6uC,YAC1Bl9D,EAAMwG,GAAG6nB,YAAY6uC,WAAWn4D,EAAQyB,MAC1CzB,EAAQqtC,KAAK76B,MAAQlN,EAAKuxD,aAAalE,yBAAyB13D,GAChE+E,EAAQqtC,KAAK7gC,MAAQxM,EAAQqtC,KAAK7gC,OAASlH,EAAKuxD,aAAavD,cAActzD,EAAS/E,GACpF+E,EAAQqtC,KAAKkmB,YAAct4D,EAAMuR,WAMlC0sB,GAAAA,GAAGq+B,IAMJb,GAAA38D,UAAA48D,qBAAR,WACEh8D,KAAKw8D,UAAU3xD,QAAO,SAAE4yD,GAAsB,OAAAA,EAAI/yC,gBAClD1qB,KAAKw8D,UAAY,yBAxNpB5nC,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,2DAdHyyB,GAAmB/vB,WAAA,CAAA,CAAAsC,KA0EvBovB,GAAAA,cAtEI4gC,8CAoCN30D,GAAAA,yCAKAA,GAAAA,sCAKAA,GAAAA,iCAKAA,GAAAA,qBAKAs8B,GAAAA,UA2KH2+B,IA9JE,SAAAA,GACkBxnC,EACR2nC,GADQl8D,KAAAu0B,UAAAA,EACRv0B,KAAAk8D,aAAAA,EAvDFl8D,KAAAw8D,UAA4B,GAoB3Bx8D,KAAAo8D,eAAyB,EAKzBp8D,KAAAq9D,0BAAoC,EAUpCr9D,KAAAu8D,mBAA6B,EAK5Bv8D,KAAAoK,MAAQ,IAAIozB,GAAAA,aCrExB,IAAAkgC,IAuBEA,GAAAt+D,UAAAshB,MAAA,WACE,MAAM,IAAIhZ,MAAM,8CAMlBg2D,GAAAt+D,UAAAuyB,QAAA,WACE,MAAM,IAAIjqB,MAAM,gDAORg2D,GAAAt+D,UAAAu+D,kBAAV,WACE,MAAM,IAAIj2D,MAAM,0DAMlB5H,OAAAC,eAAI29D,GAAAt+D,UAAA,QAAK,KAAT,WACE,OAAOY,KAAKO,QAAQsR,uCAMtB/R,OAAAC,eAAI29D,GAAAt+D,UAAA,YAAS,KAAb,WACE,OAAkC,IAA3BY,KAAKO,QAAQq9D,2CAMtB99D,OAAAC,eAAI29D,GAAAt+D,UAAA,UAAO,KAGX,WACE,OAAOY,KAAK49D,YAAsC,IAAzB59D,KAAKO,QAAQkI,aAJxC,SAAYvI,GACVF,KAAKO,QAAQkI,QAAUvI,mCAMzBJ,OAAAC,eAAI29D,GAAAt+D,UAAA,uBAAoB,KAAxB,eACQy+D,EAAuB79D,KAAKO,QAAQs9D,qBAC1C,OAAOA,IAA8C,mCAGvD/9D,OAAAC,eAAI29D,GAAAt+D,UAAA,iBAAc,KAAlB,eACQ0+D,EAAiB99D,KAAKO,QAAQu9D,eACpC,OAAOA,IAAmBr2D,WAAmBq2D,mCAM/Ch+D,OAAAC,eAAI29D,GAAAt+D,UAAA,YAAS,KAAb,WACE,OAAOY,KAAKO,QAAQw9D,2CAMtBj+D,OAAAC,eAAI29D,GAAAt+D,UAAA,SAAM,KAAV,WACE,OAAOY,KAAKO,QAAQqF,SAAW6B,UAAY,GAAKzH,KAAKO,QAAQqF,wCAM/D9F,OAAAC,eAAI29D,GAAAt+D,UAAA,WAAQ,KAAZ,WACE,OAAOY,KAAKO,QAAQy9D,WAAav2D,UAAY,GAAKzH,KAAKO,QAAQy9D,0CAMjEN,GAAAt+D,UAAA6+D,oBAAA,SAAoBC,GAApB,MAAAvzD,EAAA3K,KACE,OAAQk+D,EAAQz4D,MACd,IAAK,cACHy4D,EAAQpmD,OAAOjN,QAAO,SAACoY,SACjBA,EAAKxa,UACPkC,EAAKpK,QAAQqF,OAAS9F,OAAO2C,OAAOkI,EAAKpK,QAAQqF,QAAU,KAAEkf,EAAA,IAC1Do5C,EAAQlvD,MAAOiU,EAAK/iB,aAI3B,MACF,IAAK,eACCi+D,EAAY,GAChBD,EAAQpmD,OACL9N,OAAM,SAACrH,GAAK,OAAgB,IAAhBA,EAAEi7D,YACd/yD,QAAO,SAACoY,GACHA,EAAKxa,UACP01D,GAAal7C,EAAK/iB,MAAQ,OAGhCi+D,EAAYA,EAAUpnC,MAAM,GAAI,GAChC/2B,KAAKO,QAAQqF,OAAS9F,OAAO2C,OAAOzC,KAAKO,QAAQqF,QAAU,KAAEkf,EAAA,IAC1Do5C,EAAQlvD,MAAOmvD,QASxBr+D,OAAAC,eAAI29D,GAAAt+D,UAAA,eAAY,KAAhB,WACE,OAAOY,KAAKO,QAAQs4D,QAAUpxD,UAAY,GAAKzH,KAAKO,QAAQs4D,uCAiB9D6E,GAAAt+D,UAAAg/D,iBAAA,SAAiBl4B,EAAcm4B,OACvBC,EAAWp4B,EAAKxwB,MAAM,cAC5B,IAAK4oD,EACH,OAAO72D,cAGH82D,EAAsBv+D,KAAKw+D,kBAAkBH,GAC7CI,EAAgB,GA0BtB,OAzBAH,EAASzzD,QAAO,SAAC6zD,GACfH,EAAoBzmD,OAAOjN,QAAO,SAACoY,OAC3B07C,EAAaD,EAAQE,UAAU,GACrC,GAA0B,iBAAf37C,EAAK/iB,MAAoB,KAC5B2+D,EAAQ57C,EAAK/iB,MAChBgP,cACAowB,UAAU,OACVvxB,QAAQ,mBAAoB,IAC5BtD,MAAM,KACHsG,EAAQ8tD,EAAM7tD,QAClB2tD,EACGzvD,cACAowB,UAAU,OACVvxB,QAAQ,mBAAoB,MAElB,IAAXgD,GACF0tD,EAAch6D,KAAKo6D,EAAM9tD,IAGzBkS,EAAKq7C,WAAmD,IAAvCr7C,EAAKq7C,SAASttD,QAAQ2tD,IACzCF,EAAch6D,KAAKwe,EAAK/iB,WAKvBu+D,EAAcz0D,OAAM,SAAEg9B,EAAGllC,GAAM,OAAA28D,EAAcztD,QAAQg2B,KAAOllC,KAGrE47D,GAAAt+D,UAAAo/D,kBAAA,SAAkBM,GAChB,OAAO9+D,KAAK29D,oBAAoBK,SAASlvD,KAAI,SAC1C5O,GACC,OAAOA,EAAM8O,OAAS8vD,KAvLrBpB,GAAA72D,GAAK,GAML62D,GAAAj4D,KAAO,GAqLhBi4D,IAzDE,SAAAA,GAAYn9D,GAAZ,IAAAoK,EAAA3K,KACEA,KAAKO,QAAUA,EACfP,KAAKO,QAAUT,OAAO2C,OAAO,GAAIzC,KAAK29D,oBAAqBp9D,GAG3DP,KAAKg+D,SAASnzD,QAAO,SAACqzD,GACpBvzD,EAAKszD,oBAAoBC,KCjJ/B,IAAA5mD,GAAAynD,IACuC/3D,GAAAA,GADvCsQ,GACuComD,IAQrCqB,GAAA3/D,UAAAshB,MAAA,WACE,OAAOq+C,GAAkBl4D,IAG3Bk4D,GAAA3/D,UAAAuyB,QAAA,WACE,OAAOotC,GAAkBt5D,MAGjBs5D,GAAA3/D,UAAAu+D,kBAAV,WACE,MAAO,CACL9rD,MAAO,UAjBJktD,GAAAl4D,GAAK,MACLk4D,GAAAt5D,KAAO8b,wBAHf7hB,GAAAA,mFAKc0zD,GAAAA,OAAMzzD,KAAA,CAAC,gBAiBtBo/D,IAjBE,SAAAA,GAA+Bx+D,UAC7B+W,GAAAtU,KAAAhD,KAAMO,IAAQP,KCflB,IAAAg/D,IACSA,GAAAC,uBAAP,SAA8B/7C,EAAKC,GACjC,MAAO,iCAAmCA,EAAM,IAAMD,GAGjD87C,GAAAE,wBAAP,SAA+Bh8C,EAAKC,GAClC,MAAO,+CAAiDA,EAAM,IAAMD,GAG/D87C,GAAAG,sBAAP,SAA6BnwD,GAE3B,MAAO,iCADaowD,UAAUpwD,IAGlCgwD,IAbA,SAAAA,MCAA,IAAAK,IACSA,GAAAC,qBAAP,SAA4Bp8C,EAAKC,EAAKsD,GAEpC,YAFoC,IAAAA,IAAAA,EAAA,IAE5B,uCAAuCtD,EAAG,SAASD,EAAG,QAAQuD,EAAI,IAAItD,EAAG,IAAID,GAGhFm8C,GAAAE,qBAAP,SAA4Br8C,EAAKC,EAAKsD,GACpC,YADoC,IAAAA,IAAAA,EAAA,IAC5B,kCAAkCtD,EAAG,IAAID,EAAG,IAAIuD,EAAI,KAEhE44C,IATA,SAAAA,cCsCEG,GAAApgE,UAAAqgE,aAAA,eACQC,EAAgB1/D,KAAKmd,OAAOinC,UAAU,YAAc,GACpDub,EAAgB3/D,KAAKmd,OAAOinC,UAAU,YAAc,GACpDwb,EAASD,EAAclgE,KAAOigE,EAAcjgE,IAC5CogE,EAAqBF,EAAcG,SAAW,GAE9CC,EAAe,GAErB,GAAIH,EAAQ,CAEV,GAAID,EAAcpa,WAAY,KAGtBya,EAAoB,CACxB,CACEn5D,GAAI,qBACJgL,MALc7R,KAAKk/B,gBAAgBC,UACfC,QAAQ,8BAK5B3/B,IAAQmgE,EAAM,cACdn6D,KAAM,eAGVs6D,EAAat7D,KAAK85B,GAAAA,GAAGyhC,QAIjBC,EAAmBjgE,KAAKkY,KAC3BC,IAAkBynD,EAAM,aACxBx0C,KACC5Y,GAAAA,IAAG,SAAC0tD,GACF,OAAAA,EAAS1tD,IAAG,SAAEjP,GAAW,OAAAzD,OAAO2C,OAAOc,EAAGA,EAAEhD,aAE9C8sD,GAAAA,WAAU,SAAE8S,GAAiC,OAAA3/B,GAAAA,SAEjDu/B,EAAat7D,KAAKw7D,GAmBpB,OAfgC,EAA5BJ,EAAmB98D,QACrBg9D,EAAat7D,KACX85B,GAAAA,GAAGshC,GAAoBz0C,KACrB5Y,GAAAA,IAAG,SAAE0tD,GACH,OAAAA,EAAS1tD,IAAG,SAACjP,GAIX,OAHKA,EAAEsD,KACLtD,EAAEsD,GAAKT,GAAAA,QAEF7C,QAOVk5D,GAAAA,IAAGx5D,WAAA,EAAA0B,GAAIo7D,IAAc30C,KAC1B5Y,GAAAA,IAAG,SAAE0tD,GAA0B,MAAA,GAAGt7D,OAAO3B,MAAM,GAAIi9D,OAIvDV,GAAApgE,UAAAghE,iBAAA,SAAiBC,GAGf,OADa9K,GAAeC,sBAAsB6K,EAASrgE,MACzC60D,uBAGpB2K,GAAApgE,UAAAg2D,0BAAA,SAA0BiL,GACxB,OAAOrgE,KAAKsgE,4BAA4BD,GAASj1C,KAC/C5Y,GAAAA,IAAG,SAAE+tD,OACGnjD,EAAQmjD,EAAc/tD,IAAG,SAAE8K,GAC/B,MAAA,CACEzW,GAAI/B,GAA4BwY,EAAapW,eAC7C2K,MAAOyL,EAAazL,MACpBpM,KAAM+6D,GAAgBx3C,MACtBzoB,QAAS+c,KAGb,MAAO,CACL,CACEzW,GAAI,2BACJpB,KAAM+6D,GAAgBjM,MACtB1iD,MAAOwuD,EAAQxuD,MACfuL,MAAKA,QAOPoiD,GAAApgE,UAAAkhE,4BAAR,SACED,GAEA,OAAOrgE,KAAKkY,KAAKC,IAAoBkoD,EAAQ5gE,MAG/C+/D,GAAApgE,UAAA01D,yBAAA,SAAyBuL,GAAzB,IAAA11D,EAAA3K,KACE,OAAOA,KAAKygE,uBAAuBJ,GAASj1C,KAC1C5Y,GAAAA,IAAG,SAAEi6C,OACGrvC,EAAQ,GAMd,OALAzS,EAAK+1D,sBACHL,EACA5T,EAAa2B,WAAWplC,MACxB5L,GAEKA,MAKboiD,GAAApgE,UAAA81D,0BAAA,SAA0BmL,GAA1B,IAAA11D,EAAA3K,KACE,OAAOA,KAAKygE,uBAAuBJ,GAASj1C,KAC1C5Y,GAAAA,IAAG,SAAEi6C,GAAsB,OAAA9hD,EAAKg2D,aAAaN,EAAS5T,OAI1D+S,GAAApgE,UAAAk2D,+BAAA,SAA+B+K,GAA/B,IAAA11D,EAAA3K,KACQ4gE,EAAmB,EAA8BnM,UAEjDoM,EAAoB,GAC1BD,EAAiBpuD,IAAG,SAAE+hB,GACpB,OAAAssC,EAAqBp8D,KACnB8wD,GAAeC,sBAAsBjhC,EAAW5pB,UAK9Cm2D,EAAY,GAClBD,EAAqBruD,IAAG,SAAE+hB,GACxB,OAAAusC,EAAUr8D,KAAK8vB,EAAUsgC,6BAIvBkM,EAAY,GAYhB,GACEjhE,OAAOk4B,KAAK4oC,GAAkB9xD,KAAI,SAACkyD,GAAK,OAAAJ,EAAiBI,GAAGC,cAC5D,KACMC,EAAe,SAAIljC,EAAMjtB,OACvBxN,EAAIs9D,EAAqB9vD,GACzBowD,EAAiBrhE,OAAO2C,OAAO,GAAIc,EAAE09D,aAC3CE,EAAeC,QAAU79D,EAAEsD,GAC3Bs6D,EAAe17D,KAAO+6D,GAAgBjM,MACtC4M,EAAe/jD,MAAQ,OAEjBikD,EApBV,SAASC,EAAcC,GACrB,OAAOA,EAAI39B,OAAM,SACdsN,EAAKpY,GACJ,OAAAoY,EAAItsC,OACFk0B,EAAIrzB,OAAS+6D,GAAgBjM,MAAQ+M,EAAcxoC,EAAI1b,OAAS0b,IAEpE,IAckBwoC,CAActjC,GAMhC,OALAqjC,EAAU7uD,IAAG,SACXiH,GAAK,OAACA,EAAE2nD,QAAaD,EAAeC,QAAO,IAAID,EAAet6D,KAEhEs6D,EAAe/jD,MAAQikD,EAEhBF,GAGTJ,EAAYD,EAAUtuD,IAAG,SAAEgvD,EAAKC,GAC9B,OAAAD,EAAIp2C,KACF5Y,GAAAA,IAAG,SAAC4K,GACF,OAAAwjD,EAAiBa,GAAKR,YAClBC,EAAgB9jD,EAAOqkD,GACvBrkD,YAKV2jD,EAAYD,MAIRY,EAAYjF,GAAAA,IAAGx5D,WAAA,EAAA0B,GAAIo8D,IAAW31C,KAClC5Y,GAAAA,IAAG,SACAmvD,GAA0B,MAAA,GAAG/8D,OAAM3B,MAAT,GAAE0B,GAAWg9D,OAuBtCC,EAA4B,SAAIxkD,EAAOykD,GAC3C,OAAAzkD,EAAMwmB,OAAM,SAAEsN,EAAKlT,EAAMyjC,EAAKF,OACtB36B,EAAai7B,EAAM7jC,GACnB8jC,EAAUhiE,OAAO2C,OAAO,GAAIu7B,GAElC,GAAIA,EAAKv4B,OAAS+6D,GAAgBx3C,MAAO,KAIjC+4C,EAAoB,GAY1B,GAAyB,EAXLR,EAAIv3D,OAAM,SAAEkrC,EAAGtyC,OAC7Bo/D,GAAO,EAOX,OANI9sB,EAAErjC,QAAU+0B,GAAcsO,EAAEzvC,OAAS+6D,GAAgBx3C,QACnDpmB,IAAM6+D,GAAOvsB,EAAEksB,UAAYpjC,EAAKojC,UAClCY,GAAO,GAETD,EAAkBt9D,KAAK7B,IAElBo/D,IAGOj/D,OAAY,KACpBk/D,EAAYF,EAAkBh+B,UAAS,SAACmR,GAAK,OAAAA,IAAMusB,IAAO,EAChEK,EAAQjwD,MAAWmsB,EAAKnsB,MAAK,KAAKowD,EAAS,IAG/B/wB,EAAIpiC,KAAI,SACpBomC,GAAK,OAAAA,EAAErjC,QAAUiwD,EAAQjwD,OAASqjC,EAAEzvC,OAAS+6D,GAAgBx3C,UAG7DkoB,EAAIA,EAAInuC,QAAU++D,QAEX9jC,EAAKv4B,OAAS+6D,GAAgBjM,QACvCuN,EAAQ1kD,MAAQwkD,EACd5jC,EAAK5gB,MAAK,SACV9c,GAAS,OAAAA,EAAMuR,QAEjBq/B,EAAIA,EAAInuC,QAAU++D,GAGpB,OAAO5wB,GACN,KAQL,OANkBwwB,EAAUt2C,KAC1B5Y,GAAAA,IAAG,SAACmvD,GAAU,OA9DI,SAAI3jD,EAAM6jD,GAC5B,OAAA7jD,EAAK4lB,OAAM,SAAEsN,EAAK5/B,SACV4wD,EAAUL,EAAMvwD,GAChB6wD,EAAMjxB,EAAIpiC,KAAI,SAAComC,GAAK,OAAAA,EAAEruC,KAAOq7D,IAEnC,GAAKC,EAEE,KACCC,EAAKlxB,EAAIlgC,QAAQmxD,IACoC,IAAvDjxB,EAAIkxB,GAAIhB,QAAQ32D,MAAM,KAAKuG,QAAQM,EAAM8vD,WAC3ClwB,EAAIkxB,GAAIhB,QAAalwB,EAAIkxB,GAAIhB,QAAO,IAAI9vD,EAAM8vD,UAEhDt8C,EAAAosB,EAAIkxB,GAAIhlD,OAAM3Y,KAAIxB,MAAA6hB,EAAAngB,GAAI2M,EAAM8L,aAN5B8zB,EAAIA,EAAInuC,QAAUuO,EAQpB,OAAO4/B,GACN,IA+CWmxB,CAAeV,EAAM,SAAErwD,GAAS,OAAAA,EAAMzK,OACpD2L,GAAAA,IAAG,SAACmvD,GAAU,MAAA,GAAG/8D,OAAM3B,MAAT,GAAE0B,GAAWg9D,MAC3BnvD,GAAAA,IAAG,SAACwL,GAAQ,OAAA4jD,EAA6B5jD,EAAI,SAAE1d,GAAS,OAAAA,EAAMuR,YAM1D2tD,GAAApgE,UAAAqhE,uBAAR,SAA+BJ,OACvBtL,EAAgBC,GAAYqL,EAAY,MAC9C,OAAOrgE,KAAK0+B,oBAAoB8tB,gBAC9B8V,GAAiBvN,GACjBsL,EAAQ5gE,IACR4gE,EAAQ3rD,UAIJ8qD,GAAApgE,UAAAmjE,wBAAR,SAAgCjiE,EAAOkiE,EAAUC,EAAmBpC,OAC5DqC,EAAwB1iE,KAAK2iE,uBACjCriE,EAAMuwD,KACN4R,GAGInjE,EAAWgB,EAAMguD,QAAUhuD,EAAMguD,QAAQ,GAAK7mD,UAC9CgkB,EACJ40C,EAAQuC,YAActiE,EAAMquD,MACxB3uD,KAAK0+B,oBAAoB1F,SAAS14B,EAAMquD,OACxClnD,UAEA7B,EAAS9F,OAAO2C,OAAO,GAAI49D,EAAQwC,YAAW,CAClDh9D,OAAQvF,EAAMuwD,KACd31C,QAASmlD,EAAQ3rD,UAGbouD,EAAoB,CACxBr9D,KAAM,MACNhG,IAAK4gE,EAAQ5gE,IACbud,YAAaqjD,EAAQ0C,wBAA0B,YAAct7D,UAC7D4mD,YAAaqU,EACbnoD,gBACEmoD,IAA0BvT,GAAYl1C,MACtCyoD,IAA0BvT,GAAYj1C,SAClC,SACAzS,UACNqoD,yBAAyB,GAGrB5oD,EAAgBpH,OAAO2C,OAC3B,GACAqgE,EACAzC,EAAQn5D,cACR,CAAEtB,OAAMA,IAGJo9D,EAAe,CACnBn8D,GAAI/B,GAA4BoC,GAChCzB,KAAM+6D,GAAgBx3C,MACtBnX,MAAOvR,EAAMivD,MACb6R,QAASoB,EACTjiE,QAAS,CACPsqB,cAAe/D,GAAuBxmB,EAAMkvD,qBAC5C5kC,cAAe9D,GAAuBxmB,EAAMmvD,qBAC5CnwD,SAAU,CACRG,IAAKH,EAAWA,EAASowD,eAAiBjoD,UAC1ClI,SAAQD,GAAkBmI,WAE5BgkB,cAAaA,EACbwQ,QAAS,CAAEx2B,KAAM46D,EAAQ4C,aACzB/7D,cAAaA,IAIjB,OAAOyK,GAAAA,YAAY29C,gBAAgB0T,IAG7BxD,GAAApgE,UAAA8jE,wBAAR,SACEC,EACAC,EACAC,EACAZ,EACApC,GALF,IAAA11D,EAAA3K,KA6CE,MAtCqB,CACnB6G,GAAIw8D,EACJ59D,KAAM+6D,GAAgBjM,MACtB1iD,MAAOsxD,EAAW5T,MAClB6R,QAASf,EAAQx5D,GACjBuW,MAAO+lD,EAAWn6C,MAAM4a,OAAM,SAAExmB,EAAsB9c,GACpD,GAAIA,EAAM0oB,QAAUvhB,UAAW,KAEvB67D,EACJD,EAAU,WAAU/iE,EAAMuwD,MAAQvwD,EAAM0oB,MAAM,GAAG6nC,MAC7C0S,EAA8B54D,EAAKu4D,wBACvC5iE,EACA8iE,EACAE,EACAb,EACApC,GAGFjjD,EAAM3Y,KAAK8+D,OACN,CACL,IAAmD,IAA/C54D,EAAK64D,iBAAiBljE,EAAMuwD,KAAMuS,GACpC,OAAOhmD,MAGHqmD,EAEF94D,EAAK43D,wBACPjiE,EACA+iE,EACAZ,EACApC,GAGFjjD,EAAM3Y,KAAKg/D,GAEb,OAAOrmD,GACN,MAKCoiD,GAAApgE,UAAAshE,sBAAR,SACEL,EACA8C,EACAO,EACAC,gBAAA,IAAAA,IAAAA,EAAA,OAGMP,GAAW/C,EAAQuD,YAAc,IAAIpxD,IAAG,SAC3ChH,GAAoB,OAAA,IAAIsI,OAAOtI,KAElC,GAAK23D,EAAWn6C,UAIhB,IAAmB,IAAA9J,EAAA1B,GAAA2lD,EAAWn6C,OAAK7J,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAAhC,IAAM45B,EAAI7e,EAAAjf,MACb,GAAI89B,EAAKhV,QAAUvhB,UAAnB,KAMMg7D,EAAoBziE,KAAK6jE,sBAAsBxD,GAGrD,GAAkB,IAAdsD,EAAiB,KAGbG,EAAc,kBAAiBX,EAAWtS,MAAQ7yB,EAAK6yB,MACvD0S,EAAYvjE,KAAKkjE,wBACrBC,EACAC,EACAU,EACArB,EACApC,GAG6B,IAA3BkD,EAAUnmD,MAAMra,QAClB2gE,EAAaj/D,KAAK8+D,GAIpB,MAGA,IAAkD,IAA9CvjE,KAAKwjE,iBAAiBxlC,EAAK6yB,KAAMuS,GAAoB,KACjDK,EAAYzjE,KAAKuiE,wBACrBvkC,EACAqiC,EAAQx5D,GACR47D,EACApC,GAEFqD,EAAaj/D,KAAKg/D,SAlCpBzjE,KAAK0gE,sBAAsBL,EAASriC,EAAM0lC,EAAcC,EAAY,0GAwClEnE,GAAApgE,UAAAuhE,aAAR,SACEN,EACA5T,GAFF,IAAA9hD,EAAA3K,KAIQ2F,EAAS8mD,EAAakD,SAAS3mC,MAC/Bo6C,GAAW/C,EAAQuD,YAAc,IAAIpxD,IAAG,SAC3ChH,GAAoB,OAAA,IAAIsI,OAAOtI,KAGlC,OAAO7F,EACJ6M,IAAG,SAAElS,GACJ,IAAyD,IAArDqK,EAAK64D,iBAAiBljE,EAAMuvD,WAAYuT,GAC1C,OAAO37D,cAEH7B,EAAS9F,OAAO2C,OAAO,GAAI49D,EAAQwC,YAAa,CACpDnuD,QAAS,UAELouD,EAAiB,CACrBr9D,KAAM,OACNhG,IAAK4gE,EAAQ5gE,IACbud,YAAaqjD,EAAQ0C,wBACjB,YACAt7D,UACJnH,MAAOA,EAAMuvD,WACbkU,UAAW1D,EAAQ0D,UACnBjU,yBAAyB,EACzBkU,gBAAiB3D,EAAQ2D,iBAAmB,MAC5Cz9D,MAAO,WAEHW,EAAgBpH,OAAO2C,OAC3B,GACAqgE,EACAzC,EAAQn5D,cACR,CAAEtB,OAAMA,IAGV,OAAO+L,GAAAA,YAAY29C,gBAAgB,CACjCzoD,GAAI/B,GAA4BoC,GAChCzB,KAAM+6D,GAAgBx3C,MACtBnX,MAAOvR,EAAMivD,MACb6R,QAASf,EAAQx5D,GACjBtG,QAAS,CACP2G,cAAaA,OAIlB8C,OAAM,SAAEg0B,GAAuC,OAAAA,IAASv2B,aAGrD+3D,GAAApgE,UAAAokE,iBAAR,SAAyBvkD,EAAmBmkD,GAC1C,OAAuB,IAAnBA,EAAQrgE,QAGLqgE,EAAQt0D,KAAI,SAAEm1D,GAAkB,OAAAA,EAAM76D,KAAK6V,OAAgBxX,WAG5D+3D,GAAApgE,UAAAujE,uBAAR,SACEuB,EACAzB,OAMIpU,EAJE8V,EAAyB1B,EAAkB3zD,KAAI,SACnDmB,GAAK,OAAAA,EAAE3P,QAAU4jE,IAEbE,EAAiB3B,EAAkB3zD,KAAI,SAACmB,GAAK,MAAY,MAAZA,EAAE3P,QAOrD,OALI6jE,EACF9V,EAAc8V,EAAuB9V,YAC5B+V,IACT/V,EAAc+V,EAAe/V,aAExBA,GAGDmR,GAAApgE,UAAAykE,sBAAR,SACExD,OAEMoC,EAAmE,GACzE,OAAKpC,EAAQhS,aAGbvuD,OAAOk4B,KAAKqoC,EAAQhS,aAAaxjD,QAAO,SAACw5D,GACnChE,EAAQhS,YAAYgW,aAAiCpiE,MACvDo+D,EAAQhS,YAAYgW,GAAsBx5D,QAAO,SAACoU,GAE7CwjD,EAAkB3zD,KAAI,SAACw1D,GAAY,OAAAA,EAAShkE,QAAU2e,KAEvDwjD,EAAkBh+D,KAAK,CACrBnE,MAAO2e,EACPovC,YAAW,MAMdoU,EAAkB3zD,KAAI,SACrBw1D,GACE,OAAAA,EAAShkE,QAAU+/D,EAAQhS,YAAYgW,MAG3C5B,EAAkBh+D,KAAK,CACrBnE,MAAO+/D,EAAQhS,YAAYgW,GAC3BhW,YAAW,MAKZoU,wBA5hBV/iE,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDA3BL8Z,GAAAA,kBAKiByqC,GAAAA,qBAAjBnkB,GAAAA,uBAEPD,mNAuBA,SAAAy/B,GACUtnD,EACAiF,EACA+hB,EACAR,GAHA1+B,KAAAkY,KAAAA,EACAlY,KAAAmd,OAAAA,EACAnd,KAAAk/B,gBAAAA,EACAl/B,KAAA0+B,oBAAAA,ECPZ,IAAA6lC,IAaEzkE,OAAAC,eAAIwkE,GAAAnlE,UAAA,cAAW,KAAf,WAA6C,OAAOY,KAAKwS,IAAIgY,eAAeC,6CAgC5E85C,GAAAnlE,UAAAi0B,SAAA,eACQmxC,EAAexkE,KAAKwS,IAAI7M,OAAO6M,IAAG,SAAElS,GACxC,MAAO,CACLuG,GAAIvG,EAAMC,QAAQ8gB,OAAOxa,GACzBgL,MAAOvR,EAAMuR,MACbpM,KAAM+6D,GAAgBx3C,SAG1BhpB,KAAK+qC,MAAMnP,MAAMkW,WAAW0yB,EAAc,CAAEC,OAAO,IAAQ,GACvDzkE,KAAKqgE,SAAWrgE,KAAKqgE,QAAQqE,gBAAkBj9D,WACjDzH,KAAK+qC,MAAMa,KAAK1K,KAAK,CACnB9a,UAAWpmB,KAAKqgE,QAAQqE,cACxBC,cAAa,SAAG3mC,GAAsB,OAAAA,EAAKnsB,aAIzC+yD,IAAoB5kE,KAAKqgE,SAAUrgE,KAAKqgE,QAAQuC,WACtD5iE,KAAK6kE,mBAAqBD,GAAwC5kE,KAAK6kE,mBAEvE7kE,KAAK8uB,QAAU,IAAIg2C,GAAAA,mBAAmB9kE,KAAK+qC,MAAO/qC,KAAK+kE,QAIzDR,GAAAnlE,UAAAs0B,YAAA,WACE1zB,KAAK8uB,QAAQk2C,WAMfT,GAAAnlE,UAAA6lE,QAAA,SAAQjnC,GACN,OAAOA,EAAKv4B,OAAS+6D,GAAgBjM,OAMvCgQ,GAAAnlE,UAAA8lE,QAAA,SAAQlnC,GACN,OAAOA,EAAKv4B,OAAS+6D,GAAgBx3C,OAQvCu7C,GAAAnlE,UAAA+lE,mBAAA,SAAmB9kD,OACX/f,EAAQ+f,EAAM/f,MACpBN,KAAK+qC,MAAMnP,MAAMwpC,OAAO9kE,EAAO,CAAEmkE,MAAOpkD,EAAMokD,QAAS,GACvDpkD,EAAMokD,MAAQzkE,KAAKqlE,cAAc/kE,GAASN,KAAKslE,mBAAmBhlE,IAQpEikE,GAAAnlE,UAAAmmE,mBAAA,SAAmBllD,OACX/O,EAAQ+O,EAAM/O,MACpBtR,KAAK+qC,MAAMnP,MAAMwpC,OAAO9zD,EAAO,CAAEmzD,MAAOpkD,EAAMokD,QAAS,GACvDpkD,EAAMokD,MAAQzkE,KAAKwlE,cAAcl0D,GAAStR,KAAKylE,mBAAmBn0D,IAO5DizD,GAAAnlE,UAAAimE,cAAR,SAAsB/kE,GACpBN,KAAK0lE,eAAe,CAACplE,KAOfikE,GAAAnlE,UAAAkmE,mBAAR,SAA2BhlE,GACzBN,KAAK2lE,oBAAoB,CAACrlE,KAOpBikE,GAAAnlE,UAAAsmE,eAAR,SAAuB//D,GAAvB,IAAAgF,EAAA3K,KACQk7B,EAAUv1B,EAAO6M,IAAG,SAAElS,GAI1B,OAHIA,EAAMC,QAAQ2G,cAAc4rD,iBAAmBrrD,YACjDnH,EAAMC,QAAQ2G,cAAc4rD,gBAAiB,GAExCnoD,EAAKm8C,aAAa2M,iBAAiBnzD,EAAMC,WAGlDk8D,GAAAA,IAAGx5D,WAAA,EAAA0B,GAAIu2B,IAASvjB,UAAS,SAAEiuD,GACzBj7D,EAAKogC,MAAMnP,MAAMkW,WAAWnsC,EAAQ,CAAE8+D,OAAO,IAC7C95D,EAAK6H,IAAI2qC,UAAUyoB,MAQfrB,GAAAnlE,UAAAumE,oBAAR,SAA4BhgE,GAA5B,IAAAgF,EAAA3K,KACE2F,EAAOkF,QAAO,SAAEvK,OAQNulE,EAPRl7D,EAAKogC,MAAMnP,MAAMwpC,OAAO9kE,EAAO,CAAEmkE,OAAO,KACR,IAA5BnkE,EAAMC,QAAQ8oB,WACVw8C,EAASl7D,EAAK6H,IAAIyqC,aAAa38C,EAAMC,QAAQsG,OACpCY,WACbkD,EAAK6H,IAAI80B,YAAYu+B,IAGjBA,EAASl7D,EAAK6H,IAAIyqC,aAAa38C,EAAMuG,OAC5BY,WACbkD,EAAK6H,IAAI80B,YAAYu+B,MAUrBtB,GAAAnlE,UAAA0mE,wBAAR,SAAgC1oD,EAAsBgJ,OAC9C2/C,EAAa3oD,EAAM8jB,KAAI,SAAE8F,EAAGllC,OAC1BkkE,EAASh/B,EAAEn1B,MAAMytB,UAAU,OAAOvxB,QAAQ,mBAAoB,IAC9Dk4D,EAASnkE,EAAE+P,MAAMytB,UAAU,OAAOvxB,QAAQ,mBAAoB,IAEpE,OAAIi4D,EAASC,GACH,EAEGA,EAATD,EACK,EAEF,IAET,OAAQ5/C,GACN,IAAK,MACH,OAAO2/C,EACT,IAAK,OACH,OAAOA,EAAWh2B,UACpB,QACE,OAAO3yB,IAQLmnD,GAAAnlE,UAAAomE,cAAR,SAAsBl0D,GAAtB,IAAA3G,EAAA3K,KACM2F,EAAS2L,EAAM8L,MAAMpT,OAAM,SAAEg0B,OACzBymC,EAAQ95D,EAAKogC,MAAMnP,MAAMzjB,IAAI6lB,GAAMymC,QAAS,EAClD,OAAO95D,EAAKu6D,QAAQlnC,KAAmB,IAAVymC,IAE3BzkE,KAAKqgE,SAAWrgE,KAAKqgE,QAAQqE,gBAAkBj9D,YACjD9B,EAAS3F,KAAK8lE,wBAAwBngE,EAAQ3F,KAAKqgE,QAAQqE,gBAE7D1kE,KAAK0lE,eAAe//D,EAAOoqC,YAOrBw0B,GAAAnlE,UAAAqmE,mBAAR,SAA2Bn0D,GAA3B,IAAA3G,EAAA3K,KACQ2F,EAAS2L,EAAM8L,MAAMpT,OAAM,SAAEg0B,OAC3BymC,EAAQ95D,EAAKogC,MAAMnP,MAAMzjB,IAAI6lB,GAAMymC,QAAS,EAClD,OAAO95D,EAAKu6D,QAAQlnC,KAAmB,IAAVymC,IAE/BzkE,KAAK2lE,oBAAmB,yBAtN3BnlE,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,kiCACAC,gBAAiBC,GAAAA,wBAAwBC,qDAlBlCmmD,UATPkf,GAAAA,kEAuCCplE,GAAAA,uBAKAA,GAAAA,qBAKAA,GAAAA,mBAKAA,GAAAA,oCAKAA,GAAAA,SAqLHyjE,IAnLE,SAAAA,GACUzd,EACAie,GADA/kE,KAAA8mD,aAAAA,EACA9mD,KAAA+kE,MAAAA,EAxBD/kE,KAAA6kE,oBAAqB,EAoBrB7kE,KAAAmmE,sBAAgC,EC3C3C,IAAAC,IA0CEtmE,OAAAC,eAAIqmE,GAAAhnE,UAAA,QAAK,KAAT,WACE,OAAOizC,GAAAA,eAAeryC,KAAKM,wCAM7BR,OAAAC,eAAIqmE,GAAAhnE,UAAA,OAAI,KAAR,WACE,OAAOqzC,GAAAA,cAAczyC,KAAKM,QAAU,0CAKtC8lE,GAAAhnE,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKiqB,uBACLjqB,KAAKqmE,WAAW1uD,UAAS,SAACzX,GAAS,OAAAyK,EAAK27D,oBAAoBxpC,KAAK58B,MAOnEkmE,GAAAhnE,UAAAmnE,aAAA,SAAalmD,GACXrgB,KAAKwmE,cAAcnmD,IAGrB+lD,GAAAhnE,UAAAqnE,aAAA,SAAapmD,GAAb,IAAA1V,EAAA3K,KACEA,KAAK0mE,kBAAkBtiE,MAAMpE,KAAK0mE,kBAAkBxmE,OACpDF,KAAK8mD,aAAa2M,iBAAiBzzD,KAAKM,MAAMC,SAAS6qB,KAAKwU,GAAAA,SAC3DjoB,UAAS,SAACrX,GAAS,OAAAqK,EAAKg8D,UAAUviE,KAAK9D,MAO1C8lE,GAAAhnE,UAAAonE,cAAA,SAAcnmD,GAAd,IAAA1V,EAAA3K,KAKE,OAJuC,oBAA5BA,KAAK2iD,oBACdC,aAAa5iD,KAAK2iD,oBAGZtiC,EAAM5a,MACZ,IAAK,QACEzF,KAAKqmE,WAAWnmE,QACfF,KAAKykE,MACPzkE,KAAK0tC,SAEL1tC,KAAK4tC,OAGT5tC,KAAKqmE,WAAWjiE,MAAK,GACrB,MACF,IAAK,aACEpE,KAAKqmE,WAAWnmE,OAAUF,KAAKykE,QAClCzkE,KAAK2iD,mBAAqBhe,WAAU,WAClCh6B,EAAKijC,MACLjjC,EAAK07D,WAAWjiE,MAAK,IACpB,MAEL,MACF,IAAK,aACCpE,KAAKqmE,WAAWnmE,QAClBF,KAAK0tC,SACL1tC,KAAKqmE,WAAWjiE,MAAK,MAWrBgiE,GAAAhnE,UAAAwuC,IAAR,WACO5tC,KAAKykE,QACRzkE,KAAKykE,OAAQ,EACbzkE,KAAK4mE,YAAY9pC,KAAK,CAAE2nC,OAAO,EAAMnkE,MAAON,KAAKM,UAO7C8lE,GAAAhnE,UAAAsuC,OAAR,WACM1tC,KAAKykE,QACPzkE,KAAKykE,OAAQ,EACbzkE,KAAK4mE,YAAY9pC,KAAK,CAAE2nC,OAAO,EAAOnkE,MAAON,KAAKM,UAItD8lE,GAAAhnE,UAAAynE,UAAA,WACE,SAAU7mE,KAAKM,MAAM8gE,SAAoD,IAAzCphE,KAAKM,MAAM8gE,QAAQ32D,MAAM,KAAK1H,SAGhEqjE,GAAAhnE,UAAA6qB,qBAAA,eACQW,EAAgB5qB,KAAKM,MAAMC,QAAQqqB,eAAiB,EACpDC,EAAgB7qB,KAAKM,MAAMC,QAAQsqB,eAAiBlB,SAI1D,OAHA3pB,KAAK8mE,SAAS1iE,KACZpE,KAAKwW,YAAcoU,GAAiB5qB,KAAKwW,YAAcqU,GAElD7qB,KAAK8mE,SAAS5mE,OAGvBkmE,GAAAhnE,UAAAq8B,eAAA,WACE,OAAIz7B,KAAKykE,MACAzkE,KAAKqmE,WAAWnmE,MACnB,iCACAF,KAAK8mE,SAAS5mE,MACd,sCACA,8CAEGF,KAAK8mE,SAAS5mE,MACjB,iCACA,+DA5JTM,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,4BACVC,SAAA,yxCAEAC,gBAAiBC,GAAAA,wBAAwBC,gQAXlCmmD,2CAsBNlmD,GAAAA,kCAEAA,GAAAA,qBAKAA,GAAAA,qBAKAA,GAAAA,2BAKAs8B,GAAAA,oCAKAA,GAAAA,UA0HHgpC,IA1GE,SAAAA,GAAoBtf,GAAA9mD,KAAA8mD,aAAAA,EA9Cb9mD,KAAA8mE,SAAqC,IAAI77C,GAAAA,iBAAgB,GACzDjrB,KAAAqmE,WAAuC,IAAIp7C,GAAAA,iBAAgB,GAI3DjrB,KAAA0mE,kBAA8C,IAAIz7C,GAAAA,iBAAgB,GAClEjrB,KAAA2mE,UAAY,IAAI17C,GAAAA,gBAAuBxjB,WAIrCzH,KAAA6kE,oBAAqB,EAUrB7kE,KAAAykE,OAAQ,EAKPzkE,KAAA4mE,YAAc,IAAIppC,GAAAA,aAKlBx9B,KAAAsmE,oBAAsB,IAAI9oC,GAAAA,aC/BtC,IAAAupC,IA8EEjnE,OAAAC,eAAIgnE,GAAA3nE,UAAA,QAAK,KAAT,WACE,OAAOY,KAAKsR,MAAMO,uCAMpBk1D,GAAA3nE,UAAAi0B,SAAA,WACErzB,KAAK+qC,MAAMwC,KAAKvtC,KAAKsR,MAAM8L,OAC3Bpd,KAAKgnE,gBACLhnE,KAAKinE,iBAAiBjnE,KAAK0rB,WACvB1rB,KAAKqgE,SAAWrgE,KAAKqgE,QAAQqE,gBAAkBj9D,WACjDzH,KAAK+qC,MAAMa,KAAK1K,KAAK,CACnB9a,UAAWpmB,KAAKqgE,QAAQqE,cACxBC,cAAa,SAAG3mC,GAAsB,OAAAA,EAAKnsB,UAKjDk1D,GAAA3nE,UAAAs0B,YAAA,WACE1zB,KAAK+qC,MAAMi6B,WAMb+B,GAAA3nE,UAAA6lE,QAAA,SAAQjnC,GACN,OAAOA,EAAKv4B,OAAS+6D,GAAgBjM,OAMvCwS,GAAA3nE,UAAA8lE,QAAA,SAAQlnC,GACN,OAAOA,EAAKv4B,OAAS+6D,GAAgBx3C,OAOvC+9C,GAAA3nE,UAAAonE,cAAA,WACExmE,KAAKknE,OAAOhnE,MAAQF,KAAK0tC,SAAW1tC,KAAK4tC,OAO3Cm5B,GAAA3nE,UAAA+nE,kBAAA,SAAkBz7C,GAChB1rB,KAAKinE,iBAAiBv7C,IAUxBq7C,GAAA3nE,UAAA+lE,mBAAA,SAAmB9kD,GACjBrgB,KAAKonE,iBAAiBtqC,KAAKzc,GAC3BrgB,KAAKqnE,eAAehnD,IAMd0mD,GAAA3nE,UAAAwuC,IAAR,WACE5tC,KAAKknE,OAAO9iE,MAAK,GACjBpE,KAAK4mE,YAAY9pC,KAAK,CACpB2nC,OAAO,EACPnzD,MAAOtR,KAAKsR,SAORy1D,GAAA3nE,UAAAsuC,OAAR,WACE1tC,KAAKknE,OAAO9iE,MAAK,GACjBpE,KAAK4mE,YAAY9pC,KAAK,CACpB2nC,OAAO,EACPnzD,MAAOtR,KAAKsR,SAIhBy1D,GAAA3nE,UAAAkoE,eAAA,SAAejnD,GACbrgB,KAAKunE,SAASnjE,KAAKic,IAOb0mD,GAAA3nE,UAAAioE,eAAR,SAAuBhnD,GAAvB,IAAA1V,EAAA3K,KACQykE,EAAQpkD,EAAMokD,MACdnkE,EAAQ+f,EAAM/f,MAEAN,KAAK+qC,MAAMa,KAC5B47B,MACAx9D,OAAM,SAAEg0B,GAAsB,OAAAA,EAAKn3B,KAAOvG,EAAMuG,KAChD2L,IAAG,SAAEwrB,GAAsB,OAAArzB,EAAKixB,MAAMzjB,IAAI6lB,GAAMymC,QAAS,IAE5CpzD,MAAK,SAACnR,GAAS,OAAAA,IAAUukE,IACvCA,EAAQzkE,KAAK4tC,MAAQ5tC,KAAK0tC,UACK,IAAtB1tC,KAAKknE,OAAOhnE,OACrBF,KAAKknE,OAAO9iE,MAAK,IAIb2iE,GAAA3nE,UAAA4nE,cAAR,WAAA,IAAAr8D,EAAA3K,KACQykE,EAAQzkE,KAAK+qC,MAAMy8B,MAAMn2D,MAAK,SAAE2sB,GACpC,OAAiD,KAAzCrzB,EAAKixB,MAAMzjB,IAAI6lB,GAAMymC,QAAS,KAExCzkE,KAAKknE,OAAO9iE,KAAKqgE,IAGXsC,GAAA3nE,UAAA6nE,iBAAR,SAAyBv7C,OACnB+6B,GAAW,GACc,IAAzBzmD,KAAKynE,kBACPhhB,EAAW/6B,GAEb1rB,KAAK0nE,UAAUtjE,KAAKqiD,IAGtBsgB,GAAA3nE,UAAAuoE,aAAA,WACE3nE,KAAK0rB,WAAa1rB,KAAK0rB,gCA7M1BlrB,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,4BACVC,SAAA,o6DAEAC,gBAAiBC,GAAAA,wBAAwBC,iJAyBxCC,GAAAA,qBAKAA,GAAAA,yBAKAA,GAAAA,0BAEAA,GAAAA,kCAEAA,GAAAA,+BAKAA,GAAAA,qBASAA,GAAAA,2BAKAs8B,GAAAA,iCAQAA,GAAAA,UAyIH2pC,IA/MA,SAAAA,KAYE/mE,KAAA+qC,MAAQ,IAAIgC,GAAAA,YAA2C,IAMvD/sC,KAAAknE,OAAmC,IAAIj8C,GAAAA,iBAAgB,GACvDjrB,KAAAunE,SAAqC,IAAIt8C,GAAAA,iBAAgB,GAKzDjrB,KAAA0nE,UAAsC,IAAIz8C,GAAAA,iBAAgB,GAejDjrB,KAAA0rB,WAAqB,EAIrB1rB,KAAA6kE,oBAAqB,EAKrB7kE,KAAAynE,iBAA2B,EAc1BznE,KAAA4mE,YAAc,IAAIppC,GAAAA,aAQlBx9B,KAAAonE,iBAAmB,IAAI5pC,GAAAA,aChGnC,IAAAoqC,IAwBEA,GAAAxoE,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KAEEA,KAAKu0B,UAAU5uB,OAAS,GACxB3F,KAAK+oC,2BAA6B5d,GAAAA,cAAc,CAC9CnrB,KAAKgpC,WAAWH,SAAS3N,QACzBl7B,KAAKgpC,WAAWH,SAASre,eAAeC,cACxCW,KACA6d,GAAAA,aAAa,KACbtxB,UAAS,SAAE0T,OACL0V,EAAc1V,EAAM,GAAGrhB,OAAM,SAAE1J,GACnC,OAAiC,IAA1BA,EAAM4pB,kBAEfvf,EAAK4pB,UAAU5uB,OAASo7B,EAExBp2B,EAAKw+B,mBAAqBhe,GAAAA,cAAc4V,EACrCvuB,IAAG,SAAElS,GAAiB,OAAAA,EAAMypB,YAC5BpS,UAAS,SAAEnU,GACVmH,EAAK4pB,UAAU+L,QAAQl8B,YAM/BwjE,GAAAxoE,UAAAs0B,YAAA,WACE1zB,KAAK+oC,2BAA2Bre,cAC5B1qB,KAAKmpC,qBAAuB1hC,YAC9BzH,KAAKmpC,mBAAmBze,cACxB1qB,KAAKmpC,mBAAqB1hC,iCA1C/BmtB,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,4EAHH0/B,GAAwBh9B,WAAA,CAAA,CAAAsC,KAW5BovB,GAAAA,cAdI+T,MAmDTg/B,IAtCE,SAAAA,GACUrzC,EACAyU,GAAAhpC,KAAAgpC,WAAAA,EAERhpC,KAAKu0B,UAAYA,ECrBrB,IAAAszC,IAuFSA,GAAA7mE,QAAP,WACE,MAAO,CACLC,SAAU4mE,GACV3mE,UAAW,CAAC8lD,GAAczwB,GAAc6T,2BAlD7CjpC,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACP0mE,GAAAA,eACAC,GAAAA,mBACA1mE,GAAAA,aACA2mE,GAAAA,YACAC,GAAAA,iBACAC,GAAAA,cACA5mE,GAAAA,cACAC,GAAAA,gBACA4mE,GAAAA,qBACAC,GAAAA,gBACA5mE,GAAAA,iBACA6mE,GAAAA,cACAC,GAAAA,gBACAC,GAAAA,eACAC,GAAAA,kBACA/mE,GAAAA,kBACAgnE,GAAAA,cACAC,GAAAA,qBACAC,GAAAA,eACAC,GAAAA,gBAEFlnE,QAAS,CACP44B,GACA4F,GACAzC,GACAqE,GACA4H,GACAvJ,GACA2I,GACA8+B,GACAl9B,IAEF/oC,aAAc,CACZ24B,GACA4F,GACAzC,GACAqE,GACA4H,GACAvJ,GACA2I,GACA8+B,GACAl9B,QAUJm9B,IArDA,SAAAA,MCbA,IAAAgB,yBAAC1nE,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAknE,GAAAA,eACAhnE,GAAAA,gBACAD,GAAAA,cACA+mE,GAAAA,cACA7mE,GAAAA,iBACAsnE,GAAAA,sBACArnE,GAAAA,kBACAgnE,GAAAA,cACAC,GAAAA,qBACA3nE,GACA8mE,IAEFnmE,QAAS,CACP6iE,IAEF5iE,aAAc,CACZ4iE,GACAwC,GACAX,QAGkCyC,IAxBtC,SAAAA,MCXA,IAAAE,IA4BEA,GAAA3pE,UAAAi0B,SAAA,WACErzB,KAAK+qC,MAAMnP,MAAM/a,SAQnBkoD,GAAA3pE,UAAA4pE,gBAAA,SAAgB3I,GACdrgE,KAAK+qC,MAAMnP,MAAMwpC,OAAO/E,EAAS,CAC/B7xB,UAAU,EACVy6B,SAAS,IACR,GACHjpE,KAAKkpE,oBAAoBpsC,KAAK,CAAC0R,UAAU,EAAM6xB,QAAOA,0BA1CzD7/D,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,qWACAC,gBAAiBC,GAAAA,wBAAwBC,2CAOxCC,GAAAA,mBAKAA,GAAAA,mCAKAs8B,GAAAA,UAyBH2rC,IA7CA,SAAAA,KAoBY/oE,KAAAkpE,oBAAsB,IAAI1rC,GAAAA,aC3BtC,IAAA2rC,IAoBErpE,OAAAC,eAAIopE,GAAA/pE,UAAA,QAAK,KAAT,WAAsB,OAAOizC,GAAAA,eAAeryC,KAAKqgE,+DApBlD7/D,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,2BACVC,SAAA,2EACAC,gBAAiBC,GAAAA,wBAAwBC,6CAOxCC,GAAAA,mBAKAA,GAAAA,SAOHqoE,IAtBA,SAAAA,MCQA,IAAAC,yBAACjoE,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAC,GAAAA,cACA+mE,GAAAA,cACA7mE,GAAAA,iBACAinE,GAAAA,eAEF/mE,QAAS,CACPqnE,IAEFpnE,aAAc,CACZonE,GACAI,QAGkCC,IAhBtC,SAAAA,MCjBA,IAAAC,yBAcCloE,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAknE,GAAAA,eACAjnE,GAAAA,cACA+mE,GAAAA,cACA7mE,GAAAA,iBACAsnE,GAAAA,sBACAL,GAAAA,cACAC,GAAAA,sBAEFhnE,QAAS,CACPmnE,GACAO,IAEFznE,aAAc,OAEe0nE,IAjB/B,SAAAA,MCdA,IAAAC,IAQSA,GAAAtoE,QAAP,WACE,MAAO,CACLC,SAAUqoE,GACVpoE,UAAW,0BAThBC,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,GACTM,QAAS,GACTC,aAAc,OAShB2nE,IAZA,SAAAA,MCFA,IAAAC,IAYEA,GAAAnqE,UAAAkmB,UAAA,SAAUplB,EAAgBspE,GAA1B,IACM7jE,EADNgF,EAAA3K,KAmBE,MAhBY,SAARwpE,IACF7jE,EAASzF,EAAM8J,OAAM,SAAE1J,OACfs6D,EAAat6D,EAAgB,WACnC,OACEqK,EAAK8+D,iBAAiB7O,IACtBA,EAAWr6D,QAAQie,aAAe/W,WAClC3H,OAAOk4B,KAAK4iC,EAAWr6D,QAAQie,YAAYzb,UAIrC,QAARymE,IACF7jE,EAASzF,EAAM8J,OAAM,SAAE1J,OACfs6D,EAAat6D,EAAgB,WACnC,OAAOqK,EAAK++D,gBAAgB9O,MAGzBj1D,GAGD4jE,GAAAnqE,UAAAqqE,iBAAR,SAAyBxgD,GACvB,MAAgC,QAA5BA,EAAW1oB,QAAQkF,MAGhBwjB,EAAW1oB,QAAQmuD,gBAGpB6a,GAAAnqE,UAAAsqE,gBAAR,SAAwBzgD,OAClBygD,GAAkB,EActB,OAZEzgD,EAAW1oB,QAAQ2R,YACnB+W,EAAW1oB,QAAQ2R,WAAWzJ,SAC9BwgB,EAAW1oB,QAAQ2R,WAAWxJ,WAE9BghE,GAAkB,GAGlBzgD,EAAW1oB,QAAQ2R,YACnB+W,EAAW1oB,QAAQ2R,WAAWzJ,SAC9BwgB,EAAW1oB,QAAQ2R,WAAWrJ,cAC5B6gE,GAAkB,GAEfA,wBAhDVC,GAAAA,KAAIhqE,KAAA,CAAC,CACJqP,KAAM,2BAiDRu6D,IAlDA,SAAAA,MCRA,IAAAK,IAUEA,GAAAxqE,UAAAyqE,aAAA,SACEjP,EACAkP,OAEIrrD,EAEAsrD,EACAC,EAEJ,GAAI/nE,MAAM2uD,QAAQkZ,GAAO,KACjBG,EAAQ,GACVH,EAAK,KACPC,EAAmB/pE,KAAKkqE,iBAAiBJ,EAAK,IAC9CG,EAAMxlE,KAAKqlE,EAAK,KAEdA,EAAK,KACPE,EAAiBhqE,KAAKkqE,iBAAiBJ,EAAK,IAC5CG,EAAMxlE,KAAKqlE,EAAK,KAEG,IAAjBG,EAAMlnE,QAAgBgnE,IAAqBC,IAE3CvrD,EADEm8C,aAAsBr7C,GACjBwqD,EAAmB,IAAMC,EAEzBD,EAAmB,IAAMC,GAGhCD,IAAqBC,IACvBvrD,EAAOsrD,QAEAD,IAETrrD,EADcze,KAAKkqE,iBAAiBJ,QAIhClkE,EAAS,CAAEsmD,KAAMztC,GACvBm8C,EAAW9zD,GAAG4T,aAAa9U,IAG7BgkE,GAAAxqE,UAAA+qE,aAAA,SACEvP,EACAwP,OAEI3rD,EACAsrD,EACAC,EAEJ,GAAI/nE,MAAM2uD,QAAQwZ,GAAO,KACjBC,EAAQ,GACVD,EAAK,KACPL,EAAmBK,EAAK,GACxBC,EAAM5lE,KAAK2lE,EAAK,KAEdA,EAAK,KACPJ,EAAiBI,EAAK,GACtBC,EAAM5lE,KAAK2lE,EAAK,KAEG,IAAjBC,EAAMtnE,QAAgBgnE,IAAqBC,IAE3CvrD,EADEm8C,aAAsBr7C,GACjBwqD,EAAmB,IAAMC,EAEzBD,EAAmB,IAAMC,GAGhCD,IAAqBC,IACvBvrD,EAAOsrD,QAGTtrD,EAAO2rD,MAGHxkE,EAAS,CAAEsmD,KAAMztC,GACvBm8C,EAAW9zD,GAAG4T,aAAa9U,IAGrBgkE,GAAAxqE,UAAA8qE,iBAAR,SAAyBhqE,OACjBkqE,EAAOlqE,EAAMoqE,cACfC,EAAQrqE,EAAMsqE,WAAa,EAC3BC,EAAMvqE,EAAMwqE,aACZC,EAAOzqE,EAAM0qE,cACbC,EAAS3qE,EAAM4qE,gBAkBnB,OAhBI3lD,OAAOolD,GAAS,KAClBA,EAAQ,IAAMA,GAGZplD,OAAOslD,GAAO,KAChBA,EAAM,IAAMA,GAGVtlD,OAAOwlD,GAAQ,KACjBA,EAAO,IAAMA,GAGXxlD,OAAO0lD,GAAU,KACnBA,EAAS,IAAMA,GAGVT,EAAO,IAAMG,EAAQ,IAAME,EAAM,IAAME,EAAO,IAAME,EAAS,6BArGvEnrE,GAAAA,oDAuGDkqE,IArGE,SAAAA,UCRFmB,IAYSA,GAAA3rE,UAAA4rE,YAAP,SAAmBlQ,EAA8BmQ,OACzC93D,GAAgB,IAAIhL,IAAkB6K,yBAAyBi4D,EAAcnQ,EAAcv6D,QAAQqF,OAAOC,QAChHi1D,EAAch0D,GAAG4T,aAAa,CAAEqB,OAAQ5I,KAGnC43D,GAAA3rE,UAAA8rE,wBAAP,SAA+BC,OACvB5qE,EAAe4qE,EAAc5qE,QAC7BsW,EAAkB,IAAI1O,GAExB5H,EAAQ2R,WAAWzJ,SAAWlI,EAAQ2R,WAAWnJ,UACnDxI,EAAQ2R,WAAWnJ,QAAU8N,EAAgBnN,0BAC3CnJ,EAAQ2R,WAAWnJ,QACnBxI,EAAQgU,UAAUjM,kBAClB,IAAI8iE,EAAa,CAAEnjD,KAAM1nB,EAAQgU,UAAU3K,WAC3C,GAEGrJ,EAAQ2R,WAAWm5D,sBACtB9qE,EAAQ2R,WAAWm5D,oBAAsBx0D,EAAgBzI,8BACvD7N,EAAQ2R,WAAWnJ,QACnBxI,EAAQgU,UAAUjM,sBAMnByiE,GAAA3rE,UAAAksE,wBAAP,SAA+BxQ,OACvBv6D,EAAeu6D,EAAcv6D,QAC7BsW,EAAkB,IAAI1O,GAExB5H,EAAQ2R,WAAWzJ,SAAWlI,EAAQ2R,WAAWnJ,SACnDxI,EAAQ2R,WAAWnJ,QAAU8N,EAAgBnN,0BAC3CnJ,EAAQ2R,WAAWnJ,QACnBxI,EAAQ+H,kBACRb,WACA,GAEGlH,EAAQ2R,WAAWm5D,sBACtB9qE,EAAQ2R,WAAWm5D,oBAAsBx0D,EAAgBzI,8BAEvD7N,EAAQ2R,WAAWnJ,QACnBxI,EAAQ+H,oBAGZtI,KAAKgrE,YAAW,EAEdn0D,EAAgB/N,YAAYvI,EAAQ2R,WAAWnJ,UAEjDxI,EAAQgrE,UAAW,IAEnBhrE,EAAQ2R,WAAWnJ,QAAUtB,UAC7BlH,EAAQ2R,WAAWm5D,oBAAsB,GACzC9qE,EAAQgrE,UAAW,yBAvDxB7rE,GAAAA,oDA0DDqrE,IAxDE,SAAAA,cCEES,WAAa,aACbC,QAAU,UACVC,MAAQ,aAIRC,QAAU,UACVC,UAAY,aCnBhBC,IA6CEA,GAAAzsE,UAAA0sE,cAAA,SAAcC,EAAQ7rE,GACpB,OAAOJ,OAAOk4B,KAAK+zC,GAAQj9D,KAAI,SAACzL,GAAO,OAAA0oE,EAAO1oE,KAASnD,KAMzD2rE,GAAAzsE,UAAA4sE,eAAA,SAAevmE,OACPwmE,EAAO,EACb,GAAIA,EACF,OAAOjsE,KAAKkY,KACTC,IACCnY,KAAKkX,QAAUlX,KAAKksE,cAAcD,IAEnC7gD,KACC5Y,GAAAA,IAAG,SAAC25D,GACF,OAAAA,EAAkBxzD,SAASnG,IAAG,SAACvC,GAI7B,OAHAA,EAAEyiC,KAAO,CACP7rC,GAAIoJ,EAAEmE,WAAW6T,MAEZhY,QAUnB47D,GAAAzsE,UAAAgtE,kBAAA,WAAA,IAAAzhE,EAAA3K,KAEQod,EAAiC,GACvC,OAAOpd,KAAKkY,KAAKC,IAAInY,KAAKkX,QAFd,SAE6BkU,KACvC5Y,GAAAA,IAAG,SAAEqsD,GAmDH,OAlDAA,EAAMh0D,QAAO,SAACpF,GACZ,GAAIA,EAAKquC,WAAW,SAAU,KACtB9V,EAA8B,CAClChvB,KAAMvH,UACN4Z,OAAQ5b,GAENqY,EAASrY,EAAKm5D,UAAU,EAAGn5D,EAAK1C,QAChCspE,EAAOvuD,EACX,GAAIA,EAAO/L,SAAS,KAAM,KAClBhB,EAAQ+M,EAAO9M,QAAQ,KAC7Bq7D,EAAOvuD,EAAO8gD,UAAU7tD,EAAQ,EAAG+M,EAAO/a,QAC1C+a,EAASA,EAAO8gD,UAAU,EAAG7tD,GAE/B,IACEitB,EAAKhvB,KAAOrE,EAAKu0B,gBAAgBC,UAAUC,QACzC,mBAAqBitC,GAEvB,MAAO9nE,GACPy5B,EAAKhvB,KAAOq9D,EAAKzN,UAAU,EAAG,GAAGvmC,cAAgBg0C,EAAKzN,UAAU,EAAGyN,EAAKtpE,OAAS,GAGnF,IACEi7B,EAAK1sB,MAAQ3G,EAAKu0B,gBAAgBC,UAAUC,QAC1C,+BAAiCthB,GAEnC,MAAOvZ,GACPy5B,EAAK1sB,MAAQwM,EAAO8gD,UAAU,EAAG,GAAGvmC,cAAgBva,EAAO8gD,UAAU,EAAGyN,EAAKtpE,OAAS,GAGxFqa,EAAM3Y,KAAKu5B,QAEX,GAAIrzB,EAAKmhE,cAAcnhE,EAAKuhE,cAAezmE,GAAO,CAC1Cu4B,EAA8B,CAClChvB,KAAMvH,UACN4Z,OAAQ5b,OAEJ6mE,EAAO3hE,EAAKmhE,cAAcnhE,EAAKuhE,cAAezmE,GACpD,IACEu4B,EAAKhvB,KAAOrE,EAAKu0B,gBAAgBC,UAAUC,QACzC,mBAAqBktC,GAEvB,MAAO/nE,GACPy5B,EAAKhvB,KAAOs9D,EAAK1N,UAAU,EAAG,GAAGvmC,cAAgBi0C,EAAK1N,UAAU,EAAG0N,EAAKvpE,OAAS,GAEnFi7B,EAAK3c,OAAS5b,EAEd2X,EAAM3Y,KAAKu5B,MAIV5gB,MAQbyuD,GAAAzsE,UAAAmtE,eAAA,SACElnE,EACAmnE,EACA/mE,EACAgnE,EACArwB,GALF,IAAAzxC,EAAA3K,KAOE,GAAIyF,EAAM,KAEFinE,EAAO,EACPjtE,EAAMO,KAAKkX,QAAUlX,KAAKksE,cAAcQ,GAC1CC,EAAU,GACd,OAAIH,IAAaI,GAAsBjB,SACrCgB,EAAU,WACH3sE,KAAKkY,KACTC,IACC1Y,EAAM,IAAM4F,EAAQ+O,WAAW6T,KAAO,IAAM0kD,EAC5C,CACE/mE,OAAQ,CACNwF,SAAU,OACVstB,KAAM,UAIXtN,KACC5Y,GAAAA,IAAG,SAAC25D,GACF,OAAAA,EAAkBxzD,SAASnG,IAAG,SAACvC,GAQ7B,OAPAA,EAAEyiC,KAAO,CACP7rC,GAAIoJ,EAAEmE,WAAW6T,KACjBpW,MAAOlH,EAAKu0B,gBAAgBC,UAAUC,QACpC,iCAEF1G,KAAM,EAAWA,MAEZzoB,SAMf08D,EAAUF,EAASprD,OACZrhB,KAAKkY,KACTC,IACC1Y,EAAM,IAAM4F,EAAQ+O,WAAW6T,KAAO,IAAM0kD,EAC5C,CACE/mE,OAAQ,CACNwF,SAAU,OACVstB,KAAM,UAIXtN,KACC5Y,GAAAA,IAAG,SAAC25D,GACF,OAAAA,EAAkBxzD,SAASnG,IAAG,SAACvC,GAM7B,OALAA,EAAEyiC,KAAO,CACP7rC,GAAIoJ,EAAEmE,WAAW6T,KACjBpW,MAAO46D,EAASz9D,KAChB0pB,KAAM,EAAWA,MAEZzoB,QAQjB,OADMxQ,EAAMO,KAAKkX,QAAU,SACvBs1D,IAAaI,GAAsBjB,SAC/BgB,EAAU,iBACT3sE,KAAKkY,KACT20D,KAA8BptE,EAAMktE,EAAS,CAC5CvhE,SAAU,OACVstB,KAAM,OACN0jB,OAAMA,EACN0wB,IAAKzjE,KAAKC,UAAUjE,KAErB+lB,KACC5Y,GAAAA,IAAG,SAAC25D,GACF,OAAAA,EAAkBxzD,SAASnG,IAAG,SAACvC,GAQ7B,OAPAA,EAAEyiC,KAAO,CACP7rC,GAAIoJ,EAAEmE,WAAW6T,KACjBpW,MAAOlH,EAAKu0B,gBAAgBC,UAAUC,QACpC,iCAEF1G,KAAM,EAAWA,MAEZzoB,SAMT08D,EAAU,SAAWF,EAASprD,OAC7BrhB,KAAKkY,KACT20D,KAA8BptE,EAAMktE,EAAS,CAC5CvhE,SAAU,OACVstB,KAAM,OACN0jB,OAAMA,EACN0wB,IAAKzjE,KAAKC,UAAUjE,KAErB+lB,KACC5Y,GAAAA,IAAG,SAAC25D,GACF,OAAAA,EAAkBxzD,SAASnG,IAAG,SAACvC,GAM7B,OALAA,EAAEyiC,KAAO,CACP7rC,GAAIoJ,EAAEmE,WAAW6T,KACjBpW,MAAO46D,EAASz9D,KAChB0pB,KAAM,EAAWA,MAEZzoB,SAWrB47D,GAAAzsE,UAAA2tE,aAAA,SACE1nE,EACAI,OAEMunE,EAAchtE,KAAKksE,cAAczmE,GACjCwnE,EAAc,IAAM5nE,EAAQ+O,WAAW6T,KAC7C,GAAI+kD,GAAeC,EACjB,OAAOjtE,KAAKkY,KACTC,IAAanY,KAAKkX,QAAU81D,EAAcC,EAAa,CACtDrnE,OAAQ,CACNwF,SAAU,UAGbggB,KACC5Y,GAAAA,IAAG,SAACvC,GAMF,OALAA,EAAEyiC,KAAO,CACP7rC,GAAIoJ,EAAEmE,WAAW6T,KACjBpQ,MAAO5H,EAAEmE,WAAW6oD,IACpBprD,MAAO5B,EAAEmE,WAAW6oD,KAEfhtD,2BAxQlBvQ,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAZL8Z,GAAAA,kBACesmB,GAAAA,uBAAfmkB,GAAAA,gNAiCP,SAAA0nB,GACU3zD,EACAgnB,EACAguC,GAFAltE,KAAAkY,KAAAA,EACAlY,KAAAk/B,gBAAAA,EACAl/B,KAAAktE,cAAAA,EAtBHltE,KAAAkX,QAAkB,8CAKlBlX,KAAAksE,cAAgB,CACrBiB,UAAW,WACXC,OAAQ,kBACRC,QAAS,WACTC,SAAU,YACVC,OAAQ,UACRC,IAAK,MACLC,IAAK,gBACLC,QAAS,WACTC,OAAQ,cACRC,MAAO,QACPC,OAAQ,UAQR7tE,KAAKkX,QACHlX,KAAKktE,cAAc9oB,UAAU,sBAAwBpkD,KAAKkX,QC1ChE,IAAA42D,IAqBEA,GAAA1uE,UAAAC,KAAA,SAAKiB,OACG6+B,EAAYn/B,KAAKk/B,gBAAgBC,UACjCttB,EAAQstB,EAAUC,QAAQ,0BAChCp/B,KAAKohD,eAAe2sB,QAClB5uC,EAAUC,QAAQ,0BAClBvtB,OAGIm8D,EAA+B1tE,EAAM2oB,WAAW1oB,QACtD,GAA6C,EAAzCT,OAAOk4B,KAAKg2C,EAAU72D,UAAUpU,OAClC,GACEirE,EAAU72D,SAASC,YACnB42D,EAAU72D,SAAS1X,MAAQgI,UAC3B,KACIkC,OAAU,EAURskE,GALJtkE,EAHCrJ,EAAM2oB,WAAkB,QAAS1U,WACgC,EAAlEzU,OAAOk4B,KAAM13B,EAAM2oB,WAAkB,QAAS1U,WAAWxR,OAE3CzC,EAAM2oB,WAAkB,QAAS1U,UAEjCjU,EAAM2oB,WAAkB,QAASrjB,QAIpCqoE,uBAAyBxmE,UAChC,gBAAkBkC,EAAWQ,aAC7B,gBAAkBR,EAAWskE,qBAE7BC,EAAUF,EAAU72D,SAASC,WAChCrJ,QAAQ,yBAA0B,IAClCA,QAAQ,mBAAoB,IAC5BA,QAAQ,iBAAkB,IAEvBmE,EAAc5R,EAAM2oB,WAAkB,QAAoC/W,WAE5Ea,OAAiB,EAgBnBA,GAfFA,GAAoB,IAAI5K,IACvB8J,6BACC3R,EAAM2oB,WAAW1oB,QACjB2R,EAAWvJ,aACXrI,EAAMkS,IAAIgY,eAAerO,YACzB,IAAIivD,EAAa,CAAEnjD,KAAM3nB,EAAMkS,IAAImW,eAUf,UAAYpK,mBAAmBxL,IAP7B,IAAI5K,IAAkBW,YAC1CrB,UACAnH,EAAMkS,IAAIgY,eAAerO,YACzB,IAAIivD,EAAa,CAAEnjD,KAAM3nB,EAAMkS,IAAImW,aACnCzW,EAAWvJ,cAKfnJ,OAAOH,KACF6uE,EAAO,IAAIn7D,EAAiB,IAAIk7D,EACnC,eAEOD,EAAU72D,UACnB3X,OAAOH,KAAK2uE,EAAU72D,SAAS1X,IAAK,gCArE3CC,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDARLoiD,GAAAA,sBAAgBhiB,GAAAA,0LAYvB,SAAA8tC,GACU1sB,EACAliB,GADAl/B,KAAAohD,eAAAA,EACAphD,KAAAk/B,gBAAAA,EClBZ,IAAAivC,IAcEruE,OAAAC,eACIouE,GAAA/uE,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKC,YAEd,SAAUC,GACRF,KAAKC,OAASC,mCAIhBJ,OAAAC,eACIouE,GAAA/uE,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKG,YAEd,SAAUD,GACRF,KAAKG,OAASD,mCAMhBiuE,GAAA/uE,UAAAgvE,aAAA,SAAa9tE,GACXN,KAAKquE,gBAAgBhvE,KAAKiB,IAG5BR,OAAAC,eAAIouE,GAAA/uE,UAAA,UAAO,KAAX,WACE,GAAKY,KAAKM,MAGV,OAAON,KAAKM,MAAM2oB,WAAW1oB,8DAnChCC,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,6XAEAC,gBAAiBC,GAAAA,wBAAwBC,iEANlCitE,sCASNhtE,GAAAA,qBASAA,GAAAA,SAqBHqtE,IAZE,SAAAA,GAAoBE,GAAAruE,KAAAquE,gBAAAA,EAFZruE,KAAAG,OAAS,UC9BnB,IAAAmuE,IAyBSA,GAAAttE,QAAP,WACE,MAAO,CACLC,SAAUqtE,0BAdfntE,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAC,GAAAA,cACAC,GAAAA,gBACAC,GAAAA,iBACAC,GAAAA,mBAEFC,QAAS,CAACysE,IACVxsE,aAAc,CAACwsE,QAQjBG,IAjBA,SAAAA,MCbA,IAAAC,IAyBEzuE,OAAAC,eACIwuE,GAAAnvE,UAAA,SAAM,KADV,WAEE,OAAOY,KAAKwuE,aAEd,SAAWtuE,GACTF,KAAKwuE,QAAUtuE,EACfF,KAAK+kE,MAAM0J,iDAKb3uE,OAAAC,eACIwuE,GAAAnvE,UAAA,UAAO,KADX,WAEE,OAAOY,KAAK0uE,cAEd,SAAYxuE,GACVF,KAAK0uE,SAAWxuE,EAChBF,KAAK+kE,MAAM0J,iDASb3uE,OAAAC,eAAIwuE,GAAAnvE,UAAA,QAAK,KAAT,WACE,OAAOizC,GAAAA,eAAeryC,KAAKqF,0CAM7BvF,OAAAC,eAAIwuE,GAAAnvE,UAAA,OAAI,KAAR,WACE,OAAOqzC,GAAAA,cAAczyC,KAAKqF,UAAY,wCAaxCkpE,GAAAnvE,UAAAuvE,cAAA,SAAczuE,GACZ,OAAOF,KAAK4uE,UAAUC,+BAA+B3uE,IAGvDquE,GAAAnvE,UAAA0vE,SAAA,SAAS5uE,GACP,MAAwB,iBAAVA,GAGhBquE,GAAAnvE,UAAA2vE,MAAA,SAAM7uE,GACJ,MAAqB,iBAAVA,IAEe,aAAtBA,EAAM62B,MAAM,EAAG,IAA2C,YAAtB72B,EAAM62B,MAAM,EAAG,KAOzDw3C,GAAAnvE,UAAA4vE,wBAAA,SAAwB3pE,OAGlBi8C,EAFEyW,EAAwB1yD,EAAQqtC,KAAOrtC,EAAQqtC,KAAK76B,MAAQpQ,UAC5D2M,EAAa,GASnB,OANIpU,KAAKwS,KACPxS,KAAKwS,IAAImuC,qBAAqBhpC,UAAS,SAACikB,GACtC0lB,EAAqB1lB,IAIrBm8B,GACFj4D,OAAOk4B,KAAK+/B,GAAuBltD,QAAO,SAACkE,GACzCqF,EAAW2jD,EAAsBhpD,IAAU1J,EAAQ+O,WAAWrF,KAEzDqF,IACEktC,IAAuB75C,UAC3B65C,EAaCj8C,EAAQqtC,MAAQrtC,EAAQqtC,KAAKS,yBACC9tC,EAAQqtC,KAAKS,wBACrBtoC,QAAO,SAAC4tB,UACvBpzB,EAAQ+O,WAAWqkB,KAf1Bz4B,KAAK47B,MAAMulB,YAAc97C,EAAQqtC,MAAQrtC,EAAQqtC,KAAKQ,iBAC/B7tC,EAAQqtC,KAAKQ,iBACrBroC,QAAO,SAAC4tB,UAChBpzB,EAAQ+O,WAAWqkB,MAElBz4B,KAAK47B,MAAMulB,YAAc97C,EAAQqtC,MAAQrtC,EAAQqtC,KAAKS,yBAChC9tC,EAAQqtC,KAAKS,wBACrBtoC,QAAO,SAAC4tB,UACvBpzB,EAAQ+O,WAAWqkB,KAY5Bz4B,KAAK47B,MAAMulB,YAAc97C,EAAQqtC,MAAQrtC,EAAQqtC,KAAKQ,iBAC/B7tC,EAAQqtC,KAAKQ,iBACrBroC,QAAO,SAAC4tB,UAChBpzB,EAAQ+O,WAAWqkB,MAElBz4B,KAAK47B,MAAMulB,YAAc97C,EAAQqtC,MAAQrtC,EAAQqtC,KAAKS,yBAChC9tC,EAAQqtC,KAAKS,wBACrBtoC,QAAO,SAAC4tB,UACvBpzB,EAAQ+O,WAAWqkB,KAKzBpzB,EAAQ+O,kCA9HlB5T,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,g/CAEAC,gBAAiBC,GAAAA,wBAAwBC,8KAfzCqlE,GAAAA,yBAEO+I,EAAAA,oBACAhyC,GAAAA,mDAkBNn8B,GAAAA,mBASAA,GAAAA,uBAEAA,GAAAA,SA2GHytE,IAjFE,SAAAA,GACUxJ,EACA6J,EACAlzC,GAHV,IAAA/wB,EAAA3K,KACUA,KAAA+kE,MAAAA,EACA/kE,KAAA4uE,UAAAA,EACA5uE,KAAA07B,eAAAA,EAER17B,KAAK07B,eAAeC,eAAehkB,UAAS,SAAEikB,GAC5CjxB,EAAKixB,MAAQA,ICxDnB,IAAAszC,yBAAC/tE,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAC,GAAAA,cACAG,GAAAA,kBACA0tE,GAAAA,mBAEFztE,QAAS,CAAC6sE,IACV5sE,aAAc,CAAC4sE,QAEqBW,IAVtC,SAAAA,MCFA,IAAAE,yBAACjuE,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAguE,GAAAA,eAEF3tE,QAAS,CACP2tE,GAAAA,cACAh5B,IAEF10C,aAAc,CACZ00C,QAG+B+4B,IAbnC,SAAAA,MCVA,IAAAE,yBAMCnuE,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,cAEFK,QAAS,CACPwtE,GACAE,IAEFztE,aAAc,GACdT,UAAW,OAEkBouE,IAX/B,SAAAA,oBC4CExvE,OAAAC,eACIwvE,GAAAnwE,UAAA,eAAY,KAChB,WAAqC,OAAOY,KAAKwvE,cAActvE,WAF/D,SACiBA,GAAyBF,KAAKwvE,cAAcprE,KAAKlE,oCAsBlEJ,OAAAC,eACIwvE,GAAAnwE,UAAA,YAAS,KACb,WAA0B,OAAOY,KAAKyvE,WAAWvvE,WAFjD,SACcA,GAAiBF,KAAKyvE,WAAWrrE,KAAKlE,oCAoCpDqvE,GAAAnwE,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAK0vE,OAAOtrE,KAAKpE,KAAK2vE,YAAYzvE,MAAQF,KAAK2vE,YAAYzvE,MAAQuH,WACnEzH,KAAK4vE,QAAU5vE,KAAK2vE,YAAYE,aAAal4D,UAAS,SAAEzX,GACtDyK,EAAK+kE,OAAOtrE,KAAKlE,GAAgBuH,cAQrC8nE,GAAAnwE,UAAAs0B,YAAA,WACE1zB,KAAK4vE,QAAQllD,oCAjGhBlqB,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,0BACVC,SAAA,2nDAEAC,gBAAiBC,GAAAA,wBAAwBC,gRAvBzCqlE,GAAAA,2DAqCCplE,GAAAA,mBAKAA,GAAAA,4BAEAA,GAAAA,iCAQAA,GAAAA,6BAKAA,GAAAA,8BAKAA,GAAAA,yBAKAA,GAAAA,oCAQAA,GAAAA,uBAKAA,GAAAA,8BAKAA,GAAAA,yBAKAA,GAAAA,4BAMAA,GAAAA,SAvEUyuE,GAA0BrsE,GAAA,CAPtC4sE,GAAAA,mBAAmB,oCAgFS5J,GAAAA,qBAzEhBqJ,KAyEX,SAAAA,GAAoBxK,GAAA/kE,KAAA+kE,MAAAA,EAvEX/kE,KAAA0vE,OAA2C,IAAIzkD,GAAAA,gBAAgBxjB,WAIjEzH,KAAA+vE,qBAAsB,EACtB/vE,KAAAgwE,sBAAuB,EAerBhwE,KAAAwvE,cAAiD,IAAIvkD,GAAAA,gBAAgBxjB,WAKrEzH,KAAAiwE,mBAA6B,EAK7BjwE,KAAAkwE,cAA0B,CAAC,QAAS,aAAc,WAKlDlwE,KAAAmwE,gBAA0B,EAQ1BnwE,KAAAyvE,WAAsC,IAAIxkD,GAAAA,gBAAgB,GAK1DjrB,KAAAowE,qBAA+B,GAK/BpwE,KAAAqwE,SAAmB,EAKnBrwE,KAAAswE,eAAuC,GC1FlD,QAGEC,OAAS,SACTC,KAAO,YAIPC,OAAS,SACTC,WAAa,aACbC,MAAQ,QACRC,KAAO,QAGIC,KAA6B/rD,GAAA,IACvCgsD,GAAkBL,QAAS,IAC5B3rD,GAACgsD,GAAkBJ,YAAa,KAChC5rD,GAACgsD,GAAkBH,OAAQ,KAC3B7rD,GAACgsD,GAAkBF,MAAO,aAI1BG,aAAe,eACfC,iBAAmB,mBACnBC,YAAc,cACdC,WAAa,aACbC,SAAW,WACXC,MAAQ,SAGGC,KAA2BnyD,GAAA,IACrCoyD,GAAgBP,cAAe,KAChC7xD,GAACoyD,GAAgBN,kBAAmB,MACpC9xD,GAACoyD,GAAgBL,aAAc,MAC/B/xD,GAACoyD,GAAgBJ,YAAa,MAC9BhyD,GAACoyD,GAAgBH,UAAW,KAC5BjyD,GAACoyD,GAAgBF,OAAQ,SCX3B,SAAgBG,GAAmBrxE,GACjC,MAAe,KAARA,EAQT,SAAgBsxE,GAAatxE,GAC3B,OAAe,OAARA,EAQT,SAAgBuxE,GAAcvxE,GAC5B,OAAe,OAARA,EAQT,SAAgBwxE,GAA+BxxE,GAC7C,OAAe,KAARA,EAQT,SAAgByxE,GAA0BzxE,GACxC,OAAe,SAARA,EAQT,SAAgB0xE,GAAyB1xE,GACvC,OAAe,OAARA,EAQT,SAAgB2xE,GAAuB3xE,GACrC,OAAe,KAARA,EAQT,SAAgB4xE,GAAoB5xE,GAClC,OAAe,SAARA,EAST,SAAgB6xE,GAAa7xE,EAAe8mB,OAOpCgrD,EANmB,IAAIvlC,IAAI,CAC/B,CAACqkC,GAAkBL,OAAM,SAAG33C,GAAgB,OAAAA,IAC5C,CAACg4C,GAAkBJ,WAAYa,IAC/B,CAACT,GAAkBH,MAAOc,IAC1B,CAACX,GAAkBF,KAAMY,MAESr5D,IAAI6O,GAExC,OAAOgrD,EAAaA,EAAW9xE,GAASuH,UAS1C,SAAgBwqE,GAAmB/xE,EAAe8mB,OAS1CgrD,EARmB,IAAIvlC,IAAI,CAC/B,CAAC6kC,GAAgBP,aAAY,SAAGj4C,GAAgB,OAAAA,IAChD,CAACw4C,GAAgBN,iBAAkBU,IACnC,CAACJ,GAAgBL,YAAaU,IAC9B,CAACL,GAAgBJ,WAAYU,IAC7B,CAACN,GAAgBH,SAAUU,IAC3B,CAACP,GAAgBF,MAAOU,MAEU35D,IAAI6O,GAExC,OAAOgrD,EAAaA,EAAW9xE,GAASuH,UAS1C,SAAgByqE,GACd7B,EACA9vE,EAMA2+B,OACIvX,EAAUpnB,EAAQonB,SAClBA,IAAYlgB,WAAakgB,EAAU,KACrCA,EAAU,OAGNwqD,EAAQ,GAwBd,OAvBI5xE,EAAQ6xE,SAAW3qE,UACrB0qE,EAAM1tE,KAAK4rE,EAAQgC,eAAe9xE,EAAQ6xE,OAAQ,CAChDE,sBAAuB3qD,EACvB4qD,sBAAuB5qD,KAGzBwqD,EAAM1tE,KAAK4rE,EAAQzoD,QAAQD,GAASoR,YAGlCx4B,EAAQymB,OAASvf,YAAkC,IAArBlH,EAAQiyE,WACpCtzC,EACFizC,EAAM1tE,KACJosE,GAA8BtwE,EAAQymB,MACpCkY,EAAgBC,UAAUC,QAAQ,mBAAqByxC,GAA8BtwE,EAAQymB,OAC7FkY,EAAgBC,UAAUC,QAAQ,mBAAqBiyC,GAA4B9wE,EAAQymB,QAG/FmrD,EAAM1tE,KACJosE,GAA8BtwE,EAAQymB,OAASqqD,GAA4B9wE,EAAQymB,QAKlFmrD,EAAMnoE,OAAM,SAAC9H,GAAK,OAAAA,IAAMuF,YAAWgC,KAAK,KAQjD,SAAgBgpE,GAAsBvyE,GAIpC,QAHI8mB,EAAO8pD,GAAkBL,OACzBiC,EAAYxyE,EACVyyE,EAAgB,CAAC7B,GAAkBJ,YACtB,IAAZgC,GAA2C,EAAvBC,EAAc5vE,QAEvC2vE,EAAYX,GAAa7xE,EADzB8mB,EAAO2rD,EAAc/0D,OAGvB,OAAOoJ,EAQT,SAAgB4rD,GAAoB1yE,GAIlC,QAHI8mB,EAAOsqD,GAAgBP,aACvB2B,EAAYxyE,EACVyyE,EAAgB,CAACrB,GAAgBN,kBACpB,IAAZ0B,GAA8C,EAAvBC,EAAc5vE,QAE1C2vE,EAAYT,GAAmB/xE,EAD/B8mB,EAAO2rD,EAAc/0D,OAGvB,OAAOoJ,EAOT,SAAgB6rD,KACd,OAAO,IAAI78C,GAAAA,MAAc,CACvBJ,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAO,UACPorC,SAAU,CAAC,GAAI,IACfnzB,MAAO,IAETC,KAAO,IAAIK,GAAAA,KAAa,CACtBvY,MAAO,6BAET0O,MAAO,IAAI0J,GAAAA,OAAe,CACxBjT,OAAQ,EACR4S,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAO,YAETkY,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAO,iCAUf,SAAgBi1D,KACd,OAAO,IAAI98C,GAAAA,MAAc,CACvBJ,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAO,UACPiY,MAAO,IAETC,KAAO,IAAIK,GAAAA,KAAa,CACtBvY,MAAO,+BAWb,SAAgBk1D,GAAwBx+B,EAAwB5rB,GAC9D,OAAI4rB,aAAsBZ,EACjBlsC,UAEsC,IAA3C8sC,EAAWy+B,qBAAqBjwE,OAC3B0E,UAEFwrE,EAAAA,UAAY1+B,EAAY,CAAC5rB,WAAUA,IAS5C,SAAgBuqD,GAAsB3+B,EAAwB5rB,GAC5D,OAAI4rB,aAAsBZ,GAAWY,aAAsBX,EAClDnsC,UAEsC,IAA3C8sC,EAAWy+B,qBAAqBjwE,OAC3B0E,UAEF0rE,EAAAA,QAAU5+B,EAAY,CAAC5rB,WAAUA,IAU1C,SAAgByqD,GAAkB7+B,EAAwB5rB,GAOxD,QANM5lB,EAASgwE,GAAwBx+B,EAAY5rB,GAC7C0qD,EAAOH,GAAsB3+B,EAAY5rB,GAEzC2qD,EAAU,GACV7zB,EAAclL,EAAWg/B,gBACzBC,EAAoB/zB,EAAY18C,OAC7BH,EAAI,EAAGA,GAAK4wE,EAAoB,EAAG5wE,GAAK,EAAG,KAC5C6wE,EAAY,IAAI7/B,EAAa,CACjC,CAAC6L,EAAY78C,GAAI68C,EAAY78C,EAAI,IACjC,CAAC68C,EAAY78C,EAAI,GAAI68C,EAAY78C,EAAI,MAGvC0wE,EAAQ7uE,KAAKsuE,GAAwBU,EAAW9qD,IAGlD,MAAO,CACL0qD,KAAIA,EACJtwE,OAAMA,EACNuwE,QAAOA,GASX,SAAgBI,GAA0Bn/B,GAMxC,QALMo/B,EAAcC,GAAuBr/B,GAGrCkL,EAAclL,EAAWg/B,gBACzBM,EAAkBF,EAAY5wE,OAC3BH,EAAI,EAAGA,EAAIixE,EAAiBjxE,IAAK,KAClCqb,EAAQ,EAAJrb,EAMJkxE,EALY,IAAIlgC,EAAa,CACjC,CAAC6L,EAAYxhC,GAAIwhC,EAAgB,EAAJxhC,IAC7B,CAACwhC,EAAgB,EAAJxhC,GAAQwhC,EAAgB,EAAJxhC,MAGE81D,gBAAgB,IAC/CC,EAAaL,EAAY/wE,GAC3BoxE,IAAevsE,UACjBusE,EAAWC,eAAeH,GAE1BH,EAAY/wE,GAAK,IAAI+wC,EAAQmgC,GAGjC,OAAOH,EA6BT,SAASC,GAAuBr/B,OACxB2/B,EAAiBt5D,KAAK+jC,IAAKpK,EAAWg/B,gBAAgBxwE,OAAS,EAAK,EAAG,GAIzE4wE,EAAcp/B,EAAWp8B,IAAI,cACjC,GAAIw7D,IAAgBlsE,UAGlB,OAFAksE,EAAc,IAAI1xE,MAAMiyE,GACxB3/B,EAAW5oB,IAAI,aAAcgoD,GAAa,GACnCA,EAGT,GAAIO,IAAmBP,EAAY5wE,OACjC,OAAO4wE,EAGT,GAAIO,EAAiBP,EAAY5wE,OAE/B,OADA4wE,EAAYlvE,KAAIxB,MAAhB0wE,EAAWhvE,GAAS,IAAI1C,MAAMiyE,EAAiBP,EAAY5wE,UACpD4wE,EAGT,IAAK,IAAI/wE,EAAIsxE,EAAgBtxE,EAAI+wE,EAAY5wE,OAAQH,IAAK,KAClDoxE,EAAaL,EAAYO,GAC3BF,IAAevsE,WACjB0sE,GAAuBH,GAK3B,OAFAL,EAAY9mD,OAAOqnD,GAEZP,EAOT,SAASQ,GAAuBH,OACxBI,EAAYJ,EAAW77D,IAAI,YACjC,GAAIi8D,IAAc3sE,UAAW,KACrBowC,EAAQu8B,EAAUvrC,SACpBgP,IAAUpwC,WACZowC,EAAMw8B,cAAcD,IAU1B,SAAgBE,GAA4B//B,GAW1C,OAVoBm/B,GAA0Bn/B,GACf/hC,IAAG,SAAEwhE,OAC9BI,EAAYJ,EAAW77D,IAAI,YAM/B,OALIi8D,IAAc3sE,UAChB2sE,EAAYG,GAAuBP,GAEnCI,EAAUI,YAAYR,EAAWT,iBAE5Ba,IAUX,SAAgBK,GAAyBlgC,GAEvC,OADoBq/B,GAAuBr/B,GACxB/hC,IAAG,SAAEwhE,GACtB,OAAOA,EAAaA,EAAW77D,IAAI,YAAc1Q,YASrD,SAAgBitE,GAAuBngC,OACjCogC,EAAWpgC,EAAWp8B,IAAI,WACxBy8D,EAAmBC,EAAAA,UAAYtgC,EAAWp4B,aAQhD,OAPIw4D,IAAaltE,UACfktE,EAASV,eAAeW,IAExBD,EAAW,IAAIhhC,EAAQihC,GACvBrgC,EAAW5oB,IAAI,UAAWgpD,IAGrBA,EAQT,SAAgBG,GAAwBvgC,OAChCogC,EAAWD,GAAuBngC,GACpC6/B,EAAYO,EAASx8D,IAAI,YAM7B,OALIi8D,IAAc3sE,UAChB2sE,EAAYG,GAAuBI,GAEnCP,EAAUI,YAAYG,EAASpB,iBAE1Ba,EAQT,SAAgBW,GAAqBxgC,OAC7BogC,EAAWpgC,EAAWp8B,IAAI,WAChC,OAAOw8D,EAAWA,EAASx8D,IAAI,YAAc1Q,UAQ/C,SAAgButE,GAAwBzgC,OAChC0gC,EAAa,GAAGrwE,OAAO6vE,GAAyBlgC,IAAe,IAC/D2gC,EAAkBH,GAAqBxgC,GAI7C,OAHI2gC,IAAoBztE,WACtBwtE,EAAWxwE,KAAKywE,GAEXD,EAQT,SAAgBV,GAAuBY,OAC/Bf,EAAY,IAAIgB,EAAU,CAC9BtqE,QAASuiB,SAASC,cAAc,OAChCiwB,OAAQ,EAAE,IAAK,IACf83B,UAAW,CACT,kBACA,2BACA5rE,KAAK,KACP6rE,WAAW,IAKb,OAHAlB,EAAUI,YAAYW,EAAQ5B,iBAC9B4B,EAAQxpD,IAAI,WAAYyoD,GAEjBA,ECpgBT,IAAA98D,GAAAi+D,IAAwCvuE,GAAAA,GAAxCsQ,GAAwC5P,OAAO6tE,IAA/C,SAAAA,iEAEoDvuE,GAAAA,MAAAuuE,IAKpDC,IAJE,SAAAA,KAAA,IAAA7qE,EACE2M,GAAAtU,KAAAhD,KAAM,gCAA+BA,YACrCF,OAAOiC,eAAe4I,EAAM6qE,GAA+Bp2E,wBAIb4H,GAAAA,MAAAuuE,IAKlDE,IAJE,SAAAA,KAAA,IAAA9qE,EACE2M,GAAAtU,KAAAhD,KAAM,yDAAwDA,YAC9DF,OAAOiC,eAAe4I,EAAM8qE,GAA6Br2E,wBAIF4H,GAAAA,MAAAuuE,IAK3DG,IAJE,SAAAA,KAAA,IAAA/qE,EACE2M,GAAAtU,KAAAhD,KAAM,qFAAmFA,YACzFF,OAAOiC,eAAe4I,EAAM+qE,GAAsCt2E,aCLtE,SAAgBu2E,GAA2B93D,GAEzC,OADAA,EAAQA,GAAS,CAAC,EAAG,IAAK,KACnB,IAAImY,GAAAA,MAAc,CACvBJ,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAOA,EAAMjZ,OAAO,CAAC,IACrBkxB,MAAO,IAETC,KAAO,IAAIK,GAAAA,KAAa,CACtBvY,MAAOA,EAAMjZ,OAAO,CAAC,OAEvB2nB,MAAO,IAAI0J,GAAAA,OAAe,CACxBjT,OAAQ,EACR4S,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAOA,EAAMjZ,OAAO,CAAC,MAEvBmxB,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAOA,EAAMjZ,OAAO,CAAC,WAU7B,SAAgBgxE,KACd,OAAO,IAAI5/C,GAAAA,MAAc,CACvBJ,OAAQ,IAAIC,GAAAA,OAAe,CACzBhY,MAAQ,CAAC,EAAG,IAAK,IAAK,GACtBiY,MAAO,MAWb,SAAgB+/C,GACdthC,EACAuhC,GAEA,OAAIvhC,aAAsBhB,GACjBwiC,GAAexhC,EAAYuhC,GAc7B,GADT,SAAgBE,GAAkBC,EAA4BH,GAC5D,MAAO,GAST,SAAgBC,GAAeG,EAAsBJ,GACnD,GAAqC,EAAjCI,EAAUC,qBACZ,MAAM,IAAIX,GAGZ,GAAuC,EAAnCM,EAAShjD,iBAAiB/vB,OAC5B,MAAM,IAAI0yE,GASZ,QALMW,GADY,IAAIC,IACGxiC,oBAAoBiiC,GACvCQ,EAAmBJ,EAAUK,cAAc,GAAGzjD,iBAE9Cq/C,EAAQ,CAAC,GAAI,IACfqE,EAAyB,EACpB5zE,EAAI,EAAGgnD,EAAK0sB,EAAiBvzE,OAAS,EAAGH,EAAIgnD,EAAIhnD,IAAK,KACvD6zE,EAAqB,CAACH,EAAiB1zE,GAAI0zE,EAAiB1zE,EAAI,IAChE8zE,EAAUC,EAAAA,WAAWF,GACrBG,EAAgBC,EAAcH,EAASN,GAAQz9D,SAE/Cm+D,EAAoBF,EAAc7zE,OAExC,GADAyzE,GAA0BM,EACF,EAApBA,GAAkD,EAAzBN,EAC3B,MAAM,IAAId,GAIZ,GADAvD,EAAM,GAAG1tE,KAAKgyE,EAAmB,IACP,IAAtBK,EAAyB,KACrBC,EAAeH,EAAc,GAAGxrE,SAASq0C,YAC/C0yB,EAAM,GAAG1tE,KAAKsyE,GACd5E,EAAM,GAAG1tE,KAAKsyE,GACd5E,EAAMpiC,WAIV,OAAIymC,GAA0B,EACrB,IAGTrE,EAAM,GAAG1tE,KAAK0tE,EAAM,GAAG,IACvBA,EAAM,GAAG1tE,KAAK0tE,EAAM,GAAG,IAEhB,CAAC,IAAI5+B,GAAU,CAAC4+B,EAAM,KAAM,IAAI5+B,GAAU,CAAC4+B,EAAM,OAS1D,SAAgB6E,GAAyBd,EAAsBe,GAE7Df,EAAUgB,iBAAiBD,GAG7B,SAAgBE,GACdC,OAEM7iC,EAAa6iC,EAAQh0E,OAC3B,OAAImxC,aAAsBhB,GACjBgB,EAAWg/B,gBAAgBx8C,OAAO,GAAI,GAExCwd,EAAWg/B,gBAAgBx8C,OAAO,GC1H3C,QAiCEj3B,OAAAC,eAAIs3E,GAAAj4E,UAAA,SAAM,KAAV,WACE,OAAOY,KAAK63C,QAAUpwC,2CAOxB3H,OAAAC,eAAIs3E,GAAAj4E,UAAA,eAAY,KAAhB,WACE,OAAOY,KAAKO,QAAQk2B,8CAOtB32B,OAAAC,eAAIs3E,GAAAj4E,UAAA,kBAAe,KAAnB,WACE,OAAOY,KAAKs3E,eAAe3oD,6CAe7B0oD,GAAAj4E,UAAA04C,SAAA,SAASD,GACP,GAAIA,IAAUpwC,UAKZ,OAJAzH,KAAKu3E,4BACLv3E,KAAKw3E,4BACLx3E,KAAKy3E,+BACLz3E,KAAK63C,MAAQA,GAIf73C,KAAK63C,MAAQA,EACb73C,KAAK03E,yBACL13E,KAAK23E,wBAMPN,GAAAj4E,UAAAuvB,UAAA,WACE,OAAO3uB,KAAK43E,iBAMNP,GAAAj4E,UAAAy4E,0BAAR,WACE,OAAO,IAAIC,GAAc,CACvBz2D,OAAQrhB,KAAKO,QAAQ8gB,OAASrhB,KAAKO,QAAQ8gB,OAAS,IAAI02D,GACxDxxE,MAAOvG,KAAKO,QAAQ64B,WACpBjQ,OAAQ,OAOJkuD,GAAAj4E,UAAAo4E,0BAAR,WACMx3E,KAAKO,QAAQD,QAAUmH,WAAazH,KAAK63C,QAAUpwC,WACrDzH,KAAK63C,MAAMvQ,YAAYtnC,KAAKs3E,iBAOxBD,GAAAj4E,UAAAs4E,uBAAR,WACM13E,KAAKO,QAAQD,QAAUmH,WACzBzH,KAAK63C,MAAM5F,SAASjyC,KAAKs3E,iBAOrBD,GAAAj4E,UAAAm4E,0BAAR,WACMv3E,KAAKO,QAAQD,QAAUmH,WAAazH,KAAKO,QAAQ8gB,SAAW5Z,WAC9DzH,KAAK43E,gBAAgB/2D,OAAM,IAO/Bw2D,GAAAj4E,UAAAu4E,qBAAA,WAAA,IACMK,EADNrtE,EAAA3K,KAGIg4E,GADgC,IAA9Bh4E,KAAKi4E,UAAUp7C,WACG,IAAIq7C,GAAO,CAC7BzyE,KAAMzF,KAAKy2B,aACXpV,OAAQrhB,KAAK2uB,YACbwpD,WAAW,EACX5xE,MAAOvG,KAAKO,QAAQ63E,UACpBC,UAAWr4E,KAAKO,QAAQ83E,UACxBC,UAAU,EACVC,kBAAiB,WAAQ,OAAA,KAGD,UAAtBv4E,KAAKy2B,aACa,IAAIyhD,GAAO,CAC7BzyE,KAAM,SACN4b,OAAQrhB,KAAK2uB,YACb0pD,UAAWr4E,KAAKO,QAAQ83E,UACxBC,UAAU,IAGQ,IAAIJ,GAAO,CAC7BzyE,KAAMzF,KAAKy2B,aACXpV,OAAQrhB,KAAK2uB,YACb0pD,UAAWr4E,KAAKO,QAAQ83E,UACxBC,UAAU,IAKhBt4E,KAAKw4E,eAAiBR,EACnB9rD,GAAG,YAAW,SAAG7L,GAAuB,OAAA1V,EAAK8tE,YAAYp4D,KAC5DrgB,KAAK04E,aAAeV,EACjB9rD,GAAG,UAAS,SAAG7L,GAAuB,OAAA1V,EAAKguE,UAAUt4D,KACxDrgB,KAAK63C,MAAMhH,eAAemnC,GAC1Bh4E,KAAKg4E,kBAAoBA,GAMnBX,GAAAj4E,UAAAq4E,wBAAR,WACMz3E,KAAKg4E,oBAAsBvwE,YAI/BzH,KAAKojD,uBACL9wB,GAAAA,QAAQ,CACNtyB,KAAKw4E,eACLx4E,KAAK04E,aACL14E,KAAK44E,YAEH54E,KAAK63C,QAAUpwC,WACjBzH,KAAK63C,MAAM7G,kBAAkBhxC,KAAKg4E,mBAEpCh4E,KAAKg4E,kBAAoBvwE,YAOnB4vE,GAAAj4E,UAAAq5E,YAAR,SAAoBp4D,GAApB,IAAA1V,EAAA3K,KACQu0C,EAAal0B,EAAMhb,QAAQ2rB,cACjChxB,KAAK64E,OAAOz0E,KAAKmwC,GACjBv0C,KAAKu3E,4BACLv3E,KAAK44E,UAAYrkC,EAAWroB,GAAG,SAAQ,SAAG4sD,GACxCnuE,EAAKouE,cAAgB5B,GAAoC2B,GACzDnuE,EAAKquE,SAAS50E,KAAK00E,EAAgB11E,UAErCpD,KAAKkjD,sBAOCm0B,GAAAj4E,UAAAu5E,UAAR,SAAkBt4D,GAChBrgB,KAAKojD,uBACL9wB,GAAAA,QAAQtyB,KAAK44E,WACb54E,KAAKi5E,KAAK70E,KAAKic,EAAMhb,QAAQ2rB,gBAMvBqmD,GAAAj4E,UAAA8jD,mBAAR,WAAA,IAAAv4C,EAAA3K,KACEA,KAAKojD,uBACLpjD,KAAKujD,UAAYC,GAAAA,UAAUn2B,SAAU,WAAW1V,UAAS,SAAE0I,GAEnC,KAAlBA,EAAMojC,QAMY,KAAlBpjC,EAAMojC,SACR94C,EAAKktC,MAAMjlB,UAAUhC,QAAQ,CAC3BjK,OAAQhc,EAAKouE,cACb3nD,SAAU,IARZzmB,EAAKqtE,kBAAkBkB,qBAkBrB7B,GAAAj4E,UAAAgkD,qBAAR,WACMpjD,KAAKujD,YAAc97C,YACrBzH,KAAKujD,UAAU74B,cACf1qB,KAAKujD,UAAY97C,YAGvB4vE,IA7LE,SAAAA,GAAoB92E,GAAAP,KAAAO,QAAAA,EAhDbP,KAAA64E,OAA8B,IAAI/9B,GAAAA,QAKlC96C,KAAAi5E,KAA4B,IAAIn+B,GAAAA,QAKhC96C,KAAAg5E,SAAgC,IAAIl+B,GAAAA,QAa3C96C,KAAAi4E,UAAsC,IAAIhtD,GAAAA,iBAAgB,GA0BpD1qB,EAAQD,QAAUmH,UACpBzH,KAAKs3E,eAAiB/2E,EAAQD,MAE9BN,KAAKs3E,eAAiBt3E,KAAK63E,4BC7CjC,QAkDE/3E,OAAAC,eAAIo5E,GAAA/5E,UAAA,SAAM,KAAV,WACE,OAAOY,KAAK63C,QAAUpwC,2CAOxB3H,OAAAC,eAAIo5E,GAAA/5E,UAAA,kBAAe,KAAnB,WACE,OAAOY,KAAKs3E,eAAe3oD,6CAO7B7uB,OAAAC,eAAIo5E,GAAA/5E,UAAA,sBAAmB,KAAvB,WACE,OAAOY,KAAKo5E,mBAAmBzqD,6CAiCjCwqD,GAAA/5E,UAAA04C,SAAA,SAASD,GACP,GAAIA,IAAUpwC,UAOZ,OANAzH,KAAKu3E,4BACLv3E,KAAKw3E,4BACLx3E,KAAKq5E,4BACLr5E,KAAKs5E,+BACLt5E,KAAKy3E,+BACLz3E,KAAK63C,MAAQA,GAIf73C,KAAK63C,MAAQA,EACb73C,KAAK03E,0BAIe,IAAhB13E,KAAKu5E,QACPv5E,KAAK23E,wBAGgB,IAAnB33E,KAAKm/B,YACPn/B,KAAKw5E,4BACLx5E,KAAKy5E,iCAGa,IAAhBz5E,KAAKu5E,SACPv5E,KAAK05E,yBACL15E,KAAK25E,8BAOTR,GAAA/5E,UAAAuvB,UAAA,WACE,OAAO3uB,KAAK43E,iBAOduB,GAAA/5E,UAAAw6E,cAAA,SAAcrlC,OACNjf,EAAY,IAAI2D,GAAU,CAAC7tB,SAAUmpC,IAC3Cv0C,KAAK43E,gBAAgB/2D,QACrB7gB,KAAK43E,gBAAgBh3D,WAAW0U,IAM1B6jD,GAAA/5E,UAAAy4E,0BAAR,WACE,OAAO,IAAIC,GAAc,CACvBz2D,OAAQrhB,KAAKO,QAAQ8gB,OAASrhB,KAAKO,QAAQ8gB,OAAS,IAAI02D,GACxDxxE,MAAOvG,KAAKO,QAAQ64B,WACpBjQ,OAAQ,OAOJgwD,GAAA/5E,UAAAs4E,uBAAR,WACM13E,KAAKO,QAAQD,QAAUmH,WACzBzH,KAAK63C,MAAM5F,SAASjyC,KAAKs3E,iBAOrB6B,GAAA/5E,UAAAo4E,0BAAR,WACMx3E,KAAKO,QAAQD,QAAUmH,WAAazH,KAAK63C,QAAUpwC,WACrDzH,KAAK63C,MAAMvQ,YAAYtnC,KAAKs3E,iBAOxB6B,GAAA/5E,UAAAm4E,0BAAR,WACMv3E,KAAKO,QAAQD,QAAUmH,WAAazH,KAAKO,QAAQ8gB,SAAW5Z,WAC9DzH,KAAK43E,gBAAgB/2D,OAAM,IAIvBs4D,GAAA/5E,UAAAy6E,yBAAR,WACE,OAAO,IAAI/B,GAAc,CACvBz2D,OAAQ,IAAI02D,GACZxxE,MAAOqvE,KACPzsD,OAAQ,OAOJgwD,GAAA/5E,UAAA06E,sBAAR,WACE95E,KAAK63C,MAAM5F,SAASjyC,KAAKo5E,qBAMnBD,GAAA/5E,UAAA26E,yBAAR,WACE/5E,KAAK63C,MAAMvQ,YAAYtnC,KAAKo5E,qBAMtBD,GAAA/5E,UAAA46E,yBAAR,WACEh6E,KAAKi6E,oBAAoBp5D,OAAM,IAMzBs4D,GAAA/5E,UAAAs6E,uBAAR,eACQQ,EAAsB,IAAIC,EAAS,CACvC94D,OAAQrhB,KAAK43E,gBACbrxE,MAAOvG,KAAKO,QAAQ63E,YAEtBp4E,KAAKk6E,oBAAsBA,GAMrBf,GAAA/5E,UAAAi6E,0BAAR,WACMr5E,KAAKk6E,sBAAwBzyE,YAIjCzH,KAAKo6E,8BACLp6E,KAAKk6E,oBAAsBzyE,YAGrB0xE,GAAA/5E,UAAAu6E,0BAAR,WAAA,IAAAhvE,EAAA3K,MAC2C,IAArCA,KAAKq6E,8BAITr6E,KAAKq6E,6BAA8B,EACnCr6E,KAAKs6E,iBAAmBt6E,KAAKk6E,oBAC1BhuD,GAAG,cAAa,SAAG7L,GAAyB,OAAA1V,EAAK4vE,cAAcl6D,KAClErgB,KAAKw6E,eAAiBx6E,KAAKk6E,oBACxBhuD,GAAG,YAAW,SAAG7L,GAAyB,OAAA1V,EAAK8vE,YAAYp6D,KAC9DrgB,KAAK63C,MAAMhH,eAAe7wC,KAAKk6E,uBAGzBf,GAAA/5E,UAAAg7E,4BAAR,YAC2C,IAArCp6E,KAAKq6E,8BAITr6E,KAAKq6E,6BAA8B,EAEnC/nD,GAAAA,QAAQ,CACNtyB,KAAKs6E,iBACLt6E,KAAKw6E,eACLx6E,KAAK06E,cAEH16E,KAAK63C,QAAUpwC,WACjBzH,KAAK63C,MAAM7G,kBAAkBhxC,KAAKk6E,uBAQ9Bf,GAAA/5E,UAAAm7E,cAAR,SAAsBl6D,GAAtB,IAAA1V,EAAA3K,KACQu0C,EAAal0B,EAAM1H,SAASqlB,KAAK,GAAGhN,cAC1ChxB,KAAK64E,OAAOz0E,KAAKmwC,GACjBv0C,KAAK06E,YAAcnmC,EAAWroB,GAAG,SAAQ,SAAG4sD,GAC1CnuE,EAAKouE,cAAgB5B,GAAoC2B,GACzDnuE,EAAKquE,SAAS50E,KAAK00E,EAAgB11E,UAErCpD,KAAKkjD,sBAOCi2B,GAAA/5E,UAAAq7E,YAAR,SAAoBp6D,GAClBiS,GAAAA,QAAQtyB,KAAK06E,aACb16E,KAAKi5E,KAAK70E,KAAKic,EAAM1H,SAASqlB,KAAK,GAAGhN,eACtChxB,KAAKojD,wBAMC+1B,GAAA/5E,UAAA8jD,mBAAR,WAAA,IAAAv4C,EAAA3K,KACEA,KAAKujD,UAAYC,GAAAA,UAAUn2B,SAAU,WAAW1V,UAAS,SAAE0I,GACnC,KAAlBA,EAAMojC,SAER94C,EAAKktC,MAAMjlB,UAAUhC,QAAQ,CAC3BjK,OAAQhc,EAAKouE,cACb3nD,SAAU,OAUV+nD,GAAA/5E,UAAAgkD,qBAAR,WACMpjD,KAAKujD,YAAc97C,WACrBzH,KAAKujD,UAAU74B,eAOXyuD,GAAA/5E,UAAAo6E,0BAAR,eACQmB,EAAyB,IAAIC,EAAY,CAC7Cj1E,OAAQ,CAAC3F,KAAKs3E,kBAEhBt3E,KAAK26E,uBAAyBA,GAMxBxB,GAAA/5E,UAAAk6E,6BAAR,WACMt5E,KAAK26E,yBAA2BlzE,YAIpCzH,KAAK66E,iCACL76E,KAAK26E,uBAAyBlzE,YAGxB0xE,GAAA/5E,UAAAq6E,6BAAR,WAAA,IAAA9uE,EAAA3K,MAC8C,IAAxCA,KAAK86E,iCAIT96E,KAAK86E,gCAAiC,EACtC96E,KAAK+6E,oBAAsB/6E,KAAK26E,uBAC7BzuD,GAAG,iBAAgB,SAAG7L,GAA4B,OAAA1V,EAAKqwE,iBAAiB36D,KAC3ErgB,KAAKi7E,kBAAoBj7E,KAAK26E,uBAC3BzuD,GAAG,eAAc,SAAG7L,GAA4B,OAAA1V,EAAKuwE,eAAe76D,KACvErgB,KAAK63C,MAAMhH,eAAe7wC,KAAK26E,0BAGzBxB,GAAA/5E,UAAAy7E,+BAAR,YAC8C,IAAxC76E,KAAK86E,iCAIT96E,KAAK86E,gCAAiC,EACtCxoD,GAAAA,QAAQ,CACNtyB,KAAK+6E,oBACL/6E,KAAKi7E,kBACLj7E,KAAKm7E,iBAEHn7E,KAAK63C,QAAUpwC,WACjBzH,KAAK63C,MAAM7G,kBAAkBhxC,KAAK26E,0BAQ9BxB,GAAA/5E,UAAA47E,iBAAR,SAAyB36D,GAAzB,IAAA1V,EAAA3K,KACQu0C,EAAal0B,EAAM1H,SAASqlB,KAAK,GAAGhN,cAC1ChxB,KAAK64E,OAAOz0E,KAAKmwC,GACjBv0C,KAAKm7E,eAAiB5mC,EAAWroB,GAAG,SAAQ,SAAG4sD,GAC7CnuE,EAAKquE,SAAS50E,KAAK00E,EAAgB11E,WAQ/B+1E,GAAA/5E,UAAA87E,eAAR,SAAuB76D,GACrBiS,GAAAA,QAAQtyB,KAAKm7E,gBACbn7E,KAAKi5E,KAAK70E,KAAKic,EAAM1H,SAASqlB,KAAK,GAAGhN,gBAMhCmoD,GAAA/5E,UAAAu4E,qBAAR,WAAA,IAAAhtE,EAAA3K,KACQg4E,EAAoB,IAAIE,GAAO,CACnCzyE,KAAM,UACN4b,OAAQrhB,KAAKi6E,oBACb9B,WAAW,EACX5xE,MAAOqvE,KACPhlC,UAAS,SAAGvwB,GAGV,OAFwB1V,EAAKywE,iBAAmBzwE,EAAK0wE,iBAClBC,qBAAqBj7D,EAAMyiC,eAKlE9iD,KAAKg4E,kBAAoBA,EACzBh4E,KAAKu7E,0BAMCpC,GAAA/5E,UAAAm8E,uBAAR,WAAA,IAAA5wE,EAAA3K,KACEA,KAAKw7E,cAAgBh4B,GAAAA,UAAUn2B,SAAU,WAAW1V,UAAS,SAAE0I,GAC7D,GAAsB,KAAlBA,EAAMojC,QAAV,CAEA94C,EAAK8wE,+BAEClnC,EAAa5pC,EAAK0wE,gBACnB9mC,GAAgBA,aAAsBhB,KAE3C5oC,EAAK+wE,uBAEL/wE,EAAKyvE,8BACLzvE,EAAKkwE,iCACLlwE,EAAKgxE,+BAODxC,GAAA/5E,UAAAs8E,qBAAR,WAAA,IAAA/wE,EAAA3K,KACEA,KAAK47E,YAAcp4B,GAAAA,UAAUn2B,SAAU,SACpC1V,UAAS,SAAE0I,GACY,KAAlBA,EAAMojC,UAIV94C,EAAKkxE,yBACLlxE,EAAKy4C,uBACLz4C,EAAKmxE,4BAELnxE,EAAKgvE,6BACkB,IAAnBhvE,EAAKw0B,WACPx0B,EAAK8uE,+BAEP9uE,EAAK4wE,yBAEL5wE,EAAKywE,gBAAkB3zE,UACvBkD,EAAKqvE,2BACLrvE,EAAKsuE,KAAK70E,KAAKuG,EAAK0wE,qBAOlBlC,GAAA/5E,UAAAq8E,yBAAR,WACMz7E,KAAKw7E,gBAAkB/zE,WACzBzH,KAAKw7E,cAAc9wD,eAOfyuD,GAAA/5E,UAAAy8E,uBAAR,WACM77E,KAAK47E,cAAgBn0E,WACvBzH,KAAK47E,YAAYlxD,eAObyuD,GAAA/5E,UAAAq4E,wBAAR,WACMz3E,KAAKg4E,oBAAsBvwE,YAI/BzH,KAAKojD,uBACLpjD,KAAK67E,yBACL77E,KAAKy7E,2BACLz7E,KAAK87E,4BACL97E,KAAKg6E,2BACLh6E,KAAKg4E,kBAAoBvwE,YAMnB0xE,GAAA/5E,UAAAu8E,wBAAR,WAAA,IAAAhxE,EAAA3K,MACyC,IAAnCA,KAAK+7E,4BAIT/7E,KAAKg6E,2BACLh6E,KAAK85E,wBAEL95E,KAAK63C,MAAMtH,kBAAkB1lC,QAAO,SAAE8lC,GAChCA,aAAyBzC,KAC3BvjC,EAAKktC,MAAM7G,kBAAkBL,GAC7BhmC,EAAKqxE,sBAAsBv3E,KAAKksC,MAIpC3wC,KAAK+7E,2BAA4B,EACjC/7E,KAAKw4E,eAAiBx4E,KAAKg4E,kBACxB9rD,GAAG,YAAW,SAAG7L,GAAuB,OAAA1V,EAAK8tE,YAAYp4D,KAC5DrgB,KAAK04E,aAAe14E,KAAKg4E,kBACtB9rD,GAAG,UAAS,SAAG7L,GAAuB,OAAA1V,EAAKguE,UAAUt4D,KACxDrgB,KAAK63C,MAAMhH,eAAe7wC,KAAKg4E,qBAMzBmB,GAAA/5E,UAAA08E,0BAAR,WAAA,IAAAnxE,EAAA3K,MACyC,IAAnCA,KAAK+7E,4BAIT/7E,KAAK+5E,2BAEL/5E,KAAKg8E,sBAAsBnxE,QAAO,SAAE8lC,GAClChmC,EAAKktC,MAAMhH,eAAeF,KAE5B3wC,KAAKg8E,sBAAwB,GAE7Bh8E,KAAK+7E,2BAA4B,EACjCzpD,GAAAA,QAAQ,CACNtyB,KAAKw4E,eACLx4E,KAAK04E,aACL14E,KAAK44E,YAEH54E,KAAK63C,QAAUpwC,WACjBzH,KAAK63C,MAAM7G,kBAAkBhxC,KAAKg4E,qBAQ9BmB,GAAA/5E,UAAAq5E,YAAR,SAAoBp4D,GAApB,IAAA1V,EAAA3K,KACQu0C,EAAal0B,EAAMhb,QAAQ2rB,cACjChxB,KAAKo7E,gBAAkBp7E,KAAKq7E,gBAAgBpqD,YAEtCgrD,EAAwB1nC,EAAWgiC,gBAAgBzjD,iBACzD9yB,KAAKk8E,0BAA0BD,GAC/Bj8E,KAAK64E,OAAOz0E,KAAKpE,KAAKq7E,iBAEtBr7E,KAAK44E,UAAYrkC,EAAWroB,GAAG,SAAQ,SAAG4sD,GACxCnuE,EAAKouE,cAAgB5B,GAAoC2B,OACnDqD,EAAyBrD,EAAgB11E,OAAOmzE,gBAAgBzjD,iBACtEnoB,EAAKyxE,6BAA6BD,GAClCxxE,EAAKquE,SAAS50E,KAAKuG,EAAK0wE,mBAE1Br7E,KAAKkjD,sBAOCi2B,GAAA/5E,UAAAu5E,UAAR,SAAkBt4D,GAChBiS,GAAAA,QAAQtyB,KAAK44E,WACb54E,KAAKo7E,gBAAkB3zE,cAEjBw0E,EAAwB57D,EAAMhb,QAAQ2rB,cAAculD,gBAAgBzjD,iBAC1E9yB,KAAKo8E,6BAA6BH,GAClCj8E,KAAKg6E,2BACLh6E,KAAKi5E,KAAK70E,KAAKpE,KAAKq7E,iBACpBr7E,KAAKojD,wBAOC+1B,GAAA/5E,UAAA88E,0BAAR,SAAkCz8B,GAGhCu3B,GAFmBh3E,KAAKq7E,gBACH,IAAIgB,GAAa58B,KAQhC05B,GAAA/5E,UAAAg9E,6BAAR,SAAqC38B,OAC7BlL,EAAav0C,KAAKq7E,gBAGlBiB,EADgB/nC,EAAWgoC,iBAAiBxlD,MAAM,GAAI,GACvBvkB,IAAG,SAAEykE,GACxC,OAAOA,EAAankD,mBAEtBwpD,EAAe73E,KAAKg7C,GACpBlL,EAAW0/B,eAAeqI,IAOpBnD,GAAA/5E,UAAAi8E,cAAR,eACQzuC,EAAa5sC,KAAK43E,gBAAgB/qC,cACxC,OAA2B,EAApBD,EAAW7pC,OAAa6pC,EAAW,GAAG5b,cAAgBvpB,WAGjE0xE,IAnhBE,SAAAA,GAAoB54E,GAAAP,KAAAO,QAAAA,EA3EbP,KAAA64E,OAA8B,IAAI/9B,GAAAA,QAKlC96C,KAAAi5E,KAA4B,IAAIn+B,GAAAA,QAKhC96C,KAAAg5E,SAAgC,IAAIl+B,GAAAA,QAQnC96C,KAAAq6E,6BAAuC,EAKvCr6E,KAAA86E,gCAA0C,EAK1C96E,KAAA+7E,2BAAqC,EAQrC/7E,KAAAg8E,sBAAyC,GAgCzCh8E,KAAAu5E,QAAkB,EAKlBv5E,KAAAm/B,WAAqB,EAGvB5+B,EAAQg5E,SAAW9xE,YACrBzH,KAAKu5E,OAASh5E,EAAQg5E,QAEpBh5E,EAAQ4+B,YAAc13B,YACxBzH,KAAKm/B,UAAY5+B,EAAQ4+B,WAGvB5+B,EAAQD,QAAUmH,UACpBzH,KAAKs3E,eAAiB/2E,EAAQD,MAE9BN,KAAKs3E,eAAiBt3E,KAAK63E,4BAE7B73E,KAAKo5E,mBAAqBp5E,KAAK65E,2BC/GnC,QAiCE/5E,OAAAC,eAAIy8E,GAAAp9E,UAAA,SAAM,KAAV,WACE,OAAOY,KAAK63C,QAAUpwC,2CAOxB3H,OAAAC,eAAIy8E,GAAAp9E,UAAA,kBAAe,KAAnB,WACE,OAAOY,KAAKs3E,eAAe3oD,6CAe7B6tD,GAAAp9E,UAAA04C,SAAA,SAASD,GACP,GAAIA,IAAUpwC,UAKZ,OAJAzH,KAAKu3E,4BACLv3E,KAAKw3E,4BACLx3E,KAAKy8E,6BACLz8E,KAAK63C,MAAQA,GAIf73C,KAAK63C,MAAQA,EACb73C,KAAK03E,yBACL13E,KAAK08E,sBAMPF,GAAAp9E,UAAAuvB,UAAA,WACE,OAAO3uB,KAAK43E,iBAOd4E,GAAAp9E,UAAAw6E,cAAA,SAAcrlC,OACNjf,EAAY,IAAI2D,GAAU,CAAC7tB,SAAUmpC,IAC3Cv0C,KAAK43E,gBAAgB/2D,OAAM,GAC3B7gB,KAAK43E,gBAAgBh3D,WAAW0U,IAM1BknD,GAAAp9E,UAAAy4E,0BAAR,WACE,OAAO,IAAIC,GAAc,CACvBz2D,OAAQrhB,KAAKO,QAAQ8gB,OAASrhB,KAAKO,QAAQ8gB,OAAS,IAAI02D,GACxDxxE,MAAOvG,KAAKO,QAAQ64B,WACpBjQ,OAAQ,OAOJqzD,GAAAp9E,UAAAo4E,0BAAR,WACMx3E,KAAKO,QAAQD,QAAUmH,WAAazH,KAAK63C,QAAUpwC,WACrDzH,KAAK63C,MAAMvQ,YAAYtnC,KAAKs3E,iBAOxBkF,GAAAp9E,UAAAs4E,uBAAR,WACM13E,KAAKO,QAAQD,QAAUmH,WACzBzH,KAAK63C,MAAM5F,SAASjyC,KAAKs3E,iBAOrBkF,GAAAp9E,UAAAm4E,0BAAR,WACMv3E,KAAKO,QAAQD,QAAUmH,WAAazH,KAAKO,QAAQ8gB,SAAW5Z,WAC9DzH,KAAK43E,gBAAgB/2D,OAAM,IAOvB27D,GAAAp9E,UAAAs9E,mBAAR,WAAA,IAAA/xE,EAAA3K,KACEA,KAAK28E,gBAAkB,IAAItF,GAAY,CACrC5gD,aAAc,aACd2hD,UAAWp4E,KAAKO,QAAQ63E,UACxBC,UAAW,IAEbr4E,KAAK48E,gBAAkB58E,KAAK28E,gBAAgB9D,OACzClhE,UAAS,SAAEklE,GAAyB,OAAAlyE,EAAKmyE,gBAAgBD,KAC5D78E,KAAK+8E,cAAgB/8E,KAAK28E,gBAAgB1D,KACvCthE,UAAS,SAAEklE,GAAyB,OAAAlyE,EAAKqyE,cAAcH,KAC1D78E,KAAK28E,gBAAgB7kC,SAAS93C,KAAK63C,QAM7B2kC,GAAAp9E,UAAAq9E,sBAAR,WACMz8E,KAAK28E,kBAAoBl1E,YAI7BzH,KAAK48E,gBAAgBlyD,cACrB1qB,KAAK+8E,cAAcryD,cACnB1qB,KAAK28E,gBAAgBhuD,YAAY9N,OAAM,GACvC7gB,KAAK28E,gBAAgB7kC,SAASrwC,aAOxB+0E,GAAAp9E,UAAA09E,gBAAR,SAAwBD,GACtB78E,KAAK28E,gBAAgBhuD,YAAY9N,OAAM,IAOjC27D,GAAAp9E,UAAA49E,cAAR,SAAsBH,GAAtB,IAAAlyE,EAAA3K,KACQi9E,EAAqB,GACrBC,EAAaL,EAAO1gE,YAEpB+5B,EAAqB,GAC3B,IACEl2C,KAAK43E,gBAAgBuF,uBAAuBD,EAAU,SAAG5nD,OAEjD8nD,EAAUvH,GADGvgD,EAAUtE,cACe6rD,GACvB,EAAjBO,EAAQr6E,SACVk6E,EAAmBx4E,KAAIxB,MAAvBg6E,EAAkBt4E,GAASy4E,IAC3BlnC,EAAmBzxC,KAAK6wB,MAG5B,MAAO/wB,GACP,GAAIA,aAAagxE,GAEf,YADAv1E,KAAKq9E,OAAOj5E,KAAKG,GAGjB,MAAMA,EAIVvE,KAAK28E,gBAAgBhuD,YAAY9N,OAAM,GAEvC7gB,KAAK43E,gBAAgB7pC,YACnBkvC,EAAmBzqE,IAAG,SAAE+hC,GAA2B,OAAA,IAAItb,GAAUsb,MAEnE2B,EAAmBrrC,QAAO,SAAEyqB,GAC1B3qB,EAAKitE,gBAAgBj3D,cAAc2U,KAGrCt1B,KAAKq9E,OAAOj5E,KAAKqD,WACjBzH,KAAKi5E,KAAK70E,KAAK64E,IAEnBT,IA9JE,SAAAA,GAAoBj8E,GAAAP,KAAAO,QAAAA,EAxCbP,KAAAi5E,KAA8B,IAAIn+B,GAAAA,QAKlC96C,KAAAq9E,OAAsC,IAAIviC,GAAAA,QAoC3Cv6C,EAAQD,QAAUmH,UACpBzH,KAAKs3E,eAAiB/2E,EAAQD,MAE9BN,KAAKs3E,eAAiBt3E,KAAK63E,4BCzEjC,IAAAyF,IAuBEA,GAAAl+E,UAAAm+E,UAAA,WACEv9E,KAAKw9E,UAAU18D,8BAjBlBtgB,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,6hFARO+8E,GAAAA,gDAmBJrqB,GAAAA,OAAMzzD,KAAA,CAAC+9E,GAAAA,sBAOZJ,IATE,SAAAA,GACSE,EACyBx/D,GADzBhe,KAAAw9E,UAAAA,EACyBx9E,KAAAge,KAAAA,EANlChe,KAAA29E,gBAAkBrM,GAElBtxE,KAAA49E,kBAAoB9M,GCgDtB,IAAA+M,IA+LE/9E,OAAAC,eACI89E,GAAAz+E,UAAA,oBAAiB,KACrB,WAAuC,OAAOY,KAAK89E,wBAFnD,SACsB59E,GAAsBF,KAAK+9E,qBAAqB79E,oCAgBtEJ,OAAAC,eAAI89E,GAAAz+E,UAAA,sBAAmB,KAAvB,WACE,OAAOY,KAAKg+E,oBAAsBv2E,2CAGpC3H,OAAAC,eAAI89E,GAAAz+E,UAAA,aAAU,KAAd,WACE,OAAOY,KAAKwS,IAAI1L,GAAG8rB,UAAU8lB,iDAY/BmlC,GAAAz+E,UAAAi0B,SAAA,WACErzB,KAAKi+E,YACLj+E,KAAKk+E,wBACLl+E,KAAKm+E,2BACLn+E,KAAKo+E,sBACLp+E,KAAKq+E,oBACLr+E,KAAKs+E,iBAAiBt+E,KAAKu+E,cAC3Bv+E,KAAKw+E,yBAAyBx+E,KAAK+qC,MAAM1pB,OAAOva,KAOlD+2E,GAAAz+E,UAAAs0B,YAAA,WACE1zB,KAAK+9E,qBAAqBt2E,WAC1BzH,KAAKy+E,0BACLz+E,KAAK0+E,eAOPb,GAAAz+E,UAAAu/E,oBAAA,SAAoBC,GAClB5+E,KAAK6+E,kBAAoBD,GAO3Bf,GAAAz+E,UAAA0/E,oBAAA,SAAoBx9C,IACH,IAAXA,EACFthC,KAAKq+E,oBAELr+E,KAAK++E,yBAQTlB,GAAAz+E,UAAAk/E,iBAAA,SAAiBh9C,IAEA,KADfthC,KAAKu+E,aAAej9C,GAElBthC,KAAKg/E,uBAAuBh/E,KAAK+qC,MAAM1pB,OAAOva,IAE9C9G,KAAKi/E,wBAAwBj/E,KAAK+qC,MAAM1pB,OAAOva,KAQnD+2E,GAAAz+E,UAAA8/E,yBAAA,SAAyB59C,GACvBthC,KAAKm/E,iBAAmB79C,GAO1Bu8C,GAAAz+E,UAAAggF,mBAAA,SAAmBp4D,GACjBhnB,KAAKq/E,iBAAmBr4D,EACxBhnB,KAAKs/E,MAAM7kE,UACXza,KAAKw+E,yBAAyBx+E,KAAK+qC,MAAM1pB,OAAOva,IAC5C9G,KAAKu/E,mBAAqB93E,WAC5BzH,KAAKw/E,2BAA2Bx/E,KAAKu/E,mBAQzC1B,GAAAz+E,UAAAqgF,iBAAA,SAAiBz4D,GACfhnB,KAAK0/E,eAAiB14D,EACtBhnB,KAAKs/E,MAAM7kE,UACXza,KAAKw+E,yBAAyBx+E,KAAK+qC,MAAM1pB,OAAOva,IAC5C9G,KAAKu/E,mBAAqB93E,WAC5BzH,KAAKw/E,2BAA2Bx/E,KAAKu/E,mBAIzC1B,GAAAz+E,UAAAugF,iBAAA,eACQhnE,EAAW3Y,KAAK4/E,kBAAkB1/E,MAClCmzE,EAAO16D,EAASirB,OAAM,SAAEi8C,EAAax6E,GACzC,OAAOw6E,EAAMx6E,EAAQ+O,WAAWi8D,QAAQgD,MAAQ,GAC/C,GACGtwE,EAAS4V,EAASirB,OAAM,SAAEi8C,EAAax6E,GAC3C,MAA8B,YAA1BA,EAAQ+F,SAAS3F,KACZo6E,EAEFA,EAAMx6E,EAAQ+O,WAAWi8D,QAAQttE,QAAU,GACjD,GACG+8E,EAAYnnE,EAASirB,OAAM,SAAEi8C,EAAax6E,GAC9C,MAA8B,eAA1BA,EAAQ+F,SAAS3F,KACZo6E,EAEFA,EAAMx6E,EAAQ+O,WAAWi8D,QAAQttE,QAAU,GACjD,GAEH/C,KAAK+/E,WAAW,CACd1M,KAAIA,EACJtwE,OAAMA,EACN+8E,UAASA,KAIbjC,GAAAz+E,UAAA4gF,cAAA,WACEhgF,KAAK+qC,MAAMk1C,WAAWjgF,KAAK4/E,kBAAkB1/E,QAG/C29E,GAAAz+E,UAAA8gF,cAAA,WACE,GAA4C,IAAxClgF,KAAK4/E,kBAAkB1/E,MAAM6C,OAEjC,IAAkC,IAA9B/C,KAAKmgF,cAAcjwE,OACrBlQ,KAAKy+E,0BACLz+E,KAAKq+E,wBACA,KACC+B,EAAUpgF,KAAK4/E,kBAAkB1/E,MAAM,GAEvCo1B,EADat1B,KAAK+qC,MAAMzqC,MAAMwG,GAAG6nB,YAAYke,cACtB/9B,KAAI,SAAEuxE,GACjC,OAAOA,EAAWloE,IAAI,QAAUioE,EAAQhsE,WAAWvN,KAGrD,GAAIyuB,IAAc7tB,UAAW,CAC3BzH,KAAK++E,wBACL/+E,KAAKsgF,4BAEC/rC,EAAajf,EAAUtE,cAC7BhxB,KAAKugF,0BAA0BhsC,GAC/Bv0C,KAAKmgF,cAAcvG,cAAcrlC,MAK/BspC,GAAAz+E,UAAA2gF,WAAR,SAAmB/hE,GACjBhe,KAAKwgF,OAAOnhF,KAAKi+E,GAAyB,CAACt/D,KAAIA,KAOzC6/D,GAAAz+E,UAAA6+E,UAAR,WAAA,IAAAtzE,EAAA3K,KACQ+qC,EAAQ/qC,KAAK+qC,MAWnB4K,GAAkB5K,EATJ,IAAI/a,GAAY,CAC5Bne,MAAO,WACPsX,OAAQ,IACR9H,OAAQ,IAAIpa,GACZV,MAAOusE,KACP5oD,iBAAiB,EACjBgG,YAAY,EACZD,WAAW,KAIb2lB,GAAsB7K,GAEtBiL,GAAwBjL,EAAO,IAAIoD,GAA8B,CAC/D37B,IAAKxS,KAAKwS,IACViuE,MAAM,KAGRzgF,KAAK0gF,kBAAoB31C,EAAM1pB,OAAOva,GAAGolB,GAAG,aAAY,SAAG7L,OACnDhb,EAAUgb,EAAMhb,QAChBkvC,EAAalvC,EAAQ2rB,cAC3BrmB,EAAKg2E,0BAA0BpsC,EAAYlvC,EAAQ8S,IAAI,cAGzDnY,KAAK4gF,oBAAsB71C,EAAM1pB,OAAOva,GAAGolB,GAAG,gBAAe,SAAG7L,OACxDk0B,EAAal0B,EAAMhb,QAAQ2rB,cACjCrmB,EAAK41E,0BAA0BhsC,KAGjCv0C,KAAK6gF,mBAAqB91C,EAAMqE,UAAUC,QAAO,SAAEC,GACjD,OAAiC,IAA1BA,EAAO1T,MAAM4S,WACnBpjB,KACDqkB,GAAAA,KAAK,IAEN93B,UAAS,SAAE43B,IACwB,IAA9B5kC,EAAKw1E,cAAcjwE,QACrBvF,EAAK8zE,0BAEP9zE,EAAKi1E,kBAAkBx7E,KAAKmrC,EAAQ/8B,IAAG,SAAC88B,GAAU,OAAAA,EAAOE,aASrDquC,GAAAz+E,UAAAs/E,YAAR,eACQ3zC,EAAQ/qC,KAAK+qC,MACnB/qC,KAAK6gF,mBAAmBn2D,cACxB4H,GAAAA,QAAQtyB,KAAK0gF,mBACbpuD,GAAAA,QAAQtyB,KAAK4gF,qBACb5gF,KAAKi/E,wBAAwBl0C,EAAM1pB,OAAOva,IAC1C9G,KAAKwS,IAAI80B,YAAYyD,EAAMzqC,OAC3ByqC,EAAM+1C,yBAAyBj2C,IAC/BE,EAAM+1C,yBAAyB3yC,KAMzB0vC,GAAAz+E,UAAA8+E,sBAAR,WACEl+E,KAAK28E,gBAAkB,IAAItF,GAAY,CACrC5gD,aAAc,aACdpV,OAAQrhB,KAAK+gF,aACb3I,UAAWvF,KACXz5C,WAAY,IAAI4nD,EAAQ,OAOpBnD,GAAAz+E,UAAA++E,yBAAR,WACEn+E,KAAKihF,mBAAqB,IAAI5J,GAAY,CACxC5gD,aAAc,UACdpV,OAAQrhB,KAAK+gF,aACb3I,UAAWvF,KACXz5C,WAAY,IAAI4nD,EAAQ,OAOpBnD,GAAAz+E,UAAAg/E,oBAAR,WACEp+E,KAAKmgF,cAAgB,IAAIhH,GAAc,CACrC93D,OAAQrhB,KAAK+gF,aACb3I,UAAWvF,KACXz5C,WAAY,IAAI4nD,EAAQ,OAOpBnD,GAAAz+E,UAAAi/E,kBAAR,WACEr+E,KAAK++E,wBAED/+E,KAAK6+E,oBAAsBqC,GAAY3Q,OACzCvwE,KAAKmhF,oBAAoBnhF,KAAK28E,iBACrB38E,KAAK6+E,oBAAsBqC,GAAY1Q,MAChDxwE,KAAKmhF,oBAAoBnhF,KAAKihF,qBAQ1BpD,GAAAz+E,UAAA+hF,oBAAR,SAA4BC,GAA5B,IAAAz2E,EAAA3K,KACEA,KAAKg+E,kBAAoBoD,EACzBphF,KAAKqhF,YAAcD,EAAYvI,OAC5BlhE,UAAS,SAAE48B,GAAyC,OAAA5pC,EAAK8tE,YAAYlkC,KACxEv0C,KAAKshF,UAAYF,EAAYnI,KAC1BthE,UAAS,SAAE48B,GAAyC,OAAA5pC,EAAKguE,UAAUpkC,KACtEv0C,KAAKuhF,cAAgBH,EAAYpI,SAC9BrhE,UAAS,SAAE48B,GAAyC,OAAA5pC,EAAK62E,cAAcjtC,KAE1E6sC,EAAYtpC,SAAS93C,KAAKwS,IAAI1L,KAMxB+2E,GAAAz+E,UAAA2/E,sBAAR,WACM/+E,KAAKg+E,oBAAsBv2E,YAI/BzH,KAAK+gF,aAAalgE,QACd7gB,KAAKqhF,cAAgB55E,WAAczH,KAAKqhF,YAAY32D,cACpD1qB,KAAKshF,YAAc75E,WAAczH,KAAKshF,UAAU52D,cAChD1qB,KAAKuhF,gBAAkB95E,WAAczH,KAAKuhF,cAAc72D,cAE5D1qB,KAAKi/E,wBAAwBj/E,KAAK+gF,cAC9B/gF,KAAKu/E,mBAAqB93E,WAC5BzH,KAAKugF,0BAA0BvgF,KAAKu/E,kBAEtCv/E,KAAKg+E,kBAAkBlmC,SAASrwC,WAChCzH,KAAKg+E,kBAAoBv2E,UACzBzH,KAAKu/E,iBAAmB93E,YAGlBo2E,GAAAz+E,UAAA2+E,qBAAR,SAA6Ba,GAC3B5+E,KAAK89E,mBAAqBc,EAC1B5+E,KAAKyhF,gBACLzhF,KAAKq+E,qBAOCR,GAAAz+E,UAAAq5E,YAAR,SAAoBlkC,GAClBv0C,KAAKu/E,iBAAmBhrC,GAOlBspC,GAAAz+E,UAAAu5E,UAAR,SAAkBpkC,GAChBv0C,KAAKu/E,iBAAmB93E,UACxBzH,KAAK0hF,4BAA4BntC,GACjCv0C,KAAK2hF,kBAAkBptC,GACvBv0C,KAAKugF,0BAA0BhsC,GAC/Bv0C,KAAK+gF,aAAalgE,OAAM,IAOlBg9D,GAAAz+E,UAAAoiF,cAAR,SAAsBjtC,OACd87B,EAAU+C,GAAkB7+B,EAAYv0C,KAAK2oB,YACnD3oB,KAAK2gF,0BAA0BpsC,EAAYz0C,OAAO2C,OAAO,GAAI4tE,EAAS,CACpEgD,KAAM5rE,aAERzH,KAAK4hF,SAASx9E,KAAKisE,IAObwN,GAAAz+E,UAAAkhF,sBAAR,WAAA,IAAA31E,EAAA3K,KACQ2nC,EAAY3nC,KAAK+qC,MAAM8K,kBAAkB1H,IAC/CxG,EAAUk6C,aACVl6C,EAAU9mB,QAEV7gB,KAAK8hF,cAAgB9hF,KAAKmgF,cAActH,OACrClhE,UAAS,SAAE48B,GAAyC,OAAA5pC,EAAK4vE,cAAchmC,KAC1Ev0C,KAAK+hF,YAAc/hF,KAAKmgF,cAAclH,KACnCthE,UAAS,SAAE48B,GAAyC,OAAA5pC,EAAK8vE,YAAYlmC,KACxEv0C,KAAKgiF,gBAAkBhiF,KAAKmgF,cAAcnH,SACvCrhE,UAAS,SAAE48B,GAAyC,OAAA5pC,EAAKs3E,gBAAgB1tC,KAC5Ev0C,KAAKmgF,cAAcroC,SAAS93C,KAAKwS,IAAI1L,KAM/B+2E,GAAAz+E,UAAAq/E,wBAAR,WAKE,GAJIz+E,KAAK8hF,gBAAkBr6E,WAAczH,KAAK8hF,cAAcp3D,cACxD1qB,KAAK+hF,cAAgBt6E,WAAczH,KAAK+hF,YAAYr3D,cACpD1qB,KAAKgiF,kBAAoBv6E,WAAczH,KAAKgiF,gBAAgBt3D,cAE5D1qB,KAAKu/E,mBAAqB93E,UAAW,CACvC,GAA4C,IAAxCzH,KAAK4/E,kBAAkB1/E,MAAM6C,OAAc,KACvCsC,EAAUrF,KAAK4/E,kBAAkB1/E,MAAM,GAC7CF,KAAK2hF,kBAAkB3hF,KAAKu/E,iBAAkBl6E,GAEhDrF,KAAK0hF,4BAA4B1hF,KAAKu/E,kBAGxCv/E,KAAK+gF,aAAalgE,QAElB7gB,KAAK+qC,MAAMgL,uBAAuB5H,IAElCnuC,KAAKu/E,iBAAmB93E,UACxBzH,KAAKmgF,cAAcroC,SAASrwC,YAOtBo2E,GAAAz+E,UAAAm7E,cAAR,SAAsBhmC,GACpBv0C,KAAKy4E,YAAYlkC,IAOXspC,GAAAz+E,UAAA6iF,gBAAR,SAAwB1tC,GACtBv0C,KAAKwhF,cAAcjtC,IAObspC,GAAAz+E,UAAAq7E,YAAR,SAAoBlmC,GAClBv0C,KAAK0hF,4BAA4BntC,IAG3BspC,GAAAz+E,UAAAsiF,4BAAR,SAAoCntC,OAC9B87B,EAAU+C,GAAkB7+B,EAAYv0C,KAAK2oB,YAC7C4rB,aAAsBhB,KACxB88B,EAAUvwE,OAAO2C,OAAO,GAAI4tE,EAAS,CACnCiD,QAAS,MAGbtzE,KAAK2gF,0BAA0BpsC,EAAY87B,IAQrCwN,GAAAz+E,UAAAuhF,0BAAR,SAAkCpsC,EAAsC87B,GACtE97B,EAAW2tC,cAAc,CAACC,SAAU9R,IAAU,GAC9CrwE,KAAKw/E,2BAA2BjrC,IAM1BspC,GAAAz+E,UAAAqiF,cAAR,WACEzhF,KAAK4hF,SAASx9E,KAAK,KAQby5E,GAAAz+E,UAAAuiF,kBAAR,SAA0BptC,EAAsClvC,OACxD+8E,EAAY/8E,EAAUA,EAAQ+O,WAAWvN,GAAKT,GAAAA,OAC9CuiB,EAAa3oB,KAAKwS,IAAI1L,GAAG8rB,UAAU8lB,gBACnCttC,GAAW,IAAIirE,IAAYxiC,oBAAoBU,EAAY,CAC/DpnC,kBAAmBwb,EACnBzb,eAAgByb,IAElB3oB,KAAK+qC,MAAMq6B,OAAO,CAChB3/D,KAAM8b,GACNnW,SAAQA,EACRud,WAAYA,EAAWnf,UACvB4K,WAAY,CACVvN,GAAIu7E,EACJ/R,QAAS97B,EAAWp8B,IAAI,aAE1Bu6B,KAAM,CACJ7rC,GAAIu7E,MAWFvE,GAAAz+E,UAAAogF,2BAAR,SAAmCjrC,OAC3B87B,EAAU97B,EAAWp8B,IAAI,YACzBm7D,EAAUjD,EAAQiD,QAClBD,EAAOhD,EAAQgD,KAEfgP,EAAsB/N,GAA4B//B,GACxD,GAAI++B,EAAQvwE,SAAWs/E,EAAoBt/E,OACzC,IAAK,IAAIH,EAAI,EAAGA,EAAIy/E,EAAoBt/E,OAAQH,IAAK,KAC7C0/E,EAAShP,EAAQ1wE,GACnB0/E,IAAW76E,WACbzH,KAAKuiF,gBACHF,EAAoBz/E,GACpBmvE,GAAauQ,EAAQtiF,KAAKq/E,kBAC1Br/E,KAAKq/E,iBACL6B,GAAY3Q,QAMhB8C,IAAS5rE,WACXzH,KAAKuiF,gBACHzN,GAAwBvgC,GACxB09B,GAAmBoB,EAAOrzE,KAAK0/E,gBAC/B1/E,KAAK0/E,eACLwB,GAAY1Q,OAQVqN,GAAAz+E,UAAAojF,yBAAR,SAAiCjuC,GAAjC,IAAA5pC,EAAA3K,KACEg1E,GAAwBzgC,GAAY1pC,QAAO,SAAEupE,GACvCzpE,EAAK83E,kBAAkBrO,IACzBzpE,EAAK6H,IAAI1L,GAAG47E,WAAWtO,MASrByJ,GAAAz+E,UAAAmhF,0BAAR,SAAkChsC,GAAlC,IAAA5pC,EAAA3K,KACEg1E,GAAwBzgC,GAAY1pC,QAAO,SAAEupE,GACvCA,IAAc3sE,WAAa2sE,EAAUvrC,WAAaphC,WACpDkD,EAAK6H,IAAI1L,GAAGutE,cAAcD,MAQxByJ,GAAAz+E,UAAAo/E,yBAAR,SAAiCrtC,GAAjC,IAAAxmC,EAAA3K,KACEmxC,EAASwxC,eAAc,SAAErtD,GACvB3qB,EAAK60E,2BAA2BlqD,EAAUtE,kBAOtC6sD,GAAAz+E,UAAA4/E,uBAAR,SAA+B7tC,GAA/B,IAAAxmC,EAAA3K,KACEmxC,EAASwxC,eAAc,SAAErtD,GACvB3qB,EAAK63E,yBAAyBltD,EAAUtE,kBAQpC6sD,GAAAz+E,UAAA6/E,wBAAR,SAAgC9tC,GAAhC,IAAAxmC,EAAA3K,KACEmxC,EAASwxC,eAAc,SAAErtD,GACJA,EAAUtE,gBACVvpB,WACjBkD,EAAK41E,0BAA0BjrD,EAAUtE,kBAWvC6sD,GAAAz+E,UAAAmjF,gBAAR,SACEnO,EACA/D,EACArpD,EACAvhB,GAEA2uE,EAAU8N,cAAc,CAACC,SAAU9R,EAASuS,MAAO57D,EAAM67D,MAAOp9E,IAAO,GACvE2uE,EAAU0O,aAAaC,UAAY/iF,KAAKgjF,wBAAwB5O,GAC5Dp0E,KAAKyiF,kBAAkBrO,IACzBp0E,KAAKwS,IAAI1L,GAAG47E,WAAWtO,IASnByJ,GAAAz+E,UAAA4jF,wBAAR,SAAgC5O,OACxBhgE,EAAaggE,EAAUh7D,gBAC7B,OAAO84D,GAAc99D,EAAW+tE,SAAU,CACxCx6D,QAAS,EACTX,KAAM5S,EAAWwuE,MACjBpQ,UAAU,EACVJ,OAAQ,MACPpyE,KAAKk/B,kBASF2+C,GAAAz+E,UAAAqjF,kBAAR,SAA0BrO,GACxB,IAA0B,IAAtBp0E,KAAKu+E,aACP,OAAO,MAGHnqE,EAAaggE,EAAUh7D,gBACvBi3D,EAAUj8D,EAAW+tE,SAC3B,GAAI9R,IAAY5oE,UACd,OAAO,EAGT,GAAI2M,EAAWwuE,QAAU1B,GAAY3Q,OAKrC,OAAO,MAJC0S,EAAmBlR,GAAa/xE,KAAKijF,iBAAkB7uE,EAAWwuE,QAAU,EAClF,OAAOvS,EAAUz1D,KAAK+jC,IAAIskC,EAAkB,yBApzBjDziF,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,eACVC,SAAA,wuGAEAC,gBAAiBC,GAAAA,wBAAwBC,wpBA5ClCm/B,GAAAA,uBAhBAkjD,GAAAA,2CA4ONpiF,GAAAA,qBAKAA,GAAAA,iCAMAA,GAAAA,gCASAA,GAAAA,qBAEA+1C,GAAAA,UAASl3C,KAAA,CAAC,YA+mBbk+E,IAjmBE,SAAAA,GACU3+C,EACAshD,GAFV,IAAA71E,EAAA3K,KACUA,KAAAk/B,gBAAAA,EACAl/B,KAAAwgF,OAAAA,EA9MHxgF,KAAAmjF,cAAqC,CAC1Cx7C,WAAW,EACXy7C,YAAY,EACZC,mBAAmB,EACnBniD,MAAM,EACNoiD,QAAS,CACP,CACEt0E,KAAM,SACN6C,MAAO7R,KAAKk/B,gBAAgBC,UAAUC,QAAQ,gCAC9CulC,cAAa,SAAGt/D,OACR2hB,EAAOrc,EAAK00E,iBAElB,OAAOnN,GADSH,GAAa1sE,EAAQ+O,WAAWi8D,QAAQttE,OAAQikB,GAClC,CAC5BW,QAAS,EACTX,KAAIA,EACJwrD,UAAU,EACVJ,OAAQ,SAId,CACEpjE,KAAM,OACN6C,MAAO7R,KAAKk/B,gBAAgBC,UAAUC,QAAQ,8BAC9CulC,cAAa,SAAGt/D,OACR2hB,EAAOrc,EAAK+0E,eACZrP,EAAU4B,GAAmB5sE,EAAQ+O,WAAWi8D,QAAQgD,KAAMrsD,GACpE,OAAOqpD,EAAU6B,GAAc7B,EAAS,CACtC1oD,QAAS,EACTX,KAAIA,EACJwrD,UAAU,EACVJ,OAAQ,OACL,OAUNpyE,KAAA4+E,YAAcsC,GAMdlhF,KAAA29E,gBAAkBrM,GAMlBtxE,KAAA49E,kBAAoB9M,GAMpB9wE,KAAAm/E,kBAA4B,EAM5Bn/E,KAAA4hF,SAAqC,IAAI32D,GAAAA,gBAAgB,IAMzDjrB,KAAA4/E,kBAA2D,IAAI30D,GAAAA,gBAAgB,IAM/EjrB,KAAAu+E,cAAwB,EAyBvBv+E,KAAAq/E,iBAAsCvO,GAAkBL,OAKxDzwE,KAAA0/E,eAAkCpO,GAAgBP,aAwDlD/wE,KAAA+gF,aAAe,IAAIhJ,GAmBnB/3E,KAAA89E,mBAAkCoD,GAAY3Q,OAM7CvwE,KAAAijF,iBAA2B,GC/PtC,IAAAM,IAQEA,GAAAnkF,UAAAkmB,UAAA,SACEplB,EAAe8mB,EACfwrD,EACA7qD,OAEI67D,EAOJ,YAVA,IAAAhR,IAAAA,GAAA,QACA,IAAA7qD,IAAAA,EAAA,GAGoD,GAAhD7nB,OAAOgY,OAAOw5D,IAAiBtgE,QAAQgW,GACzCw8D,EAAMvR,GAAmB/xE,EAAK,GAC6B,GAAlDJ,OAAOgY,OAAOg5D,IAAmB9/D,QAAQgW,KAClDw8D,EAAMzR,GAAa7xE,EAAK,IAGnBsjF,EAAMtR,GAAcsR,EAAK,CAC9B77D,QAAS,EACTX,KAAIA,EACJwrD,SAAQA,EACRJ,OAAQ,OACLoR,wBAzBR7Z,GAAAA,KAAIhqE,KAAA,CAAC,CACJqP,KAAM,oBA0BRu0E,IA3BA,SAAAA,MCqCA,IAAAE,IAgCE3jF,OAAAC,eACI0jF,GAAArkF,UAAA,eAAY,KAWhB,WAAqC,OAAOY,KAAK0jF,mBAZjD,SACiBxjF,GACfF,KAAK0jF,cAAgBxjF,GACF,IAAfF,KAAK2jF,QAIT3jF,KAAK4jF,oBACL5jF,KAAK6jF,oBACL7jF,KAAKohF,YAAYnJ,UAAU7zE,KAAKpE,KAAKgwE,sBACrChwE,KAAK8jF,kDAkBPhkF,OAAAC,eACI0jF,GAAArkF,UAAA,sBAAmB,KADvB,WACqC,OAAOY,KAAK+jF,0BACjD,SAAwB7jF,GACtBF,KAAK+jF,qBAAuB7jF,GACT,IAAfF,KAAK2jF,QAGT3jF,KAAK4jF,oBACA5jF,KAAK+jF,sBAGR/jF,KAAK8jF,kDAQThkF,OAAAC,eACI0jF,GAAArkF,UAAA,uBAAoB,KADxB,WACsC,OAAOY,KAAKgkF,2BAClD,SAAyB9jF,GACvBF,KAAKgkF,sBAAwB9jF,EAC7BF,KAAK4jF,oBAEL5jF,KAAK6jF,oBACL7jF,KAAKo+E,sBAELp+E,KAAKohF,YAAYnJ,UAAU7zE,KAAKpE,KAAKgwE,uBAElB,IAAfhwE,KAAK2jF,OAIJ3jF,KAAK+vE,qBAGV/vE,KAAK8jF,iDAYPhkF,OAAAC,eACI0jF,GAAArkF,UAAA,YAAS,KAmBb,WAA2B,OAAOY,KAAKikF,gBApBvC,SACc/jF,GACRA,IAAUuH,YACZvH,EAAQy1E,MAEV31E,KAAKikF,WAAa/jF,MAEZgkF,EAAelkF,KAAKmkF,2BAA2BjkF,GACjDgkF,IAAiBz8E,UACnBzH,KAAKokF,uBAAyBF,EAAa/0D,WAAWyC,YAEtD5xB,KAAKokF,uBAAyB,KAEhCpkF,KAAK4jF,oBACL5jF,KAAK6jF,oBACL7jF,KAAKo+E,sBAELp+E,KAAKohF,YAAYnJ,UAAU7zE,KAAKpE,KAAKgwE,sBACrChwE,KAAK8jF,iDASPhkF,OAAAC,eACI0jF,GAAArkF,UAAA,eAAY,KAChB,WAA8B,OAAOY,KAAKqkF,mBAF1C,SACiBnkF,GAAkBF,KAAKqkF,cAAgBnkF,mCAQxDJ,OAAAC,eACI0jF,GAAArkF,UAAA,QAAK,KAeT,WAA+B,OAAOY,KAAKskF,YAhB3C,SACUpkF,GACRF,KAAKskF,OAASpkF,GACK,IAAfF,KAAK2jF,QAILzjF,EACFF,KAAKukF,oBAAoBrkF,GAEzBF,KAAK43E,gBAAgB/2D,OAAM,GAE7B7gB,KAAKwkF,SAAStkF,GACdF,KAAK8jF,gBACL9jF,KAAK+kE,MAAM0J,kDASb3uE,OAAAC,eAAI0jF,GAAArkF,UAAA,kBAAe,KAAnB,WACE,OAAOY,KAAKs3E,eAAe3oD,6CAG7B7uB,OAAAC,eACI0jF,GAAArkF,UAAA,SAAM,KADV,SACWc,GADX,IASQukF,EATR95E,EAAA3K,MAEqB,IAAfA,KAAK2jF,QAGL3jF,KAAKmgF,cAAcxxD,aACrB3uB,KAAKmgF,cAAcxxD,YAAYlU,UAE7Bza,KAAKgwE,sBAEPrrC,WAAU,YACR8/C,EAAW95E,EAAKw1E,cAAcjG,sBAExBuK,EAASC,WACXD,EAASC,UAAU7jE,SAGtB,qCAoBP4iE,GAAArkF,UAAAi0B,SAAA,WACMrzB,KAAKo4E,YAAc3wE,YACrBzH,KAAKo4E,UAAYzC,MAGf31E,KAAK2kF,eAAiBl9E,YACxBzH,KAAK2kF,aAAe3kF,KAAKo4E,WAG3Bp4E,KAAK4kF,oBACL5kF,KAAK6kF,uBACL7kF,KAAK6jF,oBACL7jF,KAAKo+E,sBAEDp+E,KAAKE,OACPF,KAAKukF,oBAAoBvkF,KAAKE,OAEhCF,KAAK8jF,gBAEL9jF,KAAK2jF,OAAQ,GAOfF,GAAArkF,UAAAs0B,YAAA,WAKE1zB,KAAK2jF,OAAQ,EAEb3jF,KAAK4jF,oBACL5jF,KAAK43E,gBAAgB/2D,QACrB7gB,KAAKwS,IAAI1L,GAAGwgC,YAAYtnC,KAAKs3E,iBAO/BmM,GAAArkF,UAAA0lF,iBAAA,SAAiBC,GACf/kF,KAAKwkF,SAAWO,GAQlBtB,GAAArkF,UAAA4lF,kBAAA,SAAkBD,GAChB/kF,KAAKilF,UAAYF,GAOnBtB,GAAArkF,UAAA8lF,WAAA,SAAWhlF,GACTF,KAAKE,MAAQA,GAMPujF,GAAArkF,UAAAwlF,kBAAR,WACE5kF,KAAKs3E,eAAiB,IAAIQ,GAAc,CACtCz2D,OAAQ,IAAI02D,GACZ5uD,OAAQ,IACR5iB,MAAO,OAETvG,KAAKwS,IAAI1L,GAAGmrC,SAASjyC,KAAKs3E,iBAMpBmM,GAAArkF,UAAAykF,kBAAR,WAAA,IAAAl5E,EAAA3K,KACQswE,EAAiBxwE,OAAO2C,OAAO,GAAIzC,KAAKswE,eAAgB,CAC5D75C,aAAcz2B,KAAKy2B,cAAgB,QACnCn2B,MAAON,KAAKs3E,eACZc,UAAqC,mBAAnBp4E,KAAKo4E,UAA2Bp4E,KAAKo4E,UAAS,SAAI9iD,EAAsB9e,OAClFjQ,EAAQoE,EAAKytE,UAEnB,OADAztE,EAAKw6E,6BAA6B5+E,EAAOiQ,GAClCjQ,KAGXvG,KAAKohF,YAAc,IAAI/J,GAAY/G,IAM7BmT,GAAArkF,UAAAg/E,oBAAR,WAAA,IAAAzzE,EAAA3K,KACQswE,EAAiBxwE,OAAO2C,OAAO,GAAIzC,KAAKswE,eAAgB,CAC5DhwE,MAAON,KAAKs3E,eACZc,UAAqC,mBAAnBp4E,KAAKo4E,UAA2Bp4E,KAAKo4E,UAAS,SAAI9iD,EAAsB9e,OAClFjQ,EAAQoE,EAAKytE,UAEnB,OADAztE,EAAKw6E,6BAA6B5+E,EAAOiQ,GAClCjQ,KAGXvG,KAAKmgF,cAAgB,IAAIhH,GAAc7I,IAMjCmT,GAAArkF,UAAA0kF,cAAR,eACMz1C,GAEFA,GADGruC,KAAKE,OAASF,KAAKy2B,aACXz2B,KAAKohF,YAELphF,KAAKmgF,iBAODngF,KAAKolF,gBACpBplF,KAAK4jF,oBACL5jF,KAAKqlF,gBAAgBh3C,KAQjBo1C,GAAArkF,UAAAimF,gBAAR,SAAwBC,GAAxB,IAAA36E,EAAA3K,KACEA,KAAKolF,cAAgBE,EACrBtlF,KAAKulF,iBAAmBD,EAAQrM,KAC7BthE,UAAS,SAAE48B,GAA2B,OAAA5pC,EAAK66E,iBAAiBjxC,MAC1C,IAAjBv0C,KAAKqwE,SAAoBiV,IAAYtlF,KAAKohF,cAC5CphF,KAAKylF,oBAAsBH,EAAQtM,SAChCrhE,UAAS,SAAE48B,GAA2B,OAAA5pC,EAAK+6E,oBAAoBnxC,MAEpE+wC,EAAQxtC,SAAS93C,KAAKwS,IAAI1L,KAMpB28E,GAAArkF,UAAAwkF,kBAAR,WACE5jF,KAAK2lF,uBACD3lF,KAAKolF,gBAAkB39E,WACzBzH,KAAKolF,cAActtC,SAASrwC,WAE1BzH,KAAKulF,mBAAqB99E,WAC5BzH,KAAKulF,iBAAiB76D,cAEpB1qB,KAAKylF,sBAAwBh+E,WAC/BzH,KAAKylF,oBAAoB/6D,cAE3B1qB,KAAKolF,cAAgB39E,WAOfg8E,GAAArkF,UAAAomF,iBAAR,SAAyBjxC,GACvBv0C,KAAK2lF,uBACL3lF,KAAK45E,cAAcrlC,IAObkvC,GAAArkF,UAAAsmF,oBAAR,SAA4BnxC,GACG,UAAzBA,EAAW5iB,WACb3xB,KAAK4lF,qBAAqBrxC,IAStBkvC,GAAArkF,UAAAw6E,cAAR,SAAsBrlC,OAChBr0C,EACAq0C,IAAe9sC,YAIU,WAAzB8sC,EAAW5iB,YACb4iB,EAAav0C,KAAK6lF,cAActxC,IAGlCr0C,EAAQF,KAAK8lF,UAAUjyC,oBAAoBU,EAAY,CACrDpnC,kBAAmBnN,KAAKwS,IAAImW,WAC5Bzb,eAAgB,cAEdqnC,EAAWp8B,IAAI,YACjBjY,EAAM8iB,OAASuxB,EAAWp8B,IAAI,UAC9Bo8B,EAAWwxC,QAAU7lF,EAAM8iB,QAE7BhjB,KAAKklF,WAAWhlF,KAGVujF,GAAArkF,UAAAymF,cAAR,SAAsBtxC,OACd5tB,EAAS4tB,EAAWoE,YACpB8G,EAAcz5B,GAAAA,UAAiBW,EAAQ3mB,KAAKwS,IAAImW,WAAY,aAC5D3F,EAASpI,KAAKiM,MAAM0tB,EAAW3iB,YAAehX,KAAKorE,IAAKprE,KAAKyuC,GAAK,IAAO5J,EAAY,KAK3F,OAFAlL,EAAa,IAAIm3B,EAAM/kD,IACZgF,IAAI,SAAU3I,GAAQ,GAC1BuxB,GAODkvC,GAAArkF,UAAAmlF,oBAAR,SAA4Bn5E,OACpBmpC,EAAav0C,KAAK8lF,UAAU74E,aAAa7B,EAAU,CACvD8B,eAAgB,YAChBC,kBAAmBnN,KAAKwS,IAAImW,aAExB2M,EAAY,IAAI2D,GAAU,CAC9B7tB,SAAUmpC,IAEZjf,EAAUlD,SAASpyB,KAAK2kF,cACxB3kF,KAAK43E,gBAAgB/2D,QACrB7gB,KAAK43E,gBAAgBh3D,WAAW0U,IAM1BmuD,GAAArkF,UAAAylF,qBAAR,WACE7kF,KAAKo0E,UAAY,IAAIgB,EAAU,CAC7BtqE,QAASuiB,SAASC,cAAc,OAChCiwB,OAAQ,EAAE,IAAK,IACf83B,UAAW,CACT,kBACA,2BACA5rE,KAAK,KACP6rE,WAAW,KAQPmO,GAAArkF,UAAAwmF,qBAAR,SAA6BrxC,OAErB++B,EADUF,GAAkB7+B,EAAYv0C,KAAKwS,IAAImW,YAC/B2qD,QAClB2S,EAAqC,YAAzB1xC,EAAW5iB,UAA0B2hD,EAAQvwE,OAAS,EAAIuwE,EAAQvwE,OAAS,EACvFmjF,EAAa5S,EAAQ2S,GAErBtS,EAAcD,GAA0Bn/B,GACxC4xC,EAAiBxS,EAAYsS,GACnC,GAA2B,IAAvBtS,EAAY5wE,QAAgBojF,IAAmB1+E,UAAnD,CAKAzH,KAAKo0E,UAAUI,YAAY2R,EAAe5S,qBAEpC6S,EAAYlU,GAAcgU,EAAY,CAC1Cv+D,QAAS,EACTX,KAAM8pD,GAAkBL,OACxB+B,UAAU,EACVJ,OAAQ,OAEVpyE,KAAKo0E,UAAU0O,aAAaC,UAAYqD,EACpCpmF,KAAKo0E,UAAUvrC,WAAaphC,WAC9BzH,KAAKwS,IAAI1L,GAAG47E,WAAW1iF,KAAKo0E,gBAd5Bp0E,KAAK2lF,wBAqBDlC,GAAArkF,UAAAumF,qBAAR,WACM3lF,KAAKo0E,UAAUvrC,QAAU7oC,KAAKo0E,UAAUvrC,WAAaphC,YACvDzH,KAAKwS,IAAI1L,GAAGutE,cAAcr0E,KAAKo0E,WAC/Bp0E,KAAKo0E,UAAUjqD,OAAO1iB,aASlBg8E,GAAArkF,UAAA+lF,6BAAR,SAAqCkB,EAAkB7vE,OAC/C0tE,EAAelkF,KAAKmkF,2BAA2BkC,GACrD,GAAInC,IAAiBz8E,UAArB,KAKIub,EADEsjE,EAAYtmF,KAAKsmF,UAGrBtjE,GADGsjE,GAAaA,EAAY,EACnBtmF,KAAKokF,uBAEO,EAAZkC,EAAgBA,EAAY9vE,EAAa8vE,EAEpDpC,EAAa/0D,WAAW0C,UAAU7O,KAO5BygE,GAAArkF,UAAAmnF,kBAAR,SAA0BF,GACxB,MAA0B,mBAAZA,GAA0BA,EAAQl3D,UAAYk3D,EAAQl3D,WAAW0C,WAOzE4xD,GAAArkF,UAAA+kF,2BAAR,SAAmCkC,GAIjC,OAHIpkF,MAAM2uD,QAAQy1B,KAChBA,EAAUA,EAAQ,IAEhBrmF,KAAKumF,kBAAkBF,GAClBA,EAEF5+E,gCAzhBVjH,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,gCACVC,SAAA,8BACAC,gBAAiBC,GAAAA,wBAAwBC,qDAzCzCqlE,GAAAA,yBAKOsgB,GAAAA,UAASrjF,WAAA,CAAA,CAAAsC,KAoOb+jC,GAAAA,UAAQ,CAAA/jC,KAAIovB,GAAAA,wCAxKd/zB,GAAAA,4BAKAA,GAAAA,yBAkBAA,GAAAA,uBAKAA,GAAAA,mCAKAA,GAAAA,oCAmBAA,GAAAA,8BAyBAA,GAAAA,yBAKAA,GAAAA,4BA2BAA,GAAAA,qBASAA,GAAAA,sBA2BAA,GAAAA,SA+WH2iF,IA1VE,SAAAA,GACU1e,EACmB0hB,GADnBzmF,KAAA+kE,MAAAA,EACmB/kE,KAAAymF,UAAAA,EA3LrBzmF,KAAA8lF,UAAY,IAAIzP,GAChBr2E,KAAA2jF,OAAQ,EAOR3jF,KAAAo0E,UAAYgB,EAkCXp1E,KAAAsmF,UAAoB,KAKpBtmF,KAAAqwE,SAAmB,EAmBpBrwE,KAAA+jF,sBAAgC,EA8B/B/jF,KAAAswE,eAAuC,GAsJxCtwE,KAAAwkF,SAAQ,aASRxkF,KAAAilF,UAAS,aAlEXjlF,KAAKymF,YAAch/E,YAGrBzH,KAAKymF,UAAU9hB,cAAgB3kE,MCnOrC,IAAA0mF,yBAACvlF,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACA2mE,GAAAA,YACA2e,GAAAA,oBACArlF,GAAAA,cACAymE,GAAAA,mBACAD,GAAAA,eACAvmE,GAAAA,gBACAqlF,GAAAA,sBACAnlF,GAAAA,mBAEFC,QAAS,CACP6tE,GACAkU,IAEF9hF,aAAc,CACZ4tE,GACAkU,QAGqCiD,IArBzC,SAAAA,MCnBA,IAAAG,yBAMC1lF,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAqlF,IAEFhlF,QAAS,CACPglF,IAEF/kF,aAAc,GACdT,UAAW,GACX4lF,gBAAiB,CACfvX,QAG4BsX,IAdhC,SAAAA,MCNA,IAAAE,IAiBEjnF,OAAAC,eAAIgnF,GAAA3nF,UAAA,QAAK,KAAT,eACQ4K,EAAShK,KAAKO,QAAkB,WACtC,OAAIyJ,GAAUA,EAAOvB,QACZ,OAEP,mCAIJ3I,OAAAC,eACIgnF,GAAA3nF,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKC,YAEd,SAAUC,IACRF,KAAKC,OAASC,KAEZF,KAAKO,QAAUP,KAAKM,MAAM2oB,WAAkB,0CAehD89D,GAAA3nF,UAAAi0B,SAAA,WACErzB,KAAKO,QAAUP,KAAKM,MAAM2oB,WAAkB,8BA1C/CzoB,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,yBACVC,SAAA,2rBAEAC,gBAAiBC,GAAAA,wBAAwBC,8FAexCC,GAAAA,mBAYAA,GAAAA,qBAEAA,GAAAA,sBAEAA,GAAAA,SASHimF,IALE,SAAAA,KANS/mF,KAAA6d,MAAgB,UAEhB7d,KAAAgnF,QAAkB,EAEpBhnF,KAAAinF,oBAAqB,EC5C9B,IAAAC,IAsCEpnF,OAAAC,eACImnF,GAAA9nF,UAAA,eAAY,KADhB,SACiBc,GACf,GAAIA,GACEF,KAAKyF,OAAS+qD,GAAepE,KAAM,KAC/B+6B,EAAajnF,EAAMuK,MAAM,KAC/B,GAAwB,EAApB08E,EAAWpkF,OAAY,KACnBqkF,EAAY,IAAI32D,KAAK02D,EAAW,IAChCE,EAAU,IAAI52D,KAAK02D,EAAW,IAC/BG,MAAMF,EAAUG,aACnBvnF,KAAKonF,UAAYA,GAEdE,MAAMD,EAAQE,aACjBvnF,KAAKqnF,QAAUA,sCAgBzBvnF,OAAAC,eAAImnF,GAAA9nF,UAAA,OAAI,KAAR,WACE,OAAOY,KAAKO,QAAQkF,OAASgC,UACzB+oD,GAAevE,KACfjsD,KAAKO,QAAQkF,sCAGnB3F,OAAAC,eAAImnF,GAAA9nF,UAAA,UAAO,KAAX,WACE,OAAOY,KAAKO,QAAQgwD,QAAU9oD,WAC5BzH,KAAKO,QAAQgG,QAAUkqD,GAAgBnE,QAErCtsD,KAAKO,QAAQgwD,uCAGnBzwD,OAAAC,eAAImnF,GAAA9nF,UAAA,QAAK,KAAT,WACE,OAAOY,KAAKO,QAAQgG,QAAUkB,UAC1BgpD,GAAgBnE,OAChBtsD,KAAKO,QAAQgG,uCAGnBzG,OAAAC,eAAImnF,GAAA9nF,UAAA,OAAI,KAAR,eACM6xD,EAAO,MACX,GAAIjxD,KAAKO,QAAQ0wD,OAASxpD,UACxB,OAAQzH,KAAKyF,MACX,KAAK+qD,GAAevE,KACpB,KAAKuE,GAAerE,SAClB8E,EAAO,MACP,MACF,KAAKT,GAAetE,KAClB+E,EAAO,KACP,MACF,KAAKT,GAAepE,KAClB6E,EAAO,QACP,MACF,QACEA,EAAO,WAGXA,EAAOjxD,KAAKwnF,kBAAkBxnF,KAAKO,QAAQ0wD,MAG7C,OAAOA,mCAGTnxD,OAAAC,eAAImnF,GAAA9nF,UAAA,eAAY,KAAhB,WACE,OAAOY,KAAKO,QAAQknF,eAAiBhgF,UACjC,IACAzH,KAAKO,QAAQknF,8CAGnB3nF,OAAAC,eAAImnF,GAAA9nF,UAAA,MAAG,KAAP,WACE,GAAIY,KAAKO,QAAQgqD,IAAK,KACdA,EAAM,IAAI95B,KAAKzwB,KAAKO,QAAQgqD,KAClC,OAAO,IAAI95B,KAAK85B,EAAI75B,UAAsC,IAA1B65B,EAAIm9B,qBAEpC,OAAOjgF,2CAIX3H,OAAAC,eAAImnF,GAAA9nF,UAAA,MAAG,KAAP,WACE,GAAIY,KAAKO,QAAQo+C,IAAK,KACdA,EAAM,IAAIluB,KAAKzwB,KAAKO,QAAQo+C,KAClC,OAAO,IAAIluB,KAAKkuB,EAAIjuB,UAAsC,IAA1BiuB,EAAI+oC,qBAEpC,OAAOjgF,2CAIX3H,OAAAC,eAAImnF,GAAA9nF,UAAA,KAAE,KAAN,WACE,OAAOY,KAAKO,QAAQgwD,QAAU9oD,WAAoBzH,KAAKO,QAAQgwD,uCAOjE22B,GAAA9nF,UAAAi0B,SAAA,WAgBE,GAfIrzB,KAAKonF,YAAc3/E,YACrBzH,KAAKonF,UAAY,IAAI32D,KAAKzwB,KAAKuqD,MAE7BvqD,KAAKqnF,UAAY5/E,YACnBzH,KAAKqnF,QAAU,IAAI52D,KAAKzwB,KAAK2+C,MAE3B3+C,KAAK2nF,YAAclgF,YACrBzH,KAAK2nF,UAAY,IAAIl3D,KAAKzwB,KAAKonF,WAAW9c,cAC1CtqE,KAAK4nF,cAAgB5nF,KAAK2nF,WAExB3nF,KAAK6nF,UAAYpgF,YACnBzH,KAAK6nF,QAAU,IAAIp3D,KAAKzwB,KAAKqnF,SAAS/c,cACtCtqE,KAAK8nF,YAAc9nF,KAAK6nF,SAGrB7nF,KAAK+nF,QAIH,CACL,IAASnlF,EAAI5C,KAAK2nF,UAAW/kF,EAAI5C,KAAK6nF,QAASjlF,IAC7C5C,KAAKgoF,eAAevjF,KAAK7B,GAE3B,IAASA,EAAI5C,KAAK2nF,UAAY,EAAG/kF,GAAK5C,KAAK6nF,QAASjlF,IAClD5C,KAAKioF,aAAaxjF,KAAK7B,QARzB,IAAK,IAAIA,EAAI5C,KAAK2nF,UAAW/kF,GAAK5C,KAAK6nF,QAAU,EAAGjlF,IAClD5C,KAAKkoF,UAAUzjF,KAAK7B,GAUxB5C,KAAKO,QAAQkI,QACXzI,KAAKO,QAAQkI,UAAYhB,WAAmBzH,KAAKO,QAAQkI,QAC3DzI,KAAKmoF,mBACDnoF,KAAKO,QAAQkI,QACVzI,KAAK+nF,SAA0B,WAAf/nF,KAAKuG,OAAoC,SAAdvG,KAAKyF,MACnDzF,KAAKooF,WAAWtrD,KAAK98B,KAAKoqE,OAG5BpqE,KAAKqoF,0BACLroF,KAAKooF,WAAWtrD,KAAKr1B,aAIzBy/E,GAAA9nF,UAAAipF,wBAAA,WAGKroF,KAAK+nF,SACN/nF,KAAKuG,QAAUkqD,GAAgBnE,QAC/BtsD,KAAKyF,OAAS+qD,GAAepE,OAE7BpsD,KAAKO,QAAQL,MAAQF,KAAKoqE,KAAKrxC,aAInCmuD,GAAA9nF,UAAA+oF,iBAAA,eACQG,EAActoF,KAAKM,MAAM2oB,WAAWniB,GAAG04B,YAAY0sB,KACzD,GACGlsD,KAAK+nF,SACN/nF,KAAKuG,QAAUkqD,GAAgBnE,QAC/BtsD,KAAKyF,OAAS+qD,GAAepE,MASxB,GACLpsD,KAAK+nF,SACL/nF,KAAKuG,QAAUkqD,GAAgBpE,UAC/BrsD,KAAKyF,OAAS+qD,GAAepE,MAEzBk8B,EAAa,CACftoF,KAAK2nF,UAAY5oE,SAASupE,EAAYxqE,OAAO,EAAG,GAAI,IACpD9d,KAAK6nF,QAAU9oE,SAASupE,EAAYxqE,OAAO,EAAG,GAAI,IAGlD,QAFMyqE,EAA2B,GAC3BC,EAAyB,GACtB5lF,EAAI5C,KAAK4nF,cAAehlF,EAAI5C,KAAK6nF,QAASjlF,IACjD2lF,EAAkB9jF,KAAK7B,GAEzB,IAASA,EAAI5C,KAAK2nF,UAAY,EAAG/kF,GAAK5C,KAAK8nF,YAAallF,IACtD4lF,EAAgB/jF,KAAK7B,GAEvB5C,KAAKgoF,eAAiBO,EACtBvoF,KAAKioF,aAAeO,QAxBlBF,EACFtoF,KAAKoqE,KAAO,IAAI35C,KAAK63D,EAAYvvD,YAAYuxC,cAAgB,EACpDtqE,KAAKO,QAAQL,MACtBF,KAAKoqE,KAAO,IAAI35C,KAAKzwB,KAAKO,QAAQL,MAAM64B,YAAYuxC,cAAgB,EAEpEtqE,KAAKoqE,KAAO,IAAI35C,KAAKzwB,KAAKuqD,KAAK+f,cAAgB,GAyBrD4c,GAAA9nF,UAAAqpF,iBAAA,SAAiBpoE,GACfrgB,KAAK0oF,kBACL1oF,KAAK2oF,kBAGD3oF,KAAK+nF,QACP/nF,KAAK6kD,OAAO/nB,KAAK,CAAC98B,KAAKonF,UAAWpnF,KAAKqnF,UAEvCrnF,KAAK6kD,OAAO/nB,KAAK98B,KAAKonF,YAI1BF,GAAA9nF,UAAAwpF,iBAAA,SAAiBvoE,GACf,GAAIrgB,KAAK+nF,QAAS,CAChB/nF,KAAKioF,aAAe,GACpB,IAAK,IAAIrlF,EAAI5C,KAAK2nF,UAAY,EAAG/kF,GAAK5C,KAAK8nF,YAAallF,IACtD5C,KAAKioF,aAAaxjF,KAAK7B,GAGzB,IADA5C,KAAKgoF,eAAiB,GACbplF,EAAI5C,KAAK4nF,cAAgB,EAAGhlF,EAAI5C,KAAK6nF,QAASjlF,IACrD5C,KAAKgoF,eAAevjF,KAAK7B,GAE3B5C,KAAKooF,WAAWtrD,KAAK,CAAC98B,KAAK2nF,UAAW3nF,KAAK6nF,eAE3C7nF,KAAKooF,WAAWtrD,KAAK98B,KAAKoqE,OAI9B8c,GAAA9nF,UAAAypF,qBAAA,SAAqBxoE,GACnBrgB,KAAK4oF,iBAAiB,CAAC5oF,KAAK2nF,UAAW3nF,KAAK6nF,WAG9CX,GAAA9nF,UAAA0pF,0BAAA,SAA0BzoE,GACxBrgB,KAAK6kD,OAAO/nB,KAAK,CAAC98B,KAAKonF,UAAWpnF,KAAKqnF,WAGzCH,GAAA9nF,UAAA2pF,aAAA,SAAajf,GAQX,OANIA,EACQ,IAAIr5C,KAAKq5C,GAET,IAAIr5C,KAAKzwB,KAAKuqD,MAGX75B,WAGjBw2D,GAAA9nF,UAAA4pF,oBAAA,SAAoB1pE,OACZ2pE,EAAajpF,KAAKkpF,eACtBlpF,KAAKmpF,SAASC,YAAYvuD,cAAcwuD,YAEtCJ,IACFA,EAAWK,YAAchqE,IAI7B4nE,GAAA9nF,UAAA8pF,eAAA,SAAe9/E,GAAf,IACM6/E,EADNt+E,EAAA3K,KAYE,OATAoJ,EAAKyB,QAAO,SAAC3K,GACa,gCAApBA,EAAMm1E,YACR4T,EAAa/oF,GAGa,EAAxBA,EAAMqpF,SAASxmF,SAAekmF,IAChCA,EAAat+E,EAAKu+E,eAAehpF,EAAMmpF,cAExCrpF,MACIipF,GAGT/B,GAAA9nF,UAAAoqF,kBAAA,WACExpF,KAAKO,QAAQkI,SAAWzI,KAAKO,QAAQkI,QAEjCzI,KAAKO,QAAQkI,SAEZzI,KAAK+nF,SACNt3B,GAAgBnE,QAChBtsD,KAAKyF,OAAS+qD,GAAepE,MAE7BpsD,KAAKooF,WAAWtrD,KAAK98B,KAAKoqE,OAG5BpqE,KAAKypF,aACLzpF,KAAKqoF,0BACLroF,KAAK6kD,OAAO/nB,KAAKr1B,aAIrBy/E,GAAA9nF,UAAAsqF,YAAA,SAAYrpE,GACVrgB,KAAK8pE,KAAO,IAAIr5C,KAAKzwB,KAAKuqD,KAC1BvqD,KAAKoqE,KAAOpqE,KAAK8pE,KAAKQ,cAAgB,GAEnCtqE,KAAK+nF,SACNt3B,GAAgBnE,QAChBtsD,KAAKyF,OAAS+qD,GAAepE,KAE7BpsD,KAAKooF,WAAWtrD,KAAK98B,KAAKoqE,OAE1BpqE,KAAK0oF,kBACL1oF,KAAK6kD,OAAO/nB,KAAKr1B,aAIrBy/E,GAAA9nF,UAAAuqF,WAAA,SAAWtpE,GACLrgB,KAAK4pF,SACP5pF,KAAKypF,cAELzpF,KAAK6pF,SAAW,eAChB7pF,KAAK4pF,SAAWluE,YAAW,SACzBouE,OACMC,EACEC,EAAgB,IAAIv5D,KAAKq5D,EAAKnrC,KAEpCorC,EACED,EAAKhgB,OAASriE,UAAYqiF,EAAKv/B,IAAI75B,UAAYo5D,EAAKhgB,KAAKp5C,UAC3Dq5D,GAAoBD,EAAKX,SAASl4B,KAClC64B,EAAKhgB,KAAO,IAAIr5C,KAAKs5D,GAEjBA,EAAmBC,EAAct5D,WACnCo5D,EAAKL,aAGPK,EAAKrB,iBAAiB,CAAEvoF,MAAO4pF,EAAKhgB,KAAMA,KAAMggB,EAAKhgB,QAEvD9pE,KAAKynF,aACLznF,QAKNknF,GAAA9nF,UAAA6qF,SAAA,SAAS5pE,GAELrgB,KAAKoqE,KAAOpqE,KAAKmpF,SAASl4B,KAC1BjxD,KAAK2+C,IAAI2rB,cAAgBtqE,KAAKmpF,SAASl4B,OAEvCjxD,KAAKypF,aACLzpF,KAAK0pF,YAAYrpE,IAEfrgB,KAAK4pF,SACP5pF,KAAKypF,cAELzpF,KAAK6pF,SAAW,eAChB7pF,KAAK4pF,SAAWluE,YAAW,SAEhBouE,GACPA,EAAK1f,KAAO0f,EAAK1f,KAAO0f,EAAKX,SAASl4B,KAClC64B,EAAK1f,KAAO0f,EAAKnrC,IAAI2rB,eACvBwf,EAAKL,aAEPK,EAAK1B,WAAWtrD,KAAKgtD,EAAK1f,OAE5BpqE,KAAKynF,aACLznF,QAKNknF,GAAA9nF,UAAAqqF,WAAA,WACMzpF,KAAK4pF,UACPM,cAAclqF,KAAK4pF,UAErB5pF,KAAK4pF,SAAWniF,UAChBzH,KAAK6pF,SAAW,eAGlB3C,GAAA9nF,UAAA+qF,uBAAA,SAAuB9pE,GACrBrgB,KAAK8pE,KAAO,IAAIr5C,KAAKpQ,EAAMngB,OAC3BF,KAAKgpF,oBAAoBhpF,KAAKoqF,uBAC9BpqF,KAAKyoF,iBAAiBpoE,IAGxB6mE,GAAA9nF,UAAAirF,uBAAA,SAAuBhqE,GACrBrgB,KAAKoqE,KAAO/pD,EAAMngB,MAClBF,KAAKooF,WAAWtrD,KAAK98B,KAAKoqE,OAG5B8c,GAAA9nF,UAAAkrF,kBAAA,WACE,IAA6B,IAAzBtqF,KAAKO,QAAQujC,UAAqB9jC,KAAKuqD,IAAK,KACxCggC,EAAc,IAAI95D,KACxBzwB,KAAK8pE,KAAO9pE,KAAKwqF,eAAeD,GAElC,OAAIvqF,KAAKyF,OAAS+qD,GAAepE,KACxBpsD,KAAKoqE,KAELpqE,KAAK8pE,OAASriE,UAAYzH,KAAKuqD,IAAI75B,UAAY1wB,KAAK8pE,KAAKp5C,WAIpEw2D,GAAA9nF,UAAAgrF,oBAAA,eACM9qE,EAEJ,OAAQtf,KAAKyF,MACX,KAAK+qD,GAAevE,KAClB3sC,EACEtf,KAAK8pE,OAASriE,UACVzH,KAAKuqD,IAAIkgC,eACTzqF,KAAK8pE,KAAK2gB,eAChB,MACF,KAAKj6B,GAAetE,KAClB5sC,EACEtf,KAAK8pE,OAASriE,UACVzH,KAAKuqD,IAAImgC,eACT1qF,KAAK8pE,KAAK4gB,eAChB,MAEF,QACEprE,EACEtf,KAAK8pE,OAASriE,UACVzH,KAAKuqD,IAAI+F,cACTtwD,KAAK8pE,KAAKxZ,cAIpB,OAAOhxC,GAGT4nE,GAAA9nF,UAAAspF,gBAAA,WACM1oF,KAAKuG,QAAUkqD,GAAgBnE,QACjCtsD,KAAKonF,UAAY,IAAI32D,KAAKzwB,KAAK8pE,MAC/B9pE,KAAKonF,UAAUuD,YAAa3qF,KAAKixD,KAAO,KACxCjxD,KAAKqnF,QAAU,IAAI52D,KAAKzwB,KAAKonF,WAC7BpnF,KAAKqnF,QAAQsD,WAAW3qF,KAAKixD,KAAO,OAC1BjxD,KAAK+nF,SAAa/nF,KAAK8pE,MACjC9pE,KAAKqnF,QAAU,IAAI52D,KAAKzwB,KAAK8pE,MAC7B9pE,KAAKonF,UAAY,IAAI32D,KAAKzwB,KAAK8pE,SACtB9pE,KAAK+nF,UAAc/nF,KAAK8pE,MAAS9pE,KAAK8pE,OAKrC9pE,KAAK8pE,OAJf9pE,KAAKonF,UACHpnF,KAAKonF,YAAc3/E,UAAY,IAAIgpB,KAAKzwB,KAAKuqD,KAAOvqD,KAAKonF,UAC3DpnF,KAAKqnF,QACHrnF,KAAKqnF,UAAY5/E,UAAY,IAAIgpB,KAAKzwB,KAAK2+C,KAAO3+C,KAAKqnF,UAS7DH,GAAA9nF,UAAAupF,gBAAA,WACE,OAAQ3oF,KAAKyF,MACX,KAAK+qD,GAAevE,KACdjsD,KAAKonF,YAAc3/E,WAAazH,KAAKqnF,UAAY5/E,YACnDzH,KAAKonF,UAAUwD,SAAS,GACxB5qF,KAAKonF,UAAUyD,WAAW,GAC1B7qF,KAAKonF,UAAUuD,WAAW,GAC1B3qF,KAAKqnF,QAAQuD,SAAS,IACtB5qF,KAAKqnF,QAAQwD,WAAW,IACxB7qF,KAAKqnF,QAAQsD,WAAW,KAE1B,MACF,KAAKn6B,GAAetE,KAClB,GAAIlsD,KAAKuG,QAAUkqD,GAAgBpE,SAAU,CAC3C,GAAIrsD,KAAKonF,UAAU0D,WAAa9qF,KAAKuqD,IAAIugC,SAAU,KAC3CC,EAAe/qF,KAAKonF,UAAU4D,WAC9BC,EAAiBjrF,KAAKonF,UAAU8D,aACtClrF,KAAKonF,UAAYpnF,KAAKuqD,IACtBvqD,KAAKonF,UAAUwD,SAASG,GACxB/qF,KAAKonF,UAAUyD,WAAWI,GAGxBjrF,KAAKqnF,QAAQyD,WAAa9qF,KAAKuqD,IAAIugC,WAC/BC,EAAe/qF,KAAKqnF,QAAQ2D,WAC5BC,EAAiBjrF,KAAKqnF,QAAQ6D,aACpClrF,KAAKqnF,QAAUrnF,KAAKuqD,IACpBvqD,KAAKqnF,QAAQuD,SAASG,GACtB/qF,KAAKqnF,QAAQwD,WAAWI,KAIvBjrF,KAAK+nF,SAAuB,KAAZ/nF,KAAKixD,OACxBjxD,KAAKonF,UAAUyD,WAAW,GAC1B7qF,KAAKonF,UAAUuD,WAAW,GAC1B3qF,KAAKqnF,QAAQwD,WAAW,IACxB7qF,KAAKqnF,QAAQsD,WAAW,OAShCzD,GAAA9nF,UAAA+rF,gBAAA,WACE,OAAOnrF,KAAKonF,YAAc3/E,UAAYzH,KAAKuqD,IAAMvqD,KAAKonF,WAGxDF,GAAA9nF,UAAAgsF,gBAAA,WACE,OAAOprF,KAAKqnF,UAAY5/E,UAAYzH,KAAK2+C,IAAM3+C,KAAKqnF,SAStDH,GAAA9nF,UAAAorF,eAAA,SAAe1gB,EAAMuhB,QAAA,IAAAA,IAAAA,EAAA,QACbC,EAAQ,IAAYD,EAC1B,OAAO,IAAI56D,KAAK7V,KAAKiM,MAAMijD,EAAKp5C,UAAY46D,GAASA,IAQvDpE,GAAA9nF,UAAAooF,kBAAA,SAAkBv2B,GAChB,OAAOs6B,GAAAA,SAAgBt6B,GAAMu6B,uCA3gBhChrF,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,uBACVC,SAAA,wvMATkB+qF,GAAAA,+CAajB3qF,GAAAA,uBAEAA,GAAAA,4BAeAA,GAAAA,sBAuBAs8B,GAAAA,2BACAA,GAAAA,yBAEAyZ,GAAAA,UAASl3C,KAAA,CAAC+rF,GAAAA,cA4dbxE,IAnZE,SAAAA,GAAoByE,GAAA3rF,KAAA2rF,YAAAA,EAhHb3rF,KAAA6d,MAAQ,UASR7d,KAAAkoF,UAA2B,GAC3BloF,KAAAgoF,eAAgC,GAChChoF,KAAAioF,aAA8B,GAsB9BjoF,KAAA6pF,SAAW,cACX7pF,KAAA4rF,UAAY,SAET5rF,KAAA6kD,OAA4C,IAAIrnB,GAAAA,aAE1Dx9B,KAAAooF,WAAsD,IAAI5qD,GAAAA,aA2ExDx9B,KAAK2rF,YAAYE,UAAU,MC1I/B,IAAAC,IAsBEhsF,OAAAC,eAAI+rF,GAAA1sF,UAAA,aAAU,KAAd,WACE,OAAOY,KAAKM,MAAgB,4CAI9BwrF,GAAA1sF,UAAAwpF,iBAAA,SAAiBxe,GACfpqE,KAAK+rF,kBAAkB5hB,aAAanqE,KAAK46D,WAAYwP,IAGvD0hB,GAAA1sF,UAAAqpF,iBAAA,SAAiB3e,GACf9pE,KAAK+rF,kBAAkBliB,aAAa7pE,KAAK46D,WAAYkP,IAG/CgiB,GAAA1sF,UAAAi8B,aAAR,SAAqB3P,GACnB1rB,KAAKM,MAAMyqB,gBAAkBW,EAC7B1rB,KAAK67B,YAAYz3B,MAAMsnB,IAGzBogE,GAAA1sF,UAAA08B,oBAAA,WACO97B,KAAKgsF,kBACRhsF,KAAKq7B,aAAar7B,KAAK67B,YAAY37B,QAIhC4rF,GAAA1sF,UAAA4qB,WAAP,WACEhqB,KAAKM,MAAM+c,SAAU,GAGvByuE,GAAA1sF,UAAA6sF,uBAAA,WACEjsF,KAAKgsF,kBAAoBhsF,KAAKgsF,uCA5CjCxrF,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,uBACVC,SAAA,m8CALOkpE,uCAcN9oE,GAAAA,qBAEAA,GAAAA,SAiCHgrF,IA5BE,SAAAA,GAAoBC,GAAA/rF,KAAA+rF,kBAAAA,EAZb/rF,KAAA6d,MAAQ,UACf7d,KAAA67B,YAAwC,IAAI5Q,GAAAA,iBAAgB,GAE5DjrB,KAAAgsF,kBAA4B,EAEnBhsF,KAAAgnF,QAAkB,EClB7B,IAAAkF,IAeEpsF,OAAAC,eACImsF,GAAA9sF,UAAA,SAAM,KADV,WAEE,OAAOY,KAAKogC,aAEd,SAAWlgC,GACTF,KAAKogC,QAAUlgC,EACfF,KAAK+kE,MAAM0J,sEAZdjuE,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,uBACVC,SAAA,qRACAC,gBAAiBC,GAAAA,wBAAwBC,qDARzCqlE,GAAAA,sDAWCplE,GAAAA,SAWHorF,IADE,SAAAA,GAAoBnnB,GAAA/kE,KAAA+kE,MAAAA,EAFZ/kE,KAAAogC,QAAmB,GCvB7B,IAAA+rD,IAoBEA,GAAA/sF,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KAEEA,KAAKu0B,UAAU5uB,OAAS,GAExB3F,KAAKmlD,SAAWnlD,KAAKgpC,WAAWH,SAAS3N,QAAQvjB,UAAS,SAAChS,GACzDgF,EAAK4pB,UAAU5uB,OAASA,KAI5BwmF,GAAA/sF,UAAAs0B,YAAA,WACE1zB,KAAKmlD,SAASz6B,oCAxBjBkK,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,2EAHHyrF,GAAuB/oF,WAAA,CAAA,CAAAsC,KAU3BovB,GAAAA,cAXI+T,MA6BTujD,IAnBE,SAAAA,GACU53D,EACAyU,GAAAhpC,KAAAgpC,WAAAA,EAERhpC,KAAKu0B,UAAYA,ECjBrB,IAAA63D,IAWSA,GAAAhtF,UAAAitF,aAAP,SAAoBC,EAAKC,EAASC,GAChC,OAAO,IAAIC,IAAQlsE,YAAY+rE,EAAK,CAClCp/E,eAAgBq/E,EAChBp/E,kBAAmBq/E,KAGhBJ,GAAAhtF,UAAAstF,YAAP,SAAmBC,EAAQ3jF,EAAQ4jF,OAC7BC,EAAgBv4C,GAAAA,gBAAuBtrC,EAAQ4jF,EAAYD,GAmB/D,OAlBAE,EAAgB7sF,KAAK8sF,qBAAqBD,EAAeF,EAAQ,GAkB1D,CACLjzB,QAlBc,oBACZ1wD,EAAO,GAAE,IAAIA,EAAO,GAAE,YACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,YACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,YACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,YACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,KAcxB+jF,QAbc,sBACZ/jF,EAAO,GAAE,IAAIA,EAAO,GAAE,YACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,YACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,YACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,YACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,IASxBgkF,eARqB,wBACjBhkF,EAAO,GAAE,IAAIA,EAAO,GAAE,cACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,cACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,cACtBA,EAAO,GAAE,IAAIA,EAAO,GAAE,MAQtBojF,GAAAhtF,UAAA0tF,qBAAR,SAA6BG,EAAiBtkE,EAAYhB,QAAA,IAAAA,IAAAA,EAAA,OAElDggC,EADQzrC,GAAAA,IAAWyM,GACLkwB,WAKpB,OAHgC,IADhB,CAAC,KAAM,IAAK,SAChB7nC,QAAQ22C,KAClBslC,EAAkBjtF,KAAKktF,WAAWD,EAAiBtlE,IAE9CslE,GAGDb,GAAAhtF,UAAA8tF,WAAR,SAAmBC,EAAOxlE,QAAA,IAAAA,IAAAA,EAAA,GAExB,QADIutB,EAAI,EACDA,EAAIi4C,EAAMpqF,QACfoqF,EAAMj4C,GAAKi4C,EAAMj4C,GAAGttB,QAAQD,GAC5ButB,IAEF,OAAOi4C,GAGFf,GAAAhtF,UAAAguF,UAAP,SAAiBC,EAAMV,GACrBU,EAAOA,EAAKn+E,kBAyBNo+E,EAAgB,CACpB,CAAC,IAAK,IAAK,IAAK,KAChB,CAAC,IAAK,IAAK,IAAK,KAChB,CAAC,IAAK,IAAK,IAAK,KAChB,CAAC,IAAK,IAAK,IAAK,MAGZC,EAAe,CACnB,CAAC,KAAM,KAAM,KAAM,MACnB,CAAC,KAAM,KAAM,KAAM,MACnB,CAAC,KAAM,KAAM,KAAM,MACnB,CAAC,KAAM,KAAM,KAAM,OAMjBC,GAAS,EACTC,GAAW,EACXC,GAAU,EAmBd,GAzBqB,2BAQJtkF,KAAKikF,GACpBK,GAAU,EARU,iBAUFtkF,KAAKikF,GACrBI,GAAW,EAVK,YAYArkF,KAAKikF,KACnBG,GAAS,GAKXA,EACFH,GAAQ,MACCI,IACTJ,GAAQ,MAEN,2BAA2BjkF,KAAKikF,GAAO,KAEnCM,EAAON,EAAK5iF,MADF,eAEVmjF,EAASD,EAAK,GACdE,EAAWF,EAAK,GAAG,GACnBG,EAAUH,EAAK,GAAGljF,MAAMojF,GAAU,GACpC1yE,EAAY,EACM,IAAlByyE,EAAO7qF,SACToY,EAAY,OAER4yE,EAASH,EAAOhvB,UAAU,EAAGzjD,GAC7B6yE,EAASJ,EAAOhvB,UAAUzjD,GAO5B8yE,EAAc,EACdC,EAAc,EACdC,EAAa,EACbC,EAAa,EACjBd,EAAcziF,QAAO,SAACC,IACe,IAA/BA,EAAQkG,QAAQ68E,KAClBK,EAAcZ,EAAct8E,QAAQlG,GACpCmjF,EAAcnjF,EAAQkG,QAAQ68E,MAGlCN,EAAa1iF,QAAO,SAACC,IACe,IAA9BA,EAAQkG,QAAQ88E,KAClBM,EAAab,EAAav8E,QAAQlG,GAClCqjF,EAAarjF,EAAQkG,QAAQ88E,UAI7BO,EAAkB,EAClBC,EAAkB,EAClBC,EAAiB,EACjBC,EAAiB,EACjBC,EA3Ba,EA4BbC,EA3Ba,EA4BbjB,GACFY,EA5BiB,EA4BCJ,EAClBK,EA5BiB,EA4BCJ,EAElBM,EADAD,EAAiB,EAEjBE,EAhCiB,EAiCjBC,EAhCiB,GAiCRhB,IACTW,EAnCiB,EAmCCJ,EAClBK,EAnCiB,EAmCCJ,EAClBK,EAnCgB,GAmCCJ,EACjBK,EAnCgB,IAmCCJ,EACjBK,EArCgB,GAsChBC,EArCgB,SAwCZhnE,EAAkD,CACtDinE,GAAI,CAvHG,CACTC,EAAG,CAAE50D,MAAO,GAAIqkB,IAAK,IACrBwwC,EAAG,CAAE70D,MAAO,GAAIqkB,IAAK,IACrBywC,EAAG,CAAE90D,MAAO,GAAIqkB,IAAK,IACrB0wC,EAAG,CAAE/0D,MAAO,GAAIqkB,IAAK,IACrB2wC,EAAG,CAAEh1D,MAAO,GAAIqkB,IAAK,IACrB4wC,EAAG,CAAEj1D,MAAO,GAAIqkB,IAAK,KACrB6wC,EAAG,CAAEl1D,MAAO,IAAKqkB,IAAK,KACtB8wC,EAAG,CAAEn1D,MAAO,IAAKqkB,IAAK,KACtB+wC,EAAG,CAAEp1D,MAAO,IAAKqkB,IAAK,KACtBgxC,GAAI,CAAEr1D,MAAO,IAAKqkB,IAAK,MA8GhB0vC,GAAQ1vC,GAAKgwC,EAAkBE,EA5G7B,CACTK,EAAG,CAAE50D,KAAM,GAAIqkB,GAAI,IACnBwwC,EAAG,CAAE70D,KAAM,GAAIqkB,GAAI,IACnBywC,EAAG,CAAE90D,KAAM,GAAIqkB,GAAI,IACnB0wC,EAAG,CAAE/0D,KAAM,GAAIqkB,GAAI,IACnB2wC,EAAG,CAAEh1D,KAAM,GAAIqkB,GAAI,IACnB4wC,EAAG,CAAEj1D,KAAM,GAAIqkB,GAAI,IACnB6wC,EAAG,CAAEl1D,KAAM,GAAIqkB,GAAI,IACnB8wC,EAAG,CAAEn1D,KAAM,GAAIqkB,GAAI,IACnB+wC,EAAG,CAAEp1D,KAAM,GAAIqkB,IAAK,MAoGb2vC,GAAQ3vC,GAAKiwC,EAAkBE,IAoEtC,OAhEA9mE,EAAM4nE,GAAK,CACT5nE,EAAMinE,GAAG,GAAKF,EACd/mE,EAAMinE,GAAG,GAAKD,GAEhBhnE,EAAM6nE,GAAK,CAAC7nE,EAAMinE,GAAG,GAAIjnE,EAAMinE,GAAG,GAAKD,GACvChnE,EAAM8nE,GAAK,CAAC9nE,EAAMinE,GAAG,GAAKF,EAAe/mE,EAAMinE,GAAG,IAElDjnE,EAAMinE,GAAK3oE,GAAAA,UACT,CAAC0B,EAAMinE,GAAG,GAAIjnE,EAAMinE,GAAG,IACvB,YACAhC,GAEFjlE,EAAM4nE,GAAKtpE,GAAAA,UACT,CAAC0B,EAAM4nE,GAAG,GAAI5nE,EAAM4nE,GAAG,IACvB,YACA3C,GAEFjlE,EAAM6nE,GAAKvpE,GAAAA,UACT,CAAC0B,EAAM6nE,GAAG,GAAI7nE,EAAM6nE,GAAG,IACvB,YACA5C,GAEFjlE,EAAM8nE,GAAKxpE,GAAAA,UACT,CAAC0B,EAAM8nE,GAAG,GAAI9nE,EAAM8nE,GAAG,IACvB,YACA7C,GAIFjlE,EAAMinE,GAAK3uF,KAAK8sF,qBAAqBplE,EAAMinE,GAAIhC,EAAQ,GACvDjlE,EAAM4nE,GAAKtvF,KAAK8sF,qBAAqBplE,EAAM4nE,GAAI3C,EAAQ,GACvDjlE,EAAM6nE,GAAKvvF,KAAK8sF,qBAAqBplE,EAAM6nE,GAAI5C,EAAQ,GACvDjlE,EAAM8nE,GAAKxvF,KAAK8sF,qBAAqBplE,EAAM8nE,GAAI7C,EAAQ,GAgChD,CACLjzB,QA9BA,YACA,CACEhyC,EAAMinE,GAAGllF,KAAK,KACdie,EAAM6nE,GAAG9lF,KAAK,KACdie,EAAM4nE,GAAG7lF,KAAK,KACdie,EAAM8nE,GAAG/lF,KAAK,KACdie,EAAMinE,GAAGllF,KAAK,MACdA,KAAK,KACP,KAuBAsjF,QArBA,cACA,CACErlE,EAAMinE,GAAGllF,KAAK,KACdie,EAAM6nE,GAAG9lF,KAAK,KACdie,EAAM4nE,GAAG7lF,KAAK,KACdie,EAAM8nE,GAAG/lF,KAAK,KACdie,EAAMinE,GAAGllF,KAAK,MACdA,KAAK,KACP,IAcAujF,eAXA,cACA,CACEtlE,EAAMinE,GAAGllF,KAAK,KACdie,EAAM6nE,GAAG9lF,KAAK,KACdie,EAAM4nE,GAAG7lF,KAAK,KACdie,EAAM8nE,GAAG/lF,KAAK,MACdA,KAAK,KACP,4BAzPP/J,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,6JAGZ,SAAAwsF,MCTF,IAAAqD,IA4CE3vF,OAAAC,eACI0vF,GAAArwF,UAAA,gBAAa,KAGjB,WACE,OAAOY,KAAK0vF,eAAexvF,WAL7B,SACkByvF,GAChB3vF,KAAK0vF,eAAetrF,KAAKurF,oCAQ3B7vF,OAAAC,eAAI0vF,GAAArwF,UAAA,gBAAa,KAAjB,WACE,OAAOY,KAAK46D,WAAWr6D,QAAQ2R,WAAWm5D,oBAAoBrhE,OAAM,SAClEiG,GAAK,OAAa,IAAbA,EAAEC,0CAwBXu/E,GAAArwF,UAAAi0B,SAAA,WACErzB,KAAK4vF,eAGPH,GAAArwF,UAAAwwF,YAAA,WAAA,IAAAjlF,EAAA3K,KACE,GAAKA,KAAK46D,WAAWr6D,QAAQyU,aAA7B,KAGMvG,EAASzO,KAAK46D,WAAWr6D,QAAQyU,aACpChL,OAAM,SAAC+N,GAAM,OAACA,EAAG83E,wBAA0BpoF,YAAcsQ,EAAG83E,wBAC/DphF,EAAOzE,OAAM,SAACiG,GAAK,OAAAA,EAAEjB,OAASrE,EAAKglF,cAAcrkF,eAC9CT,QAAO,SAACC,GACPH,EAAKmN,OAAShN,EAAQgN,SAAWrQ,UAAYqD,EAAQgN,OAAOopB,OAAS,KAGzElhC,KAAK8vF,QAAQ1rF,KAAKqK,OACZE,GAAmB,IAAIxG,IAAkBqG,wBAC7CC,EACAzO,KAAK2vF,cAAcrkF,aACnBtL,KAAK46D,WAAWr6D,QAAQ2R,WAAWjD,sBACrCjP,KAAK+vF,oBAAoB3rF,KAAKuK,IACqD,IAA/E7O,OAAOk4B,KAAKrpB,GAAkBqC,QAAQhR,KAAK0vF,eAAexvF,MAAM8K,YAClEhL,KAAK0vF,eAAexvF,MAAM8K,SAAWlL,OAAOk4B,KAAKrpB,GAAkB,IAErE3O,KAAKgwF,mBAGPP,GAAArwF,UAAAoqF,kBAAA,SAAkBnpE,EAAOrW,EAAmCsP,GAC1DtZ,KAAK4vF,cACDvvE,EAAM4vE,QACRjwF,KAAK46D,WAAWr6D,QAAQ2R,WAAWm5D,oBAChCrhE,OAAM,SAACiG,GAAK,OAAAA,EAAEE,WAAanG,EAAOmG,WAClCtF,QAAO,SAACC,GACPA,EAAQwO,IAAY,KAGxBtZ,KAAKkwF,kBAAkBlmF,EAAOmG,UAC9BnQ,KAAK46D,WAAWr6D,QAAQ2R,WAAWm5D,oBAChCrhE,OAAM,SAACiG,GAAK,OAAAA,EAAEE,WAAanG,EAAOmG,WAClCtF,QAAO,SAACC,GACPA,EAAQwO,IAAY,KAG1BtZ,KAAKgwF,kBAGPP,GAAArwF,UAAA+wF,aAAA,SAAanmF,OACLkI,EAAgClS,KAAK46D,WAAWr6D,QAAQ2R,WAC9DA,EAAWm5D,oBAAsBn5D,EAAWm5D,oBAAoBrhE,OAAM,SACpEiG,GAAK,OAAAA,EAAEE,WAAanG,EAAOmG,WAE7BnQ,KAAKkwF,kBAAkBlmF,EAAOmG,UAE9BnQ,KAAKgwF,kBAGPP,GAAArwF,UAAAgxF,sBAAA,SAAsBpmF,EAAmCsP,EAAUpZ,GACjEF,KAAKqwF,eAAermF,EAAQsP,EAAUyL,WAAW7kB,IACjDF,KAAKgwF,kBAGCP,GAAArwF,UAAA8wF,kBAAR,SAA0BrpF,OAClBypF,EAAYtwF,KAAKuwF,gBAAkB1pF,EACrC7G,KAAKwS,IAAI2pC,QAAQlzB,WAAWniB,GAAG2Z,eAAe6vE,IAChDtwF,KAAKwS,IAAI2pC,QAAQlzB,WAAWniB,GAAG6Z,cAC7B3gB,KAAKwS,IAAI2pC,QAAQlzB,WAAWniB,GAAG2Z,eAAe6vE,KAKpDb,GAAArwF,UAAAoxF,eAAA,SAAexmF,IACmD,IAA5DhK,KAAK+vF,oBAAoB7vF,MAAM8J,EAAOgB,UAAUqE,SAClDrP,KAAKkwF,kBAAkBlmF,EAAOmG,UAEhCnQ,KAAKgwF,kBAKPP,GAAArwF,UAAAqxF,oBAAA,SAAoB/kF,GAClB1L,KAAK2vF,cAAcjkF,UAAYA,EAAUukF,QACzCjwF,KAAKgwF,kBAGPP,GAAArwF,UAAAixF,eAAA,SAAermF,EAAmCsP,EAAUpZ,GAC1DF,KAAK46D,WAAWr6D,QAAQ2R,WAAWm5D,oBAChCrhE,OAAM,SAACiG,GAAK,OAAAA,EAAEE,WAAanG,EAAOmG,WAClCtF,QAAO,SAACC,GACPA,EAAQwO,GAAYpZ,IAExBF,KAAKgwF,kBAGPP,GAAArwF,UAAAsxF,eAAA,SAAe1mF,EAAQ9J,GAAvB,IAAAyK,EAAA3K,KACQ2wF,EAAe,2BACfC,EAAgB,iBAChBC,EAAc,YACd9uE,EAAgB/hB,KAAKwS,IAAImW,WAC/B3oB,KAAKkwF,kBAAkBlmF,EAAOmG,UAC9BnQ,KAAK46D,WAAWr6D,QAAQ2R,WAAWm5D,oBAChCrhE,OAAM,SAACiG,GAAK,OAAAA,EAAEE,WAAanG,EAAOmG,WAClCtF,QAAO,SAACC,OACH4uD,EAC8B,SAA9B1vD,EAAOoG,mBACK,KAAVlQ,GAA8B,KAAdyK,EAAK0iF,MACvB3zB,EAAU/uD,EAAKmmF,WAAW1D,UAAUziF,EAAK0iF,KAAM1iF,EAAK6H,IAAImW,YAAY+wC,QACpE5uD,EAAQ0B,aAAektD,GAEb,KAAVx5D,IACC2wF,EAAYznF,KAAKlJ,IAChB0wF,EAAcxnF,KAAKlJ,IACnBywF,EAAavnF,KAAKlJ,MAEpBw5D,EAAU/uD,EAAKmmF,WAAW1D,UAAUltF,EAAOyK,EAAK6H,IAAImW,YAAY+wC,QAChE5uD,EAAQ0B,aAAektD,GAEc,gBAA9B1vD,EAAOoG,qBAChBspD,EAAU/uD,EAAKmmF,WAAWpE,YACxB3qE,EACApX,EAAK6H,IAAIgY,eAAerO,YACxB4F,GACA23C,QACF5uD,EAAQ0B,aAAektD,KAG7B15D,KAAKgwF,uCA3LRxvF,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,+meARO0rF,+CA0BNtrF,GAAAA,0BAEAA,GAAAA,mBAEAA,GAAAA,6BAEAA,GAAAA,0BAQAA,GAAAA,SA2JH2uF,IAnJE,SAAAA,GACUqB,GAAA9wF,KAAA8wF,WAAAA,EApCH9wF,KAAA+vF,oBAAsB,IAAI9kE,GAAAA,gBAAwCxjB,WAElEzH,KAAAE,MAAQ,GAGRF,KAAA8vF,QAAU,IAAI7kE,GAAAA,gBAA6C,IAE3DjrB,KAAA6d,MAAQ,UACR7d,KAAAqtF,KAAO,GAEPrtF,KAAAuwF,gBAAkB,oBAClBvwF,KAAA0vF,eAAiB,IAAIzkE,GAAAA,gBAAqBxjB,WAgBxCzH,KAAA0oC,WAA6B,QAepC1oC,KAAK+wF,uBAAwB,IAAI5oF,IAAkBgH,UACnDnP,KAAK+vF,oBAAoB3rF,KAAKpE,KAAK+wF,uBACnC/wF,KAAKgxF,oBAAsB,CACzB,CACEvrF,KAAM,eAER,CACEA,KAAM,SC1Ed,IAAAwrF,IAgBEnxF,OAAAC,eAAIkxF,GAAA7xF,UAAA,cAAW,KAAf,WACE,OAAOY,KAAKgwF,gDAGdlwF,OAAAC,eAAIkxF,GAAA7xF,UAAA,qBAAkB,KAAtB,WACE,GAAIY,KAAK46D,WAAWr6D,QAAQ2R,WAC1B,OAAOlS,KAAK46D,WAAWr6D,QAAQ2R,WAAWtJ,yEAlB/CpI,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,0BACVC,SAAA,+xBAICI,GAAAA,mBAEAA,GAAAA,8BAEAA,GAAAA,SAgBHmwF,IADE,SAAAA,KAFOjxF,KAAA6d,MAAQ,UC3BjB,IAAAqzE,IAwCEpxF,OAAAC,eAAImxF,GAAA9xF,UAAA,cAAW,KAAf,WACE,OAAOY,KAAKgwF,eAAepxE,KAAK5e,uCAGlCF,OAAAC,eAAImxF,GAAA9xF,UAAA,aAAU,KAAd,WACE,OAAOY,KAAKM,MAAgB,4CAG9BR,OAAAC,eAAImxF,GAAA9xF,UAAA,eAAY,KAAhB,WACE,OAAQY,KAAK46D,WAAkB,QAASzjD,0CAU1C+5E,GAAA9xF,UAAAi0B,SAAA,eACQnhB,EAAalS,KAAK46D,WAAWr6D,QAAQ2R,WAQ3C,OAPIA,EAAWrJ,aAAuD,EAAxCqJ,EAAWrJ,YAAY4I,QAAQ1O,SACvDmP,EAAWtJ,qBAAuBnB,YACpCyK,EAAWtJ,oBAAqB,GAElC5I,KAAKmxF,eAAgB,GAGfnxF,KAAK46D,WAAWr6D,QAAQkF,MAC9B,IAAK,MACHzF,KAAKoxF,iBAAiB9lB,wBAAwBtrE,KAAK46D,YACnD,MACF,IAAK,MACH56D,KAAKoxF,iBAAiBlmB,wBAAwBlrE,KAAK46D,YAMnD1oD,IACEA,EAAWm5D,sBACbrrE,KAAKqxF,iBAAmBhoF,KAAKo1B,MAC3Bp1B,KAAKC,UAAU4I,EAAWm5D,sBAG2C,GAArEn5D,EAAWm5D,oBAAoBrhE,OAAM,SAACiG,GAAK,OAAAA,EAAEzD,eAAczJ,SAE3D/C,KAAKsxF,wBAAyB,IAIlCtxF,KAAKuxF,qBAAqBr/E,EAAWxJ,UACjCwJ,EAAWxJ,WAKnBwoF,GAAA9xF,UAAAoyF,oBAAA,WACExxF,KAAKgsF,kBAAmB,MAWpB1jF,EAREi5D,EAFmDvhE,KAAK46D,WAC3Dr6D,QAAQ2R,WAAWm5D,qBACa,GAC7BomB,EAA2B,IAAflwB,EAAIx+D,OAAe,EAAIw+D,EAAIA,EAAIx+D,OAAS,GAAGsL,MACzDqjF,EAAiB,GACfC,EAAiB3xF,KAAK46D,WAAWr6D,QAAQyU,aAAahL,OAAM,SAACiG,GAAK,OAACA,EAAE4/E,wBAC/C,EAAxB8B,EAAe5uF,SACjB2uF,EACEC,EAAe,GAAG3iF,OAASvH,UAAY,GAAKkqF,EAAe,GAAG3iF,UAG5D4iF,EAAoB5xF,KAAK46D,WACrB,QACNg3B,EAAkBtpF,kBACpBA,EAAoBspF,EAAkBtpF,kBAErCtI,KAAK46D,WAAkB,QAASrmD,WAChCvU,KAAK46D,WAAkB,QAASrmD,UAAUjM,oBAE3CA,EAAqBtI,KAAK46D,WAAkB,QAASrmD,UAClDjM,uBAECiI,EAAwB,IAAfgxD,EAAIx+D,OACb4L,EAAmB3O,KAAK6W,gBAAgBrI,wBAC5CxO,KAAK46D,WAAWr6D,QAAQyU,aACxB08E,EACA1xF,KAAK46D,WAAWr6D,QAAQ2R,WAAWjD,sBAC/B4iF,EAAoB/xF,OAAOk4B,KAAKrpB,GAAkB,GAExD4yD,EAAI98D,KACFzE,KAAK6W,gBAAgBtI,mBAAkB,CAEnCjD,aAAcomF,EACd1mF,SAAU6mF,EACV3hF,OAAQK,EACRH,mBAAoB,cACpBxG,QAAS5J,KAAKwS,IAAImW,YAEpBrgB,EACAmpF,EACAzxF,KAAK8xF,uBAGT9xF,KAAK46D,WAAWr6D,QAAQ2R,WAAWm5D,oBAAsB9J,GAG3D2vB,GAAA9xF,UAAAgvE,aAAA,WACEpuE,KAAKquE,gBAAgBhvE,KAAKW,KAAKM,QAGjC4wF,GAAA9xF,UAAA4wF,eAAA,SAAe+B,IACC,IAAVA,IACF/xF,KAAKqxF,iBAAmB5pF,eAEpByK,EAAgClS,KAAK46D,WAAWr6D,QAAQ2R,WACxD8/E,EAAgB9/E,EAAWm5D,oBAAoBrhE,OAAM,SACzDiG,GAAK,OAAa,IAAbA,EAAEC,SAmBT,GAjB6B,IAAzB8hF,EAAcjvF,SAChBmP,EAAWnJ,QAAUtB,UACrByK,EAAWq5D,UAAW,GAEG,EAAvBymB,EAAcjvF,SAChBivF,EAAc,GAAGhiF,cAAgBgiF,EAAc,GAAGhiF,eAKrC,IAFbgiF,EAAchoF,OAAM,SAClBioF,GAAM,OAA+D,IAA/D,CAAC,WAAY,aAAc,UAAUjhF,QAAQihF,EAAGjnF,YACtDjI,OAEF/C,KAAKsxF,wBAAyB,EAE9BtxF,KAAKsxF,wBAAyB,EAI5BjoF,KAAKC,UAAUtJ,KAAKqxF,oBAAsBhoF,KAAKC,UAAU0oF,GAC3D,CACA,GAA2C,QAAvChyF,KAAKM,MAAM2oB,WAAW1oB,QAAQkF,MAE1BysF,EADqBlyF,KAAKM,MAAM2oB,WACY1oB,QAAQ2R,YACjDnJ,QAAU/I,KAAK6W,gBAAgBrG,sCACtCwhF,GAEFhyF,KAAKM,MAAM2oB,WAAWniB,GAAG+Z,aACpB,GACkC,QAAvC7gB,KAAKM,MAAM2oB,WAAW1oB,QAAQkF,MAC9ByM,EAAWzJ,QACX,KAIQypF,EAHJC,EAAgB,GACQ,GAAxBH,EAAcjvF,UAEVmvF,EADqBlyF,KAAKM,MAAM2oB,WACY1oB,QAAQ2R,YACjDnJ,QAAU/I,KAAK6W,gBAAgBrG,sCACtCwhF,GAEFG,EAAgBnyF,KAAK6W,gBAAgB/N,YACnCopF,EAASnpF,QACTtB,UACAA,UACCzH,KAAKM,MAAM2oB,WAAkB,QAAS3gB,oBAG3CtI,KAAKoxF,iBAAiBpmB,YACpBhrE,KAAe,WACfmyF,GAEFnyF,KAAK46D,WAAWr6D,QAAQ2R,WAAWq5D,SACR,IAAzBymB,EAAcjvF,OAGlB/C,KAAKqxF,iBAAmBhoF,KAAKo1B,MAAMp1B,KAAKC,UAAU0oF,MAM/Cd,GAAA9xF,UAAA4qB,WAAP,WACEhqB,KAAKM,MAAM+c,SAAU,GAGhB6zE,GAAA9xF,UAAAgzF,qBAAP,WACE,OAAOpyF,KAAK46D,WAAWr6D,QAAQ2R,WAAWtJ,oBAGrCsoF,GAAA9xF,UAAAizF,kBAAP,WACE,OACGryF,KAAK46D,WAAWr6D,QAAQyU,cACuB,IAAhDhV,KAAK46D,WAAWr6D,QAAQyU,aAAajS,QAIjCmuF,GAAA9xF,UAAAkzF,mCAAR,SAA2CpyF,GACzCF,KAAK46D,WAAWr6D,QAAQ2R,WAAWtJ,mBAAqB1I,GAG1DgxF,GAAA9xF,UAAAmzF,oBAAA,SAAoBH,GAClBpyF,KAAKsyF,mCAAmCF,EAAqBnC,SACzDmC,EAAqBnC,SACvBjwF,KAAKgwF,gBAAe,IAIhBkB,GAAA9xF,UAAAi8B,aAAR,SAAqB3P,GACnB1rB,KAAKM,MAAMyqB,gBAAkBW,EAC7B1rB,KAAK67B,YAAYz3B,MAAMsnB,IAGzBwlE,GAAA9xF,UAAA08B,oBAAA,WACO97B,KAAKgsF,kBACRhsF,KAAKq7B,aAAar7B,KAAK67B,YAAY37B,QAIvCgxF,GAAA9xF,UAAA6sF,uBAAA,WACEjsF,KAAKgsF,kBAAoBhsF,KAAKgsF,uCA7OjCxrF,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,0BACVC,SAAA,k8EAPOqqE,UATA+C,sCA+BNhtE,GAAAA,mBAEAA,GAAAA,sBAEAA,GAAAA,SA0NHowF,IA5ME,SAAAA,GACUE,EACA/iB,GADAruE,KAAAoxF,iBAAAA,EACApxF,KAAAquE,gBAAAA,EA/BHruE,KAAA6d,MAAQ,UAEP7d,KAAA8xF,qBAAuB,MACxB9xF,KAAAsxF,wBAAyB,EACzBtxF,KAAAuxF,oBAAqB,EACrBvxF,KAAAgsF,kBAAmB,EACnBhsF,KAAAmxF,eAAyB,EAChCnxF,KAAA67B,YAAwC,IAAI5Q,GAAAA,iBAAgB,GAQnDjrB,KAAAgnF,QAAkB,EAkBzBhnF,KAAK6W,gBAAkB,IAAI1O,GCxD/B,IAAAqqF,yBASChyF,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,0BACVC,SAAA,qTACAC,gBAAiBC,GAAAA,wBAAwBC,mFAIxCC,GAAAA,mBAEAA,GAAAA,SAGH0xF,IADE,SAAAA,MCpBF,IAAAC,IAoBEA,GAAArzF,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KAEEA,KAAKu0B,UAAU5uB,OAAS,GAExB3F,KAAKmlD,SAAWnlD,KAAKgpC,WAAWH,SAAS3N,QAAQvjB,UAAS,SAAChS,GACzDgF,EAAK4pB,UAAU5uB,OAASA,KAI5B8sF,GAAArzF,UAAAs0B,YAAA,WACE1zB,KAAKmlD,SAASz6B,oCAxBjBkK,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,8EAHH+xF,GAA0BrvF,WAAA,CAAA,CAAAsC,KAU9BovB,GAAAA,cAXI+T,MA6BT6pD,IAnBE,SAAAA,GACUl+D,EACAyU,GAAAhpC,KAAAgpC,WAAAA,EAERhpC,KAAKu0B,UAAYA,ECjBrB,IAAAm+D,IAgBE5yF,OAAAC,eAAI2yF,GAAAtzF,UAAA,QAAK,KAAT,eACQ4K,EAAShK,KAAKO,QAAkB,WACtC,IAAIyJ,GAAWA,EAAOpB,mBAYf,OAAIoB,GAAUA,EAAOjB,UAAYiB,EAAOjB,QAAQA,QAC9C,EACEiB,GAAUA,EAAOjB,SAAWiB,EAAOjB,QAAQA,QAC7CiB,EAAOjB,QAAQA,QAAQhG,YADzB,EAbL,GAAIiH,EAAOnB,YAAa,KAEhB8pF,EADc3oF,EAAkB,YACKoH,OAAOtC,KAAI,SAAC8jF,GAAM,OAAAA,EAAGnqF,UAC5DoqF,EAAiB,EAIrB,OAHIF,GACFA,EAAuBphF,gBAAgBiB,IAAG,SAACsgF,GAAM,OAAAD,GAAkBC,EAAGngF,QAAQ3I,OAAM,SAAC+oF,GAAU,OAAAA,EAAOtqF,UAAS1F,SAEzF,EAAjB8vF,EAAqBA,EAAiBprF,4CAWnD3H,OAAAC,eACI2yF,GAAAtzF,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKC,YAEd,SAAUC,IACRF,KAAKC,OAASC,KAEZF,KAAKO,QAAUP,KAAKM,MAAM2oB,WAAkB,0CAehDypE,GAAAtzF,UAAAi0B,SAAA,WACErzB,KAAKO,QAAUP,KAAKM,MAAM2oB,WAAkB,8BAtD/CzoB,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,wBACVC,SAAA,k3BAEAC,gBAAiBC,GAAAA,wBAAwBC,8FA2BxCC,GAAAA,mBAYAA,GAAAA,qBAEAA,GAAAA,sBAEAA,GAAAA,SASH4xF,IALE,SAAAA,KANS1yF,KAAA6d,MAAgB,UAIlB7d,KAAAgzF,mBAAoB,ECvD7B,IAAAC,IA0CEA,GAAA7zF,UAAA8zF,qBAAA,WACE,OAAOlzF,KAAK46D,WAAWr6D,QAAQ2R,WAAWrJ,YAAYuI,QAGxD6hF,GAAA7zF,UAAAi0B,SAAA,WACMrzB,KAAK46D,WAAWr6D,QAAQ2R,YAC1BlS,KAAK46D,WAAWr6D,QAAQ2R,WAAWrJ,cACnC7I,KAAK2yF,uBACH3yF,KAAK46D,WAAWr6D,QAAQ2R,WAAWrJ,YAAYuI,OAAOtC,KAAI,SAACwD,GAAK,OAAAA,EAAE7J,WAClEzI,KAAK46D,WAAWr6D,QAAQ2R,WAAWrJ,YAAYuI,OAAO,IAE1DpR,KAAKmzF,gBAGPF,GAAA7zF,UAAAg0F,WAAA,SAAW5hF,OACL6hF,EAQJ,OAPI7hF,EAAGyqB,UAEHo3D,EADEpxF,MAAM2uD,QAAQp/C,EAAGyqB,SACdzqB,EAAGyqB,QAAQxyB,KAAK,MAEhB+H,EAAGyqB,SAGLo3D,GAAM,IAGfJ,GAAA7zF,UAAAk0F,eAAA,SAAe9hF,OAETmsB,EAOJ,OANInsB,EAAGqM,QACL8f,EAAS,CACP41D,mBAAoB/hF,EAAG/I,QAAU,QAAQ+I,EAAGqM,MAAK,IAAM,wBAIpD8f,GAGTs1D,GAAA7zF,UAAAo0F,iBAAA,SAAiB9hF,GACf,QAAOA,EAAO+hF,UAAW/hF,EAAO+hF,UAGlCR,GAAA7zF,UAAAs0F,cAAA,WAAA,IAAA/oF,EAAA3K,KAEEA,KAAKkzF,uBAAuB1gF,IAAG,SAACF,GAAK,OAAAA,EAAE7J,SAAU,IACjDzI,KAAKkzF,uBAAuBpkF,KAAI,SAACwD,GAAK,OAAAA,IAAM3H,EAAKgoF,yBAAwBlqF,SAAU,EACnFzI,KAAKmzF,gBAGPF,GAAA7zF,UAAA+zF,aAAA,SAAaQ,GACPA,IACFA,EAAqBlrF,SAAWkrF,EAAqBlrF,aAEnDsK,EAAoB,GAClB6gF,EAAa,GACnB5zF,KAAK2yF,uBAAuBphF,gBAAgBiB,IAAG,SAACC,OACxCC,EAAkB,GACxBD,EAAaE,QACZ3I,OAAM,SAAC4I,GAAS,OAAkB,IAAlBA,EAAMnK,UACtBoC,QAAO,SAACgI,GAAa,OAAAH,EAAgBjO,KAAKoO,EAAU9J,WACvB,GAA1B2J,EAAgB3P,SACa,IAA3B2P,EAAgB3P,OAClB6wF,EAAWnvF,KAAKiO,EAAgB,IAEhCkhF,EAAWnvF,KAAK,CAACwG,QAASwH,EAAaxH,QAASlC,QAAS2J,OAItC,GAArBkhF,EAAW7wF,SACbgQ,EAAoB/S,KAAK6W,gBACtB/N,YAAkC,IAAtB8qF,EAAW7wF,OACtB6wF,EAAW,GAAE,CAAI3oF,QAAS,MAAOlC,QAAS6qF,KAEX,QAAjC5zF,KAAK46D,WAAWr6D,QAAQkF,MAC1BzF,KAAKoxF,iBAAiBpmB,YAAYhrE,KAAe,WAAmB+S,GAEjC,QAAjC/S,KAAK46D,WAAWr6D,QAAQkF,MAE1BzF,KAAK46D,WAAW9zD,GAAG+Z,8BArGxBrgB,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,+BACVC,SAAA,86CALOqqE,+CAUNjqE,GAAAA,0BAEAA,GAAAA,mBAEAA,GAAAA,SA6FHmyF,IAvFE,SAAAA,GACU7B,GAAApxF,KAAAoxF,iBAAAA,EAJHpxF,KAAA6d,MAAQ,UAMb7d,KAAK6W,gBAAkB,IAAI1O,GCvB/B,IAAA0rF,IAQE/zF,OAAAC,eACI8zF,GAAAz0F,UAAA,QAAK,KADT,WAEE,OAAOY,KAAK8zF,YAEd,SAAU/oD,GACR/qC,KAAK8zF,OAAS/oD,mCA6BhB8oD,GAAAz0F,UAAAi0B,SAAA,WACuC,IAAjCrzB,KAAK+zF,kBAAkB7zF,QACzBF,KAAKyF,KAAOzF,KAAKg0F,YAAYxoB,YAEM,IAAjCxrE,KAAK+zF,kBAAkB7zF,QACzBF,KAAKyF,KAAOzF,KAAKi0F,gBAEnBj0F,KAAKk0F,UAAUp3D,KAAK98B,KAAKyF,OAG3BouF,GAAAz0F,UAAA+0F,aAAA,SAAa9zE,GAC0B,IAAjCrgB,KAAK+zF,kBAAkB7zF,QACzBF,KAAKyF,KAAO2uF,GAAkB5oB,YAEK,IAAjCxrE,KAAK+zF,kBAAkB7zF,QACzBF,KAAKyF,KAAOzF,KAAKi0F,gBAEnBj0F,KAAKk0F,UAAUp3D,KAAK98B,KAAKyF,OAG3BouF,GAAAz0F,UAAAi1F,kBAAA,SAAkBh0E,GAChBrgB,KAAKs0F,eAAex3D,KAAK98B,KAAKu0F,oBAGhCV,GAAAz0F,UAAAo1F,aAAA,SAAanvF,GACXrF,KAAKy0F,WAAW33D,KAAKz3B,IAGvBwuF,GAAAz0F,UAAAs1F,iBAAA,SAAiBV,GACfh0F,KAAKi0F,eAAiBD,EACtBh0F,KAAKk0F,UAAUp3D,KAAK98B,KAAKi0F,sCAxE5BzzF,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,0BACVC,SAAA,kpDAEAC,gBAAiBC,GAAAA,wBAAwBC,gfAIxCC,GAAAA,iCAoBAA,GAAAA,oBAEAA,GAAAA,yBAIAs8B,GAAAA,+BAEAA,GAAAA,2BAEAA,GAAAA,UAoCHy2D,IAlCE,SAAAA,KAvBO7zF,KAAA20F,UAAsB,CAAC,SAAU,UAAW,WAAY,SAAU,MAAO,MAAO,YAAa,WAC7F30F,KAAA+zF,kBAAoB,IAAIa,GAAAA,YAAY,GAMpC50F,KAAAg0F,YAAcI,GAEdp0F,KAAAi0F,eAAoCj0F,KAAKg0F,YAAYvoB,QAQlDzrE,KAAAk0F,UAAY,IAAI12D,GAAAA,aAEhBx9B,KAAAs0F,eAAiB,IAAI92D,GAAAA,aAErBx9B,KAAAy0F,WAAa,IAAIj3D,GAAAA,qBC9B3B19B,OAAAC,eACI80F,GAAAz1F,UAAA,QAAK,KADT,WAEE,OAAOY,KAAK8zF,YAEd,SAAU/oD,GACR/qC,KAAK8zF,OAAS/oD,mCAIhBjrC,OAAAC,eACI80F,GAAAz1F,UAAA,YAAS,KADb,WAEE,OAAOY,KAAK80F,gBAEd,SAAcH,GACZ30F,KAAK2vE,YAAYolB,SAAS,IAC1B/0F,KAAK80F,WAAaH,mCAYpBE,GAAAz1F,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKg1F,mBAAqBh1F,KAAK2vE,YAAYE,aAAal4D,UAAS,SAAEzX,GAC7DA,EAAM6C,QACR4H,EAAKogC,MAAMa,KAAK5hC,OAAM,SAAE3E,OAChB4vF,EAAmB/0F,EAAMgP,cAAcowB,UAAU,OAAOvxB,QAAQ,mBAAoB,IAE1F,OAD8B1I,EAAQ+O,WAAW6oD,IAAI/tD,cAAcowB,UAAU,OAAOvxB,QAAQ,mBAAoB,IACnFgE,SAASkjF,QAM9CJ,GAAAz1F,UAAAs0B,YAAA,WACE1zB,KAAKg1F,mBAAmBtqE,eAG1BmqE,GAAAz1F,UAAA81F,UAAA,SAAU7vF,GACR,OAAOA,EAAUA,EAAQ+O,WAAW6oD,IAAMx1D,WAK5CotF,GAAAz1F,UAAAo1F,aAAA,SAAanvF,GAAb,IAAAsF,EAAA3K,KACMqF,GAAWrF,KAAK20F,WAClB30F,KAAKm1F,qBAAqBpoB,aAAa1nE,EAASrF,KAAK20F,WACpDh9E,UAAS,SAAEy9E,GACVzqF,EAAK0qF,aAAeD,EACpBzqF,EAAK8pF,WAAW33D,KAAKs4D,2BA9D5B50F,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,0BACVC,SAAA,6mBAEAC,gBAAiBC,GAAAA,wBAAwBC,uHAnBlCgrE,sCAuBN/qE,GAAAA,yBASAA,GAAAA,4BAUAA,GAAAA,0BAIAs8B,GAAAA,UAmCHy3D,IAXE,SAAAA,GAAoBM,GAAAn1F,KAAAm1F,qBAAAA,EA1Bbn1F,KAAA2vE,YAAc,IAAIilB,GAAAA,YAEf50F,KAAAy0F,WAAa,IAAIj3D,GAAAA,aCZ7B,IAAA83D,IAUEx1F,OAAAC,eACIu1F,GAAAl2F,UAAA,OAAI,KADR,WAEE,OAAOY,KAAK6iF,WAEd,SAASp9E,GAAT,IAAAkF,EAAA3K,KACEA,KAAK6iF,MAAQp9E,MACPsL,EAAQ/Q,KAAKkwE,cAAcnsC,UAAS,SAACgP,GAAQ,OAAAA,IAASpoC,EAAKlF,OACjEzF,KAAKy2B,aAAez2B,KAAKkwE,cAAcn/D,GACvC/Q,KAAK2vE,YAAY4lB,QACjBv1F,KAAKgjB,OAASvb,UACdzH,KAAKyvE,WAAWrrE,KAAK,MACrBpE,KAAKw1F,WAAWpxF,KAAKqD,WAGjBzH,KAAKyF,OAAS2uF,GAAkB5oB,YAKlCxrE,KAAK2vE,YAAYolB,SAJgB,CAC/BtvF,KAAM,QACNg6C,YAAa,KAMbz/C,KAAKyF,OAAS2uF,GAAkB1oB,OAClC1rE,KAAKgjB,OAAS,IACdhjB,KAAKy1F,kBAAkBV,SAAS/0F,KAAKgjB,QACrChjB,KAAK01F,WAAU,SAAIrwF,EAAoBmR,OAC/BipC,EAAcz5B,GAAAA,UAAiB3gB,EAAQ2rB,cAAc8B,iBAAkBnoB,EAAK6H,IAAImW,WAAY,aAClG,OAAO,IAAIqN,GAAAA,MAAe,CACxBzJ,MAAO,IAAI0J,GAAAA,OAAgB,CACzBjT,OAAQrY,EAAKqY,OAAUpI,KAAKorE,IAAKprE,KAAKyuC,GAAK,IAAO5J,EAAY,IAAOjpC,EACrEof,OAAQ,IAAIC,GAAAA,OAAe,CACzBC,MAAO,EACPjY,MAAO,sBAETkY,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAO,gCAKf7d,KAAK2kF,aAAe3kF,KAAK01F,WACzB11F,KAAKw1F,WAAWpxF,KAAKpE,KAAK2kF,gBAG1B3kF,KAAKgjB,OAASvb,UACdzH,KAAK21F,UAAS,SAAItwF,EAASmR,GACzB,OAAO,IAAIwf,GAAAA,MAAe,CACxBJ,OAAQ,IAAIC,GAAAA,OAAe,CACzBC,MAAO,EACPjY,MAAO,sBAETkY,KAAM,IAAIK,GAAAA,KAAa,CACrBvY,MAAO,8BAIb7d,KAAK2kF,aAAe3kF,KAAK21F,WAE3B31F,KAAK41F,cAAcxxF,KAAKpE,KAAK2kF,+CAU/B7kF,OAAAC,eACIu1F,GAAAl2F,UAAA,QAAK,KADT,WAEE,OAAOY,KAAK8zF,YAEd,SAAU/oD,GAAV,IAAApgC,EAAA3K,KACEA,KAAK8zF,OAAS/oD,EACd/qC,KAAK8zF,OAAO+B,UAAUl+E,UAAS,WAAShN,EAAKo6D,MAAM0J,mDAQrD3uE,OAAAC,eAAIu1F,GAAAl2F,UAAA,eAAY,KAAhB,WACE,MAAO,CAAC0xE,GAAkBL,yCAyE5B6kB,GAAAl2F,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKm1F,qBAAqB/oB,oBACzBz0D,UAAS,SAAEyF,eACV,IAAmB,IAAA04E,EAAAt4E,GAAAJ,GAAK24E,EAAAD,EAAA1xF,QAAA2xF,EAAA1xF,KAAA0xF,EAAAD,EAAA1xF,OAAE,CAArB,IAAM45B,EAAI+3D,EAAA71F,MACbyK,EAAKqrF,UAAUvxF,KAAKu5B,GACpBrzB,EAAKqrF,UAAU90D,KAAI,SAAE8F,EAAGllC,GACtB,OAAOklC,EAAEh4B,KAAKinF,cAAcn0F,EAAEkN,6GAGlCrE,EAAKqrF,UAAUnrF,QAAO,SAACqrF,GACrB,GAAIA,EAAM5kF,QAAgD,IAAtC3G,EAAKyG,OAAOJ,QAAQklF,EAAM5kF,OAAgB,CAC5D3G,EAAKyG,OAAO3M,KAAKyxF,EAAM5kF,WACjBm7D,EAAkC,CACtCz9D,KAAMknF,EAAM5kF,MACZi4E,SAAU,IAEZ5+E,EAAKwrF,UAAU1xF,KAAKgoE,GAEjBypB,EAAM5kF,QACHm7D,EAAkC,CACtCz9D,KAAMknF,EAAMlnF,KACZu6E,SAAU,GACVloE,OAAQ60E,EAAM70E,QAEhB1W,EAAKwrF,UAAU1xF,KAAKgoE,IAEtB9hE,EAAKwrF,UAAUj1D,KAAI,SAAE8F,EAAGllC,GACtB,OAAOklC,EAAEh4B,KAAKinF,cAAcn0F,EAAEkN,UAGlCrE,EAAKwrF,UAAUtrF,QAAO,SAAC4hE,eACrB,IAAoB,IAAAvtD,EAAA1B,GAAA7S,EAAKqrF,WAAS72E,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAA/B,IAAM8xF,EAAK/2E,EAAAjf,MACVg2F,EAAM5kF,QAAUm7D,EAASz9D,MAC3By9D,EAAS8c,SAAS9kF,KAAKyxF,6GAM/Bl2F,KAAKipB,WAAWjL,KAAOhe,KAAKm2F,UAE5Bn2F,KAAKyvE,WAAWrrE,KAAK,MACrBpE,KAAK0vE,OAAOtrE,KAAKpE,KAAK2vE,YAAYzvE,MAAQF,KAAK2vE,YAAYzvE,MAAQuH,WACnEzH,KAAK4vE,QAAU5vE,KAAK2vE,YAAYE,aAAal4D,UAAS,SAAEzX,GACtDyK,EAAK+kE,OAAOtrE,KAAKlE,GAAgBuH,aAGnCzH,KAAK0vE,OAAO/3D,UAAS,WACnBhN,EAAKinB,YACLjnB,EAAKo6D,MAAM0J,kBAGbzuE,KAAKo2F,gBAAkBp2F,KAAKy1F,kBAAkB5lB,aAAal4D,UAAS,WAClEhN,EAAKinB,YACLjnB,EAAKo6D,MAAM0J,mBAQf6mB,GAAAl2F,UAAAs0B,YAAA,WACE1zB,KAAK4vE,QAAQllD,cACb1qB,KAAK+kE,MAAMsxB,UAGbf,GAAAl2F,UAAAk3F,iBAAA,SAAiBj2E,GACfrgB,KAAKu2F,iBAAmBl2E,EAAMngB,MAC9BF,KAAKw2F,eAAe15D,KAAK98B,KAAKu2F,mBAOhCjB,GAAAl2F,UAAAq3F,oBAAA,SAAoBzvE,GAClBhnB,KAAK02F,YAAc1vE,GAGrBsuE,GAAAl2F,UAAAu3F,aAAA,WACE,OAAO32F,KAAKyF,OAAS2uF,GAAkB5oB,YAGzC8pB,GAAAl2F,UAAAw3F,UAAA,WACE,OAAO52F,KAAKyF,OAAS2uF,GAAkB3oB,SAGzC6pB,GAAAl2F,UAAAy3F,QAAA,WACE,OAAO72F,KAAKyF,OAAS2uF,GAAkB1oB,OAGzC4pB,GAAAl2F,UAAA03F,SAAA,SAASC,EAAWC,GAClB,QAAIA,EAAKzN,UACAyN,EAAKzN,SAASxmF,QAKzBuyF,GAAAl2F,UAAAonE,cAAA,SAAcwwB,GACZh3F,KAAKi3F,YAAYC,WAAWF,GAAQh3F,KAAKi3F,YAAYE,SAASH,GAAQh3F,KAAKi3F,YAAYxxC,OAAOuxC,IAGhG1B,GAAAl2F,UAAAg4F,cAAA,SAAcJ,GAAd,IACMK,EADN1sF,EAAA3K,KAEMs3F,EAAW,EAsBf,OArBKN,GAaHK,EAAcL,EAAKzN,SAASxmF,OAC5Bi0F,EAAKzN,SAAS1+E,QAAO,SAAC0+E,GAChB5+E,EAAK4sF,kBAAkB/oD,SAAS1/B,KAAI,SAAC29D,GAAY,OAAAA,IAAa8c,KAChE+N,QAfJD,EAAcr3F,KAAKu3F,kBAAkB/oD,SAASzrC,OAC9C/C,KAAKm2F,UAAUtrF,QAAO,SAAC4hE,IACuB,IAAxC9hE,EAAKyG,OAAOJ,QAAQy7D,EAASz9D,OAC/BsoF,MAGJt3F,KAAKg2F,UAAUnrF,QAAO,SAAC0+E,GAChB5+E,EAAKwrF,UAAUrnF,KAAI,SAAC29D,GAAY,OAAAA,EAASprD,SAAWkoE,EAASloE,UAChEi2E,OAYU,GAAZA,GACKD,IAAgBC,GAM3BhC,GAAAl2F,UAAAo4F,oBAAA,SAAoBR,GAApB,IAAArsF,EAAA3K,KACMy3F,GAAO,EAMX,OALAT,EAAKzN,SAAS1+E,QAAO,SAACqrF,GAChBvrF,EAAK4sF,kBAAkB/oD,SAAS1/B,KAAI,SAAC29D,GAAY,OAAAA,EAASprD,SAAW60E,EAAM70E,WAC7Eo2E,GAAO,KAGJA,GAMTnC,GAAAl2F,UAAAs4F,aAAA,WAAA,QAAA/sF,EAAA3K,KACEA,KAAKo3F,gBACHp3F,KAAKu3F,kBAAkB12E,QACvB7gB,KAAK4nC,gBAED+vD,EAAiD,OACvD,IAAuB,IAAAz4E,EAAA1B,GAAAxd,KAAKu3F,kBAAkB/oD,UAAQrvB,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAAnD,IAAMqoE,EAAQttD,EAAAjf,MACjBy3F,EAAsBlzF,KAAKgoE,wGAGzBzsE,KAAKo3F,gBACPp3F,KAAKm2F,UAAUtrF,QAAO,SAAC4hE,GACjB9hE,EAAKmsF,SAAS,EAAGrqB,IACnB9hE,EAAKssF,YAAYxxC,OAAOgnB,KAI5BzsE,KAAKm2F,UAAUtrF,QAAO,SAAC4hE,GACjB9hE,EAAKmsF,SAAS,EAAGrqB,IACnB9hE,EAAKssF,YAAYE,SAAS1qB,KAIhCzsE,KAAK43F,eAAe96D,KAAK66D,IAG3BrC,GAAAl2F,UAAAwoC,UAAA,SAAUovD,GAAV,IAAArsF,EAAA3K,KACOg3F,EAYCh3F,KAAK82F,SAAS,EAAGE,IACnBA,EAAKzN,SAAS1+E,QAAO,SAAC0+E,GAAY,OAAA5+E,EAAK4sF,kBAAkBM,OAAOtO,MAZlEvpF,KAAKm2F,UAAUtrF,QAAO,SAAC4hE,IACuB,IAAxC9hE,EAAKyG,OAAOJ,QAAQy7D,EAASz9D,OAC/BrE,EAAK4sF,kBAAkBM,OAAOprB,KAGlCzsE,KAAKg2F,UAAUnrF,QAAO,SAAC0+E,GAChB5+E,EAAK4sF,kBAAkB/oD,SAAS1/B,KAAI,SAAC29D,GAAY,OAAAA,EAASprD,SAAWkoE,EAASloE,UACjF1W,EAAK4sF,kBAAkBM,OAAOtO,OAUtC+L,GAAAl2F,UAAA04F,gBAAA,SAAgBd,GAAhB,QAAArsF,EAAA3K,KACEA,KAAKo3F,cAAcJ,GACnBA,EAAKzN,SAAS1+E,QAAO,SAACqrF,GAAS,OAAAvrF,EAAK4sF,kBAAkBQ,SAAS7B,KAC/Dl2F,KAAK4nC,UAAUovD,OAETW,EAAiD,OACvD,IAAuB,IAAAz4E,EAAA1B,GAAAxd,KAAKu3F,kBAAkB/oD,UAAQrvB,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAAnD,IAAMqoE,EAAQttD,EAAAjf,MACjBy3F,EAAsBlzF,KAAKgoE,wGAE7BzsE,KAAKi3F,YAAYxxC,OAAOuxC,GACxBh3F,KAAK43F,eAAe96D,KAAK66D,IAM3BrC,GAAAl2F,UAAA44F,eAAA,SAAeC,GAAf,QAAAttF,EAAA3K,KACMwuC,GAAW,EACXxuC,KAAKu3F,kBAAkB/oD,SAAS1/B,KAAI,SAAC29D,GAAY,OAAAA,EAASprD,SAAW42E,EAAa52E,WAAY5Z,YAChG+mC,GAAW,GAGbxuC,KAAKg2F,UAAUnrF,QAAO,SAAC0+E,GACjBA,IAAa0O,IAA6B,IAAbzpD,GAC/B7jC,EAAK4sF,kBAAkBM,OAAOtO,GAE5BA,IAAa0O,IAA6B,IAAbzpD,GAC/B7jC,EAAK4sF,kBAAkBQ,SAASxO,KAGpCvpF,KAAKm2F,UAAUtrF,QAAO,SAAC4hE,GACjBA,IAAawrB,IAA6B,IAAbzpD,GAC/B7jC,EAAK4sF,kBAAkBM,OAAOprB,GAE5BA,IAAawrB,IAA6B,IAAbzpD,GAC/B7jC,EAAK4sF,kBAAkBQ,SAAStrB,SAI9BkrB,EAAiD,OACvD,IAAuB,IAAAz4E,EAAA1B,GAAAxd,KAAKu3F,kBAAkB/oD,UAAQrvB,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAAnD,IAAMqoE,EAAQttD,EAAAjf,MACjBy3F,EAAsBlzF,KAAKgoE,wGAE7BzsE,KAAK43F,eAAe96D,KAAK66D,IAG3BrC,GAAAl2F,UAAA84F,oBAAA,WACEl4F,KAAK+vE,qBAAuB/vE,KAAK+vE,qBAGnCulB,GAAAl2F,UAAA+4F,wBAAA,WACEn4F,KAAKgwE,sBAAwBhwE,KAAKgwE,qBAClChwE,KAAKo4F,gBAAgBt7D,KAAK98B,KAAKgwE,uBAMjCslB,GAAAl2F,UAAAi5F,mBAAA,YACMr4F,KAAK42F,aAAe52F,KAAK62F,aAC3B72F,KAAKs4F,SAAWt4F,KAAK2vE,YAAiB,MACtC3vE,KAAKs4F,SAAS5lD,KAAO,CACnB7rC,GAAIY,UACJoK,MAAO,QAET7R,KAAKs4F,SAASlkF,WAAa,CACzB6oD,IAAK,QAEPj9D,KAAKu4F,cAAcz7D,KAAK98B,KAAKs4F,WAE/Bt4F,KAAKw4F,YAAY17D,KAAK98B,KAAKgjB,QAC3BhjB,KAAKy4F,aAAa37D,QAMpBw4D,GAAAl2F,UAAAs5F,YAAA,WACE14F,KAAKysB,SAAU,EACfzsB,KAAKwS,IAAI20B,aAAannC,KAAK2F,QAC3B3F,KAAKysB,SAAU,EACXzsB,KAAK+qC,OACP/qC,KAAK+qC,MAAMlqB,QAEb7gB,KAAK24F,iBAAiB77D,KAAK,KAM7Bw4D,GAAAl2F,UAAAw5F,YAAA,WACE54F,KAAKu3F,kBAAkB12E,QACvB7gB,KAAK43F,eAAe96D,KAAK,IACzB98B,KAAK64F,iBAAiB/7D,QAMxBw4D,GAAAl2F,UAAA05F,oBAAA,WACE,GAAI94F,KAAKyF,OAAS2uF,GAAkB5oB,WAAY,CAC9C,GAAIxrE,KAAKu2F,mBAAqB3pB,GAAsBjB,SAC9C3rE,KAAK20F,YAAcltF,WAAazH,KAAK+iB,OAAStb,UAChD,OAAOzH,KAAKysB,QAGhB,GAAIzsB,KAAKu2F,mBAAqB3pB,GAAsBhB,WAC9C5rE,KAAK20F,YAAcltF,WAAazH,KAAK+iB,OAAStb,WAAsD,EAAzCzH,KAAKu3F,kBAAkB/oD,SAASzrC,OAC7F,OAAO/C,KAAKysB,QAIlB,GAAIzsB,KAAKyF,OAAS2uF,GAAkB3oB,SAAWzrE,KAAKyF,OAAS2uF,GAAkB1oB,MAAO,CACpF,GAAI1rE,KAAKu2F,mBAAqB3pB,GAAsBjB,SAAsC,OAA3B3rE,KAAK2vE,YAAYzvE,MAC9E,OAAOF,KAAKysB,QAEd,GAAIzsB,KAAKu2F,mBAAqB3pB,GAAsBhB,WACL,EAAzC5rE,KAAKu3F,kBAAkB/oD,SAASzrC,QAAyC,OAA3B/C,KAAK2vE,YAAYzvE,MACjE,OAAOF,KAAKysB,QAIlB,OAAO,GAMT6oE,GAAAl2F,UAAAwyB,UAAA,eACMmnE,EAEJ,GADkCA,EAAP,OAA3B/4F,KAAK2vE,YAAYzvE,MAA6BF,KAAK2vE,YAAYzvE,MAAM8iB,OAAqBvb,UACtFzH,KAAKyF,OAAS2uF,GAAkB1oB,MAAO,CACzC,GAAK1rE,KAAKgwE,qBASH,CACL,GAAoC,KAAhChwE,KAAKy1F,kBAAkBv1F,OAAkBF,KAAKy1F,kBAAkBv1F,MAAQ,EAM1E,OALAF,KAAKohD,eAAe43C,MAAMh5F,KAAKk/B,gBAAgBC,UAAUC,QAAQ,qCAC/Dp/B,KAAKk/B,gBAAgBC,UAAUC,QAAQ,kCACzCp/B,KAAKgjB,OAAS,IACdhjB,KAAKy1F,kBAAkBV,SAAS/0F,KAAKgjB,aACrChjB,KAAKyvE,WAAWrrE,KAAKpE,KAAKgjB,QAG5B,GAAiB,KAAb+1E,EAIF,OAHA/4F,KAAKohD,eAAe43C,MAAMh5F,KAAKk/B,gBAAgBC,UAAUC,QAAQ,qCAC/Dp/B,KAAKk/B,gBAAgBC,UAAUC,QAAQ,uCACzCp/B,KAAK2vE,YAAY4lB,QAGfwD,IACEA,IAAc/4F,KAAKy1F,kBAAkBv1F,OACvCF,KAAKy1F,kBAAkBV,SAASgE,GAElC/4F,KAAK2vE,YAAYzvE,MAAM8iB,OAASvb,gBA3BlC,GAAoC,KAAhCzH,KAAKy1F,kBAAkBv1F,OAAkBF,KAAKy1F,kBAAkBv1F,MAAQ,EAM1E,OALAF,KAAKohD,eAAe43C,MAAMh5F,KAAKk/B,gBAAgBC,UAAUC,QAAQ,qCAC/Dp/B,KAAKk/B,gBAAgBC,UAAUC,QAAQ,kCACzCp/B,KAAKgjB,OAAS,IACdhjB,KAAKy1F,kBAAkBV,SAAS/0F,KAAKgjB,aACrChjB,KAAKyvE,WAAWrrE,KAAKpE,KAAKgjB,QAyB9BhjB,KAAKgjB,OAAShjB,KAAKy1F,kBAAkBv1F,MACrCF,KAAKyvE,WAAWrrE,KAAKpE,KAAKgjB,QAC1BhjB,KAAK41F,cAAcxxF,KAAKpE,KAAK01F,YAC7B11F,KAAKw1F,WAAWpxF,KAAKpE,KAAK01F,mCA7gB/Bl1F,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,0BACVC,SAAA,sjNAEAC,gBAAiBC,GAAAA,wBAAwBC,o+CAnCzCqlE,GAAAA,yBAoBO2F,UAMA7pB,GAAAA,sBAAgBhiB,GAAAA,iDAatBl/B,GAAAA,oBAEAA,GAAAA,yBA+DAA,GAAAA,oBAEAA,GAAAA,uBAEAA,GAAAA,qBAEAA,GAAAA,sBAkBAA,GAAAA,4BAEAs8B,GAAAA,+BAEAA,GAAAA,+BAEAA,GAAAA,8BAEAA,GAAAA,4BAEAA,GAAAA,gCACAA,GAAAA,iCAEAA,GAAAA,iCAEAA,GAAAA,yBAEAA,GAAAA,UA8ZHk4D,IA/WE,SAAAA,GACUvwB,EACAowB,EACA/zC,EACAliB,GAHAl/B,KAAA+kE,MAAAA,EACA/kE,KAAAm1F,qBAAAA,EACAn1F,KAAAohD,eAAAA,EACAphD,KAAAk/B,gBAAAA,EApEDl/B,KAAA2F,OAAkB,GAEjB3F,KAAAy4F,aAAe,IAAIj7D,GAAAA,aAEnBx9B,KAAAw2F,eAAiB,IAAIh5D,GAAAA,aAErBx9B,KAAA43F,eAAiB,IAAIp6D,GAAAA,aAErBx9B,KAAAu4F,cAAgB,IAAI/6D,GAAAA,aAEpBx9B,KAAAw4F,YAAc,IAAIh7D,GAAAA,aAClBx9B,KAAAo4F,gBAAkB,IAAI56D,GAAAA,aAEtBx9B,KAAA24F,iBAAmB,IAAIn7D,GAAAA,aAEvBx9B,KAAA64F,iBAAmB,IAAIr7D,GAAAA,aAEvBx9B,KAAAi5F,UAAS,IAAIz7D,GAAAA,aAEhBx9B,KAAAwsE,SAAoC,CAACI,GAAsBjB,QAASiB,GAAsBhB,WAC1F5rE,KAAAu2F,iBAA0C3pB,GAAsBjB,QAGvE3rE,KAAAi3F,YAAc,IAAIiC,GAAAA,kBAAiB,SAAwBlC,GAAQ,OAAAA,EAAKzN,WAGjEvpF,KAAAm5F,iBAA6B,CAAC,OAAQ,UACtCn5F,KAAAg2F,UAAqC,GACrCh2F,KAAAoR,OAAmB,GACnBpR,KAAAm2F,UAAqC,GACrCn2F,KAAAipB,WAAa,IAAImwE,GAAAA,wBACjBp5F,KAAAu3F,kBAAoB,IAAI8B,GAAAA,gBAAsC,EAAM,IACpEr5F,KAAAs5F,wBAAoC,CAAC,cAAe,eAG3Dt5F,KAAA0vE,OAA2C,IAAIzkD,GAAAA,gBAAgBxjB,WAC/DzH,KAAAyvE,WAAsC,IAAIxkD,GAAAA,gBAAgB,MAC1DjrB,KAAA41F,cAA0C,IAAI3qE,GAAAA,gBAAgBxjB,WAC9DzH,KAAAw1F,WAAuC,IAAIvqE,GAAAA,gBAAgBxjB,WAKpDzH,KAAA2vE,YAAc,IAAIilB,GAAAA,YAElB50F,KAAAiwE,mBAAoB,EACpBjwE,KAAAkwE,cAA0B,CAAC,QAAS,WACpClwE,KAAAmwE,gBAAiB,EACjBnwE,KAAAsmF,UAAoB,KACpBtmF,KAAAowE,qBAAuB,GACvBpwE,KAAAqwE,SAAU,EACVrwE,KAAA+vE,qBAAsB,EACtB/vE,KAAAgwE,sBAAuB,EAQvBhwE,KAAAy1F,kBAAoB,IAAIb,GAAAA,YAExB50F,KAAA02F,YAAiC5lB,GAAkBL,OClM5D,IAAA8oB,IA0ISA,GAAAv4F,QAAP,WACE,MAAO,CACLC,SAAUs4F,GACVr4F,UAAW,CACT,CACEs4F,QAASC,GAAAA,gBACTC,SAAU,iCAhFnBv4F,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACA2mE,GAAAA,YACA2e,GAAAA,oBACAgT,GAAAA,sBACAr4F,GAAAA,cACAC,GAAAA,gBACAq4F,GAAAA,cACAC,GAAAA,eACA3xB,GAAAA,cACA4xB,GAAAA,eACAC,GAAAA,cACAnT,GAAAA,sBACApe,GAAAA,kBACAF,GAAAA,gBACAH,GAAAA,qBACAJ,GAAAA,mBACAD,GAAAA,eACAkyB,GAAAA,gBACA5xB,GAAAA,gBACAC,GAAAA,cACA7mE,GAAAA,iBACAy4F,GAAAA,oBACAC,GAAAA,oBACAC,EAAAA,wBACAC,EAAAA,wBACA34F,GAAAA,kBACAomE,GACAa,GAAAA,qBACAD,GAAAA,cACA0G,GAAAA,kBACA0X,GACAte,GAAAA,gBAEF7mE,QAAS,CACP6nE,GACAwd,GACAG,GACA4E,GACAI,GACAC,GACAsD,GACAiD,GACAO,GACAhC,GACAC,GACAsB,GACAC,GACAoB,GACAgB,GACAS,IAEF3zF,aAAc,CACZ4nE,GACAwd,GACAG,GACA4E,GACAI,GACAC,GACAsD,GACAiD,GACAO,GACAhC,GACAC,GACAsB,GACAC,GACAoB,GACAgB,GACAS,IAEFp0F,UAAW,CAAC0oE,GAAmBmB,GAAkBc,QAcnD0tB,IArFA,SAAAA,MChEA,IAAAc,IAaEv6F,OAAAC,eACIs6F,GAAAj7F,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKC,YAEd,SAAUC,GACRF,KAAKC,OAASC,mCAIhBJ,OAAAC,eACIs6F,GAAAj7F,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKG,YAEd,SAAUD,GACRF,KAAKG,OAASD,mCAMhBJ,OAAAC,eAAIs6F,GAAAj7F,UAAA,UAAO,KAAX,WACE,GAAKY,KAAKM,MAGV,OAAON,KAAKM,MAAM2oB,WAAW1oB,yCAG/B85F,GAAAj7F,UAAAk7F,kBAAA,WACE,SAAKt6F,KAAKM,iBAAiB0vB,KAAyC,IAA1BhwB,KAAKM,MAAM4vB,YAClDlwB,KAAKM,MAAM2oB,WAAW1oB,QAAQ4W,UAAYnX,KAAKM,MAAM2oB,WAAW1oB,QAAQ4W,SAAS1X,2BApCvFe,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,oBACVC,SAAA,wUAEAC,gBAAiBC,GAAAA,wBAAwBC,8FAGxCC,GAAAA,qBASAA,GAAAA,SAyBHu5F,IAhBE,SAAAA,KAFQr6F,KAAAG,OAAS,qBC7Bc6G,GAAAA,MAAAU,OAAO6yF,IAAxC,SAAAA,iEAE4CvzF,GAAAA,MAAAuzF,IAK5CC,IAJE,SAAAA,KAAA,IAAA7vF,EACE2M,GAAAtU,KAAAhD,KAAM,iBAAeA,YACrBF,OAAOiC,eAAe4I,EAAM6vF,GAAuBp7F,wBAIP4H,GAAAA,MAAAuzF,IAKhDE,IAJE,SAAAA,KAAA,IAAA9vF,EACE2M,GAAAtU,KAAAhD,KAAM,sBAAoBA,YAC1BF,OAAOiC,eAAe4I,EAAM8vF,GAA2Br7F,aCF3D,SAAgBs7F,GACdh2F,EACA08C,EACAliB,GAEA,GAAIx6B,aAAiB+1F,GACnBE,GAA2Bv5C,EAAgBliB,OAD7C,KAIMC,EAAYD,EAAgBC,UAC5BttB,EAAQstB,EAAUC,QAAQ,+BAC1BvZ,EAAUsZ,EAAUC,QAAQ,8BAClCgiB,EAAe18C,MAAMmhB,EAAShU,IAGhC,SAAgB+oF,GACdx5C,EACAliB,OAEMC,EAAYD,EAAgBC,UAC5BttB,EAAQstB,EAAUC,QAAQ,gCAC1BvZ,EAAUsZ,EAAUC,QAAQ,+BAClCgiB,EAAe2sB,QAAQloD,EAAShU,GAGlC,SAAgB8oF,GACdv5C,EACAliB,OAEMC,EAAYD,EAAgBC,UAC5BttB,EAAQstB,EAAUC,QAAQ,gCAC1BvZ,EAAUsZ,EAAUC,QAAQ,+BAClCgiB,EAAe18C,MAAMmhB,EAAShU,GCxChC,IAAagpF,GAAeC,GAAAA,QAAQ,CAAC,UAAW,MAAO,MAAO,MAAO,YAAa,WAAY,eAAgB,QCF9GC,IA4CEA,GAAA37F,UAAA65F,UAAA,SACErsD,EACAzlC,EACA0K,EACAihC,EACAZ,QADA,IAAAY,IAAAA,EAAA,kBACA,IAAAZ,IAAAA,EAAA,iBAEM8oD,EAAmBh7F,KAAKi7F,gBAAgBruD,EAAYzlC,GAE1D,OAAOnH,KAAKk7F,YACVF,EACA7zF,EACA0K,EACAihC,EACAZ,IAII6oD,GAAA37F,UAAA67F,gBAAR,SACEruD,EACAzlC,GAEA,OAAIA,IAAW0zF,GAAaM,KAAOn7F,KAAKo7F,mBAC/Bp7F,KAAKq7F,wBAAwBzuD,GAG/BA,EAAWp6B,IAAG,SAAE8iB,OAIflhB,EAHOkhB,EACVzc,UACA7O,OAAM,SAAE3G,GAAgB,OAACA,EAAIywC,WAAW,OACnBlQ,OAAM,SAC3BsN,EAAa7tC,GAEZ,OADA6tC,EAAI7tC,GAAOiyB,EAAUnd,IAAI9U,GAClB6tC,GAET,CAAE9lC,SAAUkqB,EAAUtE,gBAExB,OAAO,IAAIiI,GAAU7kB,MAIjB2mF,GAAA37F,UAAAi8F,wBAAR,SAAgCzuD,GAC9B,OAAOA,EAAWp6B,IAAG,SAAE8iB,OACf0C,EAAO1C,EACVzc,UACA7O,OAAM,SAAE3G,GAAgB,OAACA,EAAIywC,WAAW,OACvCwnD,EAAkB,GAChBlnF,EAAoB4jB,EAAK4L,OAAM,SAClCsN,EAAa7tC,GAKZ,OAJIA,IAAQoE,WAAqB,aAARpE,IACvBi4F,GAAWj4F,EAAM,IAAMiyB,EAAUnd,IAAI9U,GAAO,WAE9C6tC,EAAI7tC,GAAOiyB,EAAUnd,IAAI9U,GAClB6tC,GAET,CAAE9lC,SAAUkqB,EAAUtE,gBAElB+rC,EAAa,IAAI9jC,GAAU7kB,GAIjC,OAHA2oD,EAAWpxC,IAAI,OAAQ2J,EAAU5U,SACjCq8C,EAAWpxC,IAAI,MAAO2vE,GAEfv+B,KAIHg+B,GAAA37F,UAAA87F,YAAR,SACEtuD,EACAzlC,EACA0K,EACAihC,EACAZ,GALF,IAAAvnC,EAAA3K,KAmDE,OAAO,IAAIqY,GAAAA,WA5CG,SAAIkjF,GAEhB,IAAwB,IADA5wF,EAAK6wF,gBAAgB5uD,EAAYzlC,GAOzD,GAAmC,GADfrH,OAAOk4B,KAAK+iE,GAAcU,aAC9BzqF,QAAQ7J,GAAc,CACpC,GAAIwD,EAAK+wF,UAAYj0F,UAanB,YAZqD,GAAjDszF,GAAcY,gBAAgB3qF,QAAQ7J,GACxCwD,EAAKixF,aACHhvD,EACA2uD,EACAp0F,EACA0K,EACAihC,EACAZ,GAGFqpD,EAAS72F,MAAM,IAAI81F,KAIvB7vF,EAAKkxF,eACHjvD,EACA2uD,EACAp0F,EACA0K,EACAihC,EACAZ,QAGFvnC,EAAKixF,aACHhvD,EACA2uD,EACAp0F,EACA0K,EACAihC,EACAZ,QApCFqpD,EAAS72F,MAAM,IAAI+1F,OA4CfM,GAAA37F,UAAAw8F,aAAV,SACEhvD,EACA2uD,EACAp0F,EACA0K,EACAihC,EACAZ,OAGM4pD,GADW,IAAIt0F,GAASL,IACA40F,cAAcnvD,EAAY,CACtD1/B,eAAgBglC,EAChB/kC,kBAAmB2lC,EACnBk6B,YAAa,UACbnjE,UAAW,+BAGPmyF,EAAcnqF,EAAK,IAAI1K,EAAO+H,cAEpC+sF,GAAAA,gBAAgBH,EAAc,2BAA4BE,GAC1DT,EAASriF,YAGH6hF,GAAA37F,UAAAy8F,eAAR,SACEjvD,EACA2uD,EACAp0F,EACA0K,EACAihC,EACAZ,OAEM4pD,GAAuB,IAAIn0F,GAAAA,SAAmBo0F,cAClDnvD,EACA,CACE1/B,eAAgBglC,EAChB/kC,kBAAmB2lC,EACnBk6B,YAAa,UACbnjE,UAAW,+BAITpK,EAASO,KAAK07F,QAAO,eACrBQ,EAAO7uE,SAASC,cAAc,QAUpC,GATA4uE,EAAK31F,MAAM41F,QAAU,OACrB9uE,SAAS6sC,KAAKkiC,YAAYF,GAC1BA,EAAKG,aAAa,SAAU,QAC5BH,EAAKG,aAAa,SAAU,UAC5BH,EAAKG,aAAa,SAAU58F,GAE5By8F,EAAKI,cAAgB,QACrBJ,EAAKK,QAAU,oDAEA,iBAAXp1F,EAA2B,KACvB5G,EAAU8sB,SAASC,cAAc,SACvC/sB,EAAQ87F,aAAa,OAAQ,UAC7B97F,EAAQ87F,aAAa,OAAQ,OAC7B97F,EAAQ87F,aAAa,QAAS,uBAC9BH,EAAKE,YAAY77F,OAGbi8F,EAAenvE,SAASC,cAAc,SAC5CkvE,EAAaH,aAAa,OAAQ,UAClCG,EAAaH,aAAa,OAAQ,QAClCG,EAAaH,aAAa,QAASP,GACnCI,EAAKE,YAAYI,OAEXC,EAAkBpvE,SAASC,cAAc,SAC3CovE,EACS,cAAXv1F,EACO0K,EAAK,OACLA,EAAK,IAAI1K,EAAO+H,cACV,aAAX/H,GAAoC,iBAAXA,IAC3Bu1F,EAAgB7qF,EAAK,QAGvB6qF,GADAA,EAAaA,EAAW3uF,QAAQ,IAAK,MACbuxB,UAAU,OAAOvxB,QAAQ,mBAAoB,IACrE0uF,EAAgBJ,aAAa,OAAQ,UACrCI,EAAgBJ,aAAa,OAAQ,cACrCI,EAAgBJ,aAAa,QAASK,GACtCR,EAAKE,YAAYK,OAEbE,EAAa5B,GAAcU,YAAYt0F,GAC5B,aAAXA,GAAoC,iBAAXA,IAC3Bw1F,EAAa,WAETC,EAAoBvvE,SAASC,cAAc,SACjDsvE,EAAkBP,aAAa,OAAQ,UACvCO,EAAkBP,aAAa,OAAQ,UACvCO,EAAkBP,aAAa,QAASM,GACxCT,EAAKE,YAAYQ,GAEjBV,EAAKW,SACLxvE,SAAS6sC,KAAK4iC,YAAYZ,GAE1BX,EAASriF,YAGH6hF,GAAA37F,UAAAo8F,gBAAR,SAAwB5uD,EAAyBzlC,GAC/C,OAA0B,IAAtBylC,EAAW7pC,QAGA,QAAXoE,GACkBylC,EAAW99B,KAAI,SAACwmB,GAClC,OAEE,GADA,CAAC,QAAS,aAAc,mBAAmBtkB,QAAQskB,EAAUtE,cAAcW,eAIxDlqB,WA1PpBszF,GAAAU,YAAc,CACnBsB,IAAK,MACL5B,IAAK,MACL6B,IAAK,MACLC,UAAW,iBACXC,SAAU,WACVC,aAAc,gBAGTpC,GAAAY,gBAAkB,CAAC,MAAO,MAAO,4BAbzCj8F,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAfLukD,GAAAA,yJAgCP,SAAA42C,GAAoB59E,GAAAnd,KAAAmd,OAAAA,EAFZnd,KAAAo7F,oBAA8B,EAGpCp7F,KAAK07F,QAAU17F,KAAKmd,OAAOinC,UAAU,wBAC/Bg5C,EAAwBp9F,KAAKmd,OAAOinC,UACxC,sCAEEg5C,IAA0B31F,YAC5BzH,KAAKo7F,mBAAqBgC,cCxCCp2F,GAAAA,MAAAU,OAAO21F,IAAxC,SAAAA,iEAE4Cr2F,GAAAA,MAAAq2F,IAK5CC,IAJE,SAAAA,KAAA,IAAA3yF,EACE2M,GAAAtU,KAAAhD,KAAM,iBAAeA,YACrBF,OAAOiC,eAAe4I,EAAM2yF,GAAuBl+F,wBAIR4H,GAAAA,MAAAq2F,IAK/CE,IAJE,SAAAA,KAAA,IAAA5yF,EACI2M,GAAAtU,KAAAhD,KAAM,wBAAsBA,YAC5BF,OAAOiC,eAAe4I,EAAM4yF,GAA0Bn+F,wBAIZ4H,GAAAA,MAAAq2F,IAKhDG,IAJE,SAAAA,KAAA,IAAA7yF,EACI2M,GAAAtU,KAAAhD,KAAM,sBAAoBA,YAC1BF,OAAOiC,eAAe4I,EAAM6yF,GAA2Bp+F,wBAIxB4H,GAAAA,MAAAq2F,IAKrCI,IAJE,SAAAA,KAAA,IAAA9yF,EACI2M,GAAAtU,KAAAhD,KAAM,sBAAoBA,YAC1BF,OAAOiC,eAAe4I,EAAM6yF,GAA2Bp+F,wBAIzB4H,GAAAA,MAAAq2F,IAKpCK,IAJE,SAAAA,KAAA,IAAA/yF,EACI2M,GAAAtU,KAAAhD,KAAM,2BAAyBA,YAC/BF,OAAOiC,eAAe4I,EAAM6yF,GAA2Bp+F,aCf7D,SAAgBu+F,GAAyBhlF,EAAqBnG,EAAao0B,OACnEgG,EAAaj0B,EAASnG,IAAG,SAAEnN,GAAqB,OAAA+nC,GAAY/nC,EAASmN,EAAImW,cAEzEnlB,EAAIoX,KAAKgjF,MAAsB,IAAhBhjF,KAAKC,UACpBvI,EAAIsI,KAAKgjF,MAAsB,IAAhBhjF,KAAKC,UACpB/Y,EAAI8Y,KAAKgjF,MAAsB,IAAhBhjF,KAAKC,UACpB+a,EAAS,IAAIioE,GAAAA,OAAe,CAChChgF,MAAO,CAACra,EAAG8O,EAAGxQ,EAAG,GACjBg0B,MAAO,IAGHC,EAAO,IAAI+nE,GAAAA,KAAa,CAC5BjgF,MAAO,CAACra,EAAG8O,EAAGxQ,EAAG,MAMbuf,EAAS,IAAIpa,GAJ0D,CAC3ExB,KAAM,SACN00B,WAAW,IAGb9Y,EAAOva,GAAGinC,YAAYnB,OAChBtsC,EAAQ,IAAI0vB,GAAY,CAC5Bne,MAAO+0B,EACPvlB,OAAMA,EACN9a,MAAO,IAAIw3F,GAAAA,MAAc,CACvBnoE,OAAMA,EACNG,KAAIA,EACJxJ,MAAO,IAAIyxE,GAAAA,OAAe,CACxBh7E,OAAQ,EACR4S,OAAMA,EACNG,KAAIA,QAOV,OAHAvjB,EAAIy/B,SAAS3xC,GACbwtC,GAAiBt7B,EAAKo6B,GAEftsC,EAGT,SAAgB29F,GAA+BtlF,EAAqBnG,EAAao0B,EAClCs3D,EAAoCvqC,OAE7EptD,EACA43F,EA+CA98E,EAjDEurB,EAAaj0B,EAASnG,IAAG,SAAEnN,GAAqB,OAAA+nC,GAAY/nC,EAASmN,EAAImW,cAI/E,GAAIu1E,EAAiBE,aAAax3D,EAAW7N,WAAa,qBAAsB,KACxEslE,EAAqCH,EAAiBE,aAAax3D,EAAW7N,WAAa,qBAEjGxyB,EAAK,SAAGlB,GACN,OAAOsuD,EAAap7B,uBAClBlzB,EACAg5F,SAIC,GAAIH,EAAiBE,aAAax3D,EAAW7N,WAAa,iBAAkB,KAC3EulE,EAA6BJ,EAAiBE,aAAax3D,EAAW7N,WAAa,iBACzFolE,EAAWD,EAAiBE,aAAax3D,EAAW7N,WAAa,iBAE3D+6B,EAAYH,EAAan9B,YAAY0nE,EAAiBE,aAAax3D,EAAW7N,WAAa,kBAEjGxyB,EAAK,SAAGlB,GACN,OAAOsuD,EAAaz6B,mBAClB7zB,EACAi5F,EACAxqC,SAIC,GAAIoqC,EAAiBE,aAAax3D,EAAW7N,WAAa,UAE/DxyB,EAAQotD,EAAan9B,YAAY0nE,EAAiBE,aAAax3D,EAAW7N,WAAa,gBAElF,GAAImlE,EAAiBE,aAAa,yBAAyD,UAA9BzlF,EAAS,GAAGvN,SAAS3F,KAAkB,KACjG84F,EAA6BL,EAAiBE,aAAa,wBACjED,EAAWD,EAAiBE,aAAa,wBAEnCI,EAAY7qC,EAAan9B,YAAY0nE,EAAiBE,aAAa,yBAEzE73F,EAAK,SAAGlB,GACN,OAAOsuD,EAAaz6B,mBAClB7zB,EACAk5F,EACAC,SAINj4F,EAAQotD,EAAan9B,YAAY0nE,EAAiBE,aAAa,kBAIjE,GAAIF,EAAiBE,aAAax3D,EAAW7N,WAAa,kBAMxD1X,EAAS,IAAID,GALgE,CAC3E+8E,SAAQA,EACR14F,KAAM,UACN00B,WAAW,KAGNrzB,GAAGua,OAAO0sB,YAAYnB,QACxB,GAAIsxD,EAAiBE,aAAax3D,EAAW7N,YAAa,EAK/D1X,EAAS,IAAIpa,GAJgE,CAC3ExB,KAAM,SACN00B,WAAW,KAGNrzB,GAAGinC,YAAYnB,QACjB,GAAIsxD,EAAiBE,aAAa,yBAAyD,UAA9BzlF,EAAS,GAAGvN,SAAS3F,KAAkB,EAMzG4b,EAAS,IAAID,GALgE,CAC3E+8E,SAAQA,EACR14F,KAAM,UACN00B,WAAW,KAGNrzB,GAAGua,OAAO0sB,YAAYnB,OACxB,EAKLvrB,EAAS,IAAIpa,GAJgE,CAC3ExB,KAAM,SACN00B,WAAW,KAGNrzB,GAAGinC,YAAYnB,OAGlBtsC,EAAQ,IAAI0vB,GAAY,CAC5Bne,MAAO+0B,EACPvlB,OAAMA,EACN9a,MAAKA,IAKP,OAHAiM,EAAIy/B,SAAS3xC,GACbwtC,GAAiBt7B,EAAKo6B,GAEftsC,EAGT,SAAgBm+F,GACdC,EACA/lF,EACAnG,EACA4uC,EACAliB,EACAg/D,EACAvqC,GAEA,GAAwB,IAApBh7C,EAAS5V,OAAb,KAKM6jC,EAAa+3D,GAA0BD,GAExCR,EAGHD,GAA+BtlF,EAAUnG,EAAKo0B,EAAYs3D,EAAkBvqC,GAF5EgqC,GAAyBhlF,EAAUnG,EAAKo0B,OAKpCzH,EAAYD,EAAgBC,UAC5By/D,EAAez/D,EAAUC,QAAQ,qCACjCvZ,EAAUsZ,EAAUC,QAAQ,mCAAoC,CAClEl/B,MAAO0mC,IAEXwa,EAAe2sB,QAAQloD,EAAS+4E,QAjB9BC,GAA2BH,EAAMt9C,EAAgBliB,GAoBrD,SAAgB4/D,GACdJ,EACAh6F,EACA08C,EACAliB,EACA6/D,GAEAA,EAASA,GAAkB,GACR,CACjBC,eAAgBC,GAChBC,oBAAqBC,GACrBC,sBAAuBC,GACvBC,yBAA0BC,IAEjB76F,EAAMmhB,SAAS64E,EAAMh6F,EAAO08C,EAAgBliB,EAAiB6/D,GAG1E,SAAgBE,GACdP,EACAh6F,EACA08C,EACAliB,OAEMC,EAAYD,EAAgBC,UAC5BttB,EAAQstB,EAAUC,QAAQ,qCAC1BvZ,EAAUsZ,EAAUC,QAAQ,mCAAoC,CAClEl/B,MAAOw+F,EAAK1vF,KACZ8/C,SAAU4vC,EAAKj5F,OAEnB27C,EAAe18C,MAAMmhB,EAAShU,GAGhC,SAAgBwtF,GACdX,EACAh6F,EACA08C,EACAliB,OAEMC,EAAYD,EAAgBC,UAC5BttB,EAAQstB,EAAUC,QAAQ,wCAC1BvZ,EAAUsZ,EAAUC,QAAQ,sCAAuC,CACrEl/B,MAAOw+F,EAAK1vF,OAEhBoyC,EAAe18C,MAAMmhB,EAAShU,GAGhC,SAAgBstF,GACdT,EACAh6F,EACA08C,EACAliB,EACA6/D,OAEM5/D,EAAYD,EAAgBC,UAC5BttB,EAAQstB,EAAUC,QAAQ,sCAC1BvZ,EAAUsZ,EAAUC,QAAQ,oCAAqC,CACnEl/B,MAAOw+F,EAAK1vF,KACZoN,KAAM2iF,IAEV39C,EAAe18C,MAAMmhB,EAAShU,GAGhC,SAAgBgtF,GACdH,EACAt9C,EACAliB,OAEMC,EAAYD,EAAgBC,UAC5BttB,EAAQstB,EAAUC,QAAQ,mCAC1BvZ,EAAUsZ,EAAUC,QAAQ,iCAAkC,CAChEl/B,MAAOw+F,EAAK1vF,KACZ8/C,SAAU4vC,EAAKj5F,OAEnB27C,EAAe18C,MAAMmhB,EAAShU,GAGhC,SAAgB0tF,GACdb,EACAt9C,EACAliB,OAEMC,EAAYD,EAAgBC,UAC5BttB,EAAQstB,EAAUC,QAAQ,wCAC1BvZ,EAAUsZ,EAAUC,QAAQ,sCAAuC,CACrEl/B,MAAOw+F,EAAK1vF,KACZ8/C,SAAU4vC,EAAKj5F,OAEnB27C,EAAe18C,MAAMmhB,EAAShU,GAGhC,SAAgB2tF,GAAiBd,GAC/B,OAAOA,EAAK1vF,KAAKvE,MAAM,KAAKmT,MAAM1O,cAGpC,SAAgByvF,GAA0BD,GACxC,OAAOA,EAAK1vF,KAAK8O,OAAO,EAAG4gF,EAAK1vF,KAAKirD,YAAY,cCrOjDwlC,GAAArgG,UAAAsgG,UAAA,SACEhB,EACA5rD,EACAZ,GAEA,YAHA,IAAAY,IAAAA,EAAA,kBACA,IAAAZ,IAAAA,EAAA,aAEOlyC,KAAK2/F,YAAYjB,EAAM5rD,EAAcZ,IAGtCutD,GAAArgG,UAAAwgG,gBAAR,SACElB,OAOMmB,EAAYL,GAAiBd,GAC7B5vC,EAAW4vC,EAAKj5F,KAChBq6F,EAAgBn7F,GACjB86F,GAAcK,iBACdL,GAAcM,qBAEbC,EAAoBP,GAAcO,kBAExC,OACEF,EAAiB9uF,QAAQ89C,GAAY,GACrCkxC,EAAkBhvF,QAAQ6uF,GAAa,EAEhCp4F,UAEM,qBAAbqnD,GACwD,GAAxD,CAAC,OAAQ,UAAW,MAAO,OAAO99C,QAAQ6uF,GAEnC7/F,KAAKigG,WACHjgG,KAAK07F,UAAYj0F,UACnBzH,KAAKkgG,mBAGPz4F,WAGDg4F,GAAArgG,UAAAugG,YAAR,SACEjB,EACA5rD,EACAZ,GAHF,IAAAvnC,EAAA3K,KAmBE,OAAO,IAAIqY,GAAAA,WAdG,SAAIkjF,GAChB,GAAImD,EAAKtiF,MAAQzR,EAAKw1F,sBACpB5E,EAAS72F,MAAM,IAAI+4F,QADrB,KAIM2C,EAAWz1F,EAAKi1F,gBAAgBlB,GAClC0B,IAAa34F,UAKjB24F,EAASp9F,KAAK2H,EAAM+zF,EAAMnD,EAAUzoD,EAAcZ,GAJhDqpD,EAAS72F,MAAM,IAAI44F,QAUjBmC,GAAArgG,UAAA6gG,WAAR,SACEvB,EACAnD,EACAzoD,EACAZ,GAJF,IAAAvnC,EAAA3K,KAMQqgG,EAAS,IAAIC,WAEnBD,EAAOpyE,OAAM,SAAI5N,GACf,QACQ1H,EAAWhO,EAAK41F,sBACpB7B,EACAr+E,EAAMjd,OAAOooD,OACb1Y,EACAZ,GAEFqpD,EAASn3F,KAAKuU,GACd,MAAOpU,GACPg3F,EAAS72F,MAAM,IAAI64F,IAGrBhC,EAASriF,YAGXmnF,EAAOpgF,QAAO,SAAGugC,GACf+6C,EAAS72F,MAAM,IAAI64F,KAGrB8C,EAAOG,WAAW9B,EAAM,UAGlBe,GAAArgG,UAAA8gG,mBAAR,SACExB,EACAnD,EACAzoD,EACAZ,GAJF,IAAAvnC,EAAA3K,KAMQP,EAASO,KAAK07F,QAAO,WACrB+E,EAAW,IAAIC,SACrBD,EAASE,OAAO,SAAUjC,GAC1B+B,EAASE,OAAO,YAAa7tD,GAC7B2tD,EAASE,OAAO,YAAazuD,GAC7BuuD,EAASE,OAAO,eAAgB,WAChCF,EAASE,OAAO,eAAgB,IAEhC3gG,KAAKkY,KAAK20D,KAAKptE,EAAKghG,EAAU,CAAEG,QAAS,IAAIC,GAAAA,cAAiBlpF,UAAS,SACpE2X,GACC,GAAiB,OAAbA,EAMJ,GAAoB,GADL,EAAkBwxE,QAAU,IAChC/9F,OACTw4F,EAAS72F,MAAM,IAAI64F,QACd,KACC5kF,EAAWhO,EAAKo2F,yBACpBrC,EACApvE,EACA4iB,GAEFqpD,EAASn3F,KAAKuU,GACd4iF,EAASriF,gBAdTqiF,EAAS72F,MAAM,IAAI64F,KAgBtB,SACA74F,GACCA,EAAMA,MAAMwpD,QAAS,MACf8yC,EAASt8F,EAAMA,MAAMu8F,KAAO,GACnB,yBAAXD,EACFzF,EAAS72F,MAAM,IAAI44F,IAEnB0D,EAAOE,UAAU,6CAEjB3F,EAAS72F,MAAM,IAAIg5F,IAEnBnC,EAAS72F,MAAM,IAAI64F,OAMnBkC,GAAArgG,UAAAmhG,sBAAR,SACE7B,EACA1gF,EACA80B,EACAZ,OAOI/qC,EALE04F,EAAYL,GAAiBd,GAC7B5vC,EAAW4vC,EAAKj5F,KAEhB07F,EAAU,IAAIx5F,GAAAA,QAGpB,GAAiB,yCAAbmnD,EACF3nD,EAAS,IAAIi6F,GAAAA,SACR,GAAiB,wBAAbtyC,EACT3nD,EAAS,IAAIk6F,GAAAA,SACR,GAAiB,wBAAbvyC,EACT3nD,EAAS,IAAIm6F,GAAAA,SAEb,OAAQzB,GACN,IAAK,MACH14F,EAAS,IAAIi6F,GAAAA,IACb,MACF,IAAK,MACHj6F,EAAS,IAAIm6F,GAAAA,IACb,MACF,IAAK,MACHn6F,EAAS,IAAIk6F,GAAAA,IACb,MACF,QACEl6F,EAASg6F,EAmBf,OAdmBh6F,EAAOyR,aAAaoF,EAAM,CAC3C9Q,eAAgB4lC,EAChB3lC,kBAAmB+kC,IAEO1/B,IAAG,SAAE8iB,GAC/B,OAAOx1B,OAAO2C,OAAO0+F,EAAQI,mBAAmBjsE,GAAY,CAC1D3M,WAAYupB,EACZQ,KAAM,CACJ7rC,GAAIT,GAAAA,OACJyL,MAAO8sF,GAA0BD,SAQjCe,GAAArgG,UAAA2hG,yBAAR,SACErC,EACA1gF,EACAk0B,OAEMkB,EAAW,IAAIzrC,GAAAA,QAYrB,OAXmByrC,EAASx6B,aAAaoF,GACbxL,IAAG,SAAE8iB,GAC/B,OAAOx1B,OAAO2C,OAAO2wC,EAASmuD,mBAAmBjsE,GAAY,CAC3D3M,WAAYupB,EACZQ,KAAM,CACJ7rC,GAAIT,GAAAA,OACJyL,MAAO8sF,GAA0BD,SAxOlCe,GAAAK,iBAAmB,CACxB,sBACA,uCACA,sBACA,oBAGKL,GAAAM,oBAAsB,CAC3B,kBACA,+BACA,qBAGKN,GAAAO,kBAAoB,CAAC,UAAW,MAAO,MAAO,OAAQ,4BAjB9DtgG,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDApBL8Z,GAAAA,kBAEAyqC,GAAAA,kLAuCP,SAAAs7C,GAAoBvnF,EAA0BiF,GAA1Bnd,KAAAkY,KAAAA,EAA0BlY,KAAAmd,OAAAA,EAC5Cnd,KAAK07F,QAAU17F,KAAKmd,OAAOinC,UAAU,wBAC/Bo9C,EAAmBxhG,KAAKmd,OAAOinC,UAAU,wCAC/CpkD,KAAKmgG,uBAAyBqB,GAAsC,IAAO5mF,KAAK6B,IAAI,KAAM,GC7C9F,IAAAglF,IAoBSA,GAAAriG,UAAAg/F,aAAP,SAAoB/6F,GAClB,OAAOsO,GAAAA,YAAY+vF,QAAQ1hG,KAAK2hG,UAAWt+F,IAMtCo+F,GAAAriG,UAAAmuC,KAAP,SAAYhtC,GAAZ,IAAAoK,EAAA3K,KACQ4hG,EAAgBrhG,EAAQshC,YAAW,GACzC,IAAKthC,EAAQshG,KAEX,OADA7hG,KAAK2hG,UAAYC,GACV,MAGH1pF,EAAOlY,KAAK8hG,SAAS3pF,IAAIuB,GAAAA,YAE/B,OAAO,IAAIqoF,QAAO,SAAEL,EAASM,GAC3B9pF,EACGC,IAAI5X,EAAQshG,MACZz2E,KACCiiC,GAAAA,WAAU,SAAE3oD,GAGV,OAFAuM,QAAQC,IAAI,kBAAkB3Q,EAAQshG,KAAI,sBAC1CH,GAAQ,GACDO,GAAAA,WAAWv9F,EAAMA,OAAS,mBAGpCiT,UAAS,SAACuqF,GACTv3F,EAAKg3F,UAAYhwF,GAAAA,YAAYiK,UAAUgmF,EAAeM,GACtDR,GAAQ,6BAvCjBhiG,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAVOuiG,GAAAA,+IAenB,SAAAV,GAAoBK,GAAA9hG,KAAA8hG,SAAAA,EAFZ9hG,KAAA2hG,UAAoB,WC0F5BS,GAAAhjG,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKmlD,SAAWnlD,KAAKwS,IAAI0oB,QAAQvjB,UAAS,SAAEhS,GAC1CgF,EAAK03F,kBAAkBj+F,KACrBuB,EAAOqE,OAAM,SAAE1J,GACb,OACGA,aAAiB0vB,KAAoC,IAArB1vB,EAAM4vB,YACtC5vB,EAAM2oB,WAAW1oB,QAAQ4W,UACxB7W,EAAM2oB,WAAW1oB,QAAQ4W,SAAS1X,aAKtC+hG,EAAmBxhG,KAAKmd,OAAOinC,UACnC,wCAEFpkD,KAAKmgG,uBACFqB,GAAsC,IAAM5mF,KAAK6B,IAAI,KAAM,GAC9Dzc,KAAKsiG,WAAatiG,KAAKmgG,sBAAwBvlF,KAAK6B,IAAI,KAAM,GAE9Dzc,KAAKuiG,gBAAkBviG,KAAKwiG,eACzBp3E,KAAKq3E,GAAAA,UAAS,SAAEC,GAAkB,OAACA,KACnC/qF,UAAS,SAAE+qF,GACV/3F,EAAKuxF,KAAKyG,WAAWD,EAAe,CAAEE,WAAW,IAC7CF,EAAcpiG,OAChBqK,EAAKk4F,eACHH,EAAcpiG,MAAMkS,IAAG,SAAEmxB,GAAM,OAAAh5B,EAAK6H,IAAIyqC,aAAatZ,QAK7D3jC,KAAK8iG,YAAc9iG,KAAKk8F,KACrB/jF,IAAI,SACJ03D,aAAal4D,UAAS,SAAE0H,GACvB1U,EAAKo4F,+BACCp9F,EAAS0Z,EAAQ7M,IAAG,SAAEmxB,GAAM,OAAAh5B,EAAK6H,IAAIyqC,aAAatZ,KACxDh5B,EAAKk4F,eAAel9F,IAIjB,IADD7F,OAAOk4B,KAAKrtB,EAAKq4F,SAAS9iG,OAAO8Q,QAAQrG,EAAKuxF,KAAKh8F,MAAMiH,SAGzDwD,EAAKuxF,KAAKyG,WAAW,CAAEx7F,OAAQM,YAGjCkD,EAAKs4F,SAAS7+F,MAAK,OACb8+F,EAKA,GACNv9F,EAAOkF,QAAO,SAAEvK,GAEZA,aAAiB0vB,IAC4B,IAA7C1vB,EAAM2oB,WAAWniB,GAAG+lC,cAAc9pC,SAElCmgG,EAAcz+F,KAAK,CACjBoC,GAAIvG,EAAMuG,GACVwW,QAAS/c,EAAM+c,QACfiM,QAAShpB,EAAMgpB,QACf6Q,UAAW,EAAeA,YAE5B75B,EAAMgpB,QAAU,EAChBhpB,EAAM+c,SAAU,KAIpB1S,EAAKw4F,oBAAoB/+F,KAAK8+F,GAC9Bv+D,WAAU,WACRh6B,EAAKs4F,SAAS7+F,MAAK,IAClB,OAGPpE,KAAKojG,UAAYpjG,KAAKgjG,SACnB53E,KAAKq3E,GAAAA,UAAS,SAAEY,GAAY,OAACA,KAC7B1rF,UAAS,SAAE0rF,GAC0B,IAAhCvjG,OAAOk4B,KAAKqrE,GAAStgG,QACvB4H,EAAKuxF,KAAKyG,WAAW,CAAEx7F,OAAQk8F,EAAQvjG,OAAOk4B,KAAKqrE,GAAS,QAIlErjG,KAAKsjG,mBAAqBtjG,KAAKqiG,kBAC5Bj3E,KAAKq3E,GAAAA,UAAS,SAAE98F,GAAW,OAACA,KAC5BgS,UAAS,SAAEhS,GACY,IAAlBA,EAAO5C,QACT4H,EAAKuxF,KAAKyG,WAAW,CAAEriG,MAAOqF,EAAO,GAAGkB,QAKhDu7F,GAAAhjG,UAAAs0B,YAAA,WACE1zB,KAAKmlD,SAASz6B,cACd1qB,KAAKsjG,mBAAmB54E,cACxB1qB,KAAKojG,UAAU14E,cACf1qB,KAAK8iG,YAAYp4E,cACb1qB,KAAKuiG,iBACPviG,KAAKuiG,gBAAgB73E,cAEvB1qB,KAAKujG,oBAAoBzmE,KAAK98B,KAAKk8F,KAAKh8F,OACxCF,KAAK+iG,4BAGCX,GAAAhjG,UAAA2jG,yBAAR,WAAA,IAAAp4F,EAAA3K,KACQkjG,EAAgBljG,KAAKmjG,oBAAoBjjG,MAC3CgjG,GAAiBA,EAAcngG,QACjCmgG,EAAcr4F,QAAO,SAAE24F,OACfp/D,EAAgBz5B,EAAK6H,IAAIyqC,aAAaumD,EAAM38F,IAClDu9B,EAAc/mB,QAAUmmF,EAAMnmF,QAC9B+mB,EAAc9a,QAAUk6E,EAAMl6E,QAC9B,EAAuB6Q,UAAYqpE,EAAMrpE,YAG7Cn6B,KAAKmjG,oBAAoB/+F,KAAKqD,YAGhC26F,GAAAhjG,UAAAqkG,YAAA,SAAYC,GAAZ,QAAA/4F,EAAA3K,KACM2jG,EAAY3jG,KAAK2jG,UACjB3jG,KAAK4jG,cAAcx6F,KAAKu6F,KAC1BA,EAAY,QAAQA,GAGtB3jG,KAAKijG,SAAS7+F,MAAK,kBACRs6F,GACTx6D,EAAK2/D,cAAcnE,UAAOhB,EAAMiF,GAAWhsF,UAAS,SACjDgB,GAAwB,OAAAhO,EAAKm5F,oBAAoBpF,EAAM/lF,IAAS,SAChEjU,GAAiB,OAAAiG,EAAKo5F,kBAAkBrF,EAAMh6F,IAAM,WAEnDiG,EAAKs4F,SAAS7+F,MAAK,iBALzB,IAAmB,IAAA4/F,EAAAxmF,GAAAkmF,GAAKO,EAAAD,EAAA5/F,QAAA6/F,EAAA5/F,KAAA4/F,EAAAD,EAAA5/F,SAAT6/F,EAAA/jG,6GAWjBkiG,GAAAhjG,UAAA8kG,uBAAA,SAAuBlmF,GAAvB,IAAArT,EAAA3K,KACEA,KAAKijG,SAAS7+F,MAAK,GACnB4Z,EAAK1d,MAAMuK,QAAO,SAAEvK,OACZmjC,EAAM94B,EAAK6H,IAAIyqC,aAAa38C,GAC9B6jG,EAAW1gE,EAAI5xB,MACfmM,EAAKhP,OAASvH,YAChB08F,EAAWnmF,EAAKhP,UAgBd49B,EAdEw3D,EAA+B3gE,EAAIxa,WAAW1oB,QAElDyd,EAAK7W,SAAW0zF,GAAanrE,KAC7B00E,EAAUjtF,UACVitF,EAAUjtF,SAAS1X,IAEnBklC,WAAU,WAERnlC,OAAOH,KAAK+kG,EAAUjtF,SAAS1X,IAAK,UACpCkL,EAAKs4F,SAAS7+F,MAAK,IAClB,MAMHwoC,EADE5uB,EAAKqmF,mBACM5gE,EAAIxa,WAAWniB,GAAGsqC,oBAC7B3N,EAAIjxB,IAAIgY,eAAerO,aAGZsnB,EAAIxa,WAAWniB,GAAG+lC,cAE7BpJ,EAAIxa,sBAAsB7H,KAC5BwrB,EAAaA,EAAW03D,QAAO,SAAEC,GAC/B,OAAAA,EAAQpsF,IAAI,eAIhBxN,EAAK65F,cACFvL,UAAOrsD,EAAY5uB,EAAK7W,OAAQg9F,EAAUx5F,EAAK6H,IAAImW,YACnDhR,UAAS,aACA,SACPjT,GAAiB,OAAAiG,EAAK85F,kBAAkB//F,IAAM,WAE7CiG,EAAK+5F,sBACL/5F,EAAKs4F,SAAS7+F,MAAK,SAMrBg+F,GAAAhjG,UAAAulG,UAAR,WACM3kG,KAAK4kG,YACP5kG,KAAKk8F,KAAOl8F,KAAK6kG,YAAYvzF,MAAM,CACjCnK,OAAQ,CAAC,GAAI,CAAC29F,GAAAA,WAAWC,WACzBzkG,MAAO,CAAC,GAAI,CAACwkG,GAAAA,WAAWC,WACxBV,mBAAoB,EAAC,EAAO,CAACS,GAAAA,WAAWC,WACxC/1F,KAAM,CAAC,GAAI,CAAC81F,GAAAA,WAAWC,aAGzB/kG,KAAKk8F,KAAOl8F,KAAK6kG,YAAYvzF,MAAM,CACjCnK,OAAQ,CAAC,GAAI,CAAC29F,GAAAA,WAAWC,WACzBzkG,MAAO,CAAC,GAAI,CAACwkG,GAAAA,WAAWC,WACxBV,mBAAoB,EAAC,EAAO,CAACS,GAAAA,WAAWC,cAKtC3C,GAAAhjG,UAAA0kG,oBAAR,SAA4BpF,EAAY/lF,GACjC3Y,KAAKmd,OAAOinC,UAAU,mBASzBq6C,GACEC,EACA/lF,EACA3Y,KAAKwS,IACLxS,KAAKohD,eACLphD,KAAKk/B,gBACLl/B,KAAKk+F,iBACLl+F,KAAK2zD,cAfP8qC,GACEC,EACA/lF,EACA3Y,KAAKwS,IACLxS,KAAKohD,eACLphD,KAAKk/B,kBAeHkjE,GAAAhjG,UAAA2kG,kBAAR,SAA0BrF,EAAYh6F,GACpC1E,KAAKijG,SAAS7+F,MAAK,GACnB06F,GACEJ,EACAh6F,EACA1E,KAAKohD,eACLphD,KAAKk/B,gBACLl/B,KAAKsiG,aAIDF,GAAAhjG,UAAAqlG,kBAAR,SAA0B//F,GACxB1E,KAAKijG,SAAS7+F,MAAK,GACnBs2F,GAAsBh2F,EAAO1E,KAAKohD,eAAgBphD,KAAKk/B,kBAGjDkjE,GAAAhjG,UAAA4lG,WAAR,WACMhlG,KAAKmd,OAAOinC,UAAU,8BAAgC38C,YACxDzH,KAAK4kG,YAAc5kG,KAAKmd,OAAOinC,UAAU,6BAE3CpkD,KAAK6iG,kBAGCT,GAAAhjG,UAAAyjG,eAAR,SAAuBl9F,GACrB,GAAIA,GAAUA,EAAO5C,OAArB,KACQkiG,EAAc,CAClBC,SAAS,EACTC,YAAY,EACZC,cAAc,GAsBhB,GApBAz/F,EAAOkF,QAAO,SAAEvK,GACTA,IAIDA,aAAiB0vB,KACnB1vB,EAAM2oB,WAAW1oB,QAAQ4W,WACzB7W,EAAM2oB,WAAW1oB,QAAQ4W,SAAS1X,IAIlCa,EAAM2oB,WAAW1oB,QAAQ4W,UACzB7W,EAAM2oB,WAAW1oB,QAAQ4W,SAAS1X,IAElCwlG,EAAYG,cAAe,EAClB9kG,aAAiB0vB,KAC1Bi1E,EAAYE,YAAa,GAPzBF,EAAYC,SAAU,MAWE,IAAxBD,EAAYC,UAA+C,IAA3BD,EAAYE,WAC9CnlG,KAAKgjG,SAAS5+F,KAAK02F,GAAAA,QAAQ,CAAC,cACvB,IACsB,IAA3BmK,EAAYE,aACY,IAAxBF,EAAYC,SAGZ,GADAllG,KAAK6iG,iBACDhI,GAAanrE,OAAO1vB,KAAKgjG,SAAS9iG,MAAO,KACrC83B,EAAOl4B,OAAOk4B,KAAKh4B,KAAKgjG,SAAS9iG,OAAO8J,OAAM,SACjD3G,GAAQ,MAAQ,QAARA,IAEXrD,KAAKgjG,SAAS5+F,KAAK02F,GAAAA,QAAQ9iE,UAGA,IAA7BitE,EAAYG,eACY,IAAxBH,EAAYC,UACe,IAA3BD,EAAYE,YAEZnlG,KAAK6iG,iBACChI,GAAanrE,OAAO1vB,KAAKgjG,SAAS9iG,SAChC83B,EAAOl4B,OAAOk4B,KAAKh4B,KAAKgjG,SAAS9iG,QAClCuE,KAAK,OACVzE,KAAKgjG,SAAS5+F,KAAK02F,GAAAA,QAAQ9iE,OAG7Bh4B,KAAKgjG,SAAS5+F,KAAK,IACnBpE,KAAKohD,eAAe43C,MAClBh5F,KAAKk/B,gBAAgBC,UAAUC,QAC7B,gCAEFp/B,KAAKk/B,gBAAgBC,UAAUC,QAC7B,wCAOR,GAAIp/B,KAAKmd,OAAOinC,UAAU,0BAA4B38C,UAAW,KACzD49F,EAAsBrlG,KAAKslG,mBAC/BtlG,KAAKmd,OAAOinC,UAAU,yBAExBpkD,KAAKgjG,SAAS5+F,KAAK02F,GAAAA,QAAQuK,SAE3BrlG,KAAKgjG,SAAS5+F,KAAKy2F,KAIfuH,GAAAhjG,UAAAkmG,mBAAR,SAA2BjC,GACzB,OAAOA,EACJr5F,OAAM,SAAE7C,GACP,GACEA,EAAOkxB,gBAAkBwiE,GAAaqC,SAAS7kE,eAC/ClxB,EAAOkxB,gBAAkBwiE,GAAasC,aAAa9kE,eACnDlxB,EAAOkxB,gBAAkBwiE,GAAakC,IAAI1kE,eAC1ClxB,EAAOkxB,gBAAkBwiE,GAAaM,IAAI9iE,eAC1ClxB,EAAOkxB,gBAAkBwiE,GAAasG,QAAQ9oE,eAC9ClxB,EAAOkxB,gBAAkBwiE,GAAamC,IAAI3kE,eAC1ClxB,EAAOkxB,gBAAkBwiE,GAAaoC,UAAU5kE,eAChDlxB,EAAOkxB,gBAAkBwiE,GAAanrE,IAAI2I,cAE1C,OAAOlxB,IAGVqL,IAAG,SAAErL,GACJ,OAAIA,EAAOkxB,gBAAkBwiE,GAAaqC,SAAS7kE,cACjDlxB,EAAS0zF,GAAaqC,SAGpB/1F,EAAOkxB,gBAAkBwiE,GAAasC,aAAa9kE,cACrDlxB,EAAS0zF,GAAasC,aAGpBh2F,EAAOkxB,gBAAkBwiE,GAAakC,IAAI1kE,cAC5ClxB,EAAS0zF,GAAakC,IAGpB51F,EAAOkxB,gBAAkBwiE,GAAaM,IAAI9iE,cAC5ClxB,EAAS0zF,GAAaM,IAGpBh0F,EAAOkxB,gBAAkBwiE,GAAasG,QAAQ9oE,cAChDlxB,EAAS0zF,GAAasG,QAGpBh6F,EAAOkxB,gBAAkBwiE,GAAamC,IAAI3kE,cAC5ClxB,EAAS0zF,GAAamC,IAGpB71F,EAAOkxB,gBAAkBwiE,GAAaoC,UAAU5kE,cAClDlxB,EAAS0zF,GAAaoC,UAIpB91F,EAAOkxB,gBAAkBwiE,GAAanrE,IAAI2I,cAC5ClxB,EAAS0zF,GAAanrE,SADxB,KAOC0yE,GAAAhjG,UAAAmmG,WAAP,SAAkBC,GAChBxlG,KAAKylG,iBAAiB3oE,KAAK0oE,EAAIz0F,QAGzBqxF,GAAAhjG,UAAAslG,oBAAR,WACE9J,GAAwB56F,KAAKohD,eAAgBphD,KAAKk/B,kBAGpDkjE,GAAAhjG,UAAAsmG,qBAAA,SAAqBrlF,GACnBrgB,KAAK2lG,mBAAqBtlF,EAAMngB,4BA7bnCM,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,oBACVC,SAAA,+hKAZO++F,UADA1E,UAjBgB/6D,GAAAA,uBAAhBgiB,GAAAA,sBAwBAy/C,UADAlrE,UA1BWqvE,GAAAA,mBAGsBzhD,GAAAA,+CA+DvCrjD,GAAAA,6BAEAA,GAAAA,gCAEAs8B,GAAAA,+BAEAt8B,GAAAA,mCAIAs8B,GAAAA,UAkZHglE,IAhZE,SAAAA,GACUyB,EACAW,EACAtlE,EACAkiB,EACA88C,EACAvqC,EACAkxC,EACA1nF,GAPAnd,KAAA6jG,cAAAA,EACA7jG,KAAAwkG,cAAAA,EACAxkG,KAAAk/B,gBAAAA,EACAl/B,KAAAohD,eAAAA,EACAphD,KAAAk+F,iBAAAA,EACAl+F,KAAA2zD,aAAAA,EACA3zD,KAAA6kG,YAAAA,EACA7kG,KAAAmd,OAAAA,EAhDHnd,KAAAgjG,SAAW,IAAI/3E,GAAAA,gBAAgBxjB,WAC/BzH,KAAAqiG,kBAAiD,IAAIp3E,GAAAA,gBAC1D,IAEKjrB,KAAA2jG,UAAoB,YACpB3jG,KAAAijG,SAAW,IAAIh4E,GAAAA,iBAAgB,GAC/BjrB,KAAA4kG,aAAc,EAQb5kG,KAAA4jG,cAAgB,IAAI9vF,OAAO,aAE5B9T,KAAA2lG,mBAA6B,SAG5B3lG,KAAAmjG,oBAOJ,IAAIl4E,GAAAA,gBAAgBxjB,WAIfzH,KAAA6lG,cAAwB,EAEvB7lG,KAAAylG,iBAAmB,IAAIjoE,GAAAA,aAExBx9B,KAAAwiG,eAAiD,IAAIv3E,GAAAA,gBAC5DxjB,WAGQzH,KAAAujG,oBAAsB,IAAI/lE,GAAAA,aAYlCx9B,KAAKglG,aACLhlG,KAAK2kG,YACL1zF,QAAQC,IAAIlR,MACZiR,QAAQC,IAAIlR,KAAKk8F,MACjBjrF,QAAQC,IAAIlR,KAAKk8F,iBClFqBl1F,GAAAA,MAAA8+F,GAAAA,sBAOxChmG,OAAAC,eAAIgmG,GAAA3mG,UAAA,MAAG,KAAP,WACE,OAAOY,KAAKu0B,UAAU/hB,qCAexBuzF,GAAA3mG,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKgmG,eAAiBhmG,KAAKimG,aAAatuF,UAAS,SAAE+rF,GACjD/4F,EAAKu7F,eAAexC,MAIxBqC,GAAA3mG,UAAAs0B,YAAA,WACE1zB,KAAKgmG,eAAet7E,eAIfq7E,GAAA3mG,UAAA+mG,WADP,SACkB3lD,GAChBlpC,GAAAlY,UAAM+mG,WAAUnjG,KAAAhD,KAACwgD,IAIZulD,GAAA3mG,UAAAgnG,YADP,SACmB5lD,GACjBlpC,GAAAlY,UAAMgnG,YAAWpjG,KAAAhD,KAACwgD,IAIbulD,GAAA3mG,UAAAinG,OADP,SACc7lD,GACZlpC,GAAAlY,UAAMinG,OAAMrjG,KAAAhD,KAACwgD,IAGPulD,GAAA3mG,UAAA8mG,eAAR,SAAuBxC,GAAvB,QAAA/4F,EAAA3K,gBACa0+F,GACTx6D,EAAK2/D,cACFnE,UAAOhB,GACP/mF,UAAS,SACPgB,GAAwB,OAAAhO,EAAKm5F,oBAAoBpF,EAAM/lF,IAAS,SAChEjU,GAAiB,OAAAiG,EAAKo5F,kBAAkBrF,EAAMh6F,iBALrD,IAAmB,IAAAs/F,EAAAxmF,GAAAkmF,GAAKO,EAAAD,EAAA5/F,QAAA6/F,EAAA5/F,KAAA4/F,EAAAD,EAAA5/F,SAAT6/F,EAAA/jG,6GAUT6lG,GAAA3mG,UAAA0kG,oBAAR,SAA4BpF,EAAY/lF,GACjC3Y,KAAKmd,OAAOinC,UAAU,mBAGzBq6C,GAAwBC,EAAM/lF,EAAU3Y,KAAKwS,IAAKxS,KAAKohD,eAAgBphD,KAAKk/B,gBACnDl/B,KAAKk+F,iBAAkBl+F,KAAK2zD,cAHrD8qC,GAAwBC,EAAM/lF,EAAU3Y,KAAKwS,IAAKxS,KAAKohD,eAAgBphD,KAAKk/B,kBAOxE6mE,GAAA3mG,UAAA2kG,kBAAR,SAA0BrF,EAAYh6F,GACpCo6F,GAAsBJ,EAAMh6F,EAAO1E,KAAKohD,eAAgBphD,KAAKk/B,gBAAiBl/B,KAAKmd,OAAOinC,UAAU,+DAxEvGxvB,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,iEAPHyyB,UACAusE,UANgBz/D,GAAAA,uBAShByhE,UADAlrE,UARiC4tB,GAAAA,qBAAjCnC,GAAAA,uDA+CNskD,GAAAA,aAAY3mG,KAAA,CAAC,WAAY,CAAC,gCAK1B2mG,GAAAA,aAAY3mG,KAAA,CAAC,YAAa,CAAC,2BAK3B2mG,GAAAA,aAAY3mG,KAAA,CAAC,OAAQ,CAAC,cA4BzBomG,IA5DE,SAAAA,GACUxxE,EACAsvE,EACA3kE,EACAg/D,EACAvqC,EACAx2C,EACAikC,GAPV,IAAAz2C,EASE2M,GAAAtU,KAAAhD,OAAOA,YARC2K,EAAA4pB,UAAAA,EACA5pB,EAAAk5F,cAAAA,EACAl5F,EAAAu0B,gBAAAA,EACAv0B,EAAAuzF,iBAAAA,EACAvzF,EAAAgpD,aAAAA,EACAhpD,EAAAwS,OAAAA,EACAxS,EAAAy2C,eAAAA,EAhBAz2C,EAAAs7F,aAAqC,IAAIzoE,GAAAA,aACzC7yB,EAAA47F,aAAqC,IAAI/oE,GAAAA,eChBrD,IAAWgpE,GAAoB,IAAIC,GAAAA,eAAiC,oBAEpE,SAAgBC,GAAwBnmG,GACtC,MAAO,CACLi5F,QAASgN,GACT9M,SAAUn5F,GAId,SAAgBomG,GACdzI,EACA39F,GAEA,OAAA,WAAa,OAAA29F,EAAiB3wD,KAAKhtC,IAGrC,SAAgBqmG,KACd,MAAO,CACLpN,QAASqN,GAAAA,gBACTC,WAAYH,GACZI,OAAO,EACPC,KAAM,CAACvF,GAAkB+E,KC1B7B,IAAAS,IASSA,GAAAjmG,QAAP,WACE,MAAO,CACLC,SAAUgmG,GACV/lG,UAAW,CAACwlG,GAAwB,IAAKE,6BAT9CzlG,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,GACTO,aAAc,GACdD,QAAS,OASXulG,IAZA,SAAAA,MCHA,IAAAC,IAiDSA,GAAAlmG,QAAP,WACE,MAAO,CACLC,SAAUimG,0BA3Bf/lG,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPE,GAAAA,cACAE,GAAAA,iBACAwmE,GAAAA,YACA2e,GAAAA,oBACAtlF,GAAAA,aACAE,GAAAA,gBACAqlF,GAAAA,sBACAgT,GAAAA,cACAxxB,GAAAA,gBACA4xB,GAAAA,gBACAjyB,GAAAA,mBACAD,GAAAA,eACAK,GAAAA,qBACA1mE,GAAAA,kBACA0lG,GAAAA,iBACAh4B,GAAAA,kBACAi4B,GAAAA,kBACAH,GAAmBjmG,WAErBU,QAAS,CAAC0gG,GAAuB2D,GAAsBkB,GAAoB5M,IAC3E14F,aAAc,CAACygG,GAAuB2D,GAAsB1L,QAQ9D6M,IA9BA,SAAAA,MCxBA,IAAAG,yBAuBClmG,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAI,GAAAA,kBACA6lG,GAAAA,uBACAhmG,GAAAA,cACAC,GAAAA,gBACAC,GAAAA,kBAEFE,QAAS,CACPwxB,GACAmxB,GACAG,GACA0C,GACAjC,GACAkB,GACApF,GACA0D,GACAxC,GACAgB,IAEFthD,aAAc,CACZuxB,GACAmxB,GACAG,GACA0C,GACAjC,GACAkB,GACApF,GACA0D,GACAxC,GACAgB,QAGuBokD,IAlC3B,SAAAA,MCFA,IAAAE,IAiCEznG,OAAAC,eACIwnG,GAAAnoG,UAAA,UAAO,KAGX,WAAwB,OAAOY,KAAK4hF,SAAS1hF,WAJ7C,SACYA,GACVF,KAAK4hF,SAASx9E,KAAKlE,oCAOrBJ,OAAAC,eACIwnG,GAAAnoG,UAAA,OAAI,KACR,WAAsB,OAAOY,KAAKwnG,WAFlC,SACStnG,GAAkBF,KAAKynG,eAAevnG,oCAkB/CJ,OAAAC,eAAIwnG,GAAAnoG,UAAA,eAAY,KAAhB,WACE,OAAIY,KAAK4+E,cAAgBsC,GAAY1Q,KAC5B1wE,OAAOgY,OAAOw5D,IAEhBxxE,OAAOgY,OAAOg5D,qCASvBy2B,GAAAnoG,UAAAs0B,YAAA,WACE1zB,KAAKynG,gBAAe,IAOtBF,GAAAnoG,UAAAq3F,oBAAA,SAAoBzvE,GAClBhnB,KAAK02F,YAAc1vE,EACnBhnB,KAAK0nG,kBAAkB5qE,KAAK9V,IAGtBugF,GAAAnoG,UAAAqoG,eAAR,SAAuBnmE,GAAvB,IAAA32B,EAAA3K,KACMA,KAAK2nG,YAAclgG,WACrBzH,KAAK2nG,UAAUj9E,eAEF,IAAX4W,IACFthC,KAAK2nG,UAAY3nG,KAAK4hF,SAASjqE,UAAS,SAAE04D,GACxC1lE,EAAKi9F,uBAAuBv3B,MAGhCrwE,KAAKwnG,MAAQlmE,GAGPimE,GAAAnoG,UAAAwoG,uBAAR,SAA+Bv3B,OACzBqmB,EAAc12F,KAAK02F,YACnB12F,KAAK4+E,cAAgBsC,GAAY1Q,KACnCkmB,EAAc9jB,GAAoBvC,GACzBrwE,KAAK4+E,cAAgBsC,GAAY3Q,SAC1CmmB,EAAcjkB,GAAsBpC,IAElCqmB,IAAgB12F,KAAK02F,aACvB12F,KAAKy2F,oBAAoBC,yBA3G9Bl2F,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,oBACVC,SAAA,6lBAEAC,gBAAiBC,GAAAA,wBAAwBC,4VAmBxCC,GAAAA,2BAKAA,GAAAA,uBAKAA,GAAAA,oBASAA,GAAAA,2BAQAA,GAAAA,iCAKAs8B,GAAAA,UAuDHmqE,IA1CE,SAAAA,KAxDOvnG,KAAA4hF,SAAoC,IAAI32D,GAAAA,gBAAgBxjB,WAiCvDzH,KAAAwnG,OAAiB,EAUfxnG,KAAA0nG,kBAAoB,IAAIlqE,GAAAA,aCnDpC,IAAAqqE,yBAAC1mG,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAE,GAAAA,gBACAqlF,GAAAA,sBACAtlF,GAAAA,cACAE,GAAAA,iBACAumE,GAAAA,mBACAD,GAAAA,eACAM,GAAAA,gBACAD,GAAAA,qBACA1mE,GAAAA,kBACAqmG,GAAAA,sBAEFnmG,aAAc,CACZ4hF,GACAgkB,GACA1pB,GACAP,IAEF57E,QAAS,CACP6hF,GACA1F,IAEFiJ,gBAAiB,CACfxJ,QAG4BuqB,IA5BhC,SAAAA,MCzBA,IAAAE,yBAIC5mG,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,GACTO,aAAc,GACdD,QAAS,CACPmmG,QAG2BE,IAP/B,SAAAA,MCJA,IAAAC,IAUSA,GAAAhnG,QAAP,WACE,MAAO,CACLC,SAAU+mG,0BARf7mG,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,GACTM,QAAS,CAAC4yB,IACV3yB,aAAc,CAAC2yB,QAQjB0zE,IAXA,SAAAA,UCaMC,GAAcC,GAEpBC,IAaEA,GAAA/oG,UAAAgpG,MAAA,SAAM51F,EAAajS,GAAnB,IAAAoK,EAAA3K,KACQ6vB,EAAU,IAAIirB,GAAAA,QAEdutD,EAAsB9nG,EAAQ8nG,YAC9B7xF,GAAcjW,EAAQiW,WACtB8xF,EAAc/nG,EAAQ+nG,YAE5BtoG,KAAK6zB,WAAa7zB,KAAK2zB,gBAAgBG,eACjCy0E,EAAM,IAAIC,GAAM,CACpBF,YAAWA,EACXnhG,OAAQkhG,EAAYn5F,gBAGhBu5F,EAAa,CACjBF,EAAIG,SAASC,SAAS7yE,MACtByyE,EAAIG,SAASC,SAASv6E,QAGlBw6E,EAAU,CAAC,GAAI,GAAI,GAAI,IAGvBxsF,EAAO,CAFCqsF,EAAW,GAAKG,EAAQ,GAAKA,EAAQ,GACpCH,EAAW,GAAKG,EAAQ,GAAKA,EAAQ,IAqCpD,OAlCIroG,EAAQsR,QAAUpK,WACpBzH,KAAK6oG,SAASN,EAAKhoG,EAAQsR,MAAO42F,EAAW,KAGhB,IAA3BloG,EAAQuoG,iBAAiD,IAAtBvoG,EAAQwoG,WAC7C/oG,KAAKgpG,aACHT,EACA/1F,EACAgE,EACAjW,EAAQuoG,eACRvoG,EAAQwoG,WAGY,KAApBxoG,EAAQ+6F,SACVt7F,KAAKipG,WAAWV,EAAKhoG,EAAQ+6F,SAG/Bt7F,KAAKkpG,OAAOX,EAAK/1F,EAAKgE,EAAY4F,EAAMwsF,GAASjxF,UAAS,SACvDpH,GACKA,IAAWmc,GAAAA,cAAcK,QACA,IAAvBxsB,EAAQqiE,WACVj4D,EAAKw+F,UAAUZ,EAAK/1F,EAAKo2F,EAASpyF,GAElC7L,EAAKy+F,QAAQb,IAIbh4F,IAAWmc,GAAAA,cAAcK,MAAQxc,IAAWmc,GAAAA,cAAchlB,QAC5DiD,EAAKgpB,gBAAgBC,WAAWjpB,EAAKkpB,YACrChE,EAAQzrB,KAAKsoB,GAAAA,cAAcK,SAK1B8C,GASTs4E,GAAA/oG,UAAAiqG,oBAAA,SAAoB72F,EAAasjB,EAAetf,OAC1C7P,EAAO,GACLwmB,EAAUD,GACd1a,EAAI7M,OACJ6M,EAAIgY,eAAesU,SAAStoB,IAE9B,OAAuB,IAAnB2W,EAAQpqB,OACH4D,GAKTA,GAAQ,yCACRA,GAAQ,mCAAqCmvB,EAC7CnvB,GAAQ,8CACRA,GAAQ,WACRA,GAAQ,sCACRA,GAAQ,8CAAgDmvB,EAAQ,OAEhE3I,EAAQtiB,QAAO,SAAEpE,GACfE,GACE,mEACFA,GAAQ,yBAA2BF,EAAOoL,MAAQ,QAClDlL,GAAQ,0CAA4CF,EAAOhH,IAAM,KACjEkH,GAAQ,uBAEVA,GAAQ,WAUVwhG,GAAA/oG,UAAAkqG,qBAAA,SACE92F,EACArL,EACAoiG,EACA/yF,QAFA,IAAArP,IAAAA,EAAA,WAIM0oB,EAAU,IAAIirB,GAAAA,QAGhBn0C,EAAO3G,KAAKqpG,oBAAoB72F,EADtB,IACkCgE,GAC1CszE,EAAO9pF,KACbmH,EAASA,EAAO+H,cAGI,IAAhBvI,EAAK5D,SACP4D,EAAO,uCACPA,GAAQ,kDAGJ6iG,EAAMhqG,OAAO6tB,SAASC,cAAc,OAG1C9tB,OAAO6tB,SAAS6sC,KAAKkiC,YAAYoN,GACjCA,EAAIzmB,UAAYp8E,EAEhBg+B,WAAU,WACRsjE,GAAYuB,EAAK,CAAEC,SAAS,IACzBC,KAAI,SAACC,OACAp5F,EAASmc,GAAAA,cAAcK,KAC3B,IACOw8E,EAKHzf,EAAK8f,uBAAuBD,EAAQ,eAAsBxiG,GAH1D2iF,EAAK+f,sBAAsBF,EAAQ,cAAexiG,GAKpDqiG,EAAIM,WAAWhN,YAAY0M,GAC3B,MAAOl8C,GACP/8C,EAASmc,GAAAA,cAAchlB,MAEzBmoB,EAAQzrB,KAAKmM,KAEdw5F,SAAK,SAACxlG,GACL0M,QAAQC,IAAI3M,MAEf,MAGG4jG,GAAA/oG,UAAAypG,SAAR,SAAiBN,EAAY12F,EAAem4F,OAKtCC,EAFEC,EAAc,MAFE,GAEoCr4F,EAAM9O,OAI9DknG,EADeD,EAAbE,EACgB,GAECF,EAAYE,GAAc,EAG/C3B,EAAI4B,QAAQ,WACZ5B,EAAI6B,YAAY,IAChB7B,EAAIryE,KAAKrkB,EAAOo4F,EAAiB,KAS3B9B,GAAA/oG,UAAA6pG,WAAR,SAAmBV,EAAYjN,OAIvB+O,EAAe9B,EAAIG,SAASC,SAASv6E,OADtB,EAGrBm6E,EAAI4B,QAAQ,WACZ5B,EAAI6B,YANgB,IAOpB7B,EAAIryE,KAAKolE,EANiB,GAMW+O,IAU/BlC,GAAA/oG,UAAA4pG,aAAR,SACET,EACA/1F,EACA6I,EACAsN,EACAniB,OAEM24B,EAAYn/B,KAAKk/B,gBAAgBC,UAIjCkrE,EAAe9B,EAAIG,SAASC,SAASv6E,OADtB,GAGjBk8E,EAAwB,IACT,IAAf3hF,IAEF2hF,GADiBnrE,EAAUC,QAAQ,gCACP,KAAO5sB,EAAImW,aAE3B,IAAVniB,KACiB,IAAfmiB,IACF2hF,GAAiB,OAInBA,GAFkBnrE,EAAUC,QAAQ,2BAEP,WAAaxY,GADzBpU,EAAIgY,eAAesU,SAASzjB,KAG/CktF,EAAI4B,QAAQ,WACZ5B,EAAI6B,YAnBkB,IAoBtB7B,EAAIryE,KAAKo0E,EAnBmB,GAmBiBD,IASvClC,GAAA/oG,UAAA+pG,UAAR,SACEZ,EACA/1F,EACAo2F,EACApyF,GAJF,IAAA7L,EAAA3K,KAMQ8pF,EAAO9pF,KAEP81B,EAAQyyE,EAAIG,SAASC,SAAS7yE,MAC9BnvB,EAAO3G,KAAKqpG,oBAAoB72F,EAAKsjB,EAAOtf,GAElD,GAAa,KAAT7P,EAEF,OADA3G,KAAKopG,QAAQb,IACN,MAIHiB,EAAMhqG,OAAO6tB,SAASC,cAAc,OAC1C26E,GAAYuB,EAAK,CAAEC,SAAS,IACzBC,KAAI,SAACC,OACAY,EAGJA,EAAUZ,EAAOa,UAAU,aAC3BjC,EAAIkC,cACEC,EAAY//F,EAAKggG,qBAAqBpC,EAAKoB,EAAQf,GACzDL,EAAIqC,SAASL,EAAS,MAAO,GALZ,GAK0BG,EAAU,GAAIA,EAAU,IACnE5gB,EAAKsf,QAAQb,GACbiB,EAAIM,WAAWhN,YAAY0M,KAE5BO,SAAK,SAACxlG,GACL0M,QAAQC,IAAI3M,KAIhB/E,OAAO6tB,SAAS6sC,KAAKkiC,YAAYoN,GACjCA,EAAIzmB,UAAYp8E,GAGVwhG,GAAA/oG,UAAAyrG,UAAR,SACEtC,EACAoB,EACAf,OAEIr8E,EAIJ,IAFAA,EAAQo9E,EAAOa,UAAU,iBAEX/iG,UAAW,KACjBijG,EAAY1qG,KAAK2qG,qBAAqBpC,EAAKoB,EAAQf,GACzDL,EAAIqC,SACFr+E,EACA,OACAq8E,EAAQ,GACRA,EAAQ,GACR8B,EAAU,GACVA,EAAU,IAEZnC,EAAIuC,KAAKlC,EAAQ,GAAIA,EAAQ,GAAI8B,EAAU,GAAIA,EAAU,MAKrDvC,GAAA/oG,UAAA8pG,OAAR,SACEX,EACA/1F,EACAgE,EACA4F,EACAwsF,GALF,IAeMmC,EAfNpgG,EAAA3K,KAOQ6vB,EAAU,IAAIirB,GAAAA,QAEdkwD,EAAUx4F,EAAI1L,GAAG+tC,UACjB7rC,EAASwJ,EAAI1L,GAAG8rB,UAAUgmB,gBAAgBoyD,GAE1CC,EAAcrwF,KAAKiM,MAAOzK,EAAK,GAAK5F,EAAc,MAClD6zF,EAAezvF,KAAKiM,MAAOzK,EAAK,GAAK5F,EAAc,MA+DzD,OA3DAhE,EAAI1L,GAAGokG,KAAK,cAAa,SAAG7qF,OACpBspF,EAAStpF,EAAMsxC,QAAQg4C,OACvBwB,EAAc34F,EAAIqd,QAAQlY,UAAS,SAAEyzF,GAGzC,GAFAxoD,aAAamoD,GAETK,IAAc1+E,GAAAA,cAAcK,KAAhC,CAIAo+E,EAAYzgF,kBAERna,EAASmc,GAAAA,cAAcK,KAC3B,IACEpiB,EAAKkgG,UAAUtC,EAAKoB,EAAQf,GAC5B,MAAOt7C,GACP/8C,EAASmc,GAAAA,cAAchlB,MACvBiD,EAAKy2C,eAAe18C,MAClBiG,EAAKu0B,gBAAgBC,UAAUC,QAC7B,0CAEFz0B,EAAKu0B,gBAAgBC,UAAUC,QAC7B,4CAEF,SAIJz0B,EAAK0gG,UAAU74F,EAAKw4F,EAAShiG,GAC7B6mB,EAAQzrB,KAAKmM,MAKfw6F,EAAUvrG,OAAOmlC,WAAU,WACzBwmE,EAAYzgF,kBAERna,EAASmc,GAAAA,cAAcK,KAC3B,IACEpiB,EAAKkgG,UAAUtC,EAAKoB,EAAQf,GAC5B,MAAOt7C,GACP/8C,EAASmc,GAAAA,cAAchlB,MACvBiD,EAAKy2C,eAAe18C,MAClBiG,EAAKu0B,gBAAgBC,UAAUC,QAC7B,0CAEFz0B,EAAKu0B,gBAAgBC,UAAUC,QAC7B,4CAEF,SAIJz0B,EAAK0gG,UAAU74F,EAAKw4F,EAAShiG,GAC7B6mB,EAAQzrB,KAAKmM,IACZ,OAGLvQ,KAAKqrG,UAAU74F,EAAK,CAACy4F,EAAaZ,GAAerhG,GAE1C6mB,GAGTs4E,GAAA/oG,UAAAksG,sBAAA,SAAsBC,GACpBvrG,KAAKurG,gBAAkBA,GAezBpD,GAAA/oG,UAAAosG,iBAAA,SACEh5F,EACAgE,EACArP,EACAwhB,EACAniB,EACAC,EACAoL,EACAypF,EACAiO,GATF,IAAA5+F,EAAA3K,UAGE,IAAAmH,IAAAA,EAAA,YACA,IAAAwhB,IAAAA,GAAA,QACA,IAAAniB,IAAAA,GAAA,QACA,IAAAC,IAAAA,GAAA,QACA,IAAAoL,IAAAA,EAAA,SACA,IAAAypF,IAAAA,EAAA,SACA,IAAAiO,IAAAA,GAAA,OAEM15E,EAAU,IAAIirB,GAAAA,QAEpB96C,KAAK6zB,WAAa7zB,KAAK2zB,gBAAgBG,eACjCqL,EAAYn/B,KAAKk/B,gBAAgBC,UACvC3sB,EAAI1L,GAAGokG,KAAK,cAAa,SAAG7qF,GAC1BlZ,EAASA,EAAO+H,kBACVyiD,EAAUtxC,EAAMsxC,QAChB85C,EAAYp+E,SAASC,cAAc,UACnCF,EAAaq+E,EAAUl+E,WAAW,MAEpCm+E,EAAkB,EAElBC,EAAqB,GAEnB71E,EAAQ67B,EAAQg4C,OAAO7zE,MACzB1H,EAASujC,EAAQg4C,OAAOv7E,OAE5BhB,EAAWI,KAAO,mBACZo+E,EAAex+E,EAAWy+E,YAAYvQ,GAASxlE,MAErD1H,EAAmB,KAAVvc,EAAeuc,EAAS,GAAKA,MAGhC09E,GADN19E,GAAwB,IAAfzF,IAAkC,IAAVniB,EAAkB4nB,EAAS,GAAKA,GAC7B,GAE9B29E,EAAgBnxF,KAAKkO,KAAK8iF,EAAe91E,GAG3Ck2E,GADJ59E,EAAqB,KAAZktE,EAAiBltE,EAAyB,GAAhB29E,EAAqB39E,GACR,GAAhB29E,EAAqB,EAqBrD,GAnBAN,EAAU31E,MAAQA,EAClB21E,EAAUr9E,OAASA,EAEJ,SAAXjnB,IACFimB,EAAW6+E,UAAY,UACvB7+E,EAAW8+E,SAAS,EAAG,EAAGp2E,EAAO1H,GACjChB,EAAW6+E,UAAY,WAGX,KAAVp6F,IAEFub,EAAWI,KAAO,eAClBk+E,EAAkB,GAClBt+E,EAAWi7B,UAAY,SACvBj7B,EAAWc,SAASrc,EAAOikB,EAAQ,EAAG,OAGxC1I,EAAWI,KAAO,kBAEd7E,EAAsB,KAClBwjF,EAAWhtE,EAAUC,QAAQ,gCACnChS,EAAWi7B,UAAY,QACvBj7B,EAAWc,SACTi+E,EAAW,KAAO35F,EAAImW,WACtBgjF,EACAG,GAEFH,GAAsB,IAGxB,IAAc,IAAVnlG,EAAiB,KACb4lG,EAAYjtE,EAAUC,QAAQ,2BAC9BitE,EAAW75F,EAAIgY,eAAesU,SAAStoB,GAC7C4W,EAAWi7B,UAAY,QACvBj7B,EAAWc,SACTk+E,EAAY,WAAaxlF,GAAYylF,GACrCV,EACAG,GAIJ,GAAgB,KAAZxQ,EAGF,GAFAluE,EAAWi7B,UAAY,SAED,IAAlB0jD,EACF3+E,EAAWc,SAASotE,EAASxlE,EAAQ,EAAGk2E,QASxC,QANMM,EAAgBhR,EAAQv4F,OACxBwpG,EAAqB3xF,KAAKgjF,MAAM0O,EAAgBP,GAClDS,EAAqB,GACrBC,EAAuB,EACvBC,OAAiB,EAEZ9pG,EAAI,EAAGA,EAAImpG,EAAenpG,IAETA,EAApBmpG,EAAgB,GAOlBW,GALAF,EAAqBlR,EAAQx9E,OAC3B2uF,EACAF,IAGqCtyC,YAAY,KACnD7sC,EAAWc,SACTs+E,EAAmB1uF,OAAO,EAAG4uF,GAC7B52E,EAAQ,EACRk2E,GAEFS,GAAwBC,EAExBV,GAAoB,IAGpB5+E,EAAWc,SACTotE,EAAQx9E,OAAO2uF,GACf32E,EAAQ,EACRk2E,GAOV5+E,EAAWe,UAAUwjC,EAAQg4C,OAAQ,EAAG+B,OAEpCn7F,EAASmc,GAAAA,cAAcK,KAC3B,IAEOw8E,EAE+B,SAAzBpiG,EAAO+H,cAEhBvE,EAAKi/F,uBACH6B,EACA,MAAQj5F,EAAImW,WAAW5a,QAAQ,IAAK,KAAO,IAAM5G,GAInDwD,EAAKi/F,uBAAuB6B,EAAW,OAActkG,GATrDwD,EAAKk/F,sBAAsB4B,EAAW,MAAOtkG,GAW/C,MAAOmmD,GACP/8C,EAASmc,GAAAA,cAAchlB,MAKzB,GAFAmoB,EAAQzrB,KAAKmM,GAEgB,SAAzBpJ,EAAO+H,cAA0B,KAC7By9F,EAAahiG,EAAKiiG,wBAAwBp6F,GAC1C+c,EAAO,IAAIC,KAAK,CAACm9E,GAAa,CAClClnG,KAAM,6BAEH8jG,EAMH5+F,EAAKkiG,aACH,MAAQr6F,EAAImW,WAAW5a,QAAQ,IAAK,KAAO,OAC3CwhB,IANFu9E,GAAAA,OAAOv9E,EAAM,MAAQ/c,EAAImW,WAAa,QACtChe,EAAKoiG,yBAUXv6F,EAAI1L,GAAGkmG,cAGD7E,GAAA/oG,UAAAisG,UAAR,SAAkB74F,EAAK4J,EAAMpT,GAC3BwJ,EAAI1L,GAAGkmG,cAOC7E,GAAA/oG,UAAAgqG,QAAV,SAAkBb,GAChBA,EAAI0E,KAAK,YASH9E,GAAA/oG,UAAAurG,qBAAR,SAA6BpC,EAAKoB,EAAQf,OAElCsE,EACJ3E,EAAIG,SAASC,SAASwE,aAAevE,EAAQ,GAAKA,EAAQ,IACtDoB,EACJzB,EAAIG,SAASC,SAAS12E,YAAc22E,EAAQ,GAAKA,EAAQ,IACrDwE,EAAYzD,EAAOv7E,OACnBi/E,EAAW1D,EAAO7zE,MAClBw3E,EAAcF,EAAYF,EAC1BK,EAAaF,EAAWrD,EACxBwD,EAAyBD,EAAdD,EAA2BA,EAAcC,EAI1D,MAAO,CAFqB,EAAXC,EAAeH,EAAWG,EAAWH,EAD1B,EAAXG,EAAeJ,EAAYI,EAAWJ,IAUjDjF,GAAA/oG,UAAAwtG,wBAAR,SAAgCp6F,OACxBi7F,EAAoBj7F,EAAIgY,eAAeG,gBACvCkiE,EAAgBr6E,EAAIgY,eAAerO,YACzC,MAAO,CACLsxF,EACA,EACA,GACCA,EACD5gB,EAAc,GAAK4gB,EAAoB,GACvC5gB,EAAc,GAAK4gB,EAAoB,IACvChkG,KAAK,OASD0+F,GAAA/oG,UAAAyqG,sBAAR,SAA8BF,EAAQ36F,EAAM7H,OACpCumG,EAAa,SAAWvmG,EACxB2iF,EAAO9pF,KAEb,IACE2pG,EAAOa,YAEHjzE,UAAUo2E,YACZp2E,UAAUo2E,WAAWhE,EAAOiE,WAAY5+F,EAAO,IAAM7H,GACrDnH,KAAK+sG,sBAELpD,EAAOkE,OAAM,SAACt+E,GAEZu9E,GAAAA,OAAOv9E,EAAMvgB,EAAO,IAAM7H,GAC1B2iF,EAAKijB,sBACJW,GAEL,MAAOpgD,GACPttD,KAAKohD,eAAe18C,MAClB1E,KAAKk/B,gBAAgBC,UAAUC,QAC7B,0CAEFp/B,KAAKk/B,gBAAgBC,UAAUC,QAC7B,4CAEF,WAUE+oE,GAAA/oG,UAAAwqG,uBAAR,SAA+BD,EAAQ36F,OAE/B86E,EAAO9pF,KAEVA,KAAKmC,eAAe,YACG,oBAAjBnC,KAAK8tG,UAEZ9tG,KAAK8tG,QAAU,IAAIC,IAGrB,IACEpE,EAAOa,YACHjzE,UAAUo2E,WACZ3tG,KAAK6sG,aAAa79F,EAAM26F,EAAOiE,YAE/BjE,EAAOkE,OAAM,SAACt+E,GACZu6D,EAAK+iB,aAAa79F,EAAMugB,IAfX,cAkBjB,MAAO+9B,GACPttD,KAAKohD,eAAe18C,MAClB1E,KAAKk/B,gBAAgBC,UAAUC,QAC7B,0CAEFp/B,KAAKk/B,gBAAgBC,UAAUC,QAC7B,4CAEF,WAUE+oE,GAAA/oG,UAAAytG,aAAR,SAAqB79F,EAAMugB,GAEzBvvB,KAAK8tG,QAAQpP,KAAK1vF,EAAMugB,GACxBvvB,KAAKurG,kBAGwB,IAAzBvrG,KAAKurG,kBAEPvrG,KAAKguG,aAELhuG,KAAK2zB,gBAAgBC,WAAW5zB,KAAK6zB,cAIjCs0E,GAAA/oG,UAAA2tG,mBAAR,WACE/sG,KAAKurG,kBAGwB,IAAzBvrG,KAAKurG,iBAEPvrG,KAAK2zB,gBAAgBC,WAAW5zB,KAAK6zB,aAQjCs0E,GAAA/oG,UAAA4uG,WAAR,eACQlkB,EAAO9pF,KACbA,KAAK8tG,QAAQG,cAAc,CAAExoG,KAAM,SAAUikG,KAAI,SAACn6E,GAEhDu9E,GAAAA,OAAOv9E,EAAM,kBACNu6D,EAAKgkB,gCA5tBjBpuG,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAZLoiD,GAAAA,sBAAgBjuB,GAAAA,uBAAiBiM,GAAAA,wNAkBxC,SAAAmoE,GACU/mD,EACAztB,EACAuL,GAFAl/B,KAAAohD,eAAAA,EACAphD,KAAA2zB,gBAAAA,EACA3zB,KAAAk/B,gBAAAA,EC7BZ,IAAAgvE,IAsBEpuG,OAAAC,eACImuG,GAAA9uG,UAAA,MAAG,KADP,WAEE,OAAOY,KAAK+hC,UAEd,SAAQ7hC,GACNF,KAAK+hC,KAAO7hC,mCAIdJ,OAAAC,eACImuG,GAAA9uG,UAAA,eAAY,KADhB,WAEE,OAAOY,KAAKmuG,mBAEd,SAAiBjuG,GACfF,KAAKmuG,cAAgBjuG,mCAIvBJ,OAAAC,eACImuG,GAAA9uG,UAAA,cAAW,KADf,WAEE,OAAOY,KAAKouG,kBAEd,SAAgBluG,GACdF,KAAKouG,aAAeluG,mCAItBJ,OAAAC,eACImuG,GAAA9uG,UAAA,cAAW,KADf,WAEE,OAAOY,KAAKquG,kBAEd,SAAgBnuG,GACdF,KAAKquG,aAAenuG,mCAItBJ,OAAAC,eACImuG,GAAA9uG,UAAA,cAAW,KADf,WAEE,OAAOY,KAAKsuG,kBAEd,SAAgBpuG,GACdF,KAAKsuG,aAAepuG,mCAItBJ,OAAAC,eACImuG,GAAA9uG,UAAA,aAAU,KADd,WAEE,OAAOY,KAAKuuG,iBAEd,SAAeruG,GACbF,KAAKuuG,YAAcruG,mCAMrBguG,GAAA9uG,UAAAovG,iBAAA,SAAiBxwF,GAGf,IAFAhe,KAAKymD,UAAW,KAEZzoC,EAAKywF,eACPzuG,KAAK0uG,aACFtG,MAAMpoG,KAAKwS,IAAKwL,GAChBrG,gBACE,KACD4zF,EAAkB,EAElBvtF,EAAK4kD,YACP2oC,IAEqC,SAAnCvtF,EAAK2wF,YAAYz/F,eACnBq8F,IAGFvrG,KAAK0uG,aAAapD,sBAAsBC,OAElC/0F,GAAcwH,EAAKxH,WACzBxW,KAAK0uG,aAAalD,iBAChBxrG,KAAKwS,IACLgE,EACAwH,EAAK2wF,YACL3wF,EAAK8qF,eACL9qF,EAAK+qF,UACL/qF,EAAK4kD,WACL5kD,EAAKnM,MACLmM,EAAKs9E,QACLt9E,EAAKurF,WAEHvrF,EAAK4kD,YACP5iE,KAAK0uG,aAAapF,qBAChBtpG,KAAKwS,IACLwL,EAAK2wF,YACL3wF,EAAKurF,WACJ/yF,GAIPxW,KAAKymD,UAAW,wBAvGnBjmD,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,YACVC,SAAA,mUAJOynG,oCASNrnG,GAAAA,4BASAA,GAAAA,2BASAA,GAAAA,2BASAA,GAAAA,2BASAA,GAAAA,0BASAA,GAAAA,SAqDHotG,IA5CE,SAAAA,GAAoBQ,GAAA1uG,KAAA0uG,aAAAA,EAxDb1uG,KAAAymD,UAAW,EClBpB,IAAamoD,GAAoB9T,GAAAA,QAAQ,CAAC,MAAO,UAIpC+T,GAAmB/T,GAAAA,QAAQ,CACtC,KACA,KACA,KACA,KACA,KACA,KACA,SACA,UAIWgU,GAAmBhU,GAAAA,QAAQ,CAAC,YAAa,aAGzCiU,GAAkBjU,GAAAA,QAAQ,CAAC,KAAM,KAAM,MAAO,QAG9CkU,GAAuBlU,GAAAA,QAAQ,CAC1C,MACA,MACA,OACA,MACA,SC7BFmU,IAkCEnvG,OAAAC,eACIkvG,GAAA7vG,UAAA,WAAQ,KADZ,WAEE,OAAOY,KAAKumD,eAEd,SAAarmD,GACXF,KAAKumD,UAAYrmD,mCAInBJ,OAAAC,eACIkvG,GAAA7vG,UAAA,cAAW,KADf,WAEE,OAAOY,KAAKkvG,iBAAiBhvG,WAE/B,SAAgBA,GACdF,KAAKkvG,iBAAiBna,SAAS70F,GAAS8uG,GAAqBG,KAAM,CACjEC,UAAU,qCAIdtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,eAAY,KADhB,WAEE,OAAOY,KAAK48F,kBAAkB18F,WAEhC,SAAiBA,GACfF,KAAK48F,kBAAkB7H,SAAS70F,GAAS0uG,GAAkBS,IAAK,CAC9DD,UAAU,qCAIdtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,cAAW,KADf,WAEE,OAAOY,KAAKsvG,iBAAiBpvG,WAE/B,SAAgBA,GACdF,KAAKsvG,iBAAiBva,SAAS70F,GAAS2uG,GAAiBU,OAAQ,CAC/DH,UAAU,qCAIdtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,cAAW,KADf,WAEE,OAAOY,KAAKwvG,iBAAiBtvG,WAE/B,SAAgBA,GACdF,KAAKwvG,iBAAiBza,SAAS70F,GAAS4uG,GAAiBW,UAAW,CAClEL,UAAU,qCAIdtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,aAAU,KADd,WAEE,OAAOY,KAAK0vG,gBAAgBxvG,WAE9B,SAAeA,GACbF,KAAK0vG,gBAAgB3a,SAAS70F,GAAS6uG,GAAgB,IAAO,CAC5DK,UAAU,qCAIdtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,QAAK,KADT,WAEE,OAAOY,KAAK2vG,WAAWzvG,WAEzB,SAAUA,GACRF,KAAK2vG,WAAW5a,SAAS70F,EAAO,CAAEkvG,UAAU,qCAG9CtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,UAAO,KADX,WAEE,OAAOY,KAAK4vG,aAAa1vG,WAE3B,SAAYA,GACVF,KAAK4vG,aAAa7a,SAAS70F,EAAO,CAAEkvG,UAAU,qCAEhDtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,iBAAc,KADlB,WAEE,OAAOY,KAAK6vG,oBAAoB3vG,WAElC,SAAmBA,GACjBF,KAAK6vG,oBAAoB9a,SAAS70F,EAAO,CAAEkvG,UAAU,qCAEvDtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,YAAS,KADb,WAEE,OAAOY,KAAK8vG,eAAe5vG,WAE7B,SAAcA,GACZF,KAAK8vG,eAAe/a,SAAS70F,EAAO,CAAEkvG,UAAU,qCAElDtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,aAAU,KADd,WAEE,OAAOY,KAAK+vG,gBAAgB7vG,WAE9B,SAAeA,GACbF,KAAK+vG,gBAAgBhb,SAAS70F,EAAO,CAAEkvG,UAAU,qCAGnDtvG,OAAAC,eACIkvG,GAAA7vG,UAAA,YAAS,KADb,WAEE,OAAOY,KAAKgwG,eAAe9vG,WAE7B,SAAcA,GACZF,KAAKgwG,eAAejb,SAAS70F,EAAO,CAAEkvG,UAAU,qCAGlDtvG,OAAAC,eAAIkvG,GAAA7vG,UAAA,oBAAiB,KAArB,WACE,OAAQY,KAAKk8F,KAAa,SAAqB,8CAGjDp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,mBAAgB,KAApB,WACE,OAAQY,KAAKk8F,KAAa,SAAoB,6CAGhDp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,mBAAgB,KAApB,WACE,OAAQY,KAAKk8F,KAAa,SAAoB,6CAGhDp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,mBAAgB,KAApB,WACE,OAAQY,KAAKk8F,KAAa,SAAoB,6CAGhDp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,kBAAe,KAAnB,WACE,OAAQY,KAAKk8F,KAAa,SAAmB,4CAG/Cp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,eAAY,KAAhB,WACE,OAAQY,KAAKk8F,KAAa,SAAgB,yCAG5Cp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,sBAAmB,KAAvB,WACE,OAAQY,KAAKk8F,KAAa,SAAuB,gDAGnDp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,iBAAc,KAAlB,WACE,OAAQY,KAAKk8F,KAAa,SAAkB,2CAG9Cp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,kBAAe,KAAnB,WACE,OAAQY,KAAKk8F,KAAa,SAAmB,4CAG/Cp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,iBAAc,KAAlB,WACE,OAAQY,KAAKk8F,KAAa,SAAkB,2CAG9Cp8F,OAAAC,eAAIkvG,GAAA7vG,UAAA,aAAU,KAAd,WACE,OAAQY,KAAKk8F,KAAa,SAAc,uCAqB1C+S,GAAA7vG,UAAAi0B,SAAA,WACErzB,KAAKgwG,eAAejb,UAAS,IAG/Bka,GAAA7vG,UAAAovG,iBAAA,SAAiBxwF,EAAoBiyF,GACnCjwG,KAAKkwG,WAAY,EACjBlyF,EAAKywF,eAAiBzuG,KAAKyuG,eACvBwB,GACFjwG,KAAK68F,OAAO//D,KAAK9e,IAIrBixF,GAAA7vG,UAAA+wG,oBAAA,WACuC,UAAjCnwG,KAAK48F,kBAAkB18F,MACzBF,KAAKyuG,gBAAiB,EAEtBzuG,KAAKyuG,gBAAiB,wBAtM3BjuG,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,iBACVC,SAAA,k2JAjBAklG,GAAAA,kDA+BC9kG,GAAAA,2BASAA,GAAAA,4BAUAA,GAAAA,2BAUAA,GAAAA,2BAUAA,GAAAA,0BAUAA,GAAAA,qBAUAA,GAAAA,uBAQAA,GAAAA,8BAOAA,GAAAA,yBAOAA,GAAAA,0BAOAA,GAAAA,yBAQAA,GAAAA,sBAoDAs8B,GAAAA,UAqCH6xE,IAnCE,SAAAA,GAAoBpK,GAAA7kG,KAAA6kG,YAAAA,EA7Jb7kG,KAAAowG,cAAgBxB,GAChB5uG,KAAAqwG,aAAexB,GACf7uG,KAAAswG,aAAexB,GACf9uG,KAAAsc,YAAcyyF,GACd/uG,KAAAuwG,aAAevB,GACfhvG,KAAAyuG,gBAAiB,EAShBzuG,KAAAumD,WAAY,EA6IVvmD,KAAA68F,OAAqC,IAAIr/D,GAAAA,aAGjDx9B,KAAKk8F,KAAOl8F,KAAK6kG,YAAYvzF,MAAM,CACjCO,MAAO,CAAC,GAAI,IACZypF,QAAS,CAAC,GAAI,IACdnxF,aAAc,CAAC,GAAI,CAAC26F,GAAAA,WAAWC,WAC/BsD,YAAa,CAAC,GAAI,CAACvD,GAAAA,WAAWC,WAC9B4J,YAAa,CAAE,GAAI,CAAC7J,GAAAA,WAAWC,WAC/BvuF,WAAY,CAAC,GAAI,CAACsuF,GAAAA,WAAWC,WAC7BuD,YAAa,CAAC,GAAI,CAACxD,GAAAA,WAAWC,WAC9B+D,gBAAgB,EAChBC,WAAW,EACXnmC,YAAY,EACZ2mC,UAAW,CAAC,CAAC9sE,OAAQz8B,KAAKyuG,mBCpMhC,IAAA+B,yBAmBCrvG,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACA2mE,GAAAA,YACA2e,GAAAA,oBACArlF,GAAAA,cACAC,GAAAA,gBACA6mE,GAAAA,gBACA4xB,GAAAA,gBACAlyB,GAAAA,eACAC,GAAAA,mBACAI,GAAAA,qBACA1mE,GAAAA,kBACA0tE,GAAAA,mBAEFztE,QAAS,CAACwsG,GAAgBe,IAC1BttG,aAAc,CAACusG,GAAgBe,QAEJuB,IAlB7B,SAAAA,MCTA,SAAgBC,GAAyBtzF,GACvC,OAAO,IAAI4hD,GACT5hD,EAAOinC,UAAU,iBAAiB2a,GAAkBl4D,KAAS,IAOjE,SAAgB6pG,KACd,MAAO,CACLlX,QAAS97B,GACTopC,WAAY2J,GACZ1J,OAAO,EACPC,KAAM,CAAC7iD,GAAAA,gBCxBX,IAAAwsD,IAcSA,GAAA3vG,QAAP,WACE,MAAO,CACLC,SAAU0vG,GACVzvG,UAAW,CAACwvG,6BAVjBvvG,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CAACC,GAAAA,cACVK,QAAS,CAACq6D,IACVp6D,aAAc,CAACo6D,IACf76D,UAAW,CAACu0D,QASdk7C,IAbA,SAAAA,MCDA,QAQEC,GAAAxxG,UAAAyxG,WAAA,WACE,OAAO7wG,KAAK8/D,SAOd8wC,GAAAxxG,UAAA0xG,kBAAA,WACE,OAAO9wG,KAAK6wG,aAAa7mG,OAAM,SAC5BqX,GAAyB,OAAmB,IAAnBA,EAAO5Y,WAUrCmoG,GAAAxxG,UAAA2xG,oBAAA,SAAoBtrG,GAClBzF,KAAK6wG,aAAahmG,QAAO,SAAEwW,GACpBA,EAAkB,YAAyB5b,OAASA,EACvD4b,EAAO5Y,SAAU,EAEjB4Y,EAAO5Y,SAAU,KAUvBmoG,GAAAxxG,UAAA6+D,oBAAA,SAAoB58C,EAAsB68C,GACxC78C,EAAO48C,oBAAoBC,IAE/B0yC,IA5CE,SAAAA,GAAoB9wC,GAAA9/D,KAAA8/D,QAAAA,ECEtB,SAAgBkxC,GAAgB3vF,GAC9B,OAAO,EAAgBy9C,SAAWr3D,UAQpC,SAAgBwpG,GAAuB5vF,GACrC,OAAO,EAAgB6vF,gBAAkBzpG,UAQ3C,SAAgB0pG,GAAgC9vF,GAC9C,OAAO,EAAgB6vF,gBAAkBzpG,YAA6C,IAAhC4Z,EAAOw8C,qBCJ/D,IAAAuzC,IAcEA,GAAAhyG,UAAA0/D,OAAA,SAAO54B,EAAc3lC,GACnB,QADmB,IAAAA,IAAAA,EAAA,KACdP,KAAKqxG,YAAYnrE,GACpB,MAAO,OAgBL45B,EAbExwC,EAAWzN,GAAeqkB,EAAMlmC,KAAKgpC,WAAWH,SAASlgB,WAAY,CACzE5C,QAASxlB,EAAQwlB,UAEnB,OAAIuJ,EAASrN,OACJjiB,KAAKkxG,cAAc5hF,EAASrN,OAAQ,CAAEk8E,SAAU7uE,EAAStM,UACvDsM,EAASzJ,SAClB5U,QAAQC,IAAIoe,EAASzJ,SAGvBtlB,EAAQyI,OAAShJ,KAAKgpC,WACnBH,SACAre,eAAerO,UAAU,aAK1B2jD,EADEv/D,EAAQ+wG,gBAAkB/wG,EAAQ+wG,iBAAmB7pG,UAC7CzH,KAAKuxG,oBAAoBT,oBAEzB9wG,KAAKuxG,oBAAoBV,aAGjCtwG,EAAQoyC,SACVmtB,EAAUA,EAAQ91D,OAAM,SAACqX,GAAU,OAAAA,EAAOX,UAAYngB,EAAQoyC,WACrDpyC,EAAQixG,aACjB1xC,EAAUA,EAAQ91D,OAAM,SACtBqX,GAAU,OAAAA,EAAOsQ,YAAcpxB,EAAQixG,cAI3C1xC,EAAUA,EAAQ91D,OAAOgnG,IAClBhxG,KAAKyxG,cAAc3xC,EAAS55B,EAAM3lC,KAQ3C6wG,GAAAhyG,UAAA8xG,cAAA,SACEjvF,EACA1hB,EACAmxG,QAAA,IAAAA,IAAAA,GAAA,OAEMC,EAAwBD,EAC1BP,GACAF,GACEnxC,EAAU9/D,KAAKuxG,oBAClBT,oBACA9mG,OAAO2nG,GACV,OAAO3xG,KAAK4xG,qBAAqB9xC,EAAS79C,EAAQ1hB,GAAW,KASvD6wG,GAAAhyG,UAAAqyG,cAAR,SACE3xC,EACA55B,EACA3lC,GAEA,OAAOu/D,EAAQttD,IAAG,SAAE6O,GAClB,MAAO,CACLysC,QAAS,EAAgCgR,OAAO54B,EAAM3lC,GACtDwvC,SAAS,EACT1uB,OAAMA,MAWJ+vF,GAAAhyG,UAAAwyG,qBAAR,SACE9xC,EACA79C,EACA1hB,GAEA,OAAOu/D,EAAQttD,IAAG,SAAE6O,GAClB,MAAO,CACLysC,QAAS,EAAmCojD,cAC1CjvF,EACA1hB,GAEFwvC,SAAS,EACT1uB,OAAMA,MAUJ+vF,GAAAhyG,UAAAiyG,YAAR,SAAoBnrE,GAClB,MAAuB,iBAATA,GAA8B,KAATA,wBAxHtCxmC,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAhBLgxG,UAPAhoE,8IA0BP,SAAAwoE,GACUG,EACAvoE,GADAhpC,KAAAuxG,oBAAAA,EACAvxG,KAAAgpC,WAAAA,ECzBZ,OAAA,SAAA6oE,OCNAC,GAGE,SAAAA,GAAmBhyC,GAAA9/D,KAAA8/D,QAAAA,GAGrB,SAAgBiyC,GAA+BjyC,GAC7C,OAAO,IAAIgyC,GAAwBhyC,GAGrC,SAAgBkyC,KACd,MAAO,CACLxY,QAASsY,GACThL,WAAYiL,GACZ/K,KAAM,CAAC6K,KCdX,IAAAI,IAeEA,GAAA7yG,UAAAqqC,MAAA,SAAMgW,EAAiCyyD,GAAvC,IAAAvnG,EAAA3K,KACE,QADqC,IAAAkyG,IAAAA,EAAA,IACV,IAAvBzyD,EAAY18C,OAGhB,OAAO/C,KAAKmyG,wBAAwBryC,QACjC91D,OAAM,SAAEqX,GAA6B,OAAAA,EAAO5Y,UAC5C+J,IAAG,SAAE6O,GAA6B,OAAA1W,EAAKynG,YAAY/wF,EAAQo+B,EAAayyD,MAG7ED,GAAA7yG,UAAAgzG,YAAA,SACE/wF,EACAo+B,EACAyyD,GAGA,YAHA,IAAAA,IAAAA,EAAA,IAEgB7wF,EAAOooB,MAAMgW,EAAayyD,yBApB7CxyG,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,qDAHLkyG,gIAMP,SAAAG,GAAoBE,GAAAnyG,KAAAmyG,wBAAAA,ECbtB,IAAAE,IASEA,GAAAjzG,UAAAkzG,oBAAA,eACQC,EAAmB,GAMzB,OALIvyG,KAAKwyG,OACPxyG,KAAKwyG,MAAM3nG,QAAO,SAAC4nG,GACjBF,EAAiB9tG,KAAKguG,EAAKC,mBAGxBH,GAGTF,GAAAjzG,UAAAuzG,SAAA,SAASH,GACPxyG,KAAKwyG,MAAQA,GAGfH,GAAAjzG,UAAAwzG,SAAA,WACE,OAAO5yG,KAAKwyG,4BArBf9yG,GAAAA,oDAwBD2yG,IApBE,SAAAA,MCPF,IAAAQ,IAyGEA,GAAAzzG,UAAA0zG,YAAA,WACE9yG,KAAK+yG,qBAGPF,GAAAzzG,UAAA4zG,QAAA,SAAQ3yF,GACNA,EAAM4yF,kBAGRJ,GAAAzzG,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KAEEA,KAAKk8D,aAAaJ,cAAe,EACjC97D,KAAKkzG,aAAc,EACnBlzG,KAAKmzG,gBAAkBnzG,KAAKk/B,gBAAgBk0E,cAC5CpzG,KAAKqzG,UAAYrzG,KAAK6kG,YAAYvzF,MAAM,CACtCgiG,eAAgB,MAChBC,eAAgB,UAChBC,mBAAmB,EACnBC,yBAAyB,EACzBjB,MAAOxyG,KAAK6kG,YAAY1X,MAAM,CAC5BntF,KAAK0zG,WAAW,SAChB1zG,KAAK0zG,WAAW,WAIpB/uE,WAAU,WACRh6B,EAAKgpG,aACLhpG,EAAKipG,qBACJ,GAEH5zG,KAAK6zG,wBACL7zG,KAAK8zG,gBAAgBrvG,KACnBzE,KAAK+zG,QACF3oF,KACC6d,GAAAA,aAAajpC,KAAKugC,UAClBgX,GAAAA,wBAED5/B,UAAS,SAAEuuB,GAAiB,OAAAv7B,EAAKqpG,kBAAkB9tE,OAI1D2sE,GAAAzzG,UAAAs0B,YAAA,WACE1zB,KAAKi0G,2BACLj0G,KAAKk0G,sBACLl0G,KAAKk8D,aAAaJ,cAAe,EACjC97D,KAAKm0G,eACLn0G,KAAKo0G,2BAICvB,GAAAzzG,UAAAu0G,WAAR,eAEQU,EAAkB,IAAIxpE,GAA4B,CAACO,OAAQoB,GAAchrB,OAGzE8yF,EAAat0G,KAAKs0G,WAUxB3+D,GAAkB2+D,EATC,IAAItkF,GAAY,CACjCne,MAAO,qBACPsX,OAAQ,IACR9H,OAAQ,IAAIpa,GACZijB,iBAAiB,EACjBgG,YAAY,EACZD,WAAW,EACX1pB,MAAOguG,MAGT3+D,GAAsB0+D,EAAYD,OAG5BG,EAAax0G,KAAKw0G,WAUxB7+D,GAAkB6+D,EATC,IAAIxkF,GAAY,CACjCne,MAAO,gCACPsX,OAAQ,IACR9H,OAAQ,IAAIpa,GACZijB,iBAAiB,EACjBgG,YAAY,EACZD,WAAW,EACX1pB,MAAOguG,MAGT3+D,GAAsB4+D,EAAYH,IAI5BxB,GAAAzzG,UAAAw0G,kBAAR,WAAA,IACMa,EADN9pG,EAAA3K,KAEQ00G,EAAa,IAAIC,GAAAA,OAAqB,CAC1ChvG,OAAQ,CAAC3F,KAAKs0G,WAAWh0G,MAAMwG,IAC/B8pC,UAAWgkE,GAAAA,YACX1kE,aAAc,EACdlmC,OAAM,SAAG3E,GACP,MAA+B,SAAxBA,EAAQ8S,IAAI,WAIvBu8F,EAAWxoF,GAAG,SAAQ,SAAEs0B,GACtBi0D,EAAsBj0D,EAAIp9C,OAAOypC,cAAc,SAG3CgoE,EAAgB,IAAIC,GAAAA,UAAwB,CAChDnvG,OAAQ,CAAC3F,KAAKs0G,WAAWh0G,MAAMwG,IAC/B6R,SAAU87F,IAIZI,EAAc3oF,GAAG,cAAa,SAAEs0B,OACxB7nC,EAAW6nC,EAAI7nC,SACQ,IAAzBA,EAASo8F,aACbpqG,EAAKqqG,mBAAmBr8F,GAAU,EAAO,IAAI,KAG/Ck8F,EAAc3oF,GAAG,eAAc,SAAEs0B,OACzB7nC,EAAW6nC,EAAI7nC,SACQ,IAAzBA,EAASo8F,aACbpqG,EAAKqqG,mBAAmBr8F,GAAU,EAAM,GAAG,SAGvCs8F,EAAgB,IAAIN,GAAAA,OAAqB,CAC7ChvG,OAAQ,CAAC3F,KAAKw0G,WAAWl0G,MAAMwG,IAC/B8pC,UAAWskE,GAAAA,MACXhlE,aAAc,EACdlmC,OAAM,SAAG3E,GACP,MAA2B,UAApBA,EAAQqb,WAGnBu0F,EAAc/oF,GAAG,SAAQ,SAAEs0B,GACzB,IAAyB,IAArB71C,EAAKuoG,YAAuB,KACxBiC,EAAoBnvF,GAAAA,UACxB,EAAairB,gBAAgB6R,WAC7Bn4C,EAAK6H,IAAImW,WACThe,EAAKge,YAEPhe,EAAKyqG,cACCC,EAAM1qG,EAAK6nG,MAAMzvG,OAAS,EAChC4H,EAAK6nG,MAAM8C,GAAGD,GAAK1S,WAAW,CAAE+P,gBAAiByC,IACjDxqG,EAAK4qG,wBAAwBJ,EAAmBE,GAChD1qG,EAAK6qG,eAAeL,EAAmBE,GACvCJ,EAAcpoE,cAAchsB,QAE9Bo0F,EAAcpoE,cAAchsB,UAG9B7gB,KAAKwS,IAAI1L,GAAG+pC,eAAe6jE,GAC3B10G,KAAKwS,IAAI1L,GAAG+pC,eAAegkE,GAC3B70G,KAAKwS,IAAI1L,GAAG+pC,eAAeokE,IAIrBpC,GAAAzzG,UAAAy0G,sBAAR,WAAA,IAAAlpG,EAAA3K,KACEA,KAAK8zG,gBAAgBrvG,KACnBzE,KAAKqzG,UAAUxjC,aACZzkD,KAAK6d,GAAAA,aAAajpC,KAAKugC,WACvB5oB,UAAS,SAACmhB,GACTnuB,EAAKypG,8BAULvB,GAAAzzG,UAAA+0G,aAAR,eACQG,EAAat0G,KAAKs0G,WAClBE,EAAax0G,KAAKw0G,WAExBx0G,KAAKwS,IAAI80B,YAAYgtE,EAAWh0G,OAChCN,KAAKwS,IAAI80B,YAAYktE,EAAWl0G,OAChCg0G,EAAWxzB,yBAAyBj2C,IACpC2pE,EAAW1zB,yBAAyBj2C,KAI9BgoE,GAAAzzG,UAAA41G,mBAAR,SACEr8F,EACA88F,EACAlzD,EACAmzD,GAJF,IAAA/qG,EAAA3K,UAEE,IAAAy1G,IAAAA,GAAA,QACA,IAAAlzD,IAAAA,EAAA,QACA,IAAAmzD,IAAAA,GAAA,GACA11G,KAAKw0G,WAAW3zF,YAIZ3e,EAHEyzG,EAAeh9F,EAAS63B,WAAW,GAEnColE,EADeD,EAAaj1F,QACCjW,MAAM,KAEzC,OAAQmrG,EAAc,IACpB,IAAK,QACH1zG,EAAI,EACJ,MACF,IAAK,MACHA,EAAIlC,KAAKwyG,MAAMzvG,OAAS,EACxB,MACF,QACEb,EAAIijB,OAAOywF,EAAc,QAGvBC,EAAyB7vF,GAAAA,UAC7B2vF,EAAa3kF,cAAc8B,iBAC3B9yB,KAAKwS,IAAImW,WACT3oB,KAAK2oB,YAEP3oB,KAAKwyG,MACF8C,GAAGpzG,GACHygG,WAAW,CAAE+P,gBAAiBmD,EAAwBC,cAAe,KACpEL,GACFz1G,KAAKu1G,wBAAwBM,EAAwB3zG,OAGjDgwG,EAAiB,CACrB6D,OAAO,EACPL,UAAU,EACVM,cAAc,GAGZN,IACFxD,EAAkBwD,UAAW,EAC7BxD,EAAkB6D,OAAQ,EAC1B7D,EAAkB8D,cAAe,GAGvB,EAARzzD,GACqC,oBAA5BviD,KAAK2iD,oBACdC,aAAa5iD,KAAK2iD,oBAEpB3iD,KAAK2iD,mBAAqBhe,WAAU,WAClCh6B,EAAKsrG,UAAUxuG,UAAWyqG,IACzB3vD,KAGHK,aAAa5iD,KAAK2iD,oBAClB3iD,KAAKi2G,UAAUxuG,UAAWyqG,KAK9BW,GAAAzzG,UAAAm2G,wBAAA,SAAwB91D,EAA+By2D,GAAvD,IAAAvrG,EAAA3K,KACQm2G,EAAmB,GACnBC,EAAqB,CAAC32D,EAAY,GAAG73B,QAAQ,GAAI63B,EAAY,GAAG73B,QAAQ,IAC9E5nB,KAAKwyG,MAAM8C,GAAGY,GAAWvT,WAAW,CAAE0T,UAAWD,EAAmB3sG,KAAK,OACzEzJ,KAAKs2G,cACFpF,cAAczxD,EAAa,CAAEh5B,KAAMzmB,KAAKwS,IAAIgY,eAAegrB,YAC3DhjC,IAAG,SAACkiB,GACH,OAAA/pB,EAAKmpG,gBAAgBrvG,KACnBiwB,EAAIo5B,QAAQ1iC,KAAK5Y,GAAAA,IAAG,SAACvC,GAAK,OAAAA,KAAI0H,UAAS,SAAC+kD,GAgBtC,GAfAA,EAAQ7xD,QAAO,SAAC2gD,GAGE,IADd2qD,EAAiBnsG,OAAM,SAACiG,GAAK,OAAAA,EAAEoR,SAAWmqC,EAAOnqC,SAC9Cte,QAEHozG,EAAiB1xG,KAAK,CACpB4c,OAAQmqC,EAAOnqC,OACfq7C,QAASA,EAAQlqD,IAAG,SAAChP,GAAK,OAAAA,EAAEwa,WAIlCrT,EAAK6nG,MACF8C,GAAGY,GACHvT,WAAW,CAAEmT,cAAeK,IAE3Bz5C,EAAQ,GACV,GAAkC,oBAA9BA,EAAQ,GAAGr7C,OAAOX,QAA+B,CAGnD,QADI61F,EAAY,EACP3zG,EAAI,EAAGA,EAAI85D,EAAQ35D,OAAQH,IAElC,GAAgC,aADX85D,EAAQ95D,GAAGob,KACpB5J,WAAW3O,KAAqB,CAC1C8wG,EAAY3zG,EACZ,MAGJ+H,EAAK6nG,MAAM8C,GAAGY,GAAWvT,WAAW,CAClC0T,UAAWhkE,GAAAA,eAAeqqB,EAAQ65C,MAEU,UAA1C75C,EAAQ65C,GAAWv4F,KAAK5S,SAAS3F,MACnCkF,EAAK6nG,MAAM8C,GAAGY,GAAWvT,WAAW,CAClC+P,gBACEh2C,EAAQ65C,GAAWv4F,KAAK5S,SAASq0C,kBAKA,uBAA9Bid,EAAQ,GAAGr7C,OAAOX,UAC3B/V,EAAK6nG,MAAM8C,GAAGY,GAAWvT,WAAW,CAClC0T,UAAW,CACT35C,EAAQ,GAAG1+C,KAAK5S,SAASq0C,YAAY,GAAG73B,QAAQ,GAChD80C,EAAQ,GAAG1+C,KAAK5S,SAASq0C,YAAY,GAAG73B,QAAQ,IAChDne,KAAK,OAE6B,UAAlCizD,EAAQ,GAAG1+C,KAAK5S,SAAS3F,MAC3BkF,EAAK6nG,MAAM8C,GAAGY,GAAWvT,WAAW,CAClC+P,gBACEh2C,EAAQ,GAAG1+C,KAAK5S,SAASq0C,oBAOjC90C,EAAK6nG,MAAM8C,GAAGY,GAAWvT,WAAW,CAAE0T,UAAWD,EAAmB3sG,KAAK,KAAMqsG,cAAe,KAEhGnrG,EAAK6rG,mBAAmB/nC,sBAMlCokC,GAAAzzG,UAAAq3G,eAAA,SAAe1lG,EAAe2lG,GAC5B,YAD4B,IAAAA,IAAAA,EAAc12G,KAAKwyG,MAAMzvG,QACvC,IAAVgO,EACK,QACEA,IAAU2lG,EAAc,GAAqB,IAAhBA,EAC/B,MAEA,gBAIX7D,GAAAzzG,UAAAu3G,UAAA,SAAU5lG,GACI,EAARA,GACF/Q,KAAK42G,SAAS7lG,GAAQ,IAI1B8hG,GAAAzzG,UAAAy3G,UAAA,SAAU9lG,GACJA,EAAQ/Q,KAAKwyG,MAAMzvG,OAAS,GAC9B/C,KAAK42G,SAAS7lG,EAAO,IAIjB8hG,GAAAzzG,UAAAw3G,SAAR,SAAiB7lG,EAAOy8B,OAChBspE,EAAY92G,KAAKwyG,MAAM8C,GAAGvkG,GAChC/Q,KAAK+2G,WAAWhmG,GAChB/Q,KAAKwyG,MAAMwE,OAAOjmG,EAAQy8B,EAAMspE,GAChC92G,KAAKwyG,MAAM8C,GAAGvkG,GAAO4xF,WAAW,CAAE8T,eAAgBz2G,KAAKy2G,eAAe1lG,KACtE/Q,KAAKwyG,MACF8C,GAAGvkG,EAAQy8B,GACXm1D,WAAW,CAAE8T,eAAgBz2G,KAAKy2G,eAAe1lG,EAAQy8B,KACxDxtC,KAAKwyG,MAAM8C,GAAGvkG,GAAO7Q,MAAMwyG,iBAC7B1yG,KAAKw1G,eAAex1G,KAAKwyG,MAAM8C,GAAGvkG,GAAO7Q,MAAMwyG,gBAAiB3hG,GAE9D/Q,KAAKwyG,MAAM8C,GAAGvkG,EAAQy8B,GAAMttC,MAAMwyG,iBACpC1yG,KAAKw1G,eACHx1G,KAAKwyG,MAAM8C,GAAGvkG,EAAQy8B,GAAMttC,MAAMwyG,gBAClC3hG,EAAQy8B,IAKd1tC,OAAAC,eAAI8yG,GAAAzzG,UAAA,QAAK,KAAT,WACE,OAAOY,KAAKqzG,UAAUl7F,IAAI,0CAGrB06F,GAAAzzG,UAAAg1G,wBAAP,eACQ5B,EAAQ,GACdxyG,KAAKwyG,MAAMtyG,MAAM2K,QAAO,SAAC4nG,GACnBA,EAAKC,2BAA2BzwG,OAClCuwG,EAAM/tG,KAAKguG,KAGfzyG,KAAKi3G,sBAAsBtE,SAASH,IAGtCK,GAAAzzG,UAAAg2G,QAAA,eACQ8B,EAAcl3G,KAAKwyG,MAAMzvG,OAAS,EACxC/C,KAAKwyG,MAAMwE,OAAOE,EAAal3G,KAAK0zG,eAGtCb,GAAAzzG,UAAAs0G,WAAA,SAAWyD,GACT,YADS,IAAAA,IAAAA,EAAA,gBACFn3G,KAAK6kG,YAAYvzF,MAAM,CAC5B+kG,UAAW,CAAC,IACZP,cAAe,CAAC,IAChBW,eAAgBU,EAChBzE,gBAAiB,CAAC,GAAI,CAAC5N,GAAAA,WAAWC,cAItC8N,GAAAzzG,UAAA23G,WAAA,SAAWhmG,GAAX,IAAApG,EAAA3K,KACQ6G,EAAK7G,KAAKo3G,iBAAiBrmG,GACjC/Q,KAAKq3G,uBAAuBr3G,KAAKs0G,WAAYztG,GAC7C7G,KAAKwyG,MAAM8E,SAASvmG,OAChB6D,EAAM,EACV5U,KAAKwyG,MAAMtyG,MAAM2K,QAAO,SAAC4nG,GACvB9nG,EAAK6nG,MAAM8C,GAAG1gG,GAAK+tF,WAAW,CAAE8T,eAAgB9rG,EAAK8rG,eAAe7hG,KACpEjK,EAAK6qG,eAAe7qG,EAAK6nG,MAAM8C,GAAG1gG,GAAK1U,MAAMwyG,gBAAiB99F,GAC9DA,OAIJi+F,GAAAzzG,UAAAm4G,UAAA,WACEv3G,KAAKw3G,cAAgB/vG,UAErB,QADMgwG,EAAUz3G,KAAKwyG,MAAMzvG,OAClBH,EAAI,EAAGA,EAAI60G,EAAS70G,IAC3B5C,KAAKwyG,MAAM8E,SAAS,GAEtBt3G,KAAKwyG,MAAMwE,OAAO,EAAGh3G,KAAK0zG,WAAW,UACrC1zG,KAAKwyG,MAAMwE,OAAO,EAAGh3G,KAAK0zG,WAAW,QAErC1zG,KAAKs0G,WAAWzzF,QAChB7gB,KAAKw0G,WAAW3zF,SAGlBgyF,GAAAzzG,UAAAs4G,WAAA,SAAWzmD,EAAMr8C,GACf,OAAO5U,KAAK23G,kBACV1mD,EAAK2mD,SAASnyG,KACdwrD,EAAK2mD,SAASC,SACd5mD,EAAKjiD,KACLiiD,EAAK2mD,SAASE,cACdljG,EACAq8C,EAAK2mD,SAASG,KACdnjG,IAAQ5U,KAAKg4G,YAAYjC,MAAMhzG,OAAS,IAI5C8vG,GAAAzzG,UAAAu4G,kBAAA,SACElyG,EACAoyG,EACApuE,EACArjB,EACA6xF,EACAF,EACAG,OAEIC,EACAC,OAHJ,IAAAF,IAAAA,GAAA,OAuKIG,EAnKA9rF,EAAQ,UACR+rF,EAAW,aACTC,EAAsBv4G,KAAKw4G,iBAAiBpyF,GAC5CqyF,EAAqBz4G,KAAK04G,kBAAkBb,GAI9Cc,GAF0B,aAAbd,EAA0B,GAAK,MAETY,EACnCG,GAJ0B,aAAbf,EAA0B,GAAK,WAITY,EA+BvC,GA7BIZ,GAAyC,GAA7BA,EAAS/4C,OAAO,YAC9B85C,EAAwBH,GAGT,UAAbZ,GACFtrF,EAAQ,UACR+rF,EAAW,aACW,gBAAbT,GACTtrF,EAAQ,2BACR+rF,EAAW,gBACW,UAAbT,GACTtrF,EAAQ,2BACR+rF,EAAW,gBACW,iBAAbT,GACTtrF,EAAQ,UACR+rF,EAAW,cACW,aAAbT,EACTtrF,EAAQ,UACc,gBAAbsrF,GACTtrF,EAAQ,UACR+rF,EAAW,cACW,SAAbT,GACTtrF,EAAQ,0BACR+rF,EAAW,gBACW,eAAbT,IACTtrF,EAAQ,0BACR+rF,EAAW,gBAGA,SAAT7yG,EAGA2yG,EAFe,aAAbP,GACFM,EAAc,iBAAmB1uE,EACnB,eAAiBA,GACT,UAAbouE,GACTM,EAAc,uBAAyB1uE,EACzB,kBAAoBA,IAElC0uE,EAAc,WAAaQ,EAAwB,QAAUlvE,EAC/C,QAAUgvE,EAAqB,SAAWhvE,QAErD,GAAa,aAAThkC,EACT0yG,EACE,0BAA4BI,EAAsB,QAAU9uE,EAC9D2uE,EAAc,QAAUG,EAAsB,OAAS9uE,EACvDld,EAAQ,UACR+rF,EAAW,QACN,GAAa,WAAT7yG,EACT0yG,EACE,sBAAwBI,EAAsB,QAAU9uE,EAC1D2uE,EAAc,QAAUG,EAAsB,OAAS9uE,EACvDld,EAAQ,UACR+rF,EAAW,QACN,GAAa,WAAT7yG,EACT,GAAIyyG,EAAU,KACRW,EAAO,KACNJ,IAGHI,EADAD,EADAD,EAAwB,IAI1BR,EAAc,mBAAqBU,EAAOF,EAC1CP,EACE,oCAAsCS,EAAOD,OAE/CT,EAAc,4CAA8C1uE,EAC5D2uE,EAAc,+CAAiD3uE,EAC/Dld,EAAQ,aACR+rF,EAAW,OAEK,UAAT7yG,GACT0yG,EAAc,iBAAmB1uE,EACjC2uE,EAAc,eAAiB3uE,EAC/Bld,EAAQ,UACR+rF,EAAW,cACO,YAAT7yG,GACT0yG,EAAc,gCAAkCQ,EAChDP,EAAc,iBAAmBQ,GACf,aAATnzG,GACT0yG,EAAc,iCAAmCQ,EACjDP,EAAc,aAAeQ,GACX,SAATnzG,EAGP2yG,EAF6B,GAA3BP,EAAS/4C,OAAO,SAClBq5C,EAAc,wBAA0B1uE,EAC1B,mBAAqBA,GACE,GAA5BouE,EAAS/4C,OAAO,UACzBq5C,EAAc,wBAA0B1uE,EAC1B,oBAAsBA,IAEpC0uE,EAAc,iBAAmB1uE,EACnB,eAAiBA,GAEf,gBAAThkC,GACT0yG,EACE,iCAAmCM,EAAqB,QAAUhvE,EACpE2uE,EACE,gCAAkCK,EAAqB,SAAWhvE,GAClD,aAAThkC,GACT0yG,EAAc,0BACdC,EAAc,qBACI,aAAT3yG,GAAoC,UAAboyG,GAChCM,EAAc,iBAAmB1uE,EACjC2uE,EAAc,eAAiB3uE,EAC/Bld,EAAQ,UACR+rF,EAAW,cACO,eAAT7yG,GACT0yG,EAAc,6BAA+BJ,EAC7CI,GAAwB,IAATJ,EAAa,KAAO,IACnCI,GAAe,gBAAkB1uE,EACjC2uE,EAAc,+BAAiCL,EAC/CK,GAAwB,IAATL,EAAa,KAAO,KACnCK,GAAe,iBAAmB3uE,EAClCld,EAAQ,cACR+rF,EAAW,IACO,WAAT7yG,GACT0yG,EAAc,wBACdC,EAAc,wBACd7rF,EAAQ,cACR+rF,EAAW,IACO,oBAAT7yG,GACT0yG,EAAc,6BACdC,EAAc,2BACd7rF,EAAQ,cACR+rF,EAAW,IACO,oBAAT7yG,GACT0yG,EAAc,mBAAqB1uE,EACnC2uE,EAAc,eAAiB3uE,EAC/Bld,EAAQ,UACR+rF,EAAW,cAGXF,EAFkB,iBAAT3yG,EACT0yG,EAAc,oBAEQ,UAAbN,GACTM,EACE,6CACAI,EACA,QACA9uE,EAEA,wBAA0B8uE,EAAsB,OAAS9uE,GAE3D0uE,EAAc,MAoBhB,OAhBID,IACF3rF,EAAQ,eACR+rF,EAAW,IAEQ,IAAjBL,IACF1rF,EAAQ,UACR+rF,EAAW,IAIgB,OAAzBt4G,KAAKmzG,gBACPkF,EAAYF,EACsB,OAAzBn4G,KAAKmzG,kBACdkF,EAAYD,GAGP,CAAEU,YAAaT,EAAW9rF,MAAKA,EAAE+rF,SAAQA,IAGlDzF,GAAAzzG,UAAAs5G,kBAAA,SAAkBb,GAChB,MAAiB,UAAbA,EACK73G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,4BACxB,gBAAby4E,EACF73G,KAAKk/B,gBAAgBC,UAAUC,QACpC,kCAEoB,UAAby4E,EACF73G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,4BACxB,iBAAby4E,EACF73G,KAAKk/B,gBAAgBC,UAAUC,QACpC,mCAEoB,eAAby4E,EACF73G,KAAKk/B,gBAAgBC,UAAUC,QACpC,iCAEoB,SAAby4E,EACF73G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,2BACxB,gBAAby4E,EACF73G,KAAKk/B,gBAAgBC,UAAUC,QACpC,kCAEoB,aAAby4E,EACF73G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,+BAEvCy4E,GAIXhF,GAAAzzG,UAAAo5G,iBAAA,SAAiBO,GACf,OAAe,KAAXA,GAAkBA,EAAU,GACvB/4G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,4BACrC25E,EAAU,GACZ/4G,KAAKk/B,gBAAgBC,UAAUC,QACpC,6BAEO25E,EAAU,IACZ/4G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,4BACrC25E,EAAU,IACZ/4G,KAAKk/B,gBAAgBC,UAAUC,QACpC,6BAEO25E,EAAU,IACZ/4G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,4BACrC25E,EAAU,IACZ/4G,KAAKk/B,gBAAgBC,UAAUC,QACpC,6BAEO25E,EAAU,IACZ/4G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,4BACrC25E,EAAU,IACZ/4G,KAAKk/B,gBAAgBC,UAAUC,QACpC,kCAGF,GAIJyzE,GAAAzzG,UAAA45G,eAAA,SAAe7a,GACb,GAAiB,IAAbA,EAGJ,OAAgB,KAAZA,EACKvjF,KAAKiM,MAAMs3E,EAAW,KAAQ,MAEvB,KAAZA,EACKvjF,KAAKiM,MAAMs3E,EAAW,KAAO,GAAK,MAE3B,KAAZA,EACKvjF,KAAKiM,MAAMs3E,EAAW,KAAO,GAAK,MAEpCA,EAAW,MAGpB0U,GAAAzzG,UAAA65G,eAAA,SAAe7nF,EAAkB8nF,GAC/B,QAD+B,IAAAA,IAAAA,GAAA,GACf,MAAZ9nF,EAAkB,KACdu5C,EAAO/vD,KAAKgjF,MAAMxsE,EAAW,MAC7By5C,EAASjwD,KAAKiM,MAAiC,IAA1BuK,EAAW,KAAOu5C,IAC7C,OAAe,KAAXE,EACKF,EAAO,EAAI,KAEbA,EAAO,MAAQE,EAAS,OAGjC,OAAgB,IAAZz5C,EACKxW,KAAKiM,MAAMuK,EAAW,IAAM,OAE9BA,EAAW,MAGpByhF,GAAAzzG,UAAA+5G,YAAA,SAAYloD,EAAMxb,QAAA,IAAAA,IAAAA,GAAA,GAChBz1C,KAAKo5G,yBAAyBnoD,EAAK7lD,SAASq0C,YAAahK,IAG3Do9D,GAAAzzG,UAAAg6G,yBAAA,SAAyB35D,EAAahK,QAAA,IAAAA,IAAAA,GAAA,OAC9B4jE,EAAW,SAIXC,EAHe,IAAIliD,GAAAA,WAAkB3X,GACAn6B,UAAU,YAAatlB,KAAKwS,IAAImW,YACZmK,iBACrB,GAEpC1nB,EAAW,IAAI8rD,GAAAA,MAAaoiD,GAC5Bj0G,EAAU,IAAIiwB,GAAU,CAAElqB,SAAQA,IAElCmuG,GAAc,IAAIljC,IAAYxiC,oBAAoBzoC,EAAU,CAChE+B,kBAAmBnN,KAAKwS,IAAImW,WAC5Bzb,eAAgBlN,KAAKwS,IAAImW,aAGrB6wF,EAAiBx5G,KAAKw0G,WAAWr8F,IAAIkhG,GACrCI,EAAyBD,EAAiBA,EAAe9mE,KAAKqB,SAAW,EAEzE2lE,EAAyB,CAC7Bj0G,KAAM8b,GACNnW,SAAUmuG,EACV5wF,WAAY3oB,KAAKwS,IAAImW,WACrBvU,WAAY,CACVvN,GAAIwyG,EACJ5zG,KAAM,UAERitC,KAAM,CACJ7rC,GAAIwyG,EACJtlE,SAAU0lE,EAAyB,GAErC3yG,GAAIzB,GAENrF,KAAKw0G,WAAWpvC,OAAOs0C,GACnBjkE,GACFz1C,KAAKwS,IAAIgY,eAAeirB,aAAapwC,EAAQ2rB,cAAc7U,cAI/D02F,GAAAzzG,UAAAu6G,UAAA,SAAU3wG,GAER,GAAIA,EACFhJ,KAAKwS,IAAIgY,eAAeirB,aAAazsC,OAChC,KACC4wG,EAAe55G,KAAKw0G,WAAWl0G,MAAMwG,GAAG6nB,YAAYke,cAAc/9B,KAAI,SAACmB,GAAK,MAAc,UAAdA,EAAEyQ,UACpF,GAAIk5F,EAAc,KACVC,EAAcD,EAAa5oF,cAAc7U,YAC/Cnc,KAAKwS,IAAIgY,eAAeirB,aAAaokE,MAKnChH,GAAAzzG,UAAA2zG,kBAAR,SAA0Br9D,QAAA,IAAAA,IAAAA,GAAA,OAClB3C,EAAO/yC,KAAKg4G,YAAY5sG,SAASq0C,YAEjCq6D,EADe,IAAI1iD,GAAAA,WAAkBrkB,GACAztB,UAAU,YAAatlB,KAAKwS,IAAImW,YACvE+sB,GACF11C,KAAK25G,UAAUG,EAAsB39F,iBAGjCo9F,GAAc,IAAIljC,IAAYxiC,oBAAoBimE,EAAuB,CAC7E3sG,kBAAmBnN,KAAKwS,IAAImW,WAC5Bzb,eAAgBlN,KAAKwS,IAAImW,aAGrBoxF,EAAgB/5G,KAAKw0G,WAAWr8F,IAAI,SACpC6hG,EAAwBD,EAAgBA,EAAcrnE,KAAKqB,SAAW,EAEtE6lE,EAAwB,CAC5Bn0G,KAAM8b,GACNnW,SAAUmuG,EACV5wF,WAAY3oB,KAAKwS,IAAImW,WACrBvU,WAAY,CACVvN,GAAI,QACJpB,KAAM,SAERitC,KAAM,CACJ7rC,GAAI,QACJktC,SAAUimE,EAAwB,GAEpClzG,GAAI,IAAIwuB,GAAU,CAAElqB,SAAU0uG,KAEhC95G,KAAKw0G,WAAWpvC,OAAOw0C,IAIzB/G,GAAAzzG,UAAA62G,UAAA,SAAUvgE,EAA+Bw8D,GAAzC,IAAAvnG,EAAA3K,UAAU,IAAA01C,IAAAA,GAAA,QAA+B,IAAAw8D,IAAAA,EAAA,IACvClyG,KAAKq3G,uBAAuBr3G,KAAKw0G,WAAY,UAC7Cx0G,KAAKo0G,8BACC6F,EAASj6G,KAAKi3G,sBAAsB3E,sBAC1C,KAAI2H,EAAOl3G,OAAS,GAApB,KAGMm3G,EAAgBl6G,KAAKm6G,kBAAkB1wE,MAAMwwE,EAAQ/H,GACvDgI,GACFA,EAAc1nG,IAAG,SAACkiB,GAChB,OAAA/pB,EAAKmpG,gBAAgBrvG,KACnBiwB,EAAI/c,UAAS,SAAC8xB,GACZ9+B,EAAK6sG,cAAgB/tE,EACrB9+B,EAAKqtG,YAAcrtG,EAAK6sG,cAAc,GACtC7sG,EAAKooG,kBAAkBr9D,GACvB/qC,EAAK6rG,mBAAmB/nC,uBAO1BokC,GAAAzzG,UAAA80G,oBAAR,WAC+B,IAAzBl0G,KAAKo6G,SAASr3G,QAChB/C,KAAKo6G,SAASvvG,QAAO,SAACxH,GACpBg3G,GAAAA,QAAqBh3G,MAKnBwvG,GAAAzzG,UAAA60G,yBAAR,WACEj0G,KAAK8zG,gBAAgBjpG,QAAO,SAAE4yD,GAAsB,OAAAA,EAAI/yC,gBACxD1qB,KAAK8zG,gBAAkB,IAGzBjB,GAAAzzG,UAAAk7G,oBAAA,WAEE,GADmBC,GAAAA,UAAUC,KAAKx6G,KAAKy6G,UACvB,KACRt7E,EAAYn/B,KAAKk/B,gBAAgBC,UACjCttB,EAAQstB,EAAUC,QAAQ,2CAC1B6hE,EAAM9hE,EAAUC,QAAQ,6CAC9Bp/B,KAAKohD,eAAe2sB,QAAQkzB,EAAKpvF,KAIrCghG,GAAAzzG,UAAAs7G,0BAAA,WAAA,IAAA/vG,EAAA3K,KAEM26G,EACF36G,KAAKk/B,gBAAgBC,UAAUC,QAC7B,uCACE,MACFw7E,EAAe,GACb1B,EACJl5G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,kCACvC,SAEAp/B,KAAKg4G,YAAYnmG,MACjB,OAEA7R,KAAKg5G,eAAeh5G,KAAKg4G,YAAY7Z,UACrC,OAEAn+F,KAAKi5G,eAAej5G,KAAKg4G,YAAY5mF,UACrC,OACApxB,KAAKk/B,gBAAgBC,UAAUC,QAAQ,oCACvC,MAEI3/B,EACJO,KAAKk/B,gBAAgBC,UAAUC,QAAQ,+BACvC,QAEAp/B,KAAKy6G,SAEHI,EAAe,EACnB76G,KAAKwyG,MAAMtyG,MAAM2K,QAAO,SAAC4nG,OACnB/qF,EAAQ,GACR2uF,EAAY,GACZ5D,EAAK4D,YAAc5D,EAAKC,iBAC1B2D,EAAY5D,EAAK4D,UACjB3uF,EACE,KACA,CAAC+qF,EAAKC,gBAAgB,GAAID,EAAKC,gBAAgB,IAAIjpG,KAAK,KACxD,KAEF4sG,EAAY,CAAC5D,EAAKC,gBAAgB,GAAID,EAAKC,gBAAgB,IAAIjpG,KAC7D,KAIJmxG,EACEA,EA5CW,KA8CXC,EAAaxoC,iBACb,KACAgkC,EACA3uF,EACA,KACFmzF,UAIEC,EAAW,EACf96G,KAAKg4G,YAAYjC,MAAMlrG,QAAO,SAAComD,OACvB6nD,EAAcnuG,EAAK+sG,WAAWzmD,EAAM6pD,GAAUhC,YAC9C3a,EACJxzF,EAAKquG,eAAe/nD,EAAKktC,YAAc12F,UACnC,GACA,KAAOkD,EAAKquG,eAAe/nD,EAAKktC,UAAY,IAClDwc,EACEA,EA/DW,MAiEVG,EAAW,GAAGzoC,iBACf,KACAymC,EACA3a,EACA,KACF2c,UAGIC,EACJ7B,EAAU0B,EAAe,KAAOn7G,EAAM,OAASk7G,EAGjD,GADmBJ,GAAAA,UAAUC,KAAKO,GAClB,KACR57E,EAAYn/B,KAAKk/B,gBAAgBC,UACjCttB,EAAQstB,EAAUC,QAAQ,2CAC1B6hE,EAAM9hE,EAAUC,QAAQ,yCAC9Bp/B,KAAKohD,eAAe2sB,QAAQkzB,EAAKpvF,KAI7BghG,GAAAzzG,UAAA40G,kBAAR,SAA0B9tE,GAA1B,IAAAv7B,EAAA3K,KACE,GAAIkmC,IAASz+B,WAA6B,IAAhBy+B,EAAKnjC,OAAc,KACrCi4G,EAAkB,GACpBh7G,KAAKi7G,UACPj7G,KAAKi7G,SAASvwF,cAEG1qB,KAAKs2G,cAAcx3C,OAAO54B,EAAM,CAACsrE,WAAY,YACrDh/F,IAAG,SAACkiB,GACb,OAAA/pB,EAAKswG,SACLvmF,EAAIo5B,QAAQn2C,UAAS,SAAC+kD,GACpBA,EACG1yD,OAAM,SAACxG,GAAK,OAAAA,EAAEwa,KAAK5S,WACnBP,QAAO,SAACC,GAGS,IADdkwG,EAAgBhxG,OAAM,SAACxG,GAAK,OAAAA,EAAE6d,SAAWvW,EAAQuW,SAC9Cte,QAEHi4G,EAAgBv2G,KAAK,CACnB4c,OAAQvW,EAAQuW,OAChBqxB,KAAM5nC,EAAQ4nC,KACdgqB,QAASA,EAAQlqD,IAAG,SAAChP,GAAK,OAAAA,EAAEwa,WAIpCrT,EAAK6nG,MACF8C,GAAG3qG,EAAKuwG,kBACRvY,WAAW,CAAEmT,cAAekF,IAC/BrwG,EAAK6rG,mBAAmB/nC,sBAMhCokC,GAAAzzG,UAAA+7G,QAAA,SAAQj1E,GACNlmC,KAAKkmC,KAAOA,EAEVlmC,KAAKo7G,WAAWl1E,KACfA,EAAKnjC,QAAU/C,KAAK+C,QAA0B,IAAhBmjC,EAAKnjC,SAEpC/C,KAAK+zG,QAAQ3vG,KAAK8hC,IAId2sE,GAAAzzG,UAAAg8G,WAAR,SAAmB/3G,GACjB,OAAOrD,KAAKq7G,YAAYvsG,KAAI,SAAC5O,GAAS,OAAAA,IAAUmD,MAASoE,WAG3DorG,GAAAzzG,UAAAk8G,MAAA,SAAM14G,EAAGyd,GAAT,IAAA1V,EAAA3K,KACQkmC,EAAQ7lB,EAAY,OAAsBngB,MAChDF,KAAKm7G,QAAQj1E,GACblmC,KAAKwS,IAAI1L,GAAGwlB,GAAG,cAAa,SAAEk0B,GAC5B71C,EAAK4wG,eAAe/6D,EAAK59C,MAI7BiwG,GAAAzzG,UAAAo8G,UAAA,SAAUtF,OAEFrvG,EAAK7G,KAAKo3G,iBAAiBlB,GACjCl2G,KAAKq3G,uBAAuBr3G,KAAKs0G,WAAYztG,GAC7C7G,KAAKw0G,WAAW3zF,YACV61F,EAAc12G,KAAKwyG,MAAMzvG,OAC/B/C,KAAKwyG,MAAM8E,SAASpB,GACpBl2G,KAAKwyG,MAAMwE,OAAOd,EAAWl2G,KAAK0zG,WAAW1zG,KAAKy2G,eAAeP,EAAWQ,KAC5E12G,KAAKw3G,cAAgB/vG,UACrBzH,KAAKi2G,aAGPpD,GAAAzzG,UAAAq8G,eAAA,SAAeC,EAAU94G,GACvB,GAAI84G,IAAaj0G,UAAW,KACtBk0G,OAAS,EACP5oE,EAAO,EAAkB3nC,SACb,UAAd2nC,EAAKttC,KACPk2G,EAAY5oE,EAAK0M,YACoB,GAA5B1M,EAAKttC,KAAKq5D,OAAO,QAG1B68C,EAAY,EADZA,GADa,IAAKtlC,IAAaz9D,aAAam6B,GAC3B,GAAG/hB,cAAc4qF,sBACX,GAAID,EAAU,IACG,GAA/B5oE,EAAKttC,KAAKq5D,OAAO,aAG1B68C,EAAY,EADZA,GADa,IAAKtlC,IAAaz9D,aAAam6B,GAC3B,GAAG/hB,cAAc6qF,oBAAoBD,sBAC/B,GAAID,EAAU,KAGnCA,IAAcl0G,YAChBzH,KAAKwyG,MAAM8C,GAAG1yG,GAAG+/F,WAAW,CAAE+P,gBAAiBiJ,IAC/C37G,KAAKw1G,eAAemG,EAAW/4G,MAarCiwG,GAAAzzG,UAAA08G,MAAA,SAAMl5G,GAAN,IAAA+H,EAAA3K,KACEA,KAAKk0G,sBACLl0G,KAAKk7G,iBAAmBt4G,EACxB5C,KAAKkzG,aAAc,EACnBlzG,KAAKo6G,SAAS31G,KACZzE,KAAKwS,IAAI1L,GAAGokG,KAAK,cAAa,SAAE1qD,GAC9B71C,EAAK4wG,eAAe/6D,EAAK59C,OAKvBiwG,GAAAzzG,UAAAm8G,eAAR,SAAuBl7F,EAAoB07F,GAA3C,IAAApxG,EAAA3K,KACMA,KAAKk7G,mBAAqBzzG,WAC5BzH,KAAKo1G,UACL2G,EAAW/7G,KAAKwyG,MAAMzvG,OAAS,EAC/B/C,KAAKwyG,MAAM8C,GAAGyG,GAAU77G,MAAM41G,cAAgB,IAE9CiG,EAAW/7G,KAAKk7G,qBAEZc,EAAmBh2F,GAAAA,UACvB3F,EAAMyiC,WACN9iD,KAAKwS,IAAImW,WACT3oB,KAAK2oB,YAEP3oB,KAAKwyG,MAAM8C,GAAGyG,GAAUpZ,WAAW,CAAEmT,cAAe,GAAIpD,gBAAiBsJ,IAEzEh8G,KAAKu1G,wBAAwByG,EAAkBD,GAC/C/7G,KAAKw1G,eAAewG,EAAkBD,GACtCp3E,WAAU,WACRh6B,EAAKuoG,aAAc,GAClB,MAGLL,GAAAzzG,UAAA68G,cAAA,SAAclrG,GACZ+8B,GAAiB9tC,KAAKwS,IAAK,CAACxS,KAAKwS,IAAI6sC,oBAAqB7S,GAAc/qB,UAClEy6F,EAAuBl8G,KAAKwS,IAAIgY,eAAemuB,UAAU34C,KAAK2oB,YACpE3oB,KAAKwyG,MAAM8C,GAAGvkG,GAAO4xF,WAAW,CAAE+P,gBAAiBwJ,IACnDl8G,KAAKw1G,eAAe0G,EAAsBnrG,GAC1C/Q,KAAKu1G,wBAAwB2G,EAAsBnrG,IAG9C8hG,GAAAzzG,UAAAo2G,eAAP,SAAsB/1D,EAA+B1uC,OAE/CorG,EACAC,EAFE3F,EAAiBz2G,KAAKy2G,eAAe1lG,GAKzCqrG,EAFqB,UAAnB3F,GACF0F,EAAY,QACDn8G,KAAKk/B,gBAAgBC,UAAUC,QACxC,iCAE0B,QAAnBq3E,GACT0F,EAAY,MACDn8G,KAAKk/B,gBAAgBC,UAAUC,QACxC,gCAGF+8E,EAAY,SAEVn8G,KAAKk/B,gBAAgBC,UAAUC,QAC7B,uCAEF,KACAruB,OAGE3F,EAAW,IAAI8rD,GAAAA,MACnBlxC,GAAAA,UAAiBy5B,EAAaz/C,KAAK2oB,WAAY3oB,KAAKwS,IAAImW,aAGpD0zF,EAASr8G,KAAKo3G,iBAAiBrmG,GAC/BwoG,GAAc,IAAIljC,IAAYxiC,oBAAoBzoC,EAAU,CAChE+B,kBAAmBnN,KAAKwS,IAAImW,WAC5Bzb,eAAgBlN,KAAKwS,IAAImW,aAGrB2zF,EAAet8G,KAAKs0G,WAAWn8F,IAAIkkG,GACnCE,EAAuBD,EAAeA,EAAa5pE,KAAKqB,SAAW,EAEnEyoE,EAAuB,CAC3B/2G,KAAM8b,GACNnW,SAAUmuG,EACV5wF,WAAY3oB,KAAKwS,IAAImW,WACrBvU,WAAY,CACVvN,GAAIw1G,EACJ52G,KAAM,OACN22G,SAAQA,EACRD,UAASA,EACTM,YAAa,GAEf/pE,KAAM,CACJ7rC,GAAIw1G,EACJtoE,SAAUwoE,EAAuB,GAEnCz1G,GAAI,IAAIwuB,GAAU,CAAElqB,SAAQA,KAG9BpL,KAAKs0G,WAAWlvC,OAAOo3C,GACvBx8G,KAAKi2G,aAIApD,GAAAzzG,UAAAg4G,iBAAP,SAAwBrmG,GAStB,MAAO,mBAPO,IAAVA,EACI,QACGA,IAAU/Q,KAAKwyG,MAAMzvG,OAAS,EACjC,MAEAgO,IAKF8hG,GAAAzzG,UAAAi4G,uBAAR,SAA+BtsE,EAAOlkC,OAC9B2oC,EAASzE,EAAM5yB,IAAItR,GACrB2oC,GACFzE,EAAMgB,UAAOyD,IAITqjE,GAAAzzG,UAAAq7G,OAAR,WACE,GAAKz6G,KAAKypC,MAAV,KAIMizE,EAAgB18G,KAAKypC,MAAMlpC,QAAQo8G,mBACnCpK,EAAmB,GAEvBvyG,KAAKi3G,uBACLj3G,KAAKi3G,sBAAsB3E,uBACiC,IAA5DtyG,KAAKi3G,sBAAsB3E,sBAAsBvvG,QAEjD/C,KAAKi3G,sBAAsB3E,sBAAsBznG,QAAO,SAAC6c,GACvD6qF,EAAiB9tG,KAAKgjB,GAAaC,EAAO,UAG1Ck1F,EAAgB,GAKpB,OAJ+B,GAA3BrK,EAAiBxvG,SACnB65G,EAAmBF,EAAa,IAAInK,EAAiB9oG,KAAK,MAGrD,GAAGzD,SAASC,OACjBD,SAAS62G,SAAQ,oBACCD,yBAnrCvBp8G,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,uoNAzCkBklG,GAAAA,mBA8BXqM,UAdPjyE,GAAAA,uBACAgiB,GAAAA,sBAMOovD,UAUA37C,UAFA48C,UAjCPnsC,GAAAA,yBAoBA38B,GAAAA,aAAYpmC,WAAA,CAAA,CAAAsC,KA0ET+jC,GAAAA,6CA5BF1oC,GAAAA,wBAEAA,GAAAA,sBAEAA,GAAAA,mBAEAA,GAAAA,0BAKAA,GAAAA,0BAKAA,GAAAA,sBAEAs8B,GAAAA,UA0oCHy1E,IAzoCE,SAAAA,GACUhO,EACAsV,EACAj7E,EACAkiB,EACAk1D,EACAp6C,EACA+6C,EACAT,EACY/sE,GARZzpC,KAAA6kG,YAAAA,EACA7kG,KAAAm6G,kBAAAA,EACAn6G,KAAAk/B,gBAAAA,EACAl/B,KAAAohD,eAAAA,EACAphD,KAAAs2G,cAAAA,EACAt2G,KAAAk8D,aAAAA,EACAl8D,KAAAi3G,sBAAAA,EACAj3G,KAAAw2G,mBAAAA,EACYx2G,KAAAypC,MAAAA,EA/CLzpC,KAAAq7G,YAAc,CAAC,UAAW,QAAS,OAG7Cr7G,KAAA2oB,WAAa,YAEZ3oB,KAAA8zG,gBAAkC,GAGlC9zG,KAAA+zG,QAAU,IAAIj5D,GAAAA,QAMd96C,KAAAkzG,aAAc,EACdlzG,KAAAo6G,SAAW,GAMVp6G,KAAAugC,SAAmB,IAEnBvgC,KAAA+C,OAAiB,EAchB/C,KAAA68F,OAA4B,IAAIr/D,GAAAA,aAipC5C,SAAgB+2E,GAAWlvG,EAAoBmR,OAEvCsmG,EAAc,CAClB,IAAI9mF,GAAAA,MAAc,CAChB5qB,SAAU/F,EAAQ2rB,cAClBzE,MAAO,IAAI0J,GAAAA,OAAe,CACxBjT,OAAQ,EACR4S,OAAQ,IAAIC,GAAAA,OAAe,CAAEhY,MAAO,UAAWiY,MAAO,SAKtDinF,EAAY,IAAI/mF,GAAAA,MAAc,CAClCzJ,MAAO,IAAIkL,GAAAA,KAAa,CACtBzJ,IAAK,iCAAmC3oB,EAAQ8S,IAAI,aAAe,YACnEmR,QAAUjkB,EAAQ8S,IAAI,eACtBuf,QAAS,CAAC,GAAI,IACdC,OAAQ,CAAC,GAAK,OAGhBzB,KAAM,IAAIC,GAAAA,KAAa,CACrBD,KAAM7wB,EAAQ8S,IAAI,YAClBqV,KAAM,0BACNuI,KAAM,IAAIK,GAAAA,KAAa,CAAEvY,MAAO,SAChC+X,OAAQ,IAAIC,GAAAA,OAAe,CAAEhY,MAAO,OAAQiY,MAAO,IACnDO,UAAU,MAIR2mF,EAAa,CACjB,IAAIhnF,GAAAA,MAAc,CAChBJ,OAAQ,IAAIC,GAAAA,OAAe,CAAEhY,MAAO,UAAWiY,MAAO,GAAIxM,QAAS,QAErE,IAAI0M,GAAAA,MAAc,CAChBJ,OAAQ,IAAIC,GAAAA,OAAe,CAAEhY,MAAO,UAAWiY,MAAO,EAAGxM,QAAS,SAItE,MAA4B,SAAxBjkB,EAAQ8S,IAAI,QACP4kG,EAEmB,WAAxB13G,EAAQ8S,IAAI,QACP2kG,EAEmB,UAAxBz3G,EAAQ8S,IAAI,QACP6kG,OADT,ECzxCF,IAAAC,IAuBEA,GAAA79G,UAAAo0B,gBAAA,WAAA,IAAA7oB,EAAA3K,KACQk9G,EAAcl9G,KAAKi3G,sBAAsBrE,WAC/C,IACGsK,GAAel9G,KAAKypC,OACrBzpC,KAAKypC,MAAMlpC,QAAQo8G,mBAEnB38G,KAAKypC,MAAMo5B,YAAYlrD,UAAS,SAAC/R,OACzBu3G,EACJv3G,EAAO+E,EAAK8+B,MAAMlpC,QAA0B,oBAE9C,GAAI48G,EAAkB,KACdC,EAAqBD,EAAiB1yG,MAAM,KAClD,GAAiC,GAA7B2yG,EAAmBr6G,OAAa,KAC9Bs6G,EAAM,EACVD,EAAmBvyG,QAAO,SAAC6c,GACb,IAAR21F,GAAaA,IAAQD,EAAmBr6G,OAAS,GACnD4H,EAAK4pB,UAAUi+E,MAAMwE,OAAOqG,EAAK1yG,EAAK4pB,UAAUm/E,kBAG5C4J,EAAyBj0G,KAAKo1B,MAAM,IAAM/W,EAAQ,KACxD/c,EAAK4pB,UAAUi+E,MACZ8C,GAAG+H,GACH1a,WAAW,CAAE+P,gBAAiB4K,IACjC3yG,EAAK4pB,UAAUi+E,MACZ8C,GAAG+H,GACH1a,WAAW,CAAE0T,UAAWiH,IAC3B3yG,EAAK4pB,UAAUghF,wBACb+H,EACAD,GAIF1yG,EAAK4pB,UAAUihF,eAAe8H,EAAwBD,GACtDA,MAEF1yG,EAAK4pB,UAAU0hF,WAAU,YAI1B,GAAIiH,EAAa,CACtB,IAAK,IAAIt6G,EAAI,EAAGA,EAAIs6G,EAAYn6G,OAAQH,IAC5B,IAANA,GAAWA,IAAMs6G,EAAYn6G,OAAS,GACxC/C,KAAKu0B,UAAUi+E,MAAMwE,OAAOp0G,EAAG5C,KAAKu0B,UAAUm/E,cAE5CwJ,EAAYt6G,GAAG8vG,2BAA2BzwG,QAC5CjC,KAAKu0B,UAAUihF,eAAe0H,EAAYt6G,GAAG8vG,gBAAiB9vG,GAC9D5C,KAAKu0B,UAAUi+E,MAAM8C,GAAG1yG,GAAG+/F,WAAWua,EAAYt6G,KAGtD5C,KAAKu0B,UAAU0hF,YAEjBj2G,KAAKu0B,UAAU6/E,gDA9DlBx/E,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,2EAJHoyG,GAAuB1vG,WAAA,CAAA,CAAAsC,KAS3BovB,GAAAA,cARIw9E,UAHA9oE,GAAAA,aAAYpmC,WAAA,CAAA,CAAAsC,KAahB+jC,GAAAA,cAwDLyzE,IA3DE,SAAAA,GACkB1oF,EACR0iF,EACYxtE,GAFJzpC,KAAAu0B,UAAAA,EACRv0B,KAAAi3G,sBAAAA,EACYj3G,KAAAypC,MAAAA,ECpBxB,IAAA8zE,IA8CSA,GAAAv8G,QAAP,WACE,MAAO,CACLC,SAAUs8G,0BAxBfp8G,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACA2mE,GAAAA,YACA2e,GAAAA,oBACArlF,GAAAA,cACAC,GAAAA,gBACA8mE,GAAAA,cACAJ,GAAAA,iBACAF,GAAAA,mBACAD,GAAAA,eACAkyB,GAAAA,gBACA5xB,GAAAA,gBACA5mE,GAAAA,iBACAm4F,GAAAA,sBACAl4F,GAAAA,mBAEFC,QAAS,CAACmxG,GAAyBoK,IACnCt7G,aAAc,CAACkxG,GAAyBoK,IACxC/7G,UAAW,CAACmxG,GAAuBL,UAQrCuL,IA3BA,SAAAA,MCjBA,SAAgBC,GAA2B19C,GACzC,OAAO,IAAI8wC,GAAoB9wC,GAMjC,SAAgB29C,KACd,MAAO,CACLjkB,QAASoX,GACT9J,WAAY0W,GACZxW,KAAM,CAACtpC,aCeTggD,GAAAt+G,UAAAu+G,aAAA,SAAanyD,GACX,OAAOA,wBALV9rD,GAAAA,uDAtBQsgC,GAAAA,mBA6BT09E,IALE,SAAAA,GAAoBx+E,GAAAl/B,KAAAk/B,gBAAAA,EAUtB,IAAA5nB,GAAAsmG,IAC0C52G,GAAAA,GAD1CsQ,GAC0ComD,IAQxC59D,OAAAC,eAAI69G,GAAAx+G,UAAA,QAAK,KAAT,WACE,OAAOY,KAAK69G,OAAOhhF,4CA6BrB+gF,GAAAx+G,UAAAshB,MAAA,WACE,OAAOk9F,GAAqB/2G,IAG9B+2G,GAAAx+G,UAAAuyB,QAAA,WACE,OAAOisF,GAAqBn4G,MAGpBm4G,GAAAx+G,UAAAu+D,kBAAV,eACQmgD,EACJ99G,KAAKO,QAAQqF,QAAU5F,KAAKO,QAAQqF,OAAOk4G,MACvC34F,OAAOnlB,KAAKO,QAAQqF,OAAOk4G,OAC3Br2G,UACAs2G,EACJ/9G,KAAKO,QAAQqF,QAAU5F,KAAKO,QAAQqF,OAAOm4G,MACvC54F,OAAOnlB,KAAKO,QAAQqF,OAAOm4G,OAC3Bt2G,UACAo3D,EACJ7+D,KAAKO,QAAQqF,QAAU5F,KAAKO,QAAQqF,OAAOH,KACvCzF,KAAKO,QAAQqF,OAAOH,KACjBsI,QAAQ,MAAO,IACfmB,cACAzE,MAAM,KACT,CACE,WACA,gBACA,SACA,gBACA,MACA,WACA,SAER,MAAO,CACLoH,MAAO,+BACPksD,UAAW,8CACXC,SAAU,CACR,CACEv4D,KAAM,WACNoM,MAAO,eACP7C,KAAM,OACN8I,OAAQ,CACN,CACEjG,MAAO,uCACP3R,MAAO,WACPuI,SAAwC,IAA/Bo2D,EAAM7tD,QAAQ,YACvBstD,SAAU,CAAC,YAEb,CACEzsD,MAAO,0CACP3R,MAAO,qBACPuI,SAAkD,IAAzCo2D,EAAM7tD,QAAQ,sBACvBstD,SAAU,CAAC,uBAEb,CACEzsD,MAAO,0CACP3R,MAAO,gBACPuI,SAA6C,IAApCo2D,EAAM7tD,QAAQ,iBACvBstD,SAAU,CAAC,gBAEb,CACEzsD,MAAO,oCACP3R,MAAO,SACPuI,SAAsC,IAA7Bo2D,EAAM7tD,QAAQ,UACvBstD,SAAU,CAAC,UAEb,CACEzsD,MAAO,oCACP3R,MAAO,gBACPuI,SAA6C,IAApCo2D,EAAM7tD,QAAQ,iBACvBstD,SAAU,CAAC,eAAgB,QAE7B,CACEzsD,MAAO,uCACP3R,MAAO,0BACPuI,SAAuD,IAA9Co2D,EAAM7tD,QAAQ,2BACvBstD,SAAU,CAAC,4BAEb,CACEzsD,MAAO,mCACP3R,MAAO,MACPuI,SAAmC,IAA1Bo2D,EAAM7tD,QAAQ,OACvBstD,SAAU,CAAC,QAEb,CACEzsD,MAAO,wCACP3R,MAAO,WACPuI,SAAwC,IAA/Bo2D,EAAM7tD,QAAQ,YACvBstD,SAAU,CAAC,wBAAyB,aAEtC,CACEzsD,MAAO,0CACP3R,MAAO,cACPuI,SAA2C,IAAlCo2D,EAAM7tD,QAAQ,eACvB4sD,WAAW,EACXU,SAAU,CAAC,eAEb,CACEzsD,MAAO,qCACP3R,MAAO,QACPuI,SAAqC,IAA5Bo2D,EAAM7tD,QAAQ,SACvBstD,SAAU,CAAC,SAEb,CACEzsD,MAAO,oCACP3R,MAAO,cACPuI,SAA2C,IAAlCo2D,EAAM7tD,QAAQ,eACvBstD,SAAU,CAAC,QAAS,SAAU,SAEhC,CACEzsD,MAAO,kCACP3R,MAAO,YACPuI,SAAS,EACT61D,SAAU,CAAC,QAAS,SAAU,SAAU,SAI9C,CACE74D,KAAM,cACNoM,MAAO,gBACP7C,KAAM,QACN8I,OAAQ,CACN,CACEjG,MAAO,IACP3R,MAAO,EACPuI,QAAmB,IAAVq1G,GAEX,CACEjsG,MAAO,IACP3R,MAAO,EACPuI,QAAmB,IAAVq1G,IAAgBA,GAE3B,CACEjsG,MAAO,KACP3R,MAAO,GACPuI,QAAmB,KAAVq1G,GAEX,CACEjsG,MAAO,KACP3R,MAAO,GACPuI,QAAmB,KAAVq1G,GAEX,CACEjsG,MAAO,KACP3R,MAAO,GACPuI,QAAmB,KAAVq1G,KAIf,CACEr4G,KAAM,cACNoM,MAAO,QACP7C,KAAM,QACN8I,OAAQ,CACN,CACEjG,MAAO,OACP3R,MAAO,GACPuI,QAAmB,KAAVs1G,GAEX,CACElsG,MAAO,OACP3R,MAAO,GACPuI,QAAmB,KAAVs1G,IAAiBA,GAE5B,CACElsG,MAAO,OACP3R,MAAO,GACPuI,QAAmB,KAAVs1G,GAEX,CACElsG,MAAO,OACP3R,MAAO,GACPuI,QAAmB,KAAVs1G,GAEX,CACElsG,MAAO,QACP3R,MAAO,IACPuI,QAAmB,MAAVs1G,KAIf,CACEt4G,KAAM,cACNoM,MAAO,iBACP7C,KAAM,MACN8I,OAAQ,CACN,CACEjG,MAAO,6CACP3R,MAAO,OACPuI,SAAS,GAEX,CACEoJ,MAAO,gDACP3R,MAAO,QACPuI,SAAS,QAarBm1G,GAAAx+G,UAAA0/D,OAAA,SACE54B,EACA3lC,GAFF,IAAAoK,EAAA3K,KAIQ4F,EAAS5F,KAAKg+G,qBAAqB93E,EAAM3lC,GAAW,IAC1D,OAAKqF,EAAOuS,IAAI,QAAQpV,QAGxB/C,KAAKO,QAAQqF,OAAOq4G,KAAOr4G,EAAOuS,IAAI,SAAW,IAE1CnY,KAAKkY,KAAKC,IAAOnY,KAAK+9D,UAAS,WAAY,CAAEn4D,OAAMA,IAAIwlB,KAC5D5Y,GAAAA,IAAG,SAAE8c,GAA+B,OAAA3kB,EAAKuzG,eAAe5uF,KACxD+9B,GAAAA,WAAU,SAACC,GAKT,MAJAA,EAAI5oD,MAAMquD,WAAY,EACtBzF,EAAI5oD,MAAMmN,MAAQlH,EAAKu0B,gBAAgBC,UAAUC,QAC/Cz0B,EAAKgzD,oBAAoB9rD,OAErBy7C,MAXD/uB,GAAAA,GAAG,KAgBNq/E,GAAAx+G,UAAA++G,gBAAR,WAAA,IAAAxzG,EAAA3K,KACE,OAAOA,KAAKkY,KACTC,IAAOnY,KAAK+9D,UAAS,UACrBpmD,UAAS,SAAEknD,GACUl0D,EAAKqzD,SAASlvD,KAAI,SAACnM,GAAK,MAAW,SAAXA,EAAEqM,OAClC8I,OAAOjN,QAAO,SAAC4O,OACnBwqD,EAAQ,IAAInwD,OAAO,IAAI2F,EAAEvZ,MAAK,WAC9Bk+G,EAAev/C,EAAM70D,OAAM,SAAC9J,GAAS,OAAA+jE,EAAM76D,KAAKlJ,KACtDuZ,EAAEmkD,UAAkC,EAAtBwgD,EAAar7G,OACX,UAAZ0W,EAAEvZ,QACJyK,EAAK0zG,oBAAmB15G,GAAA,IACd25G,IACNF,EACG5rG,IAAG,SAAC9P,GAAK,OAAAA,EAAE+H,MAAM,OACjBm5B,OAAM,SAAEoD,EAAGllC,GAAM,OAAAklC,EAAEpiC,OAAO9C,KAC1BkI,OAAM,SAACtH,GAAK,MAAM,UAANA,YAQrBk7G,GAAAx+G,UAAA4+G,qBAAR,SACE93E,EACA3lC,OAEMsiE,EAAmB/iE,OAAO2C,OAC9B,CACE2I,UAAU,EACVyrD,MAAM,EACNn+B,MAAM,EACNjzB,KACE,mFAEJzF,KAAK4F,OACL5F,KAAKu+G,oBAAoBr4E,EAAM3lC,GAAW,IAAIqF,OAC9C,CACE44G,EAAGx+G,KAAKy+G,YAAYv4E,GACpB+3E,KAAM19G,EAAQ09G,OAIlB,GAAwB,SAApBp7C,EAAYiK,IAAgB,CACxB,IAAAhoD,EAAAxgB,GAAA/D,EAAAyI,OAAA,GAAC01G,EAAA55F,EAAA,GAAM65F,EAAA75F,EAAA,GAAM85F,EAAA95F,EAAA,GAAM+5F,EAAA/5F,EAAA,GACzB+9C,EAAYiK,IAAS4xC,EAAI,IAAIC,EAAI,IAAIC,EAAI,IAAID,EAAI,IAAIC,EAAI,IAAIC,EAAI,IAAIH,EAAI,IAAIG,EAAI,IAAIH,EAAI,IAAIC,MAChE,UAApB97C,EAAYiK,YACdjK,EAAYiK,IAOrB,OAJoC,IAAhCjK,EAAY27C,EAAExtG,QAAQ,OACxB6xD,EAAYp9D,KAAO,SAGd,IAAImoD,GAAAA,WAAW,CAAEC,WAAYl8C,GAAAA,YAAY29C,gBAAgBuT,MAG1D+6C,GAAAx+G,UAAA8+G,eAAR,SAAuB5uF,GAAvB,IAAA3kB,EAAA3K,KACE,OAAOsvB,EAAS3W,SAASnG,IAAG,SAAEwL,GAC5B,OAAOrT,EAAKm0G,UAAUnB,aAAahzG,EAAKo0G,aAAa/gG,EAAMsR,OAIvDsuF,GAAAx+G,UAAA2/G,aAAR,SAAqB/gG,EAAoBsR,OACjClb,EAAapU,KAAKg/G,kBAAkBhhG,GACpCnX,EAAK,CAAC7G,KAAK0gB,QAAStM,EAAW3O,KAAM2O,EAAW6T,MAAMxe,KAAK,KAE3Dw1G,EAAYjhG,EAAKkhG,UAAUrtG,OAASmM,EAAK5J,WAAW6oD,IACpDkiD,EAAenhG,EAAKkhG,UAAUE,OAChC,YAAcphG,EAAKkhG,UAAUE,OAAS,WACtC,GACEC,EAAgBrhG,EAAKkhG,UAAUI,OACjC,eAAiBthG,EAAKkhG,UAAUI,OAAS,WACzC,GAEJ,MAAO,CACLj+F,OAAQrhB,KACRge,KAAM,CACJvY,KAAM8b,GACNoH,WAAY,YACZvd,SAAU4S,EAAK5S,SACfpC,OAAQgV,EAAK64C,KACbziD,WAAUA,EACVs+B,KAAM,CACJ7rC,GAAEA,EACFgL,MAAOmM,EAAK5J,WAAW6oD,MAG3BvqB,KAAM,CACJ6sE,SAAUh+F,GACV1a,GAAEA,EACFgL,MAAOmM,EAAK5J,WAAW6oD,IACvBgiD,UAAWA,EAAYE,EAAeE,EACtC3mF,KAAM1a,EAAK0a,MAAQ,aACnB8mF,SAAUlwF,EAAS3W,SAAS5V,QAAU/C,KAAKO,QAAQqF,OAAOk4G,OAAU,IAAM99G,KAAKO,QAAQqF,OAAOq4G,KAAO,MAKnGL,GAAAx+G,UAAA4/G,kBAAR,SAA0BhhG,OAClB5J,EAAazC,GAAAA,YAAY8tG,WAC7BzhG,EAAK5J,WACLwpG,GAAqB8B,qBAGvB,GAAI1hG,EAAK5S,WAAa3D,UACpB,OAAO3H,OAAO2C,OAAO,CAAEgD,KAAMuY,EAAKjN,OAASqD,OAUzCurG,EAWAC,EAlBEC,EAGF,CACFC,WAAY,IAId,GAA2B,UAAvB9hG,EAAK5S,SAAS3F,KAChBk6G,EAAa3gD,GAAYC,uBACvBjhD,EAAK5S,SAASq0C,YAAY,GAC1BzhC,EAAK5S,SAASq0C,YAAY,QAEvB,KACC+H,EAAQu4D,GAAe/hG,EAAK5S,UAClCu0G,EAAa3gD,GAAYC,uBAAuBzX,EAAMp8C,SAASq0C,YAAY,GAAI+H,EAAMp8C,SAASq0C,YAAY,IAuB5G,OAlBEmgE,EADiB,WAAf5hG,EAAKjN,MACSiuD,GAAYG,sBAAsBnhD,EAAK5J,WAAW6oD,IAAM,KAAOj/C,EAAK5J,WAAW4rG,cACvE,kBAAfhiG,EAAKjN,MACEiuD,GAAYG,sBAAsBnhD,EAAK5J,WAAW6oD,IAAM,KAAOj/C,EAAK5J,WAAW6rG,UAE/EjhD,GAAYG,sBAAsBnhD,EAAK5J,WAAW6oD,KAAOj/C,EAAKkhG,UAAUrtG,OAG1FguG,EAAsBC,WAAa,WAAaH,EAAa,oBAC3D3/G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,yBAA2B,uBAAyBwgF,EACzF,oBAAsB5/G,KAAKk/B,gBAAgBC,UAAUC,QAAQ,wBAA0B,OAEhE,UAAvBphB,EAAK5S,SAAS3F,OAChBo6G,EAAsBK,iBAAmBlhD,GAAYE,wBACnDlhD,EAAK5S,SAASq0C,YAAY,GAC1BzhC,EAAK5S,SAASq0C,YAAY,KAIvB3/C,OAAO2C,OACZ,CAAEgD,KAAMuY,EAAKjN,OACbqD,EACAyrG,IAQIjC,GAAAx+G,UAAAq/G,YAAR,SAAoBv4E,GAApB,IAAAv7B,EAAA3K,KAuBE,OArBiBkmC,EAAKxwB,MAAM,eAAiB,IAE7ByqG,KAAI,SAACzhD,OACbC,EAAaD,EAAQE,UAAU,GACrC,OAAOj0D,EAAK0zG,oBAAoB8B,KAAI,SAClCC,GACE,OAAAA,EACGlxG,cACAowB,UAAU,OACVvxB,QAAQ,mBAAoB,MAC/B4wD,EACGzvD,cACAowB,UAAU,OACVvxB,QAAQ,mBAAoB,UAKnCm4B,EAAOA,EAAKn4B,QAAQ,aAAc,KAG7Bm4B,EAAKn4B,QAAQ,wBAAyB,KAQvC6vG,GAAAx+G,UAAAm/G,oBAAR,SACEr4E,EACA3lC,OAEM+9D,EAAWhnD,GAAAlY,UAAMg/D,iBAAgBp7D,KAAAhD,KAACkmC,EAAM,QAO9C,OANIo4B,IACF/9D,EAAQqF,OAAS9F,OAAO2C,OAAOlC,EAAQqF,QAAU,GAAI,CACnDH,KAAM64D,EAAS70D,KAAK,QAIjBlJ,GAjdFq9G,GAAA/2G,GAAK,WACL+2G,GAAAn4G,KAAO8b,GACPq8F,GAAA8B,oBAAgC,wBAJxChgH,GAAAA,uDAxCQga,GAAAA,kBAMAsmB,GAAAA,mDAkDJozB,GAAAA,OAAMzzD,KAAA,CAAC,oBAEW+9G,GAA6Bv6G,WAAA,CAAA,CAAAsC,KAD/C2tD,GAAAA,OAAMzzD,KAAA,CAAC+9G,aA1DiBvb,GAAAA,YA8f7Byb,IAxcE,SAAAA,GACU1lG,EACAgnB,EACW3+B,EAEXu+G,EACRhd,GANF,IAAAn3F,EAQE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,KAPN2K,EAAAuN,KAAAA,EACAvN,EAAAu0B,gBAAAA,EAGAv0B,EAAAm0G,UAAAA,EAbVn0G,EAAAkzG,OAAkC,IAAI5yF,GAAAA,gBAAwB,IAEtDtgB,EAAA0zG,oBAAsB,GAgB5B1zG,EAAKu0B,gBAAgBC,UAClBhnB,IAAIxN,EAAKpK,QAAQsR,OACjB8F,UAAS,SAAC9F,GAAS,OAAAlH,EAAKkzG,OAAOz5G,KAAKyN,SAEjCwuG,EAAcve,EAAS3pF,IAAImoG,GAAAA,oBAC7B31G,EAAKqzD,SAASj7D,SACXs9G,EAGHA,EAAYE,cAAc5oG,UAAS,WACjChN,EAAKwzG,oBAHPxzG,EAAKwzG,qBA4bb,IAAA7mG,GAAAkpG,IACiDx5G,GAAAA,GADjDsQ,GACiDomD,IAQ/C59D,OAAAC,eAAIygH,GAAAphH,UAAA,QAAK,KAAT,WACE,OAAOY,KAAK69G,OAAOhhF,4CA2BrB2jF,GAAAphH,UAAAshB,MAAA,WACE,OAAO8/F,GAA4B35G,IAGrC25G,GAAAphH,UAAAuyB,QAAA,WACE,OAAO6uF,GAA4B/6G,MAG3B+6G,GAAAphH,UAAAu+D,kBAAV,eACQkB,EACJ7+D,KAAKO,QAAQqF,QAAU5F,KAAKO,QAAQqF,OAAOH,KACvCzF,KAAKO,QAAQqF,OAAOH,KACjBsI,QAAQ,MAAO,IACfmB,cACAzE,MAAM,KACT,CAAC,WAAY,gBAAiB,MAAO,YAE3C,MAAO,CACLoH,MAAO,sCACPksD,UAAW,6CACXC,SAAU,CACR,CACEv4D,KAAM,WACNoM,MAAO,eACP7C,KAAM,OACN8I,OAAQ,CACN,CACEjG,MAAO,uCACP3R,MAAO,WACPuI,SAAwC,IAA/Bo2D,EAAM7tD,QAAQ,aAEzB,CACEa,MAAO,oCACP3R,MAAO,SACPuI,SAAsC,IAA7Bo2D,EAAM7tD,QAAQ,UACvB4sD,WAAW,GAEb,CACE/rD,MAAO,wCACP3R,MAAO,kBACPuI,SAA+C,IAAtCo2D,EAAM7tD,QAAQ,oBAEzB,CACEa,MAAO,oCACP3R,MAAO,gBACPuI,SAA6C,IAApCo2D,EAAM7tD,QAAQ,kBAEzB,CACEa,MAAO,mCACP3R,MAAO,MACPuI,SAAmC,IAA1Bo2D,EAAM7tD,QAAQ,QAEzB,CACEa,MAAO,wCACP3R,MAAO,WACPuI,SAAwC,IAA/Bo2D,EAAM7tD,QAAQ,eAI7B,CACEvL,KAAM,cACNoM,MAAO,SACP7C,KAAM,SACN8I,OAAQ,CACN,CACEjG,MAAO,QACP3R,MAAO,IACPuI,SAAUzI,KAAKO,QAAQ49F,UAAsC,MAA1Bn+F,KAAKO,QAAQ49F,UAElD,CACEtsF,MAAO,QACP3R,MAAO,IACPuI,QAAmC,MAA1BzI,KAAKO,QAAQ49F,UAExB,CACEtsF,MAAO,OACP3R,MAAO,IACPuI,QAAmC,MAA1BzI,KAAKO,QAAQ49F,UAExB,CACEtsF,MAAO,OACP3R,MAAO,IACPuI,QAAmC,MAA1BzI,KAAKO,QAAQ49F,UAExB,CACEtsF,MAAO,OACP3R,MAAO,IACPuI,QAAmC,MAA1BzI,KAAKO,QAAQ49F,eAclCqiB,GAAAphH,UAAA8xG,cAAA,SACEjvF,EACA1hB,GAFF,IAAAoK,EAAA3K,KAIQ4F,EAAS5F,KAAKg+G,qBAAqB/7F,EAAQ1hB,GAAW,IAC5D,OAAKqF,EAAOuS,IAAI,QAAQpV,OAGjB/C,KAAKkY,KAAKC,IAAOnY,KAAK+9D,UAAS,UAAW,CAAEn4D,OAAMA,IAAIwlB,KAC3D5Y,GAAAA,IAAG,SAAE8c,GACH,OAAO3kB,EAAKuzG,eAAe5uF,MAJtBiP,GAAAA,GAAG,KASNiiF,GAAAphH,UAAA++G,gBAAR,WAAA,IAAAxzG,EAAA3K,KACE,OAAOA,KAAKkY,KACTC,IAAOnY,KAAK+9D,UAAS,UACrBpmD,UAAS,SAAEknD,GACUl0D,EAAKqzD,SAASlvD,KAAI,SAACnM,GAAK,MAAW,SAAXA,EAAEqM,OAClC8I,OAAOjN,QAAO,SAAC4O,GACzBA,EAAEmkD,WAAgD,EAApCiB,EAAM7tD,QAAQyI,EAAO,YAKnC+mG,GAAAphH,UAAA4+G,qBAAR,SACE/7F,EACA1hB,GAQA,OANIA,EAAQ49F,UAAYn+F,KAAKO,QAAQ49F,YACnC59F,EAAQqF,OAAS9F,OAAO2C,OAAOlC,EAAQqF,QAAU,GAAI,CACnDw2C,OAAQ77C,EAAQ49F,UAAYn+F,KAAKO,QAAQ49F,YAItC,IAAIvwC,GAAAA,WAAW,CACpBC,WAAY/tD,OAAO2C,OACjB,CACEqqE,IAAK7qD,EAAOxY,KAAK,KACjBy3B,KAAM,WACN91B,UAAU,EACVstB,MAAM,GAERn4B,EAAQqF,QAAU,GAClB5F,KAAK4F,WAKH46G,GAAAphH,UAAA8+G,eAAR,SACE5uF,GADF,IAAA3kB,EAAA3K,KAGE,OAAOsvB,EAAS3W,SAASnG,IAAG,SAAEwL,GAC5B,OAAOrT,EAAKo0G,aAAa/gG,MAIrBwiG,GAAAphH,UAAAqhH,YAAR,SAAoBziG,GAClB,IAAKhe,KAAKg+D,SAASj7D,OACjB,MAAO,OAEL29G,EAAW,GACf,OAAQ1iG,EAAK5J,WAAW3O,MACtB,IAAK,kBACHi7G,EAAW1iG,EAAK5J,WAAW4rG,aAAe,oBAC1C,MACF,YAEQv6G,EADczF,KAAKg+D,SAASlvD,KAAI,SAACnM,GAAK,MAAW,SAAXA,EAAEqM,OACrB8I,OAAOhJ,KAAI,SAClCpM,GAAK,OAAAA,EAAExC,QAAU8d,EAAK5J,WAAW3O,OAE/BA,IACFi7G,EAAW1gH,KAAKk/B,gBAAgBC,UAAUC,QAAQ35B,EAAKoM,QAG7D,OAAO6uG,GAGDF,GAAAphH,UAAA2/G,aAAR,SAAqB/gG,OACb5J,EAAapU,KAAKg/G,kBAAkBhhG,GACpChV,EAAShJ,KAAK2gH,cAAc3iG,GAC5BnX,EAAK,CAAC7G,KAAK0gB,QAAStM,EAAW3O,KAAM2O,EAAW6T,MAAMxe,KAAK,KAE3Dw1G,EAAYjhG,EAAK5J,WAAW6oD,IAC5BkiD,EAAe,YAAcn/G,KAAKygH,YAAYziG,GAAQ,WAE5D,MAAO,CACLqD,OAAQrhB,KACRge,KAAM,CACJvY,KAAM8b,GACNoH,WAAY,YACZvd,SAAU4S,EAAK5S,SACfpC,OAAMA,EACNoL,WAAUA,EACVs+B,KAAM,CACJ7rC,GAAEA,EACFgL,MAAOmM,EAAK5J,WAAW6oD,MAG3BvqB,KAAM,CACJ6sE,SAAUh+F,GACV1a,GAAEA,EACFgL,MAAOmM,EAAK5J,WAAW6oD,IACvBgiD,UAAWA,EAAYE,EACvBzmF,KAAM1a,EAAK0a,MAAQ,gBAKjB8nF,GAAAphH,UAAA4/G,kBAAR,SAA0BhhG,GAKxB,OAJmBrM,GAAAA,YAAY8tG,WAC7BzhG,EAAK5J,WACLosG,GAA4Bd,sBAKxBc,GAAAphH,UAAAuhH,cAAR,SACE3iG,GAEA,OAAOA,EAAK64C,KACR,CAAC74C,EAAK64C,KAAK,GAAI74C,EAAK64C,KAAK,GAAI74C,EAAK64C,KAAK,GAAI74C,EAAK64C,KAAK,IACrDpvD,WAlQC+4G,GAAA35G,GAAK,kBACL25G,GAAA/6G,KAAO8b,GACPi/F,GAAAd,oBAAgC,wBALxChgH,GAAAA,uDAlgBQga,GAAAA,kBAMAsmB,GAAAA,mDA4gBJozB,GAAAA,OAAMzzD,KAAA,CAAC,oBAnhBiBwiG,GAAAA,YA0wB7Bqe,IA1PE,SAAAA,GACUtoG,EACAgnB,EACW3+B,EACnBuhG,GAJF,IAAAn3F,EAME2M,GAAAtU,KAAAhD,KAAMO,IAAQP,KALN2K,EAAAuN,KAAAA,EACAvN,EAAAu0B,gBAAAA,EARVv0B,EAAAkzG,OAAkC,IAAI5yF,GAAAA,gBAAwB,IAc5DtgB,EAAKu0B,gBAAgBC,UAClBhnB,IAAIxN,EAAKpK,QAAQsR,OACjB8F,UAAS,SAAC9F,GAAS,OAAAlH,EAAKkzG,OAAOz5G,KAAKyN,SAEjCwuG,EAAcve,EAAS3pF,IAAImoG,GAAAA,oBAC7B31G,EAAKqzD,SAASj7D,SACXs9G,EAGHA,EAAYE,cAAc5oG,UAAS,WACjChN,EAAKwzG,oBAHPxzG,EAAKwzG,qBC/gBb,SAAgByC,GACd1hF,GAEA,OAAO,IAAIw+E,GAA8Bx+E,GAM3C,SAAgB2hF,KACd,MAAO,CACLrnB,QAASkkB,GACT5W,WAAY8Z,GACZ5Z,KAAM,CAAChnE,GAAAA,kBAQX,SAAgB8gF,GACd5oG,EACAgnB,EACA/hB,EACA2hG,EACAhd,GAEA,OAAO,IAAI8b,GACT1lG,EACAgnB,EACA/hB,EAAOinC,UAAU,iBAAiBw5D,GAAqB/2G,IACvDi4G,EACAhd,GA0BJ,SAAgBif,GACd7oG,EACAgnB,EACA/hB,EACA2kF,GAEA,OAAO,IAAI0e,GACTtoG,EACAgnB,EACA/hB,EAAOinC,UAAU,iBAAiBo8D,GAA4B35G,IAC9Di7F,WCjEFkf,GAAA5hH,UAAAu+G,aAAA,SAAanyD,GACX,OAAOA,wBALV9rD,GAAAA,uDANQsgC,GAAAA,mBAaTghF,IALE,SAAAA,GAAoB9hF,GAAAl/B,KAAAk/B,gBAAAA,EAStB,IAAA5nB,GAAA2pG,IACoDj6G,GAAAA,GADpDsQ,GACoDomD,IASlD59D,OAAAC,eAAIkhH,GAAA7hH,UAAA,QAAK,KAAT,WACE,OAAOY,KAAK69G,OAAOhhF,4CAerBokF,GAAA7hH,UAAAshB,MAAA,WACE,OAAOugG,GAA+Bp6G,IAGxCo6G,GAAA7hH,UAAAuyB,QAAA,WACE,OAAOsvF,GAA+Bx7G,MAG9Bw7G,GAAA7hH,UAAAu+D,kBAAV,WACE,MAAO,CACL9rD,MAAO,kCACPgnD,MAAO,EACPiF,gBAAgB,IAUpBmjD,GAAA7hH,UAAA8xG,cAAA,SACEjvF,EACA1hB,GAEA,OAAOg+B,GAAAA,GAAG,CAACv+B,KAAK++G,aAAa98F,MAGvBg/F,GAAA7hH,UAAA2/G,aAAR,SAAqB/gG,OAEbi8F,EADiBpyF,GAAiB7J,EAAMhe,KAAK8nB,aACrB8b,OAAM,SAAEs9E,EAAKljF,GAAS,OAClDkjF,EAAIljF,EAAKnmB,OAASmmB,EAAK9V,gBAAiBg5F,GAAM,IAE1CC,EAAqB15F,GAAazJ,EAAM,GAAGvU,KAAK,MAGhD23G,EAAc,GAGpB,OAFAA,EAFkBphH,KAAKk/B,gBAAgBC,UAAUC,QAAQ,qCAEjC+hF,EAEjB,CACL9/F,OAAQrhB,KACRge,KAAM,CACJvY,KAAM8b,GACNoH,WAAY,YACZvd,SAAU,CACR3F,KAAM,QACNg6C,YAAa,CAACzhC,EAAK,GAAIA,EAAK,KAE9BhV,OAAQvB,UACR2M,WAAYtU,OAAO2C,OAAO,GACxB2+G,EACAnH,EACA,CACE6F,WAAY9gD,GAAYC,uBAAuBjhD,EAAK,GAAIA,EAAK,IAC7DkiG,iBAAkBlhD,GAAYE,wBAC5BlhD,EAAK,GACLA,EAAK,IAEPqjG,cAAehiD,GAASC,qBAAqBthD,EAAK,GAAIA,EAAK,GAAI,MAEnE00B,KAAM,CACJ7rC,GAAImX,EAAK,GAAG+a,WAAa,IAAM/a,EAAK,GAAG+a,WACvClnB,MAAOsvG,IAGXzuE,KAAM,CACJ6sE,SAAUh+F,GACV1a,GAAImX,EAAK,GAAG+a,WAAa,IAAM/a,EAAK,GAAG+a,WACvClnB,MAAOsvG,EACPzoF,KAAM,gBA7FLuoF,GAAAp6G,GAAK,qBACLo6G,GAAAx7G,KAAO8b,wBAJf7hB,GAAAA,mFAeI0zD,GAAAA,OAAMzzD,KAAA,CAAC,oBAhCHqgC,GAAAA,+CAkCJozB,GAAAA,OAAMzzD,KAAA,CAAC,oBAmFZshH,IAtFE,SAAAA,GACqB1gH,EACX2+B,EACepX,GAHzB,IAAAnd,EAKE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YAHN2K,EAAAu0B,gBAAAA,EARVv0B,EAAAkzG,OAAkC,IAAI5yF,GAAAA,gBAAwB,IAY5DtgB,EAAKmd,YAAcA,EACnBnd,EAAKu0B,gBAAgBC,UAClBhnB,IAAIxN,EAAKpK,QAAQsR,OACjB8F,UAAS,SAAC9F,GAAS,OAAAlH,EAAKkzG,OAAOz5G,KAAKyN,OCpC3C,SAAgByvG,GACdpiF,GAEA,OAAO,IAAI8hF,GAAiC9hF,GAM9C,SAAgBqiF,KACd,MAAO,CACL/nB,QAASwnB,GACTla,WAAYwa,GACZta,KAAM,CAAChnE,GAAAA,kBAQX,SAAgBwhF,GACdrkG,EACA+hB,EACAuiF,GAEA,OAAO,IAAIR,GACT9jG,EAAOinC,UAAU,iBAAiB68D,GAA+Bp6G,IACjEq4B,EACC/hB,EAAOinC,UAAU,gBAAmC,YCdvDs9D,GAAAtiH,UAAAu+G,aAAA,SAAa3/F,GAAb,IAAArT,EAAA3K,KACQ2hH,EAAa,CACjB,QACA,WACA,aACA,cACA,cACA,UACA,QAGIroG,EAAWxZ,OAAOksC,QAAQhuB,EAAK5J,YAClCpK,OAAM,SAAE8a,OAACzhB,EAADiB,GAAAwgB,EAAA,GAAC,GAAS,OAA6B,IAA7B68F,EAAW3wG,QAAQ3N,KACrCugC,OAAM,SAAE4/C,EAA6Bx3C,GAC9B,IACF41E,EADE98F,EAAAxgB,GAAA0nC,EAAA,GAAC3oC,EAAAyhB,EAAA,GAAK5kB,EAAA4kB,EAAA,GAEZ,IACE88F,EAASj3G,EAAKu0B,gBAAgBC,UAAUC,QACtC,oCAAsC/7B,GAExC,MAAOkB,GACPq9G,EAASv+G,EAGX,OADAmgF,EAAIo+B,GAAU1hH,GAAgB,GACvBsjF,GACN,IAECq+B,EAAQ/hH,OAAO2C,OAAO,GAAIub,GAGhC,OAFA6jG,EAAMztG,WAAU,EAETytG,wBAlCVniH,GAAAA,uDAnBQsgC,GAAAA,mBAuDT0hF,IAlCE,SAAAA,GAAoBxiF,GAAAl/B,KAAAk/B,gBAAAA,EAuCtB,IAAA5nB,GAAAwqG,IACwC96G,GAAAA,GADxCsQ,GACwComD,IAMtC59D,OAAAC,eAAI+hH,GAAA1iH,UAAA,QAAK,KAAT,WACE,OAAOY,KAAK69G,OAAOhhF,4CAgBrBilF,GAAA1iH,UAAAshB,MAAA,WACE,OAAOohG,GAAmBj7G,IAG5Bi7G,GAAA1iH,UAAAuyB,QAAA,WACE,OAAOmwF,GAAmBr8G,MAGlBq8G,GAAA1iH,UAAAu+D,kBAAV,eACQmgD,EACJ99G,KAAKO,QAAQqF,QAAU5F,KAAKO,QAAQqF,OAAOk4G,MACvC34F,OAAOnlB,KAAKO,QAAQqF,OAAOk4G,OAC3Br2G,UACN,MAAO,CACLoK,MAAO,6BACPksD,UAAW,mDACXC,SAAU,CACR,CACEv4D,KAAM,WACNoM,MAAO,eACP7C,KAAM,OACN8I,OAAQ,CACN,CACEjG,MAAO,mCACP3R,MAAO,QACPuI,SAAS,EACT61D,SAAU,CAAC,QAAS,SAAU,SAAU,YAE1C,CACEzsD,MAAO,wCACP3R,MAAO,QACPuI,SAAS,EACT61D,SAAU,CAAC,WAAY,YAAa,YAAa,iBAIvD,CACE74D,KAAM,cACNoM,MAAO,gBACP7C,KAAM,QACN8I,OAAQ,CACN,CACEjG,MAAO,IACP3R,MAAO,EACPuI,QAAmB,IAAVq1G,GAEX,CACEjsG,MAAO,IACP3R,MAAO,EACPuI,QAAmB,IAAVq1G,IAAgBA,GAE3B,CACEjsG,MAAO,KACP3R,MAAO,GACPuI,QAAmB,KAAVq1G,GAEX,CACEjsG,MAAO,KACP3R,MAAO,GACPuI,QAAmB,KAAVq1G,GAEX,CACEjsG,MAAO,KACP3R,MAAO,GACPuI,QAAmB,KAAVq1G,QAarBgE,GAAA1iH,UAAA0/D,OAAA,SACE54B,EACA3lC,GAFF,IAAAoK,EAAA3K,KAIQ4F,EAAS5F,KAAK+hH,2BAA2B77E,EAAM3lC,GAAW,IAChE,OAAKqF,EAAOuS,IAAI,MAASvS,EAAOuS,IAAI,SAGpCnY,KAAKO,QAAQqF,OAAOq4G,KAAOr4G,EAAOuS,IAAI,SAAW,IAE1CnY,KAAKkY,KACTC,IAAInY,KAAK+9D,UAAW,CAAEn4D,OAAMA,IAC5BwlB,KACC5Y,GAAAA,IAAG,SAAE8c,GAAoC,OAAA3kB,EAAKuzG,eAAe5uF,OAPxDiP,GAAAA,GAAG,KAWNujF,GAAA1iH,UAAA2iH,2BAAR,SACE77E,EACA3lC,GAEA,OAAO,IAAIqtD,GAAAA,WAAW,CACpBC,WAAYl8C,GAAAA,YAAY29C,gBACtBxvD,OAAO2C,OACL,CACE+7G,EAAGx+G,KAAKy+G,YAAYv4E,IAEtBlmC,KAAK4F,OACL5F,KAAKu+G,oBAAoBr4E,EAAM3lC,GAAW,IAAIqF,OAC9C,CACEq4G,KAAM19G,EAAQ09G,WAWhB6D,GAAA1iH,UAAAq/G,YAAR,SAAoBv4E,GAClB,OAAOA,EAAKn4B,QAAQ,aAAc,IAAIA,QAAQ,wBAAyB,KAQjE+zG,GAAA1iH,UAAAm/G,oBAAR,SACEr4E,EACA3lC,OAEM+9D,EAAWhnD,GAAAlY,UAAMg/D,iBAAgBp7D,KAAAhD,KAACkmC,EAAM,QAO9C,OANIo4B,IACF/9D,EAAQqF,OAAS9F,OAAO2C,OAAOlC,EAAQqF,QAAU,GAAI,CACnDH,KAAM64D,EAAS70D,KAAK,QAIjBlJ,GAGDuhH,GAAA1iH,UAAA8+G,eAAR,SACE5uF,GADF,IAAA3kB,EAAA3K,KAGE,OAAOsvB,EAASlS,MAAM5K,IAAG,SAAEwL,GACzB,OAAArT,EAAKo0G,aAAa/gG,EAAMsR,MAIpBwyF,GAAA1iH,UAAA2/G,aAAR,SACE/gG,EACAsR,OAEMhS,EAAetd,KAAKgiH,oBAAoBhkG,GAExCihG,EAAYjhG,EAAKkhG,UAAUrtG,OAASmM,EAAK5J,WAAWvC,MACpDowG,EAAajkG,EAAKkhG,UAAU+C,YAAcjkG,EAAK5J,WAAW6tG,WAC1D9C,EAAe8C,EACjB,mCAAqCA,EAAa,WAClD,GAEJ,MAAO,CACL5gG,OAAQrhB,KACR0yC,KAAM,CACJ6sE,SAAU39F,GACV/a,GAAI,CAAC7G,KAAK0gB,QAAS1C,EAAK5J,WAAWvN,IAAI4C,KAAK,KAC5CoI,MAAOmM,EAAK5J,WAAWvC,MACvBotG,UAAWA,EAAYE,EACvBzmF,KAA+B,UAAzB1a,EAAK5J,WAAW3O,KAAmB,SAAW,MACpD+5G,SACElwF,EAASlS,MAAMra,QAAU/C,KAAKO,QAAQqF,OAAOk4G,OAAU,IACtD99G,KAAKO,QAAQqF,OAAOq4G,KAAO,IAEhCjgG,KAAMV,IAIFwkG,GAAA1iH,UAAA4iH,oBAAR,SAA4BhkG,OACpBve,EAAMue,EAAK5J,WAAW3U,IACtBojE,EAA0C7iE,KAAKkiH,gCACnDziH,GAEF,OAAOkS,GAAAA,YAAY29C,gBAAgB,CACjCpoD,cAAe,CACbL,GAAImX,EAAK5J,WAAWvN,GACpBpB,KAAMuY,EAAK5J,WAAWjN,OACtB1H,IAAGA,EACH4uD,YAAawU,EAAYxU,YACzB9zC,gBAAiBsoD,EAAYtoD,gBAC7B3U,OAAQ,CACNC,OAAQmY,EAAK5J,WAAWpF,MAE1B8gD,yBAAyB,EACzB9yC,YAAa,aAEfnL,MAAOmM,EAAK5J,WAAWvC,MACvBgZ,cAAe/D,GACb3B,OAAOnH,EAAK5J,WAAWmX,gBAEzBX,cAAe9D,GACb3B,OAAOnH,EAAK5J,WAAWoX,gBAEzBlsB,SAAU,CACRG,IAAKue,EAAK5J,WAAW+tG,YACrB5iH,QAAQ,GAEV6U,WAAYpU,KAAK8+G,UAAUnB,aAAa3/F,GAAM5J,cAI1C0tG,GAAA1iH,UAAA8iH,gCAAR,SACEziH,WAEI4uD,EACA9zC,EACE6nG,EAAapiH,KAAY,QAA+BquD,YAC9D,GAAI+zD,EAAW,gBACF/+G,OACHnD,EAAQkiH,EAAU/+G,GACxB,GAAc,MAAVnD,SACFmuD,EAAcc,GAAY9rD,EAAIg1B,2BAI1BgqF,EAAO,EAAuCA,KACpD,OAAIpgH,MAAM2uD,QAAQyxD,IAChBA,EAAKx3G,QAAO,SAACy3G,IACkB,IAAzB7iH,EAAIuR,QAAQsxG,KACdj0D,EAAcc,GAAY9rD,EAAIg1B,gCAHpC,OARF,IAAkB,IAAAnZ,EAAA1B,GAAA1d,OAAOk4B,KAAKoqF,IAAUjjG,EAAAD,EAAA9a,QAAA+a,EAAA9a,kBAA1B8a,EAAAjf,OAA0Bif,EAAAD,EAAA9a,6GAmBtCiqD,IAAgBc,GAAYl1C,MAC5Bo0C,IAAgBc,GAAYj1C,WAE5BK,EAAkB,UAItB,MAAO,CACL8zC,YAAWA,EACX9zC,gBAAeA,IA3QZunG,GAAAj7G,GAAK,SACLi7G,GAAAr8G,KAAOmc,wBAHfliB,GAAAA,uDAjEQga,GAAAA,kBAKAsmB,GAAAA,mDA0EJozB,GAAAA,OAAMzzD,KAAA,CAAC,oBAEW+hH,GAA2Bv+G,WAAA,CAAA,CAAAsC,KAD7C2tD,GAAAA,OAAMzzD,KAAA,CAAC+hH,SAiQZI,IArQE,SAAAA,GACU5pG,EACAgnB,EACW3+B,EAEXu+G,GALV,IAAAn0G,EAOE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YANN2K,EAAAuN,KAAAA,EACAvN,EAAAu0B,gBAAAA,EAGAv0B,EAAAm0G,UAAAA,EAXVn0G,EAAAkzG,OAAkC,IAAI5yF,GAAAA,gBAAwB,IAc5DtgB,EAAKu0B,gBAAgBC,UAClBhnB,IAAIxN,EAAKpK,QAAQsR,OACjB8F,UAAS,SAAC9F,GAAS,OAAAlH,EAAKkzG,OAAOz5G,KAAKyN,OC5E3C,SAAgB0wG,GACdrjF,GAEA,OAAO,IAAIwiF,GAA4BxiF,GAMzC,SAAgBsjF,KACd,MAAO,CACLhpB,QAASkoB,GACT5a,WAAYyb,GACZvb,KAAM,CAAChnE,GAAAA,kBAQX,SAAgByiF,GACdvqG,EACAgnB,EACA/hB,EACA2hG,GAEA,OAAO,IAAIgD,GACT5pG,EACAgnB,EACA/hB,EAAOinC,UAAU,iBAAiB09D,GAAmBj7G,IACrDi4G,GCvCJ,IAAa4D,GAAe,CAACnhG,GAASK,ICqBtC+gG,IAuBE7iH,OAAAC,eACI4iH,GAAAvjH,UAAA,aAAU,KACd,WAA2B,OAAOY,KAAK4iH,YAAY1iH,WAFnD,SACeA,GAAiBF,KAAK6iH,cAAc3iH,oCAUnDyiH,GAAAvjH,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAK8iH,aAAe9iH,KAAK4iH,YACtBx3F,KAAKmsB,GAAAA,wBACL5/B,UAAS,SAAE65F,GAAuB,OAAA7mG,EAAKo4G,gBAAgBvR,MAG5DmR,GAAAvjH,UAAAs0B,YAAA,WACE1zB,KAAK8iH,aAAap4F,eAQpBi4F,GAAAvjH,UAAA4jH,mBAAA,SAAmBxR,GACjBxxG,KAAK6iH,cAAcrR,IAUrBmR,GAAAvjH,UAAA6jH,mBAAA,SAAmBzR,GACjB,MAAO,kBAAkBA,EAAWtiG,cAAa,UAO3CyzG,GAAAvjH,UAAAyjH,cAAR,SAAsBrR,GACpBxxG,KAAK4iH,YAAYx+G,KAAKotG,IAGhBmR,GAAAvjH,UAAA2jH,gBAAR,SAAwBvR,GAClBA,IAAe/pG,WAA4B,OAAf+pG,IAIhCxxG,KAAKuxG,oBAAoBR,oBAAoBS,GAC7CxxG,KAAKkjH,iBAAiBpmF,KAAK00E,0BA9E9BhxG,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,25BAEAC,gBAAiBC,GAAAA,wBAAwBC,+WAdlC+vG,4CA4BN9vG,GAAAA,0BAKAA,GAAAA,gCAOAs8B,GAAAA,UAmDHulF,IAjDE,SAAAA,GAAoBpR,GAAAvxG,KAAAuxG,oBAAAA,EAxBXvxG,KAAA4iH,YAAuC,IAAI33F,GAAAA,gBAAgBxjB,WAU3DzH,KAAAmjH,YAAwBT,GAYvB1iH,KAAAkjH,iBAAmB,IAAI1lF,GAAAA,aClCnC,IAAA4lF,yBAACjiH,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAG,GAAAA,iBACAF,GAAAA,cACAC,GAAAA,gBACA2mE,GAAAA,cACA2xB,GAAAA,eACAD,GAAAA,cACApxB,GAAAA,kBACA/mE,GAAAA,mBAEFC,QAAS,CAACihH,IACVhhH,aAAc,CAACghH,QAEqBS,IAftC,SAAAA,MCSA,IAAAC,IAcEvjH,OAAAC,eAAIsjH,GAAAjkH,UAAA,gBAAa,KAAjB,WACE,OAAOY,KAAKyiD,aAAaC,iDAgB3B2gE,GAAAjkH,UAAAkkH,oBADA,SACoBjjG,GAEI,MAAlBA,EAAMojC,UACRzjD,KAAKujH,uBAAyBvjH,KAAKujH,sBACnCvjH,KAAKwjH,qBAAqB1mF,KAAK98B,KAAKujH,yBASxCF,GAAAjkH,UAAAi0B,SAAA,WACErzB,KAAKyjH,8BAAgCzjH,KAAK0jH,4CAO5CL,GAAAjkH,UAAAukH,iBAAA,eACQC,EAAoB5jH,KAAKuxG,oBAC5BV,aACA7mG,OAAOgnG,IACPhnG,OAAM,SAACrH,GAAK,OAAAA,EAAEi7D,WAA2B,QAAdj7D,EAAE+d,SAAqB/d,EAAEm7D,iBAEjD8zC,EAAuB5xG,KAAKuxG,oBAC/BV,aACA7mG,OAAOinG,IACPjnG,OAAM,SAACrH,GAAK,OAAAA,EAAEi7D,WAA2B,QAAdj7D,EAAE+d,SAAqB/d,EAAEm7D,iBACjDgC,EAAU8jD,EAAkBh/G,OAAOgtG,GAEzC,OADA5xG,KAAK6jH,+BAA+B/jD,GAC7BA,GAOTujD,GAAAjkH,UAAAskH,yCAAA,WACE,QAAI1jH,KAAKuxG,oBAAoBT,oBAAoB9mG,OAAOmnG,IAAiCpuG,QAW3FsgH,GAAAjkH,UAAA0kH,6BAAA,SACEzjG,EACAgB,EACA68C,EACA6lD,GAEAA,EAAat7G,QAAU4X,EAAM4vE,QAC7B5uE,EAAO48C,oBAAoBC,GAC3Bl+D,KAAKgkH,mBAAmBlnF,KAAKzb,IAS/BgiG,GAAAjkH,UAAA6kH,+BAAA,SAA+B/lD,GACzBA,EAAQgmD,aAAez8G,UACrBy2D,EAAQpmD,OAAOhJ,KAAI,SAACi1G,GAAgB,OAAAA,EAAat7G,UACnDy1D,EAAQgmD,YAAa,EAErBhmD,EAAQgmD,YAAa,EAGvBhmD,EAAQgmD,YAAchmD,EAAQgmD,YAUlCb,GAAAjkH,UAAAykH,+BAAA,SAA+B/jD,OACvBqkD,EAAoBrkD,EAAQ91D,OAAM,SAACqX,GAAU,OAAAA,EAAO5Y,UAAS1F,OAC7DqhH,EAAqBtkD,EAAQ91D,OAAM,SAACqX,GAAU,OAACA,EAAO5Y,UAAS1F,OACrE/C,KAAKqkH,0BAAgDD,GAArBD,IAOlCd,GAAAjkH,UAAAklH,gBAAA,SAAgBjkG,EAAOgB,EAAsB68C,GAC3C79C,EAAMkkG,kBACNvkH,KAAKikH,+BAA+B/lD,GACpCA,EAAQpmD,OAAOjN,QAAO,SAACk5G,GACrBA,EAAat7G,QAAUy1D,EAAQgmD,aAEjC7iG,EAAO48C,oBAAoBC,GAC3Bl+D,KAAKgkH,mBAAmBlnF,KAAKzb,IAO/BgiG,GAAAjkH,UAAAolH,uBAAA,SAAuBnkG,GAAvB,IAAA1V,EAAA3K,KACEqgB,EAAMkkG,kBACNvkH,KAAK2jH,mBAAmBnxG,IAAG,SAAC6O,GAC1BA,EAAO5Y,QAAUkC,EAAK05G,wBACtB15G,EAAKq5G,mBAAmBlnF,KAAKzb,MAQjCgiG,GAAAjkH,UAAAqlH,gCAAA,SACEpkG,EACAgB,EACA68C,EACA6lD,GAEA7lD,EAAQpmD,OAAOjN,QAAO,SAACoY,GACjBA,EAAK/iB,QAAU6jH,EAAa7jH,MAC9B+iB,EAAKxa,SAAW4X,EAAMgB,OAAO4uE,QAE7BhtE,EAAKxa,QAAU4X,EAAMgB,OAAO4uE,UAGhC5uE,EAAO48C,oBAAoBC,GAC3Bl+D,KAAKgkH,mBAAmBlnF,KAAKzb,IAG/BgiG,GAAAjkH,UAAAslH,oBAAA,SAAoBrkG,EAA0BgB,GAC5CA,EAAO5Y,QAAU4X,EAAM4vE,QACvBjwF,KAAKgkH,mBAAmBlnF,KAAKzb,IAG/BgiG,GAAAjkH,UAAAulH,mBAAA,SAAmBzmD,GACjB,OAAOA,EAAQpmD,OAAO9N,OAAM,SAACrH,GAAK,OAAgB,IAAhBA,EAAEi7D,aAGtCylD,GAAAjkH,UAAAwlH,2BAAA,SAA2B1mD,WACzB,GAAIA,EAAQI,SAAU,KACdqD,EAAmB,OACzB,IAAkB,IAAAziD,EAAA1B,GAAA0gD,EAAQI,UAAQn/C,EAAAD,EAAA9a,QAAA+a,EAAA9a,KAAA8a,EAAAD,EAAA9a,OAAE,CAA/B,IAAIlE,EAAKif,EAAAjf,MACZA,EAAQ,IAAMA,EACdyhE,EAAOl9D,KAAKvE,wGAEd,OAAOyhE,IAKX0hD,GAAAjkH,UAAAmlH,gBAAA,SAAgBlkG,GACdA,EAAMkkG,mBAGRlB,GAAAjkH,UAAAylH,2BAAA,SAA2BxkG,EAAOykG,GAC5BA,GACFzkG,EAAMkkG,kBACNvkH,KAAKujH,uBAAyBvjH,KAAKujH,uBAEnCvjH,KAAKujH,sBAAwBljG,EAAM4vE,QAGrCjwF,KAAKwjH,qBAAqB1mF,KAAK98B,KAAKujH,6CA5MvC/iH,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,sBACVC,SAAA,oqJAEAC,gBAAiBC,GAAAA,wBAAwBC,42BArBlC+vG,UAOA5tD,GAAAA,gEA4BNliD,GAAAA,kCAKAs8B,GAAAA,qCAKAA,GAAAA,oCAEAkpE,GAAAA,aAAY3mG,KAAA,CAAC,mBAAoB,CAAC,cAgLrC0jH,IAvKE,SAAAA,GACU9R,EACA9uD,GADAziD,KAAAuxG,oBAAAA,EACAvxG,KAAAyiD,aAAAA,EAjCHziD,KAAAyjH,+BAAyC,EACzCzjH,KAAAqkH,yBAAmC,EAEnCrkH,KAAAo8C,OAAS,GACTp8C,KAAA+kH,YAAct0F,KAAKu0F,MAMjBhlH,KAAAujH,uBAAiC,EAKhCvjH,KAAAgkH,mBAAqB,IAAIxmF,GAAAA,aAKzBx9B,KAAAwjH,qBAAuB,IAAIhmF,GAAAA,aCtCvC,IAAAynF,yBAAC9jH,GAAAA,SAAQxB,KAAA,CAAC,CACRgC,aAAc,CAAC0hH,IACfjiH,QAAS,CACPC,GAAAA,aACAG,GAAAA,iBACAF,GAAAA,cACAC,GAAAA,gBACA2mE,GAAAA,cACA2xB,GAAAA,eACArxB,GAAAA,kBACAP,GAAAA,iBACAE,GAAAA,qBACA1mE,GAAAA,mBAEFC,QAAS,CAAC2hH,QAE2B4B,IAhBvC,SAAAA,MCSA,IAAAC,IAwDEplH,OAAAC,eACImlH,GAAA9lH,UAAA,aAAU,KAGd,WACE,OAAOY,KAAK4iH,YAAY1iH,WAL1B,SACeA,GACbF,KAAK6iH,cAAc3iH,oCAiBrBJ,OAAAC,eACImlH,GAAA9lH,UAAA,OAAI,KAGR,WACE,OAAOY,KAAK6pC,MAAM3pC,WALpB,SACSA,GACPF,KAAKm7G,QAAQj7G,oCAUfJ,OAAAC,eACImlH,GAAA9lH,UAAA,WAAQ,KAGZ,WACE,OAAOY,KAAK0nE,UAAUxnE,WALxB,SACaA,GACXF,KAAK0nE,UAAUtjE,KAAKlE,oCA2FtBJ,OAAAC,eAAImlH,GAAA9lH,UAAA,QAAK,KAAT,WACE,OAA4B,IAArBY,KAAKkmC,KAAKnjC,wCAYnBmiH,GAAA9lH,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAK8pC,OAAS9pC,KAAK6pC,MAAMlyB,UAAS,SAAEuuB,GAClCv7B,EAAKw6G,OAAO/gH,KAAK8hC,IAASz+B,WAA6B,IAAhBy+B,EAAKnjC,UAG9C/C,KAAKolH,SAAWplH,KAAK+zG,QAClB3oF,KACCmV,GAAAA,SAAQ,SAAE2F,GAAiB,MAAU,KAATA,EAAc1F,GAAAA,MAAQC,GAAAA,MAAM91B,EAAK41B,aAE9D5oB,UAAS,SAAEuuB,GAAiB,OAAAv7B,EAAK06G,UAAUn/E,KAE9ClmC,KAAK8iH,aAAe9iH,KAAK4iH,YACtBx3F,KAAKmsB,GAAAA,wBACL5/B,UAAS,SAAE65F,GAAuB,OAAA7mG,EAAKo4G,gBAAgBvR,MAO5D0T,GAAA9lH,UAAAs0B,YAAA,WACE1zB,KAAK8pC,OAAOpf,cACZ1qB,KAAKolH,SAAS16F,cACd1qB,KAAK8iH,aAAap4F,eASpBw6F,GAAA9lH,UAAAkmH,QAAA,SAAQjlG,OACAhd,EAAMgd,EAAMhd,IAClB,GAAKrD,KAAKo7G,WAAW/3G,GAArB,KAGM6iC,EAAQ7lB,EAAY,OAAsBngB,MAChDF,KAAKm7G,QAAQj1E,KAOfg/E,GAAA9lH,UAAAmmH,mBAAA,WACEvlH,KAAK6gB,QACL7gB,KAAKwlH,aAAa1oF,QAQpBooF,GAAA9lH,UAAA4jH,mBAAA,SAAmBxR,GACjBxxG,KAAK6iH,cAAcrR,IAUrB0T,GAAA9lH,UAAAyjH,cAAA,SAAcrR,GACZxxG,KAAK4iH,YAAYx+G,KAAKotG,IAGxB0T,GAAA9lH,UAAAqmH,uBAAA,WACEzlH,KAAK0lH,SAAS1lH,KAAKkmC,MACnBlmC,KAAK2lH,qBAAqB7oF,QAO5BooF,GAAA9lH,UAAA+7G,QAAA,SAAQj1E,GACN,IAAIlmC,KAAKymD,SAAT,EAIAvgB,EAAOA,GAAQ,MAEFlmC,KAAKkmC,MAChBlmC,KAAK6pC,MAAMzlC,KAAK8hC,OAGZ0/E,EAAO1/E,EAAKn4B,QAAQ,aAAc,IAAI8W,QACxC+gG,EAAK7iH,QAAU/C,KAAK6lH,WAA6B,IAAhBD,EAAK7iH,SACxC/C,KAAK+zG,QAAQ3vG,KAAK8hC,KAOdg/E,GAAA9lH,UAAAyhB,MAAR,WACE7gB,KAAK6pC,MAAMzlC,KAAK,IAChBpE,KAAK+zG,QAAQ3vG,KAAK,IAClBpE,KAAK8lH,MAAMjrF,cAAcihF,SAMnBoJ,GAAA9lH,UAAAg8G,WAAR,SAAmB/3G,GACjB,OAAwD,IAAjD6hH,GAAmB7J,YAAYrqG,QAAQ3N,IAQxC6hH,GAAA9lH,UAAAimH,UAAR,SAAkBn/E,GAChBlmC,KAAK+lH,iBAAiBjpF,KAAKoJ,GAC3BlmC,KAAK0lH,SAASx/E,IAGRg/E,GAAA9lH,UAAA2jH,gBAAR,SAAwBvR,GACtB,GAAIA,IAAe/pG,WAA4B,OAAf+pG,EAAhC,CAIAxxG,KAAKkjH,iBAAiBpmF,KAAK00E,OAErBwU,EAAc,kBAAkBxU,EAAWtiG,cAAa,eAC9DlP,KAAKimH,aAAa7hH,KAAK4hH,GAEvBhmH,KAAKm7G,QAAQn7G,KAAKkmC,QAOZg/E,GAAA9lH,UAAAsmH,SAAR,SAAiBx/E,GAAjB,IAAAv7B,EAAA3K,KAOE,GANIA,KAAKkmH,eACPlmH,KAAKkmH,aAAa1zG,IAAG,SAAC2zG,GAAY,OAAAA,EAASz7F,gBAC3C1qB,KAAKkmH,aAAez+G,WAIT,MADAy+B,EAAOA,EAAKn4B,QAAQ,aAAc,IAAI8W,OAAS,IAC5D,KAOMuhG,EAAapmH,KAAKs2G,cAAcx3C,OAAO54B,EAAM,CACjDngB,QAAS/lB,KAAK+lB,UAEhB/lB,KAAKkmH,aAAeE,EAAW5zG,IAAG,SAAC2zG,GACjC,OAAOA,EAASr4D,QAAQn2C,UAAS,SAAE+kD,GACjC/xD,EAAK07G,oBAAoBF,EAAUzpD,YAXjC18D,KAAK+qC,QAAUtjC,WACjBzH,KAAK+qC,MAAMlqB,SAqBTqkG,GAAA9lH,UAAAinH,oBAAR,SAA4BF,EAAoBzpD,GAG9C,GAFA18D,KAAK8+D,OAAOhiC,KAAK,CAAEqpF,SAAQA,EAAEzpD,QAAOA,IAEhC18D,KAAK+qC,QAAUtjC,UAAW,KACtB6+G,EAAatmH,KAAK+qC,MACrBy8B,MACAx9D,OAAM,SAACwhD,GAAU,OAAAA,EAAOnqC,SAAW8kG,EAAS9kG,SAC5Czc,OAAO83D,GACV18D,KAAK+qC,MAAMwC,KAAK+4E,KAxWbpB,GAAA7J,YAAc,CACnB,UACA,QACA,MACA,YACA,UACA,aACA,kCAjBH76G,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,iBACVC,SAAA,+8CAEAC,gBAAiBC,GAAAA,wBAAwBC,s6BAhBlCm/B,GAAAA,uBAKAoxE,4CA0DNtwG,GAAAA,0BAKAA,GAAAA,oCAcAs8B,GAAAA,qBAKAt8B,GAAAA,wBAYAA,GAAAA,qCASAA,GAAAA,0BAIAA,GAAAA,qBAKAA,GAAAA,wBAKAA,GAAAA,yBAKAA,GAAAA,0BAKAA,GAAAA,8BAKAA,GAAAA,8BAKAA,GAAAA,uBAKAA,GAAAA,qBAKAA,GAAAA,gCAKAs8B,GAAAA,uBAKAA,GAAAA,iCAQAA,GAAAA,6BAKAA,GAAAA,qCAKAA,GAAAA,sBAMAyZ,GAAAA,UAASl3C,KAAA,CAAC,YAuMbulH,IA7LE,SAAAA,GACUhmF,EACAo3E,GADAt2G,KAAAk/B,gBAAAA,EACAl/B,KAAAs2G,cAAAA,EAtKDt2G,KAAAimH,aAAwC,IAAIh7F,GAAAA,gBACnD,8BAGOjrB,KAAAmlH,OAAmC,IAAIl6F,GAAAA,iBAAgB,GAUxDjrB,KAAA+zG,QAAmC,IAAI9oF,GAAAA,gBAAgB,IAiBtDjrB,KAAAmjH,YAAwBT,GAYxB1iH,KAAA4iH,YAAuC,IAAI33F,GAAAA,gBAClDxjB,WAMQzH,KAAAwjH,qBAAuB,IAAIhmF,GAAAA,aAY5Bx9B,KAAA6pC,MAAiC,IAAI5e,GAAAA,gBAAgB,IAYrDjrB,KAAA0nE,UAAsC,IAAIz8C,GAAAA,iBAAgB,GAE1DjrB,KAAAujH,uBAAiC,EAIjCvjH,KAAA0oC,WAA6B,QAK7B1oC,KAAA6d,MAAQ,UAKR7d,KAAAugC,SAAW,IAKXvgC,KAAA6lH,UAAY,EAUZ7lH,KAAAumH,gBAAiB,EAKjBvmH,KAAAwmH,gBAAiB,EAKjBxmH,KAAA+lB,SAAU,EAUT/lB,KAAA+lH,iBAAmB,IAAIvoF,GAAAA,aAKvBx9B,KAAA8+D,OAAS,IAAIthC,GAAAA,aAQbx9B,KAAAkjH,iBAAmB,IAAI1lF,GAAAA,aAKvBx9B,KAAAwlH,aAAe,IAAIhoF,GAAAA,aAKnBx9B,KAAA2lH,qBAAuB,IAAInoF,GAAAA,aCpMvC,IAAAipF,IAsBEA,GAAArnH,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACMA,KAAKypC,OAASzpC,KAAKypC,MAAMlpC,QAAQmmH,WACnC1mH,KAAKypC,MAAMo5B,YAAYlrD,UAAS,SAAC/R,OACzBkzD,EAAelzD,EAAO+E,EAAK8+B,MAAMlpC,QAAiB,WACpDu4D,IACFnuD,EAAK4pB,UAAU4mF,QAAQriD,GACvBnuD,EAAKg8G,IAAIl4C,yCAhBlB75C,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,oEAHHykH,GAAkB/hH,WAAA,CAAA,CAAAsC,KAOtBovB,GAAAA,cAZHqxC,GAAAA,yBAGO38B,GAAAA,aAAYpmC,WAAA,CAAA,CAAAsC,KAWhB+jC,GAAAA,cAcLi9E,IAjBE,SAAAA,GACkBlyF,EACRoyF,EACYl9E,GAFJzpC,KAAAu0B,UAAAA,EACRv0B,KAAA2mH,IAAAA,EACY3mH,KAAAypC,MAAAA,ECKxB,IAAAm9E,yBAACzlH,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACA2mE,GAAAA,YACAxmE,GAAAA,iBACAF,GAAAA,cACAC,GAAAA,gBACA2mE,GAAAA,cACA2xB,GAAAA,eACA9xB,GAAAA,mBACAD,GAAAA,eACArmE,GAAAA,kBACA2hH,GACA6B,IAEFvjH,QAAS,CACPwjH,IAEFvjH,aAAc,CACZujH,GACAuB,QAG6BG,IAvBjC,SAAAA,cCEEC,QAAU,UACVC,KAAO,QAOTC,IA+CEjnH,OAAAC,eACIgnH,GAAA3nH,UAAA,OAAI,KADR,WAEE,OAAOY,KAAKgnH,WAEd,SAAS9mH,GACPF,KAAKgnH,MAAQ9mH,EACbF,KAAKinH,aAAe,oCAqCtBnnH,OAAAC,eAAIgnH,GAAA3nH,UAAA,WAAQ,KAAZ,WAIE,OAHIY,KAAKknH,YAAcz/G,YACrBzH,KAAKknH,UAAYlnH,KAAKmnH,eAEjBnnH,KAAKknH,2CAadH,GAAA3nH,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAK8uB,QAAU,IAAIg2C,GAAAA,mBAAmB9kE,KAAK+qC,MAAO/qC,KAAK+kE,OAEvD/kE,KAAKonH,gBAAgBzvG,UAAS,WAC5BhN,EAAKs8G,aAAe,MAQxBF,GAAA3nH,UAAAs0B,YAAA,WACE1zB,KAAK8uB,QAAQk2C,WASf+hD,GAAA3nH,UAAAioH,kBAAA,SAAkB/1G,OACV6gE,EAAQ,CAAC7gE,EAAM+P,OAAOxP,OACtBqC,EAAQ5C,EAAMorD,QAAQ35D,OAI5B,OAHY,EAARmR,GACFi+D,EAAM1tE,KAAK,IAAIyP,EAAK,KAEfi+D,EAAM1oE,KAAK,MASpBs9G,GAAA3nH,UAAAkoH,eAAA,SAAe97D,GACTxrD,KAAK+qC,MAAMnP,MAAMzjB,IAAIqzC,KACuB,IAA1CxrD,KAAK+qC,MAAMnP,MAAMzjB,IAAIqzC,GAAQhd,WAInCxuC,KAAK+qC,MAAMnP,MAAMwpC,OAAO5Z,EAAQ,CAACyd,SAAS,EAAMz6B,UAAU,IAAO,GACjExuC,KAAKunH,aAAazqF,KAAK0uB,KAQjBu7D,GAAA3nH,UAAA+nH,YAAR,WAAA,IAAAx8G,EAAA3K,KACE,OAAOA,KAAK+qC,MAAMa,KAAKC,OAAOzgB,KAC5BmV,GAAAA,SAAQ,SAAEm8B,GACR,OAA0B,IAAnBA,EAAQ35D,OAAey9B,GAAAA,MAAQC,GAAAA,MAAM,OAE9CjuB,GAAAA,IAAG,SAAEkqD,GACH,OAAO/xD,EAAK68G,aAAa9qD,EAAQx7B,KAAKv2B,EAAK88G,kBAUzCV,GAAA3nH,UAAAqoH,YAAR,SAAoBC,EAAkBC,GACpC,OAAOD,EAAGrmG,OAAOumG,aAAeD,EAAGtmG,OAAOumG,cAQpCb,GAAA3nH,UAAAooH,aAAR,SAAqB9qD,GAArB,IAAA/xD,EAAA3K,KACQ6nH,EAAU,IAAIp7E,IAWpB,OAVAiwB,EAAQ7xD,QAAO,SAAE2gD,OACTnqC,EAASmqC,EAAOnqC,OAClBymG,EAAgBD,EAAQ1vG,IAAIkJ,GAC5BymG,IAAkBrgH,YACpBqgH,EAAgB,GAChBD,EAAQl8F,IAAItK,EAAQymG,IAEtBA,EAAcrjH,KAAK+mD,KAGdvpD,MAAM+3B,KAAK6tF,EAAQ7vF,QAAQxlB,IAAG,SAAE6O,GAIrC,OAHI1W,EAAKs8G,aAAa5lG,EAAOX,WAAajZ,YACxCkD,EAAKs8G,aAAa5lG,EAAOX,SAAW,GAE/B,CAACW,OAAMA,EAAEq7C,QAASmrD,EAAQ1vG,IAAIkJ,OAIzC0lG,GAAA3nH,UAAA2oH,cAAA,SAAcz2G,GACZ,OAAOA,EAAMorD,UAAqE,IAA1DprD,EAAMorD,QAAQprD,EAAMorD,QAAQ35D,OAAS,GAAG2vC,KAAK8sE,UAGvEuH,GAAA3nH,UAAA4oH,mBAAA,SAAmB12G,GAAnB,IAAA3G,EAAA3K,KACQO,EAA6B,CACjCoyC,SAAUrhC,EAAM+P,OAAOX,QACvBu9F,OAAQj+G,KAAKinH,aAAa31G,EAAM+P,OAAOX,UAGtB1gB,KAAKs2G,cAAcx3C,OAAO9+D,KAAKkmC,KAAM3lC,GAC7CiS,IAAG,SAAC2zG,GACbA,EAASr4D,QAAQn2C,UAAS,SAAE+kD,OACpB4pD,EAAah1G,EAAMorD,QAAQ93D,OAAO83D,GACnCA,EAAQ35D,SACXujH,EAAWA,EAAWvjH,OAAS,GAAG2vC,KAAK8sE,UAAW,GAEpD70G,EAAKs9G,YAAYnrF,KAAK,CAACqpF,SAAQA,EAAEzpD,QAAS4pD,8BA7NjD9lH,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,qBACVC,SAAA,+8DAEAC,gBAAiBC,GAAAA,wBAAwBC,6LA/BzCqlE,GAAAA,yBAcOkrC,oCAmCNtwG,GAAAA,qBAKAA,GAAAA,yBAKAA,GAAAA,oBAKAA,GAAAA,8BAKAA,GAAAA,oBAKAA,GAAAA,+BAUAA,GAAAA,2BAKAs8B,GAAAA,8BAKAA,GAAAA,6BAKAA,GAAAA,4BAKAA,GAAAA,iCAQAA,GAAAA,iCACAA,GAAAA,sCAEAkL,GAAAA,aAAY3oC,KAAA,CAAC,2BA0IhBonH,IA9HE,SAAAA,GAAoBhiD,EACAuxC,GADAt2G,KAAA+kE,MAAAA,EACA/kE,KAAAs2G,cAAAA,EA1Fbt2G,KAAAkoH,iBAAmBC,GAOnBnoH,KAAAinH,aAAqC,GAErCjnH,KAAA0rB,UAAkC,GAiBhC1rB,KAAAooH,KAAyBD,GAAiBtB,QAK1C7mH,KAAAqoH,gBAAiB,EAejBroH,KAAAonH,gBAAkB,IAAIn8F,GAAAA,gBAAyBxjB,WAK9CzH,KAAAsoH,YAAc,IAAI9qF,GAAAA,aAKlBx9B,KAAAuoH,cAAgB,IAAI/qF,GAAAA,aAKpBx9B,KAAAunH,aAAe,IAAI/pF,GAAAA,aAKnBx9B,KAAAioH,YAAc,IAAIzqF,GAAAA,aAQlBx9B,KAAAwoH,iBAAmB,IAAIhrF,GAAAA,aACvBx9B,KAAAyoH,iBAAmB,IAAIjrF,GAAAA,aCxGnC,IAAAkrF,IAiCE5oH,OAAAC,eAAI2oH,GAAAtpH,UAAA,QAAK,KAAT,WACE,OAAOizC,GAAAA,eAAeryC,KAAKwrD,yCAO7B1rD,OAAAC,eAAI2oH,GAAAtpH,UAAA,YAAS,KAAb,WACE,OAAOupH,GAAAA,mBAAmB3oH,KAAKwrD,yCAOjC1rD,OAAAC,eAAI2oH,GAAAtpH,UAAA,cAAW,KAAf,WACE,OAAOY,KAAKi/G,UACTlxG,QAAQ,qBAAsB,MAC9BA,QAAQ,kBAAmB,qCAOhCjO,OAAAC,eAAI2oH,GAAAtpH,UAAA,OAAI,KAAR,WACE,OAAOqzC,GAAAA,cAAczyC,KAAKwrD,yCAK5Bk9D,GAAAtpH,UAAAwpH,cAAA,eACQtzF,EAAYt1B,KAAKmH,OAAOoZ,YAAYvgB,KAAKwrD,OAAOxtC,KAAM,CAC1D9Q,eAAgBlN,KAAKwrD,OAAOxtC,KAAK2K,WACjCxb,kBAAmBnN,KAAKwS,IAAImW,aAE9BmlB,GAAiB9tC,KAAKwS,IAAK,CAAC8iB,GAAYkX,GAAc7qB,+BAtEzDnhB,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,0BACVC,SAAA,4pBAEAC,gBAAiBC,GAAAA,wBAAwBC,yLAMxCC,GAAAA,mBAEAA,GAAAA,yBAUAA,GAAAA,8BAKAA,GAAAA,yBAEAs8B,GAAAA,UA2CHsrF,IATE,SAAAA,KApCS1oH,KAAAqoH,gBAAiB,EAEhBroH,KAAA6oH,UAAY,IAAIrrF,GAAAA,aAElBx9B,KAAAmH,OAAS,IAAI2tB,GC/CvB,IAAAg0F,IAgDEhpH,OAAAC,eACI+oH,GAAA1pH,UAAA,QAAK,KADT,WAEE,OAAOY,KAAKG,YAEd,SAAUD,GACRF,KAAKG,OAASD,mCAShB4oH,GAAA1pH,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACmC,UAA7BA,KAAKM,MAAMoyC,KAAK6sE,WAClBv/G,KAAKykE,OAGI,IAFPzkE,KAAKwS,IAAI7M,OAAOo+B,UAAS,SACvBN,GAAO,OAAAA,EAAI58B,KAAO8D,EAAKrK,MAAM0d,KAAK9W,cAAcL,MAGtD7G,KAAKuqB,aAAevqB,KAAKwS,IAAIgY,eAAeC,YAAY9S,UAAS,SAACzX,GAChEyK,EAAKsf,qBAAqB/pB,GAC1ByK,EAAKo+G,SAAS3kH,KAAKuG,EAAK8wB,qBAI5BqtF,GAAA1pH,UAAAs0B,YAAA,WACE1zB,KAAKuqB,aAAaG,eAOpBo+F,GAAA1pH,UAAAmnE,aAAA,SAAalmD,GACXrgB,KAAKwmE,cAAcnmD,IAOrByoG,GAAA1pH,UAAAonE,cAAA,SAAcnmD,GAAd,IAAA1V,EAAA3K,KAKE,OAJuC,oBAA5BA,KAAK2iD,oBACdC,aAAa5iD,KAAK2iD,oBAGZtiC,EAAM5a,MACZ,IAAK,QACEzF,KAAKqmE,WAAWnmE,QACfF,KAAKykE,MACPzkE,KAAK0tC,SAEL1tC,KAAK4tC,OAGT5tC,KAAKqmE,WAAWjiE,MAAK,GACrB,MACF,IAAK,aACEpE,KAAKqmE,WAAWnmE,OAAUF,KAAKykE,QAClCzkE,KAAK2iD,mBAAqBhe,WAAU,WAClCh6B,EAAKijC,MACLjjC,EAAK07D,WAAWjiE,MAAK,IACpB,MAEL,MACF,IAAK,aACCpE,KAAKqmE,WAAWnmE,QAClBF,KAAK0tC,SACL1tC,KAAKqmE,WAAWjiE,MAAK,MAQrB0kH,GAAA1pH,UAAAwuC,IAAR,WACO5tC,KAAKykE,QACRzkE,KAAKykE,OAAQ,EACbzkE,KAAKqlE,kBAIDyjD,GAAA1pH,UAAAsuC,OAAR,WACM1tC,KAAKykE,QACPzkE,KAAKykE,OAAQ,EACbzkE,KAAKslE,qBACLtlE,KAAKgpH,mBAAmBx2G,IAAG,SAAC7P,GAAK,OAAAA,EAAE+nB,gBACnC1qB,KAAKgpH,mBAAqB,KAOtBF,GAAA1pH,UAAAimE,cAAR,WAAA,IAAA16D,EAAA3K,KACE,GAAIA,KAAKwS,MAAQ/K,UAAjB,CAIA,GAAIzH,KAAKM,MAAMoyC,KAAK6sE,WAAa39F,GAC/B,OAAOna,cAGH6V,EAAgBtd,KAAU,MAAgCge,KAC5DV,EAAapW,cAAc4rD,iBAAmBrrD,YAChD6V,EAAapW,cAAc4rD,gBAAiB,GAE9C9yD,KAAKgpH,mBAAmBvkH,KACtBzE,KAAK8mD,aACF2M,iBAAiBn2C,GACjB3F,UAAS,SAACrX,GAAS,OAAAqK,EAAK6H,IAAIy/B,SAAS3xC,QAOpCwoH,GAAA1pH,UAAAkmE,mBAAR,WACE,GAAItlE,KAAKwS,MAAQ/K,UAAjB,CAIA,GAAIzH,KAAKM,MAAMoyC,KAAK6sE,WAAa39F,GAC/B,OAAOna,cAGHo+D,EAAS7lE,KAAKwS,IAAIyqC,aAAaj9C,KAAKM,MAAM0d,KAAK9W,cAAcL,IACnE7G,KAAKwS,IAAI80B,YAAYu+B,KAGvBijD,GAAA1pH,UAAA6qB,qBAAA,SAAqBzT,OACboU,EAAgB5qB,KAAKM,MAAM0d,KAAK4M,eAAiB,EACjDC,EAAgB7qB,KAAKM,MAAM0d,KAAK6M,eAAiBlB,SACvD3pB,KAAK8mE,SAAS1iE,KACEwmB,GAAdpU,GAA+BA,GAAcqU,IAIjDi+F,GAAA1pH,UAAAq8B,eAAA,WACE,OAAIz7B,KAAKykE,MACAzkE,KAAK8mE,SAAS5mE,MACjB,sCACA,8CAEGF,KAAK8mE,SAAS5mE,MACjB,iCACA,+DAtLTM,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,wBACVC,SAAA,ipBAEAC,gBAAiBC,GAAAA,wBAAwBC,2HARlCmmD,sCAyBNlmD,GAAAA,qBAKAA,GAAAA,mBAKAA,GAAAA,qBAEAA,GAAAA,SAwJHgoH,IA/IE,SAAAA,GAAoBhiE,GAAA9mD,KAAA8mD,aAAAA,EAnCb9mD,KAAA+oH,SAAoC,IAAI99F,GAAAA,gBAC7C,kCAKKjrB,KAAA8mE,SAAqC,IAAI77C,GAAAA,iBAAgB,GAEzDjrB,KAAAqmE,WAAuC,IAAIp7C,GAAAA,iBAAgB,GAE1DjrB,KAAAgpH,mBAAqB,GAuBrBhpH,KAAAG,OAAS,UC5BnB,IAAA8oH,yBAAC9nH,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAknE,GAAAA,eACA/mE,GAAAA,iBACAF,GAAAA,cACA+mE,GAAAA,cACA9mE,GAAAA,gBACAmnE,GAAAA,qBACAD,GAAAA,cACAygD,GAAAA,yBACAznH,GAAAA,kBACAqnE,GAAAA,sBACA/nE,IAEFW,QAAS,CACPqlH,GACA+B,IAEFnnH,aAAc,CACZolH,GACA2B,GACAI,QAGiCG,IAzBrC,SAAAA,MCiBA,IAAAE,IA+BEA,GAAA/pH,UAAAgqH,SADA,WAEExmE,aAAa5iD,KAAK2iD,oBAClB3iD,KAAKisC,cAOPnsC,OAAAC,eAAIopH,GAAA/pH,UAAA,MAAG,KAAP,WACE,OAAOY,KAAKu0B,UAAU/hB,qCAGxB1S,OAAAC,eAAIopH,GAAA/pH,UAAA,gBAAa,KAAjB,WACE,OAAQY,KAAKu0B,UAAa,IAAY5L,4CAcxCwgG,GAAA/pH,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKkiD,yBACLliD,KAAKqpH,0BAELrpH,KAAKwS,IAAIqd,QAAQzE,KAAKk+F,GAAAA,KAAK,IAAI3xG,UAAS,WACtChN,EAAKogC,MAAQ,IAAIiC,GAAsB,GAAI,CAACx6B,IAAK7H,EAAK6H,MACtD7H,EAAKszE,cAIPj+E,KAAKmlD,SAAWnlD,KAAKwS,IAAI0oB,QAAQvjB,UAAS,SAAEhS,GACtCgF,EAAKogC,QAAUplC,EAAOmJ,KAAI,SAAC60B,GAAK,MAAS,2BAATA,EAAE98B,MACpC8D,EAAKszE,eAUHkrC,GAAA/pH,UAAA6+E,UAAR,WAaEtoC,GAZc31C,KAAK+qC,MAEL,IAAI/a,GAAY,CAC5BnpB,GAAK,yBACLgL,MAAO,uBACPsX,OAAQ,IACR9H,OAAQ,IAAIpa,GACZijB,iBAAiB,EACjBgG,YAAY,EACZD,WAAW,EACX1pB,MAAOgjH,OAKXJ,GAAA/pH,UAAAoqH,sBAAA,WACSxpH,KAAKuxG,oBAAoBT,oBAAoB9mG,OAAOmnG,IAAiCpuG,OAGxF/C,KAAKyjH,+BAAgC,EAFrCzjH,KAAKyjH,+BAAgC,GAU3C0F,GAAA/pH,UAAAs0B,YAAA,WACE1zB,KAAKmiD,2BACLniD,KAAKypH,4BACLzpH,KAAK0pH,2BACL1pH,KAAKmlD,SAASz6B,eAOhBy+F,GAAA/pH,UAAAiqH,wBAAA,WAAA,IAAA1+G,EAAA3K,KACEA,KAAK2pH,QAAU3pH,KAAK4pH,mBAAmB/zB,UAAUl+E,UAAS,SAACkyG,GACzDl/G,EAAKm/G,yBAAyBD,MAS1BV,GAAA/pH,UAAA2qH,6BAAR,SAAqCrtD,OAC7BstD,EAAsB,GAe5B,OAbAttD,EAAQlqD,IAAG,SAACg5C,GACV,GAAIA,EAAOxtC,KAAK5J,WAAW3O,MAA2C,GAAnC+lD,EAAOxtC,KAAK5J,WAAW+pF,SACxD,GAAI6rB,EAAoB7nH,eAAeqpD,EAAOxtC,KAAK5J,WAAW3O,MAAO,KAC7DwkH,EAAeD,EAAoBx+D,EAAOxtC,KAAK5J,WAAW3O,MAAM04F,SAClE3yC,EAAOxtC,KAAK5J,WAAW+pF,SAAW8rB,IACpCD,EAAoBx+D,EAAOxtC,KAAK5J,WAAW3O,MAAQ,CAAE04F,SAAU3yC,EAAOxtC,KAAK5J,WAAW+pF,SAAUtsF,MAAO25C,EAAO9Y,KAAK7gC,aAGrHm4G,EAAoBx+D,EAAOxtC,KAAK5J,WAAW3O,MAAQ,CAAE04F,SAAU3yC,EAAOxtC,KAAK5J,WAAW+pF,SAAUtsF,MAAO25C,EAAO9Y,KAAK7gC,SAKlHm4G,GAODb,GAAA/pH,UAAA0qH,yBAAR,SAAiCD,OACzBG,EAAsBhqH,KAAK+pH,6BAA6BF,GACxDK,EAAwBpqH,OAAOk4B,KAAKgyF,GACpCG,EAAiC,GACjCjR,EAAU,GAChB2Q,EAA4Br3G,IAAG,SAACg5C,OACxB4+D,EAAYF,EAAsBl5G,QAAQw6C,EAAOxtC,KAAK5J,WAAW3O,OACpD,IAAf2kH,GACFlR,EAAQz0G,KAAKulH,EAAoBx+D,EAAOxtC,KAAK5J,WAAW3O,MAAMoM,OAC9Dq4G,EAAsBr9F,OAAOu9F,EAAW,GACxCD,EAA+B1lH,KAAK+mD,EAAOxtC,KAAK5J,WAAW3O,QAEkB,IAAzE0kH,EAA+Bn5G,QAAQw6C,EAAOxtC,KAAK5J,WAAW3O,OAChEyzG,EAAQz0G,KAAK+mD,EAAO9Y,KAAK7gC,SAI3BqnG,EAAQn2G,QACV/C,KAAKqqH,kBAAkBnR,EAAQzvG,KAAK,QAOhC0/G,GAAA/pH,UAAA8iD,uBAAR,WAAA,IAAAv3C,EAAA3K,KACEA,KAAKoiD,oBAAsBpiD,KAAKwS,IAAI1L,GAAGolB,GACrC,cAAa,SACZ7L,GAAoC,OAAA1V,EAAKsxD,WAAW57C,MAQzD8oG,GAAA/pH,UAAAqqH,0BAAA,WACEzpH,KAAK2pH,QAAQj/F,eAMfy+F,GAAA/pH,UAAAsqH,yBAAA,WACE1pH,KAAKsqH,gBAAgB93G,IAAG,SAAC7P,GAAK,OAAAA,EAAE+nB,gBAChC1qB,KAAKsqH,gBAAkB,IAOjBnB,GAAA/pH,UAAA+iD,yBAAR,WACEniD,KAAKwS,IAAI1L,GAAGwlB,GAAGtsB,KAAKoiD,oBAAoB38C,KAAMzF,KAAKoiD,oBAAoBvS,UACvE7vC,KAAKoiD,oBAAsB36C,WAOrB0hH,GAAA/pH,UAAA68D,WAAR,SAAmB57C,GAAnB,IAAA1V,EAAA3K,MAEIqgB,EAAMmiC,UAAaxiD,KAAKuqH,gCACvBvqH,KAAKyjH,gCAAiCzjH,KAAKyiD,aAAaC,iBAIpB,oBAA5B1iD,KAAK2iD,qBACdC,aAAa5iD,KAAK2iD,oBAClB3iD,KAAKisC,aACLjsC,KAAK0pH,4BAGP1pH,KAAKiiB,OAASqD,GAAAA,UAAUjF,EAAMyiC,WAAY9iD,KAAK+hB,cAAe,aAE9D/hB,KAAK2iD,mBAAqBhe,WAAU,WAClCh6B,EAAK6/G,sBACJxqH,KAAKyqH,+BAbNzqH,KAAKisC,cAgBDk9E,GAAA/pH,UAAAorH,mBAAR,WAAA,IAAA7/G,EAAA3K,KACEA,KAAK4pH,mBAAmB/oG,YAClB67C,EAAU18D,KAAKs2G,cAAcpF,cAAclxG,KAAKiiB,OAAQ,CAAErc,OAAQ,CAAEwF,SAAU,QAASstB,KAAM,WAAa,cAErG91B,GACY,EAAjB85D,EAAQ35D,QACVmhC,EAAKomF,gBAAgB7lH,KACnBi4D,EAAQ95D,GAAGkrD,QAAQn2C,UAAS,SAAE+yG,GAC5B//G,EAAKggH,SAAS,CAAExE,SAAUzpD,EAAQ95D,GAAI85D,QAASguD,eAJvD,IAAK,IAAM9nH,KAAK85D,IAAL95D,IAULumH,GAAA/pH,UAAAurH,SAAR,SAAiBtqG,OACTq8C,EAAUr8C,EAAMq8C,QAChB4pD,EAAatmH,KAAK4pH,mBAAmBpiD,MACxCx9D,OAAM,SAAEwhD,GAAyB,OAAAA,EAAOnqC,SAAWhB,EAAM8lG,SAAS9kG,SAClEzc,OAAO83D,GACV18D,KAAK4pH,mBAAmBr8E,KAAK+4E,IAOvB6C,GAAA/pH,UAAAirH,kBAAR,SAA0Bn0F,GACxBl2B,KAAKisC,iBAEC7gC,EAAW,IAAI8rD,GAAAA,MACnB5xC,GAAAA,UAAUtlB,KAAKiiB,OAAQ,YAAajiB,KAAK+hB,gBAErC1c,EAAU,IAAIiwB,GAAU,CAAElqB,SAAQA,IAClCmuG,GAAc,IAAIljC,IAAYxiC,oBAAoBzoC,EAAU,CAChE+B,kBAAmBnN,KAAK+hB,cACxB7U,eAAgBlN,KAAK+hB,gBAGjB9R,EAAa,CACjBxK,KAAM8b,GACNnW,SAAUmuG,EACV5wF,WAAY3oB,KAAK+hB,cACjB3N,WAAY,CACVvN,GAAI7G,KAAK4qH,8BACTC,eAAgB30F,GAElBwc,KAAM,CACJ7rC,GAAI7G,KAAK4qH,+BAEX9jH,GAAIzB,GAENrF,KAAK+qC,MAAMmB,iBAAiB,CAACj8B,GAAIu8B,GAAchrB,OAM3C2nG,GAAA/pH,UAAA6sC,WAAR,WACMjsC,KAAK+qC,OACP/qC,KAAK+qC,MAAMkB,mCAtSdrX,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,0EA7BHyyB,GAAmB/vB,WAAA,CAAA,CAAAsC,KA6EvBovB,GAAAA,cA3EIu8E,UAgBAR,UAEA5tD,GAAAA,uEA+BNliD,GAAAA,8CAKAA,GAAAA,wBAEAwlG,GAAAA,aAAY3mG,KAAA,CAAC,eA4QhBwpH,IA1PE,SAAAA,GACkB50F,EACR+hF,EACA/E,EACA9uD,GAHQziD,KAAAu0B,UAAAA,EACRv0B,KAAAs2G,cAAAA,EACAt2G,KAAAuxG,oBAAAA,EACAvxG,KAAAyiD,aAAAA,EA7CFziD,KAAA4pH,mBAAgD,IAAI78E,GAAAA,YAA0B,IAI9E/sC,KAAAsqH,gBAAkC,GAClCtqH,KAAAyjH,+BAA0C,EAO1CzjH,KAAA4qH,8BAAwC,gCAIvC5qH,KAAAyqH,6BAAuC,IAKvCzqH,KAAAuqH,gCAA0C,EAqRrD,SAAgBhB,GAA6BlkH,EAAoBmR,GAC/D,OAAO,IAAIwf,GAAAA,MAAc,CACvBzJ,MAAO,IAAIkL,GAAAA,KAAa,CACtBzJ,IAAK,+CACL0J,QAAS,CAAC,GAAI,MAGhBxB,KAAM,IAAIC,GAAAA,KAAa,CACrBD,KAAM7wB,EAAQ8S,IAAI,kBAClBkwC,UAAW,OACXF,aAAc,SACd36B,KAAM,0BACNuI,KAAM,IAAIK,GAAAA,KAAa,CAAEvY,MAAO,SAChCitG,eAAgB,IAAI10F,GAAAA,KAAa,CAAEvY,MAAO,6BAC1CktG,iBAAkB,IAAIl1F,GAAAA,OAAe,CAAEhY,MAAO,4BAA6BiY,MAAO,IAClFF,OAAQ,IAAIC,GAAAA,OAAe,CAAEhY,MAAO,OAAQiY,MAAO,IACnDO,UAAU,EACVkyB,QAAS,GACTE,SAAU,GACV9N,QAAS,CAAC,IAAK,IAAK,IAAK,SChX/B,IAAAqwE,IAgCSA,GAAAhqH,QAAP,WACE,MAAO,CACLC,SAAU+pH,GACV9pH,UAAW,CACTu8G,KACAoD,KACAU,KACAiB,6BAzBPrhH,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAulH,GACAxD,GACA6F,GACAhE,IAEFvjH,QAAS,CACPklH,GACAxD,GACA6F,GACAhE,GACAkE,IAEFxnH,aAAc,CAACwnH,QAcjB6B,IA7BA,SAAAA,MCdA,IAAAC,IAqBEnrH,OAAAC,eACIkrH,GAAA7rH,UAAA,WAAQ,KADZ,WAEE,OAAOY,KAAKkrH,eAEd,SAAahrH,GACXF,KAAK47B,MAAQ17B,EAAQ,WAAa,YAClCF,KAAKkrH,UAAYhrH,mCAInBJ,OAAAC,eACIkrH,GAAA7rH,UAAA,MAAG,KADP,WAEE,OAAOY,KAAK+hC,UAEd,SAAQ7hC,GACNF,KAAK+hC,KAAO7hC,mCAIdJ,OAAAC,eACIkrH,GAAA7rH,UAAA,UAAO,KADX,WAEE,OAAOY,KAAK0uE,cAEd,SAAYxuE,GACVF,KAAK0uE,SAAWxuE,mCAWlBJ,OAAAC,eAAIkrH,GAAA7rH,UAAA,QAAK,KAAT,WAAsB,OAAOizC,GAAAA,eAAeryC,KAAKqF,0CAIjD4lH,GAAA7rH,UAAAkiC,OAAA,WACEthC,KAAKmrH,UAAYnrH,KAAKmrH,SACtBnrH,KAAKorH,OAAOtuF,KAAK98B,KAAKmrH,WAGxBF,GAAA7rH,UAAAisH,oBAAA,WACE,GAAIrrH,KAAKqF,QAAQ+F,SAAU,KACnBkqB,EAAYt1B,KAAKmH,OAAOoZ,YAAYvgB,KAAKqF,QAAS,CACtD6H,eAAgBlN,KAAKqF,QAAQsjB,WAC7Bxb,kBAAmBnN,KAAKwS,IAAImW,aAE9BmlB,GAAiB9tC,KAAKwS,IAAK,CAAC8iB,GAAYkX,GAAc9qB,QAI1DupG,GAAA7rH,UAAAksH,MAAA,SAAMn3F,GACAA,IAAW82F,GAAeM,aAAaC,GACpCxrH,KAAKmrH,UACRnrH,KAAKshC,SAEEnN,IAAW82F,GAAeM,aAAaE,MAC5CzrH,KAAKmrH,UACPnrH,KAAKshC,UAnEJ2pF,GAAAM,aAAe,CACpBC,GAAI,UACJC,KAAM,kCARTjrH,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,YACVC,SAAA,m/BAUCI,GAAAA,mBAUAA,GAAAA,uBASAA,GAAAA,sBASAs8B,GAAAA,UAqCH6tF,IA5BE,SAAAA,KAvCQjrH,KAAAmH,OAAS,IAAI2tB,GA8BX90B,KAAAorH,OAAS,IAAI5tF,GAAAA,aCjDzB,IAAAkuF,IAsBSA,GAAA1qH,QAAP,WACE,MAAO,CACLC,SAAUyqH,0BAffvqH,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAC,GAAAA,cACAC,GAAAA,gBACAqnE,GAAAA,eACA+iD,GAAAA,kBACAr8C,IAEF5tE,QAAS,CAACupH,IACVtpH,aAAc,CAACspH,QAQjBS,IAlBA,SAAAA,MCTA,IAAAE,IAyCEA,GAAAxsH,UAAAysH,eAAA,WACE7rH,KAAK+kE,MAAM0J,iBAMbm9C,GAAAxsH,UAAA4gB,QAAA,WACEhgB,KAAK8rH,OAAOhvF,6BAnCft8B,GAAAA,UAASb,KAAA,CAAC,CACTc,SAAU,iBACVC,SAAA,2RAEAC,gBAAiBC,GAAAA,wBAAwBC,iEAZzCqlE,GAAAA,qDAgBCplE,GAAAA,mBAEAA,GAAAA,wBAKAs8B,GAAAA,uBAKAA,GAAAA,UAkBHwuF,IAhBE,SAAAA,GAAoB7mD,GAAA/kE,KAAA+kE,MAAAA,EAPV/kE,KAAAkZ,SAAW,IAAIskB,GAAAA,aAKfx9B,KAAA8rH,OAAS,IAAItuF,GAAAA,aC5BzB,IAAauuF,GAAkB,IAAItlB,GAAAA,eAAuB,mBAE1D,SAAgBulB,GAAuBC,GACrC,OAAOA,EAAc1pH,OAAOqpH,IAG9B,SAAgBM,KACd,MAAO,CACL1yB,QAASuyB,GACTjlB,WAAYklB,GACZhlB,KAAM,CAACmlB,GAAAA,gBCJX,IAAAC,yBAACjrH,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACAE,GAAAA,gBACAE,GAAAA,kBACA83F,IAEF73F,QAAS,CAACkqH,IACVjqH,aAAc,CAACiqH,IACf9kC,gBAAiB,CAAC8kC,QAEaQ,IAXjC,SAAAA,MCCA,IAAA90G,GAAA+0G,IAAkCrlH,GAAAA,GAAlCsQ,GAAkCg1G,GAAAA,WAEhCxsH,OAAAC,eAAIssH,GAAAjtH,UAAA,QAAK,KAAT,WAA2B,OAAOY,KAAKO,QAAQD,uCAE/CR,OAAAC,eAAIssH,GAAAjtH,UAAA,MAAG,KAAP,WAAoB,OAAOY,KAAKO,QAAQiS,qCAK1C65G,IAHE,SAAAA,GAAsB9rH,GAAtB,IAAAoK,EACE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YADM2K,EAAApK,QAAAA,ICnBxB,IAAAgsH,IAyBEA,GAAAntH,UAAAotH,gBAAA,SAAgBlsH,EAAoBkS,GAClC,OAAO,IAAI65G,GAAa,CACtBxlH,GAAIvG,EAAMuG,GACVgL,MAAOvR,EAAMuR,MACbvR,MAAKA,EACLkS,IAAGA,EACHi6G,YAAazsH,KAAK0sH,mBAAmBpsH,EAAOkS,GAC5Cm6G,YAAa,IAAIC,GAAAA,YAAY,IAC7Bl6E,KAAM,CACJywC,cAAenjF,KAAK6sH,oBAAoBvsH,OAKtCisH,GAAAntH,UAAAstH,mBAAR,SAA2BpsH,EAAoBkS,OACvCu4B,EAAQ,IAAIiC,GAAa,GAAI,CAACx6B,IAAGA,IACvCu4B,EAAMkC,UAAU3sC,OAEV+zG,EAAkB,IAAI3nE,GAAiC,IACvDogF,EAAoB,IAAI3+E,GAA8B,CAC1D37B,IAAGA,EACH09B,aAAc,IAKhB,OAHAnF,EAAM+K,YAAYu+D,GAAiB,GACnCtpE,EAAM+K,YAAYg3E,GAAmB,GAE9B/hF,GAGDwhF,GAAAntH,UAAAytH,oBAAR,SAA4BvsH,GAS1B,MAAO,CACLqnC,WAAW,EACXzG,MAAM,EACNoiD,SAXahjF,EAAM2oB,WAAW1oB,QAAQyU,cAAgB,IACjCxC,IAAG,SAAEzD,GAC1B,MAAO,CACLC,KAAM,cAAcD,EAAMC,KAC1B6C,MAAO9C,EAAM8I,MAAQ9I,EAAM8I,MAAQ9I,EAAMC,+BAzChDtP,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,6JAIZ,SAAA2sH,MCVF,IAAAj1G,GAAAy1G,IAAkC/lH,GAAAA,GAAlCsQ,GAAkCg1G,GAAAA,WAEhCxsH,OAAAC,eAAIgtH,GAAA3tH,UAAA,QAAK,KAAT,WAA0B,OAAOY,KAAKO,QAAQD,uCAE9CR,OAAAC,eAAIgtH,GAAA3tH,UAAA,MAAG,KAAP,WAAoB,OAAOY,KAAKO,QAAQiS,qCAK1Cu6G,IAHE,SAAAA,GAAsBxsH,GAAtB,IAAAoK,EACE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YADM2K,EAAApK,QAAAA,ICnBxB,IAAAysH,IAqBEA,GAAA5tH,UAAAotH,gBAAA,SAAgBlsH,EAAmBkS,GACjC,OAAO,IAAIu6G,GAAa,CACtBlmH,GAAIvG,EAAMuG,GACVgL,MAAOvR,EAAMuR,MACbvR,MAAKA,EACLkS,IAAGA,EACHm6G,YAAa,IAAIC,GAAAA,YAAY,4BAblCltH,GAAAA,WAAUC,KAAA,CAAC,CACVC,WAAY,6JAIZ,SAAAotH,MCnBF,IAAAC,IAwBEntH,OAAAC,eAAIktH,GAAA7tH,UAAA,iBAAc,KAAlB,WACE,OAAOY,KAAKu0B,UAAUwW,uCASxBkiF,GAAA7tH,UAAAi0B,SAAA,WAAA,IAAA1oB,EAAA3K,KACEA,KAAKmlD,SAAWnlD,KAAKwS,IAAI0oB,QACtB9P,KAAK6d,GAAAA,aAAa,KAClBtxB,UAAS,SAAEhS,GACV,OAAAgF,EAAKuiH,eAAevnH,MAI1BsnH,GAAA7tH,UAAAs0B,YAAA,WACE1zB,KAAKmlD,SAASz6B,eAGRuiG,GAAA7tH,UAAA8tH,eAAR,SAAuBvnH,GAAvB,IAAAgF,EAAA3K,KACQmtH,EAAiBxnH,EAAOqE,OAAM,SAAE1J,GACpC,OAAAqK,EAAKyiH,gBAAgB9sH,KAEjB+sH,EAAoBF,EAAe36G,IAAG,SAAElS,GAAiB,OAAAA,EAAMuG,KAE/DymH,EAAkBH,EACrB36G,IAAG,SAAElS,GAAuB,OAAAqK,EAAK4iH,qBAAqBjtH,KACtD0J,OAAM,SAAEwjH,GAAqC,OAAAA,IAAc/lH,YAExDgmH,EAAqBztH,KAAK0tH,eAAelmD,MAC5Cx9D,OAAM,SAAEwjH,GACP,OAAOH,EAAkBr8G,QAAQw8G,EAAU3mH,IAAM,IAGrB,EAA5B4mH,EAAmB1qH,SACrB0qH,EAAmB5iH,QAAO,SAAE2iH,GAC1BA,EAAU3rC,eAEZ7hF,KAAK0tH,eAAe9xF,MAAMkW,WAAW27E,EAAoB,CAACv9G,QAAQ,EAAOs+B,UAAU,IACnFxuC,KAAK0tH,eAAeztC,WAAWwtC,IAGJ,EAAzBH,EAAgBvqH,QAClB/C,KAAK0tH,eAAeC,WAAWL,IAI3BL,GAAA7tH,UAAAmuH,qBAAR,SAA6BjtH,GAE3B,GADkBN,KAAK0tH,eAAev1G,IAAI7X,EAAMuG,MAC9BY,UAGlB,OAAInH,EAAM2oB,sBAAsB3S,GACvBtW,KAAK4tH,oBAAoBpB,gBAAe,EAAuBxsH,KAAKwS,KAClElS,EAAM2oB,sBAAsB5O,GAC9Bra,KAAK6tH,oBAAoBrB,gBAAe,EAAsBxsH,KAAKwS,UADrE,GAODy6G,GAAA7tH,UAAAguH,gBAAR,SAAwB9sH,OAChB2oB,EAAa3oB,EAAM2oB,WACzB,GAAIA,aAAsB3S,GACxB,OAAO,EAGT,GAAI2S,aAAsB5O,GAAe,KACjCpG,EAAqBgV,EAAW1oB,SACpC,GACF,OACE0T,EAAkB/B,YAAc+B,EAAkB/B,WAAWzJ,QAIjE,OAAO,wBAvFVmsB,GAAAA,UAASj1B,KAAA,CAAC,CACTc,SAAU,uEAXwBqtH,GAAAA,kCAO3BvB,UACAS,oCASNlsH,GAAAA,SAkFHmsH,IA5EE,SAAAA,GACU14F,EACAq5F,EACAC,GAFA7tH,KAAAu0B,UAAAA,EACAv0B,KAAA4tH,oBAAAA,EACA5tH,KAAA6tH,oBAAAA,ECvBZ,IAAAE,yBAAC5sH,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,cAEFK,QAAS,CACRurH,IAEDtrH,aAAc,CACZsrH,QAGqCc,IAXzC,SAAAA,MCRA,IAAAC,yBASC7sH,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,CACPC,GAAAA,aACA4sH,GAAAA,gBACAF,GACA3B,IAEF1qH,QAAS,CACPqsH,GACA3B,IAEFzqH,aAAc,GACdT,UAAW,CACTgrH,UAGgC8B,IAhBpC,SAAAA,MCTA,IAAAE,IAQSA,GAAAltH,QAAP,WACE,MAAO,CACLC,SAAUitH,GACVhtH,UAAW,0BAThBC,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,GACTM,QAAS,GACTC,aAAc,OAShBusH,IAZA,SAAAA,MCFA,IAAAC,IAgDSA,GAAAntH,QAAP,WACE,MAAO,CACLC,SAAUktH,GACVjtH,UAAW,0BA7BhBC,GAAAA,SAAQxB,KAAA,CAAC,CACRyB,QAAS,GACTO,aAAc,GACdD,QAAS,CACP2nE,GACAC,GACAgF,GACAgB,GACAiqB,GACA1S,GACAqgB,GACAr/B,GACAw/B,GACAU,GACAhnG,GACAinG,GACAwI,GACAG,GACA4M,GACAyN,GACAU,GACAsC,GACAE,QAUJC,IAhCA,SAAAA,MCfA,SAAgBC,GACdl2G,EACAg1D,GAEA,OAAO,IAAIha,GACTh7C,EACAg1D,EAAc9oB,UAAU,eCI5B,IAAA9sC,GAAA+2G,IAC0CrnH,GAAAA,GAD1CsQ,GAC0ComD,IAWxC2wD,GAAAjvH,UAAAshB,MAAA,WACE,OAAO2tG,GAAqBxnH,IAG9BwnH,GAAAjvH,UAAAuyB,QAAA,WACE,OAAO08F,GAAqB5oH,MAMpB4oH,GAAAjvH,UAAAu+D,kBAAV,WACE,MAAO,CACL9rD,MAAO,oBACPksD,UAAW,wDASfswD,GAAAjvH,UAAA0/D,OAAA,SACE54B,EACA3lC,GAFF,IAAAoK,EAAA3K,KAMEkmC,GADAA,GADAA,EAAOA,EAAKooF,SAAS,KAAOpoF,EAAKnP,MAAM,GAAI,GAAKmP,GACpC4N,WAAW,KAAO5N,EAAKpoB,OAAO,GAAKooB,GACnCn4B,QAAQ,KAAM,QAEpBnI,EAAS5F,KAAK+hH,2BAA2B77E,EAAM3lC,GAAW,IAChE,OAAKqF,EAAOuS,IAAI,WAAcvS,EAAOuS,IAAI,UAAUzC,MAAM,cAGlD1V,KAAKkY,KACTC,IAAInY,KAAK+9D,UAAW,CAAEn4D,OAAMA,EAAEwS,aAAc,SAC5CgT,KAAK5Y,GAAAA,IAAG,SAAE8c,GAAqB,OAAA3kB,EAAKuzG,eAAe5uF,MAJ7CiP,GAAAA,GAAG,KAON8vF,GAAAjvH,UAAA2iH,2BAAR,SACE77E,EACA3lC,GAEA,OAAO,IAAIqtD,GAAAA,WAAW,CACpBC,WAAY/tD,OAAO2C,OACjB,CACE8rH,OAAQroF,EACR/xB,KAAM,QAERnU,KAAK4F,OACLrF,EAAQqF,QAAU,OAKhByoH,GAAAjvH,UAAA8+G,eAAR,SAAuB5uF,GAAvB,IAAA3kB,EAAA3K,KACE,OAAOsvB,EACJ7kB,MAAM,UACNT,OAAM,SAAEwkH,GAAgB,OAAa,EAAbA,EAAIzrH,SAC5ByP,IAAG,SAAEg8G,GAAgB,OAAA7jH,EAAKo0G,aAAayP,MAGpCH,GAAAjvH,UAAA2/G,aAAR,SAAqB/gG,OACbwwG,EAAMxwG,EAAKvT,MAAM,KACjB8jH,EAASC,EAAI,GACbliC,EAAMkiC,EAAI,GACVpjH,EAAWpL,KAAKyuH,gBAAgBniC,GAChCl4E,EAAa,CAAEs6G,MAAOH,GACtB1nH,EAAK,CAAC7G,KAAK0gB,QAAS,WAAY6tG,GAAQ9kH,KAAK,KAEnD,MAAO,CACL4X,OAAQrhB,KACR0yC,KAAM,CACJ6sE,SAAUh+F,GACV1a,GAAEA,EACFgL,MAAO08G,EACP71F,KAAM,cAER1a,KAAM,CACJvY,KAAM8b,GACNoH,WAAY,YACZvd,SAAQA,EACRgJ,WAAUA,EACVs+B,KAAM,CACJ7rC,GAAEA,EACFgL,MAAO08G,MAMPF,GAAAjvH,UAAAqvH,gBAAR,SAAwBniC,OAChBjnF,GAAU,IAAIonF,IAAQlsE,YAAY+rE,EAAK,CAC3Cp/E,eAAgB,YAChBC,kBAAmB,cAErB,MAAO,CACL1H,KAAMJ,EAAQ2rB,cAAcW,UAC5B8tB,YAAap6C,EAAQ2rB,cAAc8B,mBA7GhCu7F,GAAAxnH,GAAK,WACLwnH,GAAA5oH,KAAO8b,wBAHf7hB,GAAAA,uDAhBQga,GAAAA,8CAuBJ05C,GAAAA,OAAMzzD,KAAA,CAAC,gBA2GZ0uH,IA7GE,SAAAA,GACUn2G,EACW3X,GAFrB,IAAAoK,EAIE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YAHN2K,EAAAuN,KAAAA,ICZZ,SAAgBy2G,GACdz2G,EACAiF,GAEA,OAAO,IAAIkxG,GACTn2G,EACAiF,EAAOinC,UAAU,iBAAiBiqE,GAAqBxnH,KCD3D,IAAAyQ,GAAAs3G,IAC2C5nH,GAAAA,GAD3CsQ,OAYEs3G,GAAAxvH,UAAAshB,MAAA,WACE,OAAOkuG,GAAsB/nH,IAG/B+nH,GAAAxvH,UAAAuyB,QAAA,WACE,OAAOi9F,GAAsBnpH,MAMrBmpH,GAAAxvH,UAAAu+D,kBAAV,WACE,MAAO,CACL9rD,MAAO,kBACPksD,UAAW,6CACXC,SAAU,CACR,CACEv4D,KAAM,WACNoM,MAAO,eACP7C,KAAM,UACN8I,OAAQ,CACN,CACEjG,MAAO,qCACP3R,MACE,sFACFuI,SAAS,GAEX,CACEoJ,MAAO,uCACP3R,MACE,8FACFuI,SAAS,GAEX,CACEoJ,MAAO,8CACP3R,MACE,yMAGHuI,SAAA,IAGCoJ,MAAO,wCACP3R,MAAO,4BACRuI,SAAA,MAKHhD,KAAK,cACLoM,MAAM,gBACN7C,KAAM,eACJ,EAEE6C,MAAO,KACP3R,MAAO,GACRuI,SAAA,IAGCoJ,MAAO,KACP3R,MAAO,GACRuI,SAAA,IAGCoJ,MAAO,KACP3R,MAAO,GACRuI,SAAA,MAKHhD,KAAK,cACLoM,MAAM,iBACN7C,KAAM,sBACJ,EAEE6C,MAAO,0CACP3R,MAAO,KACRuI,SAAA,IAGCoJ,MAAO,uCACP3R,MAAO,KACRuI,SAAA,MAKHhD,KAAK,cACLoM,MAAM,kBACN7C,KAAM,gBACJ,EAEE6C,MAAO,6CACP3R,MAAO,EACRuI,SAAA,IAGCoJ,MAAO,8CACP3R,MAAO,EACRuI,SAAA,qCAYXy9B,EAAA3lC,cAKMqF,EAAQ5F,KAAI+hH,2BAAM77E,EAAA3lC,GAAA,WACpBqF,EAAO24B,IAAAA,KAGNv+B,KAAIkY,KACJC,IAAInY,KAACwS,UAAG,CAAA5M,OAAAA,yBACZ0pB,GAAA,OAAA3kB,EAAAuzG,eAAA5uF,MAJEu/F,GAAAtwF,GAAA,sDAUD2H,EAAW0nB,UACT,IAAAkhE,GAAUlhE,WAAS,YAEP9tD,OAAA2C,OAAY,CACpB+7G,EAAAx+G,KAAQy+G,YAAMv4E,GAEhB/+B,OAAK,QAGNnH,KAAA4F,OAAArF,EAAAqF,QAAA,4CAGL0pB,GACE,IAAA3kB,EAAO3K,2BACRge,GAAA,OAAArT,EAAAo0G,aAAA/gG,8HAQCnX,EAAO,CAAA7G,KAAA0gB,QAAA,QAAA1C,EAAA+wG,UAAAtlH,KAAA,WACL,CACA4X,OAAMrhB,UACJ,CACAu/G,SAAEh+F,GACF1a,GAAAA,EACAgL,MAAMmM,EAAAgxG,aACPt2F,KAAA,mBAEC,CACAjzB,KAAA8b,GACAoH,WAAQ,YACRvd,SAAMA,EACNpC,OAAAA,EACAoL,WAAMA,OACF,CACFvN,GAAAA,EACDgL,MAAAmM,EAAAgxG,yDAMLhxG,SACE,CACAgxG,aAAchxG,EAACgxG,aACfD,SAAU/wG,EAAK+wG,SACfE,SAAOjxG,EAAKixG,SACZC,QAAMlxG,EAAKkxG,SACXzpH,KAAAuY,EAAAvY,6CAIFuY,SACE,CACAvY,KAAA,QACAg6C,YAAA,CAAA16B,WAAA/G,EAAAkF,KAAA6B,WAAA/G,EAAAmF,4CAIFnF,SACE,CACA+G,WAAW/G,EAAKmxG,YAAY,IAC5BpqG,WAAW/G,EAAKmxG,YAAY,IAC5BpqG,WAAW/G,EAAKmxG,YAAY,IAC5BpqG,WAAA/G,EAAAmxG,YAAA,wCAIFjpF,GACD,OAAAlmC,KAAAovH,gBAAAlpF,6CAQC,IAAIo4B,EAAWhnD,GAAAlY,UAAAg/D,iBAAAp7D,KAAAhD,KAAAkmC,EAAA,kBACbo4B,EAIAA,EAAOv7D,QAITmjC,EAAAA,EAASn4B,QAAO,aAAA,uBACNshH,GACPnpF,GAAA,KAAAmpF,EAAA,MAGJnpF,GARE,KAJAlmC,KAAAsvH,oBAAAppF,8CAmBIA,GAaN,8CAZO83B,GACc,YAAhBA,EAAShvD,gCACEiU,wCAEEA,EAAO/iB,MAAAuK,MAAA,sBACNvK,GACPgmC,GAAA,KAAAhmC,EAAA,UAMZgmC,GA5PM0oF,GAAA/nH,GAAI,0BAHZnH,WAAU,kJACgCkvH,IAIzC,SAAAA,GACU12G,EACW3X,GAFrB,IAAAoK,EAIE2M,GAAAtU,KAAAhD,KAAMO,IAAQP,YAHN2K,EAAAuN,KAAAA,aCPVq3G,GACEr3G,EACAiF,GAEH,OAAA,IAAAyxG,GAAA12G,EAAAiF,EAAAinC,UAAA,iBAAAwqE,GAAA/nH,SCa0DyQ,GAAZtQ,IAc7C5E,GAAAotH,GAdyDl4G,qCAuGxD,OAAAk4G,GAAA3oH,oCAIA,OAAA2oH,GAAA/pH,sDAIG,CACAoM,MAAA,iBACAksD,UAAA,4EAgBJ73B,EAAA3lC,sEAcIqF,EAAI5F,KAAOg+G,qBAAuBz9G,GAAK,GAAAkvH,UAEvC,IAAA37G,OAAW,YAAK,KAAA1K,KAAApJ,KAAA0vH,qBAAAC,cACb3vH,KAAIkY,KACJC,IAAInY,KACHwS,UAAG,CAAA5M,OAAAA,EAAAwS,aAAA,8BACDkX,GAEH,OAAC3kB,EAAAuzG,eAAAvzG,EAAAilH,eAAAtgG,qEAIOA,GAEV,OAAC3kB,EAAAuzG,eAAAvzG,EAAAilH,eAAAtgG,kIAmBL,OARoB,IAAKxb,OAAA,aAAe,KACvBnM,KAAAA,KACfL,EAAAE,GAAA25F,SAEC0uB,EAAWzmH,KAAG0mH,KACfxoH,EAAAE,GAAAuoH,KAGF,IAAAzoH,8GAQA,OADgB+B,KAACo1B,OAAA,IAAAuxF,GAAAj0B,cAAAk0B,wFAUdlhH,4BAEA,IAAImhH,EAAc,IAAKp8G,OAAA/E,EAAcohH,YAAE,OAAA,KACrCD,EAAY9mH,KAAAgnH,KACZx7G,EAAA7F,EAAAohH,YAAgBv7G,GAAc,EAAMA,EACrCw7G,EAAAA,EAAA3lH,MAAAylH,GAAA,MAGD,IAAAt7G,EACAy7G,EAAO5hH,EAAa,GAAAO,MAAAk3B,OAIVvhC,GAAO8J,GAAAshC,8BAEjB,IAAImgF,EAAa,IAAIp8G,OAAA/E,EAAaohH,aAAS,OAAA,mBAEzC,IAAAr4G,EAAas4G,EAAa3lH,MAAAylH,GAC1BE,EAAet4G,EAAA,GACbA,EAAA,KACDu4G,EAAAthH,EAAAC,MAAA8I,EAAA,GAAA+M,YAVJwrG,yDAqBarwH,KAAE0vH,qBAAAY,eACbphH,uBACQ,kBACP,QACJ,eACE,IAAA4/G,GAAUlhE,WAAS,YAER9tD,OAAO2C,OAAA,CACdkrD,QAAS,MACTj5C,QAAS67G,EACTziE,QAAA,aACAwiE,eAActwH,KAAA0vH,qBAA4BY,eAC1CE,QAAAxwH,KAAc0vH,qBAAKc,QAErBb,aACA3vH,KAAK0vH,qBACSC,cAEf9sD,EAAA7iE,KAAA4F,OAAArF,EAAAqF,QAAA,4CAGL0pB,GAGE,IAAA3kB,EAAO3K,oCACEge,GACN,OAAArT,EAAAo0G,aAAA/gG,qHAOMA,EAAA5J,WAAApU,KAAqB0vH,qBAAWe,aACrCzwH,KAAK0vH,qBAAWe,YACpBzwH,KAAOywH,kBACL,CACApvG,OAAMrhB,UACJ,CACAyF,KAAA8b,GACAoH,WAAU,gCAGVvU,WAAMA,OACF,CACFvN,GAAAA,EACDgL,MAAAmM,EAAA5J,WAAAvC,UAGD,CACA0tG,SAAEh+F,GACF1a,GAAAA,EACAgL,MAAAmM,EAAW5J,WAAKvC,MAChBotG,UAAMjhG,EAAA5J,WAAYvC,GACnB6mB,KAAA,2DAUJ,OADkBg4F,GAAC/+G,YAAA8tG,WAAAzhG,EAAA5J,WAAAo7G,GAAA9P,sBA5Rb8P,GAAA3oH,GAAI,gBACJ2oH,GAAA/pH,KAAA8b,MACMm+F,oBAAA,CACX,YACA,KACA,UACA,cAVOv8G,WAAA,kJACoCqsH,aAc7CA,GAIQt3G,EAAO3X,GAHL,IAAAoK,EAAI2M,GAAYtU,KAAAhD,KAAAO,IAAAP,QAIxB2K,EAAKuN,KAAAA,EACLvN,EAAI+kH,qBAAK,4DAER,OAAA/kH,KAYCA,EAAO+kH,uBAGPz+G,QAAKC,IAAA,+FACHw+G,qBAAgB,CAChBY,sBACA7hH,OAdc,CAChB,CAAEO,KAAM,OAAA2hH,aAAY,OACrB,CAAA3hH,KAAA,WAAA2hH,aAAA,IAAAR,YAAA,QAaGR,2CACAa,oBACAC,YAVM,SAYR9lH,EAAA8lH,YAZQ,QAaTx/G,QAAAC,IAAA,iBAAAvG,EAAA+kH,+DAKC,IAAApiE,EAAU,wHACX,MAAA,IAAA5lD,MAAA4lD,OAEC3iD,EAAM+kH,qBACJjhH,OAEH,MAAA,IAAA/G,MAAA,mHAGCgoH,qBAAKC,aACPhlH,EAAK+kH,qBAAqBC,cAAO,gCAC/BD,qBAAKc,oDAIS7lH,EAAQ+kH,qBAAkBY,eAAAphH,cACnC6C,SAAA,qBACF29G,qBAAaC,aACbzgH,0CAIAo+C,EAAI,2FAER,MADCA,GAAM,sCACP,IAAA5lD,MAAA4lD,GAwBF,OArBG3iD,EAAK+kH,qBAAqBjhH,kBAAexM,QAC1C0I,EAAA+kH,qBAAAjhH,OAAA,CAAA9D,EAAA+kH,qBAAAjhH,WAGCmiH,oBAEsC,EAAxCjmH,EAAK+kH,qBAAqBjhH,OAAO1L,sDACvBgM,EAACgC,MACPpG,EAAMimH,sBACJ7hH,EAAAohH,aAAA,IAAAp/G,EAEH,MAAA,IAAArJ,MAAA,6GAECqH,EAAM4hH,aAGP,MAAA,IAAAjpH,MAAA,qFAIDgoH,qBAAKe,8DACR9lH,MA0M+D2M,GAAZtQ,IASpD5E,GAAAyuH,GATgEv5G,qCAyC/D,OAAAu5G,GAAAhqH,oCAIA,OAAAgqH,GAAAprH,sDAIG,CACAoM,MAAA,2BACAksD,UAAA,wFASJ97C,EAAA1hB,cAOIqF,EAAI5F,KAAOg+G,qBAAuB/7F,EAAK1hB,GAAA,WAEvC,IAAAuT,OAAW,YAAK,KAAA1K,KAAApJ,KAAA0vH,qBAAAC,cACb3vH,KAAIkY,KACJC,IAAInY,KACHwS,UAAG,CAAA5M,OAAAA,EAAAwS,aAAA,8BACDkX,GAEH,OAAC3kB,EAAAuzG,eAAAvzG,EAAAilH,eAAAtgG,qEAIOA,GAEV,OAAC3kB,EAAAuzG,eAAAvzG,EAAAilH,eAAAtgG,kIAmBL,OARoB,IAAKxb,OAAA,aAAe,KACvBnM,KAAAA,KACfL,EAAAE,GAAA25F,SAEC0uB,EAAWzmH,KAAG0mH,KACfxoH,EAAAE,GAAAuoH,KAGF,IAAAzoH,8GAQA,OADgB+B,KAACo1B,OAAA,IAAAuxF,GAAAj0B,cAAAk0B,qDAQhB,IAAAa,EAAmB,UACnBA,EAAc9wH,KAAK0vH,qBAAqBqB,WAAY9uG,EAAQ,GAE5D6uG,EAAWljE,KAAAA,qBAAWojE,UAAA/uG,EAAA,GACpB,IAAA6sG,GAAUlhE,WAAS,YAER9tD,OAAO2C,OAAA,CACdkrD,QAAS,MACTj5C,QAAS,QACTo5C,QAAA,aACAwiE,eAActwH,KAAA0vH,qBAA4BY,eAC1CE,QAAAxwH,KAAc0vH,qBAAKc,QAErBb,aACA3vH,KAAK0vH,qBACGC,cAETmB,EAAA9wH,KAAA4F,OAAArF,EAAAqF,QAAA,4CAGL0pB,GAGE,IAAA3kB,EAAO3K,oCACEge,GACN,OAAArT,EAAAo0G,aAAA/gG,qHAOMA,EAAA5J,WAAApU,KAAqB0vH,qBAAWe,aACrCzwH,KAAK0vH,qBAAWe,YAEpBzwH,KAAOywH,kBACL,CACApvG,OAAMrhB,UACJ,CACAyF,KAAA8b,GACAoH,WAAU,YACVvd,SAAU4S,EAAA5S,SACVgJ,WAAMA,OACF,CACFvN,GAAAA,EACDgL,MAAAmM,EAAA5J,WAAAvC,UAGD,CACA0tG,SAAEh+F,GACF1a,GAAAA,EACAgL,MAAMmM,EAAA5J,WAAYvC,GACnB6mB,KAAA,2DAWH,IAAAtkB,EAAcs8G,GAAO/+G,YAAc8tG,WAAWzhG,EAAA5J,WAAWy8G,GAAYnR,qBACtE,OAAA5/G,OAAA2C,OAAA2R,EAAA,CAAA3O,KAAAuY,EAAA5J,WAAA68G,YAhLMJ,GAAAhqH,GAAI,uBACJgqH,GAAAprH,KAAA8b,gCALEpe,WAAA,kJAC2C0tH,aASpDA,GAIgB34G,EAAA3X,GAHN,IAAAoK,EAAI2M,GAAYtU,KAAAhD,KAAAO,IAAAP,QAIxB2K,EAAKuN,KAAAA,EACLvN,EAAK+kH,qBAAK,0CAIT,MAAA,IAAAhoH,MADW,6HAGViD,EAAM+kH,qBACJqB,UAEH,MAAA,IAAArpH,MAAA,wGAECiD,EAAM+kH,qBACJsB,SAEH,MAAA,IAAAtpH,MAAA,kGAQF,SALGgoH,qBAAKC,aACPhlH,EAAK+kH,qBAAqBC,cAAO,gCAC/BD,qBAAKc,QACP7lH,EAAK+kH,qBAAqBc,SAAW,cACnCd,qBAAKe,8DACR9lH,WChWDumH,GACEh5G,EACAiF,GAEH,OAAA,IAAAqyG,GAAAt3G,EAAAiF,EAAAinC,UAAA,iBAAAorE,GAAA3oH,cAuBCsqH,GACEj5G,EACAiF,GAEH,OAAA,IAAA0zG,GAAA34G,EAAAiF,EAAAinC,UAAA,iBAAAysE,GAAAhqH,SChDCuqH,GAAO,CACPjwB,QAAI,0DCaoD7pF,GDVxD+5G,GAAe,CACfC,MAAO,qBCSiCtqH,IAYxC5E,GAAAmvH,GAZwDj6G,yDAEtD,WACD,OAAA,IAAAtX,KAAAO,QAAAkI,aAEC,SAAKvI,GACNF,KAAAO,QAAAkI,QAAAvI,iBAHAsxH,cAAA,oCAiBA,OAAAD,GAAAE,mCAEDhyE,EAOCyyD,GAPsC,IAAAvnG,EAAA3K,UAAyC,IAAzCkyG,UAErC,IAAAiL,EAAgBn9G,KAAA0xH,eAAAxf,UACblyG,KAAYkY,KACXC,IAAAnY,KAAQ48G,cAAgBn9D,EAAAh2C,KAAA,KAAA,CACxB7D,OAAAu3G,yBAELzoF,GAAA,OAAA/pB,EAAAgnH,kBAAAj9F,+CAEDpF,cAEE4qF,EAAgB,GAIjB,iCAHGzwE,GACCywE,EAAAz1G,KAAAkG,EAAAinH,YAAAnoF,EAAAna,EAAAuiG,cAEJ3X,wCAEsBhI,eAAyC,IAAzCA,UAGrBA,EAAkB8D,aAAQ9D,EAAuB8D,eAAkBvuG,WAAAyqG,EAA+B8D,aAClG9D,EAAkB6D,MAAA7D,EAAa6D,QAAkBtuG,WAAeyqG,EAAa6D,MAC7E7D,EAAkB4f,WAAW5f,EAAkB4f,aAAarqH,UAAayqG,EAAkB4f,WAAiB,UAE5G5f,EAAWtkD,SAAWskD,EAAAwD,WAAAjuG,WAAAyqG,EAAAwD,SACpB,IAAAoZ,GAAUlhE,WAAE,YACV,CACAooD,aAAU9D,EAAkB8D,aAAW,OAAe,QACtDN,SAAOxD,EAAkBwD,SAAc,aAAU,OACjDK,MAAA7D,EAAY6D,MAAkB,OAAU,QACzC+b,WAAA5f,EAAA4f,WAAA5f,EAAA4f,WAAA,qDAMH,IAAAC,EAAA,kCACWC,4BACC/gE,GACP8gE,EAAAttH,KAAAwsD,OAGD,CACFpqD,GAAA6pH,GAAOtqH,OACPyL,MAAMogH,EAAEC,KAAqB,GAAAhZ,QAC7B73F,OAAAkwG,GAAYE,MACZU,WAAQd,GAAAC,MACRz4D,MAAM,EACN1xD,OAAMiqH,GAAYjwB,QAClBzoE,KAAA,aACA/P,WAAS,YACTkpG,UAAUA,EACV1zB,SAAU8zB,EAAiB9zB,SAC3B/sE,SAAU6gG,EAAiB7gG,SAC3BhmB,SAAM6mH,EAAqB7mH,SAC3B8mH,KAAKD,EAASC,KACdnc,MAAMgc,EACN9pE,OAAAgqE,EAAahqE,OACbmqE,YAAAH,EAAAG,wCAjFL1yH,WAAU,iEARFykD,GAAAA,sCASiCotE,aAYxCA,GACEr5G,EAAOiF,GADW,IAAAxS,EAAI2M,GAAYtU,KAAAhD,OAAAA,KAInC,OAJ6C2K,EAAAuN,KAAMA,EAJ5CvN,EAAAwS,OAAAA,EAMNxS,EAAKiyG,cAAe,sEACpBjyG,EAAKpK,QAAAoK,EAAgBwS,OAAKinC,UAAW,2BAAuB,kDAC7Dz5C,WCpBD0nH,GAAgCn6G,EAAMiF,GACvC,OAAA,IAAAo0G,GAAAr5G,EAAAiF,OCOoD7F,GAAbtQ,IAEtC5E,GAAAkwH,GAFmDh7G,0CAWjDs1B,EAiCC2uD,EAAAp0F,EAAA0K,EAAAihC,EAAAZ,GAzBC,IAAIvnC,EAAK3K,yCAGL87F,cAAgBC,cAAanvD,EAAA,CAC7B1/B,eAAAglC,EACA/kC,kBAAa2lC,EACbk6B,YAAW,UACXnjE,UAAA,uDAIF0oH,EAAYvyH,KAAS0+F,KAAE8zB,sBAAA,WACvBvhH,QAAKC,IAAKqhH,yDACVxkD,GAAgE,OAAApjE,EAAA8nH,WAAApzH,KAAAkzH,EAAA,IAAAG,EAAA,gBAEjEn3B,EAAAriF,gBASA5B,GAAAlY,UAAAw8F,aAAA54F,KAAAhD,KAAA4sC,EAAA2uD,EAAAp0F,EAAA0K,EAAAihC,EAAAZ,OA9CNxyC,WAAU,qBACCC,KAAE,CAAM,CACnBC,WAAA,qDAPQ+yH,GAAAA,qBAEAC,GAAAA,gBADAC,GAAAA,gCAZTC,gBAAAC,GAAAC,iBAAA,CAAAC,QAAA,WAAA,OAAA,IAAAX,GAAAS,GAAAG,OAAAC,GAAAhvE,eAAA4uE,GAAAG,OAAAE,GAAAT,UAAAI,GAAAG,OAAAG,GAAAT,YAAAG,GAAAG,OAAAI,GAAAT,QAAAU,MAAAjB,GAAA1yH,WAAA,SAmBwC0yH,aAEtCA,GAMIn1G,EAAMq2G,EAAOf,EACd/zB,GALS,IAAA/zF,EAAA2M,GAAAtU,KAAAhD,KAAkBmd,IAAAnd,KAK3B,OAJS2K,EAAA6oH,SAAUA,EACV7oH,EAAA8nH,WAAUA,WAGnB9nH,MChB8C2M,GAAZtQ,IAQrC5E,GAAAqxH,GARiDn8G,qCAmBjDixF,GACE,IAAI59F,EAAK3K,kFAIHmtF,EAAQ,IAAG99D,WAAA+sB,GACfp8C,KAAK0zH,cACD,IAAK9wH,EAAG,EAAGA,EAAA+wH,EAAU5wH,OAAaH,IACrCuqF,EAAAvqF,GAAA+wH,EAAAC,WAAAhxH,0FAGG2vH,EAAMvyH,KAAU0+F,KAAA8zB,sBAA2B,iEAC7CzkD,GAAqE,OAAApjE,EAAA8nH,WAAApzH,KAAAkzH,EAAA,IAAAG,EAAA,0BAGxEp7G,GAAAlY,UAAAgqG,QAAApmG,KAAAhD,KAAAuoG,oCAICvoG,KAAK8pE,KAAM,IAAKr5C,KAChBzwB,KAAKyqE,IAAKzqE,KAAG8pE,KAAK+pD,UAAa96F,WAC/B/4B,KAAIuqE,MAAKvqE,KAAQ8pE,KAAIU,WAAA,EACnBxqE,KAAKuqE,MAAQ,GACdvqE,KAAAuqE,MAAA,IAAAvqE,KAAAuqE,MAAAxxC,WAEA/4B,KAAAuqE,MAAAvqE,KAAAuqE,MAAAxxC,WAED/4B,KAAKoqE,KAAOpqE,KAAK8pE,KAAKQ,cAAWvxC,WACjC/4B,KAAK2qE,KAAM3qE,KAAG8pE,KAAKkhB,WAAKjyD,WAC3B/4B,KAAA6qE,OAAA7qE,KAAA8pE,KAAAohB,aAAAnyD,eAnDFr5B,WAAU,qBACCC,KAAE,CAAM,CACnBC,WAAA,qDALwBm0B,GAAAA,sBAAiBiM,GAAAA,uBAJjC2yF,GAAAA,uBAEAC,GAAAA,gBADAC,GAAAA,gCAHTC,gBAAAC,GAAAC,iBAAA,CAAAC,QAAA,WAAA,OAAA,IAAAQ,GAAAV,GAAAG,OAAAC,GAAAnxE,gBAAA+wE,GAAAG,OAAAC,GAAAp/F,iBAAAg/F,GAAAG,OAAAC,GAAAnzF,iBAAA+yF,GAAAG,OAAAE,GAAAT,UAAAI,GAAAG,OAAAG,GAAAT,YAAAG,GAAAG,OAAAI,GAAAT,QAAAU,MAAAE,GAAA7zH,WAAA,SAYuC6zH,aAQrCA,GAQEryE,EAAMztB,EAAgBuL,EAAiBs0F,EAAgBf,EACxD/zB,GALS,IAAA/zF,EAAA2M,GAAAtU,KAAAhD,KAAkBohD,EAAAztB,EAAAuL,IAAAl/B,KAK3B,OAJS2K,EAAA6oH,SAAUA,EACV7oH,EAAA8nH,WAAUA,WAGnB9nH,8wBXZH,SAAgBmpH,KACd,MAAO,CACLt6B,QAAShoC,GACTs1C,WAAYsnB,GACZpnB,KAAM,CAACttF,GAAAA,WAAYyqC,GAAAA,4IEGvB,SAAgB4vE,KACd,MAAO,CACLv6B,QAAS97B,GACTopC,WAAY6nB,GACZ5nB,OAAO,EACPC,KAAM,CAACttF,GAAAA,WAAYyqC,GAAAA,kLnC2BvB,SAAgB6vE,KACd,MAAO,CACLx6B,QAAS97B,GACTopC,WAAYga,GACZ/Z,OAAO,EACPC,KAAM,CACJttF,GAAAA,WACAsmB,GAAAA,gBACAmkB,GAAAA,cACAu5D,GACAvb,GAAAA,yFA0BN,SAAgB8xB,KACd,MAAO,CACLz6B,QAAS97B,GACTopC,WAAYia,GACZha,OAAO,EACPC,KAAM,CAACttF,GAAAA,WAAYsmB,GAAAA,gBAAiBmkB,GAAAA,cAAeg+C,GAAAA,uME/CvD,SAAgB+xB,KACd,MAAO,CACL16B,QAAS97B,GACTopC,WAAY0a,GACZza,OAAO,EACPC,KAAM,CAAC7iD,GAAAA,cAAenkB,GAAAA,gBAAiB+jB,iJEN3C,SAAgBowE,KACd,MAAO,CACL36B,QAAS97B,GACTopC,WAAY2b,GACZ1b,OAAO,EACPC,KAAM,CAACttF,GAAAA,WAAYsmB,GAAAA,gBAAiBmkB,GAAAA,cAAeu9D,gFiC7BrD0S,WACE,CACA56B,QAAA97B,GACAopC,WAAWyoB,GACXxoB,OAAOrtF,EACPstF,KAAA,CAAA8nB,GAAAp1G,WAAAy5G,GAAAhvE,mGEFFkwE,WACE,CACA76B,QAAA97B,GACAopC,WAAWoqB,GACXnqB,OAAOrtF,EACPstF,KAAA,CAAA8nB,GAAAp1G,WAAAy5G,GAAAhvE,iHAsBFmwE,WACE,CACA96B,QAAA97B,GACAopC,WAAWqqB,GACXpqB,OAAOrtF,EACPstF,KAAA,CAAA8nB,GAAAp1G,WAAAy5G,GAAAhvE,0FG7CFowE,WACE,CACA/6B,QAAAqY,GACA/K,WAAWurB,GACXtrB,OAAOrtF,EACPstF,KAAA,CAAA8nB,GAAAp1G,WAAAy5G,GAAAhvE,41CzKoWJ,SAAgBqwE,GAAcl/F,GAC5BA,EAAUlD,SAAS,IAAI4D,GAAAA,MAAc,6X4KxXnCy+F,qBAAuB,uBACvBC,MAAQ,QACRC,gBAAkB,kBAClBC,QAAU,UACVC,IAAM,MACNC,KAAO,6E3HLP3nD,UAAY,YACZM,IAAM,MACNL,OAAS,SACTC,QAAU,UACVC,SAAW,WACXC,OAAS,SACTC,IAAM,MACNE,QAAU,0sC0C2Cd,SAAgBqnD,GAAYC,EAAeh5B,EAAkB7gF,QAAA,IAAAA,IAAAA,EAAA,SAErD85G,EADQD,EAAKxiH,IAAG,SAAE0iH,EAAcnkH,GAAkB,OAAAmkH,EAAIzrH,KAAK0R,KACxC1R,KAAK,MAC9BwyF,GAAAA,gBAAgBg5B,EAAY,yBAA0Bj5B,wBASxD,SAAgBm5B,GAAkBnnF,EAAoBs1C,GACpD,OAAOt1C,EAASx7B,IAAG,SAAEg9B,GACnB,OAAO8zC,EAAQ9wE,IAAG,SAAE4iH,OACdzwD,EAKJ,OAJIywD,EAAO16F,WAAajzB,WAAa2tH,EAAO16F,WAAa26F,GAAAA,0BAA0B1zG,UACjFgjD,EAAgBywD,EAAOzwD,gBAEzBA,EAAgBA,GAAgCpyB,GAAAA,mBAC3B/C,EAAQ4lF,EAAOpmH,27BkFtExC2yB,OAAS,SACTC,MAAQ,QACRC,UAAU,gxBlHFqB,qpBC0VjC,SAAgByzF,GAAyB/gF,GAGvC,QAFMo/B,EAAcp/B,EAAWp8B,IAAI,eAAiB,GAC9C07D,EAAkBF,EAAY5wE,OAC3BH,EAAI,EAAGA,EAAIixE,EAAiBjxE,IAAK,KAClCoxE,EAAaL,EAAY/wE,GAC3BoxE,IAAevsE,WACbusE,IAAevsE,WACjB0sE,GAAuBH,GAO7B,OAFAz/B,EAAW5oB,IAAI,aAAclkB,WAAW,GAEjCksE,kxCwDlUT,SAAgB4hD,GACdlwH,EACAgc,GAGA,OADAhc,EAAQstC,SAAWtxB,EAAOX,QACnB,CACLW,OAAMA,EACNrD,KAAM3Y,EACNqtC,KAAM,CACJ6sE,SAAUh+F,GACV1a,GAAIxB,EAAQqtC,KAAO,GACnB7gC,MAAOxM,EAAQqtC,KAAK7gC,MACpB6mB,KAAMrzB,EAAQqtC,KAAKha,MAAQ","sourcesContent":["import { Injectable } from '@angular/core';\r\n\r\nimport { MetadataOptions } from './metadata.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MetadataService {\r\n  constructor() {}\r\n\r\n  open(metadata: MetadataOptions) {\r\n    if (metadata.extern) {\r\n      window.open(metadata.url, '_blank');\r\n    }\r\n  }\r\n}\r\n","import { Component, Input, ChangeDetectionStrategy } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../shared/metadata.interface';\r\nimport { MetadataService } from '../shared/metadata.service';\r\n\r\n@Component({\r\n  selector: 'igo-metadata-button',\r\n  templateUrl: './metadata-button.component.html',\r\n  styleUrls: ['./metadata-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MetadataButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private metadataService: MetadataService) {}\r\n\r\n  openMetadata(metadata: MetadataOptions) {\r\n    this.metadataService.open(metadata);\r\n  }\r\n\r\n  get options(): MetadataLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatTooltipModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { MetadataButtonComponent } from './metadata-button/metadata-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [MetadataButtonComponent],\r\n  declarations: [MetadataButtonComponent]\r\n})\r\nexport class IgoMetadataModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoMetadataModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\nLicensed under the Apache License, Version 2.0 (the \"License\"); you may not use\r\nthis file except in compliance with the License. You may obtain a copy of the\r\nLicense at http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nTHIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED\r\nWARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,\r\nMERCHANTABLITY OR NON-INFRINGEMENT.\r\n\r\nSee the Apache Version 2.0 License for specific language governing permissions\r\nand limitations under the License.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport function __exportStar(m, exports) {\r\n    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];\r\n}\r\n\r\nexport function __values(o) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator], i = 0;\r\n    if (m) return m.call(o);\r\n    return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result.default = mod;\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n","export abstract class DataService {\r\n    abstract getData(): string;\r\n}\r\n","import { Md5 } from 'ts-md5';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { AnyDataSourceOptions } from '../datasource/shared/datasources/any-datasource.interface';\r\nimport { DataSourceOptions } from '../datasource/shared/datasources/datasource.interface';\r\nimport { WMSDataSourceOptions } from '../datasource/shared/datasources/wms-datasource.interface';\r\nimport { WMTSDataSourceOptions } from '../datasource/shared/datasources/wmts-datasource.interface';\r\n\r\n/**\r\n * Generate a id from it's datasource options.\r\n * @param options Data source options\r\n * @returns A id\r\n */\r\nexport function generateIdFromSourceOptions(options: DataSourceOptions): string {\r\n  const generators = {\r\n    wms: generateWMSIdFromSourceOptions,\r\n    wmts: generateWMTSIdFromSourceOptions,\r\n    xyz: generateXYZIdFromSourceOptions,\r\n    feature: generateFeatureIdFromSourceOptions,\r\n    osm: (_options: AnyDataSourceOptions) => 'OSM'\r\n  };\r\n  const generator = generators[options.type] || generateId;\r\n  return generator(options);\r\n}\r\n\r\n/**\r\n * Generate a id from WMS data source options\r\n * @param options WMS data source options\r\n * @returns A md5 hash of the the url and layers\r\n */\r\nexport function generateWMSIdFromSourceOptions(options: WMSDataSourceOptions) {\r\n  const layers = options.params.LAYERS;\r\n  const url = options.url.charAt(0) === '/' ? window.location.origin + options.url : options.url;\r\n  const chain = 'wms' + url + layers;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from WMTS data source options\r\n * @param options WMTS data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateWMTSIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const layer = options.layer;\r\n  const chain = 'wmts' + options.url + layer;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from XYZ data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateXYZIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const chain = 'xyz' + options.url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from feature data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateFeatureIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  if (! options.url) { return generateId(options); }\r\n  const chain = 'feature' + options.url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a unique id\r\n * @returns A uuid\r\n */\r\nexport function generateId(options: AnyDataSourceOptions) {\r\n  return uuid();\r\n}\r\n","import olSource from 'ol/source/Source';\r\n\r\nimport {\r\n  DataSourceOptions,\r\n  Legend\r\n} from './datasource.interface';\r\n\r\nimport { DataService } from './data.service';\r\nimport { generateIdFromSourceOptions } from '../../../utils/id-generator';\r\nimport { LegendOptions } from '../../../layer';\r\n\r\nexport abstract class DataSource {\r\n\r\n  public id: string;\r\n  public ol: olSource;\r\n  private legend: Legend[];\r\n\r\n  constructor(\r\n    public options: DataSourceOptions = {},\r\n    protected dataService?: DataService\r\n  ) {\r\n    this.options = options;\r\n    this.id = this.options.id ||this.generateId();\r\n    this.ol = this.createOlSource();\r\n  }\r\n\r\n  protected abstract createOlSource(): olSource;\r\n\r\n  protected generateId(): string {\r\n    return generateIdFromSourceOptions(this.options);\r\n  }\r\n\r\n  public getLegend(style?: string, scale?: number): Legend[] {\r\n    return this.legend ? this.legend : [];\r\n  }\r\n\r\n  public setLegend(options: LegendOptions): Legend[] {\r\n    if (options.url) {\r\n      this.legend = [{ url: options.url} ];\r\n    } else if (options.html) {\r\n      this.legend = [{ html: options.html} ];\r\n    } else {\r\n      this.legend = [];\r\n    }\r\n\r\n    return this.legend;\r\n  }\r\n\r\n  protected abstract onUnwatch();\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as olformat from 'ol/format';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { FeatureDataSourceOptions } from './feature-datasource.interface';\r\n\r\nexport class FeatureDataSource extends DataSource {\r\n  public options: FeatureDataSourceOptions;\r\n  public ol: olSourceVector;\r\n  protected createOlSource(): olSourceVector {\r\n    const sourceOptions = {\r\n      format: this.getSourceFormatFromOptions(this.options)\r\n    };\r\n\r\n    return new olSourceVector(Object.assign(sourceOptions, this.options));\r\n  }\r\n\r\n  protected getSourceFormatFromOptions(options: FeatureDataSourceOptions) {\r\n    if (options.format) {\r\n      return options.format;\r\n    }\r\n    let olFormatCls;\r\n    const formatType = options.formatType;\r\n    if (!formatType) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    } else {\r\n      olFormatCls = olformat[formatType];\r\n      if (olFormatCls === undefined) {\r\n        throw new Error('Invalid vector source format ${formatType}.');\r\n      }\r\n    }\r\n\r\n    const formatOptions = options.formatOptions;\r\n    let format;\r\n    if (formatOptions) {\r\n      format = new olFormatCls(formatOptions);\r\n    } else {\r\n      format = new olFormatCls();\r\n    }\r\n\r\n    return format;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n}\r\n","import olSourceOSM from 'ol/source/OSM';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { OSMDataSourceOptions } from './osm-datasource.interface';\r\n\r\nexport class OSMDataSource extends DataSource {\r\n  public options: OSMDataSourceOptions;\r\n  public ol: olSourceOSM;\r\n\r\n  protected createOlSource(): olSourceOSM {\r\n    this.options.url = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';\r\n    return new olSourceOSM(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceXYZ from 'ol/source/XYZ';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { XYZDataSourceOptions } from './xyz-datasource.interface';\r\n\r\nexport class XYZDataSource extends DataSource {\r\n  public options: XYZDataSourceOptions;\r\n  public ol: olSourceXYZ;\r\n\r\n  protected createOlSource(): olSourceXYZ {\r\n    return new olSourceXYZ(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import * as olfilter from 'ol/format/filter';\r\nimport olFormatWKT from 'ol/format/WKT';\r\nimport olFormatWFS from 'ol/format/WFS';\r\nimport olGeometry from 'ol/geom/Geometry';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\n\r\nimport {\r\n  OgcFilter,\r\n  IgoOgcFilterObject,\r\n  WFSWriteGetFeatureOptions,\r\n  AnyBaseOgcFilterOptions,\r\n  OgcInterfaceFilterOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  OgcFiltersOptions,\r\n  IgoPushButton,\r\n  PushButtonGroup,\r\n  OgcPushButtonBundle\r\n} from './ogc-filter.interface';\r\nimport { OgcFilterOperatorType } from './ogc-filter.enum';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\n\r\nexport class OgcFilterWriter {\r\n  private filterSequence: OgcInterfaceFilterOptions[] = [];\r\n  public operators = {\r\n    PropertyIsEqualTo: { spatial: false, fieldRestrict: [] },\r\n    PropertyIsNotEqualTo: { spatial: false, fieldRestrict: [] },\r\n    PropertyIsLike: { spatial: false, fieldRestrict: ['string'] },\r\n    PropertyIsGreaterThan: { spatial: false, fieldRestrict: ['number'] },\r\n    PropertyIsGreaterThanOrEqualTo: { spatial: false, fieldRestrict: ['number'] },\r\n    PropertyIsLessThan: { spatial: false, fieldRestrict: ['number'] },\r\n    PropertyIsLessThanOrEqualTo: { spatial: false, fieldRestrict: ['number'] },\r\n    PropertyIsBetween: { spatial: false, fieldRestrict: ['number'] },\r\n    During: { spatial: false, fieldRestrict: [] },\r\n    PropertyIsNull: { spatial: false, fieldRestrict: [] },\r\n    Intersects: { spatial: true, fieldRestrict: [] },\r\n    Within: { spatial: true, fieldRestrict: [] },\r\n    Contains: { spatial: true, fieldRestrict: [] }\r\n  };\r\n\r\n  defineOgcFiltersDefaultOptions(\r\n    ogcFiltersOptions: OgcFiltersOptions,\r\n    fieldNameGeometry: string,\r\n    srcType?: string): OgcFiltersOptions  {\r\n    let ogcFiltersDefaultValue = true; // default values for wfs.\r\n    if (srcType && srcType === 'wms') {\r\n      ogcFiltersDefaultValue = false;\r\n    }\r\n\r\n    ogcFiltersOptions = ogcFiltersOptions || {};\r\n    ogcFiltersOptions.enabled = ogcFiltersOptions.enabled === undefined ? ogcFiltersDefaultValue : ogcFiltersOptions.enabled;\r\n    ogcFiltersOptions.editable = ogcFiltersOptions.editable === undefined ? ogcFiltersDefaultValue : ogcFiltersOptions.editable;\r\n    ogcFiltersOptions.geometryName = fieldNameGeometry;\r\n\r\n    ogcFiltersOptions.advancedOgcFilters = true;\r\n    if (ogcFiltersOptions.enabled && ogcFiltersOptions.pushButtons) {\r\n      ogcFiltersOptions.advancedOgcFilters = false;\r\n    }\r\n    return ogcFiltersOptions;\r\n  }\r\n\r\n  public buildFilter(\r\n    filters?: IgoOgcFilterObject,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection,\r\n    fieldNameGeometry?: string\r\n  ): string {\r\n    let ourBboxFilter;\r\n    let enableBbox: boolean;\r\n    if (/intersects|contains|within/gi.test(JSON.stringify(filters))) {\r\n      enableBbox = false;\r\n    } else {\r\n      enableBbox = true;\r\n    }\r\n    if (filters) {\r\n      fieldNameGeometry =\r\n        (filters as any).geometryName !== undefined\r\n          ? (filters as any).geometryName\r\n          : fieldNameGeometry;\r\n    }\r\n    if (extent && filters) {\r\n      ourBboxFilter = olfilter.bbox(fieldNameGeometry, extent, proj.getCode());\r\n    }\r\n    let filterAssembly: OgcFilter;\r\n    if (filters) {\r\n      filters = this.checkIgoFiltersProperties(filters, fieldNameGeometry, proj);\r\n      if (extent && enableBbox) {\r\n        filterAssembly = olfilter.and(\r\n          ourBboxFilter,\r\n          this.bundleFilter(filters)\r\n        );\r\n      } else {\r\n        filterAssembly = this.bundleFilter(filters);\r\n      }\r\n    } else {\r\n      return 'bbox=' + extent.join(',') + ',' + proj.getCode();\r\n    }\r\n\r\n    const wfsOptions: WFSWriteGetFeatureOptions = {\r\n      srsName: '',\r\n      featureNS: '',\r\n      featurePrefix: '',\r\n      featureTypes: ['featureTypes'],\r\n      filter: filterAssembly,\r\n      outputFormat: '',\r\n      geometryName: fieldNameGeometry\r\n    };\r\n\r\n    const query = new olFormatWFS().writeGetFeature(wfsOptions);\r\n    const str = new XMLSerializer().serializeToString(query);\r\n    const regexp1 = /typenames *=|typename *=\\\"featureTypes\\\" *>/gi;\r\n    const regexp2 = /<\\/Query><\\/GetFeature>/gi;\r\n\r\n    return 'filter=' + str.split(regexp1)[1].split(regexp2)[0];\r\n  }\r\n\r\n  private bundleFilter(filterObject: any) {\r\n    if (filterObject instanceof Array) {\r\n      const logicalArray = [];\r\n      filterObject.forEach(element => {\r\n        logicalArray.push(this.bundleFilter(element));\r\n      });\r\n      return logicalArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return this.createFilter({\r\n          operator: filterObject.logical,\r\n          logicalArray: this.bundleFilter(filterObject.filters)\r\n        });\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.createFilter(filterObject as AnyBaseOgcFilterOptions);\r\n      }\r\n    }\r\n  }\r\n\r\n  private createFilter(filterOptions): OgcFilter {\r\n    const operator = filterOptions.operator;\r\n    const logicalArray = filterOptions.logicalArray;\r\n\r\n    const wfsPropertyName = filterOptions.propertyName;\r\n    const wfsPattern = filterOptions.pattern;\r\n    const wfsMatchCase = filterOptions.matchCase\r\n      ? filterOptions.matchCase\r\n      : true;\r\n    const wfsWildCard = filterOptions.wildCard ? filterOptions.wildCard : '*';\r\n    const wfsSingleChar = filterOptions.singleChar\r\n      ? filterOptions.singleChar\r\n      : '.';\r\n    const wfsEscapeChar = filterOptions.escapeChar\r\n      ? filterOptions.escapeChar\r\n      : '!';\r\n\r\n    const wfsLowerBoundary = filterOptions.lowerBoundary;\r\n    const wfsUpperBoundary = filterOptions.upperBoundary;\r\n\r\n    const wfsGeometryName = filterOptions.geometryName;\r\n    const wfsExtent = filterOptions.extent;\r\n    const wfsWktGeometry = filterOptions.wkt_geometry;\r\n    const wfsSrsName = filterOptions.srsName\r\n      ? filterOptions.srsName\r\n      : 'EPSG:3857';\r\n\r\n    const wfsBegin = filterOptions.begin;\r\n    const wfsEnd = filterOptions.end;\r\n\r\n    const wfsExpression = filterOptions.expression;\r\n\r\n    let geometry: olGeometry;\r\n    if (wfsWktGeometry) {\r\n      const wkt = new olFormatWKT();\r\n      geometry = wkt.readGeometry(wfsWktGeometry, {\r\n        dataProjection: wfsSrsName,\r\n        featureProjection: wfsSrsName || 'EPSG:3857'\r\n      });\r\n    }\r\n\r\n    switch (operator) {\r\n      case 'BBOX':\r\n        return olfilter.bbox(wfsGeometryName, wfsExtent, wfsSrsName);\r\n      case 'PropertyIsBetween':\r\n        return olfilter.between(\r\n          wfsPropertyName,\r\n          wfsLowerBoundary,\r\n          wfsUpperBoundary\r\n        );\r\n      case 'Contains':\r\n        return olfilter.contains(wfsGeometryName, geometry, wfsSrsName);\r\n      case 'During':\r\n        return olfilter.during(wfsPropertyName, wfsBegin, wfsEnd);\r\n      case 'PropertyIsEqualTo':\r\n        return olfilter.equalTo(\r\n          wfsPropertyName,\r\n          wfsExpression,\r\n          wfsMatchCase\r\n        );\r\n      case 'PropertyIsGreaterThan':\r\n        return olfilter.greaterThan(wfsPropertyName, wfsExpression);\r\n      case 'PropertyIsGreaterThanOrEqualTo':\r\n        return olfilter.greaterThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case 'Intersects':\r\n        return olfilter.intersects(wfsGeometryName, geometry, wfsSrsName);\r\n      case 'PropertyIsNull':\r\n        return olfilter.isNull(wfsPropertyName);\r\n      case 'PropertyIsLessThan':\r\n        return olfilter.lessThan(wfsPropertyName, wfsExpression);\r\n      case 'PropertyIsLessThanOrEqualTo':\r\n        return olfilter.lessThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case 'PropertyIsLike':\r\n        return olfilter.like(\r\n          wfsPropertyName,\r\n          wfsPattern.replace(/[()_]/gi, wfsSingleChar),\r\n          wfsWildCard,\r\n          wfsSingleChar,\r\n          wfsEscapeChar,\r\n          wfsMatchCase\r\n        );\r\n      case 'PropertyIsNotEqualTo':\r\n        return olfilter.notEqualTo(\r\n          wfsPropertyName,\r\n          wfsExpression,\r\n          wfsMatchCase\r\n        );\r\n      case 'Within':\r\n        return olfilter.within(wfsGeometryName, geometry, wfsSrsName);\r\n      // LOGICAL\r\n      case 'And':\r\n        return olfilter.and.apply(null, logicalArray);\r\n      case 'Or':\r\n        return olfilter.or.apply(null, logicalArray);\r\n      case 'Not':\r\n        return olfilter.not.apply(null, logicalArray);\r\n\r\n      default:\r\n        return undefined;\r\n    }\r\n  }\r\n\r\n  public defineInterfaceFilterSequence(\r\n    filterObject: any,\r\n    geometryName,\r\n    logical = '',\r\n    level = -1\r\n  ): OgcInterfaceFilterOptions[] {\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach(element => {\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            element,\r\n            geometryName,\r\n            logical,\r\n            level\r\n          )\r\n        );\r\n      });\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        level = level + 1;\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            filterObject.filters,\r\n            geometryName,\r\n            filterObject.logical,\r\n            level\r\n          )\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        this.filterSequence.push(\r\n          this.addInterfaceFilter(filterObject, geometryName, level, logical)\r\n        );\r\n      }\r\n    }\r\n    return this.filterSequence;\r\n  }\r\n\r\n  public computeAllowedOperators(\r\n    fields?: SourceFieldsOptionsParams[],\r\n    propertyName?: string,\r\n    defaultOperatorsType?: OgcFilterOperatorType ) {\r\n    let effectiveOperators: {} = {};\r\n    let allowedOperators;\r\n    if (fields && propertyName) {\r\n      const srcField = fields.find(field => field.name === propertyName);\r\n      allowedOperators = srcField && srcField.allowedOperatorsType ?\r\n        srcField.allowedOperatorsType : defaultOperatorsType;\r\n    }\r\n\r\n    allowedOperators = allowedOperators ? allowedOperators : 'basicandspatial';\r\n\r\n    switch (allowedOperators.toLowerCase()) {\r\n      case 'all':\r\n        effectiveOperators = this.operators;\r\n        break;\r\n      case 'spatial':\r\n        effectiveOperators = {\r\n          Intersects: { spatial: true, fieldRestrict: [] },\r\n          Within: { spatial: true, fieldRestrict: [] },\r\n        };\r\n        break;\r\n      case 'basicandspatial':\r\n        effectiveOperators = {\r\n          PropertyIsEqualTo: { spatial: false, fieldRestrict: [] },\r\n          PropertyIsNotEqualTo: { spatial: false, fieldRestrict: [] },\r\n          Intersects: { spatial: true, fieldRestrict: [] },\r\n          Within: { spatial: true, fieldRestrict: [] },\r\n        };\r\n        break;\r\n      case 'basic':\r\n        effectiveOperators = {\r\n          PropertyIsEqualTo: { spatial: false, fieldRestrict: [] },\r\n          PropertyIsNotEqualTo: { spatial: false, fieldRestrict: [] }\r\n        };\r\n        break;\r\n        case 'time':\r\n          effectiveOperators = {\r\n            During: { spatial: false, fieldRestrict: [] },\r\n          };\r\n          break;\r\n      case 'basicnumeric':\r\n        effectiveOperators = {\r\n          PropertyIsEqualTo: { spatial: false, fieldRestrict: [] },\r\n          PropertyIsNotEqualTo: { spatial: false, fieldRestrict: [] },\r\n          PropertyIsGreaterThan: { spatial: false, fieldRestrict: ['number'] },\r\n          PropertyIsGreaterThanOrEqualTo: { spatial: false, fieldRestrict: ['number'] },\r\n          PropertyIsLessThan: { spatial: false, fieldRestrict: ['number'] },\r\n          PropertyIsLessThanOrEqualTo: { spatial: false, fieldRestrict: ['number'] },\r\n        };\r\n        break;\r\n      default:\r\n        effectiveOperators = {\r\n          PropertyIsEqualTo: { spatial: false, fieldRestrict: [] },\r\n          PropertyIsNotEqualTo: { spatial: false, fieldRestrict: [] },\r\n          Intersects: { spatial: true, fieldRestrict: [] },\r\n          Within: { spatial: true, fieldRestrict: [] },\r\n        };\r\n    }\r\n\r\n    return effectiveOperators;\r\n  }\r\n\r\n  public addInterfaceFilter(\r\n    igoOgcFilterObject?,\r\n    geometryName?,\r\n    level = 0,\r\n    parentLogical = 'Or'\r\n  ): OgcInterfaceFilterOptions {\r\n    if (!igoOgcFilterObject) {\r\n      igoOgcFilterObject = { operator: 'PropertyIsEqualTo' };\r\n    }\r\n    const f = {\r\n      propertyName: '',\r\n      operator: '',\r\n      active: '',\r\n      filterid: uuid(),\r\n      begin: '',\r\n      end: '',\r\n      lowerBoundary: '',\r\n      upperBoundary: '',\r\n      expression: '',\r\n      pattern: '',\r\n      wildCard: '*',\r\n      singleChar: '.',\r\n      escapeChar: '!',\r\n      matchCase: true,\r\n      igoSpatialSelector: '',\r\n      geometryName: '',\r\n      geometry: '',\r\n      wkt_geometry: '',\r\n      extent: '',\r\n      srsName: '',\r\n      parentLogical: '',\r\n      level: 0\r\n    };\r\n\r\n    return Object.assign(\r\n      f,\r\n      {\r\n        parentLogical,\r\n        level,\r\n        geometryName\r\n      },\r\n      igoOgcFilterObject\r\n    );\r\n  }\r\n\r\n  public checkIgoFiltersProperties(\r\n    filterObject: any,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterArray = [];\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach(element => {\r\n        filterArray.push(\r\n          this.checkIgoFiltersProperties(element, fieldNameGeometry, proj, active)\r\n        );\r\n      });\r\n      return filterArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return Object.assign(\r\n          {},\r\n          {\r\n            logical: filterObject.logical,\r\n            filters: this.checkIgoFiltersProperties(\r\n              filterObject.filters,\r\n              fieldNameGeometry,\r\n              proj,\r\n              active\r\n            )\r\n          }\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.addFilterProperties(\r\n          filterObject as OgcInterfaceFilterOptions,\r\n          fieldNameGeometry,\r\n          proj,\r\n          active\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private addFilterProperties(\r\n    igoOgcFilterObject: OgcInterfaceFilterOptions,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterid = igoOgcFilterObject.hasOwnProperty('filterid')\r\n      ? igoOgcFilterObject.filterid\r\n      : uuid();\r\n    const status = igoOgcFilterObject.hasOwnProperty('active')\r\n      ? igoOgcFilterObject.active\r\n      : active;\r\n\r\n    const srsName = igoOgcFilterObject.hasOwnProperty('srsName')\r\n      ? igoOgcFilterObject.srsName\r\n      : proj ? proj.getCode() : 'EPSG:3857';\r\n\r\n    return Object.assign(\r\n      {},\r\n      {\r\n        filterid,\r\n        active: status,\r\n        igoSpatialSelector: 'fixedExtent',\r\n        srsName\r\n      },\r\n      igoOgcFilterObject,\r\n      { geometryName: fieldNameGeometry }\r\n    );\r\n  }\r\n\r\n  public rebuiltIgoOgcFilterObjectFromSequence(\r\n    sequence: OgcInterfaceFilterOptions[]\r\n  ): IgoOgcFilterObject {\r\n    if (sequence instanceof Array) {\r\n      if (sequence.length >= 1) {\r\n        let lastParentLogical = sequence[0].parentLogical;\r\n        let nextElement: any;\r\n        let logicalArray = [];\r\n        let lastProcessedFilter;\r\n        sequence.forEach(uiFilter => {\r\n          const element = Object.assign({}, uiFilter);\r\n          const index = sequence.indexOf(uiFilter);\r\n          if (index >= 0 && index < sequence.length - 1) {\r\n            nextElement = sequence[index + 1];\r\n          } else {\r\n            nextElement = element;\r\n          }\r\n          delete element.active;\r\n          delete element.filterid;\r\n          delete element.parentLogical;\r\n          logicalArray.push(element);\r\n\r\n          if (sequence.length === 1) {\r\n            lastProcessedFilter = element;\r\n          } else if (lastParentLogical !== nextElement.parentLogical) {\r\n            if (logicalArray.length === 1) {\r\n              console.log(\r\n                'You must set at ' +\r\n                  'least two operator in a logical (' +\r\n                  lastParentLogical +\r\n                  ')'\r\n              );\r\n            } else {\r\n              lastProcessedFilter = Object.assign(\r\n                {},\r\n                { logical: lastParentLogical, filters: logicalArray }\r\n              );\r\n              logicalArray = [lastProcessedFilter];\r\n              lastParentLogical = nextElement.parentLogical;\r\n            }\r\n          }\r\n        });\r\n        return lastProcessedFilter;\r\n      } else {\r\n        return undefined;\r\n      }\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  private computeIgoPushButton(pushButtons: IgoPushButton): IgoPushButton {\r\n    if (pushButtons.groups.every(group => group.computedButtons !== undefined)) {\r\n      return pushButtons;\r\n    }\r\n    let pb: IgoPushButton;\r\n    if (pushButtons.groups && pushButtons.bundles) {\r\n      if (!pushButtons.bundles.every(bundle => bundle.id !== undefined)) {\r\n        throw new Error('You must set an id for each of your pushButtons bundles');\r\n      }\r\n      pb = ObjectUtils.copyDeep(pushButtons);\r\n      pb.groups.forEach(group => {\r\n        group.title = group.title ? group.title : group.name;\r\n        group.enabled = group.enabled ? group.enabled : false;\r\n        group.computedButtons = ObjectUtils.copyDeep(pb.bundles.filter(b => group.ids.includes(b.id)));\r\n      });\r\n    } else if (!pushButtons.groups && pushButtons.bundles) {\r\n      pb = ObjectUtils.copyDeep(pushButtons);\r\n      pb.groups = [{ title: 'group1', name: 'group1', computedButtons: ObjectUtils.copyDeep(pb.bundles) } as PushButtonGroup];\r\n    } else {\r\n      pb = {\r\n        bundles: pushButtons as OgcPushButtonBundle[],\r\n        groups: [\r\n          {\r\n            title: 'group1', name: 'group1',\r\n            computedButtons: ObjectUtils.copyDeep(pushButtons) as OgcPushButtonBundle[]\r\n          } as PushButtonGroup]\r\n      };\r\n    }\r\n    if (!pb.groups.find(pbGroup => pbGroup.enabled)) {\r\n      pb.groups[0].enabled = true;\r\n    }\r\n    return pb;\r\n  }\r\n\r\n  public handleOgcFiltersAppliedValue(\r\n    options: OgcFilterableDataSourceOptions,\r\n    fieldNameGeometry: string,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection): string {\r\n    const ogcFilters = options.ogcFilters;\r\n    if (!ogcFilters) {\r\n      return;\r\n    }\r\n    let filterQueryStringPushButton = '';\r\n    let filterQueryStringAdvancedFilters = '';\r\n    if (ogcFilters.enabled && ogcFilters.pushButtons) {\r\n      ogcFilters.pushButtons = this.computeIgoPushButton(ogcFilters.pushButtons);\r\n      const pushButtonBundle = ogcFilters.pushButtons.groups.find(g => g.enabled).computedButtons;\r\n      const conditions = [];\r\n      pushButtonBundle.map(buttonBundle => {\r\n        const bundleCondition = [];\r\n        buttonBundle.buttons\r\n          .filter(ogcpb => ogcpb.enabled === true)\r\n          .forEach(enabledPb => bundleCondition.push(enabledPb.filters));\r\n        if (bundleCondition.length === 1) {\r\n          conditions.push(bundleCondition[0]);\r\n        } else if (bundleCondition.length > 1) {\r\n          conditions.push({ logical: buttonBundle.logical, filters: bundleCondition });\r\n        }\r\n      });\r\n      if (conditions.length >= 1) {\r\n        filterQueryStringPushButton = this.buildFilter(\r\n            conditions.length === 1 ? conditions[0] : { logical: 'And', filters: conditions },\r\n            extent,\r\n            proj,\r\n            ogcFilters.geometryName\r\n          );\r\n      }\r\n    }\r\n\r\n    if (ogcFilters.enabled && ogcFilters.filters) {\r\n      ogcFilters.geometryName = ogcFilters.geometryName || fieldNameGeometry;\r\n      const igoFilters = ogcFilters.filters;\r\n      filterQueryStringAdvancedFilters = this.buildFilter(igoFilters, extent, proj, ogcFilters.geometryName);\r\n    }\r\n\r\n    let filterQueryString = ogcFilters.advancedOgcFilters ? filterQueryStringAdvancedFilters : filterQueryStringPushButton;\r\n    if (options.type === 'wms') {\r\n      filterQueryString = this.formatProcessedOgcFilter(filterQueryString, (options as any).params.LAYERS);\r\n    }\r\n    if (options.type === 'wfs') {\r\n      filterQueryString = this.formatProcessedOgcFilter(filterQueryString, (options as any).params.featureTypes);\r\n    }\r\n\r\n    return filterQueryString;\r\n\r\n  }\r\n\r\n  public formatProcessedOgcFilter(\r\n    processedFilter: string,\r\n    layersOrTypenames: string): string {\r\n    let appliedFilter = '';\r\n    if (processedFilter.length === 0 && layersOrTypenames.indexOf(',') === -1) {\r\n      appliedFilter = processedFilter;\r\n    } else {\r\n      layersOrTypenames.split(',').forEach(layerOrTypenames => {\r\n        appliedFilter = `${appliedFilter}(${processedFilter.replace('filter=', '')})`;\r\n      });\r\n    }\r\n    appliedFilter = appliedFilter.replace(/\\(\\)/g, '');\r\n    const filterValue = appliedFilter.length > 0 ? appliedFilter.replace('filter=', '') : undefined;\r\n    return filterValue;\r\n  }\r\n}\r\n","import { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport * as OlFormat from 'ol/format';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatGML32 from 'ol/format/GML32';\r\nimport olFormatOSMXML from 'ol/format/OSMXML';\r\n\r\nexport const defaultEpsg = 'EPSG:3857';\r\nexport const defaultMaxFeatures = 5000;\r\nexport const defaultWfsVersion = '2.0.0';\r\nexport const defaultFieldNameGeometry = 'geometry';\r\nexport const gmlRegex = new RegExp(/(.*)?gml(.*)?/gi);\r\nexport const jsonRegex = new RegExp(/(.*)?json(.*)?/gi);\r\n\r\n/**\r\n * This method build/standardize WFS call query params based on the layer property.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @param count  Number: Used to control the number of feature. Used to bypass whe wfs datasource options interface (maxFeatures)\r\n * @param epsg  String: Used to control the EPSG code (es: 'EPSG3857'). Used to bypass whe wfs datasource options interface (srsName)\r\n * @param properties  String: Used to control the queried fields  (WFS service).\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function formatWFSQueryString(\r\n  dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n  count?: number,\r\n  epsg?: string,\r\n  properties?: string\r\n): { name: string; value: string }[] {\r\n  const versionWfs200 = '2.0.0'; // not the same usage as defaultWfsVersion.\r\n  const url = dataSourceOptions.urlWfs;\r\n  const paramsWFS = dataSourceOptions.paramsWFS;\r\n  const effectiveCount = count || defaultMaxFeatures;\r\n  const epsgCode = epsg || defaultEpsg;\r\n  const outputFormat = paramsWFS.outputFormat\r\n    ? `outputFormat=${paramsWFS.outputFormat}`\r\n    : '';\r\n  const version = paramsWFS.version\r\n    ? `version=${paramsWFS.version}`\r\n    : `version=${defaultWfsVersion}`;\r\n  const paramTypename =\r\n    paramsWFS.version === versionWfs200 ? 'typenames' : 'typename';\r\n  const featureTypes = `${paramTypename}=${paramsWFS.featureTypes}`;\r\n  const paramMaxFeatures =\r\n    paramsWFS.version === versionWfs200 ? 'count' : 'maxFeatures';\r\n  const cnt = count\r\n    ? `${paramMaxFeatures}=${effectiveCount}`\r\n    : paramsWFS.maxFeatures\r\n    ? `${paramMaxFeatures}=${paramsWFS.maxFeatures}`\r\n    : `${paramMaxFeatures}=${effectiveCount}`;\r\n  const srs = epsg\r\n    ? `srsname=${epsgCode}`\r\n    : paramsWFS.srsName\r\n    ? 'srsname=' + paramsWFS.srsName\r\n    : `srsname=${epsgCode}`;\r\n\r\n  let propertyName = '';\r\n  let valueReference = '';\r\n  if (properties) {\r\n    propertyName = `propertyName=${properties}`;\r\n    valueReference = `valueReference=${properties}`;\r\n  }\r\n  const sourceFields = dataSourceOptions.sourceFields;\r\n  if (!propertyName && sourceFields && sourceFields.length > 0) {\r\n    const fieldsNames = [];\r\n    dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n      fieldsNames.push(sourcefield.name);\r\n    });\r\n    propertyName = `propertyName=${fieldsNames.join(',')},${\r\n      paramsWFS.fieldNameGeometry\r\n    }`;\r\n  }\r\n\r\n  const getCapabilities = `${url}?service=WFS&request=GetCapabilities&${version}`;\r\n  let getFeature = `${url}?service=WFS&request=GetFeature&${version}&${featureTypes}&`;\r\n  getFeature += `${outputFormat}&${srs}&${cnt}&${propertyName}`;\r\n\r\n  let getpropertyvalue = `${url}?service=WFS&request=GetPropertyValue&version=${versionWfs200}&${featureTypes}&`;\r\n  getpropertyvalue += `&${cnt}&${valueReference}`;\r\n\r\n  return [\r\n    { name: 'outputformat', value: outputFormat },\r\n    { name: 'version', value: version },\r\n    { name: 'typename', value: featureTypes },\r\n    { name: 'count', value: cnt },\r\n    { name: 'srsname', value: srs },\r\n    { name: 'propertyname', value: propertyName },\r\n    { name: 'valuereference', value: valueReference },\r\n    { name: 'getcapabilities', value: getCapabilities.replace(/&&/g, '&') },\r\n    { name: 'getfeature', value: getFeature.replace(/&&/g, '&') },\r\n    { name: 'getpropertyvalue', value: getpropertyvalue.replace(/&&/g, '&') }\r\n  ];\r\n}\r\n\r\n/**\r\n * Validate/Modify layer's wfs options based on :\r\n * 1- an Openlayers's issue with GML provided from WFS. Refer to\r\n * https://github.com/openlayers/openlayers/pull/6400\r\n * 2- Set default values for optionals parameters.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function checkWfsParams(wfsDataSourceOptions, srcType?: string) {\r\n  if (srcType && srcType === 'wfs') {\r\n    // reassignation of params to paramsWFS and url to urlWFS to have a common interface with wms-wfs datasources\r\n    wfsDataSourceOptions.paramsWFS = wfsDataSourceOptions.params;\r\n  }\r\n\r\n  const paramsWFS = wfsDataSourceOptions.paramsWFS;\r\n  wfsDataSourceOptions.urlWfs =\r\n    wfsDataSourceOptions.urlWfs || wfsDataSourceOptions.url;\r\n\r\n  paramsWFS.version = paramsWFS.version || defaultWfsVersion;\r\n  paramsWFS.fieldNameGeometry =\r\n    paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n  paramsWFS.maxFeatures = paramsWFS.maxFeatures || defaultMaxFeatures;\r\n\r\n  let outputFormat;\r\n  if (paramsWFS.outputFormat) {\r\n    outputFormat = paramsWFS.outputFormat;\r\n  }\r\n\r\n  if (gmlRegex.test(outputFormat) || !outputFormat) {\r\n    paramsWFS.version = '1.1.0';\r\n  }\r\n  return Object.assign({}, wfsDataSourceOptions);\r\n}\r\n\r\nexport function getFormatFromOptions(\r\n  options: WFSDataSourceOptions | WMSDataSourceOptions\r\n) {\r\n  const wfsOptions = options as WFSDataSourceOptions;\r\n\r\n  let olFormatCls = OlFormat.WFS;\r\n  const outputFormat = wfsOptions.paramsWFS.outputFormat\r\n    ? wfsOptions.paramsWFS.outputFormat\r\n    : undefined;\r\n\r\n  if (!outputFormat) {\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  if (OlFormat[outputFormat]) {\r\n    olFormatCls = OlFormat[outputFormat];\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gml2')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ...{ gmlFormat: olFormatGML2 }});\r\n  } else if (outputFormat.toLowerCase().match('gml32')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ...{ gmlFormat: olFormatGML32 }});\r\n  } else if (outputFormat.toLowerCase().match('gml3')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ...{ gmlFormat: olFormatGML3 }});\r\n  } else if (outputFormat.toLowerCase().match('topojson')) {\r\n    olFormatCls = OlFormat.TopoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('geojson')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('esrijson')) {\r\n    olFormatCls = OlFormat.EsriJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('json')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gpx')) {\r\n    olFormatCls = OlFormat.GPX;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('WKT')) {\r\n    olFormatCls = OlFormat.WKT;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('osmxml')) {\r\n    olFormatCls = olFormatOSMXML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('kml')) {\r\n    olFormatCls = OlFormat.KML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  return new olFormatCls();\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as OlLoadingStrategy from 'ol/loadingstrategy';\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions, OgcFiltersOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport {\r\n  formatWFSQueryString,\r\n  defaultFieldNameGeometry,\r\n  checkWfsParams,\r\n  getFormatFromOptions\r\n} from './wms-wfs.utils';\r\n\r\nexport class WFSDataSource extends DataSource {\r\n  public ol: olSourceVector;\r\n\r\n  constructor(\r\n    public options: WFSDataSourceOptions,\r\n    protected wfsService: WFSService\r\n  ) {\r\n    super(checkWfsParams(options, 'wfs'));\r\n\r\n    const ogcFilters = (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n    const fieldNameGeometry = this.options.paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters =\r\n      ogcFilterWriter.defineOgcFiltersDefaultOptions(ogcFilters, fieldNameGeometry);\r\n    if (\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.enabled &&\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.editable\r\n    ) {\r\n      this.wfsService.getSourceFieldsFromWFS(this.options);\r\n    }\r\n  }\r\n\r\n  protected createOlSource(): olSourceVector {\r\n\r\n    return new olSourceVector({\r\n      format: getFormatFromOptions(this.options),\r\n      overlaps: false,\r\n      url: (extent, resolution, proj: olProjection) => {\r\n        this.options.paramsWFS.srsName = this.options.paramsWFS.srsName || proj.getCode();\r\n        return this.buildUrl(\r\n          extent,\r\n          proj,\r\n          (this.options as OgcFilterableDataSourceOptions).ogcFilters);\r\n      },\r\n      strategy: OlLoadingStrategy.bbox\r\n    });\r\n  }\r\n\r\n  private buildUrl(extent, proj: olProjection, ogcFilters: OgcFiltersOptions): string {\r\n    const paramsWFS = this.options.paramsWFS;\r\n    const queryStringValues = formatWFSQueryString(this.options, undefined, this.options.paramsWFS.srsName);\r\n    let igoFilters;\r\n    if (ogcFilters && ogcFilters.enabled) {\r\n      igoFilters = ogcFilters.filters;\r\n    }\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n    const filterOrBox = ogcFilterWriter.buildFilter(igoFilters, extent, proj, ogcFilters.geometryName);\r\n    let filterOrPush = ogcFilterWriter.handleOgcFiltersAppliedValue(this.options, ogcFilters.geometryName);\r\n\r\n    let prefix = 'filter';\r\n    if (!filterOrPush) {\r\n      prefix = 'bbox';\r\n      filterOrPush = extent.join(',') + ',' + proj.getCode();\r\n    }\r\n\r\n    paramsWFS.xmlFilter = ogcFilters.advancedOgcFilters ? filterOrBox : `${prefix}=${filterOrPush}`;\r\n    let baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n    const patternFilter = /(filter|bbox)=.*/gi;\r\n    baseUrl = patternFilter.test(paramsWFS.xmlFilter) ? `${baseUrl}&${paramsWFS.xmlFilter}` : baseUrl;\r\n    this.options.download = Object.assign({}, this.options.download, { dynamicUrl: baseUrl });\r\n    return baseUrl.replace(/&&/g, '&');\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport olFeature from 'ol/Feature';\r\nimport * as olformat from 'ol/format';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { DataService } from './data.service';\r\nimport { formatWFSQueryString,\r\n          gmlRegex,\r\n          defaultEpsg,\r\n          defaultMaxFeatures,\r\n          getFormatFromOptions} from './wms-wfs.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WFSService extends DataService {\r\n  constructor(private http: HttpClient) {\r\n    super();\r\n  }\r\n\r\n  getData() {\r\n    console.log('This is defining a data service.');\r\n    return 'This is defining a data service.';\r\n  }\r\n\r\n  public getSourceFieldsFromWFS(dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions) {\r\n    if (!dataSourceOptions.sourceFields || dataSourceOptions.sourceFields.length === 0 ) {\r\n      dataSourceOptions.sourceFields = [];\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields = getfeatureSourceField;\r\n      });\r\n\r\n    } else {\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n          if (sourcefield.alias === undefined) {\r\n            sourcefield.alias = sourcefield.name; // to allow only a list of sourcefield with names\r\n          }\r\n          if (sourcefield.values === undefined || sourcefield.values.length === 0) {\r\n            sourcefield.values = getfeatureSourceField.find(sf => sf.name === sourcefield.name).values;\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  private wfsGetFeature(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n    nb: number = defaultMaxFeatures,\r\n    epsgCode: string = defaultEpsg,\r\n    propertyName?: string\r\n  ): Observable<any> {\r\n    const queryStringValues = formatWFSQueryString(dataSourceOptions, nb, epsgCode, propertyName);\r\n    const baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n    const outputFormat = dataSourceOptions.paramsWFS.outputFormat;\r\n    if (gmlRegex.test(outputFormat) || !outputFormat) {\r\n      return this.http.get(baseUrl, { responseType: 'text' });\r\n    } else {\r\n      return this.http.get(baseUrl);\r\n    }\r\n  }\r\n\r\n  defineFieldAndValuefromWFS(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions\r\n  ): Observable<any> {\r\n    return new Observable(d => {\r\n      const sourceFields = [];\r\n      let fieldList;\r\n      let fieldListWoGeom;\r\n      let fieldListWoGeomStr;\r\n      let olFormats;\r\n\r\n      olFormats = getFormatFromOptions(dataSourceOptions);\r\n\r\n      this.wfsGetFeature(dataSourceOptions, 1).subscribe(oneFeature => {\r\n        const features = olFormats.readFeatures(oneFeature);\r\n        fieldList = features[0].getKeys();\r\n        fieldListWoGeom = fieldList.filter(\r\n          field =>\r\n            field !== features[0].getGeometryName() &&\r\n            !field.match(/boundedby/gi)\r\n        );\r\n        fieldListWoGeomStr = fieldListWoGeom.join(',');\r\n        this.wfsGetFeature(\r\n          dataSourceOptions,\r\n          dataSourceOptions.paramsWFS.maxFeatures || defaultMaxFeatures,\r\n          dataSourceOptions.paramsWFS.srsName,\r\n          fieldListWoGeomStr\r\n        ).subscribe(manyFeatures => {\r\n          const mfeatures = olFormats.readFeatures(manyFeatures);\r\n          this.built_properties_value(mfeatures).forEach(element => {\r\n            sourceFields.push(element);\r\n          });\r\n          d.next(sourceFields);\r\n          d.complete();\r\n        });\r\n      });\r\n\r\n    });\r\n  }\r\n\r\n  private built_properties_value(features: olFeature[]): string[] {\r\n    const kv = Object.assign({}, features[0].getProperties());\r\n    delete kv[features[0].getGeometryName()];\r\n    delete kv.boundedBy;\r\n    const sourceFields = [];\r\n    for (const property in kv) {\r\n      if (kv.hasOwnProperty(property)) {\r\n        const fieldType =\r\n          typeof features[0].get(property) === 'object'\r\n            ? undefined\r\n            : typeof features[0].get(property);\r\n        sourceFields.push({\r\n          name: property,\r\n          alias: property,\r\n          type: fieldType,\r\n          values: [kv[property]]\r\n        });\r\n      }\r\n    }\r\n    features.every((element) => {\r\n      const featureProperties = element.getProperties();\r\n      for (const key in featureProperties) {\r\n        if (featureProperties.hasOwnProperty(key) && key in kv) {\r\n          sourceFields.filter(f => f.name === key).forEach(v => {\r\n            if (v.values.indexOf(featureProperties[key]) === -1) {\r\n              v.values.push(featureProperties[key]);\r\n            }\r\n          });\r\n        }\r\n      }\r\n      return true;\r\n    });\r\n    return sourceFields;\r\n  }\r\n}\r\n","export enum QueryFormat {\r\n  GML2 = 'gml2',\r\n  GML3 = 'gml3',\r\n  JSON = 'json',\r\n  GEOJSON = 'geojson',\r\n  GEOJSON2 = 'geojson2',\r\n  ESRIJSON = 'esrijson',\r\n  TEXT = 'text',\r\n  HTML = 'html',\r\n  HTMLGML2 = 'htmlgml2'\r\n}\r\n\r\nexport enum QueryFormatMimeType {\r\n  GML2 = 'application/vnd.ogc.gml',\r\n  GML3 = 'application/vnd.ogc.gml/3.1.1',\r\n  JSON = 'application/json',\r\n  GEOJSON = 'application/geojson',\r\n  GEOJSON2 = 'geojson',\r\n  ESRIJSON = 'application/json',\r\n  TEXT = 'text/plain',\r\n  HTML = 'text/html',\r\n  HTMLGML2 = 'text/html'\r\n}\r\n\r\nexport enum QueryHtmlTarget {\r\n  IFRAME = 'iframe',\r\n  BLANK = '_blank'\r\n}\r\n","import olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\nimport {\r\n  formatWFSQueryString,\r\n  checkWfsParams,\r\n  defaultFieldNameGeometry\r\n} from './wms-wfs.utils';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nexport class WMSDataSource extends DataSource {\r\n  public ol: olSourceImageWMS;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  constructor(\r\n    public options: WMSDataSourceOptions,\r\n    protected wfsService: WFSService\r\n  ) {\r\n    super(options);\r\n    const sourceParams: any = options.params;\r\n\r\n    const dpi = sourceParams.DPI || 96;\r\n    sourceParams.DPI = dpi;\r\n    sourceParams.MAP_RESOLUTION = dpi;\r\n    sourceParams.FORMAT_OPTIONS = 'dpi:' + dpi;\r\n\r\n    if (options.refreshIntervalSec && options.refreshIntervalSec > 0) {\r\n      setInterval(() => {\r\n        this.refresh();\r\n      }, options.refreshIntervalSec * 1000); // Convert seconds to MS\r\n    }\r\n\r\n    let fieldNameGeometry = defaultFieldNameGeometry;\r\n\r\n    // ####   START if paramsWFS\r\n    if (options.paramsWFS) {\r\n      const wfsCheckup = checkWfsParams(options, 'wms');\r\n      ObjectUtils.mergeDeep(options.paramsWFS, wfsCheckup.paramsWFS);\r\n\r\n      fieldNameGeometry =\r\n        options.paramsWFS.fieldNameGeometry || fieldNameGeometry;\r\n\r\n      options.download = Object.assign({}, options.download, {\r\n        dynamicUrl: this.buildDynamicDownloadUrlFromParamsWFS(options)\r\n      });\r\n    } //  ####   END  if paramsWFS\r\n\r\n    if (!options.sourceFields || options.sourceFields.length === 0) {\r\n      options.sourceFields = [];\r\n    } else {\r\n      options.sourceFields.forEach(sourceField => {\r\n        sourceField.alias = sourceField.alias\r\n          ? sourceField.alias\r\n          : sourceField.name;\r\n        // to allow only a list of sourcefield with names\r\n      });\r\n    }\r\n    const initOgcFilters = (options as OgcFilterableDataSourceOptions)\r\n      .ogcFilters;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (!initOgcFilters) {\r\n      (options as OgcFilterableDataSourceOptions).ogcFilters = ogcFilterWriter.defineOgcFiltersDefaultOptions(\r\n        initOgcFilters,\r\n        fieldNameGeometry,\r\n        'wms'\r\n      );\r\n    } else {\r\n      initOgcFilters.advancedOgcFilters = initOgcFilters.pushButtons\r\n        ? false\r\n        : true;\r\n    }\r\n\r\n    if (\r\n      sourceParams.LAYERS.split(',').length > 1 &&\r\n      initOgcFilters &&\r\n      initOgcFilters.enabled\r\n    ) {\r\n      console.log('*******************************');\r\n      console.log(\r\n        'BE CAREFULL, YOUR WMS LAYERS (' +\r\n          sourceParams.LAYERS +\r\n          ') MUST SHARE THE SAME FIELDS TO ALLOW ogcFilters TO WORK !! '\r\n      );\r\n      console.log('*******************************');\r\n    }\r\n\r\n    if (options.paramsWFS && initOgcFilters && initOgcFilters.enabled && initOgcFilters.editable) {\r\n      this.wfsService.getSourceFieldsFromWFS(options);\r\n    }\r\n\r\n    const filterQueryString = ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n      options,\r\n      fieldNameGeometry\r\n    );\r\n    sourceParams.FILTER = filterQueryString;\r\n  }\r\n\r\n  refresh() {\r\n    this.ol.updateParams({ igoRefresh: Math.random() });\r\n  }\r\n\r\n  private buildDynamicDownloadUrlFromParamsWFS(asWFSDataSourceOptions) {\r\n    const queryStringValues = formatWFSQueryString(asWFSDataSourceOptions);\r\n    const downloadUrl = queryStringValues.find(f => f.name === 'getfeature')\r\n      .value;\r\n    return downloadUrl;\r\n  }\r\n\r\n  protected createOlSource(): olSourceImageWMS {\r\n    return new olSourceImageWMS(this.options);\r\n  }\r\n\r\n  getLegend(style?: string, scale?: number): Legend[] {\r\n    let legend = super.getLegend();\r\n    if (legend.length > 0 && (style === undefined && !scale)) {\r\n      return legend;\r\n    }\r\n\r\n    const sourceParams = this.params;\r\n\r\n    let layers = [];\r\n    if (sourceParams.LAYERS !== undefined) {\r\n      layers = sourceParams.LAYERS.split(',');\r\n    }\r\n\r\n    const baseUrl = this.options.url.replace(/\\?$/, '');\r\n    const params = [\r\n      'REQUEST=GetLegendGraphic',\r\n      'SERVICE=WMS',\r\n      'FORMAT=image/png',\r\n      'SLD_VERSION=1.1.0',\r\n      `VERSION=${sourceParams.VERSION || '1.3.0'}`\r\n    ];\r\n    if (style !== undefined) {\r\n      params.push(`STYLE=${style}`);\r\n    }\r\n    if (scale !== undefined) {\r\n      params.push(`SCALE=${scale}`);\r\n    }\r\n\r\n    legend = layers.map((layer: string) => {\r\n      const separator = baseUrl.match(/\\?/) ? '&' : '?';\r\n      return {\r\n        url: `${baseUrl}${separator}${params.join('&')}&LAYER=${layer}`,\r\n        title: layers.length > 1 ? layer : undefined,\r\n        currentStyle: style === undefined ? undefined : style as string\r\n      };\r\n    });\r\n\r\n    return legend;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olTileGridWMTS from 'ol/tilegrid/WMTS';\r\nimport * as olproj from 'ol/proj';\r\nimport {\r\n  getTopLeft as extentGetTopLeft,\r\n  getWidth as extentGetWidth\r\n} from 'ol/extent.js';\r\n\r\nexport function createDefaultTileGrid(epsg?: string): olTileGridWMTS {\r\n  const projection = epsg ? olproj.get(epsg) : olproj.get('EPSG:3857');\r\n  const projectionExtent = projection.getExtent();\r\n  const size = extentGetWidth(projectionExtent) / 256;\r\n  const resolutions = new Array(20);\r\n  const matrixIds = new Array(20);\r\n  for (let z = 0; z < 20; ++z) {\r\n    resolutions[z] = size / Math.pow(2, z);\r\n    matrixIds[z] = z;\r\n  }\r\n\r\n  return new olTileGridWMTS({\r\n    origin: extentGetTopLeft(projectionExtent),\r\n    resolutions,\r\n    matrixIds\r\n  });\r\n}\r\n","import olSourceWMTS from 'ol/source/WMTS';\r\n\r\nimport { createDefaultTileGrid } from '../../utils/tilegrid';\r\nimport { DataSource } from './datasource';\r\nimport { WMTSDataSourceOptions } from './wmts-datasource.interface';\r\n\r\nexport class WMTSDataSource extends DataSource {\r\n  public options: WMTSDataSourceOptions;\r\n  public ol: olSourceWMTS;\r\n\r\n  constructor(options: WMTSDataSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  protected createOlSource(): olSourceWMTS {\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        tileGrid: createDefaultTileGrid(this.options.projection as string)\r\n      },\r\n      this.options\r\n    );\r\n\r\n    return new olSourceWMTS(sourceOptions);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import olSourceCarto from 'ol/source/CartoDB';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { CartoDataSourceOptions } from './carto-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class CartoDataSource extends DataSource {\r\n  public ol: olSourceCarto;\r\n  public options: CartoDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceCarto {\r\n    const crossOrigin = this.options.crossOrigin\r\n      ? this.options.crossOrigin\r\n      : 'anonymous';\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        crossOrigin\r\n      },\r\n      this.options\r\n    );\r\n    return new olSourceCarto(sourceOptions);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legend = super.getLegend();\r\n    if (legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    let htmlString = '<table>';\r\n    if (this.options.config.layers[0].legend != null) {\r\n      this.options.config.layers[0].legend.items.forEach(f => {\r\n        if (f.visible === true) {\r\n          htmlString +=\r\n            '<tr><td>' +\r\n            '<p><font size=\"5\" color=\"' +\r\n            f.value +\r\n            '\"> &#9679</font></p></td>' +\r\n            '<td>' +\r\n            f.name +\r\n            '</td></tr>';\r\n        }\r\n      });\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    } else {\r\n      // Try to build the legend from the cartocss options\r\n      const layerOptions = this.options.config.layers[0].options;\r\n      // All available cartocss style options\r\n      const types = [\r\n        'polygon-fill:',\r\n        'marker-fill:',\r\n        'shield-fill:',\r\n        'building-fill:',\r\n        'line-color:'\r\n      ];\r\n      for (const oneType of types) {\r\n        if (layerOptions.cartocss.includes(oneType)) {\r\n          const type = layerOptions.cartocss.split(oneType).pop();\r\n          const color = type.substr(0, type.indexOf(';'));\r\n          if (color.includes('ramp')) {\r\n            const colors = color.split(', (')[1].split(',');\r\n            const data = color.split(', (')[2].split(',');\r\n            for (let j = 0; j < colors.length; j++) {\r\n              colors[j] = colors[j].replace(/(\"|\\))/g, '');\r\n              data[j] = data[j].replace(/(\"|\\))/g, '');\r\n              if (data[j].replace(/\\s+/g, '') === '=') {\r\n                data[j] = 'Autres';\r\n              }\r\n              htmlString +=\r\n                '<tr><td>' +\r\n                '<p><font size=\"5\" color=\"' +\r\n                colors[j] +\r\n                '\"> &#9679</font></p></td>' +\r\n                '<td>' +\r\n                data[j] +\r\n                '</td></tr>';\r\n            }\r\n            break;\r\n          } else {\r\n            const title = layerOptions.layer_name\r\n              ? layerOptions.layer_name\r\n              : '';\r\n            htmlString +=\r\n              '<tr><td>' +\r\n              '<p><font size=\"5\" color=\"' +\r\n              color +\r\n              '\"> &#9679</font></p>' +\r\n              '</td><td>' +\r\n              title +\r\n              '</td></tr>';\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    }\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport * as olloadingstrategy from 'ol/loadingstrategy';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { ArcGISRestDataSourceOptions } from './arcgisrest-datasource.interface';\r\n\r\nexport class ArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceVector;\r\n  public options: ArcGISRestDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector {\r\n    const esrijsonFormat = new olFormatEsriJSON();\r\n    return new olSourceVector({\r\n      attributions: this.options.params.attributions,\r\n      overlaps: false,\r\n      format: esrijsonFormat,\r\n      url: function(extent, resolution, proj) {\r\n        const baseUrl = this.options.url + '/' + this.options.layer + '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        if (this.options.params.timeFilter) {\r\n          const time = `time=${this.options.params.timeExtent}`;\r\n          params.push(time);\r\n        }\r\n        if (this.options.params.customParams) {\r\n          this.options.params.customParams.forEach(element => {\r\n            params.push(element);\r\n          });\r\n        }\r\n        return `${baseUrl}?${params.join('&')}`;\r\n      }.bind(this),\r\n      strategy: olloadingstrategy.bbox\r\n    });\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.params.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    const id = parseInt(this.options.layer, 10);\r\n    const lyr = legendInfo.layers[id];\r\n    let htmlString = '<table><tr><td>' + lyr.layerName + '</td></tr>';\r\n\r\n    for (const lyrLegend of lyr.legend) {\r\n      const modifiedUrl = this.options.url.replace(\r\n        'FeatureServer',\r\n        'MapServer'\r\n      );\r\n      const src = `${modifiedUrl}/${lyr.layerId}/images/${lyrLegend.url}`;\r\n      const label = lyrLegend.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td>` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceTileArcGISRest from 'ol/source/TileArcGISRest';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { TileArcGISRestDataSourceOptions } from './tilearcgisrest-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class TileArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceTileArcGISRest;\r\n  public options: TileArcGISRestDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceTileArcGISRest {\r\n    return new olSourceTileArcGISRest(this.options);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legend = super.getLegend();\r\n    if (this.options.legendInfo === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    const id = parseInt(this.options.layer, 10);\r\n    const lyr = this.options.legendInfo.layers[id];\r\n    let htmlString = '<table><tr><td>' + lyr.layerName + '</td></tr>';\r\n\r\n    for (const lyrLegend of lyr.legend) {\r\n      const src = `${this.options.url}/${lyr.layerId}/images/${\r\n        lyrLegend.url\r\n      }`;\r\n      const label = lyrLegend.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td>` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as olformat from 'ol/format';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { easeOut } from 'ol/easing';\r\nimport { Circle as CircleStyle, Fill, Stroke, Style } from 'ol/style';\r\n\r\nimport { Md5 } from 'ts-md5';\r\n\r\nimport { uuid } from '@igo2/utils';\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { WebSocketDataSourceOptions } from './websocket-datasource.interface';\r\n\r\nexport class WebSocketDataSource extends FeatureDataSource {\r\n  public ws: WebSocket;\r\n  public options: WebSocketDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector {\r\n    this.createWebSocket();\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    return super.createOlSource();\r\n  }\r\n\r\n  private createWebSocket() {\r\n    this.ws = new WebSocket(this.options.url);\r\n    this.ws.onmessage = this.onMessage.bind(this);\r\n\r\n    if (this.options.onclose) {\r\n      this.ws.onclose = this.onClose.bind(this);\r\n    }\r\n\r\n    if (this.options.onerror) {\r\n      this.ws.onerror = this.onError.bind(this);\r\n    }\r\n\r\n    if (this.options.onopen) {\r\n      this.ws.onopen = this.onOpen.bind(this);\r\n    }\r\n  }\r\n\r\n  onMessage(event) {\r\n    const featureAdded = this.options.format.readFeature(event.data);\r\n\r\n    switch (this.options.onmessage) {\r\n      case 'update':\r\n        // ol don't add if same ID\r\n        const featureToRemove = this.ol.getFeatureById(featureAdded.getId());\r\n        if (featureToRemove) {\r\n          this.ol.removeFeature(featureToRemove);\r\n        }\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'delete':\r\n        this.ol.clear(true);\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'add':\r\n      default:\r\n        this.ol.addFeature(featureAdded);\r\n    }\r\n  }\r\n\r\n  onClose(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onError(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onOpen(event) {\r\n    // thrown message to user ?\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.ws.close();\r\n  }\r\n}\r\n","import { Md5 } from 'ts-md5';\r\nimport feature from 'ol/Feature';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\nimport olFormatMVT from 'ol/format/MVT';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { MVTDataSourceOptions } from './mvt-datasource.interface';\r\n\r\nexport class MVTDataSource extends DataSource {\r\n  public options: MVTDataSourceOptions;\r\n  public ol: olSourceVectorTile;\r\n\r\n  protected createOlSource(): olSourceVectorTile {\r\n    let mvtFormat;\r\n    if (this.options.featureClass === 'feature') {\r\n      mvtFormat = new olFormatMVT({featureClass: feature});\r\n    } else if (this.options.featureClass === undefined) {\r\n      mvtFormat = new olFormatMVT();\r\n    }\r\n    this.options.format = mvtFormat;\r\n    return new olSourceVectorTile(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    if (!this.options.url) {\r\n        return uuid();\r\n    }\r\n    const chain = 'mvt' + this.options.url;\r\n    return Md5.hashStr(chain) as string;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceCluster from 'ol/source/Cluster';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { ClusterDataSourceOptions } from './cluster-datasource.interface';\r\n\r\nexport class ClusterDataSource extends FeatureDataSource {\r\n  public options: ClusterDataSourceOptions;\r\n  public ol: olSourceCluster;\r\n\r\n  protected createOlSource(): olSourceCluster {\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    this.options.source = super.createOlSource();\r\n    return new olSourceCluster(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    return uuid();\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","export const FEATURE = 'Feature';\r\n\r\nexport enum FeatureMotion {\r\n  None,\r\n  Move,\r\n  Zoom,\r\n  Default\r\n}\r\n","export const LAYER = 'Layer';\r\n","import * as olproj from 'ol/proj';\r\nimport { MapBrowserPointerEvent as OlMapBrowserPointerEvent } from 'ol/MapBrowserEvent';\r\nimport { MAC } from 'ol/has';\r\n\r\nimport { MapViewState } from './map.interface';\r\nimport proj4 from 'proj4';\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * This method extracts a coordinate tuple from a string.\r\n * @param str Any string\r\n * @param mapProjection string Map Projection\r\n * @param opts.forceNA boolean Force North America Zone\r\n * @returns object:\r\n *             lonLat: Coordinate,\r\n *             message: Message of error,\r\n *             radius: radius of the confience of coordinate,\r\n *             conf: confidence of the coordinate}\r\n */\r\nexport function stringToLonLat(\r\n  str: string,\r\n  mapProjection: string,\r\n  opts: { forceNA?: boolean } = {}\r\n): {\r\n  lonLat: [number, number] | undefined;\r\n  message: string;\r\n  radius: number | undefined;\r\n  conf: number | undefined;\r\n} {\r\n  let lonLat: [number, number];\r\n  let coordStr: string;\r\n  let negativeLon: string;\r\n  let degreesLon: string;\r\n  let minutesLon: string;\r\n  let secondsLon: string;\r\n  let directionLon: string;\r\n  let decimalLon: string;\r\n  let negativeLat: string;\r\n  let degreesLat: string;\r\n  let minutesLat: string;\r\n  let secondsLat: string;\r\n  let directionLat: string;\r\n  let decimalLat: string;\r\n  let zone: string;\r\n  let radius: string;\r\n  let conf: string;\r\n  let lon: any;\r\n  let lat: any;\r\n\r\n  const projectionPattern = '(\\\\s*;\\\\s*[\\\\d]{4,6})';\r\n  const toProjection = '4326';\r\n  let projectionStr: string;\r\n  const projectionRegex = new RegExp(projectionPattern, 'g');\r\n\r\n  const lonlatCoord = '([-+])?([\\\\d]{1,3})([,.](\\\\d+))?';\r\n  const lonLatPattern = `${lonlatCoord}[\\\\s,]+${lonlatCoord}`;\r\n  const lonLatRegex = new RegExp(`^${lonLatPattern}$`, 'g');\r\n\r\n  const dmsCoord =\r\n    '([0-9]{1,2})[:|]?\\\\s*([0-9]{1,2})?[:|\\'||]?\\\\s*([0-9]{1,2}(?:.[0-9]+){0,1})?\\\\s*[\"||]?\\\\s*';\r\n  const dmsCoordPattern = `${dmsCoord}([N|S|E|W|O]),?\\\\s*${dmsCoord}([N|S|E|W|O])`;\r\n  const dmsRegex = new RegExp(`^${dmsCoordPattern}`, 'gi');\r\n\r\n  const patternUtm =\r\n    '(UTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const utmRegex = new RegExp(`^${patternUtm}`, 'gi');\r\n\r\n  const patternMtm =\r\n    '(MTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const mtmRegex = new RegExp(`^${patternMtm}`, 'gi');\r\n\r\n  const ddCoord = '([-+])?(\\\\d{1,3})[,.](\\\\d+)';\r\n  const patternDd = `${ddCoord}\\\\s*[,]?\\\\s*${ddCoord}`;\r\n  const ddRegex = new RegExp(`^${patternDd}`, 'g');\r\n\r\n  const dmdCoord =\r\n    '([-+])?(\\\\d{1,3})[\\\\s,.]{1}(\\\\d{1,2})[\\\\s,.]{1}(\\\\d{1,2})[.,]?(\\\\d{1,5})?';\r\n  const patternDmd = `${dmdCoord}\\\\s*[,.]?\\\\s*${dmdCoord}`;\r\n  const dmdRegex = new RegExp(`^${patternDmd}`, 'g');\r\n\r\n  // tslint:disable:max-line-length\r\n  const patternBELL =\r\n    'LAT\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,2})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*LONG\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,3})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*UNC\\\\s*[\\\\s:]?\\\\s*(\\\\d+)\\\\s*CONF\\\\s*[\\\\s:]?\\\\s*(\\\\d{1,3})';\r\n  const bellRegex = new RegExp(`^${patternBELL}?`, 'gi');\r\n\r\n  const mmCoord = '([-+]?\\\\d+)[,.]?(\\\\d+)?';\r\n  const mmPattern = `${mmCoord}[\\\\s,]+${mmCoord}`;\r\n  const mmRegex = new RegExp(`^${mmPattern}$`, 'g');\r\n\r\n  let isXYCoords = false;\r\n\r\n  str = str.toLocaleUpperCase().trim();\r\n\r\n  // Extract projection\r\n  if (projectionRegex.test(str)) {\r\n    [coordStr, projectionStr] = str.split(';').map(s => s.trim());\r\n  } else {\r\n    coordStr = str;\r\n  }\r\n  if (lonLatRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      lon,\r\n      ,\r\n      decimalLon,\r\n      negativeLat,\r\n      lat,\r\n      ,\r\n      decimalLat\r\n    ] = coordStr.match(lonLatPattern);\r\n\r\n    lon = parseFloat((negativeLon ? negativeLon : '') + lon + '.' + decimalLon);\r\n    lat = parseFloat((negativeLat ? negativeLat : '') + lat + '.' + decimalLat);\r\n  } else if (dmsRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      directionLon,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      directionLat\r\n    ] = coordStr.match(dmsCoordPattern);\r\n\r\n    if (directionLon === 'S' || directionLon === 'N') {\r\n      degreesLon = [degreesLat, (degreesLat = degreesLon)][0];\r\n      minutesLon = [minutesLat, (minutesLat = minutesLon)][0];\r\n      secondsLon = [secondsLat, (secondsLat = secondsLon)][0];\r\n      directionLon = [directionLat, (directionLat = directionLon)][0];\r\n    }\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat(degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat(degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (utmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternUtm);\r\n    const epsgUtm = Number(zone) < 10 ? `EPSG:3260${zone}` : `EPSG:326${zone}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgUtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (mtmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternMtm);\r\n    const epsgMtm =\r\n      Number(zone) < 10 ? `EPSG:3218${zone}` : `EPSG:321${80 + Number(zone)}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgMtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (dmdRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDmd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (ddRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (bellRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      ,\r\n      directionLat,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      ,\r\n      directionLon,\r\n      radius,\r\n      conf\r\n    ] = coordStr.match(patternBELL);\r\n\r\n    // Set default value for North America\r\n    if (!directionLon) {\r\n      directionLon = 'W';\r\n    }\r\n\r\n    // Check if real minutes or decimals\r\n    if (minutesLon && minutesLon.length > 2) {\r\n      lon = parseFloat(\r\n        (negativeLon ? negativeLon : '') + degreesLon + '.' + minutesLon\r\n      );\r\n    } else {\r\n      lon = convertDMSToDD(\r\n        parseFloat(degreesLon),\r\n        parseFloat(minutesLon),\r\n        parseFloat(secondsLon),\r\n        directionLon\r\n      );\r\n    }\r\n\r\n    if (minutesLat && minutesLat.length > 2) {\r\n      lat = parseFloat(\r\n        (negativeLat ? negativeLat : '') + degreesLat + '.' + minutesLat\r\n      );\r\n    } else {\r\n      lat = convertDMSToDD(\r\n        parseFloat(degreesLat),\r\n        parseFloat(minutesLat),\r\n        parseFloat(secondsLat),\r\n        directionLat\r\n      );\r\n    }\r\n  } else if (mmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, lon, decimalLon, lat, decimalLat] = coordStr.match(mmPattern);\r\n\r\n    if (decimalLon) {\r\n      lon = parseFloat(lon + '.' + decimalLon);\r\n    }\r\n\r\n    if (decimalLat) {\r\n      lat = parseFloat(lat + '.' + decimalLat);\r\n    }\r\n  } else {\r\n    return {\r\n      lonLat: undefined,\r\n      message: '',\r\n      radius: undefined,\r\n      conf: undefined\r\n    };\r\n  }\r\n\r\n  if (opts.forceNA && !isXYCoords) {\r\n    // Set a negative coordinate for North America zone\r\n    if (lon > 0 && lat > 0) {\r\n      if (lon > lat) {\r\n        lon = -lon;\r\n      } else {\r\n        lat = -lat;\r\n      }\r\n    }\r\n\r\n    // Reverse coordinate to respect lonLat convention\r\n    if (lon > lat) {\r\n      lon = [lat, (lat = lon)][0];\r\n    }\r\n  }\r\n\r\n  lonLat = [Number(lon), Number(lat)] as [number, number];\r\n\r\n  // Reproject the coordinate if projection parameter have been set and coord is not 4326\r\n  if (\r\n    (projectionStr !== undefined && projectionStr !== toProjection) ||\r\n    (lonLat[0] > 180 || lonLat[0] < -180) ||\r\n    (lonLat[1] > 90 || lonLat[1] < -90)\r\n  ) {\r\n    const source = projectionStr ? 'EPSG:' + projectionStr : mapProjection;\r\n    const dest = 'EPSG:' + toProjection;\r\n\r\n    try {\r\n      lonLat = olproj.transform(lonLat, source, dest);\r\n    } catch (e) {\r\n      return {\r\n        lonLat: undefined,\r\n        message: 'Projection ' + source + ' not supported',\r\n        radius: undefined,\r\n        conf: undefined\r\n      };\r\n    }\r\n  }\r\n\r\n  return {\r\n    lonLat,\r\n    message: '',\r\n    radius: radius ? parseInt(radius, 10) : undefined,\r\n    conf: conf ? parseInt(conf, 10) : undefined\r\n  };\r\n}\r\n\r\n/**\r\n * Convert degrees minutes seconds to dd\r\n * @param degrees Degrees\r\n * @param minutes Minutes\r\n * @param seconds Seconds\r\n * @param direction Direction\r\n */\r\nfunction convertDMSToDD(\r\n  degrees: number,\r\n  minutes: number,\r\n  seconds: number,\r\n  direction: string\r\n) {\r\n  minutes = minutes || 0;\r\n  seconds = seconds || 0;\r\n  let dd = degrees + minutes / 60 + seconds / 3600;\r\n\r\n  if (direction === 'S' || direction === 'W') {\r\n    dd = -dd;\r\n  } // Don't do anything for N or E\r\n  return dd;\r\n}\r\n\r\n/**\r\n * Return true of two view states are equal.\r\n * @param state1 View state\r\n * @param state2 View state\r\n * @returns True if the view states are equal\r\n */\r\nexport function viewStatesAreEqual(\r\n  state1: MapViewState,\r\n  state2: MapViewState\r\n): boolean {\r\n  if (state1 === undefined || state2 === undefined) {\r\n    return false;\r\n  }\r\n\r\n  const tolerance = 1 / 10000;\r\n  return (\r\n    state1.zoom === state2.zoom &&\r\n    Math.trunc(state1.center[0] / tolerance) ===\r\n      Math.trunc(state2.center[0] / tolerance) &&\r\n    Math.trunc(state1.center[1] / tolerance) ===\r\n      Math.trunc(state2.center[1] / tolerance)\r\n  );\r\n}\r\n\r\n/**\r\n * Format the scale to a human readable text\r\n * @param Scale of the map\r\n * @returns Human readable scale text\r\n */\r\nexport function formatScale(scale) {\r\n  scale = Math.round(scale);\r\n  if (scale < 10000) {\r\n    return scale + '';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  if (scale < 1000) {\r\n    return scale + 'K';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  return scale + 'M';\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param scale Scale denom\r\n * @param dpi DPI\r\n * @returns Resolution\r\n */\r\nexport function getResolutionFromScale(\r\n  scale: number,\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return scale / (inchesPerMeter * dpi);\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param Scale denom\r\n * @returns Resolution\r\n */\r\nexport function getScaleFromResolution(\r\n  resolution: number,\r\n  unit: string = 'm',\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return resolution * olproj.METERS_PER_UNIT[unit] * inchesPerMeter * dpi;\r\n}\r\n\r\n/**\r\n * Returns true if the CTRL key is pushed during an Ol MapBrowserPointerEvent\r\n * @param event OL MapBrowserPointerEvent\r\n * @returns Whether the CTRL key is pushed\r\n */\r\nexport function ctrlKeyDown(event: OlMapBrowserPointerEvent): boolean {\r\n  const originalEvent = event.originalEvent;\r\n  return (\r\n    !originalEvent.altKey &&\r\n    (MAC ? originalEvent.metaKey : originalEvent.ctrlKey) &&\r\n    !originalEvent.shiftKey\r\n  );\r\n}\r\n\r\nexport function roundCoordTo(coord: [number, number], decimal: number = 3) {\r\n  return [coord[0].toFixed(decimal), coord[1].toFixed(decimal)];\r\n}\r\n\r\n/**\r\n * Returns an array of converted coordinates.\r\n * Conversion is done for every configured projections\r\n * and for the current UTM zone and MTM zone.\r\n * @param lonLat [number, number] array of the coordinate to transform.\r\n * @param projections  Projection[] Array of destination projection.\r\n * @returns Returns an array of converted coordinates.\r\n */\r\nexport function lonLatConversion(\r\n  lonLat: [number, number],\r\n  projections: Projection[]\r\n): {\r\n  code: string;\r\n  alias: string;\r\n  coord: [number, number];\r\n  igo2CoordFormat: string;\r\n}[] {\r\n  const rawCoord3857 = olproj.transform(lonLat, 'EPSG:4326', 'EPSG:3857');\r\n  const convertedLonLat = [\r\n    {\r\n      code: 'EPSG:3857',\r\n      alias: 'Web mercator',\r\n      coord: rawCoord3857,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord3857).join(', ')} ; 3857`\r\n    }\r\n  ];\r\n\r\n  // detect the current utm zone.\r\n  const utmZone = utmZoneFromLonLat(lonLat);\r\n  const epsgUtm = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n  const utmName = `UTM-${utmZone}`;\r\n  const rawCoordUtm = olproj.transform(lonLat, 'EPSG:4326', epsgUtm);\r\n  convertedLonLat.push({\r\n    code: epsgUtm,\r\n    alias: 'UTM',\r\n    coord: rawCoordUtm,\r\n    igo2CoordFormat: `${utmName} ${roundCoordTo(rawCoordUtm).join(', ')}`\r\n  });\r\n\r\n  // detect the current mtm zone.\r\n  const mtmZone = mtmZoneFromLonLat(lonLat);\r\n  if (mtmZone) {\r\n    const epsgMtm =\r\n      mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n    const mtmName = `MTM-${mtmZone}`;\r\n    const rawCoordMtm = olproj.transform(lonLat, 'EPSG:4326', epsgMtm);\r\n    convertedLonLat.push({\r\n      code: epsgMtm,\r\n      alias: 'MTM',\r\n      coord: rawCoordMtm,\r\n      igo2CoordFormat: `${mtmName} ${roundCoordTo(rawCoordMtm).join(', ')}`\r\n    });\r\n  }\r\n\r\n  projections.forEach(projection => {\r\n    const rawCoord = olproj.transform(lonLat, 'EPSG:4326', projection.code);\r\n    const numericEpsgCode = projection.code.split(':')[1];\r\n    convertedLonLat.push({\r\n      code: projection.code,\r\n      alias: projection.alias || projection.code,\r\n      coord: rawCoord,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord).join(\r\n        ', '\r\n      )} ; ${numericEpsgCode}`\r\n    });\r\n  });\r\n\r\n  return convertedLonLat;\r\n}\r\n\r\n/**\r\n * Detect the current utm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the UTM zone.\r\n * @returns number The UTM zone.\r\n */\r\nexport function utmZoneFromLonLat(lonLat: [number, number]) {\r\n  return Math.ceil((lonLat[0] + 180) / 6);\r\n}\r\n\r\n/**\r\n * Detect the current mtm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the MTM zone.\r\n * @returns number The MTM zone. Undefined if outside of the mtm application zone.\r\n */\r\nexport function mtmZoneFromLonLat(lonLat: [number, number]) {\r\n  const long = lonLat[0];\r\n  let mtmZone;\r\n  if (long < -51 && long > -54) {\r\n    mtmZone = 1;\r\n  }\r\n  if (long < -54 && long > -57) {\r\n    mtmZone = 2;\r\n  }\r\n  if (long < -57 && long > -60) {\r\n    mtmZone = 3;\r\n  }\r\n  if (long < -60 && long > -63) {\r\n    mtmZone = 4;\r\n  }\r\n  if (long < -63 && long > -66) {\r\n    mtmZone = 5;\r\n  }\r\n  if (long < -66 && long > -69) {\r\n    mtmZone = 6;\r\n  }\r\n  if (long < -69 && long > -72) {\r\n    mtmZone = 7;\r\n  }\r\n  if (long < -72 && long > -75) {\r\n    mtmZone = 8;\r\n  }\r\n  if (long < -75 && long > -78) {\r\n    mtmZone = 9;\r\n  }\r\n  if (long < -78 && long > -81) {\r\n    mtmZone = 10;\r\n  }\r\n  return mtmZone;\r\n}\r\n","import {\r\n  BehaviorSubject,\r\n  Observable,\r\n  Subject,\r\n  Subscription,\r\n  combineLatest\r\n} from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olLayer from 'ol/layer/Layer';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { DataSource, Legend } from '../../../datasource';\r\nimport { IgoMap } from '../../../map/shared/map';\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\n\r\nimport { LayerOptions } from './layer.interface';\r\n\r\nexport abstract class Layer {\r\n  public collapsed: boolean;\r\n  public dataSource: DataSource;\r\n  public legend: Legend[];\r\n  public legendCollapsed: boolean = true;\r\n  public firstLoadComponent: boolean = true;\r\n  public map: IgoMap;\r\n  public ol: olLayer;\r\n  public status$: Subject<SubjectStatus>;\r\n\r\n  private resolution$$: Subscription;\r\n\r\n  get id(): string {\r\n    return this.options.id || this.dataSource.id;\r\n  }\r\n\r\n  get alias(): string {\r\n    return this.options.alias;\r\n  }\r\n\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  set title(title: string) {\r\n    this.options.title = title;\r\n  }\r\n\r\n  get zIndex(): number {\r\n    return this.ol.getZIndex();\r\n  }\r\n\r\n  set zIndex(zIndex: number) {\r\n    this.ol.setZIndex(zIndex);\r\n  }\r\n\r\n  get baseLayer(): boolean {\r\n    return this.options.baseLayer;\r\n  }\r\n\r\n  set baseLayer(baseLayer: boolean) {\r\n    this.options.baseLayer = baseLayer;\r\n  }\r\n\r\n  get opacity(): number {\r\n    return this.ol.get('opacity');\r\n  }\r\n\r\n  set opacity(opacity: number) {\r\n    this.ol.setOpacity(opacity);\r\n  }\r\n\r\n  set isInResolutionsRange(value: boolean) {\r\n    this.isInResolutionsRange$.next(value);\r\n  }\r\n  get isInResolutionsRange(): boolean {\r\n    return this.isInResolutionsRange$.value;\r\n  }\r\n  readonly isInResolutionsRange$: BehaviorSubject<\r\n    boolean\r\n  > = new BehaviorSubject(false);\r\n\r\n  set maxResolution(value: number) {\r\n    this.ol.setMaxResolution(value || Infinity);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get maxResolution(): number {\r\n    return this.ol.getMaxResolution();\r\n  }\r\n\r\n  set minResolution(value: number) {\r\n    this.ol.setMinResolution(value || 0);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get minResolution(): number {\r\n    return this.ol.getMinResolution();\r\n  }\r\n\r\n  set visible(value: boolean) {\r\n    this.ol.setVisible(value);\r\n    this.visible$.next(value);\r\n  }\r\n  get visible(): boolean {\r\n    return this.visible$.value;\r\n  }\r\n  readonly visible$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  get displayed(): boolean {\r\n    return this.visible && this.isInResolutionsRange;\r\n  }\r\n  readonly displayed$: Observable<boolean> = combineLatest([\r\n    this.isInResolutionsRange$,\r\n    this.visible$\r\n  ]).pipe(map((bunch: [boolean, boolean]) => bunch[0] && bunch[1]));\r\n\r\n  get showInLayerList(): boolean {\r\n    return this.options.showInLayerList !== false;\r\n  }\r\n\r\n  constructor(\r\n    public options: LayerOptions,\r\n    protected authInterceptor?: AuthInterceptor\r\n  ) {\r\n    this.dataSource = options.source;\r\n\r\n    this.ol = this.createOlLayer();\r\n    if (options.zIndex !== undefined) {\r\n      this.zIndex = options.zIndex;\r\n    }\r\n\r\n    if (options.baseLayer && options.visible === undefined) {\r\n      options.visible = false;\r\n    }\r\n\r\n    this.maxResolution = options.maxResolution || getResolutionFromScale(Number(options.maxScaleDenom));\r\n    this.minResolution = options.minResolution || getResolutionFromScale(Number(options.minScaleDenom));\r\n\r\n    this.visible = options.visible === undefined ? true : options.visible;\r\n    this.opacity = options.opacity === undefined ? 1 : options.opacity;\r\n\r\n    if (\r\n      options.legendOptions &&\r\n      (options.legendOptions.url || options.legendOptions.html)\r\n    ) {\r\n      this.legend = this.dataSource.setLegend(options.legendOptions);\r\n    }\r\n\r\n    this.legendCollapsed = options.legendOptions\r\n      ? options.legendOptions.collapsed\r\n        ? options.legendOptions.collapsed\r\n        : true\r\n      : true;\r\n\r\n    this.ol.set('_layer', this, true);\r\n  }\r\n\r\n  protected abstract createOlLayer(): olLayer;\r\n\r\n  setMap(igoMap: IgoMap | undefined) {\r\n    this.map = igoMap;\r\n\r\n    this.unobserveResolution();\r\n    if (igoMap !== undefined) {\r\n      this.observeResolution();\r\n    }\r\n  }\r\n\r\n  private observeResolution() {\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(() =>\r\n      this.updateInResolutionsRange()\r\n    );\r\n  }\r\n\r\n  private unobserveResolution() {\r\n    if (this.resolution$$ !== undefined) {\r\n      this.resolution$$.unsubscribe();\r\n      this.resolution$$ = undefined;\r\n    }\r\n  }\r\n\r\n  private updateInResolutionsRange() {\r\n    if (this.map !== undefined) {\r\n      const resolution = this.map.viewController.getResolution();\r\n      const minResolution = this.minResolution;\r\n      const maxResolution = this.maxResolution === undefined ? Infinity : this.maxResolution;\r\n      this.isInResolutionsRange = resolution >= minResolution && resolution <= maxResolution;\r\n    } else {\r\n      this.isInResolutionsRange = false;\r\n    }\r\n  }\r\n}\r\n","import olLayer from 'ol/layer/Layer';\r\n\r\nimport { DataSource } from '../../../datasource/shared/datasources/datasource';\r\nimport { AnyDataSourceOptions } from '../../../datasource/shared/datasources/any-datasource.interface';\r\n\r\nexport interface LayerOptions {\r\n  source?: DataSource;\r\n  sourceOptions?: AnyDataSourceOptions;\r\n  title?: string;\r\n  id?: string;\r\n  alias?: string;\r\n  baseLayer?: boolean;\r\n  opacity?: number;\r\n  visible?: boolean;\r\n  extent?: [number, number, number, number];\r\n  zIndex?: number;\r\n  minResolution?: number;\r\n  maxResolution?: number;\r\n  minScaleDenom?: number;\r\n  maxScaleDenom?: number;\r\n  showInLayerList?: boolean;\r\n  removable?: boolean;\r\n  legendOptions?: LegendOptions;\r\n  ol?: olLayer;\r\n  tooltip?: TooltipContent;\r\n  _internal?: { [key: string]: string };\r\n  active?: boolean;\r\n  check?: boolean;\r\n}\r\n\r\nexport interface GroupLayers {\r\n  title: string;\r\n  layers?: LayerOptions;\r\n  collapsed?: boolean;\r\n}\r\n\r\nexport interface TooltipContent {\r\n  type?: TooltipType;\r\n  text?: string;\r\n}\r\nexport enum TooltipType {\r\n  TITLE = 'title',\r\n  ABSTRACT = 'abstract',\r\n  CUSTOM = 'custom'\r\n}\r\n\r\nexport interface LegendOptions {\r\n  collapsed?: boolean;\r\n  display?: boolean;\r\n  url?: string;\r\n  html?: string;\r\n  stylesAvailable?: ItemStyleOptions[];\r\n}\r\n\r\nexport interface ItemStyleOptions {\r\n  name: string;\r\n  title?: string;\r\n}\r\n\r\nexport interface OutputLayerLegend {\r\n  title: string;\r\n  url: string;\r\n  image: string;\r\n}\r\n","import olSourceImage from 'ol/source/Image';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { ImageLayer } from '../shared/layers/image-layer';\r\n\r\nexport class ImageWatcher extends Watcher {\r\n  protected id: string;\r\n  protected loaded = 0;\r\n  protected loading = 0;\r\n\r\n  private source: olSourceImage;\r\n\r\n  constructor(layer: ImageLayer) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`imageloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`imageloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    if (!event.image.__watchers__) {\r\n      event.image.__watchers__ = [];\r\n    }\r\n    event.image.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.image.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.image.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.image.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import olSourceTile from 'ol/source/Tile';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { TileLayer } from '../shared/layers/tile-layer';\r\nimport { VectorTileLayer } from '../shared/layers/vectortile-layer';\r\n\r\nexport class TileWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private source: olSourceTile;\r\n\r\n  constructor(layer: TileLayer | VectorTileLayer) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    // This is to avoid increasing\r\n    // the number of loaded tiles if a tile was loading\r\n    // before subscribing to this watcher\r\n    if (!event.tile.__watchers__) {\r\n      event.tile.__watchers__ = [];\r\n    }\r\n    event.tile.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.tile.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.tile.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.tile.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Layer } from '../shared/layers/layer';\r\nimport { OutputLayerLegend } from '../shared/layers/layer.interface';\r\n\r\n/**\r\n * Get all the layers legend\r\n * @return Array of legend\r\n */\r\nexport function getLayersLegends(layers: Layer[], scale?: number): OutputLayerLegend[] {\r\n  const legends = [];\r\n  const newCanvas = document.createElement('canvas');\r\n  const newContext = newCanvas.getContext('2d');\r\n  newContext.font = '20px Calibri';\r\n\r\n  let heightPos = 0;\r\n  for (const layer of layers) {\r\n    if (layer.visible === false) { continue; }\r\n\r\n    const legendUrls = layer.dataSource.getLegend(undefined, scale) || [];\r\n    for (const legendUrl of legendUrls) {\r\n      if (legendUrl.url === undefined) { continue; }\r\n\r\n      const title = layer.title;\r\n      // Create an image for the legend\r\n      const legendImage = new Image();\r\n      legendImage.crossOrigin = 'anonymous';\r\n      legendImage.src = legendUrl.url;\r\n      legendImage.onload = () => {\r\n        newContext.fillText(title, 0, heightPos);\r\n        newContext.drawImage(legendImage, 0, heightPos + 20);\r\n        heightPos += legendImage.height + 5;\r\n      };\r\n      // Add legend info to the list\r\n      legends.push({\r\n        title,\r\n        url: legendUrl.url,\r\n        image: legendImage\r\n      });\r\n    }\r\n  }\r\n\r\n  return legends;\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { VectorLayer } from '../shared/layers/vector-layer';\r\n\r\nexport class VectorWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private layer: VectorLayer;\r\n\r\n  constructor(layer: VectorLayer) {\r\n    super();\r\n    this.layer = layer;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.layer.onUnwatch();\r\n  }\r\n}\r\n","import olLayerImage from 'ol/layer/Image';\r\nimport olSourceImage from 'ol/source/Image';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\nimport { ImageWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { WMSDataSource } from '../../../datasource/shared/datasources/wms-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { ImageLayerOptions } from './image-layer.interface';\r\n\r\nexport class ImageLayer extends Layer {\r\n  public dataSource: WMSDataSource;\r\n  public options: ImageLayerOptions;\r\n  public ol: olLayerImage;\r\n\r\n  private watcher: ImageWatcher;\r\n\r\n  constructor(\r\n    options: ImageLayerOptions,\r\n    public authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(options, authInterceptor);\r\n    this.watcher = new ImageWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerImage {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceImage\r\n    });\r\n\r\n    const image = new olLayerImage(olOptions);\r\n    if (this.authInterceptor) {\r\n      (image.getSource() as any).setImageLoadFunction((tile, src) => {\r\n        this.customLoader(tile, src);\r\n      });\r\n    }\r\n\r\n    return image;\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  private customLoader(tile, src) {\r\n    const xhr = new XMLHttpRequest();\r\n    xhr.open('GET', src);\r\n\r\n    const intercepted = this.authInterceptor.interceptXhr(xhr, src);\r\n    if (!intercepted) {\r\n      xhr.abort();\r\n      tile.getImage().src = src;\r\n      return;\r\n    }\r\n\r\n    xhr.responseType = 'arraybuffer';\r\n\r\n    xhr.onload = function() {\r\n      const arrayBufferView = new Uint8Array((this as any).response);\r\n      const blob = new Blob([arrayBufferView], { type: 'image/png' });\r\n      const urlCreator = window.URL;\r\n      const imageUrl = urlCreator.createObjectURL(blob);\r\n      tile.getImage().src = imageUrl;\r\n    };\r\n    xhr.send();\r\n  }\r\n}\r\n","import olLayerTile from 'ol/layer/Tile';\r\nimport olSourceTile from 'ol/source/Tile';\r\n\r\nimport { TileWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { OSMDataSource } from '../../../datasource/shared/datasources/osm-datasource';\r\nimport { WMTSDataSource } from '../../../datasource/shared/datasources/wmts-datasource';\r\nimport { XYZDataSource } from '../../../datasource/shared/datasources/xyz-datasource';\r\nimport { CartoDataSource } from '../../../datasource/shared/datasources/carto-datasource';\r\nimport { TileArcGISRestDataSource } from '../../../datasource/shared/datasources/tilearcgisrest-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { TileLayerOptions } from './tile-layer.interface';\r\n\r\nexport class TileLayer extends Layer {\r\n  public dataSource:\r\n    | OSMDataSource\r\n    | WMTSDataSource\r\n    | XYZDataSource\r\n    | CartoDataSource\r\n    | TileArcGISRestDataSource;\r\n  public options: TileLayerOptions;\r\n  public ol: olLayerTile;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(options: TileLayerOptions) {\r\n    super(options);\r\n\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerTile {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceTile\r\n    });\r\n\r\n    return new olLayerTile(olOptions);\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n}\r\n","import olLayerVector from 'ol/layer/Vector';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { easeOut } from 'ol/easing';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\nimport { FeatureDataSource } from '../../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSource } from '../../../datasource/shared/datasources/wfs-datasource';\r\nimport { ArcGISRestDataSource } from '../../../datasource/shared/datasources/arcgisrest-datasource';\r\nimport { WebSocketDataSource } from '../../../datasource/shared/datasources/websocket-datasource';\r\nimport { ClusterDataSource } from '../../../datasource/shared/datasources/cluster-datasource';\r\n\r\nimport { VectorWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\nimport { Layer } from './layer';\r\nimport { VectorLayerOptions } from './vector-layer.interface';\r\n\r\nexport class VectorLayer extends Layer {\r\n  public dataSource:\r\n    | FeatureDataSource\r\n    | WFSDataSource\r\n    | ArcGISRestDataSource\r\n    | WebSocketDataSource\r\n    | ClusterDataSource;\r\n  public options: VectorLayerOptions;\r\n  public ol: olLayerVector;\r\n  private watcher: VectorWatcher;\r\n  private trackFeatureListenerId;\r\n\r\n  get browsable(): boolean {\r\n    return this.options.browsable !== false;\r\n  }\r\n\r\n  get exportable(): boolean {\r\n    return this.options.exportable !== false;\r\n  }\r\n\r\n  constructor(options: VectorLayerOptions) {\r\n    super(options);\r\n    this.watcher = new VectorWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVector {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVector\r\n    });\r\n\r\n    if (this.options.animation) {\r\n      this.dataSource.ol.on(\r\n        'addfeature',\r\n        function(e) {\r\n          this.flash(e.feature);\r\n        }.bind(this)\r\n      );\r\n    }\r\n\r\n    if (this.options.trackFeature) {\r\n      this.enableTrackFeature(this.options.trackFeature);\r\n    }\r\n\r\n    return new olLayerVector(olOptions);\r\n  }\r\n\r\n  protected flash(feature) {\r\n    const start = new Date().getTime();\r\n    const listenerKey = this.map.ol.on('postcompose', animate.bind(this));\r\n\r\n    function animate(event) {\r\n      const vectorContext = event.vectorContext;\r\n      const frameState = event.frameState;\r\n      const flashGeom = feature.getGeometry().clone();\r\n      const elapsed = frameState.time - start;\r\n      const elapsedRatio = elapsed / this.options.animation.duration;\r\n      const opacity = easeOut(1 - elapsedRatio);\r\n      const newColor = ColorAsArray(this.options.animation.color || 'red');\r\n      newColor[3] = opacity;\r\n      let style = this.ol\r\n        .getStyleFunction()\r\n        .call(this, feature)\r\n        .find(style2 => {\r\n          return style2.getImage();\r\n        });\r\n      if (!style) {\r\n        style = this.ol.getStyleFunction().call(this, feature)[0];\r\n      }\r\n      const styleClone = style.clone();\r\n\r\n      switch (feature.getGeometry().getType()) {\r\n        case 'Point':\r\n          const radius =\r\n            easeOut(elapsedRatio) * (styleClone.getImage().getRadius() * 3);\r\n          styleClone.getImage().setRadius(radius);\r\n          styleClone.getImage().setOpacity(opacity);\r\n          break;\r\n        case 'LineString':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone\r\n              .getImage()\r\n              .getStroke()\r\n              .setColor(newColor);\r\n            styleClone\r\n              .getImage()\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) *\r\n                  (styleClone\r\n                    .getImage()\r\n                    .getStroke()\r\n                    .getWidth() *\r\n                    3)\r\n              );\r\n          }\r\n          if (styleClone.getStroke()) {\r\n            styleClone.getStroke().setColor(newColor);\r\n            styleClone\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) * (styleClone.getStroke().getWidth() * 3)\r\n              );\r\n          }\r\n          break;\r\n        case 'Polygon':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone\r\n              .getImage()\r\n              .getFill()\r\n              .setColor(newColor);\r\n          }\r\n          if (styleClone.getFill()) {\r\n            styleClone.getFill().setColor(newColor);\r\n          }\r\n          break;\r\n      }\r\n\r\n      styleClone.setText('');\r\n      vectorContext.setStyle(styleClone);\r\n      vectorContext.drawGeometry(flashGeom);\r\n\r\n      if (elapsed > this.options.animation.duration) {\r\n        unByKey(listenerKey);\r\n        // remove last geometry\r\n        // there is a little flash before feature disappear, better solution ?\r\n        this.map.ol.render();\r\n        return;\r\n      }\r\n      // tell OpenLayers to continue postcompose animation\r\n      this.map.ol.render();\r\n    }\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.dataSource.onUnwatch();\r\n    this.stopAnimation();\r\n  }\r\n\r\n  public stopAnimation() {\r\n    this.dataSource.ol.un(\r\n      'addfeature',\r\n      function(e) {\r\n        if (this.visible) {\r\n          this.flash(e.feature);\r\n        }\r\n      }.bind(this)\r\n    );\r\n  }\r\n\r\n  public enableTrackFeature(id: string | number) {\r\n    this.trackFeatureListenerId = this.dataSource.ol.on(\r\n      'addfeature',\r\n      this.trackFeature.bind(this, id)\r\n    );\r\n  }\r\n  public centerMapOnFeature(id: string | number) {\r\n    const feat = this.dataSource.ol.getFeatureById(id);\r\n    if (feat) {\r\n      this.map.ol.getView().setCenter(feat.getGeometry().getCoordinates());\r\n    }\r\n  }\r\n\r\n  public trackFeature(id, feat) {\r\n    if (feat.feature.getId() === id && this.visible) {\r\n      this.centerMapOnFeature(id);\r\n    }\r\n  }\r\n\r\n  public disableTrackFeature(id?: string | number) {\r\n    unByKey(this.trackFeatureListenerId);\r\n  }\r\n}\r\n","import olLayerVectorTile from 'ol/layer/VectorTile';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\n\r\nimport { MVTDataSource } from '../../../datasource/shared/datasources/mvt-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { VectorTileLayerOptions } from './vectortile-layer.interface';\r\nimport { TileWatcher } from '../../utils';\r\n\r\nexport class VectorTileLayer extends Layer {\r\n  public dataSource: MVTDataSource;\r\n  public options: VectorTileLayerOptions;\r\n  public ol: olLayerVectorTile;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(options: VectorTileLayerOptions) {\r\n    super(options);\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVectorTile {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVectorTile\r\n    });\r\n\r\n    return new olLayerVectorTile(olOptions);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  AfterViewInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { ActivityService } from '@igo2/core';\r\n\r\nimport { IgoMap, MapViewOptions } from '../shared';\r\n\r\n@Component({\r\n  selector: 'igo-map-browser',\r\n  templateUrl: './map-browser.component.html',\r\n  styleUrls: ['./map-browser.component.scss']\r\n})\r\nexport class MapBrowserComponent implements OnInit, AfterViewInit, OnDestroy {\r\n\r\n  private activityId: string;\r\n  private status$$: Subscription;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get view(): MapViewOptions { return this._view; }\r\n  set view(value: MapViewOptions) {\r\n    this._view = value;\r\n    if (this.map !== undefined) {\r\n      this.map.updateView(value);\r\n    }\r\n  }\r\n  private _view: MapViewOptions;\r\n\r\n  public id = `igo-map-target-${new Date().getTime()}`;\r\n\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  ngOnInit() {\r\n    this.status$$ = this.map.status$.subscribe(status =>\r\n      this.handleStatusChange(status)\r\n    );\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.map.setTarget(this.id);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.setTarget(undefined);\r\n    this.activityService.unregister(this.activityId);\r\n    this.status$$.unsubscribe();\r\n  }\r\n\r\n  private handleStatusChange(status: SubjectStatus) {\r\n    if (status === SubjectStatus.Working && this.activityId === undefined) {\r\n      this.activityId = this.activityService.register();\r\n    } else if (status === SubjectStatus.Done && this.activityId !== undefined) {\r\n      this.activityService.unregister(this.activityId);\r\n      this.activityId = undefined;\r\n    }\r\n  }\r\n}\r\n","export enum OverlayAction {\r\n    None,\r\n    Move,\r\n    Zoom,\r\n    ZoomIfOutMapExtent\r\n  }\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayAction } from './overlay.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OverlayService {\r\n  public features$ = new BehaviorSubject<[Feature[], OverlayAction]>([\r\n    [],\r\n    undefined\r\n  ]);\r\n\r\n  constructor() {}\r\n\r\n  setFeatures(features: Feature[], action: OverlayAction = OverlayAction.None) {\r\n    this.features$.next([features, action]);\r\n  }\r\n\r\n  clear() {\r\n    this.features$.next([[], OverlayAction.None]);\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olextent from 'ol/extent';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayService } from '../shared/overlay.service';\r\nimport { OverlayAction } from '../shared/overlay.enum';\r\n\r\n@Directive({\r\n  selector: '[igoOverlay]'\r\n})\r\nexport class OverlayDirective implements OnInit, OnDestroy {\r\n  private features$$: Subscription;\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private overlayService: OverlayService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.features$$ = this.overlayService.features$.subscribe(res =>\r\n      this.handleFeatures(res[0], res[1])\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.features$$.unsubscribe();\r\n  }\r\n\r\n  private handleFeatures(features: Feature[], action: OverlayAction) {}\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer, StyleService } from '../../layer';\r\n\r\n/**\r\n * Create an overlay layer and it's source\r\n * @returns Overlay layer\r\n */\r\nexport function createOverlayLayer(): VectorLayer {\r\n  const overlayDataSource = new FeatureDataSource();\r\n  return new VectorLayer({\r\n    title: 'Overlay',\r\n    zIndex: 300,\r\n    source: overlayDataSource,\r\n    style: createOverlayLayerStyle()\r\n  });\r\n}\r\n\r\n/**\r\n * Create an overlay style with markers for points and a basic stroke/fill\r\n * combination for lines and polygons\r\n * @returns Style function\r\n */\r\nfunction createOverlayLayerStyle(): (olFeature: OlFeature) => olstyle.Style {\r\n  const defaultStyle = createOverlayDefaultStyle();\r\n  const markerStyle = createOverlayMarkerStyle();\r\n\r\n  let style;\r\n\r\n  return (olFeature: OlFeature) => {\r\n    if (olFeature.getId() === 'bufferFeature') {\r\n      style = createBufferStyle(olFeature.get('bufferStroke'), 2, olFeature.get('bufferFill'), olFeature.get('bufferText'));\r\n      return style;\r\n    } else {\r\n      const customStyle = olFeature.get('_style');\r\n      if (customStyle) {\r\n        const styleService = new StyleService();\r\n        return styleService.createStyle(customStyle);\r\n      }\r\n      const geometryType = olFeature.getGeometry().getType();\r\n      style = geometryType === 'Point' ? markerStyle : defaultStyle;\r\n      style.getText().setText(olFeature.get('_mapTitle'));\r\n      return style;\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Create a basic style for lines and polygons\r\n * @returns Style\r\n */\r\nexport function createOverlayDefaultStyle(\r\n  {text, fillOpacity, strokeWidth = 2, strokeOpacity, color = [0, 161, 222, 0.3], strokeColor}:\r\n    {text?: string, fillOpacity?: number, strokeWidth?: number, strokeOpacity?: number, color?: number[], strokeColor?: number[]}  = {}\r\n  ): olstyle.Style {\r\n  const fillWithOpacity = color.slice(0);\r\n  const strokeWithOpacity = color.slice(0);\r\n  strokeWithOpacity[3] = 1;\r\n  if (fillOpacity) {\r\n    fillWithOpacity[3] = fillOpacity;\r\n  }\r\n  if (strokeOpacity) {\r\n    strokeWithOpacity[3] = strokeOpacity;\r\n  }\r\n  if (strokeColor) {\r\n    strokeWithOpacity[0] = strokeColor[0];\r\n    strokeWithOpacity[1] = strokeColor[1];\r\n    strokeWithOpacity[2] = strokeColor[2];\r\n  }\r\n\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeWithOpacity\r\n  });\r\n\r\n  const fill = new olstyle.Fill({\r\n    color: fillWithOpacity\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      text,\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Create a marker style for points\r\n * @returns Style\r\n */\r\nexport function createOverlayMarkerStyle(\r\n  {text, opacity = 1, color = 'blue', outlineColor}:\r\n    {text?: string, opacity?: number, color?: string, outlineColor?: string | number[]}  = {}\r\n  ): olstyle.Style {\r\n  let iconColor;\r\n  let svgIconColor;\r\n  let svgOutlineColor;\r\n  let svg;\r\n\r\n  const isIE = /msie\\s|trident\\/|edge\\//i.test(window.navigator.userAgent); // To fix IE11 svg bug (temporarly)\r\n\r\n  switch (color) {\r\n    case 'blue':\r\n      svgIconColor = '\"rgb(0,161,222)\"';\r\n      iconColor = color;\r\n      break;\r\n    case 'red':\r\n      svgIconColor = '\"rgb(246,65,57)\"';\r\n      iconColor = color;\r\n      break;\r\n    case 'yellow':\r\n      svgIconColor = '\"rgb(255,215,0)\"';\r\n      iconColor = color;\r\n      break;\r\n    case 'green':\r\n      svgIconColor = '\"rgb(0,128,0)\"';\r\n      iconColor = color;\r\n      break;\r\n    default:\r\n      svgIconColor = '\"rgb(0,161,222)\"';\r\n      iconColor = 'blue';\r\n      break;\r\n  }\r\n\r\n  if (outlineColor) {\r\n    if (outlineColor instanceof Array) {\r\n      svgOutlineColor = 'rgb(' + outlineColor[0] + ',' + outlineColor[1] + ',' + outlineColor[2] + ')';\r\n    }\r\n    switch (outlineColor) {\r\n      case 'blue':\r\n        svgOutlineColor = 'rgb(0,161,222)';\r\n        break;\r\n      case 'red':\r\n        svgOutlineColor = 'rgb(246,65,57)';\r\n        break;\r\n      case 'yellow':\r\n        svgOutlineColor = 'rgb(255,215,0)';\r\n        break;\r\n      case 'green':\r\n        svgOutlineColor = 'rgb(0,128,0)';\r\n        break;\r\n    }\r\n    svg = '<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" height=\"36\" width=\"36\" viewBox=\"0 0 36 36\">' +\r\n          '<path fill=' + svgIconColor + ' stroke=\"' + svgOutlineColor + '\" stroke-width=\"2\" d=\"M 17.692635,32.565644 C 15.71852,30.330584 13.290925,27.058065 11.6766,24.455732 9.3398623,20.688851 7.8905694,17.205334 7.6297492,14.728733 7.5616025,14.081649 7.5739557,12.528552 7.6513363,12.014724 8.1013861,9.0262716 9.8047068,6.3655569 12.310675,4.7364878 c 1.113691,-0.7239832 2.508083,-1.2834131 3.776687,-1.5152052 0.242945,-0.044389 0.451656,-0.09393 0.463804,-0.1100911 0.01215,-0.016161 0.638282,-0.025502 1.391411,-0.02076 1.088235,0.00685 1.450932,0.024316 1.766871,0.085071 2.650763,0.5097353 4.947142,1.8701891 6.498786,3.8501033 0.628018,0.8013587 1.297046,2.0200608 1.640967,2.9891872 0.191065,0.538399 0.427644,1.447408 0.477391,1.834287 0.0164,0.127546 0.0434,0.231902 0.06,0.231902 0.0166,0 0.03122,0.626135 0.03249,1.391411 0.0013,0.765276 -0.011,1.391411 -0.02726,1.391411 -0.01626,0 -0.05449,0.154049 -0.08495,0.342331 -0.08815,0.544879 -0.387235,1.721449 -0.604837,2.379406 -1.209421,3.656888 -4.014463,8.349762 -7.849521,13.132357 -0.790496,0.985807 -1.795217,2.167992 -1.842543,2.167992 -0.01896,0 -0.161766,-0.144111 -0.317336,-0.320246 z m 1.066937,-15.36525 c 0.133519,-0.02121 0.248766,-0.05657 0.256105,-0.07859 0.0073,-0.02202 0.04918,-0.03066 0.09298,-0.0192 0.0438,0.01145 0.107628,-0.0072 0.141834,-0.04137 0.03421,-0.03421 0.08456,-0.05474 0.111888,-0.04563 0.02733,0.0091 0.07703,-0.01077 0.110429,-0.04417 0.03341,-0.03341 0.08416,-0.05293 0.112796,-0.04338 0.02863,0.0095 0.08974,-0.01867 0.135802,-0.06271 0.04606,-0.04403 0.111902,-0.08625 0.146319,-0.09381 0.204084,-0.04483 0.762371,-0.519108 1.079463,-0.917027 0.26749,-0.335672 0.570987,-0.878795 0.529019,-0.946701 -0.01496,-0.0242 -0.0067,-0.044 0.01835,-0.044 0.05645,0 0.196809,-0.467982 0.158801,-0.529481 -0.01521,-0.02461 -0.0043,-0.04475 0.02427,-0.04475 0.03157,0 0.04365,-0.04329 0.03082,-0.11043 -0.01161,-0.06074 -0.0066,-0.110429 0.01124,-0.110429 0.01779,0 0.03235,-0.258405 0.03235,-0.574233 0,-0.315829 -0.01545,-0.574234 -0.03434,-0.574234 -0.01889,0 -0.02437,-0.03811 -0.01219,-0.08469 0.04412,-0.168712 -0.336329,-1.152668 -0.481536,-1.245401 -0.02327,-0.01486 -0.04022,-0.03992 -0.03765,-0.05568 0.01222,-0.07498 -0.156557,-0.318365 -0.406379,-0.586027 -0.295921,-0.317054 -0.773059,-0.690104 -0.83427,-0.652274 -0.0206,0.01273 -0.03745,0.0024 -0.03745,-0.02289 0,-0.06107 -0.433076,-0.2789369 -0.487546,-0.245273 -0.02338,0.01445 -0.04251,0.0068 -0.04251,-0.01695 0,-0.056281 -0.393995,-0.1865457 -0.613804,-0.2029397 -0.0943,-0.00703 -0.188579,-0.023183 -0.209503,-0.035888 -0.02092,-0.012705 -0.276571,-0.023337 -0.568105,-0.023627 -0.534044,-5.301e-4 -1.12638,0.091025 -1.12638,0.1741017 0,0.023781 -0.01713,0.032648 -0.03808,0.019705 -0.05054,-0.031232 -0.403641,0.1088602 -0.403641,0.1601422 0,0.02204 -0.01988,0.02779 -0.04417,0.01278 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01988,0.0371 -0.04417,0.02209 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01915,0.03755 -0.04256,0.02308 -0.02341,-0.01447 -0.08138,0.01252 -0.128834,0.05997 -0.04745,0.04745 -0.0974,0.07515 -0.111001,0.06155 -0.0136,-0.0136 -0.03722,0.0078 -0.05248,0.0476 -0.01526,0.03978 -0.0411,0.06408 -0.0574,0.054 -0.03277,-0.02025 -0.462299,0.323995 -0.491977,0.394291 -0.01026,0.02429 -0.07454,0.0912 -0.142856,0.148686 -0.248033,0.208705 -0.730279,0.974169 -0.672565,1.067553 0.0145,0.02346 0.0059,0.04266 -0.01914,0.04266 -0.05907,0 -0.241471,0.599428 -0.208527,0.685278 0.01385,0.0361 0.0044,0.06564 -0.02098,0.06564 -0.02539,0 -0.04169,0.0646 -0.03622,0.143558 0.0055,0.07896 -0.0042,0.213129 -0.02144,0.29816 -0.04741,0.233576 0.0511,1.055502 0.167516,1.397721 0.126048,0.370516 0.310099,0.740163 0.426484,0.856548 0.04776,0.04776 0.07554,0.08684 0.06174,0.08684 -0.0138,0 0.01516,0.05653 0.06436,0.125632 0.131301,0.184396 0.499365,0.587266 0.518785,0.567846 0.0092,-0.0092 0.09821,0.06081 0.197812,0.155562 0.09961,0.09475 0.190589,0.162786 0.202187,0.151188 0.0116,-0.0116 0.05991,0.01774 0.107361,0.06519 0.04745,0.04745 0.105426,0.07444 0.128834,0.05997 0.02341,-0.01447 0.04256,-0.0057 0.04256,0.01958 0,0.06106 0.344664,0.23496 0.399061,0.201341 0.02346,-0.0145 0.04266,-0.0059 0.04266,0.01914 0,0.05907 0.599429,0.241471 0.685279,0.208527 0.0361,-0.01385 0.06564,-0.0065 0.06564,0.01645 0,0.05196 1.079115,0.04833 1.413314,-0.0048 z\"></path>'\r\n          + '</svg>';\r\n  }\r\n\r\n  if (!isIE) {\r\n    return new olstyle.Style({\r\n      image: new olstyle.Icon({\r\n        src: svg ? 'data:image/svg+xml;utf8,' + svg : './assets/igo2/geo/icons/place_' + iconColor + '_36px.svg',\r\n        opacity,\r\n        imgSize: [36, 36], // for ie\r\n        anchor: [0.5, 0.92]\r\n      }),\r\n      text: new olstyle.Text({\r\n        text,\r\n        font: '12px Calibri,sans-serif',\r\n        fill: new olstyle.Fill({ color: '#000' }),\r\n        stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n        overflow: true\r\n      })\r\n    });\r\n  } else {\r\n    return new olstyle.Style({\r\n      image: new olstyle.Icon({\r\n        src: './assets/igo2/geo/icons/place_' + iconColor + '_36px.svg',\r\n        opacity,\r\n        imgSize: [36, 36], // for ie\r\n        anchor: [0.5, 0.92]\r\n      }),\r\n      text: new olstyle.Text({\r\n        text,\r\n        font: '12px Calibri,sans-serif',\r\n        fill: new olstyle.Fill({ color: '#000' }),\r\n        stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n        overflow: true\r\n      })\r\n    });\r\n  }\r\n}\r\n\r\nfunction createBufferStyle(\r\n  strokeRGBA: [number, number, number, number] = [0, 161, 222, 1],\r\n  strokeWidth: number = 2,\r\n  fillRGBA: [number, number, number, number] = [0, 161, 222, 0.15],\r\n  bufferRadius?\r\n): olstyle.Style {\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeRGBA\r\n  });\r\n\r\n  const fill = new olstyle.Stroke({\r\n    color: fillRGBA\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      font: '12px Calibri,sans-serif',\r\n      text: bufferRadius,\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport { StyleByAttribute } from './vector-style.interface';\r\n\r\nimport { ClusterParam } from './clusterParam';\r\nimport { createOverlayMarkerStyle } from '../../overlay';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleService {\r\n  public style: olstyle.Style;\r\n\r\n  createStyle(options: { [key: string]: any }) {\r\n    if (!options) {\r\n      return createOverlayMarkerStyle();\r\n    }\r\n    if (typeof options === 'function' || options instanceof olstyle.Style) {\r\n      return options;\r\n    }\r\n    return this.parseStyle('style', options);\r\n  }\r\n\r\n  private parseStyle(key: string, value: any): olstyle {\r\n    const styleOptions = {};\r\n    const olCls = this.getOlCls(key);\r\n\r\n    if (olCls && value instanceof Object) {\r\n      Object.keys(value).forEach(_key => {\r\n        const olKey = this.getOlKey(_key);\r\n        styleOptions[olKey] = this.parseStyle(_key, value[_key]);\r\n      });\r\n      return new olCls(styleOptions);\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  private getOlKey(key: any) {\r\n    let olKey;\r\n    switch (key.toLowerCase()) {\r\n      case 'circle':\r\n      case 'regularshape':\r\n      case 'icon':\r\n        olKey = 'image';\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return olKey || key;\r\n  }\r\n\r\n  private getOlCls(key: any) {\r\n    let olCls = olstyle[key.charAt(0).toUpperCase() + key.slice(1)];\r\n    if (key === 'regularshape') {\r\n      olCls = olstyle.RegularShape;\r\n    }\r\n    if (key === 'backgroundFill') {\r\n      olCls = olstyle.Fill;\r\n    }\r\n    if (key === 'backgroundStroke') {\r\n      olCls = olstyle.Stroke;\r\n    }\r\n\r\n    return olCls;\r\n  }\r\n\r\n  createStyleByAttribute(feature, styleByAttribute: StyleByAttribute) {\r\n    let style;\r\n    const type = styleByAttribute.type;\r\n    const attribute = styleByAttribute.attribute;\r\n    const data = styleByAttribute.data;\r\n    const stroke = styleByAttribute.stroke;\r\n    const width = styleByAttribute.width;\r\n    const fill = styleByAttribute.fill;\r\n    const radius = styleByAttribute.radius;\r\n    const icon = styleByAttribute.icon;\r\n    const scale = styleByAttribute.scale;\r\n    const size = data.length;\r\n    const label = styleByAttribute.label.attribute || styleByAttribute.label;\r\n    const labelStyle =\r\n      this.parseStyle('text', styleByAttribute.label.style) ||\r\n      new olstyle.Text();\r\n    labelStyle.setText(this.getLabel(feature, label));\r\n    const baseStyle = styleByAttribute.baseStyle;\r\n    if (type === 'circle') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n          typeof feature.get(attribute) !== 'undefined'\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(data[i])) {\r\n          if (icon) {\r\n            style = [\r\n              new olstyle.Style({\r\n                image: new olstyle.Icon({\r\n                  src: icon[i],\r\n                  scale: scale ? scale[i] : 1\r\n                })\r\n              })\r\n            ];\r\n            return style;\r\n          }\r\n          style = [\r\n            new olstyle.Style({\r\n              image: new olstyle.Circle({\r\n                radius: radius ? radius[i] : 4,\r\n                stroke: new olstyle.Stroke({\r\n                  color: stroke ? stroke[i] : 'black',\r\n                  width: width ? width[i] : 1\r\n                }),\r\n                fill: new olstyle.Fill({\r\n                  color: fill ? fill[i] : 'black'\r\n                })\r\n              }),\r\n              text: labelStyle\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (!feature.getStyle()) {\r\n        style = [\r\n          new olstyle.Style({\r\n            image: new olstyle.Circle({\r\n              radius: 4,\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n        return style;\r\n      }\r\n    } else if (type === 'regular') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n          typeof feature.get(attribute) !== 'undefined'\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(data[i])) {\r\n          style = [\r\n            new olstyle.Style({\r\n              stroke: new olstyle.Stroke({\r\n                color: stroke ? stroke[i] : 'black',\r\n                width: width ? width[i] : 1\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: fill ? fill[i] : 'rgba(255,255,255,0.4)'\r\n              }),\r\n              text: labelStyle\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (feature instanceof OlFeature) {\r\n        if (!feature.getStyle()) {\r\n          if (baseStyle) {\r\n            style = this.createStyle(baseStyle);\r\n            return style;\r\n          }\r\n          style = [\r\n            new olstyle.Style({\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  createClusterStyle(feature, clusterParam: ClusterParam = {}, layerStyle) {\r\n    let style: olstyle.Style;\r\n    const size = feature.get('features').length;\r\n    if (size !== 1) {\r\n      if (clusterParam.clusterRanges) {\r\n        for (const r of clusterParam.clusterRanges) {\r\n          if (\r\n            (!r.minRadius || r.minRadius <= size) &&\r\n            (!r.maxRadius || r.maxRadius >= size)\r\n          ) {\r\n            style = this.createStyle(r.style);\r\n\r\n            if (r.showRange) {\r\n              const text = new olstyle.Text({\r\n                text: size.toString(),\r\n                fill: new olstyle.Fill({\r\n                  color: '#fff'\r\n                })\r\n              });\r\n              style.setText(text);\r\n            }\r\n\r\n            if (r.dynamicRadius) {\r\n              let clusterRadius: number;\r\n              const radiusMin = style.image_.getRadius();\r\n              clusterRadius = 5 * Math.log(size);\r\n              if (clusterRadius < radiusMin) {\r\n                clusterRadius = radiusMin;\r\n              }\r\n              style.image_.setRadius(clusterRadius);\r\n            }\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!style) {\r\n        let clusterRadius: number;\r\n        if (clusterParam.radiusCalc) {\r\n          clusterRadius = clusterParam.radiusCalc(size);\r\n        } else {\r\n          const radiusMin = 6;\r\n          clusterRadius = 5 * Math.log(size);\r\n          if (clusterRadius < radiusMin) {\r\n            clusterRadius = radiusMin;\r\n          }\r\n        }\r\n\r\n        style = [\r\n          new olstyle.Style({\r\n            image: new olstyle.Circle({\r\n              radius: clusterRadius,\r\n              opacity: 0.4,\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: 'rgba(24, 134, 45, 0.5)'\r\n              })\r\n            }),\r\n            text: new olstyle.Text({\r\n              text: size.toString(),\r\n              fill: new olstyle.Fill({\r\n                color: '#fff'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n      }\r\n    } else {\r\n      style = this.createStyle(layerStyle);\r\n    }\r\n    return style;\r\n  }\r\n\r\n  getLabel(feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.get(v[1]));\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.get(labelMatch) || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n}\r\n","import OlLayer from 'ol/layer/Layer';\r\n\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { QueryableDataSource } from './query.interfaces';\r\n\r\n/**\r\n * Whether a layer is queryable\r\n * @param layer Layer\r\n * @returns True if the layer s squeryable\r\n */\r\nexport function layerIsQueryable(layer: AnyLayer): boolean {\r\n  const dataSource = layer.dataSource as QueryableDataSource;\r\n  return dataSource.options.queryable === true;\r\n}\r\n\r\n/**\r\n * Whether an OL layer is queryable\r\n * @param layer Layer\r\n * @returns True if the ol layer is queryable\r\n */\r\nexport function olLayerIsQueryable(olLayer: OlLayer): boolean {\r\n  const layer = olLayer.get('_layer');\r\n  return layer === undefined ? false : layerIsQueryable(layer);\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  Renderer2,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { layerIsQueryable } from '../../query/shared/query.utils';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-item',\r\n  templateUrl: './layer-item.component.html',\r\n  styleUrls: ['./layer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerItemComponent implements OnInit, OnDestroy {\r\n\r\n  public focusedCls = 'igo-layer-item-focused';\r\n\r\n  @Input()\r\n  get activeLayer() {\r\n    return this._activeLayer;\r\n  }\r\n  set activeLayer(value) {\r\n    if (value && this.layer && value.id === this.layer.id && !this.selectionMode) {\r\n      this.layerTool$.next(true);\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n  }\r\n  private _activeLayer;\r\n\r\n  layerTool$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  queryBadgeHidden$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  @Input()\r\n  get selectAll() {\r\n    return this._selectAll;\r\n  }\r\n  set selectAll(value: boolean) {\r\n    this._selectAll = value;\r\n    if (value === true) {\r\n      this.layerCheck = true;\r\n    }\r\n  }\r\n  private _selectAll = false;\r\n\r\n  @Input() layerCheck;\r\n\r\n  private resolution$$: Subscription;\r\n\r\n  layers$: BehaviorSubject<Layer> = new BehaviorSubject<Layer>(undefined);\r\n\r\n  @Input()\r\n  get layer() {\r\n    return this._layer;\r\n  }\r\n  set layer(value) {\r\n    this._layer = value;\r\n    this.layers$.next(value);\r\n  }\r\n  private _layer;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendIfVisible: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() orderable: boolean = true;\r\n\r\n  @Input() lowerDisabled: boolean = false;\r\n\r\n  @Input() raiseDisabled: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Input() selectionMode;\r\n\r\n  get removable(): boolean {\r\n    return this.layer.options.removable !== false;\r\n  }\r\n\r\n  get opacity() {\r\n    return this.layer.opacity * 100;\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.layer.opacity = opacity / 100;\r\n  }\r\n\r\n  @Output() action: EventEmitter<Layer> = new EventEmitter<Layer>(undefined);\r\n  @Output() checkbox = new EventEmitter<{\r\n    layer: Layer;\r\n    check: boolean;\r\n  }>();\r\n\r\n  constructor(\r\n    private networkService: NetworkService,\r\n    private renderer: Renderer2,\r\n    private elRef: ElementRef) {}\r\n\r\n  ngOnInit() {\r\n    if (\r\n      this.layer.visible &&\r\n      this.expandLegendIfVisible &&\r\n      this.layer.firstLoadComponent === true\r\n    ) {\r\n      this.layer.firstLoadComponent = false;\r\n      this.layer.legendCollapsed = false;\r\n    }\r\n    this.toggleLegend(this.layer.legendCollapsed);\r\n    this.updateQueryBadge();\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n\r\n    this.layers$.subscribe(() => {\r\n      if (this.layer && this.layer.options.active) {\r\n        this.layerTool$.next(true);\r\n        this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    this.toggleLegend(this.showLegend$.value);\r\n  }\r\n\r\n  toggleVisibility() {\r\n    this.layer.visible = !this.layer.visible;\r\n    if (this.toggleLegendOnVisibilityChange) {\r\n      this.toggleLegend(!this.layer.visible);\r\n    }\r\n    this.updateQueryBadge();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    if (\r\n      inResolutionRange === false &&\r\n      this.updateLegendOnResolutionChange === true\r\n    ) {\r\n      this.toggleLegend(true);\r\n    }\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n\r\n  private updateQueryBadge() {\r\n    const hidden =\r\n      this.queryBadge === false ||\r\n      this.layer.visible === false ||\r\n      !layerIsQueryable(this.layer);\r\n    this.queryBadgeHidden$.next(hidden);\r\n  }\r\n\r\n  toggleLayerTool() {\r\n    this.layerTool$.next(!this.layerTool$.getValue());\r\n    if (this.layerTool$.getValue() === true) {\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n    this.action.emit(this.layer);\r\n  }\r\n\r\n  public check() {\r\n    this.layerCheck = !this.layerCheck;\r\n    this.checkbox.emit({layer: this.layer, check: this.layerCheck});\r\n  }\r\n}\r\n","import { Component, Input, OnInit, OnDestroy, ChangeDetectionStrategy, ViewChildren, ElementRef, QueryList } from '@angular/core';\r\n\r\nimport { Subscription, BehaviorSubject, of, Observable } from 'rxjs';\r\n\r\nimport { Legend } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { Layer, ItemStyleOptions } from '../shared/layers';\r\nimport { CapabilitiesService } from '../../datasource/shared/capabilities.service';\r\nimport { map } from 'rxjs/operators';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend',\r\n  templateUrl: './layer-legend.component.html',\r\n  styleUrls: ['./layer-legend.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendComponent implements OnInit, OnDestroy {\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  /**\r\n   * Observable of the legend items\r\n   */\r\n  legendItems$: BehaviorSubject<Legend[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Subscription to the map's resolution\r\n   */\r\n  private resolution$$: Subscription;\r\n\r\n  /**\r\n   * The available styles\r\n   */\r\n  public styles;\r\n\r\n  /**\r\n   * The style used to make the legend\r\n   */\r\n  public currentStyle;\r\n\r\n  /**\r\n   * The scale used to make the legend\r\n   */\r\n  private scale: number = undefined;\r\n\r\n  /**\r\n   * Get list of images display\r\n   */\r\n  @ViewChildren('renderedLegend') renderedLegends: QueryList<ElementRef>;\r\n\r\n  /**\r\n   * List of size of images displayed\r\n   */\r\n  public imagesHeight: { [srcKey: string]: number } = {};\r\n\r\n  /**\r\n   * Layer\r\n   */\r\n  @Input() layer: Layer;\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    private languageService: LanguageService) {}\r\n\r\n  /**\r\n   * On init, subscribe to the map's resolution and update the legend accordingly\r\n   */\r\n  ngOnInit() {\r\n    let lastlLegend = this.layer.legend;\r\n    this.styles = this.listStyles();\r\n    const sourceOptions = this.layer.options.source.options as any;\r\n    if (\r\n      sourceOptions &&\r\n      sourceOptions.params &&\r\n      sourceOptions.params.STYLES) {\r\n      // if a styles is provided into the layers wms params\r\n      this.currentStyle = this.styles.find(style => style.name === sourceOptions.params.STYLES).name;\r\n    } else if (!this.layer.legend) {\r\n      // if no legend is manually provided\r\n      if (this.styles && this.styles.length > 1) {\r\n        this.currentStyle = this.styles[0].name;\r\n      }\r\n    } else if (this.styles && this.styles.length > 1) {\r\n      this.currentStyle = lastlLegend[0].currentStyle;\r\n    }\r\n\r\n    lastlLegend = this.layer.dataSource.getLegend(this.currentStyle, this.scale);\r\n    if (this.updateLegendOnResolutionChange === true) {\r\n      const resolution$ = this.layer.map.viewController.resolution$;\r\n      this.resolution$$ = resolution$.subscribe((resolution: number) => this.onResolutionChange(resolution));\r\n    } else if (lastlLegend.length !== 0) {\r\n      this.legendItems$.next(lastlLegend);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On destroy, unsubscribe to the map,s resolution\r\n   */\r\n  ngOnDestroy() {\r\n    if (this.resolution$$ !== undefined) {\r\n      this.resolution$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  toggleLegendItem(collapsed: boolean, item: Legend) {\r\n    item.collapsed = collapsed;\r\n  }\r\n\r\n  private transfertToggleLegendItem(newLegends: Legend[]): Legend[] {\r\n    const outLegends: Legend[] = newLegends;\r\n    const lastLegends = this.layer.legend;\r\n    for (let i = 0; i < lastLegends.length; i++) {\r\n      outLegends[i].collapsed = lastLegends[i].collapsed;\r\n   }\r\n    return outLegends;\r\n  }\r\n\r\n  computeItemTitle(layerLegend): Observable<string> {\r\n    const layerOptions = this.layer.dataSource.options as any;\r\n    if (layerOptions.type !== 'wms') {\r\n      return of(layerLegend.title);\r\n    }\r\n\r\n    const layers = layerOptions.params.LAYERS.split(',');\r\n    const localLayerOptions = JSON.parse(JSON.stringify(layerOptions)); // to avoid to alter the original options.\r\n    localLayerOptions.params.LAYERS = layers.find(layer => layer === layerLegend.title);\r\n    return this.capabilitiesService\r\n      .getWMSOptions(localLayerOptions)\r\n      .pipe(map(wmsDataSourceOptions => {\r\n        return wmsDataSourceOptions._layerOptionsFromSource.title;\r\n      }));\r\n  }\r\n\r\n  /**\r\n   * On resolution change, compute the effective scale level and update the\r\n   * legend accordingly.\r\n   * @param resolution Map resolution\r\n   */\r\n  private onResolutionChange(resolution: number) {\r\n    this.scale = this.layer.map.viewController.getScale();\r\n    this.updateLegend();\r\n  }\r\n\r\n  /**\r\n   * Update the legend with scale level and style define\r\n   */\r\n  private updateLegend() {\r\n    let legendItems = this.layer.dataSource.getLegend(this.currentStyle, this.scale);\r\n    if (this.layer.legend && this.layer.legend.length > 1) { legendItems = this.transfertToggleLegendItem(legendItems); }\r\n    this.layer.legend = legendItems;\r\n\r\n    if (legendItems.length === 0 && this.legendItems$.value.length === 0) {\r\n      return;\r\n    }\r\n    this.legendItems$.next(legendItems);\r\n  }\r\n\r\n  private listStyles() {\r\n    const layerOptions = this.layer.options;\r\n    if (layerOptions && layerOptions.legendOptions) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant('igo.geo.layer.legend.default');\r\n      const stylesAvailable =  [{ name: '', title } as ItemStyleOptions]\r\n        .concat(layerOptions.legendOptions.stylesAvailable.filter(sA => (\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'default' &&\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'defaut')));\r\n      stylesAvailable.map(s => s.title = s.title.charAt(0).toUpperCase() + s.title.slice(1).replace(/_/g, ' '));\r\n      return stylesAvailable;\r\n    }\r\n    return ;\r\n  }\r\n\r\n  onChangeStyle() {\r\n    this.updateLegend();\r\n    let STYLES = '';\r\n    this.layer.dataSource.ol.getParams().LAYERS.split(',').map(layer =>\r\n      STYLES += this.currentStyle + ','\r\n    );\r\n    STYLES = STYLES.slice(0, -1);\r\n    this.layer.dataSource.ol.updateParams({STYLES});\r\n  }\r\n\r\n  onLoadImage(id: string) {\r\n    let elemRef: HTMLImageElement;\r\n    if (this.renderedLegends.length === 1) {\r\n      elemRef = this.renderedLegends.first.nativeElement as HTMLImageElement;\r\n    } else {\r\n      elemRef = this.renderedLegends.find(renderedLegend => renderedLegend.nativeElement.id === id).nativeElement as HTMLImageElement;\r\n    }\r\n    this.imagesHeight[id] = elemRef.height;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-item',\r\n  templateUrl: './layer-legend-item.component.html',\r\n  styleUrls: ['./layer-legend-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendItemComponent implements OnInit, OnDestroy {\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  private resolution$$: Subscription;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  constructor(private networkService: NetworkService) {}\r\n\r\n  ngOnInit() {\r\n    this.layer.legendCollapsed = true;\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n}\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit, OnDestroy, EventEmitter, Output } from '@angular/core';\r\nimport { Layer } from '../shared';\r\nimport { BehaviorSubject, ReplaySubject, Subscription, EMPTY, timer } from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-list',\r\n  templateUrl: './layer-legend-list.component.html',\r\n  styleUrls: ['./layer-legend-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n\r\n  hasVisibleOrInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  hasVisibleAndNotInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  layersInUi$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  showAllLegend: boolean =  false;\r\n  public change$ = new ReplaySubject<void>(1);\r\n  private change$$: Subscription;\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() allowShowAllLegends: boolean = false;\r\n\r\n  @Input() showAllLegendsValue: boolean = false;\r\n\r\n  @Output() allLegendsShown = new EventEmitter<boolean>(false);\r\n\r\n  constructor() { }\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(debounce(() => {\r\n        return this.layers.length === 0 ? EMPTY : timer(50);\r\n      }))\r\n      .subscribe(() => {\r\n        const layers = this.computeShownLayers(this.layers.slice(0));\r\n        this.layers$.next(layers);\r\n        this.hasVisibleOrInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n        this.hasVisibleAndNotInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && !layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n\r\n        this.layersInUi$.next(\r\n          this.layers.slice(0).filter(layer => layer.showInLayerList !== false && (!this.excludeBaseLayers || !layer.baseLayer))\r\n        );\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n  private computeShownLayers(layers: Layer[]) {\r\n    let shownLayers = layers.filter((layer: Layer) => layer.visible && layer.isInResolutionsRange);\r\n    if (this.showAllLegendsValue) {\r\n      shownLayers = layers;\r\n    }\r\n    return this.sortLayersByZindex(shownLayers);\r\n  }\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  toggleShowAllLegends(toggle: boolean) {\r\n      this.showAllLegendsValue = toggle;\r\n      this.next();\r\n      this.allLegendsShown.emit(toggle);\r\n  }\r\n}\r\n","export enum LayerListControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  TemplateRef,\r\n  ContentChild,\r\n  OnInit,\r\n  OnDestroy,\r\n  Output,\r\n  EventEmitter,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material';\r\n\r\nimport { Layer } from '../shared';\r\nimport { LayerListControlsEnum } from './layer-list.enum';\r\nimport {\r\n  BehaviorSubject,\r\n  ReplaySubject,\r\n  Subscription,\r\n  EMPTY,\r\n  timer\r\n} from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../../metadata/shared/metadata.interface';\r\nimport { LayerListControlsOptions } from '../layer-list-tool/layer-list-tool.interface';\r\nimport { IgoMap } from '../../map/shared/map';\r\n\r\n// TODO: This class could use a clean up. Also, some methods could be moved ealsewhere\r\n@Component({\r\n  selector: 'igo-layer-list',\r\n  templateUrl: './layer-list.component.html',\r\n  styleUrls: ['./layer-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n  thresholdToFilterAndSort = 5;\r\n\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n\r\n  change$ = new ReplaySubject<void>(1);\r\n\r\n  showToolbar$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public layerTool: boolean;\r\n  activeLayer$: BehaviorSubject<Layer> = new BehaviorSubject(undefined);\r\n\r\n  layersChecked: Layer[] = [];\r\n  public selection;\r\n\r\n  private change$$: Subscription;\r\n\r\n  @ContentChild('igoLayerItemToolbar') templateLayerToolbar: TemplateRef<any>;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() ogcButton: boolean = true;\r\n\r\n  @Input() timeButton: boolean = true;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n\r\n  set activeLayer(value: Layer) {\r\n    this._activeLayer = value;\r\n    this.activeLayer$.next(value);\r\n  }\r\n  get activeLayer(): Layer {\r\n    return this._activeLayer;\r\n  }\r\n  private _activeLayer: Layer;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input() layerFilterAndSortOptions: LayerListControlsOptions = {};\r\n\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendOfVisibleLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n\r\n  get keyword(): string {\r\n    return this._keyword;\r\n  }\r\n  set keyword(value: string) {\r\n    this._keyword = value;\r\n    this.next();\r\n  }\r\n  private _keyword = undefined;\r\n\r\n  get onlyVisible(): boolean {\r\n    return this._onlyVisible;\r\n  }\r\n  set onlyVisible(value: boolean) {\r\n    this._onlyVisible = value;\r\n    this.next();\r\n  }\r\n  private _onlyVisible = false;\r\n\r\n  get sortAlpha(): boolean {\r\n    return this._sortedAlpha;\r\n  }\r\n  set sortAlpha(value: boolean) {\r\n    this._sortedAlpha = value;\r\n    this.next();\r\n  }\r\n  private _sortedAlpha = false;\r\n\r\n  get opacity() {\r\n    return Math.round(this.activeLayer$.getValue().opacity * 100);\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.activeLayer$.getValue().opacity = opacity / 100;\r\n  }\r\n\r\n  get badgeOpacity() {\r\n    if (this.opacity === 100) {\r\n      return;\r\n    }\r\n    return this.opacity;\r\n  }\r\n\r\n  get raiseDisabled(): boolean {\r\n    if (!this.orderable || this.activeLayer.baseLayer || this.getUpperLayer().id === this.activeLayer.id ||\r\n        this.isUpperBaselayer(this.activeLayer)) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabled(): boolean {\r\n    if (!this.orderable || this.activeLayer.baseLayer || this.getLowerLayer().id === this.activeLayer.id ||\r\n        this.isLowerBaselayer(this.activeLayer)) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get raiseDisabledSelection(): boolean {\r\n    if (this.layersChecked.length === 0 || !this.orderable || !this.raisableLayers(this.layersChecked) || this.selectAllCheck === true) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabledSelection(): boolean {\r\n    if (this.layersChecked.length === 0 || !this.orderable || !this.lowerableLayers(this.layersChecked) || this.selectAllCheck === true) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get checkOpacity() {\r\n    return this.layersCheckedOpacity() * 100;\r\n  }\r\n  set checkOpacity(opacity: number) {\r\n    for (const layer of this.layersChecked) {\r\n      layer.opacity = opacity / 100;\r\n    }\r\n  }\r\n\r\n  public toggleOpacity = false;\r\n\r\n  public selectAllCheck$ = new BehaviorSubject<boolean>(undefined);\r\n  selectAllCheck$$: Subscription;\r\n  public selectAllCheck;\r\n\r\n  constructor(\r\n    private elRef: ElementRef,\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(\r\n        debounce(() => {\r\n          return this.layers.length === 0 ? EMPTY : timer(50);\r\n        })\r\n      )\r\n      .subscribe(() => {\r\n        this.showToolbar$.next(this.computeShowToolbar());\r\n        this.layers$.next(this.computeLayers(this.layers.slice(0)));\r\n        this.appliedFilterAndSort.emit({\r\n          keyword: this.keyword,\r\n          sortAlpha: this.sortAlpha,\r\n          onlyVisible: this.onlyVisible\r\n        });\r\n      });\r\n\r\n    this.selectAllCheck$$ = this.selectAllCheck$.subscribe((value) => {\r\n      this.selectAllCheck = value;\r\n    });\r\n\r\n    this.layers$.subscribe(() => {\r\n      if (this.layers) {\r\n        let checks = 0;\r\n        for (const layer of this.layers) {\r\n          if (layer.options.active) {\r\n            this.activeLayer = layer;\r\n            this.layerTool = true;\r\n          }\r\n          if (layer.options.check) {\r\n            checks += 1;\r\n          }\r\n        }\r\n        if (this.excludeBaseLayers) {\r\n          this.selectAllCheck = checks === this.layers.filter(lay => lay.baseLayer !== true && lay.showInLayerList).length ? true : false;\r\n        } else {\r\n          this.selectAllCheck = checks === this.layers.filter(lay => lay.showInLayerList).length ? true : false;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n\r\n  clearKeyword() {\r\n    this.keyword = undefined;\r\n  }\r\n\r\n  getLowerLayer() {\r\n    return this.layers\r\n      .filter(l => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex < current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isLowerBaselayer(layer) {\r\n    const index = this.layers.findIndex(lay =>layer.id === lay.id);\r\n    if (this.layers && this.layers[index + 1] && this.layers[index + 1].baseLayer === true) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  getUpperLayer() {\r\n    return this.layers\r\n      .filter(l => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex > current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isUpperBaselayer(layer) {\r\n    const index = this.layers.findIndex(lay =>layer.id === lay.id);\r\n    if (this.layers && this.layers[index - 1] && this.layers[index - 1].baseLayer === true) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  raisableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex(lay =>layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const previousLayer = this.layers[mapIndex - 1];\r\n      if (previousLayer && previousLayer.baseLayer !== true && !layers.find(lay => previousLayer.id === lay.id) &&\r\n            currentLayer.baseLayer !== true) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if ((this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) || base === this.layersChecked.length) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  raisableLayer(index: number) {\r\n    if (index < 1) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index - 1].options.check) {\r\n      return this.raisableLayer(index - 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  raiseLayers(layers: Layer[]) {\r\n    const layersToRaise = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex(lay => lay.id === layer.id);\r\n      if (this.raisableLayer(index)) {\r\n        layersToRaise.push(layer);\r\n      }\r\n    }\r\n    this.map.raiseLayers(layersToRaise);\r\n    setTimeout(() => {\r\n      const elements = this.computeElementRef();\r\n      if (!this.isScrolledIntoView(elements[0], elements[1].offsetParent)) {\r\n        elements[0].scrollTop = elements[1].offsetParent.offsetTop;\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  lowerableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex(lay =>layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const nextLayer = this.layers[mapIndex + 1];\r\n      if (nextLayer && nextLayer.baseLayer !== true && !layers.find(lay => nextLayer.id === lay.id)) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if ((this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) || base === this.layersChecked.length) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  lowerableLayer(index: number) {\r\n    if (index > this.layers.filter(lay => lay.baseLayer !== true).length - 2) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index + 1].options.check) {\r\n      return this.lowerableLayer(index + 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  lowerLayers(layers: Layer[]) {\r\n    const layersToLower = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex(lay => lay.id === layer.id);\r\n      if (this.lowerableLayer(index)) {\r\n        layersToLower.push(layer);\r\n      }\r\n    }\r\n    this.map.lowerLayers(layersToLower);\r\n    setTimeout(() => {\r\n      const elements = this.computeElementRef('lower');\r\n      if (!this.isScrolledIntoView(elements[0], elements[1].offsetParent)) {\r\n        elements[0].scrollTop = elements[1].offsetParent.offsetTop + elements[1].offsetParent.offsetHeight - elements[0].clientHeight;\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n  private computeLayers(layers: Layer[]): Layer[] {\r\n    let layersOut = this.filterLayers(layers);\r\n    if (this.sortAlpha) {\r\n      layersOut = this.sortLayersByTitle(layersOut);\r\n    } else {\r\n      layersOut = this.sortLayersByZindex(layersOut);\r\n    }\r\n    return layersOut;\r\n  }\r\n\r\n  onKeywordChange(term) {\r\n    this.keyword = term;\r\n  }\r\n\r\n  onAppliedFilterAndSortChange(appliedFilter: LayerListControlsOptions) {\r\n    this.keyword = appliedFilter.keyword;\r\n    this.onlyVisible = appliedFilter.onlyVisible;\r\n    this.sortAlpha = appliedFilter.sortAlpha;\r\n  }\r\n\r\n  private filterLayers(layers: Layer[]): Layer[] {\r\n    if (\r\n      this.layerFilterAndSortOptions.showToolbar === LayerListControlsEnum.never\r\n    ) {\r\n      return layers;\r\n    }\r\n    if (!this.keyword && !this.onlyVisible) {\r\n      return layers;\r\n    }\r\n\r\n    const keepLayerIds = layers.map((layer: Layer) => layer.id);\r\n\r\n    layers.forEach((layer: Layer) => {\r\n      const layerOptions = (layer.options as MetadataLayerOptions) || {};\r\n      const dataSourceOptions = layer.dataSource.options || {};\r\n      const metadata = layerOptions.metadata || ({} as MetadataOptions);\r\n      const keywords = metadata.keywordList || [];\r\n      const layerKeywords = keywords.map((kw: string) => {\r\n        return kw.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      });\r\n\r\n      if (this.keyword && layer.title) {\r\n        const localKeyword = this.keyword\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const layerTitle = layer.title\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const dataSourceType = dataSourceOptions.type || '';\r\n        const keywordRegex = new RegExp(localKeyword, 'gi');\r\n        const keywordInList =\r\n          layerKeywords.find((kw: string) => keywordRegex.test(kw)) !==\r\n          undefined;\r\n        if (\r\n          !keywordRegex.test(layerTitle) &&\r\n          !(this.keyword.toLowerCase() === dataSourceType.toLowerCase()) &&\r\n          !keywordInList\r\n        ) {\r\n          const index = keepLayerIds.indexOf(layer.id);\r\n          if (index > -1) {\r\n            keepLayerIds.splice(index, 1);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.onlyVisible && layer.visible === false) {\r\n        const index = keepLayerIds.indexOf(layer.id);\r\n        if (index > -1) {\r\n          keepLayerIds.splice(index, 1);\r\n        }\r\n      }\r\n    });\r\n\r\n    return layers.filter(\r\n      (layer: Layer) => keepLayerIds.indexOf(layer.id) !== -1\r\n    );\r\n  }\r\n\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  private sortLayersByTitle(layers: Layer[]) {\r\n    return layers.sort((a, b) => {\r\n      if (this.normalize(a.title) < this.normalize(b.title)) {\r\n        return -1;\r\n      }\r\n      if (this.normalize(a.title) > this.normalize(b.title)) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n  }\r\n\r\n  private normalize(str: string) {\r\n    return str.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').toLowerCase();\r\n  }\r\n\r\n  private computeShowToolbar(): boolean {\r\n    switch (this.layerFilterAndSortOptions.showToolbar) {\r\n      case LayerListControlsEnum.always:\r\n        return true;\r\n      case LayerListControlsEnum.never:\r\n        return false;\r\n      default:\r\n        if (\r\n          this.layers.length >= this.thresholdToFilterAndSort ||\r\n          this.keyword ||\r\n          this.onlyVisible\r\n        ) {\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  }\r\n\r\n  toggleLayerTool(layer) {\r\n    this.toggleOpacity = false;\r\n    if (this.layerTool && layer === this.activeLayer) {\r\n      this.layerTool = false;\r\n    } else {\r\n      this.layerTool = true;\r\n    }\r\n\r\n    for (const lay of this.layers) {\r\n      lay.options.active = false;\r\n    }\r\n    layer.options.active = true;\r\n    this.activeLayer = layer;\r\n    return;\r\n  }\r\n\r\n  removeLayers(layers?: Layer[]) {\r\n    if (layers && layers.length > 0) {\r\n      for (const layer of layers) {\r\n        layer.map.removeLayer(layer);\r\n      }\r\n      this.layersChecked = [];\r\n    } else if (!layers) {\r\n      this.activeLayer.map.removeLayer(this.activeLayer);\r\n      this.layerTool = false;\r\n    }\r\n    return;\r\n  }\r\n\r\n  layersCheck(event: {layer: Layer; check: boolean}) {\r\n    event.layer.options.check = event.check;\r\n    if (event.check === true) {\r\n      const eventMapIndex = this.layers.findIndex(layer =>event.layer.id === layer.id);\r\n      for (const layer of this.layersChecked) {\r\n        const mapIndex = this.layers.findIndex(lay =>layer.id === lay.id);\r\n        if (eventMapIndex < mapIndex) {\r\n          this.layersChecked.splice(this.layersChecked.findIndex(lay =>layer.id === lay.id), 0, event.layer);\r\n\r\n          if (this.excludeBaseLayers) {\r\n            if (this.layersChecked.length === this.layers.filter(lay => (lay.baseLayer !== true && lay.showInLayerList)).length) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          } else if (!this.excludeBaseLayers) {\r\n            if (this.layersChecked.length === this.layers.filter(lay => lay.showInLayerList).length) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          }\r\n          return;\r\n        }\r\n      }\r\n      this.layersChecked.push(event.layer);\r\n    } else {\r\n      const index = this.layersChecked.findIndex(layer => event.layer.id === layer.id);\r\n      this.layersChecked.splice(index, 1);\r\n    }\r\n\r\n    if (this.excludeBaseLayers) {\r\n      if (this.layersChecked.length === this.layers.filter(lay => (lay.baseLayer !== true && lay.showInLayerList)).length) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    } else if (!this.excludeBaseLayers) {\r\n      if (this.layersChecked.length === this.layers.filter(lay => lay.showInLayerList).length) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  toggleSelectionMode(value: boolean) {\r\n    this.selection = value;\r\n    this.activeLayer = undefined;\r\n    if (value === true) {\r\n      this.layerTool = false;\r\n      for (const layer of this.layers) {\r\n        if (layer.options.check) {\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  layersCheckedOpacity(): any {\r\n    if (this.layersChecked.length > 1) {\r\n      return 1;\r\n    } else {\r\n      const opacity = [];\r\n      for (const layer of this.layersChecked) {\r\n        opacity.push(layer.opacity);\r\n      }\r\n      return opacity;\r\n    }\r\n  }\r\n\r\n  selectAll() {\r\n    if (!this.selectAllCheck) {\r\n      for (const layer of this.layers) {\r\n        if (this.excludeBaseLayers && layer.baseLayer !== true && layer.showInLayerList) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        } else if (!this.excludeBaseLayers && layer.showInLayerList) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n      this.selectAllCheck$.next(true);\r\n    } else {\r\n      for (const layer of this.layers) {\r\n        layer.options.check = false;\r\n      }\r\n      this.layersChecked = [];\r\n      this.selectAllCheck$.next(false);\r\n    }\r\n  }\r\n\r\n  isScrolledIntoView(elemSource, elem) {\r\n    const docViewTop = elemSource.scrollTop;\r\n    const docViewBottom = docViewTop + elemSource.clientHeight;\r\n\r\n    const elemTop = elem.offsetTop;\r\n    const elemBottom = elemTop + elem.clientHeight;\r\n    return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop));\r\n  }\r\n\r\n  computeElementRef(type?: string) {\r\n    const checkItems = this.elRef.nativeElement.getElementsByClassName('mat-checkbox-checked');\r\n    const checkItem = type === 'lower' ? this.elRef.nativeElement.getElementsByClassName('mat-checkbox-checked')[checkItems.length - 1] :\r\n      this.elRef.nativeElement.getElementsByClassName('mat-checkbox-checked')[0];\r\n    const igoList = this.elRef.nativeElement.getElementsByTagName('igo-list')[0];\r\n\r\n    return [igoList, checkItem];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { IgoMap } from './map';\r\n\r\n/**\r\n * MapService\r\n *\r\n * This service tracks the IgoMap instance, if any.\r\n * Currently, only one map instance is supported\r\n * but support for multiple maps may be added in the future.\r\n * This will impact other services such as the OverlayService\r\n * because these maps won't be sharing overlayed features.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MapService {\r\n  private map: IgoMap;\r\n\r\n  constructor() {}\r\n\r\n  getMap(): IgoMap {\r\n    return this.map;\r\n  }\r\n\r\n  setMap(map: IgoMap) {\r\n    this.map = map;\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy, Optional } from '@angular/core';\r\nimport { Subscription, combineLatest } from 'rxjs';\r\n\r\nimport { RouteService } from '@igo2/core';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { LayerListComponent } from './layer-list.component';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { map, debounceTime } from 'rxjs/operators';\r\n\r\n@Directive({\r\n  selector: '[igoLayerListBinding]'\r\n})\r\nexport class LayerListBindingDirective implements OnInit, OnDestroy {\r\n  private component: LayerListComponent;\r\n  private layersOrResolutionChange$$: Subscription;\r\n  layersVisibility$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() component: LayerListComponent,\r\n    private mapService: MapService,\r\n    @Optional() private route: RouteService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input layers\r\n    // this.component.layers = [];\r\n    this.layersOrResolutionChange$$ = combineLatest([\r\n      this.mapService.getMap().layers$,\r\n      this.mapService.getMap().viewController.resolution$]\r\n    ).pipe(\r\n      debounceTime(10)\r\n    ).subscribe((bunch: [Layer[], number]) => {\r\n      const shownLayers = bunch[0].filter((layer: Layer) => {\r\n        return layer.showInLayerList === true;\r\n      });\r\n      this.component.layers = shownLayers;\r\n      this.setLayersVisibilityStatus(shownLayers, this.component.excludeBaseLayers);\r\n    });\r\n  }\r\n\r\n  private setLayersVisibilityStatus(layers: Layer[], excludeBaseLayers: boolean) {\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n    this.layersVisibility$$ = combineLatest(layers\r\n      .filter(layer => layer.baseLayer !== excludeBaseLayers )\r\n      .map((layer: Layer) => layer.visible$))\r\n      .pipe(map((visibles: boolean[]) => visibles.every(Boolean)))\r\n      .subscribe((allLayersAreVisible: boolean) =>\r\n        this.component.layersAreAllVisible = allLayersAreVisible);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layersOrResolutionChange$$.unsubscribe();\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n  }\r\n\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  EventEmitter,\r\n  Output,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material';\r\n\r\nimport {\r\n  BehaviorSubject,\r\n  Subscription,\r\n} from 'rxjs';\r\nimport { LayerListControlsOptions } from './layer-list-tool.interface';\r\n\r\n@Component({\r\n  selector: 'igo-layer-list-tool',\r\n  templateUrl: './layer-list-tool.component.html',\r\n  styleUrls: ['./layer-list-tool.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListToolComponent implements OnInit, OnDestroy {\r\n\r\n  public onlyVisible$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public sortAlpha$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public term$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n  onlyVisible$$: Subscription;\r\n  sortAlpha$$: Subscription;\r\n  term$$: Subscription;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input()\r\n  set onlyVisible(value: boolean) {\r\n    this.onlyVisible$.next(value);\r\n  }\r\n  get onlyVisible(): boolean {\r\n    return this.onlyVisible$.value;\r\n  }\r\n\r\n  @Input()\r\n  set sortAlpha(value: boolean) {\r\n    this.sortAlpha$.next(value);\r\n  }\r\n  get sortAlpha(): boolean {\r\n    return this.sortAlpha$.value;\r\n  }\r\n\r\n  @Input()\r\n  set term(value: string) {\r\n    this.term$.next(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n\r\n  public selectionMode = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n  @Output() selection = new EventEmitter<boolean>();\r\n\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe(keyword => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha: this.sortAlpha});\r\n    });\r\n\r\n    this.onlyVisible$$ = this.onlyVisible$.subscribe(onlyVisible => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible,\r\n        sortAlpha: this.sortAlpha});\r\n    });\r\n    this.sortAlpha$$ = this.sortAlpha$.subscribe(sortAlpha => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha});\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.onlyVisible$$.unsubscribe();\r\n    this.sortAlpha$$.unsubscribe();\r\n    this.term$$.unsubscribe();\r\n  }\r\n\r\n  clearTerm() {\r\n    this.term = undefined;\r\n  }\r\n  toggleSortAlpha() {\r\n    this.sortAlpha = !this.sortAlpha;\r\n  }\r\n\r\n  toggleOnlyVisible() {\r\n    this.onlyVisible = !this.onlyVisible;\r\n  }\r\n\r\n  toggleSelectionMode() {\r\n    this.selectionMode = !this.selectionMode;\r\n    this.selection.emit(this.selectionMode);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerListToolService {\r\n  public keyword: string;\r\n  public sortAlpha = false;\r\n  public onlyVisible = false;\r\n  public onlyInRange = false;\r\n  public keywordInitialized = false;\r\n  public sortedAlphaInitialized = false;\r\n  public onlyVisibleInitialized = false;\r\n  public onlyInRangeInitialized = false;\r\n\r\n  constructor() {}\r\n\r\n}\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer, VectorLayer } from '../shared/layers';\r\nimport { VectorLayerOptions } from '../shared/layers/vector-layer.interface';\r\n\r\n@Component({\r\n  selector: 'igo-track-feature-button',\r\n  templateUrl: './track-feature-button.component.html',\r\n  styleUrls: ['./track-feature-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TrackFeatureButtonComponent implements OnInit {\r\n\r\n  @Input() layer: VectorLayer;\r\n\r\n  @Input() trackFeature = false;\r\n\r\n  get options(): VectorLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n\r\n  public color: string = 'primary';\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.color = this.trackFeature ? 'primary' : 'basic';\r\n  }\r\n\r\n  toggleTrackFeature() {\r\n    if (this.trackFeature) {\r\n      this.layer.disableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'basic';\r\n    } else {\r\n      this.layer.enableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'primary';\r\n    }\r\n    this.trackFeature = !this.trackFeature;\r\n  }\r\n}\r\n","import { Subscription } from 'rxjs';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureMotion } from '../feature.enums';\r\nimport { Feature, FeatureStoreLoadingStrategyOptions } from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\n\r\n/**\r\n * This strategy loads a store's features into it's layer counterpart.\r\n * The store -> layer binding is a one-way binding. That means any entity\r\n * added to the store will be added to the layer but the opposite is false.\r\n *\r\n * Important: This strategy observes filtered entities, not raw entities. This\r\n * is not configurable yet.\r\n */\r\nexport class FeatureStoreLoadingStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's features\r\n   */\r\n  private stores$$ = new Map<FeatureStore, Subscription>();\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  constructor(protected options: FeatureStoreLoadingStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on load\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for entities changes in a store.\r\n   * Important: Never observe a store's sorted entities. It makes no sense\r\n   * to display sorted entities (instead of unsorted) on a layer and it\r\n   * would potentially result in a lot of useless computation.\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    const subscription = store.view.all$()\r\n      .subscribe((features: Feature[]) => this.onFeaturesChange(features, store));\r\n    this.stores$$.set(store, subscription);\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in a store.\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const subscription = this.stores$$.get(store);\r\n    if (subscription !== undefined) {\r\n      subscription.unsubscribe();\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, Subscription]) => {\r\n      entries[1].unsubscribe();\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features into a layer or clear the layer if the array of features is empty.\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onFeaturesChange(features: Feature[], store: FeatureStore) {\r\n    if (features.length === 0) {\r\n      store.clearLayer();\r\n    } else {\r\n      store.setLayerFeatures(\r\n        features,\r\n        this.selectMotion(store),\r\n        this.options.viewScale,\r\n        this.options.areaRatio,\r\n        this.options.getFeatureId\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Selects the best motion\r\n   * @param store A FeatureStore to apply the motion\r\n   * @returns The motion selected\r\n   */\r\n  private selectMotion(store: FeatureStore) {\r\n    if (this.motion !== undefined) { return this.motion; }\r\n\r\n    if (store.pristine === true) {\r\n      // If features have just been loaded into the store, move/zoom on them\r\n      return FeatureMotion.Default;\r\n    } else if (store.count > store.view.count) {\r\n      // If features have been filtered, move/zoom on the remaining ones\r\n      return FeatureMotion.Default;\r\n    } else {\r\n      // On insert, update or delete, do nothing\r\n      return FeatureMotion.None;\r\n    }\r\n  }\r\n}\r\n","import { unByKey } from 'ol/Observable';\r\nimport { OlEvent } from 'ol/events/Event';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreLoadingLayerStrategyOptions } from '../feature.interfaces';\r\n\r\n/**\r\n * This strategy loads a layer's features into it's store counterpart.\r\n * The layer -> store binding is a one-way binding. That means any OL feature\r\n * added to the layer will be added to the store but the opposite is false.\r\n *\r\n * Important: In it's current state, this strategy is to meant to be combined\r\n * with a standard Loading strategy and it would probably cause recursion issues.\r\n */\r\nexport class FeatureStoreLoadingLayerStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n\r\n  constructor(protected options: FeatureStoreLoadingLayerStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.onSourceChanges(store);\r\n    const olSource = store.layer.ol.getSource();\r\n    olSource.on('change', (event: OlEvent) => {\r\n      this.onSourceChanges(store);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      unByKey(key);\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, string]) => {\r\n      unByKey(entries[1]);\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features from an OL source into a  store or clear the store if the source is empty\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onSourceChanges(store: FeatureStore) {\r\n    const olFeatures = store.layer.ol.getSource().getFeatures();\r\n    if (olFeatures.length === 0) {\r\n      store.clear();\r\n    } else {\r\n      store.setStoreOlFeatures(olFeatures);\r\n    }\r\n  }\r\n}\r\n","import OlFeature from 'ol/Feature';\r\n\r\nimport {\r\n  getEntityId,\r\n  EntityKey,\r\n  EntityStore\r\n} from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { FeatureMotion } from './feature.enums';\r\nimport { Feature, FeatureStoreOptions } from './feature.interfaces';\r\nimport { computeOlFeaturesDiff, featureFromOl, featureToOl, moveToOlFeatures } from './feature.utils';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * features and the map layer to display them on. Synchronization\r\n * between the store and the layer is handled by strategies.\r\n */\r\nexport class FeatureStore<T extends Feature = Feature> extends EntityStore<T> {\r\n\r\n  /**\r\n   * Vector layer to display the features on\r\n   */\r\n  layer: VectorLayer;\r\n\r\n  /**\r\n   * The map the layer is bound to\r\n   */\r\n  readonly map: IgoMap;\r\n\r\n  /**\r\n   * The layer's data source\r\n   */\r\n  get source(): FeatureDataSource {\r\n    return this.layer ? this.layer.dataSource as FeatureDataSource : undefined;\r\n  }\r\n\r\n  constructor(entities: T[], options: FeatureStoreOptions) {\r\n    super(entities, options);\r\n    this.map = options.map;\r\n  }\r\n\r\n  /**\r\n   * Bind this store to a vector layer\r\n   * @param layer Vector layer\r\n   * @returns Feature store\r\n   */\r\n  bindLayer(layer: VectorLayer): FeatureStore {\r\n    this.layer = layer;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible. Strategies\r\n   * make extensive use of that method.\r\n   * @param features Features\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  setLayerFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number,\r\n    getId?: (Feature) => EntityKey\r\n  ) {\r\n    getId = getId ? getId : getEntityId;\r\n    this.checkLayer();\r\n\r\n    const olFeatures = features\r\n      .map((feature: Feature) => featureToOl(feature, this.map.projection, getId));\r\n    this.setLayerOlFeatures(olFeatures, motion, viewScale, areaRatio);\r\n  }\r\n\r\n  /**\r\n   * Set the store's features from an array of OL features.\r\n   * @param olFeatures Ol features\r\n   */\r\n  setStoreOlFeatures(olFeatures: OlFeature[]) {\r\n    this.checkLayer();\r\n\r\n    const features = olFeatures.map((olFeature: OlFeature) => {\r\n      olFeature.set('_featureStore', this, true);\r\n      return featureFromOl(olFeature, this.layer.map.projection);\r\n    });\r\n    this.load(features as T[]);\r\n  }\r\n\r\n  /**\r\n   * Remove all features from the layer\r\n   */\r\n  clearLayer() {\r\n    this.checkLayer();\r\n    this.source.ol.clear();\r\n  }\r\n\r\n  /**\r\n   * Check wether a layer is bound or not and throw an error if not.\r\n   */\r\n  private checkLayer() {\r\n    if (this.layer === undefined) {\r\n      throw new Error('This FeatureStore is not bound to a layer.');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible.\r\n   * @param features Openlayers feature objects\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  private setLayerOlFeatures(\r\n    olFeatures: OlFeature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number\r\n  ) {\r\n    const olSource = this.layer.ol.getSource();\r\n    const diff = computeOlFeaturesDiff(olSource.getFeatures(), olFeatures);\r\n    if (diff.remove.length > 0) {\r\n      this.removeOlFeaturesFromLayer(diff.remove);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      this.addOlFeaturesToLayer(diff.add);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      // If features are added, do a motion toward the newly added features\r\n      moveToOlFeatures(this.map, diff.add, motion, viewScale, areaRatio);\r\n    } else if (diff.remove.length > 0) {\r\n      // Else, do a motion toward all the features\r\n      moveToOlFeatures(this.map, olFeatures, motion, viewScale, areaRatio);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add features to the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private addOlFeaturesToLayer(olFeatures: OlFeature[]) {\r\n    olFeatures.forEach((olFeature: OlFeature) => {\r\n      olFeature.set('_featureStore', this, true);\r\n    });\r\n    this.source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private removeOlFeaturesFromLayer(olFeatures: OlFeature[]) {\r\n    olFeatures.forEach((olFeature: OlFeature) => {\r\n      this.source.ol.removeFeature(olFeature);\r\n    });\r\n  }\r\n\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport OlDragBoxInteraction from 'ol/interaction/DragBox';\r\nimport { DragBoxEvent as OlDragBoxEvent } from 'ol/interaction/DragBox';\r\nimport { ListenerFunction } from 'ol/events';\r\nimport { MapBrowserPointerEvent as OlMapBrowserPointerEvent } from 'ol/MapBrowserEvent';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subscription, combineLatest } from 'rxjs';\r\nimport { map, debounceTime, skip } from 'rxjs/operators';\r\n\r\nimport { EntityKey, EntityRecord, EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../../datasource';\r\nimport { VectorLayer } from '../../../layer';\r\nimport { IgoMap, ctrlKeyDown } from '../../../map';\r\n\r\nimport { Feature, FeatureStoreSelectionStrategyOptions } from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureMotion } from '../feature.enums';\r\n\r\nclass OlDragSelectInteraction extends OlDragBoxInteraction {\r\n  constructor(options) {\r\n    super(options);\r\n  }\r\n}\r\n\r\n/**\r\n * This strategy synchronizes a store and a layer selected entities.\r\n * The store <-> layer binding is a two-way binding.\r\n *\r\n * In many cases, a single strategy bound to multiple stores\r\n * will yield better results that multiple strategies with each their\r\n * own store. In the latter scenario, a click on overlapping features\r\n * would trigger the strategy of each layer and they would cancel\r\n * each other as well as move the map view around needlessly.\r\n */\r\nexport class FeatureStoreSelectionStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Listener to the map click event that allows selecting a feature\r\n   * by clicking on the map\r\n   */\r\n  private mapClickListener: ListenerFunction;\r\n\r\n  private olDragSelectInteraction: OlDragSelectInteraction;\r\n\r\n  private olDragSelectInteractionEndKey: string;\r\n\r\n  /**\r\n   * Subscription to all stores selected entities\r\n   */\r\n  private stores$$: Subscription;\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  /**\r\n   * The map the layers belong to\r\n   */\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  /**\r\n   * A feature store that'll contain the selected features. It has it's own\r\n   * layer, shared by all the stores this staretgy is bound to.\r\n   */\r\n  get overlayStore(): FeatureStore { return this._overlayStore; }\r\n  private _overlayStore: FeatureStore;\r\n\r\n  constructor(protected options: FeatureStoreSelectionStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n    this._overlayStore = this.createOverlayStore();\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on select\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Unselect all entities, from all stores\r\n   */\r\n  unselectAll() {\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      store.state.updateAll({selected: false});\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.overlayStore.clear();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the selection without removing the selection\r\n   * overlay.\r\n   */\r\n  deactivateSelection() {\r\n    this.unlistenToMapClick();\r\n    this.removeDragBoxInteraction();\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer, setup the map click lsitener and\r\n   * start watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.addOverlayLayer();\r\n    this.listenToMapClick();\r\n    if (this.options.dragBox === true) {\r\n      this.addDragBoxInteraction();\r\n    }\r\n    this.watchAll();\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer, remove the map click lsitener and\r\n   * stop watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.deactivateSelection();\r\n    this.removeOverlayLayer();\r\n  }\r\n\r\n  /**\r\n   * Create a single observable of all the stores. With a single observable,\r\n   * features can be added all at once to the overlay layer and a single\r\n   * motion can be performed. Multiple observable would have\r\n   * a cancelling effect on each other.\r\n   */\r\n  private watchAll() {\r\n    this.unwatchAll();\r\n\r\n    const stores$ = this.stores.map((store: FeatureStore) => {\r\n      return store.stateView.manyBy$((record: EntityRecord<Feature>) => {\r\n        return record.state.selected === true;\r\n      }).pipe(\r\n        map((records: EntityRecord<Feature>[]) => records.map(record => record.entity))\r\n      );\r\n    });\r\n    this.stores$$ = combineLatest(stores$)\r\n      .pipe(\r\n        debounceTime(5),\r\n        skip(1), // Skip intial selection\r\n        map((features: Array<Feature[]>) => features.reduce((a, b) => a.concat(b)))\r\n      ).subscribe((features: Feature[]) => this.onSelectFromStore(features));\r\n  }\r\n\r\n  /**\r\n   * Stop watching for selection in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    if (this.stores$$ !== undefined) {\r\n      this.stores$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a 'singleclick' listener to the map that'll allow selecting\r\n   * features by clicking on the map. The selection will be performed\r\n   * only on the layers bound to this strategy.\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on('singleclick', (event: OlMapBrowserPointerEvent) => {\r\n      this.onMapClick(event);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove the map click listener\r\n   */\r\n  private unlistenToMapClick() {\r\n    if (this.mapClickListener !== undefined) {\r\n      this.map.ol.un(\r\n        this.mapClickListener.type,\r\n        this.mapClickListener.listener\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On map click, select feature at pixel\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onMapClick(event: OlMapBrowserPointerEvent) {\r\n    const exclusive = !ctrlKeyDown(event);\r\n    const reverse = !exclusive;\r\n    const olFeatures = event.map.getFeaturesAtPixel(event.pixel, {\r\n      hitTolerance: this.options.hitTolerance || 0,\r\n      layerFilter: (olLayer) => {\r\n        const storeOlLayer = this.stores.find((store: FeatureStore) => {\r\n          return store.layer.ol === olLayer;\r\n        });\r\n        return storeOlLayer !== undefined;\r\n      }\r\n    });\r\n    this.onSelectFromMap(olFeatures, exclusive, reverse);\r\n  }\r\n\r\n  /**\r\n   * Add a drag box interaction and, on drag box end, select features\r\n   */\r\n  private addDragBoxInteraction() {\r\n    let olDragSelectInteraction;\r\n    const olInteractions = this.map.ol.getInteractions().getArray();\r\n\r\n    // There can only be one dragbox interaction, so find the current one, if any\r\n    // Don't keep a reference to the current dragbox because we don't want\r\n    // to remove it when this startegy is deactivated\r\n    for (const olInteraction of olInteractions) {\r\n      if (olInteraction instanceof OlDragSelectInteraction) {\r\n        olDragSelectInteraction = olInteraction;\r\n        break;\r\n      }\r\n    }\r\n    // If no drag box interaction is found, create a new one and add it to the map\r\n    if (olDragSelectInteraction === undefined) {\r\n      olDragSelectInteraction = new OlDragSelectInteraction({\r\n        condition: ctrlKeyDown\r\n      });\r\n      this.map.ol.addInteraction(olDragSelectInteraction);\r\n      this.olDragSelectInteraction = olDragSelectInteraction;\r\n    }\r\n\r\n    this.olDragSelectInteractionEndKey = olDragSelectInteraction.on(\r\n      'boxend',\r\n      (event: OlMapBrowserPointerEvent) => this.onDragBoxEnd(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove drag box interaction\r\n   */\r\n  private removeDragBoxInteraction() {\r\n    if (this.olDragSelectInteractionEndKey !== undefined) {\r\n      unByKey(this.olDragSelectInteractionEndKey);\r\n    }\r\n    if (this.olDragSelectInteraction !== undefined) {\r\n      this.map.ol.removeInteraction(this.olDragSelectInteraction);\r\n    }\r\n    this.olDragSelectInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * On dragbox end, select features in drag box\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onDragBoxEnd(event: OlDragBoxEvent) {\r\n    const exclusive = !ctrlKeyDown(event.mapBrowserEvent);\r\n    const extent = event.target.getGeometry().getExtent();\r\n    const olFeatures = this.stores.reduce((acc: OlFeature[], store: FeatureStore) => {\r\n      const olSource = store.layer.ol.getSource();\r\n      acc.push(...olSource.getFeaturesInExtent(extent));\r\n      return acc;\r\n    }, []);\r\n    this.onSelectFromMap(olFeatures, exclusive, false);\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the store, add\r\n   * them to this startegy's overlay layer (select on map)\r\n   * @param features Store features\r\n   */\r\n  private onSelectFromStore(features: Feature[]) {\r\n    const motion = this.motion;\r\n    const olOverlayFeatures = this.overlayStore.layer.ol.getSource().getFeatures();\r\n    const overlayFeaturesKeys = olOverlayFeatures.map((olFeature: OlFeature) => olFeature.getId());\r\n    const featuresKeys = features.map(this.overlayStore.getKey);\r\n\r\n    let doMotion;\r\n    if (features.length === 0) {\r\n      doMotion = false;\r\n    } else {\r\n      doMotion = overlayFeaturesKeys.length !== featuresKeys.length ||\r\n        !overlayFeaturesKeys.every((key: EntityKey) => featuresKeys.indexOf(key) >= 0);\r\n    }\r\n\r\n    this.overlayStore.setLayerFeatures(\r\n      features,\r\n      doMotion ? motion : FeatureMotion.None,\r\n      this.options.viewScale,\r\n      this.options.areaRatio,\r\n      this.options.getFeatureId\r\n    );\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the map, also select them\r\n   * in their store.\r\n   * @param olFeatures OL feature objects\r\n   */\r\n  private onSelectFromMap(olFeatures: OlFeature[], exclusive: boolean, reverse: boolean) {\r\n    const groupedFeatures = this.groupFeaturesByStore(olFeatures);\r\n\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      const features = groupedFeatures.get(store);\r\n      if (features === undefined && exclusive === true) {\r\n        this.unselectAllFeaturesFromStore(store);\r\n      } else if (features === undefined && exclusive === false) {\r\n        // Do nothing\r\n      } else {\r\n        this.selectFeaturesFromStore(store, features, exclusive, reverse);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Select features in store\r\n   * @param store: Feature store\r\n   * @param features Features\r\n   */\r\n  private selectFeaturesFromStore(store: FeatureStore, features: Feature[], exclusive: boolean, reverse: boolean) {\r\n    if (reverse === true) {\r\n      store.state.reverseMany(features, ['selected']);\r\n    } else {\r\n      store.state.updateMany(features, {selected: true}, exclusive);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unselect all features from store\r\n   * @param store: Feature store\r\n   */\r\n  private unselectAllFeaturesFromStore(store: FeatureStore) {\r\n    store.state.updateAll({selected: false});\r\n  }\r\n\r\n  /**\r\n   * This method returns a store -> features mapping from a list\r\n   * of OL selected features. OL features keep a reference to the store\r\n   * they are from.\r\n   * @param olFeatures: OL feature objects\r\n   * @returns Store -> features mapping\r\n   */\r\n  private groupFeaturesByStore(olFeatures: OlFeature[]): Map<FeatureStore, Feature[]> {\r\n    const groupedFeatures = new Map<FeatureStore, Feature[]>();\r\n    if (olFeatures === null || olFeatures === undefined) {\r\n      return groupedFeatures;\r\n    }\r\n\r\n    olFeatures.forEach((olFeature: OlFeature) => {\r\n      const store = olFeature.get('_featureStore');\r\n      if (store === undefined) { return; }\r\n\r\n      let features = groupedFeatures.get(store);\r\n      if (features === undefined) {\r\n        features = [];\r\n        groupedFeatures.set(store, features);\r\n      }\r\n\r\n      const feature = store.get(olFeature.getId());\r\n      if (feature !== undefined) {\r\n        features.push(feature);\r\n      }\r\n    });\r\n\r\n    return groupedFeatures;\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay store\r\n   */\r\n  private createOverlayStore(): FeatureStore {\r\n    const overlayLayer = this.options.layer\r\n      ? this.options.layer\r\n      : this.createOverlayLayer();\r\n    return new FeatureStore([], {map: this.map}).bindLayer(overlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay layer\r\n   */\r\n  private createOverlayLayer(): VectorLayer {\r\n    return new VectorLayer({\r\n      zIndex: 300,\r\n      source: new FeatureDataSource(),\r\n      style: undefined,\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay store's layer to the map to display the selected\r\n   * features.\r\n   */\r\n  private addOverlayLayer() {\r\n    if (this.overlayStore.layer.map === undefined) {\r\n      this.map.addLayer(this.overlayStore.layer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer from the map\r\n   */\r\n  private removeOverlayLayer() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.map.removeLayer(this.overlayStore.layer);\r\n  }\r\n}\r\n","import * as olextent from 'ol/extent';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlGeometryLayout from 'ol/geom/GeometryLayout';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport OlLayer from 'ol/layer/Layer';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport {\r\n  EntityKey,\r\n  getEntityId,\r\n  getEntityTitle,\r\n  getEntityRevision,\r\n  getEntityIcon,\r\n  getEntityProperty\r\n} from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport { VectorLayer } from '../../layer';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { FEATURE, FeatureMotion } from './feature.enums';\r\nimport { Feature } from './feature.interfaces';\r\nimport { FeatureStore } from './store';\r\nimport {\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy\r\n} from './strategies';\r\n\r\n/**\r\n * Create an Openlayers feature object out of a feature definition.\r\n * The output object has a reference to the feature id.\r\n * @param feature Feature definition\r\n * @param projectionOut Feature object projection\r\n * @returns OpenLayers feature object\r\n */\r\nexport function featureToOl(\r\n  feature: Feature,\r\n  projectionOut: string,\r\n  getId?: (Feature) => EntityKey\r\n): OlFeature {\r\n  getId = getId ? getId : getEntityId;\r\n\r\n  const olFormat = new OlFormatGeoJSON();\r\n  const olFeature = olFormat.readFeature(feature, {\r\n    dataProjection: feature.projection,\r\n    featureProjection: projectionOut\r\n  });\r\n\r\n  olFeature.setId(getId(feature));\r\n\r\n  const title = getEntityTitle(feature);\r\n  if (title !== undefined) {\r\n    olFeature.set('_title', title, true);\r\n  }\r\n\r\n  if (feature.extent !== undefined) {\r\n    olFeature.set('_extent', feature.extent, true);\r\n  }\r\n\r\n  if (feature.projection !== undefined) {\r\n    olFeature.set('_projection', feature.projection, true);\r\n  }\r\n\r\n  const mapTitle = getEntityProperty(feature, 'meta.mapTitle');\r\n  if (mapTitle !== undefined) {\r\n    olFeature.set('_mapTitle', mapTitle, true);\r\n  }\r\n\r\n  olFeature.set('_entityRevision', getEntityRevision(feature), true);\r\n\r\n  const icon = getEntityIcon(feature);\r\n  if (icon !== undefined) {\r\n    olFeature.set('_icon', icon, true);\r\n  }\r\n\r\n  if (feature.meta && feature.meta.style) {\r\n    olFeature.set('_style', feature.meta.style, true);\r\n  }\r\n\r\n  if (feature.sourceId) {\r\n    olFeature.set('_sourceId', feature.sourceId, true);\r\n  }\r\n\r\n  return olFeature;\r\n}\r\n\r\nexport function renderFeatureFromOl(\r\n  olRenderFeature: OlRenderFeature,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer,\r\n  projectionOut = 'EPSG:4326'\r\n  ): Feature {\r\n    let geom;\r\n    let title;\r\n    let exclude;\r\n    let excludeOffline;\r\n\r\n    if (olLayer) {\r\n      title = olLayer.get('title');\r\n      if (olLayer.get('sourceOptions')) {\r\n        exclude = olLayer.get('sourceOptions').excludeAttribute;\r\n        excludeOffline = olLayer.get('sourceOptions').excludeAttributeOffline;\r\n      }\r\n    } else {\r\n      title = olRenderFeature.get('_title');\r\n    }\r\n\r\n    const olFormat = new OlFormatGeoJSON();\r\n    const properties = olRenderFeature.getProperties();\r\n    const geometryType = olRenderFeature.getType();\r\n\r\n    if (geometryType === 'Polygon') {\r\n      const ends = olRenderFeature.ends_;\r\n      geom = new OlPolygon(olRenderFeature.flatCoordinates_, OlGeometryLayout.XY, ends);\r\n    } else if (geometryType === 'Point') {\r\n      geom = new OlPoint(olRenderFeature.flatCoordinates_, OlGeometryLayout.XY);\r\n    } else if (geometryType === 'LineString') {\r\n      geom = new OlLineString(olRenderFeature.flatCoordinates_, OlGeometryLayout.XY);\r\n    }\r\n\r\n    const geometry = olFormat.writeGeometryObject(geom, {\r\n      dataProjection: projectionOut,\r\n      featureProjection: projectionIn\r\n    });\r\n\r\n    const id = olRenderFeature.getId() ? olRenderFeature.getId() : uuid();\r\n    const mapTitle = olRenderFeature.get('_mapTitle');\r\n\r\n    return {\r\n      type: FEATURE,\r\n      projection: projectionOut,\r\n      extent: olRenderFeature.getExtent(),\r\n      meta: {\r\n        id,\r\n        title: title ? title : mapTitle ? mapTitle : id,\r\n        mapTitle,\r\n        excludeAttribute: exclude,\r\n        excludeAttributeOffline: excludeOffline\r\n      },\r\n      properties,\r\n      geometry,\r\n      ol: olRenderFeature\r\n    };\r\n  }\r\n/**\r\n * Create a feature object out of an OL feature\r\n * The output object has a reference to the feature id.\r\n * @param olFeature OL Feature\r\n * @param projectionIn OL feature projection\r\n * @param olLayer OL Layer\r\n * @param projectionOut Feature projection\r\n * @returns Feature\r\n */\r\nexport function featureFromOl(\r\n  olFeature: OlFeature,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer,\r\n  projectionOut = 'EPSG:4326'\r\n): Feature {\r\n  let title;\r\n  let exclude;\r\n  let excludeOffline;\r\n  const olFormat = new OlFormatGeoJSON();\r\n\r\n  const keys = olFeature.getKeys().filter((key: string) => {\r\n    return !key.startsWith('_') && key !== 'geometry';\r\n  });\r\n  const properties = keys.reduce((acc: object, key: string) => {\r\n    acc[key] = olFeature.get(key);\r\n    return acc;\r\n  }, {});\r\n\r\n  const geometry = olFormat.writeGeometryObject(olFeature.getGeometry(), {\r\n    dataProjection: projectionOut,\r\n    featureProjection: projectionIn\r\n  });\r\n\r\n  if (olLayer) {\r\n    title = olLayer.get('title');\r\n    if (olLayer.get('sourceOptions')) {\r\n      exclude = olLayer.get('sourceOptions').excludeAttribute;\r\n      excludeOffline = olLayer.get('sourceOptions').excludeAttributeOffline;\r\n    }\r\n  } else {\r\n    title = olFeature.get('_title');\r\n  }\r\n  const mapTitle = olFeature.get('_mapTitle');\r\n  const id = olFeature.getId() ? olFeature.getId() : uuid();\r\n\r\n  return {\r\n    type: FEATURE,\r\n    projection: projectionOut,\r\n    extent: olFeature.get('_extent'),\r\n    meta: {\r\n      id,\r\n      title: title ? title : mapTitle ? mapTitle : id,\r\n      mapTitle,\r\n      revision: olFeature.getRevision(),\r\n      style: olFeature.get('_style'),\r\n      excludeAttribute: exclude,\r\n      excludeAttributeOffline: excludeOffline\r\n    },\r\n    properties,\r\n    geometry,\r\n    ol: olFeature\r\n  };\r\n}\r\n\r\n/**\r\n * Compute an OL feature extent in it's map projection\r\n * @param map Map\r\n * @param olFeature OL feature\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeatureExtent(\r\n  map: IgoMap,\r\n  olFeature: OlFeature\r\n): [number, number, number, number] {\r\n  let olExtent = olextent.createEmpty();\r\n\r\n  const olFeatureExtent = olFeature.get('_extent');\r\n  const olFeatureProjection = olFeature.get('_projection');\r\n  if (olFeatureExtent !== undefined && olFeatureProjection !== undefined) {\r\n    olExtent = olproj.transformExtent(\r\n      olFeatureExtent,\r\n      olFeatureProjection,\r\n      map.projection\r\n    );\r\n  } else {\r\n    const olGeometry = olFeature.getGeometry();\r\n    if (olGeometry !== null) {\r\n      olExtent = olGeometry.getExtent();\r\n    }\r\n  }\r\n\r\n  return olExtent;\r\n}\r\n\r\n/**\r\n * Compute a multiple OL features extent in their map projection\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeaturesExtent(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature[]\r\n): [number, number, number, number] {\r\n  const extent = olextent.createEmpty();\r\n\r\n  olFeatures.forEach((olFeature: OlFeature) => {\r\n    const featureExtent = computeOlFeatureExtent(map, olFeature);\r\n    olextent.extend(extent, featureExtent);\r\n  });\r\n\r\n  return extent;\r\n}\r\n\r\n/**\r\n * Scale an extent.\r\n * @param extent Extent\r\n * @param Scaling factors for top, right, bottom and left directions, in that order\r\n * @returns Scaled extent\r\n */\r\nexport function scaleExtent(\r\n  extent: [number, number, number, number],\r\n  scale: [number, number, number, number]\r\n): [number, number, number, number] {\r\n  const [width, height] = olextent.getSize(extent);\r\n  return [\r\n    scale[3] ? extent[0] - width * scale[3] : extent[0],\r\n    scale[2] ? extent[1] - height * scale[2] : extent[1],\r\n    scale[1] ? extent[2] + width * scale[1] : extent[2],\r\n    scale[0] ? extent[3] + height * scale[0] : extent[3]\r\n  ];\r\n}\r\n\r\n/**\r\n * Return true if features are out of view.\r\n * If features are too close to the edge, they are considered out of view.\r\n * We define the edge as 5% of the extent size.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @returns Return true if features are out of view\r\n */\r\nexport function featuresAreOutOfView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number]\r\n) {\r\n  const mapExtent = map.viewController.getExtent();\r\n  const edgeRatio = 0.05;\r\n  const scale = [-1, -1, -1, -1].map(x => x * edgeRatio);\r\n  const viewExtent = scaleExtent(mapExtent, scale as [\r\n    number,\r\n    number,\r\n    number,\r\n    number\r\n  ]);\r\n\r\n  return !olextent.containsExtent(viewExtent, featuresExtent);\r\n}\r\n\r\n/**\r\n * Return true if features are too deep into the view. This results\r\n * in features being too small.\r\n * Features are considered too small if their extent occupies less than\r\n * 1% of the map extent.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @param areaRatio The features extent to view extent acceptable ratio\r\n * @returns Return true if features are too deep in the view\r\n */\r\nexport function featuresAreTooDeepInView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  // An area ratio of 0.004 means that the feature extent's width and height\r\n  // should be about 1/16 of the map extent's width and height\r\n  areaRatio = areaRatio ? areaRatio : 0.004;\r\n  const mapExtent = map.viewController.getExtent();\r\n  const mapExtentArea = olextent.getArea(mapExtent);\r\n  const featuresExtentArea = olextent.getArea(featuresExtent);\r\n\r\n  if (featuresExtentArea === 0 && map.viewController.getZoom() > 13) { // In case it's a point\r\n      return false;\r\n  }\r\n\r\n  return featuresExtentArea / mapExtentArea < areaRatio;\r\n}\r\n\r\n/**\r\n * Fit view to include the features extent.\r\n * By default, this method will let the features occupy about 50% of the viewport.\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @param motion To motion to the new map view\r\n * @param scale If this is defined, the original view will be scaled\r\n *  by that factor before any logic is applied.\r\n */\r\nexport function moveToOlFeatures(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature[],\r\n  motion: FeatureMotion = FeatureMotion.Default,\r\n  scale?: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  const featuresExtent = computeOlFeaturesExtent(map, olFeatures);\r\n  let viewExtent = featuresExtent;\r\n  if (scale !== undefined) {\r\n    viewExtent = scaleExtent(viewExtent, scale);\r\n  }\r\n\r\n  if (motion === FeatureMotion.Zoom) {\r\n    map.viewController.zoomToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Move) {\r\n    map.viewController.moveToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Default) {\r\n    if (\r\n      featuresAreOutOfView(map, featuresExtent) ||\r\n      featuresAreTooDeepInView(map, featuresExtent, areaRatio)\r\n    ) {\r\n      map.viewController.zoomToExtent(viewExtent);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hide an OL feature\r\n * @param olFeature OL feature\r\n */\r\nexport function hideOlFeature(olFeature: OlFeature) {\r\n  olFeature.setStyle(new olstyle.Style({}));\r\n}\r\n\r\n/**\r\n * Try to bind a layer to a store if none is bound already.\r\n * The layer will also be added to the store's map.\r\n * If no layer is given to that function, a basic one will be created.\r\n * @param store The store to bind the layer\r\n * @param layer An optional VectorLayer\r\n */\r\nexport function tryBindStoreLayer(store: FeatureStore, layer?: VectorLayer) {\r\n  if (store.layer !== undefined) {\r\n    if (store.layer.map === undefined) {\r\n      store.map.addLayer(store.layer);\r\n    }\r\n    return;\r\n  }\r\n\r\n  layer = layer\r\n    ? layer\r\n    : new VectorLayer({\r\n        source: new FeatureDataSource()\r\n      });\r\n  store.bindLayer(layer);\r\n  if (store.layer.map === undefined) {\r\n    store.map.addLayer(store.layer);\r\n  }\r\n}\r\n\r\n/**\r\n * Try to add a loading strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the loading strategy\r\n * @param strategy An optional loading strategy\r\n */\r\nexport function tryAddLoadingStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreLoadingStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreLoadingStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    return;\r\n  }\r\n\r\n  strategy = strategy ? strategy : new FeatureStoreLoadingStrategy({});\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n\r\n/**\r\n * Try to add a selection strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the selection strategy\r\n * @param [strategy] An optional selection strategy\r\n */\r\nexport function tryAddSelectionStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreSelectionStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreSelectionStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n    return;\r\n  }\r\n  strategy = strategy\r\n    ? strategy\r\n    : new FeatureStoreSelectionStrategy({\r\n        map: store.map\r\n      });\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n\r\n/**\r\n * Compute a diff between a source array of Ol features and a target array\r\n * @param source Source array of OL features\r\n * @param starget Target array of OL features\r\n * @returns Features to add and remove\r\n */\r\nexport function computeOlFeaturesDiff(\r\n  source: OlFeature[],\r\n  target: OlFeature[]\r\n): {\r\n  add: OlFeature[];\r\n  remove: OlFeature;\r\n} {\r\n  const olFeaturesMap = new Map();\r\n  target.forEach((olFeature: OlFeature) => {\r\n    olFeaturesMap.set(olFeature.getId(), olFeature);\r\n  });\r\n\r\n  const olFeaturesToRemove = [];\r\n  source.forEach((olFeature: OlFeature) => {\r\n    const newOlFeature = olFeaturesMap.get(olFeature.getId());\r\n    if (newOlFeature === undefined) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else if (\r\n      newOlFeature.get('_entityRevision') !== olFeature.get('_entityRevision')\r\n    ) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else {\r\n      olFeaturesMap.delete(newOlFeature.getId());\r\n    }\r\n  });\r\n\r\n  const olFeaturesToAddIds = Array.from(olFeaturesMap.keys());\r\n  const olFeaturesToAdd = target.filter((olFeature: OlFeature) => {\r\n    return olFeaturesToAddIds.indexOf(olFeature.getId()) >= 0;\r\n  });\r\n\r\n  return {\r\n    add: olFeaturesToAdd,\r\n    remove: olFeaturesToRemove\r\n  };\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Form, FormComponent, getEntityRevision } from '@igo2/common';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FEATURE } from '../shared/feature.enums';\r\nimport { Feature, FeatureMeta } from '../shared/feature.interfaces';\r\n\r\n/**\r\n * A configurable form, optionnally bound to a feature.\r\n * This component creates an entity form and, on submit,\r\n * returns a feature made out of the submitted data. It also\r\n * does things like managing the feature visibility while it's being updated\r\n * as well as disabling the selection of another feature.\r\n */\r\n@Component({\r\n  selector: 'igo-feature-form',\r\n  templateUrl: './feature-form.component.html',\r\n  styleUrls: ['./feature-form.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FeatureFormComponent {\r\n\r\n  /**\r\n   * Form\r\n   */\r\n  @Input() form: Form;\r\n\r\n  /**\r\n   * Feature to update\r\n   */\r\n  @Input()\r\n  set feature(value: Feature | undefined) { this.feature$.next(value); }\r\n  get feature(): Feature | undefined { return this.feature$.value; }\r\n  readonly feature$: BehaviorSubject<Feature> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Event emitted when the form is submitted\r\n   */\r\n  @Output() submitForm = new EventEmitter<Feature>();\r\n\r\n  @ViewChild('igoForm') igoForm: FormComponent;\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Transform the form data to a feature and emit an event\r\n   * @param event Form submit event\r\n   * @internal\r\n   */\r\n  onSubmit(data: { [key: string]: any }) {\r\n    const feature = this.formDataToFeature(data);\r\n    this.submitForm.emit(feature);\r\n  }\r\n\r\n  getData(): Feature {\r\n    return this.formDataToFeature(this.igoForm.getData());\r\n  }\r\n\r\n  /**\r\n   * Transform the form data to a feature\r\n   * @param data Form data\r\n   * @returns A feature\r\n   */\r\n  private formDataToFeature(data: { [key: string]: any }): Feature {\r\n    const properties = {};\r\n    const meta = {};\r\n    if (this.feature === undefined) {\r\n      (meta as any).id = uuid();\r\n    } else {\r\n      Object.assign(properties, this.feature.properties);\r\n      Object.assign(meta, this.feature.meta, {\r\n        revision: getEntityRevision(this.feature) + 1\r\n      });\r\n    }\r\n\r\n    const propertyPrefix = 'properties.';\r\n    Object.entries(data).forEach((entry: [string, any]) => {\r\n      const [key, value] = entry;\r\n      if (key.startsWith(propertyPrefix)) {\r\n        const property = key.substr(propertyPrefix.length);\r\n        properties[property] = value;\r\n      }\r\n    });\r\n\r\n    let geometry = data.geometry;\r\n    if (geometry === undefined && this.feature !== undefined) {\r\n      geometry = this.feature.geometry;\r\n    }\r\n\r\n    return {\r\n      meta: meta as FeatureMeta,\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: 'EPSG:4326',\r\n      properties\r\n    };\r\n  }\r\n}\r\n","import { SearchSource } from './../../search/shared/sources/source';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  featureToOl,\r\n  moveToOlFeatures\r\n} from '../../feature';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { createOverlayLayer } from './overlay.utils';\r\n\r\n/**\r\n * This class is simply a shortcut for adding features to a map.\r\n * It does nothing more than a standard layer but it's shipped with\r\n * a defautl style based on the geometry type of the features it contains.\r\n * @todo Enhance that by using a FeatureStore and strategies.\r\n */\r\nexport class Overlay {\r\n  /**\r\n   * The map to add the layer to\r\n   */\r\n  private map: IgoMap;\r\n\r\n  /**\r\n   * Overlay layer\r\n   */\r\n  private layer: VectorLayer;\r\n\r\n  /**\r\n   * Overlay layer's data source\r\n   */\r\n  get dataSource(): FeatureDataSource {\r\n    return this.layer.dataSource as FeatureDataSource;\r\n  }\r\n\r\n  constructor(map?: IgoMap) {\r\n    this.layer = createOverlayLayer();\r\n    this.setMap(map);\r\n  }\r\n\r\n  /**\r\n   * Bind this to a map and add the overlay layer to that map\r\n   * @param map Map\r\n   */\r\n  setMap(map: IgoMap) {\r\n    if (map === undefined) {\r\n      if (this.map !== undefined) {\r\n        this.map.ol.removeLayer(this.layer.ol);\r\n      }\r\n    } else {\r\n      map.ol.addLayer(this.layer.ol);\r\n    }\r\n    this.map = map;\r\n  }\r\n\r\n  /**\r\n   * Set the overlay features and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   * @param sourceId Optional: Remove features of certain sourceId (ex: 'Map' for query features)\r\n   */\r\n  setFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    sourceId?: string\r\n  ) {\r\n    if (sourceId) {\r\n      for (const olFeature of this.dataSource.ol.getFeatures()) {\r\n        if (olFeature.get('_sourceId') === sourceId) {\r\n          this.removeOlFeature(olFeature);\r\n        }\r\n      }\r\n    } else {\r\n      this.clear();\r\n    }\r\n    this.addFeatures(features, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the  overlay and, optionally, move to it\r\n   * @param feature Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeature(feature: Feature, motion: FeatureMotion = FeatureMotion.Default) {\r\n    this.addFeatures([feature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add features to the  overlay and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    const olFeatures = [];\r\n    features.forEach((feature: Feature) => {\r\n      const olFeature = featureToOl(feature, this.map.projection);\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry === null) {\r\n        return;\r\n      }\r\n      olFeatures.push(olFeature);\r\n    });\r\n\r\n    this.addOlFeatures(olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a OpenLayers feature to the  overlay and, optionally, move to it\r\n   * @param olFeature OpenLayers Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeature(\r\n    olFeature: OlFeature,\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.addOlFeatures([olFeature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add OpenLayers features to the overlay and, optionally, move to them\r\n   * @param olFeatures OpenLayers Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeatures(\r\n    olFeatures: OlFeature[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.dataSource.ol.addFeatures(olFeatures);\r\n    moveToOlFeatures(this.map, olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Remove a feature from the overlay\r\n   * @param feature Feature\r\n   */\r\n  removeFeature(feature: Feature) {\r\n    this.removeFeatures([feature]);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the overlay\r\n   * @param features Features\r\n   */\r\n  removeFeatures(features: Feature[]) {\r\n    features.forEach((feature: Feature) => {\r\n      if (feature.meta) {\r\n        if (this.dataSource.ol.getFeatureById(feature.meta.id)) {\r\n          this.removeOlFeature(this.dataSource.ol.getFeatureById(feature.meta.id));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove an OpenLayers feature from the overlay\r\n   * @param olFeature OpenLayers Feature\r\n   */\r\n  removeOlFeature(olFeature: OlFeature) {\r\n    this.dataSource.ol.removeFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.dataSource.ol.clear();\r\n  }\r\n}\r\n","import { Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { Watcher, SubjectStatus } from '@igo2/utils';\r\nimport { Layer } from '../../layer/shared/layers';\r\n\r\nexport class LayerWatcher extends Watcher {\r\n  private loaded = 0;\r\n  private loading = 0;\r\n  private layers: Layer[] = [];\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  watch() {}\r\n\r\n  unwatch() {\r\n    this.layers.forEach(layer => this.unwatchLayer(layer), this);\r\n  }\r\n\r\n  watchLayer(layer: Layer) {\r\n    if (layer.status$ === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.layers.push(layer);\r\n\r\n    const layer$$ = layer.status$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe(status => {\r\n        if (status === SubjectStatus.Working) {\r\n          this.loading += 1;\r\n        } else if (status === SubjectStatus.Done) {\r\n          this.loaded += 1;\r\n        }\r\n\r\n        if (this.loaded >= this.loading) {\r\n          this.loading = this.loaded = 0;\r\n          this.status = SubjectStatus.Done;\r\n        } else if (this.loading > 0) {\r\n          this.status = SubjectStatus.Working;\r\n        }\r\n      });\r\n\r\n    this.subscriptions.push(layer$$);\r\n  }\r\n\r\n  unwatchLayer(layer: Layer) {\r\n    layer.status$.next(SubjectStatus.Done);\r\n    const index = this.layers.indexOf(layer);\r\n    if (index >= 0) {\r\n      const status = (layer as any).watcher.status;\r\n      if (\r\n        [SubjectStatus.Working, SubjectStatus.Waiting].indexOf(status) !== -1\r\n      ) {\r\n        this.loaded += 1;\r\n      }\r\n      this.subscriptions[index].unsubscribe();\r\n      this.subscriptions.splice(index, 1);\r\n      this.layers.splice(index, 1);\r\n      (layer as any).watcher.unwatch();\r\n    }\r\n  }\r\n}\r\n","export enum MapViewAction {\r\n  Move,\r\n  Zoom\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\n/**\r\n * Base map controller\r\n */\r\nexport class MapController {\r\n\r\n  /**\r\n   * OL Map\r\n   */\r\n  protected olMap: OlMap;\r\n\r\n  /**\r\n   * Array of observer keys\r\n   */\r\n  protected observerKeys: string[] = [];\r\n\r\n  /**\r\n   * Return the OL map this controller is bound to\r\n   * @returns OL Map\r\n   */\r\n  getOlMap(): OlMap {\r\n    return this.olMap;\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap !== undefined && this.getOlMap() !== undefined) {\r\n      throw new Error('This controller is already bound to a map.');\r\n    }\r\n\r\n    if (olMap === undefined) {\r\n      this.teardownObservers();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    this.observerKeys.forEach((key: string) => unByKey(key));\r\n    this.observerKeys = [];\r\n  }\r\n\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport OlMapEvent from 'ol/MapEvent';\r\n\r\nimport { BehaviorSubject, Subject, Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport * as oleasing from 'ol/easing';\r\nimport * as olproj from 'ol/proj';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport OlView from 'ol/View';\r\n\r\nimport { MapViewAction } from '../map.enums';\r\nimport { MapExtent, MapViewState } from '../map.interface';\r\nimport { getScaleFromResolution, viewStatesAreEqual } from '../map.utils';\r\nimport { MapController } from './controller';\r\n\r\nexport interface MapViewControllerOptions {\r\n  stateHistory: boolean;\r\n}\r\n\r\n/**\r\n * Controller to handle map view interactions\r\n */\r\nexport class MapViewController extends MapController {\r\n  /**\r\n   * Observable of the current resolution\r\n   */\r\n  resolution$ = new BehaviorSubject<number>(undefined);\r\n\r\n  /**\r\n   * Observable of the current state\r\n   */\r\n  state$ = new BehaviorSubject<MapViewState>(undefined);\r\n\r\n  /**\r\n   * View Padding\r\n   */\r\n  padding = [0, 0, 0, 0];\r\n\r\n  /**\r\n   * Max zoom after set extent\r\n   */\r\n  maxZoomOnExtent = 19;\r\n\r\n  /**\r\n   * Extent stream\r\n   */\r\n  private extent$ = new Subject<{ extent: MapExtent; action: MapViewAction }>();\r\n\r\n  /**\r\n   * Subscription to the movement stream\r\n   */\r\n  private extent$$: Subscription;\r\n\r\n  /**\r\n   * History of states\r\n   */\r\n  private states: MapViewState[] = [];\r\n\r\n  /**\r\n   * Current state index\r\n   */\r\n  private stateIndex: number = 0;\r\n\r\n  /**\r\n   * Whether the view controller should keep the view's state history\r\n   */\r\n  get stateHistory(): boolean {\r\n    return this.options ? this.options.stateHistory === true : false;\r\n  }\r\n\r\n  /**\r\n   * OL View\r\n   */\r\n  get olView(): OlView {\r\n    return this.olMap.getView();\r\n  }\r\n\r\n  constructor(private options?: MapViewControllerOptions) {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    super.setOlMap(olMap);\r\n    this.setupObservers();\r\n  }\r\n\r\n  /**\r\n   * Observe move moveend and subscribe to the extent stream\r\n   */\r\n  setupObservers() {\r\n    if (this.stateHistory === true) {\r\n      this.observerKeys.push(\r\n        this.olMap.on('moveend', (event: OlMapEvent) => this.onMoveEnd(event))\r\n      );\r\n    }\r\n\r\n    this.extent$$ = this.extent$\r\n      .pipe(debounceTime(25))\r\n      .subscribe((value: { extent: MapExtent; action: MapViewAction }) => {\r\n        this.setExtent(value.extent, value.action);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    super.teardownObservers();\r\n    if (this.extent$$ !== undefined) {\r\n      this.extent$$.unsubscribe();\r\n      this.extent$$ = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the view's OL projection\r\n   * @returns OL projection\r\n   */\r\n  getOlProjection(): OlProjection {\r\n    return this.olView.getProjection();\r\n  }\r\n\r\n  /**\r\n   * Get the current map view center\r\n   * @param projection Output projection\r\n   * @returns Center\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    let center = this.olView.getCenter();\r\n    if (projection && center) {\r\n      center = olproj.transform(center, this.getOlProjection(), projection);\r\n    }\r\n    return center;\r\n  }\r\n\r\n  /**\r\n   * Get the current view extent\r\n   * @param projection Output projection\r\n   * @returns Extent\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    let extent = this.olView.calculateExtent(this.olMap.getSize());\r\n    if (projection && extent) {\r\n      extent = olproj.transformExtent(\r\n        extent,\r\n        this.getOlProjection(),\r\n        projection\r\n      );\r\n    }\r\n    return extent;\r\n  }\r\n\r\n  /**\r\n   * Get the current scale\r\n   * @param dpi Dot per inches\r\n   * @returns View scale\r\n   */\r\n  getScale(dpi = 96) {\r\n    return getScaleFromResolution(\r\n      this.getResolution(),\r\n      this.getOlProjection().getUnits(),\r\n      dpi\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the current resolution\r\n   * @returns Projection denominator\r\n   */\r\n  getResolution(): number {\r\n    return this.olView.getResolution();\r\n  }\r\n\r\n  /**\r\n   * Get the current zoom level\r\n   * @returns Zoom level\r\n   */\r\n  getZoom(): number {\r\n    return Math.round(this.olView.getZoom());\r\n  }\r\n\r\n  /**\r\n   * Zoom in\r\n   */\r\n  zoomIn() {\r\n    this.zoomTo(this.olView.getZoom() + 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom out\r\n   */\r\n  zoomOut() {\r\n    this.zoomTo(this.olView.getZoom() - 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom to specific zoom level\r\n   * @param zoom Zoom level\r\n   */\r\n  zoomTo(zoom: number) {\r\n    this.olView.cancelAnimations();\r\n    this.olView.animate({\r\n      zoom,\r\n      duration: 250,\r\n      easing: oleasing.easeOut\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Move to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to move to\r\n   */\r\n  moveToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Move });\r\n  }\r\n\r\n  /**\r\n   * Zoom to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to zoom to\r\n   */\r\n  zoomToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Zoom });\r\n  }\r\n\r\n  /**\r\n   * Return the current view rotation\r\n   * @returns Rotation angle in degrees\r\n   */\r\n  getRotation(): number {\r\n    return this.olView.getRotation();\r\n  }\r\n\r\n  /**\r\n   * Reset the view rotation to 0\r\n   */\r\n  resetRotation() {\r\n    this.olView.animate({ rotation: 0 });\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a previous state\r\n   * @returns True if the view has a previous state\r\n   */\r\n  hasPreviousState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex > 0;\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a next state\r\n   * @returns True if the view has a next state\r\n   */\r\n  hasNextState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex < this.states.length - 1;\r\n  }\r\n\r\n  /**\r\n   * Restore the previous view state\r\n   */\r\n  previousState() {\r\n    if (this.hasPreviousState()) {\r\n      this.setStateIndex(this.stateIndex - 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Restore the next view state\r\n   */\r\n  nextState() {\r\n    if (this.hasNextState()) {\r\n      this.setStateIndex(this.stateIndex + 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the state history\r\n   */\r\n  clearStateHistory() {\r\n    this.states = [];\r\n    this.stateIndex = 0;\r\n  }\r\n\r\n  /**\r\n   * Update the the view to it's intial state\r\n   */\r\n  setInitialState() {\r\n    if (this.states.length > 0) {\r\n      this.setStateIndex(0);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Move to the extent retrieved from the stream\r\n   * @param extent Extent\r\n   * @param action Either zoom or move\r\n   * @param animation With or without animation to the target extent.\r\n   */\r\n  private setExtent(\r\n    extent: MapExtent,\r\n    action: MapViewAction,\r\n    animation: boolean = true\r\n  ) {\r\n    const olView = this.olView;\r\n    olView.cancelAnimations();\r\n    const duration = animation ? 500 : 0;\r\n    const zoom = olView.getZoom();\r\n\r\n    const fromCenter = olView.getCenter();\r\n    const toCenter = [\r\n      extent[0] + (extent[2] - extent[0]) / 2,\r\n      extent[1] + (extent[3] - extent[1]) / 2\r\n    ];\r\n    const distCenter = Math.sqrt(\r\n      Math.pow(fromCenter[0] - toCenter[0], 2) +\r\n        Math.pow(fromCenter[1] - toCenter[1], 2)\r\n    );\r\n    const fromExtent = olView.calculateExtent();\r\n    const fromSize = Math.sqrt(\r\n      Math.pow(fromExtent[2] - fromExtent[0], 2) +\r\n        Math.pow(fromExtent[3] - fromExtent[1], 2)\r\n    );\r\n    const toSize = Math.sqrt(\r\n      Math.pow(extent[2] - extent[0], 2) + Math.pow(extent[3] - extent[1], 2)\r\n    );\r\n    const moySize = (toSize + fromSize) / 2;\r\n    const xSize = distCenter / moySize;\r\n\r\n    const maxZoom =\r\n      action === MapViewAction.Move || zoom > this.maxZoomOnExtent\r\n        ? zoom\r\n        : this.maxZoomOnExtent;\r\n\r\n    olView.fit(extent, {\r\n      maxZoom,\r\n      padding: this.padding,\r\n      duration: xSize > 4 ? 0 : duration\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set the view state index\r\n   * @param index State index\r\n   */\r\n  private setStateIndex(index: number) {\r\n    this.stateIndex = index;\r\n    this.setState(this.states[index]);\r\n  }\r\n\r\n  /**\r\n   * Set the view state\r\n   * @param state View state\r\n   */\r\n  private setState(state: MapViewState) {\r\n    this.olView.animate({\r\n      resolution: state.resolution,\r\n      center: state.center,\r\n      duration: 0\r\n    });\r\n  }\r\n\r\n  /**\r\n   * On move end, get the view state and record it.\r\n   * @param event Map event\r\n   */\r\n  private onMoveEnd(event: OlMapEvent) {\r\n    const resolution = this.getResolution();\r\n    if (this.resolution$.value !== resolution) {\r\n      this.resolution$.next(resolution);\r\n    }\r\n\r\n    const state = {\r\n      resolution,\r\n      center: this.getCenter(),\r\n      zoom: this.getZoom()\r\n    };\r\n\r\n    if (this.stateHistory === true) {\r\n      const stateIndex = this.stateIndex;\r\n      const stateAtIndex =\r\n        this.states.length === 0 ? undefined : this.states[stateIndex];\r\n      if (!viewStatesAreEqual(state, stateAtIndex)) {\r\n        this.states = this.states.slice(0, stateIndex + 1).concat([state]);\r\n        this.stateIndex = this.states.length - 1;\r\n      }\r\n    }\r\n\r\n    this.state$.next(state);\r\n  }\r\n}\r\n","import olMap from 'ol/Map';\r\nimport olView from 'ol/View';\r\nimport olFeature from 'ol/Feature';\r\nimport olGeolocation from 'ol/Geolocation';\r\nimport olControlAttribution from 'ol/control/Attribution';\r\nimport olControlScaleLine from 'ol/control/ScaleLine';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport * as olinteraction from 'ol/interaction';\r\nimport olCircle from 'ol/geom/Circle';\r\n\r\nimport proj4 from 'proj4';\r\nimport { BehaviorSubject, Subject, Subscription } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { Layer } from '../../layer/shared/layers';\r\nimport { Overlay } from '../../overlay/shared/overlay';\r\n\r\nimport { LayerWatcher } from '../utils/layer-watcher';\r\nimport {\r\n  MapViewOptions,\r\n  MapOptions,\r\n  MapAttributionOptions,\r\n  MapScaleLineOptions,\r\n  MapExtent\r\n} from './map.interface';\r\nimport { MapViewController } from './controllers/view';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { FeatureMotion } from '../../feature/shared/feature.enums';\r\n\r\n// TODO: This class is messy. Clearly define it's scope and the map browser's.\r\n// Move some stuff into controllers.\r\nexport class IgoMap {\r\n  public ol: olMap;\r\n  public offlineButtonToggle$ = new BehaviorSubject<boolean>(false);\r\n  public layers$ = new BehaviorSubject<Layer[]>([]);\r\n  public status$: Subject<SubjectStatus>;\r\n  public alwaysTracking: boolean;\r\n  public positionFollower: boolean = true;\r\n  public geolocation$ = new BehaviorSubject<olGeolocation>(undefined);\r\n  public geolocationFeature: olFeature;\r\n  public bufferGeom: olCircle;\r\n  public bufferFeature: olFeature;\r\n  public buffer: Overlay;\r\n  public overlay: Overlay;\r\n  public viewController: MapViewController;\r\n\r\n  public bufferDataSource: FeatureDataSource;\r\n\r\n  private layerWatcher: LayerWatcher;\r\n  private geolocation: olGeolocation;\r\n  private geolocation$$: Subscription;\r\n\r\n  private options: MapOptions;\r\n  private defaultOptions: Partial<MapOptions> = {\r\n    controls: { attribution: false }\r\n  };\r\n\r\n  get layers(): Layer[] {\r\n    return this.layers$.value;\r\n  }\r\n\r\n  get projection(): string {\r\n    return this.viewController.getOlProjection().getCode();\r\n  }\r\n\r\n  constructor(options?: MapOptions) {\r\n    this.options = Object.assign({}, this.defaultOptions, options);\r\n    this.layerWatcher = new LayerWatcher();\r\n    this.status$ = this.layerWatcher.status$;\r\n    olproj4.register(proj4);\r\n    this.init();\r\n  }\r\n\r\n  init() {\r\n    const controls = [];\r\n    if (this.options.controls) {\r\n      if (this.options.controls.attribution) {\r\n        const attributionOpt = (this.options.controls.attribution === true\r\n          ? {}\r\n          : this.options.controls.attribution) as MapAttributionOptions;\r\n        controls.push(new olControlAttribution(attributionOpt));\r\n      }\r\n      if (this.options.controls.scaleLine) {\r\n        const scaleLineOpt = (this.options.controls.scaleLine === true\r\n          ? {}\r\n          : this.options.controls.scaleLine) as MapScaleLineOptions;\r\n        controls.push(new olControlScaleLine(scaleLineOpt));\r\n      }\r\n    }\r\n    let interactions = {};\r\n    if (this.options.interactions === false) {\r\n      interactions = {\r\n        altShiftDragRotate: false,\r\n        doubleClickZoom: false,\r\n        keyboard: false,\r\n        mouseWheelZoom: false,\r\n        shiftDragZoom: false,\r\n        dragPan: false,\r\n        pinchRotate: false,\r\n        pinchZoom: false\r\n      };\r\n    }\r\n\r\n    this.ol = new olMap({\r\n      interactions: olinteraction.defaults(interactions),\r\n      controls\r\n    });\r\n\r\n    this.setView(this.options.view || {});\r\n    this.viewController = new MapViewController({\r\n      stateHistory: true\r\n    });\r\n    this.viewController.setOlMap(this.ol);\r\n    this.overlay = new Overlay(this);\r\n    this.buffer = new Overlay(this);\r\n  }\r\n\r\n  setTarget(id: string) {\r\n    this.ol.setTarget(id);\r\n    if (id !== undefined) {\r\n      this.layerWatcher.subscribe(() => {}, null);\r\n    } else {\r\n      this.layerWatcher.unsubscribe();\r\n    }\r\n  }\r\n\r\n  updateView(options: MapViewOptions) {\r\n    const currentView = this.ol.getView();\r\n    const viewOptions = Object.assign(\r\n      {\r\n        zoom: currentView.getZoom()\r\n      },\r\n      currentView.getProperties()\r\n    );\r\n\r\n    this.setView(Object.assign(viewOptions, options));\r\n    if (options.maxZoomOnExtent) {\r\n      this.viewController.maxZoomOnExtent = options.maxZoomOnExtent;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the map view\r\n   * @param options Map view options\r\n   */\r\n  setView(options: MapViewOptions) {\r\n    if (this.viewController !== undefined) {\r\n      this.viewController.clearStateHistory();\r\n    }\r\n\r\n    const view = new olView(options);\r\n    this.ol.setView(view);\r\n\r\n    this.unsubscribeGeolocate();\r\n    if (options) {\r\n      if (options.center) {\r\n        const projection = view.getProjection().getCode();\r\n        const center = olproj.fromLonLat(options.center, projection);\r\n        view.setCenter(center);\r\n      }\r\n\r\n      if (options.geolocate) {\r\n        this.geolocate(true);\r\n      }\r\n\r\n      if (options.alwaysTracking) {\r\n        this.alwaysTracking = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    return this.viewController.getCenter(projection);\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    return this.viewController.getExtent(projection);\r\n  }\r\n\r\n  // TODO: Move to ViewController and update every place it's used\r\n  getZoom(): number {\r\n    return this.viewController.getZoom();\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (!baseLayer) {\r\n      return;\r\n    }\r\n\r\n    for (const bl of this.getBaseLayers()) {\r\n      bl.visible = false;\r\n    }\r\n\r\n    baseLayer.visible = true;\r\n\r\n    this.viewController.olView.setMinZoom(\r\n      baseLayer.dataSource.options.minZoom || (this.options.view || {}).minZoom\r\n    );\r\n    this.viewController.olView.setMaxZoom(\r\n      baseLayer.dataSource.options.maxZoom || (this.options.view || {}).maxZoom\r\n    );\r\n  }\r\n\r\n  getBaseLayers(): Layer[] {\r\n    return this.layers.filter((layer: Layer) => layer.baseLayer === true);\r\n  }\r\n\r\n  getLayerById(id: string): Layer {\r\n    return this.layers.find((layer: Layer) => layer.id && layer.id === id);\r\n  }\r\n\r\n  getLayerByAlias(alias: string): Layer {\r\n    return this.layers.find(\r\n      (layer: Layer) => layer.alias && layer.alias === alias\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Add a single layer\r\n   * @param layer Layer to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayer(layer: Layer, push = true) {\r\n    this.addLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add many layers\r\n   * @param layers Layers to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayers(layers: Layer[], push = true) {\r\n    let offsetZIndex = 0;\r\n    let offsetBaseLayerZIndex = 0;\r\n    const addedLayers = layers\r\n      .map((layer: Layer) => {\r\n        const offset = layer.zIndex\r\n          ? 0\r\n          : layer.baseLayer\r\n          ? offsetBaseLayerZIndex++\r\n          : offsetZIndex++;\r\n        return this.doAddLayer(layer, offset);\r\n      })\r\n      .filter((layer: Layer | undefined) => layer !== undefined);\r\n    this.setLayers([].concat(this.layers, addedLayers));\r\n  }\r\n\r\n  /**\r\n   * Remove a single layer\r\n   * @param layer Layer to remove\r\n   */\r\n  removeLayer(layer: Layer) {\r\n    this.removeLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Remove many layers\r\n   * @param layers Layers to remove\r\n   */\r\n  removeLayers(layers: Layer[]) {\r\n    const newLayers = this.layers$.value.slice(0);\r\n    const layersToRemove = [];\r\n    layers.forEach((layer: Layer) => {\r\n      const index = newLayers.indexOf(layer);\r\n      if (index >= 0) {\r\n        layersToRemove.push(layer);\r\n        newLayers.splice(index, 1);\r\n      }\r\n    });\r\n\r\n    layersToRemove.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.setLayers(newLayers);\r\n  }\r\n\r\n  /**\r\n   * Remove all layers\r\n   */\r\n  removeAllLayers() {\r\n    this.layers.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.layers$.next([]);\r\n  }\r\n\r\n  raiseLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index > 1) {\r\n      this.moveLayer(layer, index, index - 1);\r\n    }\r\n  }\r\n\r\n  raiseLayers(layers: Layer[]) {\r\n    for (const layer of layers) {\r\n      this.raiseLayer(layer);\r\n    }\r\n  }\r\n\r\n  lowerLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index < this.layers.length - 1) {\r\n      this.moveLayer(layer, index, index + 1);\r\n    }\r\n  }\r\n\r\n  lowerLayers(layers: Layer[]) {\r\n    const reverseLayers = layers.reverse();\r\n    for (const layer of reverseLayers) {\r\n      this.lowerLayer(layer);\r\n    }\r\n  }\r\n\r\n  moveLayer(layer: Layer, from: number, to: number) {\r\n    const layerTo = this.layers[to];\r\n    const zIndexTo = layerTo.zIndex;\r\n    const zIndexFrom = layer.zIndex;\r\n\r\n    if (layerTo.baseLayer || layer.baseLayer) {\r\n      return;\r\n    }\r\n\r\n    layer.zIndex = zIndexTo;\r\n    layerTo.zIndex = zIndexFrom;\r\n\r\n    this.layers[to] = layer;\r\n    this.layers[from] = layerTo;\r\n    this.layers$.next(this.layers.slice(0));\r\n  }\r\n\r\n  /**\r\n   * Add a layer to the OL map and start watching. If the layer is already\r\n   * added to this map, make it visible but don't add it one again.\r\n   * @param layer Layer\r\n   * @returns The layer added, if any\r\n   */\r\n  private doAddLayer(layer: Layer, offsetZIndex: number) {\r\n    if (layer.baseLayer && layer.visible) {\r\n      this.changeBaseLayer(layer);\r\n    }\r\n\r\n    const existingLayer = this.getLayerById(layer.id);\r\n    if (existingLayer !== undefined) {\r\n      existingLayer.visible = true;\r\n      return;\r\n    }\r\n\r\n    if (!layer.baseLayer && layer.zIndex) {\r\n      layer.zIndex += 10;\r\n    }\r\n\r\n    if (layer.zIndex === undefined || layer.zIndex === 0) {\r\n      const maxZIndex = Math.max(\r\n        layer.baseLayer ? 0 : 10,\r\n        ...this.layers\r\n          .filter(\r\n            l => l.baseLayer === layer.baseLayer && l.zIndex < 200 // zIndex > 200 = system layer\r\n          )\r\n          .map(l => l.zIndex)\r\n      );\r\n      layer.zIndex = maxZIndex + 1 + offsetZIndex;\r\n    }\r\n\r\n    if (layer.baseLayer && layer.zIndex > 9) {\r\n      layer.zIndex = 10; // baselayer must have zIndex < 10\r\n    }\r\n\r\n    layer.setMap(this);\r\n    this.layerWatcher.watchLayer(layer);\r\n    this.ol.addLayer(layer.ol);\r\n\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Remove a layer from the OL map and stop watching\r\n   * @param layer Layer\r\n   */\r\n  private doRemoveLayer(layer: Layer) {\r\n    this.layerWatcher.unwatchLayer(layer);\r\n    this.ol.removeLayer(layer.ol);\r\n    layer.setMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Update the layers observable\r\n   * @param layers Layers\r\n   */\r\n  private setLayers(layers: Layer[]) {\r\n    this.layers$.next(this.sortLayersByZIndex(layers).slice(0));\r\n  }\r\n\r\n  /**\r\n   * Sort layers by descending zIndex\r\n   * @param layers Array of layers\r\n   * @returns The original array, sorted by zIndex\r\n   */\r\n  private sortLayersByZIndex(layers: Layer[]) {\r\n    // Sort by descending zIndex\r\n    return layers.sort(\r\n      (layer1: Layer, layer2: Layer) => layer2.zIndex - layer1.zIndex\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get layer index in the map's inenr array of layers\r\n   * @param layer Layer\r\n   * @returns The layer index\r\n   */\r\n  private getLayerIndex(layer: Layer) {\r\n    return this.layers.findIndex((_layer: Layer) => _layer === layer);\r\n  }\r\n\r\n  // TODO: Create a GeolocationController with everything below\r\n  geolocate(track = false) {\r\n    let first = true;\r\n    if (this.geolocation$$) {\r\n      track = this.geolocation.getTracking();\r\n      this.unsubscribeGeolocate();\r\n    }\r\n    this.startGeolocation();\r\n\r\n    this.geolocation$$ = this.geolocation$.subscribe(geolocation => {\r\n      if (!geolocation) {\r\n        return;\r\n      }\r\n      const accuracy = geolocation.getAccuracy();\r\n      if (accuracy < 10000) {\r\n        const geometry = geolocation.getAccuracyGeometry();\r\n        const extent = geometry.getExtent();\r\n        if (\r\n          this.geolocationFeature &&\r\n          this.overlay.dataSource.ol.getFeatureById(\r\n            this.geolocationFeature.getId()\r\n          )\r\n        ) {\r\n          this.overlay.dataSource.ol.removeFeature(this.geolocationFeature);\r\n        }\r\n\r\n        if (this.bufferFeature) {\r\n          this.buffer.dataSource.ol.removeFeature(this.bufferFeature);\r\n        }\r\n\r\n        this.geolocationFeature = new olFeature({ geometry });\r\n        this.geolocationFeature.setId('geolocationFeature');\r\n        if (!this.positionFollower && this.alwaysTracking) {\r\n          this.overlay.addOlFeature(this.geolocationFeature, FeatureMotion.None);\r\n        } else if (this.positionFollower && this.alwaysTracking) {\r\n          this.overlay.addOlFeature(this.geolocationFeature, FeatureMotion.Move);\r\n        } else {\r\n          this.overlay.addOlFeature(this.geolocationFeature);\r\n        }\r\n\r\n        if (this.ol.getView().options_.buffer) {\r\n          const bufferRadius = this.ol.getView().options_.buffer.bufferRadius;\r\n          const coordinates = geolocation.getPosition();\r\n          this.bufferGeom = new olCircle(coordinates, bufferRadius);\r\n          const bufferStroke = this.ol.getView().options_.buffer.bufferStroke;\r\n          const bufferFill = this.ol.getView().options_.buffer.bufferFill;\r\n\r\n          let bufferText;\r\n          if (this.ol.getView().options_.buffer.showBufferRadius) {\r\n            bufferText = bufferRadius.toString() + 'm';\r\n          } else {\r\n            bufferText = '';\r\n          }\r\n\r\n          this.bufferFeature = new olFeature(this.bufferGeom);\r\n          this.bufferFeature.setId('bufferFeature');\r\n          this.bufferFeature.set('bufferStroke', bufferStroke);\r\n          this.bufferFeature.set('bufferFill', bufferFill);\r\n          this.bufferFeature.set('bufferText', bufferText);\r\n          this.buffer.addOlFeature(this.bufferFeature, FeatureMotion.None);\r\n        }\r\n        if (first) {\r\n          this.viewController.zoomToExtent(extent);\r\n          this.positionFollower = !this.positionFollower;\r\n        }\r\n      } else if (first) {\r\n        const view = this.ol.getView();\r\n        const coordinates = geolocation.getPosition();\r\n        view.setCenter(coordinates);\r\n        view.setZoom(14);\r\n      }\r\n      if (track && !this.alwaysTracking) {\r\n        this.unsubscribeGeolocate();\r\n      }\r\n      first = false;\r\n    });\r\n  }\r\n\r\n  unsubscribeGeolocate() {\r\n    this.stopGeolocation();\r\n    if (this.geolocation$$) {\r\n      this.geolocation$$.unsubscribe();\r\n      this.geolocation$$ = undefined;\r\n    }\r\n  }\r\n\r\n  private startGeolocation() {\r\n    if (!this.geolocation) {\r\n      this.geolocation = new olGeolocation({\r\n        trackingOptions: {\r\n          enableHighAccuracy: true\r\n        },\r\n        projection: this.projection,\r\n        tracking: true\r\n      });\r\n\r\n      this.geolocation.on('change', evt => {\r\n        this.geolocation$.next(this.geolocation);\r\n      });\r\n    } else {\r\n      this.geolocation.setTracking(true);\r\n    }\r\n  }\r\n\r\n  private stopGeolocation() {\r\n    if (this.geolocation) {\r\n      this.geolocation.setTracking(false);\r\n    }\r\n  }\r\n\r\n  onOfflineToggle(offline: boolean) {\r\n    this.offlineButtonToggle$.next(offline);\r\n  }\r\n}\r\n","import { Directive, AfterViewInit } from '@angular/core';\r\nimport { NetworkService, ConnectionState, MessageService, LanguageService } from '@igo2/core';\r\n\r\nimport { IgoMap } from './map';\r\nimport { MapBrowserComponent } from '../map-browser/map-browser.component';\r\nimport { FeatureDataSourceOptions } from '../../datasource/shared/datasources/feature-datasource.interface';\r\nimport { XYZDataSourceOptions } from '../../datasource/shared/datasources/xyz-datasource.interface';\r\nimport { MVTDataSourceOptions } from '../../datasource/shared/datasources/mvt-datasource.interface';\r\nimport { ClusterDataSourceOptions } from '../../datasource/shared/datasources/cluster-datasource.interface';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { MVTDataSource } from '../../datasource/shared/datasources/mvt-datasource';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { XYZDataSource } from '../../datasource/shared/datasources/xyz-datasource';\r\n\r\n@Directive({\r\n    selector: '[igoMapOffline]'\r\n  })\r\nexport class MapOfflineDirective implements AfterViewInit {\r\n\r\n  private component: MapBrowserComponent;\r\n  private offlineButtonStatus: boolean = false;\r\n  private networkState: ConnectionState = {\r\n    connection: true\r\n  };\r\n  private offlineButtonState: ConnectionState = {\r\n    connection: true\r\n  };\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    component: MapBrowserComponent,\r\n    private networkService: NetworkService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService\r\n    ) {\r\n      this.component = component;\r\n    }\r\n\r\n    ngAfterViewInit() {\r\n      this.map.offlineButtonToggle$.subscribe((offlineButtonToggle: boolean) => {\r\n        this.offlineButtonStatus = offlineButtonToggle;\r\n        const translate = this.languageService.translate;\r\n        if (this.offlineButtonStatus && this.networkState.connection) {\r\n          const message = translate.instant('igo.geo.network.offline.message');\r\n          const title = translate.instant('igo.geo.network.offline.title');\r\n          this.messageService.info(message, title);\r\n          this.offlineButtonState.connection = false;\r\n          this.changeLayer();\r\n        } else if (!this.offlineButtonStatus && !this.networkState.connection) {\r\n          const message = translate.instant('igo.geo.network.offline.message');\r\n          const title = translate.instant('igo.geo.network.offline.title');\r\n          this.messageService.info(message, title);\r\n          this.offlineButtonState.connection = false;\r\n          this.changeLayer();\r\n        } else if (!this.offlineButtonStatus && this.networkState.connection) {\r\n          let message;\r\n          let title;\r\n          const messageObs = translate.get('igo.geo.network.online.message');\r\n          const titleObs = translate.get('igo.geo.network.online.title');\r\n          messageObs.subscribe((message1: string) => {\r\n            message = message1;\r\n          });\r\n          titleObs.subscribe((title1: string) => {\r\n            title = title1;\r\n          });\r\n          this.messageService.info(message, title);\r\n          this.offlineButtonState.connection = true;\r\n          this.changeLayer();\r\n        }\r\n      });\r\n\r\n      this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n        this.networkState = state;\r\n        if (!this.offlineButtonStatus) {\r\n          this.changeLayer();\r\n        }\r\n      });\r\n\r\n      this.map.layers$.subscribe((layers: Layer[]) => {\r\n        this.changeLayer();\r\n      });\r\n    }\r\n\r\n  private changeLayer() {\r\n    let sourceOptions;\r\n    const layerList = this.map.layers$.value;\r\n    layerList.forEach(layer => {\r\n      if (layer.options.source instanceof MVTDataSource) {\r\n        sourceOptions = (layer.options.sourceOptions as MVTDataSourceOptions);\r\n        layer.ol.getSource().clear();\r\n      } else if (layer.options.source instanceof XYZDataSource) {\r\n        sourceOptions = (layer.options.sourceOptions as XYZDataSourceOptions);\r\n      } else if (layer.options.source instanceof ClusterDataSource) {\r\n        sourceOptions = (layer.options.sourceOptions as ClusterDataSourceOptions);\r\n      } else if (layer.options.source instanceof FeatureDataSource) {\r\n        sourceOptions = (layer.options.sourceOptions as FeatureDataSourceOptions);\r\n      } else {\r\n        if (this.networkState.connection === false || this.offlineButtonState.connection === false) {\r\n          layer.ol.setMaxResolution(0);\r\n          return;\r\n        } else if (this.networkState.connection === true || this.offlineButtonState.connection === true) {\r\n          layer.ol.setMaxResolution(Infinity);\r\n          return;\r\n        }\r\n      }\r\n\r\n      if (sourceOptions) {\r\n        if (sourceOptions.pathOffline && this.networkState.connection === false ||\r\n          sourceOptions.pathOffline && this.offlineButtonState.connection === false) {\r\n            if (sourceOptions.type === 'vector' || sourceOptions.type === 'cluster') {\r\n              return;\r\n            }\r\n            layer.ol.getSource().setUrl(sourceOptions.pathOffline);\r\n        } else if (sourceOptions.pathOffline && this.networkState.connection === false ||\r\n          sourceOptions.pathOffline && this.offlineButtonState.connection === true) {\r\n            if (sourceOptions.type === 'vector' || sourceOptions.type === 'cluster') {\r\n              return;\r\n            }\r\n            layer.ol.getSource().setUrl(sourceOptions.url);\r\n        } else {\r\n          if (this.networkState.connection === false || this.offlineButtonState.connection === false) {\r\n            layer.ol.setMaxResolution(0);\r\n          } else if (this.networkState.connection === true || this.offlineButtonState.connection === true) {\r\n            layer.ol.setMaxResolution(Infinity);\r\n          }\r\n        }\r\n      } else {\r\n        if (this.networkState.connection === false || this.offlineButtonState.connection === false) {\r\n          layer.ol.setMaxResolution(0);\r\n        } else if (this.networkState.connection === true || this.offlineButtonState.connection === true) {\r\n          layer.ol.setMaxResolution(Infinity);\r\n        }\r\n      }\r\n    });\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport { MapBrowserPointerEvent as OlMapBrowserPointerEvent } from 'ol/MapBrowserEvent';\r\nimport { ListenerFunction } from 'ol/events';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\n\r\nimport { transform } from 'ol/proj';\r\nimport { MediaService } from '@igo2/core';\r\n/**\r\n * This directive return the pointer coordinate (on click or pointermove)\r\n * in [longitude, latitude], delayed by in input (pointerMoveDelay)\r\n * to avoid too many emitted values.\r\n */\r\n@Directive({\r\n  selector: '[igoPointerPosition]'\r\n})\r\nexport class PointerPositionDirective implements OnInit, OnDestroy {\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener: ListenerFunction;\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener: ListenerFunction;\r\n\r\n  /**\r\n   * Delay before emitting an event\r\n   */\r\n  @Input() pointerPositionDelay: number = 1000;\r\n\r\n  /**\r\n   * Event emitted when the pointer move, delayed by pointerMoveDelay\r\n   */\r\n  @Output() pointerPositionCoord = new EventEmitter<[number, number]>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.listenToMapPointerMove();\r\n    this.listenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unlistenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: OlMapBrowserPointerEvent) => this.onPointerEvent(event, this.pointerPositionDelay)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map click\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: OlMapBrowserPointerEvent) => this.onPointerEvent(event, 0)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    this.map.ol.un(this.pointerMoveListener.type, this.pointerMoveListener.listener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    this.map.ol.un(this.mapClickListener.type, this.mapClickListener.listener);\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * emit delayed coordinate (longitude, latitude array) based on pointerMoveDelay or on click\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onPointerEvent(event: OlMapBrowserPointerEvent, delay: number) {\r\n    if (event.dragging || this.mediaService.isTouchScreen()) {return; }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    const lonlat = transform(event.coordinate, this.mapProjection, 'EPSG:4326');\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.pointerPositionCoord.emit(lonlat);\r\n    }, delay);\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport { MapBrowserPointerEvent as OlMapBrowserPointerEvent } from 'ol/MapBrowserEvent';\r\nimport { ListenerFunction } from 'ol/events';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\n\r\nimport { transform } from 'ol/proj';\r\nimport { Subscription, BehaviorSubject, fromEvent } from 'rxjs';\r\nimport { MediaService } from '@igo2/core';\r\n/**\r\n * This directive return the pointer coordinate (on click or pointermove)\r\n * in [longitude, latitude], delayed by in input (pointerMoveDelay)\r\n * to avoid too many emitted values.\r\n * User needs to hold the key defined by pointerByKeyEventKeyCode to emit a coord.\r\n */\r\n@Directive({\r\n  selector: '[igoPointerPositionByKey]'\r\n})\r\nexport class PointerPositionByKeyDirective implements OnInit, OnDestroy {\r\n\r\n  private keyDown$$: Subscription;\r\n  private keyUp$$: Subscription;\r\n  private definedKeyIsDown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener: ListenerFunction;\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener: ListenerFunction;\r\n\r\n  /**\r\n   * Delay before emitting an event\r\n   */\r\n  @Input() pointerPositionByKeyDelay: number = 1000;\r\n\r\n  /**\r\n   * The key pressed (must be hold) to trigger the output\r\n   */\r\n  @Input() pointerPositionByKeyCode: number = 17;\r\n\r\n  /**\r\n   * Event emitted when the pointer move, delayed by pointerMoveDelay\r\n   */\r\n  @Output() pointerPositionByKeyCoord = new EventEmitter<[number, number]>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.listenToMapPointerMove();\r\n    this.listenToMapClick();\r\n    this.subscribeToKeyDown();\r\n    this.subscribeToKeyUp();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unlistenToMapClick();\r\n    this.unsubscribeToKeyDown();\r\n    this.unsubscribeToKeyUp();\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: OlMapBrowserPointerEvent) => this.onPointerEvent(event, this.pointerPositionByKeyDelay)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map click\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: OlMapBrowserPointerEvent) => this.onPointerEvent(event, 0)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Subscribe to user defined key keyDown, hold down to activate the emit\r\n   */\r\n  private subscribeToKeyDown() {\r\n    this.unsubscribeToKeyDown();\r\n    this.keyDown$$ = fromEvent(document, 'keydown')\r\n    .subscribe((event: KeyboardEvent) => {\r\n      // On user defined key is down,\r\n      if (event.keyCode === this.pointerPositionByKeyCode) {\r\n        this.definedKeyIsDown$.next(true);\r\n        return;\r\n      }\r\n    });\r\n  }\r\n  /**\r\n   * Subscribe to user defined key keyUp, release to desactivate the emit\r\n   */\r\n  private subscribeToKeyUp() {\r\n    this.unsubscribeToKeyUp();\r\n    this.keyUp$$ = fromEvent(document, 'keyup')\r\n    .subscribe((event: KeyboardEvent) => {\r\n      // When user defined key is released,\r\n      if (event.keyCode === this.pointerPositionByKeyCode) {\r\n        this.definedKeyIsDown$.next(false);\r\n        return;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    this.map.ol.un(this.pointerMoveListener.type, this.pointerMoveListener.listener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    this.map.ol.un(this.mapClickListener.type, this.mapClickListener.listener);\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeToKeyDown() {\r\n    if (this.keyDown$$ !== undefined) {\r\n      this.keyDown$$.unsubscribe();\r\n      this.keyDown$$ = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key up\r\n   */\r\n  private unsubscribeToKeyUp() {\r\n    if (this.keyUp$$ !== undefined) {\r\n      this.keyUp$$.unsubscribe();\r\n      this.keyUp$$ = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * emit delayed coordinate (longitude, latitude array) based on pointerMoveDelay or on click\r\n   * User must hold the defined key to allow the emit.\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onPointerEvent(event: OlMapBrowserPointerEvent, delay: number) {\r\n    if (event.dragging || this.mediaService.isTouchScreen()) {return; }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    if (this.definedKeyIsDown$.value) {\r\n    const lonlat = transform(event.coordinate, this.mapProjection, 'EPSG:4326');\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.pointerPositionByKeyCoord.emit(lonlat);\r\n    }, delay);\r\n  }\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport proj4 from 'proj4';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * When injected, this service automatically registers and\r\n * projection defined in the application config. A custom projection\r\n * needs to be registered to be usable by OL.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ProjectionService {\r\n\r\n  constructor(private config: ConfigService) {\r\n    const projections = this.config.getConfig('projections') || [];\r\n    projections.forEach((projection: Projection) => {\r\n      projection.alias = projection.alias ? projection.alias : projection.code;\r\n      this.registerProjection(projection);\r\n    });\r\n\r\n    // register all utm zones\r\n    for (let utmZone = 1; utmZone < 61; utmZone++) {\r\n      const code = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n      const def = `+proj=utm +zone=${utmZone} +datum=WGS84 +units=m +no_defs`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n\r\n    // register all mtm zones\r\n    for (let mtmZone = 1; mtmZone < 11; mtmZone++) {\r\n      const code = mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n      let lon0;\r\n      if (Number(mtmZone) <= 2) {\r\n        lon0 = -50 - Number(mtmZone) * 3;\r\n      } else if (Number(mtmZone) >= 12) {\r\n        lon0 = -81 - (Number(mtmZone) - 12) * 3;\r\n      } else {\r\n        lon0 = -49.5 - Number(mtmZone) * 3;\r\n      }\r\n      const def = `+proj=tmerc +lat_0=0 +lon_0=${lon0} +k=0.9999 +x_0=304800 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs\"`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define a proj4 projection and register it in OL\r\n   * @param projection Projection\r\n   */\r\n  registerProjection(projection: Projection) {\r\n    proj4.defs(projection.code, projection.def);\r\n    olproj4.register(proj4);\r\n    if (projection.extent) {\r\n      olproj.get(projection.code).setExtent(projection.extent);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-zoom-button',\r\n  templateUrl: './zoom-button.component.html',\r\n  styleUrls: ['./zoom-button.component.scss']\r\n})\r\nexport class ZoomButtonComponent {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string;\r\n\r\n  get zoom(): number { return this.map.viewController.getZoom(); }\r\n\r\n  get minZoom(): number { return this.map.viewController.olView.getMinZoom() || 1; }\r\n\r\n  get maxZoom(): number { return this.map.viewController.olView.getMaxZoom(); }\r\n\r\n  constructor() {}\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-geolocate-button',\r\n  templateUrl: './geolocate-button.component.html',\r\n  styleUrls: ['./geolocate-button.component.scss']\r\n})\r\nexport class GeolocateButtonComponent {\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get color(): string {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color: string;\r\n\r\n  constructor() {}\r\n}\r\n","import { Component, Input, EventEmitter, Output, AfterViewInit } from '@angular/core';\r\nimport { IgoMap } from '../shared/map';\r\nimport { Observable, BehaviorSubject, Subscription, fromEvent } from 'rxjs';\r\nimport { debounceTime, startWith } from 'rxjs/operators';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-offline-button',\r\n  templateUrl: './offline-button.component.html',\r\n  styleUrls: ['./offline-button.component.scss']\r\n})\r\n\r\nexport class OfflineButtonComponent {\r\n\r\n  btnStyle: string = 'baseStyle';\r\n  colorOff: string = 'rgb(255,255,255)';\r\n\r\n  @Output() change = new EventEmitter<boolean>();\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get color(): string {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color: string;\r\n\r\n  @Input() public check: boolean = false;\r\n\r\n  get checked(): boolean {\r\n    return this.check;\r\n  }\r\n\r\n  public visible = false;\r\n\r\n  constructor(\r\n    private config: ConfigService\r\n    ) {\r\n    this.visible = this.config.getConfig('offlineButton') ? true : false;\r\n  }\r\n\r\n  onToggle() {\r\n    this.check = !this.check;\r\n    if (this.check) {\r\n      this.btnStyle = 'toggleStyle';\r\n    } else {\r\n      this.btnStyle = 'baseStyle';\r\n    }\r\n  }\r\n}\r\n","import {\r\n  trigger,\r\n  state,\r\n  style,\r\n  transition,\r\n  animate,\r\n  AnimationTriggerMetadata\r\n} from '@angular/animations';\r\n\r\nexport function baseLayersSwitcherSlideInOut(): AnimationTriggerMetadata {\r\n  return trigger('baseLayerSwitcherState', [\r\n    state(\r\n      'collapseIcon',\r\n      style({\r\n        height: '40px',\r\n        width: '40px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'collapseMap',\r\n      style({\r\n        height: '85px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'expand',\r\n      style({\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    transition('collapse => expand', animate('200ms')),\r\n    transition('expand => collapse', animate('200ms'))\r\n  ]);\r\n}\r\n","import { Component, Input, AfterViewInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { MediaService, Media } from '@igo2/core';\r\nimport { Layer } from '../../layer';\r\nimport { IgoMap } from '../shared';\r\nimport { baseLayersSwitcherSlideInOut } from './baselayers-switcher.animation';\r\n\r\n@Component({\r\n  selector: 'igo-baselayers-switcher',\r\n  templateUrl: './baselayers-switcher.component.html',\r\n  styleUrls: ['./baselayers-switcher.component.scss'],\r\n  animations: [baseLayersSwitcherSlideInOut()]\r\n})\r\nexport class BaseLayersSwitcherComponent implements AfterViewInit, OnDestroy {\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get useStaticIcon(): boolean {\r\n    return this._useStaticIcon;\r\n  }\r\n  set useStaticIcon(value: boolean) {\r\n    this._useStaticIcon = value;\r\n  }\r\n  private _useStaticIcon: boolean;\r\n\r\n  public _baseLayers: Layer[] = [];\r\n  public expand = false;\r\n  public showButton = true;\r\n\r\n  private layers$$: Subscription;\r\n\r\n  constructor(private mediaService: MediaService) {\r\n    const media = this.mediaService.media$.value;\r\n    if (media === Media.Mobile && this.useStaticIcon === undefined) {\r\n      this.useStaticIcon = true;\r\n    }\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.layers$$ = this.map.layers$.subscribe(arrayLayers => {\r\n      this._baseLayers = arrayLayers.filter(l => l.baseLayer);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  collapseOrExpand() {\r\n    if (this.baseLayers.length > 1 || this.useStaticIcon) {\r\n      this.expand = !this.expand;\r\n    } else {\r\n      this.expand = false;\r\n    }\r\n  }\r\n\r\n  get baseLayers(): Layer[] {\r\n    const mapResolution = this.map.viewController.getResolution();\r\n    const mapZoom = this.map.viewController.getZoom();\r\n\r\n    const bl = this._baseLayers.filter(l => {\r\n      return (\r\n        (!l.options.maxResolution ||\r\n          mapResolution <= l.options.maxResolution) &&\r\n        (!l.options.minResolution || mapResolution >= l.options.minResolution) &&\r\n        (!l.options.source.options.maxZoom || mapZoom <= l.options.source.options.maxZoom) &&\r\n        (!l.options.source.options.minZoom || mapZoom >= l.options.source.options.minZoom)\r\n      );\r\n    });\r\n\r\n    const blHidden = bl.filter(l => !l.visible);\r\n    return blHidden.length + 1 === bl.length ? blHidden : bl;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  AfterViewInit,\r\n  OnDestroy,\r\n  ApplicationRef\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../shared';\r\n\r\n@Component({\r\n  selector: 'igo-mini-basemap',\r\n  templateUrl: './mini-basemap.component.html',\r\n  styleUrls: ['./mini-basemap.component.scss']\r\n})\r\nexport class MiniBaseMapComponent implements AfterViewInit, OnDestroy {\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n    this.handleMoveEnd();\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get baseLayer(): Layer {\r\n    return this._baseLayer;\r\n  }\r\n  set baseLayer(value: Layer) {\r\n    this._baseLayer = value;\r\n    this.handleBaseLayerChanged(value);\r\n  }\r\n  private _baseLayer: Layer;\r\n\r\n  @Input()\r\n  get disabled(): boolean {\r\n    return this._disabled;\r\n  }\r\n  set disabled(value: boolean) {\r\n    this._disabled = value;\r\n  }\r\n  private _disabled: boolean;\r\n\r\n  @Input()\r\n  get display(): boolean {\r\n    return this._display;\r\n  }\r\n  set display(value: boolean) {\r\n    this._display = value;\r\n  }\r\n  private _display: boolean;\r\n\r\n  public basemap = new IgoMap({\r\n    controls: {},\r\n    interactions: false\r\n  });\r\n\r\n  @Input() title: string;\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private appRef: ApplicationRef\r\n  ) {}\r\n\r\n  ngAfterViewInit() {\r\n    this.map.ol.on('moveend', () => this.handleMoveEnd());\r\n    this.handleMoveEnd();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.ol.un('moveend', () => this.handleMoveEnd());\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n    this.map.changeBaseLayer(baseLayer);\r\n    this.appRef.tick();\r\n  }\r\n\r\n  private handleMoveEnd() {\r\n    this.basemap.ol.setView(this.map.ol.getView());\r\n  }\r\n\r\n  private handleBaseLayerChanged(baselayer: Layer) {\r\n    this.basemap.removeAllLayers();\r\n\r\n    const options: any = Object.assign(\r\n      Object.create(baselayer.options),\r\n      baselayer.options,\r\n      {\r\n        visible: true,\r\n        baseLayer: false\r\n      }\r\n    );\r\n\r\n    const layer = this.layerService.createLayer(options);\r\n    this.basemap.addLayer(layer);\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-rotation-button',\r\n  templateUrl: './rotation-button.component.html',\r\n  styleUrls: ['./rotation-button.component.scss']\r\n})\r\nexport class RotationButtonComponent {\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get showIfNoRotation(): boolean {\r\n    return this._showIfNoRotation;\r\n  }\r\n  set showIfNoRotation(value: boolean) {\r\n    this._showIfNoRotation = value;\r\n  }\r\n  private _showIfNoRotation: boolean;\r\n\r\n  @Input()\r\n  get color(): string {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color: string;\r\n\r\n  get rotated(): boolean {\r\n    return this.map.viewController.getRotation() !== 0;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  rotationStyle(radians): {} {\r\n    const rotation = 'rotate(' + radians + 'rad)';\r\n    return {\r\n      transform: rotation\r\n    };\r\n  }\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\n\r\nexport class EsriStyleGenerator {\r\n  public _converters: any;\r\n  public _renderers: any;\r\n\r\n  constructor() {\r\n    this._converters = {};\r\n    this._converters.esriPMS = EsriStyleGenerator._convertEsriPMS;\r\n    this._converters.esriSFS = EsriStyleGenerator._convertEsriSFS;\r\n    this._converters.esriSLS = EsriStyleGenerator._convertEsriSLS;\r\n    this._converters.esriSMS = EsriStyleGenerator._convertEsriSMS;\r\n    this._converters.esriTS = EsriStyleGenerator._convertEsriTS;\r\n    this._renderers = {};\r\n    this._renderers.uniqueValue = this._renderUniqueValue;\r\n    this._renderers.simple = this._renderSimple;\r\n    this._renderers.classBreaks = this._renderClassBreaks;\r\n  }\r\n  static _convertPointToPixel(point) {\r\n    return point / 0.75;\r\n  }\r\n  static _transformColor(color): [number, number, number, number] {\r\n    // alpha channel is different, runs from 0-255 but in ol3 from 0-1\r\n    return [color[0], color[1], color[2], color[3] / 255];\r\n  }\r\n\r\n  static _getResolutionForScale(scale, units) {\r\n    const dpi = 96;\r\n    const mpu = olproj.METERS_PER_UNIT[units];\r\n    const inchesPerMeter = 39.3701;\r\n    return parseFloat(scale) / (mpu * inchesPerMeter * dpi);\r\n  }\r\n\r\n  /* convert an Esri Text Symbol */\r\n  static _convertEsriTS(symbol) {\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    const text = symbol.text !== undefined ? symbol.text : undefined;\r\n    return new olstyle.Style({\r\n      text: new olstyle.Text({\r\n        fill: new olstyle.Fill({\r\n          color: EsriStyleGenerator._transformColor(symbol.color)\r\n        }),\r\n        font:\r\n          symbol.font.style +\r\n          ' ' +\r\n          symbol.font.weight +\r\n          ' ' +\r\n          symbol.font.size +\r\n          ' px ' +\r\n          symbol.font.family,\r\n        textBaseline: symbol.verticalAlignment,\r\n        textAlign: symbol.horizontalAlignment,\r\n        offsetX: EsriStyleGenerator._convertPointToPixel(symbol.xoffset),\r\n        offsetY: EsriStyleGenerator._convertPointToPixel(symbol.yoffset),\r\n        rotation,\r\n        text\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Picture Marker Symbol */\r\n  static _convertEsriPMS(symbol) {\r\n    const src = 'data:' + symbol.contentType + ';base64, ' + symbol.imageData;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n\r\n    return new olstyle.Style({\r\n      image: new olstyle.Icon({\r\n        src,\r\n        rotation\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Simple Fill Symbol */\r\n  static _convertEsriSFS(symbol) {\r\n    // there is no support in openlayers currently for fill patterns, so style is not interpreted\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    return new olstyle.Style({\r\n      fill,\r\n      stroke\r\n    });\r\n  }\r\n  static _convertOutline(outline) {\r\n    let lineDash;\r\n    const color = EsriStyleGenerator._transformColor(outline.color);\r\n    if (outline.style === 'esriSLSDash') {\r\n      lineDash = [5];\r\n    } else if (outline.style === 'esriSLSDashDot') {\r\n      lineDash = [5, 5, 1, 2];\r\n    } else if (outline.style === 'esriSLSDashDotDot') {\r\n      lineDash = [5, 5, 1, 2, 1, 2];\r\n    } else if (outline.style === 'esriSLSDot') {\r\n      lineDash = [1, 2];\r\n    } else if (outline.style === 'esriSLSNull') {\r\n      // line not visible, make color fully transparent\r\n      color[3] = 0;\r\n    }\r\n    return new olstyle.Stroke({\r\n      color,\r\n      lineDash,\r\n      width: EsriStyleGenerator._convertPointToPixel(outline.width)\r\n    });\r\n  }\r\n  /* convert an Esri Simple Line Symbol */\r\n  static _convertEsriSLS(symbol) {\r\n    return new olstyle.Style({\r\n      stroke: EsriStyleGenerator._convertOutline(symbol)\r\n    });\r\n  }\r\n  static _transformAngle(angle) {\r\n    if (angle === 0 || angle === undefined) {\r\n      return undefined;\r\n    }\r\n    const normalRad = (angle * Math.PI) / 180;\r\n    const ol3Rad = -normalRad + Math.PI / 2;\r\n    if (ol3Rad < 0) {\r\n      return 2 * Math.PI + ol3Rad;\r\n    } else {\r\n      return ol3Rad;\r\n    }\r\n  }\r\n  /* convert an Esri Simple Marker Symbol */\r\n  static _convertEsriSMS(symbol) {\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    const radius = EsriStyleGenerator._convertPointToPixel(symbol.size) / 2;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    if (symbol.style === 'esriSMSCircle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.Circle({\r\n          radius,\r\n          fill,\r\n          stroke\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSCross') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSDiamond') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSSquare') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSX') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSTriangle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 3,\r\n          radius,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    }\r\n  }\r\n\r\n  _convertLabelingInfo(labelingInfo, mapUnits) {\r\n    const styles = [];\r\n    for (let i = 0, ii = labelingInfo.length; i < ii; ++i) {\r\n      const labelExpression = labelingInfo[i].labelExpression;\r\n      // only limited support for label expressions\r\n      const field = labelExpression.substr(\r\n        labelExpression.indexOf('[') + 1,\r\n        labelExpression.indexOf(']') - 1\r\n      );\r\n      const symbol = labelingInfo[i].symbol;\r\n      const maxScale = labelingInfo[i].maxScale;\r\n      const minScale = labelingInfo[i].minScale;\r\n      let minResolution = null;\r\n      if (maxScale !== 0) {\r\n        minResolution = EsriStyleGenerator._getResolutionForScale(\r\n          maxScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      let maxResolution = null;\r\n      if (minScale !== 0) {\r\n        maxResolution = EsriStyleGenerator._getResolutionForScale(\r\n          minScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      styles.push(\r\n        (() => {\r\n          return function(feature, resolution) {\r\n            let visible = true;\r\n            if (this.minResolution !== null && this.maxResolution !== null) {\r\n              visible =\r\n                resolution < this.maxResolution &&\r\n                resolution >= this.minResolution;\r\n            } else if (this.minResolution !== null) {\r\n              visible = resolution >= this.minResolution;\r\n            } else if (this.maxResolution !== null) {\r\n              visible = resolution < this.maxResolution;\r\n            }\r\n            if (visible) {\r\n              const value = feature.get(this.field);\r\n              this.style.getText().setText(value);\r\n              return [this.style];\r\n            }\r\n          };\r\n        })().bind({\r\n          minResolution,\r\n          maxResolution,\r\n          field,\r\n          style\r\n        })\r\n      );\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  _renderSimple(renderer) {\r\n    const style = this._converters[renderer.symbol.type].call(\r\n      this,\r\n      renderer.symbol\r\n    );\r\n    return (() => {\r\n      return () => {\r\n        return [style];\r\n      };\r\n    })();\r\n  }\r\n  _renderClassBreaks(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    const defaultStyle = this._converters[defaultSymbol.type].call(\r\n      this,\r\n      defaultSymbol\r\n    );\r\n    const field = renderer.field;\r\n    const classes = [];\r\n    for (let i = 0, ii = renderer.classBreakInfos.length; i < ii; ++i) {\r\n      const classBreakInfo = renderer.classBreakInfos[i];\r\n      let min;\r\n      if (\r\n        classBreakInfo.classMinValue === null ||\r\n        classBreakInfo.classMinValue === undefined\r\n      ) {\r\n        if (i === 0) {\r\n          min = renderer.minValue;\r\n        } else {\r\n          min = renderer.classBreakInfos[i - 1].classMaxValue;\r\n        }\r\n      } else {\r\n        min = classBreakInfo.classMinValue;\r\n      }\r\n      const max = classBreakInfo.classMaxValue;\r\n      const symbol = classBreakInfo.symbol;\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      classes.push({ min, max, style });\r\n    }\r\n    return (() => {\r\n      return (feature) => {\r\n        const value = feature.get(field);\r\n        for (let i = 0, ii = classes.length; i < ii; ++i) {\r\n          let condition;\r\n          if (i === 0) {\r\n            condition = value >= classes[i].min && value <= classes[i].max;\r\n          } else {\r\n            condition = value > classes[i].min && value <= classes[i].max;\r\n          }\r\n          if (condition) {\r\n            return [classes[i].style];\r\n          }\r\n        }\r\n        return [defaultStyle];\r\n      };\r\n    })();\r\n  }\r\n  _renderUniqueValue(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    let defaultStyle = [];\r\n    if (defaultSymbol) {\r\n      defaultStyle = [\r\n        this._converters[defaultSymbol.type].call(this, defaultSymbol)\r\n      ];\r\n    }\r\n    const field = renderer.field1;\r\n    const infos = renderer.uniqueValueInfos;\r\n    const me = this;\r\n    return (() => {\r\n      const hash = {};\r\n      for (let i = 0, ii = infos.length; i < ii; ++i) {\r\n        const info = infos[i];\r\n        const symbol = info.symbol;\r\n        hash[info.value] = [me._converters[symbol.type].call(me, symbol)];\r\n      }\r\n\r\n      return (feature) => {\r\n        const style = hash[feature.get(field)];\r\n        return style ? style : defaultStyle;\r\n      };\r\n    })();\r\n  }\r\n  generateStyle(layerInfo, mapUnits) {\r\n    const drawingInfo = layerInfo.drawingInfo;\r\n    let styleFunctions = [];\r\n    const drawingInfoStyle = this._renderers[drawingInfo.renderer.type].call(\r\n      this,\r\n      drawingInfo.renderer\r\n    );\r\n    if (drawingInfoStyle !== undefined) {\r\n      styleFunctions.push(drawingInfoStyle);\r\n    }\r\n    if (layerInfo.labelingInfo) {\r\n      const labelingInfoStyleFunctions = this._convertLabelingInfo(\r\n        layerInfo.labelingInfo,\r\n        mapUnits\r\n      );\r\n      styleFunctions = styleFunctions.concat(labelingInfoStyleFunctions);\r\n    }\r\n    if (styleFunctions.length === 1) {\r\n      return styleFunctions[0];\r\n    } else {\r\n      return (() => {\r\n        return (feature, resolution) => {\r\n          let styles = [];\r\n          for (let i = 0, ii = styleFunctions.length; i < ii; ++i) {\r\n            const result = styleFunctions[i].call(null, feature, resolution);\r\n            if (result) {\r\n              styles = styles.concat(result);\r\n            }\r\n          }\r\n          return styles;\r\n        };\r\n      })();\r\n    }\r\n  }\r\n}\r\n","export enum TimeFilterType {\r\n    DATE = 'date',\r\n    TIME = 'time',\r\n    DATETIME = 'datetime',\r\n    YEAR = 'year',\r\n}\r\n\r\nexport enum TimeFilterStyle {\r\n    CALENDAR = 'calendar',\r\n    SLIDER = 'slider',\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { Observable, forkJoin, of } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport { Cacheable } from 'ngx-cacheable';\r\n\r\nimport { WMSCapabilities, WMTSCapabilities } from 'ol/format';\r\nimport { optionsFromCapabilities } from 'ol/source/WMTS.js';\r\nimport olAttribution from 'ol/control/Attribution';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { getResolutionFromScale } from '../../map';\r\nimport { EsriStyleGenerator } from '../utils/esri-style-generator';\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType\r\n} from '../../query/shared/query.enums';\r\n\r\nimport {\r\n  WMTSDataSourceOptions,\r\n  WMSDataSourceOptions,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSourceOptions,\r\n  TileArcGISRestDataSourceOptions\r\n} from './datasources';\r\nimport {\r\n  LegendOptions,\r\n  ItemStyleOptions\r\n} from '../../layer/shared/layers/layer.interface';\r\nimport {\r\n  TimeFilterType,\r\n  TimeFilterStyle\r\n} from '../../filter/shared/time-filter.enum';\r\n\r\nexport enum TypeCapabilities {\r\n  wms = 'wms',\r\n  wmts = 'wmts'\r\n}\r\n\r\nexport type TypeCapabilitiesStrings = keyof typeof TypeCapabilities;\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CapabilitiesService {\r\n  private parsers = {\r\n    wms: new WMSCapabilities(),\r\n    wmts: new WMTSCapabilities()\r\n  };\r\n\r\n  constructor(private http: HttpClient) {}\r\n\r\n  getWMSOptions(\r\n    baseOptions: WMSDataSourceOptions\r\n  ): Observable<WMSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = (baseOptions.params as any).VERSION;\r\n\r\n    return this.getCapabilities('wms', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n  }\r\n\r\n  getWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = baseOptions.version;\r\n\r\n    const options = this.getCapabilities('wmts', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMTSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n\r\n    return options;\r\n  }\r\n\r\n  getCartoOptions(\r\n    baseOptions: CartoDataSourceOptions\r\n  ): Observable<CartoDataSourceOptions> {\r\n    const baseUrl =\r\n      'https://' +\r\n      baseOptions.account +\r\n      '.carto.com/api/v2/viz/' +\r\n      baseOptions.mapId +\r\n      '/viz.json';\r\n\r\n    return this.http\r\n      .jsonp(baseUrl, 'callback')\r\n      .pipe(\r\n        map((cartoOptions: any) =>\r\n          this.parseCartoOptions(baseOptions, cartoOptions)\r\n        )\r\n      );\r\n  }\r\n\r\n  getArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const modifiedUrl = baseOptions.url.replace('FeatureServer', 'MapServer');\r\n    const legendUrl = modifiedUrl + '/legend?f=json';\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legend = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError(err => {\r\n        console.log('No legend associated with this Feature Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legend]).pipe(\r\n      map((res: any) => {\r\n        return this.parseArcgisOptions(baseOptions, res[0], res[1]);\r\n      })\r\n    );\r\n  }\r\n\r\n  getTileArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions\r\n  ): Observable<TileArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const legendUrl = baseOptions.url + '/legend?f=json';\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legendInfo = this.http.get(legendUrl);\r\n\r\n    return forkJoin([arcgisOptions, legendInfo]).pipe(\r\n      map((res: any) =>\r\n        this.parseTileArcgisOptions(baseOptions, res[0], res[1])\r\n      )\r\n    );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getCapabilities(\r\n    service: TypeCapabilitiesStrings,\r\n    baseUrl: string,\r\n    version?: string\r\n  ): Observable<any> {\r\n    const params = new HttpParams({\r\n      fromObject: {\r\n        request: 'GetCapabilities',\r\n        service: service.toUpperCase(),\r\n        version: version || '1.3.0',\r\n        _i: 'true'\r\n      }\r\n    });\r\n\r\n    const request = this.http.get(baseUrl, {\r\n      params,\r\n      responseType: 'text'\r\n    });\r\n\r\n    return request.pipe(\r\n      map(res => {\r\n        try {\r\n          return this.parsers[service].read(res);\r\n        } catch (e) {\r\n          return undefined;\r\n        }\r\n      }),\r\n      catchError(e => {\r\n        e.error.caught = true;\r\n        throw e;\r\n      })\r\n    );\r\n  }\r\n\r\n  private parseWMSOptions(\r\n    baseOptions: WMSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMSDataSourceOptions {\r\n    const layers = (baseOptions.params as any).LAYERS;\r\n    const layer = this.findDataSourceInCapabilities(\r\n      capabilities.Capability.Layer,\r\n      layers\r\n    );\r\n\r\n    if (!layer) {\r\n      throw {\r\n        error: {\r\n          message: 'Layer not found'\r\n        }\r\n      };\r\n    }\r\n    const metadata = layer.DataURL ? layer.DataURL[0] : undefined;\r\n    const abstract = layer.Abstract ? layer.Abstract : undefined;\r\n    const keywordList = layer.KeywordList ? layer.KeywordList : undefined;\r\n    let queryable = layer.queryable;\r\n    const timeFilter = this.getTimeFilter(layer);\r\n    const timeFilterable = timeFilter && Object.keys(timeFilter).length > 0;\r\n    const legendOptions = layer.Style ? this.getStyle(layer.Style) : undefined;\r\n\r\n    let queryFormat: QueryFormat;\r\n    const queryFormatMimeTypePriority = [\r\n      QueryFormatMimeType.GEOJSON,\r\n      QueryFormatMimeType.GEOJSON2,\r\n      QueryFormatMimeType.GML3,\r\n      QueryFormatMimeType.GML2,\r\n      QueryFormatMimeType.JSON,\r\n      QueryFormatMimeType.HTML\r\n    ];\r\n\r\n    for (const mimeType of queryFormatMimeTypePriority) {\r\n      if (\r\n        capabilities.Capability.Request.GetFeatureInfo.Format.indexOf(\r\n          mimeType\r\n        ) !== -1\r\n      ) {\r\n        const keyEnum = Object.keys(QueryFormatMimeType).find(\r\n          key => QueryFormatMimeType[key] === mimeType\r\n        );\r\n        queryFormat = QueryFormat[keyEnum];\r\n        break;\r\n      }\r\n    }\r\n    if (!queryFormat) {\r\n      queryable = false;\r\n    }\r\n\r\n    const options: WMSDataSourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title,\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        metadata: {\r\n          url: metadata ? metadata.OnlineResource : undefined,\r\n          extern: metadata ? true : undefined,\r\n          abstract,\r\n          keywordList\r\n        },\r\n        legendOptions\r\n      },\r\n      queryable,\r\n      queryFormat,\r\n      timeFilter: timeFilterable ? timeFilter : undefined,\r\n      timeFilterable: timeFilterable ? true : undefined\r\n    });\r\n\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMTSDataSourceOptions {\r\n\r\n    // Put Title source in _layerOptionsFromSource. (For source & catalog in _layerOptionsFromSource, if not already on config)\r\n    const layer = capabilities.Contents.Layer.find(el => el.Identifier === baseOptions.layer);\r\n\r\n    const options = optionsFromCapabilities(capabilities, baseOptions);\r\n\r\n    const ouputOptions = Object.assign(options, baseOptions);\r\n    const sourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title}});\r\n\r\n    return ObjectUtils.mergeDeep(sourceOptions, ouputOptions);\r\n  }\r\n\r\n  private parseCartoOptions(\r\n    baseOptions: CartoDataSourceOptions,\r\n    cartoOptions: any\r\n  ): CartoDataSourceOptions {\r\n    const layers = [];\r\n    const params = cartoOptions.layers[1].options.layer_definition;\r\n    params.layers.forEach(element => {\r\n      layers.push({\r\n        type: element.type.toLowerCase(),\r\n        options: element.options,\r\n        legend: element.legend\r\n      });\r\n    });\r\n    const options = ObjectUtils.removeUndefined({\r\n      config: {\r\n        version: params.version,\r\n        layers\r\n      }\r\n    });\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions,\r\n    arcgisOptions: any,\r\n    legend?: any\r\n  ): ArcGISRestDataSourceOptions {\r\n    const legendInfo = legend.layers ? legend : undefined;\r\n    const styleGenerator = new EsriStyleGenerator();\r\n    const units = arcgisOptions.units === 'esriMeters' ? 'm' : 'degrees';\r\n    const style = styleGenerator.generateStyle(arcgisOptions, units);\r\n    const attributions = new olAttribution({\r\n      html: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        legendInfo,\r\n        style,\r\n        timeFilter,\r\n        timeExtent,\r\n        attributions\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params\r\n    });\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseTileArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions,\r\n    arcgisOptions: any,\r\n    legend: any\r\n  ): TileArcGISRestDataSourceOptions {\r\n    const legendInfo = legend.layers ? legend : undefined;\r\n    const attributions = new olAttribution({\r\n      html: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        layers: 'show:' + baseOptions.layer,\r\n        time: timeExtent\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params,\r\n      legendInfo,\r\n      timeFilter,\r\n      attributions\r\n    });\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private findDataSourceInCapabilities(layerArray, name): any {\r\n    if (Array.isArray(layerArray)) {\r\n      let layer;\r\n      layerArray.find(value => {\r\n        layer = this.findDataSourceInCapabilities(value, name);\r\n        return layer !== undefined;\r\n      }, this);\r\n\r\n      return layer;\r\n    } else if (layerArray.Layer) {\r\n      return this.findDataSourceInCapabilities(layerArray.Layer, name);\r\n    } else {\r\n      if (layerArray.Name && layerArray.Name === name) {\r\n        return layerArray;\r\n      }\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  getTimeFilter(layer) {\r\n    let dimension;\r\n\r\n    if (layer.Dimension) {\r\n      const timeFilter: any = {};\r\n      dimension = layer.Dimension[0];\r\n\r\n      if (dimension.values) {\r\n        const minMaxDim = dimension.values.split('/');\r\n        timeFilter.min = minMaxDim[0] !== undefined ? minMaxDim[0] : undefined;\r\n        timeFilter.max = minMaxDim[1] !== undefined ? minMaxDim[1] : undefined;\r\n        timeFilter.step = minMaxDim[2] !== undefined ? minMaxDim[2] : undefined;\r\n      }\r\n\r\n      if (dimension.default) {\r\n        timeFilter.value = dimension.default;\r\n      }\r\n      return timeFilter;\r\n    }\r\n  }\r\n\r\n  getStyle(Style): LegendOptions {\r\n    const styleOptions: ItemStyleOptions[] = Style.map(style => {\r\n      return {\r\n        name: style.Name,\r\n        title: style.Title\r\n      };\r\n    })\r\n      // Handle repeat the style \"default\" in output  (MapServer or OpenLayer)\r\n      .filter(\r\n        (item, index, self) =>\r\n          self.findIndex((i: ItemStyleOptions) => i.name === item.name) ===\r\n          index\r\n      );\r\n\r\n    const legendOptions: LegendOptions = {\r\n      stylesAvailable: styleOptions\r\n    } as LegendOptions;\r\n\r\n    return legendOptions;\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { WMSDataSourceOptions } from '../datasources';\r\n\r\nexport abstract class OptionsService {\r\n  abstract getWMSOptions(\r\n    _baseOptions: WMSDataSourceOptions\r\n  ): Observable<WMSDataSourceOptions>;\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { forkJoin, of, Observable, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { CapabilitiesService } from './capabilities.service';\r\nimport { OptionsService } from './options/options.service';\r\nimport { WFSService } from './datasources/wfs.service';\r\nimport {\r\n  DataSource,\r\n  OSMDataSource,\r\n  OSMDataSourceOptions,\r\n  FeatureDataSource,\r\n  FeatureDataSourceOptions,\r\n  XYZDataSource,\r\n  XYZDataSourceOptions,\r\n  WFSDataSource,\r\n  WFSDataSourceOptions,\r\n  WMTSDataSource,\r\n  WMTSDataSourceOptions,\r\n  WMSDataSource,\r\n  WMSDataSourceOptions,\r\n  CartoDataSource,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSource,\r\n  ArcGISRestDataSourceOptions,\r\n  TileArcGISRestDataSource,\r\n  TileArcGISRestDataSourceOptions,\r\n  WebSocketDataSource,\r\n  AnyDataSourceOptions,\r\n  MVTDataSource,\r\n  MVTDataSourceOptions,\r\n  ClusterDataSource,\r\n  ClusterDataSourceOptions\r\n} from './datasources';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { ProjectionService } from '../../map/shared/projection.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DataSourceService {\r\n  public datasources$ = new BehaviorSubject<DataSource[]>([]);\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    @Optional() private optionsService: OptionsService,\r\n    private wfsDataSourceService: WFSService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private projectionService: ProjectionService\r\n  ) {}\r\n\r\n  createAsyncDataSource(context: AnyDataSourceOptions): Observable<DataSource> {\r\n    if (!context.type) {\r\n      console.error(context);\r\n      throw new Error('Datasource needs a type');\r\n    }\r\n    let dataSource;\r\n    switch (context.type.toLowerCase()) {\r\n      case 'osm':\r\n        dataSource = this.createOSMDataSource(context as OSMDataSourceOptions);\r\n        break;\r\n      case 'vector':\r\n        dataSource = this.createFeatureDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'wfs':\r\n        dataSource = this.createWFSDataSource(context as WFSDataSourceOptions);\r\n        break;\r\n      case 'wms':\r\n        const wmsContext = context as WMSDataSourceOptions;\r\n        ObjectUtils.removeDuplicateCaseInsensitive(wmsContext.params);\r\n        dataSource = this.createWMSDataSource(wmsContext);\r\n        break;\r\n      case 'wmts':\r\n        dataSource = this.createWMTSDataSource(\r\n          context as WMTSDataSourceOptions\r\n        );\r\n        break;\r\n      case 'xyz':\r\n        dataSource = this.createXYZDataSource(context as XYZDataSourceOptions);\r\n        break;\r\n      case 'carto':\r\n        dataSource = this.createCartoDataSource(\r\n          context as CartoDataSourceOptions\r\n        );\r\n        break;\r\n      case 'arcgisrest':\r\n        dataSource = this.createArcGISRestDataSource(\r\n          context as ArcGISRestDataSourceOptions\r\n        );\r\n        break;\r\n      case 'websocket':\r\n        dataSource = this.createWebSocketDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'mvt':\r\n        dataSource = this.createMVTDataSource(context as MVTDataSourceOptions);\r\n        break;\r\n      case 'tilearcgisrest':\r\n        dataSource = this.createTileArcGISRestDataSource(\r\n          context as TileArcGISRestDataSourceOptions\r\n        );\r\n        break;\r\n      case 'cluster':\r\n        dataSource = this.createClusterDataSource(\r\n          context as ClusterDataSourceOptions\r\n        );\r\n        break;\r\n      default:\r\n        console.error(context);\r\n        throw new Error('Invalid datasource type');\r\n    }\r\n\r\n    this.datasources$.next(this.datasources$.value.concat([dataSource]));\r\n\r\n    return dataSource;\r\n  }\r\n\r\n  private createOSMDataSource(\r\n    context: OSMDataSourceOptions\r\n  ): Observable<OSMDataSource> {\r\n    return new Observable(d => d.next(new OSMDataSource(context)));\r\n  }\r\n\r\n  private createFeatureDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<FeatureDataSource> {\r\n    return new Observable(d => d.next(new FeatureDataSource(context)));\r\n  }\r\n\r\n  private createWebSocketDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<WebSocketDataSource> {\r\n    return new Observable(d => d.next(new WebSocketDataSource(context)));\r\n  }\r\n\r\n  private createWFSDataSource(\r\n    context: WFSDataSourceOptions\r\n  ): Observable<WFSDataSource> {\r\n    return new Observable(d =>\r\n      d.next(new WFSDataSource(context, this.wfsDataSourceService))\r\n    );\r\n  }\r\n\r\n  private createWMSDataSource(context: WMSDataSourceOptions): Observable<any> {\r\n    const observables = [];\r\n    if (context.optionsFromCapabilities) {\r\n      observables.push(\r\n        this.capabilitiesService.getWMSOptions(context).pipe(\r\n          catchError(e => {\r\n            const title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            const message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailable',\r\n              { value: context.params.LAYERS }\r\n            );\r\n\r\n            this.messageService.error(message, title);\r\n            throw e;\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getWMSOptions(context).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    observables.push(of(context));\r\n\r\n    return forkJoin(observables).pipe(\r\n      map((options: WMSDataSourceOptions[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new WMSDataSource(optionsMerged, this.wfsDataSourceService);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createWMTSDataSource(\r\n    context: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSource> {\r\n    if (context.optionsFromCapabilities) {\r\n      return this.capabilitiesService.getWMTSOptions(context).pipe(\r\n        map((options: WMTSDataSourceOptions) => {\r\n          return options ? new WMTSDataSource(options) : undefined;\r\n        }),\r\n        catchError(() => {\r\n          const title = this.languageService.translate.instant(\r\n            'igo.geo.dataSource.unavailableTitle'\r\n          );\r\n          const message = this.languageService.translate.instant(\r\n            'igo.geo.dataSource.unavailable',\r\n            { value: context.layer }\r\n          );\r\n\r\n          this.messageService.error(message, title);\r\n          return of(undefined);\r\n        })\r\n      );\r\n    }\r\n\r\n    return new Observable(d => d.next(new WMTSDataSource(context)));\r\n  }\r\n\r\n  private createXYZDataSource(\r\n    context: XYZDataSourceOptions\r\n  ): Observable<XYZDataSource> {\r\n    return new Observable(d => d.next(new XYZDataSource(context)));\r\n  }\r\n\r\n  private createCartoDataSource(\r\n    context: CartoDataSourceOptions\r\n  ): Observable<CartoDataSource> {\r\n    if (context.mapId) {\r\n      return this.capabilitiesService\r\n        .getCartoOptions(context)\r\n        .pipe(\r\n          map((options: CartoDataSourceOptions) => new CartoDataSource(options))\r\n        );\r\n    }\r\n    return new Observable(d => d.next(new CartoDataSource(context)));\r\n  }\r\n\r\n  private createArcGISRestDataSource(\r\n    context: ArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestDataSource> {\r\n    return this.capabilitiesService\r\n      .getArcgisOptions(context)\r\n      .pipe(\r\n        map(\r\n          (options: ArcGISRestDataSourceOptions) =>\r\n            new ArcGISRestDataSource(options)\r\n        )\r\n      );\r\n  }\r\n\r\n  private createTileArcGISRestDataSource(\r\n    context: TileArcGISRestDataSourceOptions\r\n  ): Observable<TileArcGISRestDataSource> {\r\n    return this.capabilitiesService\r\n      .getTileArcgisOptions(context)\r\n      .pipe(\r\n        map(\r\n          (options: TileArcGISRestDataSourceOptions) =>\r\n            new TileArcGISRestDataSource(options)\r\n        )\r\n      );\r\n  }\r\n\r\n  private createMVTDataSource(\r\n    context: MVTDataSourceOptions\r\n  ): Observable<MVTDataSource> {\r\n    return new Observable(d => d.next(new MVTDataSource(context)));\r\n  }\r\n\r\n  private createClusterDataSource(\r\n    context: ClusterDataSourceOptions\r\n  ): Observable<ClusterDataSource> {\r\n    return new Observable(d => d.next(new ClusterDataSource(context)));\r\n  }\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { WMSDataSourceOptions } from '../datasources';\r\nimport { OptionsService } from './options.service';\r\nimport { OptionsApiOptions } from './options-api.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OptionsApiService extends OptionsService {\r\n  private urlApi: string;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    @Inject('options') options: OptionsApiOptions = {}\r\n  ) {\r\n    super();\r\n    this.urlApi = options.url || this.urlApi;\r\n  }\r\n\r\n  getWMSOptions(\r\n    baseOptions: WMSDataSourceOptions\r\n  ): Observable<WMSDataSourceOptions> {\r\n    if (!this.urlApi) {\r\n      return of({} as WMSDataSourceOptions);\r\n    }\r\n    const params = new HttpParams({\r\n      fromObject: {\r\n        type: baseOptions.type,\r\n        url: baseOptions.url,\r\n        layers: baseOptions.params.LAYERS\r\n      }\r\n    });\r\n\r\n    const request = this.http.get(this.urlApi, {\r\n      params\r\n    });\r\n\r\n    return request.pipe(\r\n      map(\r\n        (res: {\r\n          sourceOptions: WMSDataSourceOptions;\r\n          layerOptions: { [keys: string]: string };\r\n        }) => {\r\n          if (!res || !res.sourceOptions) {\r\n            return {} as WMSDataSourceOptions;\r\n          }\r\n          res.sourceOptions._layerOptionsFromSource = res.layerOptions;\r\n          return res.sourceOptions;\r\n        }\r\n      )\r\n    );\r\n  }\r\n}\r\n","import { Injectable, Injector, Optional } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport stylefunction from 'ol-mapbox-style/stylefunction';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport {\r\n  OSMDataSource,\r\n  FeatureDataSource,\r\n  XYZDataSource,\r\n  WFSDataSource,\r\n  WMTSDataSource,\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  ArcGISRestDataSource,\r\n  TileArcGISRestDataSource,\r\n  WebSocketDataSource,\r\n  MVTDataSource,\r\n  ClusterDataSource\r\n} from '../../datasource';\r\n\r\nimport { DataSourceService } from '../../datasource/shared/datasource.service';\r\n\r\nimport {\r\n  Layer,\r\n  ImageLayer,\r\n  ImageLayerOptions,\r\n  TileLayer,\r\n  TileLayerOptions,\r\n  VectorLayer,\r\n  VectorLayerOptions,\r\n  AnyLayerOptions,\r\n  VectorTileLayer,\r\n  VectorTileLayerOptions\r\n} from './layers';\r\n\r\nimport { StyleService } from './style.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private styleService: StyleService,\r\n    private dataSourceService: DataSourceService,\r\n    @Optional() private authInterceptor: AuthInterceptor\r\n  ) {}\r\n\r\n  createLayer(layerOptions: AnyLayerOptions): Layer {\r\n    if (!layerOptions.source) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      layerOptions.source.options &&\r\n      layerOptions.source.options._layerOptionsFromSource\r\n    ) {\r\n      layerOptions = ObjectUtils.mergeDeep(\r\n        layerOptions.source.options._layerOptionsFromSource,\r\n        layerOptions || {}\r\n      );\r\n    }\r\n\r\n    let layer;\r\n    switch (layerOptions.source.constructor) {\r\n      case OSMDataSource:\r\n      case WMTSDataSource:\r\n      case XYZDataSource:\r\n      case CartoDataSource:\r\n      case TileArcGISRestDataSource:\r\n        layer = this.createTileLayer(layerOptions as TileLayerOptions);\r\n        break;\r\n      case FeatureDataSource:\r\n      case WFSDataSource:\r\n      case ArcGISRestDataSource:\r\n      case WebSocketDataSource:\r\n      case ClusterDataSource:\r\n        layer = this.createVectorLayer(layerOptions as VectorLayerOptions);\r\n        break;\r\n      case WMSDataSource:\r\n        layer = this.createImageLayer(layerOptions as ImageLayerOptions);\r\n        break;\r\n      case MVTDataSource:\r\n        layer = this.createVectorTileLayer(\r\n          layerOptions as VectorTileLayerOptions\r\n        );\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return layer;\r\n  }\r\n\r\n  createAsyncLayer(layerOptions: AnyLayerOptions): Observable<Layer> {\r\n    if (layerOptions.source) {\r\n      return new Observable(d => d.next(this.createLayer(layerOptions)));\r\n    }\r\n\r\n    return this.dataSourceService\r\n      .createAsyncDataSource(layerOptions.sourceOptions)\r\n      .pipe(\r\n        map(source => {\r\n          if (source === undefined) {\r\n            return undefined;\r\n          }\r\n          return this.createLayer(Object.assign(layerOptions, { source }));\r\n        })\r\n      );\r\n  }\r\n\r\n  private createImageLayer(layerOptions: ImageLayerOptions): ImageLayer {\r\n    return new ImageLayer(layerOptions, this.authInterceptor);\r\n  }\r\n\r\n  private createTileLayer(layerOptions: TileLayerOptions): TileLayer {\r\n    return new TileLayer(layerOptions);\r\n  }\r\n\r\n  private createVectorLayer(layerOptions: VectorLayerOptions): VectorLayer {\r\n    let style;\r\n    let olLayer;\r\n    if (layerOptions.style !== undefined) {\r\n      style = this.styleService.createStyle(layerOptions.style);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ArcGISRestDataSource) {\r\n      const source = layerOptions.source as ArcGISRestDataSource;\r\n      style = source.options.params.style;\r\n    } else if (layerOptions.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = feature => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.styleByAttribute\r\n        );\r\n      };\r\n      olLayer = new VectorLayer(layerOptions);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ClusterDataSource) {\r\n      const serviceStyle = this.styleService;\r\n      const baseStyle = layerOptions.clusterBaseStyle;\r\n      layerOptions.style = feature => {\r\n        return serviceStyle.createClusterStyle(\r\n          feature,\r\n          layerOptions.clusterParam,\r\n          baseStyle\r\n        );\r\n      };\r\n      olLayer = new VectorLayer(layerOptions);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!olLayer) {\r\n      olLayer = new VectorLayer(layerOptionsOl);\r\n    }\r\n\r\n    this.applyMapboxStyle(olLayer, layerOptionsOl);\r\n\r\n    return olLayer;\r\n  }\r\n\r\n  private createVectorTileLayer(\r\n    layerOptions: VectorTileLayerOptions\r\n  ): VectorTileLayer {\r\n    let style;\r\n    let olLayer;\r\n\r\n    if (layerOptions.style !== undefined) {\r\n      style = this.styleService.createStyle(layerOptions.style);\r\n    }\r\n\r\n    if (layerOptions.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = feature => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.styleByAttribute\r\n        );\r\n      };\r\n      olLayer = new VectorTileLayer(layerOptions);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!olLayer) {\r\n      olLayer = new VectorTileLayer(layerOptionsOl);\r\n    }\r\n\r\n    this.applyMapboxStyle(olLayer, layerOptionsOl);\r\n    return olLayer;\r\n  }\r\n\r\n  private applyMapboxStyle(layer: Layer, layerOptions: VectorTileLayerOptions) {\r\n    if (layerOptions.mapboxStyle) {\r\n      this.getMapboxGlStyle(layerOptions.mapboxStyle.url).subscribe(res => {\r\n        stylefunction(layer.ol, res, layerOptions.mapboxStyle.source);\r\n      });\r\n    }\r\n  }\r\n\r\n  public getMapboxGlStyle(url: string) {\r\n    return this.http.get(url).pipe(\r\n      map((res: any) => res),\r\n      catchError(err => {\r\n        console.log('No style was found');\r\n        return of(err);\r\n      })\r\n    );\r\n  }\r\n}\r\n","export enum CatalogItemType {\r\n  Layer = 'layer',\r\n  Group = 'group'\r\n}\r\n\r\nexport enum TypeCatalog {\r\n  wms, wmts, baselayers, composite\r\n}\r\n\r\nexport type TypeCatalogStrings = keyof typeof TypeCatalog;\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { TooltipType } from '../../layer';\r\nimport { TimeFilterOptions } from '../../filter';\r\nimport { QueryFormat, QueryHtmlTarget  } from '../../query';\r\n\r\nimport { ICatalog, ICompositeCatalog , CatalogItem, CatalogItemGroup } from './catalog.interface';\r\nimport { CatalogService } from './catalog.service';\r\nimport { TypeCatalog, TypeCatalogStrings } from './catalog.enum';\r\n\r\nexport abstract class Catalog implements ICatalog {\r\n\r\n    // ICatalog -----------------------------\r\n    id: string;\r\n    title: string;\r\n    url: string;\r\n    items?: CatalogItem[];\r\n    type?: TypeCatalogStrings;\r\n    version?: string;\r\n    matrixSet?: string;\r\n    requestEncoding?: string;\r\n    regFilters?: string[];\r\n    groupImpose?: CatalogItemGroup;\r\n    timeFilter?: TimeFilterOptions;\r\n    queryFormat?: QueryFormat;\r\n    queryHtmlTarget?: QueryHtmlTarget;\r\n    queryParams?: { [key: string]: string; };\r\n    sourceOptions?: { [key: string]: any; };\r\n    count?: number;\r\n    tooltipType?: TooltipType.ABSTRACT | TooltipType.TITLE;\r\n    sortDirection?: 'asc' | 'desc';\r\n    setCrossOriginAnonymous?: boolean;\r\n    showLegend?: boolean;\r\n    // ICatalog -----------------------------\r\n\r\n    protected catalogService: CatalogService;\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        Object.assign(this, options);\r\n        this.catalogService = service;\r\n    }\r\n\r\n    public abstract collectCatalogItems(): Observable<CatalogItem[]>;\r\n}\r\n\r\nclass WMSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wms];\r\n        this.type =  TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass WMTSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wmts];\r\n        this.type =  TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMTSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass BaselayersCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.baselayers];\r\n        this.type =  TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItemGroup[]> {\r\n        return this.catalogService.loadCatalogBaseLayerItems(this);\r\n    }\r\n}\r\n\r\nexport class CompositeCatalog extends Catalog implements ICompositeCatalog {\r\n    composite: ICatalog[];\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.composite];\r\n        this.type =  TypeCatalog[sType];\r\n        this.url = null;\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogCompositeLayerItems(this);\r\n    }\r\n}\r\n\r\nexport class CatalogFactory {\r\n\r\n    public static createInstanceCatalog(options: Catalog, service: CatalogService): Catalog {\r\n\r\n        let catalog: Catalog;\r\n        if (options.hasOwnProperty('composite')) {\r\n            catalog = new CompositeCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.baselayers]) {\r\n            catalog = new BaselayersCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.wmts]) {\r\n            catalog = new WMTSCatalog(options, service);\r\n        } else {\r\n            catalog = new WMSCatalog(options, service);\r\n        }\r\n\r\n        return catalog;\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map, mergeMap } from 'rxjs/operators';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport * as olextent from 'ol/extent';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport olFeature from 'ol/Feature';\r\nimport * as olgeom from 'ol/geom';\r\n\r\nimport { uuid } from '@igo2/utils';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport {\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  TileArcGISRestDataSource,\r\n  WMSDataSourceOptions\r\n} from '../../datasource';\r\n\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType,\r\n  QueryHtmlTarget\r\n} from './query.enums';\r\nimport {\r\n  QueryOptions,\r\n  QueryableDataSource,\r\n  QueryableDataSourceOptions\r\n} from './query.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class QueryService {\r\n  public queryEnabled = true;\r\n\r\n  constructor(private http: HttpClient) {}\r\n\r\n  query(layers: Layer[], options: QueryOptions): Observable<Feature[]>[] {\r\n    return layers\r\n      .filter((layer: Layer) => layer.visible && layer.isInResolutionsRange)\r\n      .map((layer: Layer) => this.queryLayer(layer, options));\r\n  }\r\n\r\n  queryLayer(layer: Layer, options: QueryOptions): Observable<Feature[]> {\r\n    const url = this.getQueryUrl(layer.dataSource, options);\r\n    if (!url) {\r\n      return of([]);\r\n    }\r\n\r\n    if (\r\n      (layer.dataSource as QueryableDataSource).options.queryFormat ===\r\n      QueryFormat.HTMLGML2\r\n    ) {\r\n      const urlGml = this.getQueryUrl(layer.dataSource, options, true);\r\n      return this.http.get(urlGml, { responseType: 'text' }).pipe(\r\n        mergeMap(gmlRes => {\r\n          const imposedGeom = this.mergeGML(gmlRes, url);\r\n          return this.http\r\n            .get(url, { responseType: 'text' })\r\n            .pipe(\r\n              map(res =>\r\n                this.extractData(res, layer, options, url, imposedGeom)\r\n              )\r\n            );\r\n        })\r\n      );\r\n    }\r\n\r\n    const request = this.http.get(url, { responseType: 'text' });\r\n    return request.pipe(map(res => this.extractData(res, layer, options, url)));\r\n  }\r\n\r\n  private mergeGML(gmlRes, url) {\r\n    let parser = new olFormatGML2();\r\n    let features = parser.readFeatures(gmlRes);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      parser = new olformat.WMSGetFeatureInfo();\r\n      features = parser.readFeatures(gmlRes);\r\n    }\r\n    const olmline = new olgeom.MultiLineString([]);\r\n    let pts;\r\n    const ptsArray = [];\r\n    let olmpoly = new olgeom.MultiPolygon([]);\r\n    let firstFeatureType;\r\n    const nbFeatures = features.length;\r\n\r\n    // Check if geometry intersect bbox\r\n    // for geoserver getfeatureinfo response in data projection, not call projection\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const bbox = bboxRaw.split(',');\r\n    const bboxExtent = olextent.createEmpty();\r\n    olextent.extend(bboxExtent, bbox);\r\n    const outBboxExtent = false;\r\n    features.map(feature => {\r\n      /*  if (!feature.getGeometry().simplify(100).intersectsExtent(bboxExtent)) {\r\n        outBboxExtent = true;\r\n        // TODO: Check to project the geometry?\r\n      }*/\r\n      const featureGeometryCoordinates = feature.getGeometry().getCoordinates();\r\n      const featureGeometryType = feature.getGeometry().getType();\r\n\r\n      if (!firstFeatureType && !outBboxExtent) {\r\n        firstFeatureType = featureGeometryType;\r\n      }\r\n      if (!outBboxExtent) {\r\n        switch (featureGeometryType) {\r\n          case 'Point':\r\n            if (nbFeatures === 1) {\r\n              pts = new olgeom.Point(featureGeometryCoordinates, 'XY');\r\n            } else {\r\n              ptsArray.push(featureGeometryCoordinates);\r\n            }\r\n            break;\r\n          case 'LineString':\r\n            olmline.appendLineString(\r\n              new olgeom.LineString(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'Polygon':\r\n            olmpoly.appendPolygon(\r\n              new olgeom.Polygon(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'MultiPolygon':\r\n            olmpoly = new olgeom.MultiPolygon(featureGeometryCoordinates, 'XY');\r\n            break;\r\n          default:\r\n            return;\r\n        }\r\n      }\r\n    });\r\n\r\n    let olmpts;\r\n    if (ptsArray.length === 0 && pts) {\r\n      olmpts = {\r\n        type: pts.getType(),\r\n        coordinates: pts.getCoordinates()\r\n      };\r\n    } else {\r\n      olmpts = {\r\n        type: 'Polygon',\r\n        coordinates: [this.convexHull(ptsArray)]\r\n      };\r\n    }\r\n\r\n    switch (firstFeatureType) {\r\n      case 'LineString':\r\n        return {\r\n          type: olmline.getType(),\r\n          coordinates: olmline.getCoordinates()\r\n        };\r\n      case 'Point':\r\n        return olmpts;\r\n      case 'Polygon':\r\n        return {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n      case 'MultiPolygon':\r\n        return {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n\r\n  cross(a, b, o) {\r\n    return (a[0] - o[0]) * (b[1] - o[1]) - (a[1] - o[1]) * (b[0] - o[0]);\r\n  }\r\n\r\n  /**\r\n   * @param points An array of [X, Y] coordinates\r\n   * This method is use instead of turf.js convexHull because Turf needs at least 3 point to make a hull.\r\n   * https://en.wikibooks.org/wiki/Algorithm_Implementation/Geometry/Convex_hull/Monotone_chain#JavaScript\r\n   */\r\n  convexHull(points) {\r\n    points.sort((a, b) => {\r\n      return a[0] === b[0] ? a[1] - b[1] : a[0] - b[0];\r\n    });\r\n\r\n    const lower = [];\r\n    for (const point of points) {\r\n      while (\r\n        lower.length >= 2 &&\r\n        this.cross(lower[lower.length - 2], lower[lower.length - 1], point) <= 0\r\n      ) {\r\n        lower.pop();\r\n      }\r\n      lower.push(point);\r\n    }\r\n\r\n    const upper = [];\r\n    for (let i = points.length - 1; i >= 0; i--) {\r\n      while (\r\n        upper.length >= 2 &&\r\n        this.cross(\r\n          upper[upper.length - 2],\r\n          upper[upper.length - 1],\r\n          points[i]\r\n        ) <= 0\r\n      ) {\r\n        upper.pop();\r\n      }\r\n      upper.push(points[i]);\r\n    }\r\n\r\n    upper.pop();\r\n    lower.pop();\r\n    return lower.concat(upper);\r\n  }\r\n\r\n  private extractData(\r\n    res,\r\n    layer: Layer,\r\n    options: QueryOptions,\r\n    url: string,\r\n    imposedGeometry?\r\n  ): Feature[] {\r\n    const queryDataSource = layer.dataSource as QueryableDataSource;\r\n\r\n    const allowedFieldsAndAlias = this.getAllowedFieldsAndAlias(layer);\r\n    let features = [];\r\n    switch (queryDataSource.options.queryFormat) {\r\n      case QueryFormat.GML3:\r\n        features = this.extractGML3Data(\r\n          res,\r\n          layer.zIndex,\r\n          allowedFieldsAndAlias\r\n        );\r\n        break;\r\n      case QueryFormat.JSON:\r\n      case QueryFormat.GEOJSON:\r\n      case QueryFormat.GEOJSON2:\r\n        features = this.extractGeoJSONData(res);\r\n        break;\r\n      case QueryFormat.ESRIJSON:\r\n        features = this.extractEsriJSONData(res, layer.zIndex);\r\n        break;\r\n      case QueryFormat.TEXT:\r\n        features = this.extractTextData(res);\r\n        break;\r\n      case QueryFormat.HTML:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url\r\n        );\r\n        break;\r\n      case QueryFormat.HTMLGML2:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url,\r\n          imposedGeometry\r\n        );\r\n        break;\r\n      case QueryFormat.GML2:\r\n      default:\r\n        features = this.extractGML2Data(res, layer, allowedFieldsAndAlias);\r\n        break;\r\n    }\r\n\r\n    if (features.length > 0 && features[0].geometry == null) {\r\n      const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n      for (const feature of features) {\r\n        feature.geometry = geomToAdd;\r\n      }\r\n    }\r\n\r\n    return features.map((feature: Feature, index: number) => {\r\n      const mapLabel = feature.properties[queryDataSource.mapLabel];\r\n\r\n      let exclude;\r\n      if (layer.options.sourceOptions.type === 'wms') {\r\n        const sourceOptions = layer.options\r\n          .sourceOptions as WMSDataSourceOptions;\r\n        exclude = sourceOptions ? sourceOptions.excludeAttribute : undefined;\r\n      }\r\n\r\n      let title = this.getQueryTitle(feature, layer);\r\n      if (!title && features.length > 1) {\r\n        title = `${layer.title} (${index + 1})`;\r\n      } else if (!title) {\r\n        title = layer.title;\r\n      }\r\n\r\n      const meta = Object.assign({}, feature.meta || {}, {\r\n        id: uuid(),\r\n        title,\r\n        mapTitle: mapLabel,\r\n        sourceTitle: layer.title,\r\n        order: 1000 - layer.zIndex,\r\n        excludeAttribute: exclude\r\n      });\r\n\r\n      return Object.assign(feature, {\r\n        meta,\r\n        projection:\r\n          queryDataSource.options.type === 'carto'\r\n            ? 'EPSG:4326'\r\n            : options.projection\r\n      });\r\n    });\r\n  }\r\n\r\n  private createGeometryFromUrlClick(url) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const width = parseInt(searchParams.width, 10);\r\n    const height = parseInt(searchParams.height, 10);\r\n    const xPosition = parseInt(searchParams.i || searchParams.x, 10);\r\n    const yPosition = parseInt(searchParams.j || searchParams.y, 10);\r\n    const projection = searchParams.crs || searchParams.srs || 'EPSG:3857';\r\n\r\n    const bbox = bboxRaw.split(',');\r\n    let threshold =\r\n      (Math.abs(parseFloat(bbox[0])) - Math.abs(parseFloat(bbox[2]))) * 0.05;\r\n\r\n    // for context in degree (EPSG:4326,4269...)\r\n    if (Math.abs(parseFloat(bbox[0])) < 180) {\r\n      threshold = 0.045;\r\n    }\r\n    const clickx =\r\n      parseFloat(bbox[0]) +\r\n      (Math.abs(parseFloat(bbox[0]) - parseFloat(bbox[2])) * xPosition) /\r\n        width -\r\n      threshold;\r\n    const clicky =\r\n      parseFloat(bbox[1]) +\r\n      (Math.abs(parseFloat(bbox[1]) - parseFloat(bbox[3])) * yPosition) /\r\n        height -\r\n      threshold;\r\n    const clickx1 = clickx + threshold * 2;\r\n    const clicky1 = clicky + threshold * 2;\r\n\r\n    const wktPoly =\r\n      'POLYGON((' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      '))';\r\n\r\n    const format = new olformat.WKT();\r\n    const tenPercentWidthGeom = format.readFeature(wktPoly);\r\n    const f = tenPercentWidthGeom.getGeometry() as any;\r\n\r\n    const newGeom = {\r\n      type: f.getType(),\r\n      coordinates: f.getCoordinates()\r\n    };\r\n\r\n    return newGeom;\r\n  }\r\n\r\n  private extractGML2Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    let parser = new olFormatGML2();\r\n    let features = parser.readFeatures(res);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      parser = new olformat.WMSGetFeatureInfo();\r\n      try {\r\n        features = parser.readFeatures(res);\r\n      } catch (e) {\r\n        console.warn(\r\n          'query.service: Multipolygons are badly managed in mapserver in GML2. Use another format.'\r\n        );\r\n      }\r\n    }\r\n\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGML3Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    const parser = new olFormatGML3();\r\n    let features = [];\r\n    try {\r\n      features = parser.readFeatures(res);\r\n    } catch (e) {\r\n      console.warn('query.service: GML3 is not well supported');\r\n    }\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGeoJSONData(res) {\r\n    let features = [];\r\n    try {\r\n      features = JSON.parse(res).features;\r\n    } catch (e) {\r\n      console.warn('query.service: Unable to parse geojson', '\\n', res);\r\n    }\r\n    return features;\r\n  }\r\n\r\n  private extractEsriJSONData(res, zIndex) {\r\n    const parser = new olFormatEsriJSON();\r\n    const features = parser.readFeatures(res);\r\n\r\n    return features.map(feature => this.featureToResult(feature, zIndex));\r\n  }\r\n\r\n  private extractTextData(res) {\r\n    // TODO\r\n    return [];\r\n  }\r\n\r\n  private extractHtmlData(\r\n    res,\r\n    htmlTarget: QueryHtmlTarget,\r\n    url,\r\n    imposedGeometry?\r\n  ) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const projection = searchParams.crs || searchParams.srs || 'EPSG:3857';\r\n    const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n    if (\r\n      htmlTarget !== QueryHtmlTarget.BLANK &&\r\n      htmlTarget !== QueryHtmlTarget.IFRAME\r\n    ) {\r\n      htmlTarget = QueryHtmlTarget.IFRAME;\r\n    }\r\n\r\n    const bodyTagStart = res.toLowerCase().indexOf('<body>');\r\n    const bodyTagEnd = res.toLowerCase().lastIndexOf('</body>') + 7;\r\n    // replace \\r \\n  and ' ' with '' to validate if the body is really empty.\r\n    const body = res.slice(bodyTagStart, bodyTagEnd).replace(/(\\r|\\n|\\s)/g, '');\r\n    if (body === '<body></body>' || res === '') {\r\n      return [];\r\n    }\r\n\r\n    return [\r\n      {\r\n        type: FEATURE,\r\n        projection,\r\n        properties: { target: htmlTarget, body: res, url },\r\n        geometry: imposedGeometry || geomToAdd\r\n      }\r\n    ];\r\n  }\r\n\r\n  private getQueryParams(url) {\r\n    const queryString = url.split('?');\r\n    if (!queryString[1]) {\r\n      return;\r\n    }\r\n    const pairs = queryString[1].split('&');\r\n\r\n    const result = {};\r\n    pairs.forEach(pair => {\r\n      pair = pair.split('=');\r\n      result[pair[0]] = decodeURIComponent(pair[1] || '');\r\n    });\r\n    return result;\r\n  }\r\n\r\n  public featureToResult(\r\n    featureOL: olFeature,\r\n    zIndex: number,\r\n    allowedFieldsAndAlias?\r\n  ): Feature {\r\n    const featureGeometry = featureOL.getGeometry() as any;\r\n    const properties: any = Object.assign({}, featureOL.getProperties());\r\n    delete properties.geometry;\r\n    delete properties.boundedBy;\r\n    delete properties.shape;\r\n    delete properties.SHAPE;\r\n    delete properties.the_geom;\r\n\r\n    let geometry;\r\n    if (featureGeometry !== undefined) {\r\n      geometry = {\r\n        type: featureGeometry.getType(),\r\n        coordinates: featureGeometry.getCoordinates()\r\n      };\r\n    }\r\n\r\n    return {\r\n      type: FEATURE,\r\n      projection: undefined,\r\n      properties,\r\n      geometry,\r\n      meta: {\r\n        id: uuid(),\r\n        order: 1000 - zIndex,\r\n        alias: allowedFieldsAndAlias\r\n      }\r\n    };\r\n  }\r\n\r\n  private getQueryUrl(\r\n    datasource: QueryableDataSource,\r\n    options: QueryOptions,\r\n    forceGML2 = false\r\n  ): string {\r\n    let url;\r\n    switch (datasource.constructor) {\r\n      case WMSDataSource:\r\n        const wmsDatasource = datasource as WMSDataSource;\r\n\r\n        const WMSGetFeatureInfoOptions = {\r\n          INFO_FORMAT:\r\n            wmsDatasource.params.INFO_FORMAT ||\r\n            this.getMimeInfoFormat(datasource.options.queryFormat),\r\n          QUERY_LAYERS: wmsDatasource.params.LAYERS,\r\n          FEATURE_COUNT: wmsDatasource.params.FEATURE_COUNT || '5'\r\n        };\r\n\r\n        if (forceGML2) {\r\n          WMSGetFeatureInfoOptions.INFO_FORMAT = this.getMimeInfoFormat(\r\n            QueryFormat.GML2\r\n          );\r\n        }\r\n\r\n        url = wmsDatasource.ol.getGetFeatureInfoUrl(\r\n          options.coordinates,\r\n          options.resolution,\r\n          options.projection,\r\n          WMSGetFeatureInfoOptions\r\n        );\r\n        // const wmsVersion =\r\n        //   wmsDatasource.params.VERSION ||\r\n        //   wmsDatasource.params.version ||\r\n        //   '1.3.0';\r\n        // if (wmsVersion !== '1.3.0') {\r\n        //   url = url.replace('&I=', '&X=');\r\n        //   url = url.replace('&J=', '&Y=');\r\n        // }\r\n        break;\r\n      case CartoDataSource:\r\n        const cartoDatasource = datasource as CartoDataSource;\r\n        const baseUrl =\r\n          'https://' +\r\n          cartoDatasource.options.account +\r\n          '.carto.com/api/v2/sql?';\r\n        const format = 'format=GeoJSON';\r\n        const sql =\r\n          '&q=' + cartoDatasource.options.config.layers[0].options.sql;\r\n        const clause =\r\n          ' WHERE ST_Intersects(the_geom_webmercator,ST_BUFFER(ST_SetSRID(ST_POINT(';\r\n        const meters = cartoDatasource.options.queryPrecision\r\n          ? cartoDatasource.options.queryPrecision\r\n          : '1000';\r\n        const coordinates =\r\n          options.coordinates[0] +\r\n          ',' +\r\n          options.coordinates[1] +\r\n          '),3857),' +\r\n          meters +\r\n          '))';\r\n\r\n        url = `${baseUrl}${format}${sql}${clause}${coordinates}`;\r\n        break;\r\n      case TileArcGISRestDataSource:\r\n        const tileArcGISRestDatasource = datasource as TileArcGISRestDataSource;\r\n        let extent = olextent.boundingExtent([options.coordinates]);\r\n        if (tileArcGISRestDatasource.options.queryPrecision) {\r\n          extent = olextent.buffer(\r\n            extent,\r\n            tileArcGISRestDatasource.options.queryPrecision\r\n          );\r\n        }\r\n        const serviceUrl =\r\n          tileArcGISRestDatasource.options.url +\r\n          '/' +\r\n          tileArcGISRestDatasource.options.layer +\r\n          '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        url = `${serviceUrl}?${params.join('&')}`;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return url;\r\n  }\r\n\r\n  private getMimeInfoFormat(queryFormat: string) {\r\n    let mime = 'application/vnd.ogc.gml';\r\n    const keyEnum = Object.keys(QueryFormat).find(\r\n      key => QueryFormat[key] === queryFormat\r\n    );\r\n    if (keyEnum) {\r\n      mime = QueryFormatMimeType[keyEnum];\r\n    }\r\n\r\n    return mime;\r\n  }\r\n\r\n  getAllowedFieldsAndAlias(layer: any) {\r\n    let allowedFieldsAndAlias;\r\n    if (\r\n      layer.options &&\r\n      layer.options.source &&\r\n      layer.options.source.options &&\r\n      layer.options.source.options.sourceFields &&\r\n      layer.options.source.options.sourceFields.length >= 1\r\n    ) {\r\n      allowedFieldsAndAlias = {};\r\n      layer.options.source.options.sourceFields.forEach(sourceField => {\r\n        const alias = sourceField.alias ? sourceField.alias : sourceField.name;\r\n        allowedFieldsAndAlias[sourceField.name] = alias;\r\n      });\r\n    }\r\n    return allowedFieldsAndAlias;\r\n  }\r\n\r\n  getQueryTitle(feature: Feature, layer: Layer): string {\r\n    let title;\r\n    if (layer.options && layer.options.source && layer.options.source.options) {\r\n      const dataSourceOptions = layer.options.source\r\n        .options as QueryableDataSourceOptions;\r\n      if (dataSourceOptions.queryTitle) {\r\n        title = this.getLabelMatch(feature, dataSourceOptions.queryTitle);\r\n      }\r\n    }\r\n\r\n    return title;\r\n  }\r\n\r\n  getLabelMatch(feature: Feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.properties[v[1]]);\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.properties[labelMatch] || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n}\r\n","import { getEntityTitle } from '@igo2/common';\r\nimport {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  AfterViewInit,\r\n  Self\r\n} from '@angular/core';\r\n\r\nimport { Subscription, Observable, of, zip } from 'rxjs';\r\n\r\nimport OlFeature from 'ol/Feature';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlLayer from 'ol/layer/Layer';\r\n\r\nimport OlDragBoxInteraction from 'ol/interaction/DragBox';\r\nimport { MapBrowserPointerEvent as OlMapBrowserPointerEvent } from 'ol/MapBrowserEvent';\r\nimport { ListenerFunction } from 'ol/events';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { renderFeatureFromOl } from '../../feature/shared/feature.utils';\r\nimport { featureFromOl } from '../../feature/shared/feature.utils';\r\nimport { QueryService } from './query.service';\r\nimport { layerIsQueryable, olLayerIsQueryable } from './query.utils';\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\n\r\n/**\r\n * This directive makes a map queryable with a click of with a drag box.\r\n * By default, all layers are queryable but this can ben controlled at\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoQuery]'\r\n})\r\nexport class QueryDirective implements AfterViewInit, OnDestroy {\r\n  /**\r\n   * Subscriptions to ongoing queries\r\n   */\r\n  private queries$$: Subscription[] = [];\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener: ListenerFunction;\r\n\r\n  /**\r\n   * OL drag box interaction\r\n   */\r\n  private olDragBoxInteraction: OlDragBoxInteraction;\r\n\r\n  /**\r\n   * Ol drag box \"end\" event key\r\n   */\r\n  private olDragBoxInteractionEndKey: string;\r\n\r\n  /**\r\n   * Whter to query features or not\r\n   */\r\n  @Input() queryFeatures: boolean = false;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesHitTolerance: number = 0;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesCondition: (olLayer: OlLayer) => boolean;\r\n\r\n  /**\r\n   * Whether all query should complete before emitting an event\r\n   */\r\n  @Input() waitForAllQueries: boolean = true;\r\n\r\n  /**\r\n   * Event emitted when a query (or all queries) complete\r\n   */\r\n  @Output() query = new EventEmitter<{\r\n    features: Feature[] | Feature[][];\r\n    event: OlMapBrowserPointerEvent;\r\n  }>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return (this.component.map as any) as IgoMap;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private queryService: QueryService\r\n  ) {}\r\n\r\n  /**\r\n   * Start listening to click and drag box events\r\n   * @internal\r\n   */\r\n  ngAfterViewInit() {\r\n    this.listenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to click and drag box events and cancel ongoind requests\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.cancelOngoingQueries();\r\n    this.unlistenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * On map click, issue queries\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: OlMapBrowserPointerEvent) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    this.map.ol.un(this.mapClickListener.type, this.mapClickListener.listener);\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Issue queries from a map event and emit events with the results\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: OlMapBrowserPointerEvent) {\r\n    this.cancelOngoingQueries();\r\n    if (!this.queryService.queryEnabled) {\r\n      return;\r\n    }\r\n\r\n    const queries$ = [];\r\n    if (this.queryFeatures) {\r\n      queries$.push(this.doQueryFeatures(event));\r\n    }\r\n\r\n    const resolution = this.map.ol.getView().getResolution();\r\n    const queryLayers = this.map.layers.filter(layerIsQueryable);\r\n    queries$.push(\r\n      ...this.queryService.query(queryLayers, {\r\n        coordinates: event.coordinate,\r\n        projection: this.map.projection,\r\n        resolution\r\n      })\r\n    );\r\n\r\n    if (queries$.length === 0) {\r\n      return;\r\n    }\r\n\r\n    if (this.waitForAllQueries) {\r\n      this.queries$$.push(\r\n        zip(...queries$).subscribe((results: Feature[][]) => {\r\n          const features = [].concat(...results);\r\n          this.query.emit({ features, event });\r\n        })\r\n      );\r\n    } else {\r\n      this.queries$$ = queries$.map((query$: Observable<Feature[]>) => {\r\n        return query$.subscribe((features: Feature[]) => {\r\n          this.query.emit({ features, event });\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query features already present on the map\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private doQueryFeatures(\r\n    event: OlMapBrowserPointerEvent\r\n  ): Observable<Feature[]> {\r\n    const clickedFeatures = [];\r\n\r\n    this.map.ol.forEachFeatureAtPixel(\r\n      event.pixel,\r\n      (featureOL: OlFeature, layerOL: OlLayer) => {\r\n        if (featureOL) {\r\n          if (featureOL.get('features')) {\r\n            for (const feature of featureOL.get('features')) {\r\n              const newFeature = featureFromOl(feature, this.map.projection);\r\n              newFeature.meta = {\r\n                title: feature.values_.nom,\r\n                id: feature.id_,\r\n                icon: feature.values_._icon,\r\n                sourceTitle: layerOL.values_.title\r\n              };\r\n              clickedFeatures.push(newFeature);\r\n            }\r\n          } else if (featureOL instanceof OlRenderFeature) {\r\n            const featureFromRender: OlFeature = featureOL;\r\n            const feature = renderFeatureFromOl(\r\n              featureOL,\r\n              this.map.projection,\r\n              layerOL\r\n            );\r\n            clickedFeatures.push(feature);\r\n          } else {\r\n            const feature = featureFromOl(\r\n              featureOL,\r\n              this.map.projection,\r\n              layerOL\r\n            );\r\n            clickedFeatures.push(feature);\r\n          }\r\n        }\r\n      },\r\n      {\r\n        hitTolerance: this.queryFeaturesHitTolerance || 0,\r\n        layerFilter: this.queryFeaturesCondition\r\n          ? this.queryFeaturesCondition\r\n          : olLayerIsQueryable\r\n      }\r\n    );\r\n\r\n    const queryableLayers = this.map.layers.filter(layerIsQueryable);\r\n    clickedFeatures.forEach((feature: Feature) => {\r\n      queryableLayers.forEach((layer: AnyLayer) => {\r\n        if (typeof layer.ol.getSource().hasFeature !== 'undefined') {\r\n          if (layer.ol.getSource().hasFeature(feature.ol)) {\r\n            feature.meta.alias = this.queryService.getAllowedFieldsAndAlias(layer);\r\n            feature.meta.title = feature.meta.title || this.queryService.getQueryTitle(feature, layer);\r\n            feature.meta.sourceTitle = layer.title;\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    return of(clickedFeatures);\r\n  }\r\n\r\n  /**\r\n   * Cancel ongoing requests, if any\r\n   */\r\n  private cancelOngoingQueries() {\r\n    this.queries$$.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.queries$$ = [];\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions,\r\n  SearchSourceSettings\r\n} from './source.interfaces';\r\n\r\n/**\r\n * Base search source class\r\n */\r\nexport class SearchSource {\r\n  /**\r\n   * Search source ID\r\n   * @internal\r\n   */\r\n  static id = '';\r\n\r\n  /**\r\n   * Search source type\r\n   * @internal\r\n   */\r\n  static type = '';\r\n\r\n  /**\r\n   * Search source options\r\n   * @internal\r\n   */\r\n  protected options: SearchSourceOptions;\r\n\r\n  /**\r\n   * Get search source's id\r\n   * @returns Search source's id\r\n   */\r\n  getId(): string {\r\n    throw new Error('You have to implement the method \"getId\".');\r\n  }\r\n  /**\r\n   * Get search source's type\r\n   * @returns Search source's type\r\n   */\r\n  getType(): string {\r\n    throw new Error('You have to implement the method \"getType\".');\r\n  }\r\n\r\n  /**\r\n   * Get search source's default options\r\n   * @returns Search source default options\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    throw new Error('You have to implement the method \"getDefaultOptions\".');\r\n  }\r\n\r\n  /**\r\n   * Search source's title\r\n   */\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is available\r\n   */\r\n  get available(): boolean {\r\n    return this.options.available !== false;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is enabled\r\n   */\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  get enabled(): boolean {\r\n    return this.available && this.options.enabled !== false;\r\n  }\r\n\r\n  get showInPointerSummary(): boolean {\r\n    const showInPointerSummary = this.options.showInPointerSummary;\r\n    return showInPointerSummary ? showInPointerSummary : false;\r\n  }\r\n\r\n  get showInSettings(): boolean {\r\n    const showInSettings = this.options.showInSettings;\r\n    return showInSettings === undefined ? true : showInSettings;\r\n  }\r\n\r\n  /**\r\n   * Search url\r\n   */\r\n  get searchUrl(): string {\r\n    return this.options.searchUrl;\r\n  }\r\n\r\n  /**\r\n   * Search query params\r\n   */\r\n  get params(): { [key: string]: string } {\r\n    return this.options.params === undefined ? {} : this.options.params;\r\n  }\r\n\r\n  /**\r\n   * Search settings\r\n   */\r\n  get settings(): SearchSourceSettings[] {\r\n    return this.options.settings === undefined ? [] : this.options.settings;\r\n  }\r\n\r\n  /**\r\n   * Set params from selected settings\r\n   */\r\n  setParamFromSetting(setting: SearchSourceSettings) {\r\n    switch (setting.type) {\r\n      case 'radiobutton':\r\n        setting.values.forEach(conf => {\r\n          if (conf.enabled) {\r\n            this.options.params = Object.assign(this.options.params || {}, {\r\n              [setting.name]: conf.value\r\n            });\r\n          }\r\n        });\r\n        break;\r\n      case 'checkbox':\r\n        let confValue = '';\r\n        setting.values\r\n          .filter(s => s.available !== false)\r\n          .forEach(conf => {\r\n            if (conf.enabled) {\r\n              confValue += conf.value + ',';\r\n            }\r\n          });\r\n        confValue = confValue.slice(0, -1);\r\n        this.options.params = Object.assign(this.options.params || {}, {\r\n          [setting.name]: confValue\r\n        });\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Search results display order\r\n   */\r\n  get displayOrder(): number {\r\n    return this.options.order === undefined ? 99 : this.options.order;\r\n  }\r\n\r\n  constructor(options: SearchSourceOptions) {\r\n    this.options = options;\r\n    this.options = Object.assign({}, this.getDefaultOptions(), options);\r\n\r\n    // Set Default Params from Settings\r\n    this.settings.forEach(setting => {\r\n      this.setParamFromSetting(setting);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get hashtags valid\r\n   * @param hashtag hashtag from query\r\n   */\r\n  getHashtagsValid(term: string, settingsName: string): string[] {\r\n    const hashtags = term.match(/(#[^\\s]+)/g);\r\n    if (!hashtags) {\r\n      return undefined;\r\n    }\r\n\r\n    const searchSourceSetting = this.getSettingsValues(settingsName);\r\n    const hashtagsValid = [];\r\n    hashtags.forEach(hashtag => {\r\n      searchSourceSetting.values.forEach(conf => {\r\n        const hashtagKey = hashtag.substring(1);\r\n        if (typeof conf.value === 'string') {\r\n          const types = conf.value\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n            .split(',');\r\n          const index = types.indexOf(\r\n            hashtagKey\r\n              .toLowerCase()\r\n              .normalize('NFD')\r\n              .replace(/[\\u0300-\\u036f]/g, '')\r\n          );\r\n          if (index !== -1) {\r\n            hashtagsValid.push(types[index]);\r\n          }\r\n        }\r\n        if (conf.hashtags && conf.hashtags.indexOf(hashtagKey) !== -1) {\r\n          hashtagsValid.push(conf.value);\r\n        }\r\n      });\r\n    });\r\n\r\n    return hashtagsValid.filter((a, b) => hashtagsValid.indexOf(a) === b);\r\n  }\r\n\r\n  getSettingsValues(search: string): SearchSourceSettings {\r\n    return this.getDefaultOptions().settings.find(\r\n      (value: SearchSourceSettings) => {\r\n        return value.name === search;\r\n      }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by text implement this class\r\n */\r\nexport interface TextSearch {\r\n  /**\r\n   * Search by text\r\n   * @param term Text\r\n   * @param options Optional: TextSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult[]>;\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by coordinates implement this class\r\n */\r\nexport interface ReverseSearch {\r\n  /**\r\n   * Search by text\r\n   * @param lonLat Coordinates\r\n   * @param options Optional: ReverseSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult[]>;\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\n\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { SearchSourceOptions } from '../../search/shared/sources/source.interfaces';\r\n/**\r\n * Map search source. For now it has no search capability. All it does\r\n * is act as a placeholder for the map query results' \"search source\".\r\n */\r\n@Injectable()\r\nexport class QuerySearchSource extends SearchSource {\r\n  static id = 'map';\r\n  static type = FEATURE;\r\n\r\n  constructor(@Inject('options') options: SearchSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  getId(): string {\r\n    return QuerySearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return QuerySearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Carte'\r\n    };\r\n  }\r\n}\r\n","export class GoogleLinks {\r\n  static getGoogleMapsCoordLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleStreetViewLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=&layer=c&cbll=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleMapsNameLink(name) {\r\n    const encodedName = encodeURI(name);\r\n    return 'https://www.google.com/maps?q=' + encodedName;\r\n  }\r\n}\r\n","export class OsmLinks {\r\n  static getOpenStreetMapLink(lon, lat, zoom: number = 17) {\r\n    // return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n    return  `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=${zoom}/${lat}/${lon}`;\r\n  }\r\n\r\n  static getOpenStreetCamLink(lon, lat, zoom: number = 17) {\r\n    return  `https://openstreetcam.org/map/@${lat},${lon},${zoom}z`;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\nimport { EMPTY, Observable, of, zip } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, ConfigService } from '@igo2/core';\r\nimport {\r\n  CapabilitiesService,\r\n  TypeCapabilities,\r\n  WMSDataSourceOptions,\r\n  WMSDataSourceOptionsParams,\r\n  WMTSDataSourceOptions\r\n} from '../../datasource';\r\nimport { LayerOptions, ImageLayerOptions } from '../../layer';\r\nimport { getResolutionFromScale } from '../../map';\r\n\r\nimport {\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup\r\n} from './catalog.interface';\r\nimport { Catalog, CatalogFactory, CompositeCatalog } from './catalog.abstract';\r\nimport { CatalogItemType, TypeCatalog } from './catalog.enum';\r\nimport { QueryFormat } from '../../query';\r\nimport { generateIdFromSourceOptions } from '../../utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CatalogService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private capabilitiesService: CapabilitiesService\r\n  ) {}\r\n\r\n  loadCatalogs(): Observable<Catalog[]> {\r\n    const contextConfig = this.config.getConfig('context') || {};\r\n    const catalogConfig = this.config.getConfig('catalog') || {};\r\n    const apiUrl = catalogConfig.url || contextConfig.url;\r\n    const catalogsFromConfig = catalogConfig.sources || [];\r\n\r\n    const observables$ = [];\r\n\r\n    if (apiUrl) {\r\n      // Base layers catalog\r\n      if (catalogConfig.baseLayers) {\r\n        const translate = this.languageService.translate;\r\n        const title = translate.instant('igo.geo.catalog.baseLayers');\r\n        const baseLayersCatalog = [\r\n          {\r\n            id: 'catalog.baselayers',\r\n            title,\r\n            url: `${apiUrl}/baselayers`,\r\n            type: 'baselayers'\r\n          }\r\n        ];\r\n        observables$.push(of(baseLayersCatalog));\r\n      }\r\n\r\n      // Catalogs from API\r\n      const catalogsFromApi$ = this.http\r\n        .get<Catalog[]>(`${apiUrl}/catalogs`)\r\n        .pipe(\r\n          map(catalogs =>\r\n            catalogs.map((c: any) => Object.assign(c, c.options))\r\n          ),\r\n          catchError((_response: HttpErrorResponse) => EMPTY)\r\n        );\r\n      observables$.push(catalogsFromApi$);\r\n    }\r\n\r\n    // Catalogs from config\r\n    if (catalogsFromConfig.length > 0) {\r\n      observables$.push(\r\n        of(catalogsFromConfig).pipe(\r\n          map((catalogs: Catalog[]) =>\r\n            catalogs.map(c => {\r\n              if (!c.id) {\r\n                c.id = uuid();\r\n              }\r\n              return c;\r\n            })\r\n          )\r\n        )\r\n      );\r\n    }\r\n\r\n    return zip(...observables$).pipe(\r\n      map((catalogs: Catalog[][]) => [].concat.apply([], catalogs))\r\n    ) as Observable<Catalog[]>;\r\n  }\r\n\r\n  loadCatalogItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    let newCatalog: Catalog;\r\n    newCatalog = CatalogFactory.createInstanceCatalog(catalog, this);\r\n    return newCatalog.collectCatalogItems();\r\n  }\r\n\r\n  loadCatalogBaseLayerItems(catalog: Catalog): Observable<CatalogItemGroup[]> {\r\n    return this.getCatalogBaseLayersOptions(catalog).pipe(\r\n      map((layersOptions: LayerOptions[]) => {\r\n        const items = layersOptions.map((layerOptions: LayerOptions) => {\r\n          return {\r\n            id: generateIdFromSourceOptions(layerOptions.sourceOptions),\r\n            title: layerOptions.title,\r\n            type: CatalogItemType.Layer,\r\n            options: layerOptions\r\n          } as CatalogItemLayer;\r\n        });\r\n        return [\r\n          {\r\n            id: 'catalog.group.baselayers',\r\n            type: CatalogItemType.Group,\r\n            title: catalog.title,\r\n            items\r\n          }\r\n        ];\r\n      })\r\n    );\r\n  }\r\n\r\n  private getCatalogBaseLayersOptions(\r\n    catalog: Catalog\r\n  ): Observable<LayerOptions[]> {\r\n    return this.http.get<LayerOptions[]>(catalog.url);\r\n  }\r\n\r\n  loadCatalogWMSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => {\r\n        const items = [];\r\n        this.includeRecursiveItems(\r\n          catalog,\r\n          capabilities.Capability.Layer,\r\n          items\r\n        );\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  loadCatalogWMTSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => this.getWMTSItems(catalog, capabilities))\r\n    );\r\n  }\r\n\r\n  loadCatalogCompositeLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    const compositeCatalog = (catalog as CompositeCatalog).composite;\r\n\r\n    const catalogsFromInstance = [] as Catalog[];\r\n    compositeCatalog.map((component: Catalog) =>\r\n      catalogsFromInstance.push(\r\n        CatalogFactory.createInstanceCatalog(component, this)\r\n      )\r\n    );\r\n\r\n    // get CatalogItems for each original Catalog-----------------------------------------------------\r\n    const request1$ = [];\r\n    catalogsFromInstance.map((component: Catalog) =>\r\n      request1$.push(component.collectCatalogItems())\r\n    );\r\n\r\n    // integrate imposed group -----------------------------------------------------\r\n    let request2$ = [];\r\n\r\n    function flatDeepLayer(arr) {\r\n      return arr.reduce(\r\n        (acc, val) =>\r\n          acc.concat(\r\n            val.type === CatalogItemType.Group ? flatDeepLayer(val.items) : val\r\n          ),\r\n        []\r\n      );\r\n    }\r\n\r\n    if (\r\n      Object.keys(compositeCatalog).find(k => compositeCatalog[k].groupImpose)\r\n    ) {\r\n      const pushImposeGroup = (item, index) => {\r\n        const c = catalogsFromInstance[index];\r\n        const outGroupImpose = Object.assign({}, c.groupImpose);\r\n        outGroupImpose.address = c.id;\r\n        outGroupImpose.type = CatalogItemType.Group;\r\n        outGroupImpose.items = [];\r\n\r\n        const flatLayer = flatDeepLayer(item);\r\n        flatLayer.map(\r\n          v => (v.address = `${outGroupImpose.address}.${outGroupImpose.id}`)\r\n        );\r\n        outGroupImpose.items = flatLayer;\r\n\r\n        return outGroupImpose;\r\n      };\r\n\r\n      request2$ = request1$.map((obs, idx) =>\r\n        obs.pipe(\r\n          map(items =>\r\n            compositeCatalog[idx].groupImpose\r\n              ? pushImposeGroup(items, idx)\r\n              : items\r\n          )\r\n        )\r\n      );\r\n    } else {\r\n      request2$ = request1$;\r\n    }\r\n\r\n    // concat Group -----------------------------------------------------\r\n    const request3$ = zip(...request2$).pipe(\r\n      map(\r\n        (output: CatalogItem[]) => [].concat(...output) // [].concat.apply([], result1\r\n      )\r\n    );\r\n\r\n    // merge Group (first level only) -----------------------------------------------------\r\n    const groupByGroupId = (data, keyFn) =>\r\n      data.reduce((acc, group) => {\r\n        const groupId = keyFn(group);\r\n        const ind = acc.find(x => x.id === groupId);\r\n\r\n        if (!ind) {\r\n          acc[acc.length] = group;\r\n        } else {\r\n          const ix = acc.indexOf(ind);\r\n          if (acc[ix].address.split('|').indexOf(group.address) === -1) {\r\n            acc[ix].address = `${acc[ix].address}|${group.address}`;\r\n          }\r\n          acc[ix].items.push(...group.items);\r\n        }\r\n        return acc;\r\n      }, []);\r\n\r\n    // merge Layer for each Level (catalog, group(recursive))\r\n    const recursiveGroupByLayerAddress = (items, keyFn) =>\r\n      items.reduce((acc, item, idx, arr) => {\r\n        const layerTitle = keyFn(item);\r\n        const outItem = Object.assign({}, item);\r\n\r\n        if (item.type === CatalogItemType.Layer) {\r\n          // same title, same address => result: only one item is keep\r\n\r\n          // same title, address diff\r\n          const indicesMatchTitle = [];\r\n          const diffAddress = arr.filter((x, i) => {\r\n            let bInd = false;\r\n            if (x.title === layerTitle && x.type === CatalogItemType.Layer) {\r\n              if (i !== idx && x.address !== item.address) {\r\n                bInd = true;\r\n              }\r\n              indicesMatchTitle.push(i);\r\n            }\r\n            return bInd;\r\n          }); // $& i !== idx\r\n\r\n          if (diffAddress.length > 0) {\r\n            const nPosition = indicesMatchTitle.findIndex(x => x === idx) + 1;\r\n            outItem.title = `${item.title} (${nPosition})`; // source: ${item.address.split('.')[0]}\r\n          }\r\n\r\n          const exist = acc.find(\r\n            x => x.title === outItem.title && x.type === CatalogItemType.Layer\r\n          );\r\n          if (!exist) {\r\n            acc[acc.length] = outItem;\r\n          }\r\n        } else if (item.type === CatalogItemType.Group) {\r\n          outItem.items = recursiveGroupByLayerAddress(\r\n            item.items,\r\n            layer => layer.title\r\n          );\r\n          acc[acc.length] = outItem;\r\n        }\r\n\r\n        return acc;\r\n      }, []);\r\n\r\n    const request4$ = request3$.pipe(\r\n      map(output => groupByGroupId(output, group => group.id)),\r\n      map(output => [].concat(...output)),\r\n      map(data => recursiveGroupByLayerAddress(data, layer => layer.title))\r\n    );\r\n\r\n    return request4$;\r\n  }\r\n\r\n  private getCatalogCapabilities(catalog: Catalog): Observable<any> {\r\n    const sType: string = TypeCatalog[catalog.type as string];\r\n    return this.capabilitiesService.getCapabilities(\r\n      TypeCapabilities[sType],\r\n      catalog.url,\r\n      catalog.version\r\n    );\r\n  }\r\n\r\n  private prepareCatalogItemLayer(layer, idParent, layersQueryFormat, catalog) {\r\n    const configuredQueryFormat = this.retriveLayerInfoFormat(\r\n      layer.Name,\r\n      layersQueryFormat\r\n    );\r\n\r\n    const metadata = layer.DataURL ? layer.DataURL[0] : undefined;\r\n    const legendOptions =\r\n      catalog.showLegend && layer.Style\r\n        ? this.capabilitiesService.getStyle(layer.Style)\r\n        : undefined;\r\n\r\n    const params = Object.assign({}, catalog.queryParams, {\r\n      LAYERS: layer.Name,\r\n      VERSION: catalog.version\r\n    } as WMSDataSourceOptionsParams);\r\n\r\n    const baseSourceOptions = {\r\n      type: 'wms',\r\n      url: catalog.url,\r\n      crossOrigin: catalog.setCrossOriginAnonymous ? 'anonymous' : undefined,\r\n      queryFormat: configuredQueryFormat,\r\n      queryHtmlTarget:\r\n        configuredQueryFormat === QueryFormat.HTML ||\r\n        configuredQueryFormat === QueryFormat.HTMLGML2\r\n          ? 'iframe'\r\n          : undefined,\r\n      optionsFromCapabilities: true\r\n    };\r\n\r\n    const sourceOptions = Object.assign(\r\n      {},\r\n      baseSourceOptions,\r\n      catalog.sourceOptions,\r\n      { params }\r\n    ) as WMSDataSourceOptions;\r\n\r\n    const layerPrepare = {\r\n      id: generateIdFromSourceOptions(sourceOptions),\r\n      type: CatalogItemType.Layer,\r\n      title: layer.Title,\r\n      address: idParent,\r\n      options: {\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        metadata: {\r\n          url: metadata ? metadata.OnlineResource : undefined,\r\n          extern: metadata ? true : undefined\r\n        },\r\n        legendOptions,\r\n        tooltip: { type: catalog.tooltipType },\r\n        sourceOptions\r\n      }\r\n    };\r\n\r\n    return ObjectUtils.removeUndefined(layerPrepare);\r\n  }\r\n\r\n  private prepareCatalogItemGroup(\r\n    itemListIn,\r\n    regexes,\r\n    idGroup,\r\n    layersQueryFormat,\r\n    catalog\r\n  ) {\r\n    const groupPrepare = {\r\n      id: idGroup,\r\n      type: CatalogItemType.Group,\r\n      title: itemListIn.Title,\r\n      address: catalog.id,\r\n      items: itemListIn.Layer.reduce((items: CatalogItem[], layer: any) => {\r\n        if (layer.Layer !== undefined) {\r\n          // recursive, check next level\r\n          const idGroupItemNextLevel =\r\n            idGroup + `.group.${layer.Name || layer.Layer[0].Name}`;\r\n          const groupItem: CatalogItemGroup = this.prepareCatalogItemGroup(\r\n            layer,\r\n            regexes,\r\n            idGroupItemNextLevel,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(groupItem);\r\n        } else {\r\n          if (this.testLayerRegexes(layer.Name, regexes) === false) {\r\n            return items;\r\n          }\r\n\r\n          const layerItem: CatalogItemLayer<\r\n            ImageLayerOptions\r\n          > = this.prepareCatalogItemLayer(\r\n            layer,\r\n            idGroup,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(layerItem);\r\n        }\r\n        return items;\r\n      }, [])\r\n    };\r\n    return groupPrepare;\r\n  }\r\n\r\n  private includeRecursiveItems(\r\n    catalog: Catalog,\r\n    itemListIn: any,\r\n    itemsPrepare: CatalogItem[],\r\n    loopLevel: number = 0\r\n  ) {\r\n    // Dig all levels until last level (layer object are not defined on last level)\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n    if (!itemListIn.Layer) {\r\n      return;\r\n    }\r\n\r\n    for (const item of itemListIn.Layer) {\r\n      if (item.Layer !== undefined) {\r\n        // recursive, check next level\r\n        this.includeRecursiveItems(catalog, item, itemsPrepare, loopLevel + 1);\r\n        continue;\r\n      }\r\n\r\n      const layersQueryFormat = this.findCatalogInfoFormat(catalog);\r\n\r\n      // group(with layers) and layer(without group) level 1\r\n      if (loopLevel !== 0) {\r\n        // TODO: Slice that into multiple methods\r\n        // Define object of group layer\r\n        const idGroupItem = `catalog.group.${itemListIn.Name || item.Name}`;\r\n        const groupItem = this.prepareCatalogItemGroup(\r\n          itemListIn,\r\n          regexes,\r\n          idGroupItem,\r\n          layersQueryFormat,\r\n          catalog\r\n        );\r\n\r\n        if (groupItem.items.length !== 0) {\r\n          itemsPrepare.push(groupItem);\r\n        }\r\n\r\n        // Break the group (don't add a group of layer for each of their layer!)\r\n        break;\r\n      } else {\r\n        // layer without group\r\n        if (this.testLayerRegexes(item.Name, regexes) !== false) {\r\n          const layerItem = this.prepareCatalogItemLayer(\r\n            item,\r\n            catalog.id,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n          itemsPrepare.push(layerItem);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private getWMTSItems(\r\n    catalog: Catalog,\r\n    capabilities: { [key: string]: any }\r\n  ): CatalogItemLayer[] {\r\n    const layers = capabilities.Contents.Layer;\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n\r\n    return layers\r\n      .map((layer: any) => {\r\n        if (this.testLayerRegexes(layer.Identifier, regexes) === false) {\r\n          return undefined;\r\n        }\r\n        const params = Object.assign({}, catalog.queryParams, {\r\n          version: '1.0.0'\r\n        });\r\n        const baseSourceOptions = {\r\n          type: 'wmts',\r\n          url: catalog.url,\r\n          crossOrigin: catalog.setCrossOriginAnonymous\r\n            ? 'anonymous'\r\n            : undefined,\r\n          layer: layer.Identifier,\r\n          matrixSet: catalog.matrixSet,\r\n          optionsFromCapabilities: true,\r\n          requestEncoding: catalog.requestEncoding || 'KVP',\r\n          style: 'default'\r\n        } as WMTSDataSourceOptions;\r\n        const sourceOptions = Object.assign(\r\n          {},\r\n          baseSourceOptions,\r\n          catalog.sourceOptions,\r\n          { params }\r\n        ) as WMTSDataSourceOptions;\r\n\r\n        return ObjectUtils.removeUndefined({\r\n          id: generateIdFromSourceOptions(sourceOptions),\r\n          type: CatalogItemType.Layer,\r\n          title: layer.Title,\r\n          address: catalog.id,\r\n          options: {\r\n            sourceOptions\r\n          }\r\n        });\r\n      })\r\n      .filter((item: CatalogItemLayer | undefined) => item !== undefined);\r\n  }\r\n\r\n  private testLayerRegexes(layerName: string, regexes: RegExp[]): boolean {\r\n    if (regexes.length === 0) {\r\n      return true;\r\n    }\r\n    return regexes.find((regex: RegExp) => regex.test(layerName)) !== undefined;\r\n  }\r\n\r\n  private retriveLayerInfoFormat(\r\n    layerNameFromCatalog: string,\r\n    layersQueryFormat: { layer: string; queryFormat: QueryFormat }[]\r\n  ): QueryFormat {\r\n    const currentLayerInfoFormat = layersQueryFormat.find(\r\n      f => f.layer === layerNameFromCatalog\r\n    );\r\n    const baseInfoFormat = layersQueryFormat.find(f => f.layer === '*');\r\n    let queryFormat: QueryFormat;\r\n    if (currentLayerInfoFormat) {\r\n      queryFormat = currentLayerInfoFormat.queryFormat;\r\n    } else if (baseInfoFormat) {\r\n      queryFormat = baseInfoFormat.queryFormat;\r\n    }\r\n    return queryFormat;\r\n  }\r\n\r\n  private findCatalogInfoFormat(\r\n    catalog: Catalog\r\n  ): { layer: string; queryFormat: QueryFormat }[] {\r\n    const layersQueryFormat: { layer: string; queryFormat: QueryFormat }[] = [];\r\n    if (!catalog.queryFormat) {\r\n      return layersQueryFormat;\r\n    }\r\n    Object.keys(catalog.queryFormat).forEach(configuredInfoFormat => {\r\n      if (catalog.queryFormat[configuredInfoFormat] instanceof Array) {\r\n        catalog.queryFormat[configuredInfoFormat].forEach(layerName => {\r\n          if (\r\n            !layersQueryFormat.find(specific => specific.layer === layerName)\r\n          ) {\r\n            layersQueryFormat.push({\r\n              layer: layerName,\r\n              queryFormat: configuredInfoFormat as QueryFormat\r\n            });\r\n          }\r\n        });\r\n      } else {\r\n        if (\r\n          !layersQueryFormat.find(\r\n            specific =>\r\n              specific.layer === catalog.queryFormat[configuredInfoFormat]\r\n          )\r\n        ) {\r\n          layersQueryFormat.push({\r\n            layer: catalog.queryFormat[configuredInfoFormat],\r\n            queryFormat: configuredInfoFormat as QueryFormat\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return layersQueryFormat;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { zip, BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore, EntityStoreWatcher } from '@igo2/common';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport {\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup,\r\n  CatalogItemState,\r\n  CatalogItemType\r\n} from '../shared';\r\n\r\n/**\r\n * Component to browse a catalog's groups and layers and display them on a map.\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser',\r\n  templateUrl: './catalog-browser.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Catalog items store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<CatalogItem>;\r\n\r\n // private resolution$$: Subscription;\r\n\r\n  get resolution$(): BehaviorSubject<number> { return this.map.viewController.resolution$; }\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Store holding the catalog's items\r\n   */\r\n  @Input() store: EntityStore<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Whether a group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsedGroup: boolean = true;\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    const currentItems = this.map.layers.map((layer: Layer) => {\r\n      return {\r\n        id: layer.options.source.id,\r\n        title: layer.title,\r\n        type: CatalogItemType.Layer\r\n      };\r\n    });\r\n    this.store.state.updateMany(currentItems, { added: true }, true);\r\n    if (this.catalog && this.catalog.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.catalog.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n      });\r\n    }\r\n\r\n    const catalogShowLegend = this.catalog ? this.catalog.showLegend : false;\r\n    this.catalogAllowLegend = catalogShowLegend ? catalogShowLegend : this.catalogAllowLegend;\r\n\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Layer added event\r\n   */\r\n  onLayerAddedChange(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    const layer = event.layer;\r\n    this.store.state.update(layer, { added: event.added }, false);\r\n    event.added ? this.addLayerToMap(layer) : this.removeLayerFromMap(layer);\r\n  }\r\n\r\n  /**\r\n   * When a froup is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Group added event\r\n   */\r\n  onGroupAddedChange(event: { added: boolean; group: CatalogItemGroup }) {\r\n    const group = event.group;\r\n    this.store.state.update(group, { added: event.added }, false);\r\n    event.added ? this.addGroupToMap(group) : this.removeGroupFromMap(group);\r\n  }\r\n\r\n  /**\r\n   * Add layer to map\r\n   * @param layer Catalog layer\r\n   */\r\n  private addLayerToMap(layer: CatalogItemLayer) {\r\n    this.addLayersToMap([layer]);\r\n  }\r\n\r\n  /**\r\n   * Remove layer from map\r\n   * @param layer Catalog layer\r\n   */\r\n  private removeLayerFromMap(layer: CatalogItemLayer) {\r\n    this.removeLayersFromMap([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add multiple layers to map\r\n   * @param layers Catalog layers\r\n   */\r\n  private addLayersToMap(layers: CatalogItemLayer[]) {\r\n    const layers$ = layers.map((layer: CatalogItemLayer) => {\r\n      if (layer.options.sourceOptions.optionsFromApi === undefined) {\r\n        layer.options.sourceOptions.optionsFromApi = true;\r\n      }\r\n      return this.layerService.createAsyncLayer(layer.options);\r\n    });\r\n\r\n    zip(...layers$).subscribe((oLayers: Layer[]) => {\r\n      this.store.state.updateMany(layers, { added: true });\r\n      this.map.addLayers(oLayers);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove multiple layers from map\r\n   * @param layers Catalog layers\r\n   */\r\n  private removeLayersFromMap(layers: CatalogItemLayer[]) {\r\n    layers.forEach((layer: CatalogItemLayer) => {\r\n      this.store.state.update(layer, { added: false });\r\n      if (layer.options.baseLayer === true) {\r\n        const oLayer = this.map.getLayerById(layer.options.id);\r\n        if (oLayer !== undefined) {\r\n          this.map.removeLayer(oLayer);\r\n        }\r\n      } else {\r\n        const oLayer = this.map.getLayerById(layer.id);\r\n        if (oLayer !== undefined) {\r\n          this.map.removeLayer(oLayer);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sort the layers by title. asc or desc.\r\n   * @internal\r\n   */\r\n  private sortCatalogItemsByTitle(items: CatalogItem[], direction) {\r\n    const returnItem = items.sort((a, b) => {\r\n      const titleA = a.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      const titleB = b.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n\r\n      if (titleA < titleB) {\r\n        return -1;\r\n      }\r\n      if (titleA > titleB) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n    switch (direction) {\r\n      case 'asc':\r\n        return returnItem;\r\n      case 'desc':\r\n        return returnItem.reverse();\r\n      default:\r\n        return items;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add all the layers of a group to map\r\n   * @param group Catalog group\r\n   */\r\n  private addGroupToMap(group: CatalogItemGroup) {\r\n    let layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === false;\r\n    });\r\n    if (this.catalog && this.catalog.sortDirection !== undefined) {\r\n      layers = this.sortCatalogItemsByTitle(layers, this.catalog.sortDirection);\r\n  }\r\n    this.addLayersToMap(layers.reverse() as CatalogItemLayer[]);\r\n  }\r\n\r\n  /**\r\n   * Remove all the layers of a group from map\r\n   * @param group Catalog group\r\n   */\r\n  private removeGroupFromMap(group: CatalogItemGroup) {\r\n    const layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === true;\r\n    });\r\n    this.removeLayersFromMap(layers as CatalogItemLayer[]);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\n\r\nimport { CatalogItemLayer } from '../shared';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { first } from 'rxjs/operators';\r\nimport { Layer } from '../../layer/shared/layers';\r\n\r\n/**\r\n * Catalog browser layer item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-layer',\r\n  templateUrl: './catalog-browser-layer.component.html',\r\n  styleUrls: ['./catalog-browser-layer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserLayerComponent implements OnInit {\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  public layerLegendShown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public igoLayer$ = new BehaviorSubject<Layer>(undefined);\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog layer\r\n   */\r\n  @Input() layer: CatalogItemLayer;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added = false;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<{\r\n    added: boolean;\r\n    layer: CatalogItemLayer;\r\n  }>();\r\n\r\n  @Output() addedLayerIsPreview = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.layer);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.layer) || 'layers';\r\n  }\r\n\r\n  constructor(private layerService: LayerService ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.isInResolutionsRange();\r\n    this.isPreview$.subscribe(value => this.addedLayerIsPreview.emit(value));\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  askForLegend(event) {\r\n    this.layerLegendShown$.next(!this.layerLegendShown$.value);\r\n    this.layerService.createAsyncLayer(this.layer.options).pipe(first())\r\n    .subscribe(layer => this.igoLayer$.next(layer));\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove();\r\n          } else {\r\n            this.add();\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add();\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove();\r\n          this.isPreview$.next(false);\r\n        }\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add() {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addedChange.emit({ added: true, layer: this.layer });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private remove() {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.addedChange.emit({ added: false, layer: this.layer });\r\n    }\r\n  }\r\n\r\n  haveGroup(): boolean {\r\n    return !(!this.layer.address || this.layer.address.split('.').length === 1);\r\n  }\r\n\r\n  isInResolutionsRange(): boolean {\r\n    const minResolution = this.layer.options.minResolution || 0;\r\n    const maxResolution = this.layer.options.maxResolution || Infinity;\r\n    this.inRange$.next(\r\n      this.resolution >= minResolution && this.resolution <= maxResolution\r\n    );\r\n    return this.inRange$.value;\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      return this.isPreview$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStateManager, EntityStore } from '@igo2/common';\r\n\r\nimport {\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemGroup,\r\n  CatalogItemLayer,\r\n  CatalogItemState,\r\n  CatalogItemType\r\n} from '../shared';\r\n\r\n/**\r\n * Catalog browser group item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-group',\r\n  templateUrl: './catalog-browser-group.component.html',\r\n  styleUrls: ['./catalog-browser-group.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserGroupComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Group's items store\r\n   * @internal\r\n   */\r\n  store = new EntityStore<CatalogItem, CatalogItemState>([]);\r\n\r\n  /**\r\n   * Whether all the layers of the group are added\r\n   * @internal\r\n   */\r\n  added$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  preview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Whether the toggle button is disabled\r\n   * @internal\r\n   */\r\n  disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Catalog group\r\n   */\r\n  @Input() group: CatalogItemGroup;\r\n\r\n  /**\r\n   * Whether the group is collapsed\r\n   */\r\n  @Input() collapsed: boolean = true;\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Whether the group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsed: boolean = true;\r\n\r\n  /**\r\n   * Parent catalog's items store state. Groups share a unique\r\n   * EntityState that tracks the group and it's layers state (whether they are added or not).\r\n   * Sharing a unique state would also allow us to expand this component to allow\r\n   * the selection of a layer while unselecting any layer already selected in another group.\r\n   * This could be useful to display some layer info before adding it, for example.\r\n   */\r\n  @Input() state: EntityStateManager<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of the group is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<{\r\n    added: boolean;\r\n    group: CatalogItemGroup;\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of a layer is clicked\r\n   */\r\n  @Output() layerAddedChange = new EventEmitter<{\r\n    added: boolean;\r\n    layer: CatalogItemLayer;\r\n  }>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return this.group.title;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.load(this.group.items);\r\n    this.evaluateAdded();\r\n    this.evaluateDisabled(this.collapsed);\r\n    if (this.catalog && this.catalog.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.catalog.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n      });\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick() {\r\n    this.added$.value ? this.remove() : this.add();\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleCollapsed(collapsed: boolean) {\r\n    this.evaluateDisabled(collapsed);\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, evaluate if all the layers of the group\r\n   * are now added or removed. If so, consider that the group itself is added\r\n   * or removed.\r\n   * @internal\r\n   * @param event Layer added change event\r\n   */\r\n  onLayerAddedChange(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    this.layerAddedChange.emit(event);\r\n    this.tryToggleGroup(event);\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add() {\r\n    this.added$.next(true);\r\n    this.addedChange.emit({\r\n      added: true,\r\n      group: this.group\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private remove() {\r\n    this.added$.next(false);\r\n    this.addedChange.emit({\r\n      added: false,\r\n      group: this.group\r\n    });\r\n  }\r\n\r\n  onLayerPreview(event) {\r\n    this.preview$.next(event);\r\n  }\r\n\r\n  /**\r\n   * If all the layers of the group added or removed, add or remove the group itself.\r\n   * @param event The last layer added change event to occur\r\n   */\r\n  private tryToggleGroup(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    const added = event.added;\r\n    const layer = event.layer;\r\n\r\n    const layersAdded = this.store.view\r\n      .all()\r\n      .filter((item: CatalogItem) => item.id !== layer.id)\r\n      .map((item: CatalogItem) => this.state.get(item).added || false);\r\n\r\n    if (layersAdded.every(value => value === added)) {\r\n      added ? this.add() : this.remove();\r\n    } else if (this.added$.value === true) {\r\n      this.added$.next(false);\r\n    }\r\n  }\r\n\r\n  private evaluateAdded() {\r\n    const added = this.store.all().every((item: CatalogItem) => {\r\n      return (this.state.get(item).added || false) === true;\r\n    });\r\n    this.added$.next(added);\r\n  }\r\n\r\n  private evaluateDisabled(collapsed: boolean) {\r\n    let disabled = false;\r\n    if (this.toggleCollapsed === false) {\r\n      disabled = collapsed;\r\n    }\r\n    this.disabled$.next(disabled);\r\n  }\r\n\r\n  onTitleClick() {\r\n    this.collapsed = !this.collapsed;\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy, Optional } from '@angular/core';\r\nimport { Subscription, combineLatest } from 'rxjs';\r\n\r\nimport { RouteService } from '@igo2/core';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { debounceTime } from 'rxjs/operators';\r\nimport { LayerLegendListComponent } from './layer-legend-list.component';\r\n\r\n@Directive({\r\n  selector: '[igoLayerLegendListBinding]'\r\n})\r\nexport class LayerLegendListBindingDirective implements OnInit, OnDestroy {\r\n  private component: LayerLegendListComponent;\r\n  private layersOrResolutionChange$$: Subscription;\r\n  layersVisibility$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() component: LayerLegendListComponent,\r\n    private mapService: MapService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input layers\r\n    this.component.layers = [];\r\n    this.layersOrResolutionChange$$ = combineLatest([\r\n      this.mapService.getMap().layers$,\r\n      this.mapService.getMap().viewController.resolution$]\r\n    ).pipe(\r\n      debounceTime(10)\r\n    ).subscribe((bunch: [Layer[], number]) => {\r\n      const shownLayers = bunch[0].filter((layer: Layer) => {\r\n        return layer.showInLayerList === true;\r\n      });\r\n      this.component.layers = shownLayers;\r\n\r\n      this.layersVisibility$$ = combineLatest(shownLayers\r\n        .map((layer: Layer) => layer.visible$))\r\n        .subscribe((r) => {\r\n          this.component.change$.next();\r\n        }\r\n        );\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layersOrResolutionChange$$.unsubscribe();\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n  }\r\n\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport {\r\n  MatInputModule,\r\n  MatFormFieldModule,\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatTooltipModule,\r\n  MatListModule,\r\n  MatSliderModule,\r\n  MatBadgeModule,\r\n  MatSelectModule,\r\n  MatSlideToggleModule,\r\n  MatDividerModule,\r\n  MatMenuModule,\r\n  MatCheckboxModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoListModule,\r\n  IgoCollapsibleModule,\r\n  IgoImageModule,\r\n  IgoPanelModule\r\n} from '@igo2/common';\r\n\r\nimport { LayerService } from './shared/layer.service';\r\nimport { StyleService } from './shared/style.service';\r\nimport { LayerListToolService } from './layer-list-tool/layer-list-tool.service';\r\nimport { LayerItemComponent } from './layer-item/layer-item.component';\r\nimport { LayerLegendComponent } from './layer-legend/layer-legend.component';\r\nimport { LayerListComponent } from './layer-list/layer-list.component';\r\nimport { LayerListToolComponent } from './layer-list-tool/layer-list-tool.component';\r\nimport { LayerListBindingDirective } from './layer-list/layer-list-binding.directive';\r\nimport { LayerLegendListBindingDirective } from './layer-legend-list/layer-legend-list-binding.directive';\r\nimport { TrackFeatureButtonComponent } from './track-feature-button/track-feature-button.component';\r\nimport { LayerLegendListComponent } from './layer-legend-list/layer-legend-list.component';\r\nimport { LayerLegendItemComponent } from './layer-legend-item/layer-legend-item.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatInputModule,\r\n    MatFormFieldModule,\r\n    CommonModule,\r\n    FormsModule,\r\n    MatDividerModule,\r\n    MatMenuModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSlideToggleModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatListModule,\r\n    MatSliderModule,\r\n    MatBadgeModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoImageModule,\r\n    IgoPanelModule\r\n  ],\r\n  exports: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent\r\n  ],\r\n  declarations: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent\r\n  ]\r\n})\r\nexport class IgoLayerModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoLayerModule,\r\n      providers: [LayerService, StyleService, LayerListToolService]\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  MatTooltipModule,\r\n  MatBadgeModule,\r\n  MatButtonModule,\r\n  MatIconModule,\r\n  MatListModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoMatBadgeIconModule,\r\n  IgoCollapsibleModule,\r\n  IgoListModule\r\n} from '@igo2/common';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { CatalogBrowserComponent } from './catalog-browser.component';\r\nimport { CatalogBrowserLayerComponent } from './catalog-browser-layer.component';\r\nimport { CatalogBrowserGroupComponent } from './catalog-browser-group.component';\r\nimport { IgoLayerModule } from '../../layer/layer.module';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoMetadataModule,\r\n    IgoLayerModule\r\n  ],\r\n  exports: [\r\n    CatalogBrowserComponent\r\n  ],\r\n  declarations: [\r\n    CatalogBrowserComponent,\r\n    CatalogBrowserGroupComponent,\r\n    CatalogBrowserLayerComponent\r\n  ]\r\n})\r\nexport class IgoCatalogBrowserModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { IgoMap } from '../../map';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n/**\r\n * Component to browse a list of available catalogs\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library',\r\n  templateUrl: './catalog-library.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryComponent implements OnInit {\r\n\r\n  /**\r\n   * Store holding the catalogs\r\n   */\r\n  @Input() store: EntityStore<Catalog>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Event emitted a catalog is selected or unselected\r\n   */\r\n  @Output() catalogSelectChange = new EventEmitter<{\r\n    selected: boolean;\r\n    catalog: Catalog;\r\n  }>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.state.clear();\r\n  }\r\n\r\n  /**\r\n   * When a catalog is selected, update it's state in the store\r\n   * and emit the catalog select change event\r\n   * @internal\r\n   */\r\n  onCatalogSelect(catalog: Catalog) {\r\n    this.store.state.update(catalog, {\r\n      selected: true,\r\n      focused: true\r\n    }, true);\r\n    this.catalogSelectChange.emit({selected: true, catalog});\r\n  }\r\n\r\n}\r\n","import { Component, Input, ChangeDetectionStrategy } from '@angular/core';\r\n\r\nimport { getEntityTitle } from '@igo2/common';\r\nimport { IgoMap } from '../../map';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n/**\r\n * Catalog library item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library-item',\r\n  templateUrl: './catalog-library-item.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryItemComponent {\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return getEntityTitle(this.catalog); }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  MatTooltipModule,\r\n  MatIconModule,\r\n  MatListModule\r\n} from '@angular/material';\r\n\r\nimport { IgoListModule } from '@igo2/common';\r\n\r\nimport { CatalogLibaryComponent, } from './catalog-library.component';\r\nimport { CatalogLibaryItemComponent } from './catalog-library-item.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoListModule\r\n  ],\r\n  exports: [\r\n    CatalogLibaryComponent\r\n  ],\r\n  declarations: [\r\n    CatalogLibaryComponent,\r\n    CatalogLibaryItemComponent\r\n  ]\r\n})\r\nexport class IgoCatalogLibraryModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport {\r\n  MatIconModule,\r\n  MatListModule,\r\n  MatTooltipModule,\r\n  MatBadgeModule\r\n} from '@angular/material';\r\n\r\nimport { IgoListModule, IgoCollapsibleModule, IgoMatBadgeIconModule } from '@igo2/common';\r\n\r\nimport { IgoCatalogBrowserModule } from './catalog-browser/catalog-browser.module';\r\nimport { IgoCatalogLibraryModule } from './catalog-library/catalog-library.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule\r\n  ],\r\n  exports: [\r\n    IgoCatalogBrowserModule,\r\n    IgoCatalogLibraryModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoCatalogModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  exports: [],\r\n  declarations: []\r\n})\r\nexport class IgoDataSourceModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoDataSourceModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { DataSource } from '../../datasource/shared/datasources/datasource';\r\n\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\nimport { TimeFilterableDataSource } from './time-filter.interface';\r\n\r\n@Pipe({\r\n  name: 'filterableDataSource'\r\n})\r\nexport class FilterableDataSourcePipe implements PipeTransform {\r\n  transform(value: Layer[], arg: string): Layer[] {\r\n    let layers;\r\n\r\n    if (arg === 'time') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as TimeFilterableDataSource;\r\n        return (\r\n          this.isTimeFilterable(datasource) &&\r\n          datasource.options.timeFilter !== undefined &&\r\n          Object.keys(datasource.options.timeFilter).length\r\n        );\r\n      });\r\n    }\r\n    if (arg === 'ogc') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as OgcFilterableDataSource;\r\n        return this.isOgcFilterable(datasource);\r\n      });\r\n    }\r\n    return layers;\r\n  }\r\n\r\n  private isTimeFilterable(dataSource: TimeFilterableDataSource) {\r\n    if (dataSource.options.type !== 'wms') {\r\n      return false;\r\n    }\r\n    return dataSource.options.timeFilterable;\r\n  }\r\n\r\n  private isOgcFilterable(dataSource: OgcFilterableDataSource): boolean {\r\n    let isOgcFilterable = false;\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      dataSource.options.ogcFilters.editable\r\n    ) {\r\n      isOgcFilterable = true;\r\n    }\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      dataSource.options.ogcFilters.pushButtons) {\r\n        isOgcFilterable = true;\r\n    }\r\n    return isOgcFilterable;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { TileArcGISRestDataSource } from '../../datasource/shared/datasources/tilearcgisrest-datasource';\r\n\r\n@Injectable()\r\nexport class TimeFilterService {\r\n  constructor() {}\r\n\r\n  filterByDate(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    date: Date | [Date, Date]\r\n  ) {\r\n    let time;\r\n    let newdateform;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(date)) {\r\n      const dates = [];\r\n      if (date[0]) {\r\n        newdateformStart = this.reformatDateTime(date[0]);\r\n        dates.push(date[0]);\r\n      }\r\n      if (date[1]) {\r\n        newdateformEnd = this.reformatDateTime(date[1]);\r\n        dates.push(date[1]);\r\n      }\r\n      if (dates.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else if (date) {\r\n      newdateform = this.reformatDateTime(date);\r\n      time = newdateform;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n  }\r\n\r\n  filterByYear(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    year: string | [string, string]\r\n  ) {\r\n    let time;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(year)) {\r\n      const years = [];\r\n      if (year[0]) {\r\n        newdateformStart = year[0];\r\n        years.push(year[0]);\r\n      }\r\n      if (year[1]) {\r\n        newdateformEnd = year[1];\r\n        years.push(year[1]);\r\n      }\r\n      if (years.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else {  // to reset filter.\r\n      time = year;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n  }\r\n\r\n  private reformatDateTime(value) {\r\n    const year = value.getFullYear();\r\n    let month = value.getMonth() + 1;\r\n    let day = value.getUTCDate();\r\n    let hour = value.getUTCHours();\r\n    let minute = value.getUTCMinutes();\r\n\r\n    if (Number(month) < 10) {\r\n      month = '0' + month;\r\n    }\r\n\r\n    if (Number(day) < 10) {\r\n      day = '0' + day;\r\n    }\r\n\r\n    if (Number(hour) < 10) {\r\n      hour = '0' + hour;\r\n    }\r\n\r\n    if (Number(minute) < 10) {\r\n      minute = '0' + minute;\r\n    }\r\n\r\n    return year + '-' + month + '-' + day + 'T' + hour + ':' + minute + ':00Z';\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { OgcFilterWriter } from './ogc-filter';\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\n\r\n@Injectable()\r\nexport class OGCFilterService {\r\n  constructor() {}\r\n\r\n  public filterByOgc(wmsDatasource: WMSDataSource, filterString: string) {\r\n    const appliedFilter = new OgcFilterWriter().formatProcessedOgcFilter(filterString, wmsDatasource.options.params.LAYERS);\r\n    wmsDatasource.ol.updateParams({ FILTER: appliedFilter });\r\n  }\r\n\r\n  public setOgcWFSFiltersOptions(wfsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wfsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.paramsWFS.fieldNameGeometry,\r\n        new olProjection({ code: options.paramsWFS.srsName }),\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          options.ogcFilters.filters,\r\n          options.paramsWFS.fieldNameGeometry\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  public setOgcWMSFiltersOptions(wmsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wmsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.fieldNameGeometry,\r\n        undefined,\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          // With some wms server, this param must be set to make spatials call.\r\n          options.ogcFilters.filters,\r\n          options.fieldNameGeometry\r\n        );\r\n      }\r\n      this.filterByOgc(\r\n        wmsDatasource as WMSDataSource,\r\n        ogcFilterWriter.buildFilter(options.ogcFilters.filters)\r\n      );\r\n      options.filtered = true;\r\n    } else {\r\n      options.ogcFilters.filters = undefined;\r\n      options.ogcFilters.interfaceOgcFilters = [];\r\n      options.filtered = false;\r\n    }\r\n  }\r\n}\r\n","export enum SpatialFilterQueryType {\r\n    AdmRegion = 'AdmRegion',\r\n    Mun = 'Mun',\r\n    Arrond = 'Arrond',\r\n    CircFed = 'CircFed',\r\n    CircProv = 'CircProv',\r\n    DirReg = 'DirReg',\r\n    MRC = 'MRC',\r\n    RegTour = 'RegTour'\r\n}\r\n\r\nexport enum SpatialFilterType {\r\n    Predefined = 'Predefined',\r\n    Polygon = 'Polygon',\r\n    Point = 'Point'\r\n}\r\n\r\nexport enum SpatialFilterItemType {\r\n    Address = 'Address',\r\n    Thematics = 'Thematics'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\nimport { map } from 'rxjs/operators';\r\nimport { Observable } from 'rxjs';\r\nimport { Feature } from '../../feature/shared';\r\nimport {\r\n  SpatialFilterQueryType,\r\n  SpatialFilterItemType\r\n} from './spatial-filter.enum';\r\nimport { SpatialFilterThematic } from './spatial-filter.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SpatialFilterService {\r\n  public baseUrl: string = 'https://geoegl.msp.gouv.qc.ca/apis/terrapi/';\r\n\r\n  /*\r\n   * Type association with URL\r\n   */\r\n  public urlFilterList = {\r\n    AdmRegion: 'regadmin',\r\n    Arrond: 'arrondissements',\r\n    CircFed: 'circ-fed',\r\n    CircProv: 'circ-prov',\r\n    DirReg: 'dir-reg',\r\n    MRC: 'mrc',\r\n    Mun: 'municipalites',\r\n    RegTour: 'tourisme',\r\n    bornes: 'bornes-sumi',\r\n    hydro: 'hydro',\r\n    routes: 'routes'\r\n  };\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService\r\n  ) {\r\n    this.baseUrl =\r\n      this.configService.getConfig('spatialFilter.url') || this.baseUrl;\r\n  }\r\n\r\n  getKeyByValue(object, value) {\r\n    return Object.keys(object).find(key => object[key] === value);\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter list component (NO GEOMETRY)\r\n   */\r\n  loadFilterList(type: SpatialFilterQueryType): Observable<Feature[]> {\r\n    const urlPath = type as string;\r\n    if (urlPath) {\r\n      return this.http\r\n        .get<{ features: Feature[] }>(\r\n          this.baseUrl + this.urlFilterList[urlPath]\r\n        )\r\n        .pipe(\r\n          map(featureCollection =>\r\n            featureCollection.features.map(f => {\r\n              f.meta = {\r\n                id: f.properties.code\r\n              };\r\n              return f;\r\n            })\r\n          )\r\n        );\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Loading item list (STRING)\r\n   */\r\n  loadThematicsList() {\r\n    const url = 'types';\r\n    const items: SpatialFilterThematic[] = [];\r\n    return this.http.get(this.baseUrl + url).pipe(\r\n      map((types: string[]) => {\r\n        types.forEach(type => {\r\n          if (type.startsWith('lieux')) {\r\n            const item: SpatialFilterThematic = {\r\n              name: undefined,\r\n              source: type\r\n            };\r\n            let substr = type.substring(6, type.length);\r\n            let name = substr;\r\n            if (substr.includes('.')) {\r\n              const index = substr.indexOf('.');\r\n              name = substr.substring(index + 1, substr.length);\r\n              substr = substr.substring(0, index);\r\n            }\r\n            try {\r\n              item.name = this.languageService.translate.instant(\r\n                'igo.geo.terrapi.' + name\r\n              );\r\n            } catch (e) {\r\n              item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n            }\r\n\r\n            try {\r\n              item.group = this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.group.' + substr\r\n              );\r\n            } catch (e) {\r\n              item.group = substr.substring(0, 1).toUpperCase() + substr.substring(1, name.length - 1);\r\n            }\r\n\r\n            items.push(item);\r\n          } else {\r\n            if (this.getKeyByValue(this.urlFilterList, type)) {\r\n              const item: SpatialFilterThematic = {\r\n                name: undefined,\r\n                source: type\r\n              };\r\n              const name = this.getKeyByValue(this.urlFilterList, type);\r\n              try {\r\n                item.name = this.languageService.translate.instant(\r\n                  'igo.geo.terrapi.' + name\r\n                );\r\n              } catch (e) {\r\n                item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n              }\r\n              item.source = type;\r\n\r\n              items.push(item);\r\n            }\r\n          }\r\n        });\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter item component (Address or Thematics) depends on predefined zone or draw zone (feature)\r\n   */\r\n  loadFilterItem(\r\n    feature,\r\n    itemType: SpatialFilterItemType,\r\n    type?: SpatialFilterQueryType,\r\n    thematic?: SpatialFilterThematic,\r\n    buffer?: number\r\n  ) {\r\n    if (type) {\r\n      // Predefined type\r\n      const urlType = type as string;\r\n      const url = this.baseUrl + this.urlFilterList[urlType];\r\n      let urlItem = '';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        urlItem = 'adresses';\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        urlItem = thematic.source;\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    } else {\r\n      // Draw type\r\n      const url = this.baseUrl + 'locate';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        const urlItem = '?type=adresses';\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            buffer,\r\n            loc: JSON.stringify(feature)\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        const urlItem = '?type=' + thematic.source;\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            buffer,\r\n            loc: JSON.stringify(feature)\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Get one territory by id (WITH GEOMETRY)\r\n   */\r\n  loadItemById(\r\n    feature: Feature,\r\n    type: SpatialFilterQueryType\r\n  ): Observable<Feature> {\r\n    const featureType = this.urlFilterList[type];\r\n    const featureCode = '/' + feature.properties.code;\r\n    if (featureType && featureCode) {\r\n      return this.http\r\n        .get<Feature>(this.baseUrl + featureType + featureCode, {\r\n          params: {\r\n            geometry: 'true'\r\n          }\r\n        })\r\n        .pipe(\r\n          map(f => {\r\n            f.meta = {\r\n              id: f.properties.code,\r\n              alias: f.properties.nom,\r\n              title: f.properties.nom\r\n            };\r\n            return f;\r\n          })\r\n        );\r\n    }\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\nimport { Layer } from '../../layer/shared';\r\nimport { OgcFilterWriter, OgcFilterableDataSourceOptions } from '../../filter/shared';\r\n\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DownloadService {\r\n\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  open(layer: Layer) {\r\n    const translate = this.languageService.translate;\r\n    const title = translate.instant('igo.geo.download.title');\r\n    this.messageService.success(\r\n      translate.instant('igo.geo.download.start'),\r\n      title\r\n    );\r\n\r\n    const DSOptions: DataSourceOptions = layer.dataSource.options;\r\n    if (Object.keys(DSOptions.download).length > 0) {\r\n      if (\r\n        DSOptions.download.dynamicUrl &&\r\n        DSOptions.download.url === undefined\r\n      ) {\r\n        let wfsOptions;\r\n        if (\r\n          (layer.dataSource.options as any).paramsWFS &&\r\n          Object.keys((layer.dataSource.options as any).paramsWFS).length > 0\r\n        ) {\r\n          wfsOptions = (layer.dataSource.options as any).paramsWFS;\r\n        } else {\r\n          wfsOptions = (layer.dataSource.options as any).params;\r\n        }\r\n\r\n        const outputFormatDownload =\r\n          wfsOptions.outputFormatDownload === undefined\r\n            ? 'outputformat=' + wfsOptions.outputFormat\r\n            : 'outputformat=' + wfsOptions.outputFormatDownload;\r\n\r\n        const baseurl = DSOptions.download.dynamicUrl\r\n          .replace(/&?outputformat=[^&]*/gi, '')\r\n          .replace(/&?filter=[^&]*/gi, '')\r\n          .replace(/&?bbox=[^&]*/gi, '');\r\n\r\n        const ogcFilters = (layer.dataSource.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n\r\n        let filterQueryString;\r\n        filterQueryString = new OgcFilterWriter()\r\n        .handleOgcFiltersAppliedValue(\r\n          layer.dataSource.options,\r\n          ogcFilters.geometryName,\r\n          layer.map.viewController.getExtent(),\r\n          new olProjection({ code: layer.map.projection }));\r\n        if (!filterQueryString) {\r\n          // Prevent getting all the features for empty filter\r\n            filterQueryString = new OgcFilterWriter().buildFilter(\r\n            undefined,\r\n            layer.map.viewController.getExtent(),\r\n            new olProjection({ code: layer.map.projection }),\r\n            ogcFilters.geometryName\r\n          );\r\n        } else {\r\n          filterQueryString = 'filter=' + encodeURIComponent(filterQueryString);\r\n        }\r\n        window.open(\r\n          `${baseurl}&${filterQueryString}&${outputFormatDownload}`,\r\n          '_blank'\r\n        );\r\n      } else if (DSOptions.download) {\r\n        window.open(DSOptions.download.url, '_blank');\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Component, Input, ChangeDetectionStrategy } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { DownloadDataSourceOptions } from '../shared/download.interface';\r\nimport { DownloadService } from '../shared/download.service';\r\n\r\n@Component({\r\n  selector: 'igo-download-button',\r\n  templateUrl: './download-button.component.html',\r\n  styleUrls: ['./download-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DownloadButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private downloadService: DownloadService) {}\r\n\r\n  openDownload(layer: Layer) {\r\n    this.downloadService.open(layer);\r\n  }\r\n\r\n  get options(): DownloadDataSourceOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.dataSource.options;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatTooltipModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { DownloadButtonComponent } from './download-button/download-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [DownloadButtonComponent],\r\n  declarations: [DownloadButtonComponent]\r\n})\r\nexport class IgoDownloadModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoDownloadModule\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\n\r\nimport { Feature } from '../shared';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { IgoMap } from '../../map/shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-feature-details',\r\n  templateUrl: './feature-details.component.html',\r\n  styleUrls: ['./feature-details.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\n\r\nexport class FeatureDetailsComponent {\r\n  private state: ConnectionState;\r\n\r\n  @Input()\r\n  get source(): SearchSource {\r\n    return this._source;\r\n  }\r\n  set source(value: SearchSource ) {\r\n    this._source = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get feature(): Feature {\r\n    return this._feature;\r\n  }\r\n  set feature(value: Feature) {\r\n    this._feature = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  private _feature: Feature;\r\n  private _source: SearchSource;\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.feature);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.feature) || 'link';\r\n  }\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private sanitizer: DomSanitizer,\r\n    private networkService: NetworkService\r\n  ) {\r\n    this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n    });\r\n  }\r\n\r\n  htmlSanitizer(value): SafeResourceUrl {\r\n    return this.sanitizer.bypassSecurityTrustResourceUrl(value);\r\n  }\r\n\r\n  isObject(value) {\r\n    return typeof value === 'object';\r\n  }\r\n\r\n  isUrl(value) {\r\n    if (typeof value === 'string') {\r\n      return (\r\n        value.slice(0, 8) === 'https://' || value.slice(0, 7) === 'http://'\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  filterFeatureProperties(feature) {\r\n    const allowedFieldsAndAlias = feature.meta ? feature.meta.alias : undefined;\r\n    const properties = {};\r\n    let offlineButtonState;\r\n\r\n    if (this.map) {\r\n      this.map.offlineButtonToggle$.subscribe(state => {\r\n        offlineButtonState = state;\r\n      });\r\n    }\r\n\r\n    if (allowedFieldsAndAlias) {\r\n      Object.keys(allowedFieldsAndAlias).forEach(field => {\r\n        properties[allowedFieldsAndAlias[field]] = feature.properties[field];\r\n      });\r\n      return properties;\r\n    } else if (offlineButtonState !== undefined) {\r\n      if (!offlineButtonState) {\r\n        if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n          const excludeAttribute = feature.meta.excludeAttribute;\r\n          excludeAttribute.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      } else {\r\n        if (feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      }\r\n    } else {\r\n      if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n        const excludeAttribute = feature.meta.excludeAttribute;\r\n        excludeAttribute.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n        const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n        excludeAttributeOffline.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      }\r\n    }\r\n\r\n    return feature.properties;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule } from '@igo2/common';\r\n\r\nimport { FeatureDetailsComponent } from './feature-details.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule\r\n  ],\r\n  exports: [FeatureDetailsComponent],\r\n  declarations: [FeatureDetailsComponent]\r\n})\r\nexport class IgoFeatureDetailsModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\n\r\nimport { FeatureFormComponent } from './feature-form.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoFormModule\r\n  ],\r\n  exports: [\r\n    IgoFormModule,\r\n    FeatureFormComponent\r\n  ],\r\n  declarations: [\r\n    FeatureFormComponent\r\n  ]\r\n})\r\nexport class IgoFeatureFormModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFeatureDetailsModule } from './feature-details/feature-details.module';\r\nimport { IgoFeatureFormModule } from './feature-form/feature-form.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoFeatureDetailsModule,\r\n    IgoFeatureFormModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoFeatureModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { FormControl } from '@angular/forms';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport OlGeometryType from 'ol/geom/GeometryType';\r\nimport { Style as OlStyle } from 'ol/style';\r\n\r\nimport { FormFieldComponent } from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport { GeoJSONGeometry } from '../shared/geometry.interfaces';\r\n\r\n/**\r\n * This input allows a user to draw a new geometry or to edit\r\n * an existing one on a map.\r\n */\r\n@FormFieldComponent('geometry')\r\n@Component({\r\n  selector: 'igo-geometry-form-field',\r\n  templateUrl: './geometry-form-field.component.html',\r\n  styleUrls: ['./geometry-form-field.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class GeometryFormFieldComponent implements OnInit, OnDestroy {\r\n\r\n  readonly value$: BehaviorSubject<GeoJSONGeometry> = new BehaviorSubject(undefined);\r\n\r\n  private value$$: Subscription;\r\n\r\n  public drawControlIsActive = true;\r\n  public freehandDrawIsActive = false;\r\n\r\n  /**\r\n   * The field's form control\r\n   */\r\n  @Input() formControl: FormControl;\r\n\r\n  /**\r\n   * The map to draw the geometry on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  set geometryType(value: OlGeometryType) { this.geometryType$.next(value); }\r\n  get geometryType(): OlGeometryType { return this.geometryType$.value; }\r\n  readonly geometryType$: BehaviorSubject<OlGeometryType> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Whether a geometry type toggle should be displayed\r\n   */\r\n  @Input() geometryTypeField: boolean = false;\r\n\r\n  /**\r\n   * Available geometry types\r\n   */\r\n  @Input() geometryTypes: string[] = ['Point', 'LineString', 'Polygon'];\r\n\r\n  /**\r\n   * Whether a draw guide field should be displayed\r\n   */\r\n  @Input() drawGuideField: boolean = false;\r\n\r\n  /**\r\n   * The drawGuide around the mouse pointer to help drawing\r\n   */\r\n  @Input()\r\n  set drawGuide(value: number) { this.drawGuide$.next(value); }\r\n  get drawGuide(): number { return this.drawGuide$.value; }\r\n  readonly drawGuide$: BehaviorSubject<number> = new BehaviorSubject(0);\r\n\r\n  /**\r\n   * Draw guide placeholder\r\n   */\r\n  @Input() drawGuidePlaceholder: string = '';\r\n\r\n  /**\r\n   * Whether a measure tooltip should be displayed\r\n   */\r\n  @Input() measure: boolean = false;\r\n\r\n  /**\r\n   * Control options\r\n   */\r\n  @Input() controlOptions: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Style for the draw control (applies while the geometry is being drawn)\r\n   */\r\n  @Input() drawStyle: OlStyle;\r\n\r\n  /**\r\n   * Style for the overlay layer (applies once the geometry is added to the map)\r\n   * If not specified, drawStyle applies\r\n   */\r\n  @Input() overlayStyle: OlStyle;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Set up a value stream\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.value$.next(this.formControl.value ? this.formControl.value : undefined);\r\n    this.value$$ = this.formControl.valueChanges.subscribe((value: GeoJSONGeometry) => {\r\n      this.value$.next(value ? value : undefined);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the value stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.value$$.unsubscribe();\r\n  }\r\n}\r\n","\r\nexport const MEASURE_UNIT_AUTO = 'auto';\r\n\r\nexport enum MeasureType {\r\n  Length = 'length',\r\n  Area = 'area'\r\n}\r\n\r\nexport enum MeasureLengthUnit {\r\n  Meters = 'meters',\r\n  Kilometers = 'kilometers',\r\n  Miles = 'miles',\r\n  Feet = 'feet'\r\n}\r\n\r\nexport const MeasureLengthUnitAbbreviation = {\r\n  [MeasureLengthUnit.Meters]: 'm',\r\n  [MeasureLengthUnit.Kilometers]: 'km',\r\n  [MeasureLengthUnit.Miles]: 'mi',\r\n  [MeasureLengthUnit.Feet]: 'ft'\r\n};\r\n\r\nexport enum MeasureAreaUnit {\r\n  SquareMeters = 'squareMeters',\r\n  SquareKilometers = 'squareKilometers',\r\n  SquareMiles = 'squareMiles',\r\n  SquareFeet = 'squareFeet',\r\n  Hectares = 'hectares',\r\n  Acres = 'acres'\r\n}\r\n\r\nexport const MeasureAreaUnitAbbreviation = {\r\n  [MeasureAreaUnit.SquareMeters]: 'm',\r\n  [MeasureAreaUnit.SquareKilometers]: 'km',\r\n  [MeasureAreaUnit.SquareMiles]: 'mi',\r\n  [MeasureAreaUnit.SquareFeet]: 'ft',\r\n  [MeasureAreaUnit.Hectares]: 'ha',\r\n  [MeasureAreaUnit.Acres]: 'ac'\r\n};\r\n","import { LanguageService } from '@igo2/core';\r\nimport * as olstyle from 'ol/style';\r\nimport OlGeometry from 'ol/geom/Geometry';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { getCenter as olGetCenter } from 'ol/extent';\r\nimport {\r\n  getLength as olGetLength,\r\n  getArea as olGetArea\r\n} from 'ol/sphere';\r\n\r\nimport { Measure } from './measure.interfaces';\r\nimport {\r\n  MeasureAreaUnit,\r\n  MeasureAreaUnitAbbreviation,\r\n  MeasureLengthUnit,\r\n  MeasureLengthUnitAbbreviation\r\n} from './measure.enum';\r\n\r\n/**\r\n * Convert value from meters to kilometers\r\n * @param value Value in meters\r\n * @returns Value in kilometers\r\n */\r\nexport function metersToKilometers(value: number): number {\r\n  return value * 0.001;\r\n}\r\n\r\n/**\r\n * Convert value from meters to feet\r\n * @param value Value in meters\r\n * @returns Value in feet\r\n */\r\nexport function metersToFeet(value: number): number {\r\n  return value * 3.2808;\r\n}\r\n\r\n/**\r\n * Convert value from meters to miles\r\n * @param value Value in meters\r\n * @returns Value in miles\r\n */\r\nexport function metersToMiles(value: number): number {\r\n  return value * 0.000621;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square kilometers\r\n * @param value Value in square meters\r\n * @returns Value in square kilometers\r\n */\r\nexport function squareMetersToSquareKilometers(value: number): number {\r\n  return value * 0.000001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square miles\r\n * @param value Value in square meters\r\n * @returns Value in square miles\r\n */\r\nexport function squareMetersToSquareMiles(value: number): number {\r\n  return value * 0.0000003861;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square feet\r\n * @param value Value in square meters\r\n * @returns Value in square feet\r\n */\r\nexport function squareMetersToSquareFeet(value: number): number {\r\n  return value * 10.764;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to hectares\r\n * @param value Value in square meters\r\n * @returns Value in hectares\r\n */\r\nexport function squareMetersToHectares(value: number): number {\r\n  return value * 0.0001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to acres\r\n * @param value Value in square meters\r\n * @returns Value in acres\r\n */\r\nexport function squareMetersToAcres(value: number): number {\r\n  return value * 0.00024711;\r\n}\r\n\r\n/**\r\n * Convert value from meters to the specified length unit\r\n * @param value Value in meters\r\n * @param unit Length unit\r\n * @returns Value in unit\r\n */\r\nexport function metersToUnit(value: number, unit: MeasureLengthUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureLengthUnit.Meters, (val: number) => val],\r\n    [MeasureLengthUnit.Kilometers, metersToKilometers],\r\n    [MeasureLengthUnit.Miles, metersToMiles],\r\n    [MeasureLengthUnit.Feet, metersToFeet],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to the specified area unit\r\n * @param value Value in meters\r\n * @param unit Area unit\r\n * @returns Value in unit\r\n */\r\nexport function squareMetersToUnit(value: number, unit: MeasureAreaUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureAreaUnit.SquareMeters, (val: number) => val],\r\n    [MeasureAreaUnit.SquareKilometers, squareMetersToSquareKilometers],\r\n    [MeasureAreaUnit.SquareMiles, squareMetersToSquareMiles],\r\n    [MeasureAreaUnit.SquareFeet, squareMetersToSquareFeet],\r\n    [MeasureAreaUnit.Hectares, squareMetersToHectares],\r\n    [MeasureAreaUnit.Acres, squareMetersToAcres],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * This method format a measure to a readable format\r\n * @param measure Measure\r\n * @param options Formatting options\r\n * @returns Formatted measure\r\n */\r\nexport function formatMeasure(\r\n  measure: number,\r\n  options?: {\r\n    decimal?: number;\r\n    unit?: MeasureAreaUnit | MeasureLengthUnit;\r\n    unitAbbr?: boolean;\r\n    locale?: string;\r\n  },\r\n  languageService?: LanguageService) {\r\n  let decimal = options.decimal;\r\n  if (decimal === undefined || decimal < 0) {\r\n    decimal = 1;\r\n  }\r\n\r\n  const parts = [];\r\n  if (options.locale !== undefined) {\r\n    parts.push(measure.toLocaleString(options.locale, {\r\n      minimumFractionDigits: decimal,\r\n      maximumFractionDigits: decimal\r\n    }));\r\n  } else {\r\n    parts.push(measure.toFixed(decimal).toString());\r\n  }\r\n\r\n  if (options.unit !== undefined && options.unitAbbr === true) {\r\n    if (languageService) {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] ?\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureLengthUnitAbbreviation[options.unit]) :\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureAreaUnitAbbreviation[options.unit])\r\n      );\r\n    } else {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] || MeasureAreaUnitAbbreviation[options.unit]\r\n      );\r\n    }\r\n  }\r\n\r\n  return parts.filter(p => p !== undefined).join(' ');\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestLengthUnit(value: number): MeasureLengthUnit {\r\n  let unit = MeasureLengthUnit.Meters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureLengthUnit.Kilometers];\r\n  while (converted > 1000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = metersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in square meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestAreaUnit(value: number): MeasureAreaUnit {\r\n  let unit = MeasureAreaUnit.SquareMeters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureAreaUnit.SquareKilometers];\r\n  while (converted > 1000000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = squareMetersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Create a default style for a measure interaction\r\n * @returns OL style\r\n */\r\nexport function createMeasureInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      lineDash: [10, 10],\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    }),\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke: new olstyle.Stroke({\r\n        color: '#ffcc33',\r\n      }),\r\n      fill: new olstyle.Fill({\r\n        color: 'rgba(255, 255, 255, 0.2)'\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for a measure layer\r\n * @returns OL style\r\n */\r\nexport function createMeasureLayerStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Compute the length in meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Length in meters\r\n */\r\nexport function measureOlGeometryLength(olGeometry: OlGeometry, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetLength(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area in square meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Area in square meters\r\n */\r\nexport function measureOlGeometryArea(olGeometry: OlGeometry, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint || olGeometry instanceof OlLineString) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetArea(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area (square meters), length (meters) and last length (meters)\r\n * of an OL geometry with a given projection.\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Computed measure\r\n */\r\nexport function measureOlGeometry(olGeometry: OlGeometry, projection: string): Measure {\r\n  const length = measureOlGeometryLength(olGeometry, projection);\r\n  const area = measureOlGeometryArea(olGeometry, projection);\r\n\r\n  const lengths = [];\r\n  const coordinates = olGeometry.flatCoordinates;\r\n  const coordinatesLength = coordinates.length;\r\n  for (let i = 0; i <= coordinatesLength - 4; i += 2) {\r\n    const olSegment = new OlLineString([\r\n      [coordinates[i], coordinates[i + 1]],\r\n      [coordinates[i + 2], coordinates[i + 3]]\r\n    ]);\r\n\r\n    lengths.push(measureOlGeometryLength(olSegment, projection));\r\n  }\r\n\r\n  return {\r\n    area,\r\n    length,\r\n    lengths\r\n  };\r\n}\r\n\r\n/**\r\n * Update an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nexport function updateOlGeometryMidpoints(olGeometry: OlLineString | OlPolygon): OlPoint[] {\r\n  const olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n\r\n  // TODO: handle multi geometries\r\n  const coordinates = olGeometry.flatCoordinates;\r\n  const midpointsLength = olMidpoints.length;\r\n  for (let i = 0; i < midpointsLength; i++) {\r\n    const j = i * 2;\r\n    const olSegment = new OlLineString([\r\n      [coordinates[j], coordinates[j + 1]],\r\n      [coordinates[j + 2], coordinates[j + 3]]\r\n    ]);\r\n\r\n    const midpointCoordinate = olSegment.getCoordinateAt(0.5);\r\n    const olMidpoint = olMidpoints[i];\r\n    if (olMidpoint !== undefined) {\r\n      olMidpoint.setCoordinates(midpointCoordinate);\r\n    } else {\r\n      olMidpoints[i] = new OlPoint(midpointCoordinate);\r\n    }\r\n  }\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Clear an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n */\r\nexport function clearOlGeometryMidpoints(olGeometry: OlLineString | OlPolygon) {\r\n  const olMidpoints = olGeometry.get('_midpoints') || [];\r\n  const midpointsLength = olMidpoints.length;\r\n  for (let i = 0; i < midpointsLength; i++) {\r\n    const olMidpoint = olMidpoints[i];\r\n    if (olMidpoint !== undefined) {\r\n      if (olMidpoint !== undefined) {\r\n        clearOlMidpointTooltip(olMidpoint);\r\n      }\r\n    }\r\n  }\r\n\r\n  olGeometry.set('_midpoints', undefined, true);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Return an array of  OL geometry midpoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nfunction getOlGeometryMidpoints(olGeometry: OlLineString | OlPolygon): OlPoint[] {\r\n  const expectedNumber = Math.max((olGeometry.flatCoordinates.length / 2) - 1, 0);\r\n\r\n  // TODO: This works but it's quite messy. If time permits,\r\n  // clean this. Maybe a Tooltip class could handle that\r\n  let olMidpoints = olGeometry.get('_midpoints');\r\n  if (olMidpoints === undefined) {\r\n    olMidpoints = new Array(expectedNumber);\r\n    olGeometry.set('_midpoints', olMidpoints, true);\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber === olMidpoints.length) {\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber > olMidpoints.length) {\r\n    olMidpoints.push(...new Array(expectedNumber - olMidpoints.length));\r\n    return olMidpoints;\r\n  }\r\n\r\n  for (let i = expectedNumber; i < olMidpoints.length; i++) {\r\n    const olMidpoint = olMidpoints[expectedNumber];\r\n    if (olMidpoint !== undefined) {\r\n      clearOlMidpointTooltip(olMidpoint);\r\n    }\r\n  }\r\n  olMidpoints.splice(expectedNumber);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Remove an OL midpoint's tooltip from the map\r\n * @param olMidpoint OL Point\r\n */\r\nfunction clearOlMidpointTooltip(olMidpoint: OlPoint) {\r\n  const olTooltip = olMidpoint.get('_tooltip');\r\n  if (olTooltip !== undefined) {\r\n    const olMap = olTooltip.getMap();\r\n    if (olMap !== undefined) {\r\n      olMap.removeOverlay(olTooltip);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Add an OL overlay at each midpoint and return an array of those overlays\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function updateOlTooltipsAtMidpoints(olGeometry: OlLineString | OlPolygon): OlOverlay[] {\r\n  const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n  const olTooltips = olMidpoints.map((olMidpoint: OlPoint) => {\r\n    let olTooltip = olMidpoint.get('_tooltip');\r\n    if (olTooltip === undefined) {\r\n      olTooltip = createOlTooltipAtPoint(olMidpoint);\r\n    } else {\r\n      olTooltip.setPosition(olMidpoint.flatCoordinates);\r\n    }\r\n    return olTooltip;\r\n  });\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipsAtMidpoints(olGeometry: OlLineString | OlPolygon): OlOverlay[] {\r\n  const olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n  return olMidpoints.map((olMidpoint: OlPoint) => {\r\n    return olMidpoint ? olMidpoint.get('_tooltip') : undefined;\r\n  });\r\n}\r\n\r\n/**\r\n * Update an OL geometry center and return it\r\n * @param olGeometry OL Geometry\r\n * @returns OL point\r\n */\r\nexport function updateOlGeometryCenter(olGeometry: OlLineString | OlPolygon): OlPoint {\r\n  let olCenter = olGeometry.get('_center');\r\n  const centerCoordinate = olGetCenter(olGeometry.getExtent());\r\n  if (olCenter !== undefined) {\r\n    olCenter.setCoordinates(centerCoordinate);\r\n  } else {\r\n    olCenter = new OlPoint(centerCoordinate);\r\n    olGeometry.set('_center', olCenter);\r\n  }\r\n\r\n  return olCenter;\r\n}\r\n\r\n/**\r\n * Add an OL overlay at the center of a geometry and return that overlay\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlay\r\n */\r\nexport function updateOlTooltipAtCenter(olGeometry: OlLineString | OlPolygon): OlOverlay {\r\n  const olCenter = updateOlGeometryCenter(olGeometry);\r\n  let olTooltip = olCenter.get('_tooltip');\r\n  if (olTooltip === undefined) {\r\n    olTooltip = createOlTooltipAtPoint(olCenter);\r\n  } else {\r\n    olTooltip.setPosition(olCenter.flatCoordinates);\r\n  }\r\n  return olTooltip;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipAtCenter(olGeometry: OlLineString | OlPolygon): OlOverlay {\r\n  const olCenter = olGeometry.get('_center');\r\n  return olCenter ? olCenter.get('_tooltip') : undefined;\r\n}\r\n\r\n/**\r\n * Get all the tooltips of an OL geometry\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon): OlOverlay[] {\r\n  const olTooltips = [].concat(getOlTooltipsAtMidpoints(olGeometry) || []);\r\n  const olCenterTooltip = getOlTooltipAtCenter(olGeometry);\r\n  if (olCenterTooltip !== undefined) {\r\n    olTooltips.push(olCenterTooltip);\r\n  }\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Create an OL overlay at a point and bind the overlay to the point\r\n * @param olPoint OL Point\r\n * @returns OL overlay\r\n */\r\nexport function createOlTooltipAtPoint(olPoint: OlPoint): OlOverlay {\r\n  const olTooltip = new OlOverlay({\r\n    element: document.createElement('div'),\r\n    offset: [-30, -10],\r\n    className: [\r\n      'igo-map-tooltip',\r\n      'igo-map-tooltip-measure'\r\n    ].join(' '),\r\n    stopEvent: false\r\n  });\r\n  olTooltip.setPosition(olPoint.flatCoordinates);\r\n  olPoint.set('_tooltip', olTooltip);\r\n\r\n  return olTooltip;\r\n}\r\n","/* tslint:disable */\r\n// See this issue: https://github.com/Microsoft/TypeScript/issues/13965\r\n// And the solution: https://github.com/Microsoft/TypeScript/wiki/Breaking-Changes#extending-built-ins-like-error-array-and-map-may-no-longer-work\r\n// for an explanation as to why the prototype is set manually\r\n/* tslint:enable */\r\n\r\nexport class GeometrySliceError extends Error {}\r\n\r\nexport class GeometrySliceMultiPolygonError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice a MultiPolygon.');\r\n    Object.setPrototypeOf(this, GeometrySliceMultiPolygonError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceLineStringError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice with a line that has more than 2 points.');\r\n    Object.setPrototypeOf(this, GeometrySliceLineStringError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceTooManyIntersectionError extends GeometrySliceError {\r\n  constructor() {\r\n    super('More than 2 intersections found between the target polygon and the slicing line.');\r\n    Object.setPrototypeOf(this, GeometrySliceTooManyIntersectionError.prototype);\r\n  }\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport { GeometryEvent as OlGeometryEvent } from 'ol/geom/Geometry';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport lineIntersect from '@turf/line-intersect';\r\nimport { lineString } from '@turf/helpers';\r\n\r\nimport {\r\n  GeometrySliceMultiPolygonError,\r\n  GeometrySliceLineStringError,\r\n  GeometrySliceTooManyIntersectionError\r\n } from './geometry.errors';\r\n\r\n/**\r\n * Create a default style for draw and modify interactions\r\n * @param color Style color (R, G, B)\r\n * @returns OL style\r\n */\r\nexport function createDrawInteractionStyle(color?: [number, number, number]): olstyle.Style {\r\n  color = color || [0, 153, 255];\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: color.concat([1]),\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: color.concat([0.2])\r\n    }),\r\n    image: new olstyle.Circle({\r\n      radius: 8,\r\n      stroke: new olstyle.Stroke({\r\n        color: color.concat([1])\r\n      }),\r\n      fill: new olstyle.Fill({\r\n        color: color.concat([0.2])\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for drawing a hole\r\n * @returns OL style\r\n */\r\nexport function createDrawHoleInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color:  [0, 153, 255, 1],\r\n      width: 2\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Slice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function sliceOlGeometry(\r\n  olGeometry: OlLineString | OlPolygon,\r\n  olSlicer: OlLineString\r\n): Array<OlLineString | OlPolygon> {\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return sliceOlPolygon(olGeometry, olSlicer);\r\n  } else if (olGeometry instanceof OlLineString) {\r\n    return sliceOlLineString(olGeometry, olSlicer);\r\n  }\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL LineString into one or more lines\r\n * @param olLineString OL line string\r\n * @param olSlicer Slicing line\r\n * @returns New OL line strings\r\n */\r\nexport function sliceOlLineString(olLineString: OlLineString, olSlicer: OlLineString): OlLineString[] {\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL Polygon into one or more polygons\r\n * @param olPolygon OL polygon\r\n * @param olSlicer Slicing line\r\n * @returns New OL polygons\r\n */\r\nexport function sliceOlPolygon(olPolygon: OlPolygon, olSlicer: OlLineString): OlPolygon[] {\r\n  if (olPolygon.getLinearRingCount() > 1) {\r\n    throw new GeometrySliceMultiPolygonError();\r\n  }\r\n\r\n  if (olSlicer.getCoordinates().length > 2) {\r\n    throw new GeometrySliceLineStringError();\r\n  }\r\n\r\n  const olGeoJSON = new OlGeoJSON();\r\n  const slicer = olGeoJSON.writeGeometryObject(olSlicer);\r\n  const outerCoordinates = olPolygon.getLinearRing(0).getCoordinates();\r\n\r\n  const parts = [[], []];\r\n  let totalIntersectionCount = 0;\r\n  for (let i = 0, ii = outerCoordinates.length - 1; i < ii; i++) {\r\n    const segmentCoordinates = [outerCoordinates[i], outerCoordinates[i + 1]];\r\n    const segment = lineString(segmentCoordinates);\r\n    const intersections = lineIntersect(segment, slicer).features;\r\n\r\n    const intersectionCount = intersections.length;\r\n    totalIntersectionCount += intersectionCount;\r\n    if (intersectionCount > 1 || totalIntersectionCount > 2) {\r\n      throw new GeometrySliceTooManyIntersectionError();\r\n    }\r\n\r\n    parts[0].push(segmentCoordinates[0]);\r\n    if (intersectionCount === 1) {\r\n      const intersection = intersections[0].geometry.coordinates;\r\n      parts[0].push(intersection);\r\n      parts[1].push(intersection);\r\n      parts.reverse();\r\n    }\r\n  }\r\n\r\n  if (totalIntersectionCount <= 1) {\r\n    return [];\r\n  }\r\n\r\n  parts[0].push(parts[0][0]);\r\n  parts[1].push(parts[1][0]);\r\n\r\n  return [new OlPolygon([parts[0]]), new OlPolygon([parts[1]])];\r\n}\r\n\r\n/**\r\n * Splice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function addLinearRingToOlPolygon(olPolygon: OlPolygon, olLinearRing: OlLinearRing ): OlPolygon {\r\n  // TODO: make some validation and support updating an existing linear ring\r\n  olPolygon.appendLinearRing(olLinearRing);\r\n}\r\n\r\nexport function getMousePositionFromOlGeometryEvent(\r\n  olEvent: OlGeometryEvent\r\n): [number, number] {\r\n  const olGeometry = olEvent.target;\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return olGeometry.flatCoordinates.slice(-4, -2);\r\n  }\r\n  return olGeometry.flatCoordinates.slice(-2);\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlStyle from 'ol/style';\r\nimport OlGeometryType from 'ol/geom/GeometryType';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport {\r\n  Geometry as OlGeometry,\r\n  GeometryEvent as OlGeometryEvent\r\n} from 'ol/geom/Geometry';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subject, Subscription, fromEvent, BehaviorSubject } from 'rxjs';\r\n\r\nimport { getMousePositionFromOlGeometryEvent } from '../geometry.utils';\r\n\r\nexport interface DrawControlOptions {\r\n  geometryType: OlGeometryType;\r\n  source?: OlVectorSource;\r\n  layer?: OlVectorLayer;\r\n  layerStyle?: OlStyle | ((olfeature: OlFeature) => OlStyle);\r\n  drawStyle?: OlStyle | ((olfeature: OlFeature) => OlStyle);\r\n  maxPoints?: number;\r\n}\r\n\r\n/**\r\n * Control to draw geometries\r\n */\r\nexport class DrawControl {\r\n\r\n  /**\r\n   * Draw start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Geometry changes observable\r\n   */\r\n  public changes$: Subject<OlGeometry> = new Subject();\r\n\r\n  private olMap: OlMap;\r\n  private olOverlayLayer: OlVectorLayer;\r\n  private olDrawInteraction: OlDraw;\r\n  private onDrawStartKey: string;\r\n  private onDrawEndKey: string;\r\n  private onDrawKey: string;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  private keyDown$$: Subscription;\r\n\r\n  freehand$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * Geometry type\r\n   * @internal\r\n   */\r\n  get geometryType(): OlGeometryType {\r\n    return this.options.geometryType;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  constructor(private options: DrawControlOptions) {\r\n    if (options.layer !== undefined) {\r\n      this.olOverlayLayer = options.layer;\r\n    } else {\r\n      this.olOverlayLayer = this.createOlInnerOverlayLayer();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap === undefined) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlDrawInteraction();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n    this.addOlDrawInteraction();\r\n  }\r\n\r\n  /**\r\n   * Return the overlay source\r\n   */\r\n  getSource(): OlVectorSource {\r\n    return this.olOverlaySource;\r\n  }\r\n\r\n  /**\r\n   * Create an overlay source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer {\r\n    return new OlVectorLayer({\r\n      source: this.options.source ? this.options.source : new OlVectorSource(),\r\n      style: this.options.layerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined && this.olMap !== undefined) {\r\n      this.olMap.removeLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer(): OlVectorLayer {\r\n    if (this.options.layer === undefined) {\r\n      this.olMap.addLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (this.options.layer === undefined && this.options.source === undefined) {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a draw interaction to the map an set up some listeners\r\n   */\r\n  addOlDrawInteraction() {\r\n    let olDrawInteraction;\r\n    if (this.freehand$.getValue() === false) {\r\n      olDrawInteraction = new OlDraw({\r\n        type: this.geometryType,\r\n        source: this.getSource(),\r\n        stopClick: true,\r\n        style: this.options.drawStyle,\r\n        maxPoints: this.options.maxPoints,\r\n        freehand: false,\r\n        freehandCondition: () => false\r\n      });\r\n    } else {\r\n      if (this.geometryType === 'Point') {\r\n        olDrawInteraction = new OlDraw({\r\n          type: 'Circle',\r\n          source: this.getSource(),\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n      } else {\r\n        olDrawInteraction = new OlDraw({\r\n          type: this.geometryType,\r\n          source: this.getSource(),\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n      }\r\n    }\r\n\r\n    this.onDrawStartKey = olDrawInteraction\r\n      .on('drawstart', (event: OlDrawEvent) => this.onDrawStart(event));\r\n    this.onDrawEndKey = olDrawInteraction\r\n      .on('drawend', (event: OlDrawEvent) => this.onDrawEnd(event));\r\n    this.olMap.addInteraction(olDrawInteraction);\r\n    this.olDrawInteraction = olDrawInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the draw interaction\r\n   */\r\n  private removeOlDrawInteraction() {\r\n    if (this.olDrawInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.unsubscribeToKeyDown();\r\n    unByKey([\r\n      this.onDrawStartKey,\r\n      this.onDrawEndKey,\r\n      this.onDrawKey\r\n    ]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n    }\r\n    this.olDrawInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * When drawing starts, clear the overlay and start watching from changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.start$.next(olGeometry);\r\n    this.clearOlInnerOverlaySource();\r\n    this.onDrawKey = olGeometry.on('change', (olGeometryEvent: OlGeometryEvent) => {\r\n      this.mousePosition = getMousePositionFromOlGeometryEvent(olGeometryEvent);\r\n      this.changes$.next(olGeometryEvent.target);\r\n    });\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, update the geometry observable and start watching from changes\r\n   * @param event Draw end event\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    this.unsubscribeToKeyDown();\r\n    unByKey(this.onDrawKey);\r\n    this.end$.next(event.feature.getGeometry());\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key down to activate the draw control\r\n   */\r\n  private subscribeToKeyDown() {\r\n    this.unsubscribeToKeyDown();\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe((event: KeyboardEvent) => {\r\n      // On ESC key down, remove the last vertex\r\n      if (event.keyCode === 27) {\r\n        this.olDrawInteraction.removeLastPoint();\r\n        return;\r\n      }\r\n\r\n      // On space bar, pan to the current mouse position\r\n      if (event.keyCode === 32) {\r\n        this.olMap.getView().animate({\r\n          center: this.mousePosition,\r\n          duration: 0\r\n        });\r\n        return;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeToKeyDown() {\r\n    if (this.keyDown$$ !== undefined) {\r\n      this.keyDown$$.unsubscribe();\r\n      this.keyDown$$ = undefined;\r\n    }\r\n  }\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlStyle from 'ol/style';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport OlTranslate from 'ol/interaction/Translate';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlInteraction from 'ol/interaction/Interaction';\r\nimport OlDragBoxInteraction from 'ol/interaction/DragBox';\r\nimport { MapBrowserEvent as OlMapBrowserEvent } from 'ol/MapBrowserEvent';\r\nimport {\r\n  Geometry as OlGeometry,\r\n  GeometryEvent as OlGeometryEvent\r\n} from 'ol/geom/Geometry';\r\nimport { ModifyEvent as OlModifyEvent } from 'ol/interaction/Modify';\r\nimport { TranslateEvent as OlTranslateEvent } from 'ol/interaction/Translate';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subject, Subscription, fromEvent } from 'rxjs';\r\n\r\nimport {\r\n  addLinearRingToOlPolygon,\r\n  createDrawHoleInteractionStyle,\r\n  getMousePositionFromOlGeometryEvent\r\n} from '../geometry.utils';\r\n\r\nexport interface ModifyControlOptions {\r\n  source?: OlVectorSource;\r\n  layer?: OlVectorLayer;\r\n  layerStyle?: OlStyle | ((olfeature: OlFeature) => OlStyle);\r\n  drawStyle?: OlStyle | ((olfeature: OlFeature) => OlStyle);\r\n  modify?: boolean;\r\n  translate?: boolean;\r\n}\r\n\r\n/**\r\n * Control to modify geometries\r\n */\r\nexport class ModifyControl {\r\n\r\n  /**\r\n   * Modify start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Modify end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Geometry changes observable\r\n   */\r\n  public changes$: Subject<OlGeometry> = new Subject();\r\n\r\n  private olMap: OlMap;\r\n  private olOverlayLayer: OlVectorLayer;\r\n  public olModifyInteraction: OlModify;\r\n  private onModifyStartKey: string;\r\n  private onModifyEndKey: string;\r\n  private onModifyKey: string;\r\n  private olModifyInteractionIsActive: boolean = false;\r\n  private olTranslateInteraction: OlTranslate;\r\n  private onTranslateStartKey: string;\r\n  private onTranslateEndKey: string;\r\n  private onTranslateKey: string;\r\n  private olTranslateInteractionIsActive: boolean = false;\r\n  private olDrawInteraction: OlTranslate;\r\n  private onDrawStartKey: string;\r\n  private onDrawEndKey: string;\r\n  private onDrawKey: string;\r\n  private olDrawInteractionIsActive: boolean = false;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  private keyDown$$: Subscription;\r\n  private drawKeyUp$$: Subscription;\r\n  private drawKeyDown$$: Subscription;\r\n\r\n  private removedOlInteractions: OlInteraction[] = [];\r\n  private olLinearRingsLayer: OlVectorLayer;\r\n\r\n  // This is the geometry to test against when drawing holes\r\n  private olOuterGeometry: OlGeometry;\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * OL linear rings source\r\n   * @internal\r\n   */\r\n  get olLinearRingsSource(): OlVectorSource {\r\n    return this.olLinearRingsLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * Whether a modify control should be available\r\n   */\r\n  private modify: boolean = true;\r\n\r\n  /**\r\n   * Whether a translate control should be available\r\n   */\r\n  private translate: boolean = true;\r\n\r\n  constructor(private options: ModifyControlOptions) {\r\n    if (options.modify !== undefined) {\r\n      this.modify = options.modify;\r\n    }\r\n    if (options.translate !== undefined) {\r\n      this.translate = options.translate;\r\n    }\r\n\r\n    if (options.layer !== undefined) {\r\n      this.olOverlayLayer = options.layer;\r\n    } else {\r\n      this.olOverlayLayer = this.createOlInnerOverlayLayer();\r\n    }\r\n    this.olLinearRingsLayer = this.createOlLinearRingsLayer();\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap === undefined) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlModifyInteraction();\r\n      this.removeOlTranslateInteraction();\r\n      this.removeOlDrawInteraction();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n\r\n    // The order in which these interactions\r\n    // are added is important\r\n    if (this.modify === true) {\r\n      this.addOlDrawInteraction();\r\n    }\r\n\r\n    if (this.translate === true) {\r\n      this.addOlTranslateInteraction();\r\n      this.activateTranslateInteraction();\r\n    }\r\n\r\n    if (this.modify === true) {\r\n      this.addOlModifyInteraction();\r\n      this.activateModifyInteraction();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return the overlay source\r\n   */\r\n  getSource(): OlVectorSource {\r\n    return this.olOverlaySource;\r\n  }\r\n\r\n  /**\r\n   * Add an OL geometry to the overlay and start modifying it\r\n   * @param olGeometry Ol Geometry\r\n   */\r\n  setOlGeometry(olGeometry: OlGeometry) {\r\n    const olFeature = new OlFeature({geometry: olGeometry});\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer {\r\n    return new OlVectorLayer({\r\n      source: this.options.source ? this.options.source : new OlVectorSource(),\r\n      style: this.options.layerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer(): OlVectorLayer {\r\n    if (this.options.layer === undefined) {\r\n      this.olMap.addLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined && this.olMap !== undefined) {\r\n      this.olMap.removeLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (this.options.layer === undefined && this.options.source === undefined) {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n  }\r\n\r\n  private createOlLinearRingsLayer(): OlVectorLayer {\r\n    return new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      style: createDrawHoleInteractionStyle(),\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the linear rings layer\r\n   */\r\n  private addOlLinearRingsLayer() {\r\n    this.olMap.addLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings layer\r\n   */\r\n  private removeOlLinearRingsLayer() {\r\n    this.olMap.removeLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings source\r\n   */\r\n  private clearOlLinearRingsSource() {\r\n    this.olLinearRingsSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Add a modify interaction to the map an set up some listeners\r\n   */\r\n  private addOlModifyInteraction() {\r\n    const olModifyInteraction = new OlModify({\r\n      source: this.olOverlaySource,\r\n      style: this.options.drawStyle\r\n    });\r\n    this.olModifyInteraction = olModifyInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the modify interaction\r\n   */\r\n  private removeOlModifyInteraction() {\r\n    if (this.olModifyInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateModifyInteraction();\r\n    this.olModifyInteraction = undefined;\r\n  }\r\n\r\n  private activateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = true;\r\n    this.onModifyStartKey = this.olModifyInteraction\r\n      .on('modifystart', (event: OlModifyEvent) => this.onModifyStart(event));\r\n    this.onModifyEndKey = this.olModifyInteraction\r\n      .on('modifyend', (event: OlModifyEvent) => this.onModifyEnd(event));\r\n    this.olMap.addInteraction(this.olModifyInteraction);\r\n  }\r\n\r\n  private deactivateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = false;\r\n\r\n    unByKey([\r\n      this.onModifyStartKey,\r\n      this.onModifyEndKey,\r\n      this.onModifyKey\r\n    ]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olModifyInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When modifying starts, clear the overlay and start watching for changes\r\n   * @param event Modify start event\r\n   */\r\n  private onModifyStart(event: OlModifyEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry();\r\n    this.start$.next(olGeometry);\r\n    this.onModifyKey = olGeometry.on('change', (olGeometryEvent: OlGeometryEvent) => {\r\n      this.mousePosition = getMousePositionFromOlGeometryEvent(olGeometryEvent);\r\n      this.changes$.next(olGeometryEvent.target);\r\n    });\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When modifying ends, update the geometry observable and stop watching for changes\r\n   * @param event Modify end event\r\n   */\r\n  private onModifyEnd(event: OlModifyEvent) {\r\n    unByKey(this.onModifyKey);\r\n    this.end$.next(event.features.item(0).getGeometry());\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to space key down to pan the map\r\n   */\r\n  private subscribeToKeyDown() {\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe((event: KeyboardEvent) => {\r\n      if (event.keyCode === 32) {\r\n        // On space bar, pan to the current mouse position\r\n        this.olMap.getView().animate({\r\n          center: this.mousePosition,\r\n          duration: 0\r\n        });\r\n        return;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeToKeyDown() {\r\n    if (this.keyDown$$ !== undefined) {\r\n      this.keyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a translate interaction to the map an set up some listeners\r\n   */\r\n  private addOlTranslateInteraction() {\r\n    const olTranslateInteraction = new OlTranslate({\r\n      layers: [this.olOverlayLayer]\r\n    });\r\n    this.olTranslateInteraction = olTranslateInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the translate interaction\r\n   */\r\n  private removeOlTranslateInteraction() {\r\n    if (this.olTranslateInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateTranslateInteraction();\r\n    this.olTranslateInteraction = undefined;\r\n  }\r\n\r\n  private activateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = true;\r\n    this.onTranslateStartKey = this.olTranslateInteraction\r\n      .on('translatestart', (event: OlTranslateEvent) => this.onTranslateStart(event));\r\n    this.onTranslateEndKey = this.olTranslateInteraction\r\n      .on('translateend', (event: OlTranslateEvent) => this.onTranslateEnd(event));\r\n    this.olMap.addInteraction(this.olTranslateInteraction);\r\n  }\r\n\r\n  private deactivateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = false;\r\n    unByKey([\r\n      this.onTranslateStartKey,\r\n      this.onTranslateEndKey,\r\n      this.onTranslateKey\r\n    ]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olTranslateInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When translation starts, clear the overlay and start watching for changes\r\n   * @param event Translate start event\r\n   */\r\n  private onTranslateStart(event: OlTranslateEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry();\r\n    this.start$.next(olGeometry);\r\n    this.onTranslateKey = olGeometry.on('change', (olGeometryEvent: OlGeometryEvent) => {\r\n      this.changes$.next(olGeometryEvent.target);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Translate end event\r\n   */\r\n  private onTranslateEnd(event: OlTranslateEvent) {\r\n    unByKey(this.onTranslateKey);\r\n    this.end$.next(event.features.item(0).getGeometry());\r\n  }\r\n\r\n  /**\r\n   * Add a draw interaction to the map an set up some listeners\r\n   */\r\n  private addOlDrawInteraction() {\r\n    const olDrawInteraction = new OlDraw({\r\n      type: 'Polygon',\r\n      source: this.olLinearRingsSource,\r\n      stopClick: true,\r\n      style: createDrawHoleInteractionStyle(),\r\n      condition: (event: OlMapBrowserEvent) => {\r\n        const olOuterGeometry = this.olOuterGeometry || this.getOlGeometry();\r\n        const intersects = olOuterGeometry.intersectsCoordinate(event.coordinate);\r\n        return intersects;\r\n      }\r\n    });\r\n\r\n    this.olDrawInteraction = olDrawInteraction;\r\n    this.subscribeToDrawKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key down to activate the draw control\r\n   */\r\n  private subscribeToDrawKeyDown() {\r\n    this.drawKeyDown$$ = fromEvent(document, 'keydown').subscribe((event: KeyboardEvent) => {\r\n      if (event.keyCode !== 17) { return; }\r\n\r\n      this.unsubscribeToDrawKeyDown();\r\n\r\n      const olGeometry = this.getOlGeometry();\r\n      if (!olGeometry || !(olGeometry instanceof OlPolygon)) { return; }\r\n\r\n      this.subscribeToDrawKeyUp();\r\n\r\n      this.deactivateModifyInteraction();\r\n      this.deactivateTranslateInteraction();\r\n      this.activateDrawInteraction();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key up to deactivate the draw control\r\n   */\r\n  private subscribeToDrawKeyUp() {\r\n    this.drawKeyUp$$ = fromEvent(document, 'keyup')\r\n      .subscribe((event: KeyboardEvent) => {\r\n        if (event.keyCode !== 17) {\r\n          return;\r\n        }\r\n\r\n        this.unsubscribeToDrawKeyUp();\r\n        this.unsubscribeToKeyDown();\r\n        this.deactivateDrawInteraction();\r\n\r\n        this.activateModifyInteraction();\r\n        if (this.translate === true) {\r\n          this.activateTranslateInteraction();\r\n        }\r\n        this.subscribeToDrawKeyDown();\r\n\r\n        this.olOuterGeometry = undefined;\r\n        this.clearOlLinearRingsSource();\r\n        this.end$.next(this.getOlGeometry());\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to draw key down\r\n   */\r\n  private unsubscribeToDrawKeyDown() {\r\n    if (this.drawKeyDown$$ !== undefined) {\r\n      this.drawKeyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key up\r\n   */\r\n  private unsubscribeToDrawKeyUp() {\r\n    if (this.drawKeyUp$$ !== undefined) {\r\n      this.drawKeyUp$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the draw interaction\r\n   */\r\n  private removeOlDrawInteraction() {\r\n    if (this.olDrawInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.unsubscribeToKeyDown();\r\n    this.unsubscribeToDrawKeyUp();\r\n    this.unsubscribeToDrawKeyDown();\r\n    this.deactivateDrawInteraction();\r\n    this.clearOlLinearRingsSource();\r\n    this.olDrawInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * Activate the draw interaction\r\n   */\r\n  private activateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.clearOlLinearRingsSource();\r\n    this.addOlLinearRingsLayer();\r\n\r\n    this.olMap.getInteractions().forEach((olInteraction: OlInteraction) => {\r\n      if (olInteraction instanceof OlDragBoxInteraction) {\r\n        this.olMap.removeInteraction(olInteraction);\r\n        this.removedOlInteractions.push(olInteraction);\r\n      }\r\n    });\r\n\r\n    this.olDrawInteractionIsActive = true;\r\n    this.onDrawStartKey = this.olDrawInteraction\r\n      .on('drawstart', (event: OlDrawEvent) => this.onDrawStart(event));\r\n    this.onDrawEndKey = this.olDrawInteraction\r\n      .on('drawend', (event: OlDrawEvent) => this.onDrawEnd(event));\r\n    this.olMap.addInteraction(this.olDrawInteraction);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the draw interaction\r\n   */\r\n  private deactivateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.removeOlLinearRingsLayer();\r\n\r\n    this.removedOlInteractions.forEach((olInteraction: OlInteraction) => {\r\n      this.olMap.addInteraction(olInteraction);\r\n    });\r\n    this.removedOlInteractions = [];\r\n\r\n    this.olDrawInteractionIsActive = false;\r\n    unByKey([\r\n      this.onDrawStartKey,\r\n      this.onDrawEndKey,\r\n      this.onDrawKey\r\n    ]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When draw start, add a new linerar ring to the geometry and start watching for changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.olOuterGeometry = this.getOlGeometry().clone();\r\n\r\n    const linearRingCoordinates = olGeometry.getLinearRing().getCoordinates();\r\n    this.addLinearRingToOlGeometry(linearRingCoordinates);\r\n    this.start$.next(this.getOlGeometry());\r\n\r\n    this.onDrawKey = olGeometry.on('change', (olGeometryEvent: OlGeometryEvent) => {\r\n      this.mousePosition = getMousePositionFromOlGeometryEvent(olGeometryEvent);\r\n      const _linearRingCoordinates = olGeometryEvent.target.getLinearRing().getCoordinates();\r\n      this.updateLinearRingOfOlGeometry(_linearRingCoordinates);\r\n      this.changes$.next(this.getOlGeometry());\r\n    });\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Draw end event\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    unByKey(this.onDrawKey);\r\n    this.olOuterGeometry = undefined;\r\n\r\n    const linearRingCoordinates = event.feature.getGeometry().getLinearRing().getCoordinates();\r\n    this.updateLinearRingOfOlGeometry(linearRingCoordinates);\r\n    this.clearOlLinearRingsSource();\r\n    this.end$.next(this.getOlGeometry());\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Add a linear ring to the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private addLinearRingToOlGeometry(coordinates: number[]) {\r\n    const olGeometry = this.getOlGeometry();\r\n    const olLinearRing = new OlLinearRing(coordinates);\r\n    addLinearRingToOlPolygon(olGeometry, olLinearRing);\r\n  }\r\n\r\n  /**\r\n   * Update the last linear ring of the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private updateLinearRingOfOlGeometry(coordinates: number[]) {\r\n    const olGeometry = this.getOlGeometry();\r\n    // Remove the last linear ring (the one we are updating)\r\n    const olLinearRings = olGeometry.getLinearRings().slice(0, -1);\r\n    const newCoordinates = olLinearRings.map((olLinearRing: OlLinearRing) => {\r\n      return olLinearRing.getCoordinates();\r\n    });\r\n    newCoordinates.push(coordinates);\r\n    olGeometry.setCoordinates(newCoordinates);\r\n  }\r\n\r\n  /**\r\n   * Get the geometry being modified\r\n   * @returns OL Geometry\r\n   */\r\n  private getOlGeometry(): OlGeometry {\r\n    const olFeatures = this.olOverlaySource.getFeatures();\r\n    return olFeatures.length > 0 ? olFeatures[0].getGeometry() : undefined;\r\n  }\r\n\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlStyle from 'ol/style';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlGeometry from 'ol/geom/Geometry';\r\nimport OlLineString from 'ol/geom/LineString';\r\n\r\nimport { Subject, Subscription } from 'rxjs';\r\n\r\nimport { GeometrySliceError } from '../geometry.errors';\r\nimport { sliceOlGeometry } from '../geometry.utils';\r\nimport { DrawControl } from './draw';\r\n\r\nexport interface SliceControlOptions {\r\n  source?: OlVectorSource;\r\n  layer?: OlVectorLayer;\r\n  layerStyle?: OlStyle | ((olfeature: OlFeature) => OlStyle);\r\n  drawStyle?: OlStyle | ((olfeature: OlFeature) => OlStyle);\r\n}\r\n\r\n/**\r\n * Control to modify geometries\r\n */\r\nexport class SliceControl {\r\n\r\n  /**\r\n   * Slice end observable\r\n   */\r\n  public end$: Subject<OlGeometry[]> = new Subject();\r\n\r\n  /**\r\n   * Slice error, if any\r\n   */\r\n  public error$: Subject<GeometrySliceError> = new Subject();\r\n\r\n  private olMap: OlMap;\r\n  private olOverlayLayer: OlVectorLayer;\r\n\r\n  /**\r\n   * Draw line control\r\n   */\r\n  private drawLineControl: DrawControl;\r\n\r\n  /**\r\n   * Subscription to draw start\r\n   */\r\n  private drawLineStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to draw end\r\n   */\r\n  private drawLineEnd$$: Subscription;\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  constructor(private options: SliceControlOptions) {\r\n    if (options.layer !== undefined) {\r\n      this.olOverlayLayer = options.layer;\r\n    } else {\r\n      this.olOverlayLayer = this.createOlInnerOverlayLayer();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap === undefined) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeDrawLineControl();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n    this.addDrawLineControl();\r\n  }\r\n\r\n  /**\r\n   * Return the overlay source\r\n   */\r\n  getSource(): OlVectorSource {\r\n    return this.olOverlaySource;\r\n  }\r\n\r\n  /**\r\n   * Add an OL geometry to the overlay for slicing\r\n   * @param olGeometry Ol Geometry\r\n   */\r\n  setOlGeometry(olGeometry: OlGeometry) {\r\n    const olFeature = new OlFeature({geometry: olGeometry});\r\n    this.olOverlaySource.clear(true);\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer {\r\n    return new OlVectorLayer({\r\n      source: this.options.source ? this.options.source : new OlVectorSource(),\r\n      style: this.options.layerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined && this.olMap !== undefined) {\r\n      this.olMap.removeLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer(): OlVectorLayer {\r\n    if (this.options.layer === undefined) {\r\n      this.olMap.addLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (this.options.layer === undefined && this.options.source === undefined) {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a draw line control and add it to the map\r\n   */\r\n  private addDrawLineControl() {\r\n    this.drawLineControl = new DrawControl({\r\n      geometryType: 'LineString',\r\n      drawStyle: this.options.drawStyle,\r\n      maxPoints: 2\r\n    });\r\n    this.drawLineStart$$ = this.drawLineControl.start$\r\n      .subscribe((olLine: OlLineString) => this.onDrawLineStart(olLine));\r\n    this.drawLineEnd$$ = this.drawLineControl.end$\r\n      .subscribe((olLine: OlLineString) => this.onDrawLineEnd(olLine));\r\n    this.drawLineControl.setOlMap(this.olMap);\r\n  }\r\n\r\n  /**\r\n   * Remove draw line control\r\n   */\r\n  private removeDrawLineControl() {\r\n    if (this.drawLineControl === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.drawLineStart$$.unsubscribe();\r\n    this.drawLineEnd$$.unsubscribe();\r\n    this.drawLineControl.getSource().clear(true);\r\n    this.drawLineControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olLine Ol linestring or polygon\r\n   */\r\n  private onDrawLineStart(olLine: OlLineString) {\r\n    this.drawLineControl.getSource().clear(true);\r\n  }\r\n\r\n  /**\r\n   * Slice the first geometry encountered with the drawn line\r\n   * @param olLine Ol linestring\r\n   */\r\n  private onDrawLineEnd(olLine: OlLineString) {\r\n    const olSlicedGeometries = [];\r\n    const lineExtent = olLine.getExtent();\r\n\r\n    const olFeaturesToRemove = [];\r\n    try {\r\n      this.olOverlaySource.forEachFeatureInExtent(lineExtent, (olFeature: OlFeature) => {\r\n        const olGeometry = olFeature.getGeometry();\r\n        const olParts = sliceOlGeometry(olGeometry, olLine);\r\n        if (olParts.length > 0) {\r\n          olSlicedGeometries.push(...olParts);\r\n          olFeaturesToRemove.push(olFeature);\r\n        }\r\n      });\r\n    } catch (e) {\r\n      if (e instanceof GeometrySliceError) {\r\n        this.error$.next(e);\r\n        return;\r\n      } else {\r\n        throw e;\r\n      }\r\n    }\r\n\r\n    this.drawLineControl.getSource().clear(true);\r\n\r\n    this.olOverlaySource.addFeatures(\r\n      olSlicedGeometries.map((olGeometry: OlGeometry) => new OlFeature(olGeometry))\r\n    );\r\n    olFeaturesToRemove.forEach((olFeature: OlFeature) => {\r\n      this.olOverlaySource.removeFeature(olFeature);\r\n    });\r\n\r\n    this.error$.next(undefined);\r\n    this.end$.next(olSlicedGeometries);\r\n  }\r\n}\r\n","import { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material';\r\n\r\nimport { MeasurerDialogData } from '../shared/measure.interfaces';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit} from '../shared/measure.enum';\r\n\r\n@Component({\r\n  selector: 'igo-measurer-dialog',\r\n  templateUrl: 'measurer-dialog.component.html',\r\n  styleUrls: ['./measurer-dialog.component.scss']\r\n})\r\nexport class MeasurerDialogComponent {\r\n\r\n  measureAreaUnit = MeasureAreaUnit;\r\n\r\n  measureLengthUnit = MeasureLengthUnit;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<MeasurerDialogComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: MeasurerDialogData\r\n  ) {}\r\n\r\n  onNoClick(): void {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { MatDialog } from '@angular/material';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { skip } from 'rxjs/operators';\r\n\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport OlStyle from 'ol/style/Style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityRecord, EntityTableTemplate, EntityTableComponent } from '@igo2/common';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport {\r\n  FEATURE,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  tryBindStoreLayer,\r\n  tryAddLoadingStrategy,\r\n  tryAddSelectionStrategy\r\n} from '../../feature';\r\nimport { DrawControl, ModifyControl } from '../../geometry';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { Measure, MeasurerDialogData, FeatureWithMeasure } from '../shared/measure.interfaces';\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit,\r\n} from '../shared/measure.enum';\r\nimport {\r\n  measureOlGeometry,\r\n  createMeasureInteractionStyle,\r\n  createMeasureLayerStyle,\r\n  updateOlTooltipsAtMidpoints,\r\n  updateOlTooltipAtCenter,\r\n  getTooltipsOfOlGeometry,\r\n  squareMetersToUnit,\r\n  metersToUnit,\r\n  formatMeasure\r\n} from '../shared/measure.utils';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * Tool to measure lengths and areas\r\n */\r\n@Component({\r\n  selector: 'igo-measurer',\r\n  templateUrl: './measurer.component.html',\r\n  styleUrls: ['./measurer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Table template\r\n   * @internal\r\n   */\r\n  public tableTemplate: EntityTableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    selectionCheckbox: true,\r\n    sort: true,\r\n    columns: [\r\n      {\r\n        name: 'length',\r\n        title: this.languageService.translate.instant('igo.geo.measure.lengthHeader'),\r\n        valueAccessor: (feature: FeatureWithMeasure) => {\r\n          const unit = this.activeLengthUnit;\r\n          const measure = metersToUnit(feature.properties.measure.length, unit);\r\n          return formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          });\r\n        }\r\n      },\r\n      {\r\n        name: 'area',\r\n        title: this.languageService.translate.instant('igo.geo.measure.areaHeader'),\r\n        valueAccessor: (feature: FeatureWithMeasure) => {\r\n          const unit = this.activeAreaUnit;\r\n          const measure = squareMetersToUnit(feature.properties.measure.area, unit);\r\n          return measure ? formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          }) : '';\r\n        }\r\n      }\r\n    ]\r\n  };\r\n\r\n  /**\r\n   * Reference to the MeasureType enum\r\n   * @internal\r\n   */\r\n  public measureType = MeasureType;\r\n\r\n  /**\r\n   * Reference to the AreaMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureAreaUnit = MeasureAreaUnit;\r\n\r\n  /**\r\n   * Reference to the LengthMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureLengthUnit = MeasureLengthUnit;\r\n\r\n  /**\r\n   * Whether measure units should be automatically determined\r\n   * @internal\r\n   */\r\n  public measureUnitsAuto: boolean = false;\r\n\r\n  /**\r\n   * Observable of area\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<Measure> = new BehaviorSubject({});\r\n\r\n  /**\r\n   * Observable of selected features\r\n   * @internal\r\n   */\r\n  public selectedFeatures$: BehaviorSubject<FeatureWithMeasure[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * OL draw source\r\n   * @internal\r\n   */\r\n  public showTooltips: boolean = true;\r\n\r\n  /**\r\n   * Draw line control\r\n   */\r\n  private drawLineControl: DrawControl;\r\n\r\n  /**\r\n   * Draw polygon control\r\n   */\r\n  private drawPolygonControl: DrawControl;\r\n\r\n  /**\r\n   * Modify control\r\n   */\r\n  private modifyControl: ModifyControl;\r\n\r\n  /**\r\n   * Active OL geometry\r\n   */\r\n  private activeOlGeometry: OlLineString | OlPolygon;\r\n\r\n  /**\r\n   * Active mlength unit\r\n   */\r\n  private activeLengthUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  /**\r\n   * Active area unit\r\n   */\r\n  private activeAreaUnit: MeasureAreaUnit = MeasureAreaUnit.SquareMeters;\r\n\r\n  /**\r\n   * Feature added listener key\r\n   */\r\n  private onFeatureAddedKey: string;\r\n\r\n  /**\r\n   * Feature removed listener key\r\n   */\r\n  private onFeatureRemovedKey: string;\r\n\r\n  /**\r\n   * Active draw control\r\n   * @internal\r\n   */\r\n  private activeDrawControl: DrawControl;\r\n\r\n  /**\r\n   * Subscription to draw start\r\n   */\r\n  private drawStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to draw end\r\n   */\r\n  private drawEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private drawChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify start\r\n   */\r\n  private modifyStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify end\r\n   */\r\n  private modifyEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private modifyChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to measures selection\r\n   */\r\n  private selectedFeatures$$: Subscription;\r\n\r\n  /**\r\n   * OL draw source\r\n   */\r\n  private olDrawSource = new OlVectorSource();\r\n\r\n  /**\r\n   * The map to measure on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The measures store\r\n   */\r\n  @Input() store: FeatureStore<FeatureWithMeasure>;\r\n\r\n  /**\r\n   * Measure type\r\n   * @internal\r\n   */\r\n  @Input()\r\n  set activeMeasureType(value: MeasureType) { this.setActiveMeasureType(value); }\r\n  get activeMeasureType(): MeasureType { return this._activeMeasureType; }\r\n  private _activeMeasureType: MeasureType = MeasureType.Length;\r\n\r\n  /**\r\n   * The minimum length a segment must have to display a tooltip.\r\n   * It also applies to area tooltips.\r\n   */\r\n  @Input() minSegmentLength: number = 10;\r\n\r\n  @ViewChild('table') table: EntityTableComponent;\r\n\r\n  /**\r\n   * Wheter one of the draw control is active\r\n   * @internal\r\n   */\r\n  get drawControlIsActive(): boolean {\r\n    return this.activeDrawControl !== undefined;\r\n  }\r\n\r\n  get projection(): OlProjection {\r\n    return this.map.ol.getView().getProjection();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dialog: MatDialog\r\n  ) {}\r\n\r\n  /**\r\n   * Add draw controls and activate one\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.initStore();\r\n    this.createDrawLineControl();\r\n    this.createDrawPolygonControl();\r\n    this.createModifyControl();\r\n    this.toggleDrawControl();\r\n    this.onToggleTooltips(this.showTooltips);\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.setActiveMeasureType(undefined);\r\n    this.deactivateModifyControl();\r\n    this.freezeStore();\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onMeasureTypeChange(measureType: MeasureType) {\r\n    this.activeMeasureType = measureType;\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n  onToggleDrawControl(toggle: boolean) {\r\n    if (toggle === true) {\r\n      this.toggleDrawControl();\r\n    } else {\r\n      this.deactivateDrawControl();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n  onToggleTooltips(toggle: boolean) {\r\n    this.showTooltips = toggle;\r\n    if (toggle === true) {\r\n      this.showTooltipsOfOlSource(this.store.source.ol);\r\n    } else {\r\n      this.clearTooltipsOfOlSource(this.store.source.ol);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n  onToggleMeasureUnitsAuto(toggle: boolean) {\r\n    this.measureUnitsAuto = toggle;\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onLengthUnitChange(unit: MeasureLengthUnit) {\r\n    this.activeLengthUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onAreaUnitChange(unit: MeasureAreaUnit) {\r\n    this.activeAreaUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  onCalculateClick() {\r\n    const features = this.selectedFeatures$.value;\r\n    const area = features.reduce((sum: number, feature: FeatureWithMeasure) => {\r\n      return sum + feature.properties.measure.area || 0;\r\n    }, 0);\r\n    const length = features.reduce((sum: number, feature: FeatureWithMeasure) => {\r\n      if (feature.geometry.type === 'Polygon') {\r\n        return sum;\r\n      }\r\n      return sum + feature.properties.measure.length || 0;\r\n    }, 0);\r\n    const perimeter = features.reduce((sum: number, feature: FeatureWithMeasure) => {\r\n      if (feature.geometry.type === 'LineString') {\r\n        return sum;\r\n      }\r\n      return sum + feature.properties.measure.length || 0;\r\n    }, 0);\r\n\r\n    this.openDialog({\r\n      area,\r\n      length,\r\n      perimeter\r\n    });\r\n  }\r\n\r\n  onDeleteClick() {\r\n    this.store.deleteMany(this.selectedFeatures$.value);\r\n  }\r\n\r\n  onModifyClick() {\r\n    if (this.selectedFeatures$.value.length !== 1) { return; }\r\n\r\n    if (this.modifyControl.active === true) {\r\n      this.deactivateModifyControl();\r\n      this.toggleDrawControl();\r\n    } else {\r\n      const feature = this.selectedFeatures$.value[0];\r\n      const olFeatures = this.store.layer.ol.getSource().getFeatures();\r\n      const olFeature = olFeatures.find((_olFeature: OlFeature) => {\r\n        return _olFeature.get('id') === feature.properties.id;\r\n      });\r\n\r\n      if (olFeature !== undefined) {\r\n        this.deactivateDrawControl();\r\n        this.activateModifyControl();\r\n\r\n        const olGeometry = olFeature.getGeometry();\r\n        this.clearTooltipsOfOlGeometry(olGeometry);\r\n        this.modifyControl.setOlGeometry(olGeometry);\r\n      }\r\n    }\r\n  }\r\n\r\n  private openDialog(data: MeasurerDialogData): void {\r\n    this.dialog.open(MeasurerDialogComponent, {data});\r\n  }\r\n\r\n  /**\r\n   * Initialize the measure store and set up some listeners\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      title: 'Measures',\r\n      zIndex: 200,\r\n      source: new FeatureDataSource(),\r\n      style: createMeasureLayerStyle(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n\r\n    tryAddLoadingStrategy(store);\r\n\r\n    tryAddSelectionStrategy(store, new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      many: true\r\n    }));\r\n\r\n    this.onFeatureAddedKey = store.source.ol.on('addfeature', (event: OlVectorSourceEvent) => {\r\n      const feature = event.feature;\r\n      const olGeometry = feature.getGeometry();\r\n      this.updateMeasureOfOlGeometry(olGeometry, feature.get('measure'));\r\n    });\r\n\r\n    this.onFeatureRemovedKey = store.source.ol.on('removefeature', (event: OlVectorSourceEvent) => {\r\n      const olGeometry = event.feature.getGeometry();\r\n      this.clearTooltipsOfOlGeometry(olGeometry);\r\n    });\r\n\r\n    this.selectedFeatures$$ = store.stateView.manyBy$((record: EntityRecord<FeatureWithMeasure>) => {\r\n      return record.state.selected === true;\r\n    }).pipe(\r\n      skip(1)  // Skip initial emission\r\n    )\r\n    .subscribe((records: EntityRecord<FeatureWithMeasure>[]) => {\r\n      if (this.modifyControl.active === true) {\r\n        this.deactivateModifyControl();\r\n      }\r\n      this.selectedFeatures$.next(records.map(record => record.entity));\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Freeze any store, meaning the layer is removed, strategies are deactivated\r\n   * and some listener removed\r\n   * @internal\r\n   */\r\n  private freezeStore() {\r\n    const store = this.store;\r\n    this.selectedFeatures$$.unsubscribe();\r\n    unByKey(this.onFeatureAddedKey);\r\n    unByKey(this.onFeatureRemovedKey);\r\n    this.clearTooltipsOfOlSource(store.source.ol);\r\n    this.map.removeLayer(store.layer);\r\n    store.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    store.deactivateStrategyOfType(FeatureStoreSelectionStrategy);\r\n  }\r\n\r\n  /**\r\n   * Create a draw line control\r\n   */\r\n  private createDrawLineControl() {\r\n    this.drawLineControl = new DrawControl({\r\n      geometryType: 'LineString',\r\n      source: this.olDrawSource,\r\n      drawStyle: createMeasureInteractionStyle(),\r\n      layerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createDrawPolygonControl() {\r\n    this.drawPolygonControl = new DrawControl({\r\n      geometryType: 'Polygon',\r\n      source: this.olDrawSource,\r\n      drawStyle: createMeasureInteractionStyle(),\r\n      layerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createModifyControl() {\r\n    this.modifyControl = new ModifyControl({\r\n      source: this.olDrawSource,\r\n      drawStyle: createMeasureInteractionStyle(),\r\n      layerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Activate the right control\r\n   */\r\n  private toggleDrawControl() {\r\n    this.deactivateDrawControl();\r\n    // this.deactivateModifyControl();\r\n    if (this.activeMeasureType === MeasureType.Length) {\r\n      this.activateDrawControl(this.drawLineControl);\r\n    } else if (this.activeMeasureType === MeasureType.Area) {\r\n      this.activateDrawControl(this.drawPolygonControl);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param drawControl Draw control\r\n   */\r\n  private activateDrawControl(drawControl: DrawControl) {\r\n    this.activeDrawControl = drawControl;\r\n    this.drawStart$$ = drawControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawStart(olGeometry));\r\n    this.drawEnd$$ = drawControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawEnd(olGeometry));\r\n    this.drawChanges$$ = drawControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawChanges(olGeometry));\r\n\r\n    drawControl.setOlMap(this.map.ol);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  private deactivateDrawControl() {\r\n    if (this.activeDrawControl === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n    if (this.drawStart$$ !== undefined ) { this.drawStart$$.unsubscribe(); }\r\n    if (this.drawEnd$$ !== undefined ) { this.drawEnd$$.unsubscribe(); }\r\n    if (this.drawChanges$$ !== undefined ) { this.drawChanges$$.unsubscribe(); }\r\n\r\n    this.clearTooltipsOfOlSource(this.olDrawSource);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.clearTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n    this.activeDrawControl.setOlMap(undefined);\r\n    this.activeDrawControl = undefined;\r\n    this.activeOlGeometry = undefined;\r\n  }\r\n\r\n  private setActiveMeasureType(measureType: MeasureType) {\r\n    this._activeMeasureType = measureType;\r\n    this.clearMeasures();\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = undefined;\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n    this.addFeatureToStore(olGeometry);\r\n    this.clearTooltipsOfOlGeometry(olGeometry);\r\n    this.olDrawSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawChanges(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = measureOlGeometry(olGeometry, this.projection);\r\n    this.updateMeasureOfOlGeometry(olGeometry, Object.assign({}, measure, {\r\n      area: undefined  // We don't want to display an area tooltip while drawing.\r\n    }));\r\n    this.measure$.next(measure);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param modifyControl Modify control\r\n   */\r\n  private activateModifyControl() {\r\n    const selection = this.store.getStrategyOfType(FeatureStoreSelectionStrategy) as FeatureStoreSelectionStrategy;\r\n    selection.deactivate();\r\n    selection.clear();\r\n\r\n    this.modifyStart$$ = this.modifyControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyStart(olGeometry));\r\n    this.modifyEnd$$ = this.modifyControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyEnd(olGeometry));\r\n    this.modifyChanges$$ = this.modifyControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyChanges(olGeometry));\r\n    this.modifyControl.setOlMap(this.map.ol);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active modify control\r\n   */\r\n  private deactivateModifyControl() {\r\n    if (this.modifyStart$$ !== undefined ) { this.modifyStart$$.unsubscribe(); }\r\n    if (this.modifyEnd$$ !== undefined ) { this.modifyEnd$$.unsubscribe(); }\r\n    if (this.modifyChanges$$ !== undefined ) { this.modifyChanges$$.unsubscribe(); }\r\n\r\n    if (this.activeOlGeometry !== undefined) {\r\n      if (this.selectedFeatures$.value.length === 1) {\r\n        const feature = this.selectedFeatures$.value[0];\r\n        this.addFeatureToStore(this.activeOlGeometry, feature);\r\n      }\r\n      this.finalizeMeasureOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n\r\n    this.store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n\r\n    this.activeOlGeometry = undefined;\r\n    this.modifyControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawStart(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyChanges(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawChanges(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  private finalizeMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    let measure = measureOlGeometry(olGeometry, this.projection);\r\n    if (olGeometry instanceof OlPolygon) {\r\n      measure = Object.assign({}, measure, {\r\n        lengths: []  // We don't want to display an area tooltip while drawing.\r\n      });\r\n    }\r\n    this.updateMeasureOfOlGeometry(olGeometry, measure);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables\r\n   * @param olGeometry Ol linestring or polygon\r\n   * @param measure Measure\r\n   */\r\n  private updateMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon, measure: Measure) {\r\n    olGeometry.setProperties({_measure: measure}, true);\r\n    this.updateTooltipsOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the measures observables\r\n   */\r\n  private clearMeasures() {\r\n    this.measure$.next({});\r\n  }\r\n\r\n  /**\r\n   * Add a feature with measures to the store. The loading stragegy of the store\r\n   * will trigger and add the feature to the map.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(olGeometry: OlLineString | OlPolygon, feature?: FeatureWithMeasure) {\r\n    const featureId = feature ? feature.properties.id : uuid();\r\n    const projection = this.map.ol.getView().getProjection();\r\n    const geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n      featureProjection: projection,\r\n      dataProjection: projection\r\n    });\r\n    this.store.update({\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: projection.getCode(),\r\n      properties: {\r\n        id: featureId,\r\n        measure: olGeometry.get('_measure')\r\n      },\r\n      meta: {\r\n        id: featureId\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update all the tooltips of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   * @param lengths Lengths of the OL geometry's segments\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = olGeometry.get('_measure');\r\n    const lengths = measure.lengths;\r\n    const area = measure.area;\r\n\r\n    const olMidpointsTooltips = updateOlTooltipsAtMidpoints(olGeometry);\r\n    if (lengths.length === olMidpointsTooltips.length) {\r\n      for (let i = 0; i < olMidpointsTooltips.length; i++) {\r\n        const length = lengths[i];\r\n        if (length !== undefined) {\r\n          this.updateOlTooltip(\r\n            olMidpointsTooltips[i],\r\n            metersToUnit(length, this.activeLengthUnit),\r\n            this.activeLengthUnit,\r\n            MeasureType.Length\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    if (area !== undefined) {\r\n      this.updateOlTooltip(\r\n        updateOlTooltipAtCenter(olGeometry),\r\n        squareMetersToUnit(area,  this.activeAreaUnit),\r\n        this.activeAreaUnit,\r\n        MeasureType.Area\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of a geoemtry\r\n   */\r\n  private showTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (this.shouldShowTooltip(olTooltip)) {\r\n        this.map.ol.addOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the tooltips of an OL geometrys\r\n   * @param olGeometry OL geometry with tooltips\r\n   */\r\n  private clearTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (olTooltip !== undefined && olTooltip.getMap() !== undefined) {\r\n        this.map.ol.removeOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private updateTooltipsOfOlSource(olSource: OlVectorSource) {\r\n    olSource.forEachFeature((olFeature: OlFeature) => {\r\n      this.updateTooltipsOfOlGeometry(olFeature.getGeometry());\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private showTooltipsOfOlSource(olSource: OlVectorSource) {\r\n    olSource.forEachFeature((olFeature: OlFeature) => {\r\n      this.showTooltipsOfOlGeometry(olFeature.getGeometry());\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the map tooltips\r\n   * @param olDrawSource OL vector source\r\n   */\r\n  private clearTooltipsOfOlSource(olSource: OlVectorSource) {\r\n    olSource.forEachFeature((olFeature: OlFeature) => {\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry !== undefined) {\r\n        this.clearTooltipsOfOlGeometry(olFeature.getGeometry());\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update an OL tooltip properties and inner HTML and add it to the map if possible\r\n   * @param olTooltip OL tooltip\r\n   * @param measure The measure valeu ti display\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateOlTooltip(\r\n    olTooltip: OlOverlay,\r\n    measure: number,\r\n    unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    type: MeasureType\r\n  ) {\r\n    olTooltip.setProperties({_measure: measure, _unit: unit, _type: type}, true);\r\n    olTooltip.getElement().innerHTML = this.computeTooltipInnerHTML(olTooltip);\r\n    if (this.shouldShowTooltip(olTooltip)) {\r\n      this.map.ol.addOverlay(olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Compute a tooltip's content\r\n   * @param olTooltip OL overlay\r\n   * @returns Inner HTML\r\n   */\r\n  private computeTooltipInnerHTML(olTooltip: OlOverlay): string {\r\n    const properties = olTooltip.getProperties() as any;\r\n    return formatMeasure(properties._measure, {\r\n      decimal: 1,\r\n      unit: properties._unit,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    }, this.languageService);\r\n  }\r\n\r\n  /**\r\n   * Whether a tooltip should be showned based on the length\r\n   * of the segment it is bound to.\r\n   * @param olTooltip OL overlay\r\n   * @returns True if the tooltip should be shown\r\n   */\r\n  private shouldShowTooltip(olTooltip: OlOverlay): boolean {\r\n    if (this.showTooltips === false) {\r\n      return false;\r\n    }\r\n\r\n    const properties = olTooltip.getProperties() as any;\r\n    const measure = properties._measure;\r\n    if (measure === undefined) {\r\n      return false;\r\n    }\r\n\r\n    if (properties._unit === MeasureType.Length) {\r\n      const minSegmentLength = metersToUnit(this.minSegmentLength, properties._unit) || 0;\r\n      return measure > Math.max(minSegmentLength, 0);\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit } from '../shared/measure.enum';\r\nimport { metersToUnit, squareMetersToUnit, formatMeasure } from '../shared/measure.utils';\r\n\r\n/**\r\n * This pipe returns a measure converted from meters (or square meters)\r\n * to the specified unit. It also keeps a certain number of decimals.\r\n */\r\n@Pipe({\r\n  name: 'measureFormat'\r\n})\r\nexport class MeasureFormatPipe implements PipeTransform {\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  transform(\r\n    value: number, unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    unitAbbr: boolean = false,\r\n    decimal: number = 1\r\n  ): number {\r\n    let out;\r\n    if (Object.values(MeasureAreaUnit).indexOf(unit) >= 0) {\r\n      out = squareMetersToUnit(value, unit as MeasureAreaUnit);\r\n    } else if (Object.values(MeasureLengthUnit).indexOf(unit) >= 0) {\r\n      out = metersToUnit(value, unit as MeasureLengthUnit);\r\n    }\r\n\r\n    return out ? formatMeasure(out, {\r\n      decimal: 1,\r\n      unit,\r\n      unitAbbr,\r\n      locale: 'fr'\r\n    }) : out;\r\n  }\r\n}\r\n","import { OlModify } from 'ol/interaction/Modify';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  Optional,\r\n  Self,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy,\r\n  EventEmitter,\r\n  Output\r\n} from '@angular/core';\r\nimport { NgControl, ControlValueAccessor } from '@angular/forms';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlGeometry from 'ol/geom/Geometry';\r\nimport OlGeometryType from 'ol/geom/GeometryType';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport * as poly from 'ol/geom/Polygon';\r\nimport * as olproj from 'ol/proj';\r\nimport Point from 'ol/geom/Point';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport {\r\n  MeasureLengthUnit,\r\n  updateOlGeometryMidpoints,\r\n  formatMeasure,\r\n  measureOlGeometry\r\n} from '../../measure';\r\nimport { DrawControl, ModifyControl } from '../shared/controls';\r\nimport { createDrawInteractionStyle } from '../shared/geometry.utils';\r\nimport { GeoJSONGeometry } from '../shared/geometry.interfaces';\r\n\r\n/**\r\n * This input allows a user to draw a new geometry or to edit\r\n * an existing one on a map. A text input is also displayed in the\r\n * form with some instructions.\r\n * This is still WIP.\r\n */\r\n@Component({\r\n  selector: 'igo-geometry-form-field-input',\r\n  templateUrl: './geometry-form-field-input.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class GeometryFormFieldInputComponent implements OnInit, OnDestroy, ControlValueAccessor {\r\n\r\n  private olOverlayLayer: OlVectorLayer;\r\n  private olGeoJSON = new OlGeoJSON();\r\n  private ready = false;\r\n\r\n  private drawControl: DrawControl;\r\n  private modifyControl: ModifyControl;\r\n  private defaultDrawStyleRadius: number;\r\n  private olGeometryEnds$$: Subscription;\r\n  private olGeometryChanges$$: Subscription;\r\n  private olTooltip = OlOverlay;\r\n\r\n  /**\r\n   * Active control\r\n   * @internal\r\n   */\r\n  public activeControl: DrawControl | ModifyControl;\r\n\r\n  /**\r\n   * The map to draw the geometry on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The geometry type\r\n   */\r\n  @Input()\r\n  set geometryType(value: OlGeometryType) {\r\n    this._geometryType = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get geometryType(): OlGeometryType { return this._geometryType; }\r\n  private _geometryType: OlGeometryType;\r\n\r\n  /**\r\n   * The drawGuide around the mouse pointer to help drawing\r\n   */\r\n  @Input() drawGuide: number = null;\r\n\r\n  /**\r\n   * Whether a measure tooltip should be displayed\r\n   */\r\n  @Input() measure: boolean = false;\r\n\r\n  /**\r\n   * Whether draw control should be active or not\r\n   */\r\n  @Input()\r\n  get drawControlIsActive(): boolean { return this._drawControlIsActive; }\r\n  set drawControlIsActive(value: boolean) {\r\n    this._drawControlIsActive = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    this.deactivateControl();\r\n    if (!this._drawControlIsActive) {\r\n      return;\r\n    } else {\r\n      this.toggleControl();\r\n    }\r\n  }\r\n  private _drawControlIsActive: boolean = true;\r\n\r\n  /**\r\n   * Whether freehand draw control should be active or not\r\n   */\r\n  @Input()\r\n  get freehandDrawIsActive(): boolean { return this._freehandDrawIsActive; }\r\n  set freehandDrawIsActive(value: boolean) {\r\n    this._freehandDrawIsActive = value;\r\n    this.deactivateControl();\r\n\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (!this.drawControlIsActive) {\r\n      return;\r\n    }\r\n    this.toggleControl();\r\n  }\r\n  private _freehandDrawIsActive: boolean;\r\n\r\n  /**\r\n   * Control options\r\n   */\r\n  @Input() controlOptions: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Style for the draw control (applies while the geometry is being drawn)\r\n   */\r\n  @Input()\r\n  set drawStyle(value: OlStyle) {\r\n    if (value === undefined) {\r\n      value = createDrawInteractionStyle();\r\n    }\r\n    this._drawStyle = value;\r\n\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(value);\r\n    if (olGuideStyle !== undefined) {\r\n      this.defaultDrawStyleRadius = olGuideStyle.getImage().getRadius();\r\n    } else {\r\n      this.defaultDrawStyleRadius = null;\r\n    }\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get drawStyle(): OlStyle { return this._drawStyle; }\r\n  private _drawStyle: OlStyle;\r\n\r\n  /**\r\n   * Style for the overlay layer (applies once the geometry is added to the map)\r\n   * If not specified, drawStyle applies\r\n   */\r\n  @Input()\r\n  set overlayStyle(value: OlStyle) { this._overlayStyle = value; }\r\n  get overlayStyle(): OlStyle { return this._overlayStyle; }\r\n  private _overlayStyle: OlStyle;\r\n\r\n  /**\r\n   * The geometry value (GeoJSON)\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  @Input()\r\n  set value(value: GeoJSONGeometry) {\r\n    this._value = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (value) {\r\n      this.addGeoJSONToOverlay(value);\r\n    } else {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n    this.onChange(value);\r\n    this.toggleControl();\r\n    this.cdRef.detectChanges();\r\n  }\r\n  get value(): GeoJSONGeometry { return this._value; }\r\n  private _value: GeoJSONGeometry;\r\n\r\n  /**\r\n   * The vector source to add the geometry to\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  @Input()\r\n  set radius(value: any) {\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    if (this.modifyControl.getSource()) {\r\n      this.modifyControl.getSource().refresh();\r\n    }\r\n    if (this.freehandDrawIsActive) {\r\n      let olModify;\r\n      setTimeout(() => {\r\n        olModify = this.modifyControl.olModifyInteraction;\r\n        if (olModify) {\r\n          if (olModify.features_) {\r\n            olModify.features_.clear();\r\n          }\r\n        }\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    @Optional() @Self() public ngControl: NgControl\r\n  ) {\r\n    if (this.ngControl !== undefined) {\r\n      // Setting the value accessor directly (instead of using\r\n      // the providers) to avoid running into a circular import.\r\n      this.ngControl.valueAccessor = this;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create an overlay layer, add the initial geometry to it (if any)\r\n   * and toggle the right interaction.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    if (this.drawStyle === undefined) {\r\n      this.drawStyle = createDrawInteractionStyle();\r\n    }\r\n\r\n    if (this.overlayStyle === undefined) {\r\n      this.overlayStyle = this.drawStyle;\r\n    }\r\n\r\n    this.addOlOverlayLayer();\r\n    this.createMeasureTooltip();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    if (this.value) {\r\n      this.addGeoJSONToOverlay(this.value);\r\n    }\r\n    this.toggleControl();\r\n\r\n    this.ready = true;\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    // This is mandatory when the form control is reused after\r\n    // this component has been destroyed. It seems like the control\r\n    // keeps a reference to this component even after it's destroyed\r\n    // and it attempts to set it's value\r\n    this.ready = false;\r\n\r\n    this.deactivateControl();\r\n    this.olOverlaySource.clear();\r\n    this.map.ol.removeLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // tslint:disable-next-line:ban-types\r\n  registerOnChange(fn: Function) {\r\n    this.onChange = fn;\r\n  }\r\n  private onChange: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // tslint:disable-next-line:ban-types\r\n  registerOnTouched(fn: Function) {\r\n    this.onTouched = fn;\r\n  }\r\n  private onTouched: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  writeValue(value: GeoJSONGeometry) {\r\n    this.value = value;\r\n  }\r\n\r\n  /**\r\n   * Add an overlay layer to the map\r\n   */\r\n  private addOlOverlayLayer(): OlVectorLayer {\r\n    this.olOverlayLayer = new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      zIndex: 500,\r\n      style: null\r\n    });\r\n    this.map.ol.addLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create a draw control and subscribe to it's geometry\r\n   */\r\n  private createDrawControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      geometryType: this.geometryType || 'Point',\r\n      layer: this.olOverlayLayer,\r\n      drawStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    });\r\n    this.drawControl = new DrawControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Create a modify control and subscribe to it's geometry\r\n   */\r\n  private createModifyControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      layer: this.olOverlayLayer,\r\n      drawStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    });\r\n    this.modifyControl = new ModifyControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Toggle the proper control (draw or modify)\r\n   */\r\n  private toggleControl() {\r\n    let activate;\r\n    if (!this.value && this.geometryType) {\r\n      activate = this.drawControl;\r\n    } else {\r\n      activate = this.modifyControl;\r\n    }\r\n\r\n    // If the control that should be activated\r\n    // is not the same as the current active control,\r\n    // deactivate the current control and activate the new one\r\n    // Otherwise, do nothing and keep the current control active\r\n    if (activate !== this.activeControl) {\r\n      this.deactivateControl();\r\n      this.activateControl(activate);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param control Control\r\n   */\r\n  private activateControl(control: DrawControl | ModifyControl) {\r\n    this.activeControl = control;\r\n    this.olGeometryEnds$$ = control.end$\r\n      .subscribe((olGeometry: OlGeometry) => this.onOlGeometryEnds(olGeometry));\r\n    if (this.measure === true && control === this.drawControl) {\r\n      this.olGeometryChanges$$ = control.changes$\r\n        .subscribe((olGeometry: OlGeometry) => this.onOlGeometryChanges(olGeometry));\r\n    }\r\n    control.setOlMap(this.map.ol);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active control\r\n   */\r\n  private deactivateControl() {\r\n    this.removeMeasureTooltip();\r\n    if (this.activeControl !== undefined) {\r\n      this.activeControl.setOlMap(undefined);\r\n    }\r\n    if (this.olGeometryEnds$$ !== undefined) {\r\n      this.olGeometryEnds$$.unsubscribe();\r\n    }\r\n    if (this.olGeometryChanges$$ !== undefined) {\r\n      this.olGeometryChanges$$.unsubscribe();\r\n    }\r\n    this.activeControl = undefined;\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryEnds(olGeometry: OlGeometry | undefined) {\r\n    this.removeMeasureTooltip();\r\n    this.setOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryChanges(olGeometry: OlGeometry) {\r\n    if (olGeometry.getType() !== 'Point') {\r\n      this.updateMeasureTooltip(olGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, convert the output value to GeoJSON and keep it.\r\n   * Restore the double click interaction.\r\n   * @param olGeometry OL geometry\r\n   */\r\n  private setOlGeometry(olGeometry: OlGeometry | undefined) {\r\n    let value;\r\n    if (olGeometry === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (olGeometry.getType() === 'Circle') { // Because Circle doesn't exist as a GeoJSON object\r\n      olGeometry = this.circleToPoint(olGeometry);\r\n    }\r\n\r\n    value = this.olGeoJSON.writeGeometryObject(olGeometry, {\r\n      featureProjection: this.map.projection,\r\n      dataProjection: 'EPSG:4326'\r\n    });\r\n    if (olGeometry.get('radius')) {\r\n      value.radius = olGeometry.get('radius');\r\n      olGeometry._radius = value.radius;\r\n    }\r\n    this.writeValue(value);\r\n  }\r\n\r\n  private circleToPoint(olGeometry) {\r\n    const center = olGeometry.getCenter();\r\n    const coordinates = olproj.transform(center, this.map.projection, 'EPSG:4326');\r\n    const radius = Math.round(olGeometry.getRadius() * (Math.cos((Math.PI / 180) * coordinates[1])));\r\n\r\n    // Convert it to a point object\r\n    olGeometry = new Point(center);\r\n    olGeometry.set('radius', radius, true);\r\n    return olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Add a GeoJSON geometry to the overlay\r\n   * @param geometry GeoJSON geometry\r\n   */\r\n  private addGeoJSONToOverlay(geometry: GeoJSONGeometry) {\r\n    const olGeometry = this.olGeoJSON.readGeometry(geometry, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: this.map.projection\r\n    });\r\n    const olFeature = new OlFeature({\r\n      geometry: olGeometry\r\n    });\r\n    olFeature.setStyle(this.overlayStyle);\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create the measure tooltip\r\n   */\r\n  private createMeasureTooltip(): OlOverlay {\r\n    this.olTooltip = new OlOverlay({\r\n      element: document.createElement('div'),\r\n      offset: [-30, -10],\r\n      className: [\r\n        'igo-map-tooltip',\r\n        'igo-map-tooltip-measure'\r\n      ].join(' '),\r\n      stopEvent: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update the measure tooltip of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   */\r\n  private updateMeasureTooltip(olGeometry: OlGeometry) {\r\n    const measure = measureOlGeometry(olGeometry, this.map.projection);\r\n    const lengths = measure.lengths;\r\n    const lastIndex = olGeometry.getType() === 'Polygon' ? lengths.length - 2 : lengths.length - 1;\r\n    const lastLength = lengths[lastIndex];\r\n\r\n    const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n    const olLastMidpoint = olMidpoints[lastIndex];\r\n    if (olMidpoints.length === 0 || olLastMidpoint === undefined) {\r\n      this.removeMeasureTooltip();\r\n      return;\r\n    }\r\n\r\n    this.olTooltip.setPosition(olLastMidpoint.flatCoordinates);\r\n\r\n    const innerHtml = formatMeasure(lastLength, {\r\n      decimal: 1,\r\n      unit: MeasureLengthUnit.Meters,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    });\r\n    this.olTooltip.getElement().innerHTML = innerHtml;\r\n    if (this.olTooltip.getMap() === undefined) {\r\n      this.map.ol.addOverlay(this.olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the measure tooltip from the map\r\n   */\r\n  private removeMeasureTooltip() {\r\n    if (this.olTooltip.getMap && this.olTooltip.getMap() !== undefined) {\r\n      this.map.ol.removeOverlay(this.olTooltip);\r\n      this.olTooltip.setMap(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adjust the draw style with the specified draw guide distance, if possible\r\n   * @param olStyle Draw style to update\r\n   * @param resolution Resolution (to make the screen size of symbol fit the drawGuide value)\r\n   */\r\n  private updateDrawStyleWithDrawGuide(olStyle: OlStyle, resolution: number) {\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(olStyle);\r\n    if (olGuideStyle === undefined) {\r\n      return;\r\n    }\r\n\r\n    const drawGuide = this.drawGuide;\r\n    let radius;\r\n    if (!drawGuide || drawGuide < 0) {\r\n      radius = this.defaultDrawStyleRadius;\r\n    } else {\r\n      radius = drawGuide > 0 ? drawGuide / resolution : drawGuide;\r\n    }\r\n    olGuideStyle.getImage().setRadius(radius);\r\n  }\r\n\r\n  /**\r\n   * Returns wether a given Open Layers style has a radius property that can be set (used to set draw guide)\r\n   * @param olStyle The style on which to perform the check\r\n   */\r\n  private isStyleWithRadius(olStyle: OlStyle): boolean {\r\n    return typeof olStyle !== 'function' && olStyle.getImage && olStyle.getImage().setRadius;\r\n  }\r\n\r\n  /**\r\n   * Returns wether a given Open Layers style has a radius property that can be set (used to set draw guide)\r\n   * @param olStyle The style on which to perform the check\r\n   */\r\n  private getGuideStyleFromDrawStyle(olStyle: OlStyle |  OlStyle[]): OlStyle {\r\n    if (Array.isArray(olStyle)) {\r\n      olStyle = olStyle[0];\r\n    }\r\n    if (this.isStyleWithRadius(olStyle)) {\r\n      return olStyle;\r\n    }\r\n    return undefined;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport {\r\n  MatIconModule,\r\n  MatFormFieldModule,\r\n  MatInputModule,\r\n  MatButtonModule,\r\n  MatButtonToggleModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { GeometryFormFieldComponent } from './geometry-form-field.component';\r\nimport { GeometryFormFieldInputComponent } from './geometry-form-field-input.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ],\r\n  declarations: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ]\r\n})\r\nexport class IgoGeometryFormFieldModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoGeometryFormFieldModule } from './geometry-form-field/geometry-form-field.module';\r\nimport { GeometryFormFieldComponent } from './geometry-form-field/geometry-form-field.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  exports: [\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  declarations: [],\r\n  providers: [],\r\n  entryComponents: [\r\n    GeometryFormFieldComponent\r\n  ]\r\n})\r\nexport class IgoGeometryModule {}\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { TimeFilterableDataSourceOptions } from '../shared/time-filter.interface';\r\nimport { WMSDataSourceOptions } from '../../datasource/shared/datasources/wms-datasource.interface';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-button',\r\n  templateUrl: './time-filter-button.component.html',\r\n  styleUrls: ['./time-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterButtonComponent implements OnInit {\r\n\r\n  public options: TimeFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.timeFilter as any;\r\n    if (filter && filter.enabled) {\r\n      return 1;\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  public timeFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { MatSlider, DateAdapter } from '@angular/material';\r\nimport * as moment from 'moment';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterOptions } from '../shared/time-filter.interface';\r\nimport { TimeFilterType, TimeFilterStyle } from '../shared/time-filter.enum';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-form',\r\n  templateUrl: './time-filter-form.component.html',\r\n  styleUrls: ['./time-filter-form.component.scss']\r\n})\r\nexport class TimeFilterFormComponent implements OnInit {\r\n  @Input() layer: Layer;\r\n\r\n  @Input() options: TimeFilterOptions;\r\n\r\n  public color = 'primary';\r\n  public date: Date;\r\n  public startDate: Date;\r\n  public endDate: Date;\r\n  public year: any;\r\n  public startYear: any;\r\n  public endYear: any;\r\n  public initStartYear: any;\r\n  public initEndYear: any;\r\n  public listYears: Array<string> = [];\r\n  public startListYears: Array<string> = [];\r\n  public endListYears: Array<string> = [];\r\n\r\n  @Input()\r\n  set currentValue(value: string) {\r\n    if (value) {\r\n      if (this.type !== TimeFilterType.YEAR) {\r\n        const valueArray = value.split('/');\r\n        if (valueArray.length > 0) {\r\n          const startDate = new Date(valueArray[0]);\r\n          const endDate = new Date(valueArray[1]);\r\n          if (!isNaN(startDate.valueOf())) {\r\n            this.startDate = startDate;\r\n          }\r\n          if (!isNaN(endDate.valueOf())) {\r\n            this.endDate = endDate;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public interval: any;\r\n  public playIcon = 'play-circle';\r\n  public resetIcon = 'replay';\r\n\r\n  @Output() change: EventEmitter<Date | [Date, Date]> = new EventEmitter();\r\n  @Output()\r\n  yearChange: EventEmitter<string | [string, string]> = new EventEmitter();\r\n  @ViewChild(MatSlider) mySlider;\r\n\r\n  get type(): TimeFilterType {\r\n    return this.options.type === undefined\r\n      ? TimeFilterType.DATE\r\n      : this.options.type;\r\n  }\r\n\r\n  get isRange(): boolean {\r\n    return this.options.range === undefined ||\r\n      this.options.style === TimeFilterStyle.SLIDER\r\n      ? false\r\n      : this.options.range;\r\n  }\r\n\r\n  get style(): TimeFilterStyle {\r\n    return this.options.style === undefined\r\n      ? TimeFilterStyle.SLIDER\r\n      : this.options.style;\r\n  }\r\n\r\n  get step(): number {\r\n    let step = 10800000;\r\n    if (this.options.step === undefined) {\r\n      switch (this.type) {\r\n        case TimeFilterType.DATE:\r\n        case TimeFilterType.DATETIME:\r\n          step = 10800000;\r\n          break;\r\n        case TimeFilterType.TIME:\r\n          step = 3600000;\r\n          break;\r\n        case TimeFilterType.YEAR:\r\n          step = 31536000000;\r\n          break;\r\n        default:\r\n          step = 10800000;\r\n      }\r\n    } else {\r\n      step = this.getStepDefinition(this.options.step);\r\n    }\r\n\r\n    return step;\r\n  }\r\n\r\n  get timeInterval(): number {\r\n    return this.options.timeInterval === undefined\r\n      ? 2000\r\n      : this.options.timeInterval;\r\n  }\r\n\r\n  get min(): Date {\r\n    if (this.options.min) {\r\n      const min = new Date(this.options.min);\r\n      return new Date(min.getTime() + min.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get max(): Date {\r\n    if (this.options.max) {\r\n      const max = new Date(this.options.max);\r\n      return new Date(max.getTime() + max.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get is(): boolean {\r\n    return this.options.range === undefined ? false : this.options.range;\r\n  }\r\n\r\n  constructor(private dateAdapter: DateAdapter<Date>) {\r\n    this.dateAdapter.setLocale('fr');\r\n  }\r\n\r\n  ngOnInit() {\r\n    if (this.startDate === undefined) {\r\n      this.startDate = new Date(this.min);\r\n    }\r\n    if (this.endDate === undefined) {\r\n      this.endDate = new Date(this.max);\r\n    }\r\n    if (this.startYear === undefined) {\r\n      this.startYear = new Date(this.startDate).getFullYear();\r\n      this.initStartYear = this.startYear;\r\n    }\r\n    if (this.endYear === undefined) {\r\n      this.endYear = new Date(this.endDate).getFullYear();\r\n      this.initEndYear = this.endYear;\r\n    }\r\n\r\n    if (!this.isRange) {\r\n      for (let i = this.startYear; i <= this.endYear + 1; i++) {\r\n        this.listYears.push(i);\r\n      }\r\n    } else {\r\n      for (let i = this.startYear; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      for (let i = this.startYear + 1; i <= this.endYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n    }\r\n    this.options.enabled =\r\n      this.options.enabled === undefined ? true : this.options.enabled;\r\n    this.checkFilterValue();\r\n    if (this.options.enabled) {\r\n      if (!this.isRange && this.style === 'slider' && this.type === 'year') {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.storeCurrentFilterValue();\r\n      this.yearChange.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  storeCurrentFilterValue() {\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.options.value = this.year.toString();\r\n    }\r\n  }\r\n\r\n  checkFilterValue() {\r\n    const timeFromWms = this.layer.dataSource.ol.getParams().TIME;\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.year = new Date(timeFromWms.toString()).getFullYear() + 1;\r\n      } else if (this.options.value) {\r\n        this.year = new Date(this.options.value.toString()).getFullYear() + 1;\r\n      } else {\r\n        this.year = new Date(this.min).getFullYear() + 1;\r\n      }\r\n    } else if (\r\n      this.isRange &&\r\n      this.style === TimeFilterStyle.CALENDAR &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.startYear = parseInt(timeFromWms.substr(0, 4), 10);\r\n        this.endYear = parseInt(timeFromWms.substr(5, 4), 10);\r\n        const newStartListYears: any[] = [];\r\n        const newEndListYears: any[] = [];\r\n        for (let i = this.initStartYear; i < this.endYear; i++) {\r\n          newStartListYears.push(i);\r\n        }\r\n        for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n          newEndListYears.push(i);\r\n        }\r\n        this.startListYears = newStartListYears;\r\n        this.endListYears = newEndListYears;\r\n      }\r\n    }\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n  }\r\n\r\n  handleDateChange(event: any) {\r\n    this.setupDateOutput();\r\n    this.applyTypeChange();\r\n\r\n    // Only if is range, use 2 dates to make the range\r\n    if (this.isRange) {\r\n      this.change.emit([this.startDate, this.endDate]);\r\n    } else {\r\n      this.change.emit(this.startDate);\r\n    }\r\n  }\r\n\r\n  handleYearChange(event: any) {\r\n    if (this.isRange) {\r\n      this.endListYears = [];\r\n      for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n      this.startListYears = [];\r\n      for (let i = this.initStartYear + 1; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      this.yearChange.emit([this.startYear, this.endYear]);\r\n    } else {\r\n      this.yearChange.emit(this.year);\r\n    }\r\n  }\r\n\r\n  handleListYearChange(event: any) {\r\n    this.handleYearChange([this.startYear, this.endYear]);\r\n  }\r\n\r\n  handleListYearStartChange(event: any) {\r\n    this.change.emit([this.startDate, this.endDate]);\r\n  }\r\n\r\n  dateToNumber(date: Date): number {\r\n    let newDate;\r\n    if (date) {\r\n      newDate = new Date(date);\r\n    } else {\r\n      newDate = new Date(this.min);\r\n    }\r\n\r\n    return newDate.getTime();\r\n  }\r\n\r\n  setSliderThumbLabel(label: string) {\r\n    const thumbLabel = this.findThumbLabel(\r\n      this.mySlider._elementRef.nativeElement.childNodes\r\n    );\r\n    if (thumbLabel) {\r\n      thumbLabel.textContent = label;\r\n    }\r\n  }\r\n\r\n  findThumbLabel(test: any[]): any {\r\n    let thumbLabel;\r\n\r\n    test.forEach(value => {\r\n      if (value.className === 'mat-slider-thumb-label-text') {\r\n        thumbLabel = value;\r\n      }\r\n\r\n      if (value.children.length > 0 && !thumbLabel) {\r\n        thumbLabel = this.findThumbLabel(value.childNodes);\r\n      }\r\n    }, this);\r\n    return thumbLabel;\r\n  }\r\n\r\n  toggleFilterState() {\r\n    this.options.enabled = !this.options.enabled;\r\n\r\n    if (this.options.enabled) {\r\n      if (\r\n        !this.isRange &&\r\n        TimeFilterStyle.SLIDER &&\r\n        this.type === TimeFilterType.YEAR\r\n      ) {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.stopFilter();\r\n      this.storeCurrentFilterValue();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  resetFilter(event: any) {\r\n    this.date = new Date(this.min);\r\n    this.year = this.date.getFullYear() + 1;\r\n    if (\r\n      !this.isRange &&\r\n      TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.yearChange.emit(this.year);\r\n    } else {\r\n      this.setupDateOutput();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  playFilter(event: any) {\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        that => {\r\n          let newMinDateNumber;\r\n          const maxDateNumber = new Date(that.max);\r\n\r\n          newMinDateNumber =\r\n            that.date === undefined ? that.min.getTime() : that.date.getTime();\r\n          newMinDateNumber += that.mySlider.step;\r\n          that.date = new Date(newMinDateNumber);\r\n\r\n          if (newMinDateNumber > maxDateNumber.getTime()) {\r\n            that.stopFilter();\r\n          }\r\n\r\n          that.handleDateChange({ value: that.date, date: that.date });\r\n        },\r\n        this.timeInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  playYear(event: any) {\r\n    if (\r\n      this.year + this.mySlider.step >\r\n      this.max.getFullYear() + this.mySlider.step\r\n    ) {\r\n      this.stopFilter();\r\n      this.resetFilter(event);\r\n    }\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        // tslint:disable-next-line:only-arrow-functions\r\n        function(that) {\r\n          that.year = that.year + that.mySlider.step;\r\n          if (that.year > that.max.getFullYear()) {\r\n            that.stopFilter();\r\n          }\r\n          that.yearChange.emit(that.year);\r\n        },\r\n        this.timeInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  stopFilter() {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n  }\r\n\r\n  handleSliderDateChange(event: any) {\r\n    this.date = new Date(event.value);\r\n    this.setSliderThumbLabel(this.handleSliderTooltip());\r\n    this.handleDateChange(event);\r\n  }\r\n\r\n  handleSliderYearChange(event: any) {\r\n    this.year = event.value;\r\n    this.yearChange.emit(this.year);\r\n  }\r\n\r\n  handleSliderValue(): number {\r\n    if (this.options.current === true || !this.min) {\r\n      const currentDate = new Date();\r\n      this.date = this.getRoundedDate(currentDate);\r\n    }\r\n    if (this.type === TimeFilterType.YEAR) {\r\n      return this.year;\r\n    } else {\r\n      return this.date === undefined ? this.min.getTime() : this.date.getTime();\r\n    }\r\n  }\r\n\r\n  handleSliderTooltip() {\r\n    let label: string;\r\n\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toDateString()\r\n            : this.date.toDateString();\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toTimeString()\r\n            : this.date.toTimeString();\r\n        break;\r\n      // datetime\r\n      default:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toUTCString()\r\n            : this.date.toUTCString();\r\n        break;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  setupDateOutput() {\r\n    if (this.style === TimeFilterStyle.SLIDER) {\r\n      this.startDate = new Date(this.date);\r\n      this.startDate.setSeconds(-(this.step / 1000));\r\n      this.endDate = new Date(this.startDate);\r\n      this.endDate.setSeconds(this.step / 1000);\r\n    } else if (!this.isRange && !!this.date) {\r\n      this.endDate = new Date(this.date);\r\n      this.startDate = new Date(this.date);\r\n    } else if (this.isRange && (!!this.date || !this.date)) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    } else if (!this.date) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    }\r\n  }\r\n\r\n  applyTypeChange() {\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        if (this.startDate !== undefined || this.endDate !== undefined) {\r\n          this.startDate.setHours(0);\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setHours(23);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        if (this.style === TimeFilterStyle.CALENDAR) {\r\n          if (this.startDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.startDate.getHours();\r\n            const selectedMinute = this.startDate.getMinutes();\r\n            this.startDate = this.min;\r\n            this.startDate.setHours(selectedHour);\r\n            this.startDate.setMinutes(selectedMinute);\r\n          }\r\n\r\n          if (this.endDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.endDate.getHours();\r\n            const selectedMinute = this.endDate.getMinutes();\r\n            this.endDate = this.min;\r\n            this.endDate.setHours(selectedHour);\r\n            this.endDate.setMinutes(selectedMinute);\r\n          }\r\n        }\r\n\r\n        if (!this.isRange && this.step > 60 * 60 * 1000) {\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      // datetime\r\n      default:\r\n      // do nothing\r\n    }\r\n  }\r\n\r\n  getRangeMinDate(): Date {\r\n    return this.startDate === undefined ? this.min : this.startDate;\r\n  }\r\n\r\n  getRangeMaxDate(): Date {\r\n    return this.endDate === undefined ? this.max : this.endDate;\r\n  }\r\n\r\n  /**\r\n   * Round date at a certain time, 10 minutes by Default\r\n   * @param date - Date to Round\r\n   * @param atMinute - round to closest 'atMinute' minute, rounded 10 by default\r\n   * @return the rounded date\r\n   */\r\n  getRoundedDate(date, atMinute = 10) {\r\n    const coeff = 1000 * 60 * atMinute;\r\n    return new Date(Math.round(date.getTime() / coeff) * coeff);\r\n  }\r\n\r\n  /**\r\n   * Get the step (period) definition from the layer dimension tag\r\n   * @param step The step as ISO 8601 example: PT10M for 10 Minutes\r\n   * @return the duration in milliseconds\r\n   */\r\n  getStepDefinition(step) {\r\n    return moment.duration(step).asMilliseconds();\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterableDataSource } from '../shared/time-filter.interface';\r\nimport { TimeFilterService } from '../shared/time-filter.service';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-item',\r\n  templateUrl: './time-filter-item.component.html',\r\n  styleUrls: ['./time-filter-item.component.scss']\r\n})\r\nexport class TimeFilterItemComponent {\r\n  public color = 'primary';\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  filtersCollapsed: boolean = false;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  get datasource(): TimeFilterableDataSource {\r\n    return this.layer.dataSource as TimeFilterableDataSource;\r\n  }\r\n  constructor(private timeFilterService: TimeFilterService) {}\r\n\r\n  handleYearChange(year: string | [string, string]) {\r\n    this.timeFilterService.filterByYear(this.datasource, year);\r\n  }\r\n\r\n  handleDateChange(date: Date | [Date, Date]) {\r\n    this.timeFilterService.filterByDate(this.datasource, date);\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-list',\r\n  templateUrl: './time-filter-list.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterListComponent {\r\n  @Input()\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n  private _layers: Layer[] = [];\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { TimeFilterListComponent } from './time-filter-list.component';\r\n\r\n@Directive({\r\n  selector: '[igoTimeFilterListBinding]'\r\n})\r\nexport class TimeFilterListBindingDirective implements OnInit, OnDestroy {\r\n  private component: TimeFilterListComponent;\r\n  private layers$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() component: TimeFilterListComponent,\r\n    private mapService: MapService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input layers\r\n    this.component.layers = [];\r\n\r\n    this.layers$$ = this.mapService.getMap().layers$.subscribe(layers => {\r\n      this.component.layers = layers;\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport * as olproj from 'ol/proj';\r\nimport olWKT from 'ol/format/WKT';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WktService {\r\n  constructor() {}\r\n\r\n  public wktToFeature(wkt, wktProj, featureProj) {\r\n    return new olWKT().readFeature(wkt, {\r\n      dataProjection: wktProj,\r\n      featureProjection: featureProj\r\n    });\r\n  }\r\n  public extentToWkt(epsgTO, extent, extentProj) {\r\n    let currentExtent = olproj.transformExtent(extent, extentProj, epsgTO);\r\n    currentExtent = this.roundCoordinateArray(currentExtent, epsgTO, 0);\r\n    const wktPoly = `POLYGON((\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]}))`;\r\n    const wktLine = `LINESTRING(\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]})`;\r\n    const wktMultiPoints = `MULTIPOINT(\r\n        ${extent[0]} ${extent[1]},\r\n        ${extent[0]} ${extent[3]},\r\n        ${extent[2]} ${extent[3]},\r\n        ${extent[2]} ${extent[1]})`;\r\n    return {\r\n      wktPoly,\r\n      wktLine,\r\n      wktMultiPoints\r\n    };\r\n  }\r\n\r\n  private roundCoordinateArray(coordinateArray, projection, decimal = 0) {\r\n    const lproj = olproj.get(projection);\r\n    const units = lproj.getUnits();\r\n    const olUnits = ['ft', 'm', 'us-ft'];\r\n    if (olUnits.indexOf(units) !== -1) {\r\n      coordinateArray = this.roundArray(coordinateArray, decimal);\r\n    }\r\n    return coordinateArray;\r\n  }\r\n\r\n  private roundArray(array, decimal = 0) {\r\n    let x = 0;\r\n    while (x < array.length) {\r\n      array[x] = array[x].toFixed(decimal);\r\n      x++;\r\n    }\r\n    return array;\r\n  }\r\n\r\n  public snrcToWkt(snrc, epsgTO) {\r\n    snrc = snrc.toLowerCase();\r\n    let wktPoly;\r\n    const ew = {\r\n      1: { from: -56, to: -64 },\r\n      2: { from: -64, to: -72 },\r\n      3: { from: -72, to: -80 },\r\n      4: { from: -80, to: -88 },\r\n      5: { from: -88, to: -96 },\r\n      6: { from: -96, to: -104 },\r\n      7: { from: -104, to: -112 },\r\n      8: { from: -112, to: -120 },\r\n      9: { from: -120, to: -128 },\r\n      10: { from: -128, to: -136 }\r\n    };\r\n    const sn = {\r\n      1: { from: 44, to: 48 },\r\n      2: { from: 48, to: 52 },\r\n      3: { from: 52, to: 56 },\r\n      4: { from: 56, to: 60 },\r\n      5: { from: 60, to: 64 },\r\n      6: { from: 64, to: 68 },\r\n      7: { from: 68, to: 72 },\r\n      8: { from: 72, to: 76 },\r\n      9: { from: 76, to: -128 }\r\n    };\r\n    const snrc250kIndex = [\r\n      ['m', 'n', 'o', 'p'],\r\n      ['l', 'k', 'j', 'i'],\r\n      ['e', 'f', 'g', 'h'],\r\n      ['d', 'c', 'b', 'a']\r\n    ];\r\n\r\n    const snrc50kIndex = [\r\n      ['13', '14', '15', '16'],\r\n      ['12', '11', '10', '09'],\r\n      ['05', '06', '07', '08'],\r\n      ['04', '03', '02', '01']\r\n    ];\r\n    const checkSNRC50k = /\\d{2,3}[a-p][0,1][0-9]/gi;\r\n    const checkSNRC250k = /\\d{2,3}[a-p]/gi;\r\n    const checkSNRC1m = /\\d{2,3}/gi;\r\n\r\n    let snrc1m = false;\r\n    let snrc250k = false;\r\n    let snrc50k = false;\r\n\r\n    if (checkSNRC50k.test(snrc)) {\r\n      snrc50k = true;\r\n    } else {\r\n      if (checkSNRC250k.test(snrc)) {\r\n        snrc250k = true;\r\n      } else {\r\n        if (checkSNRC1m.test(snrc)) {\r\n          snrc1m = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (snrc1m) {\r\n      snrc += 'a01';\r\n    } else if (snrc250k) {\r\n      snrc += '01';\r\n    }\r\n    if (/\\d{2,3}[a-p][0,1][0-9]/gi.test(snrc)) {\r\n      const regex1m = /(?=[a-p])/gi;\r\n      const ar1m = snrc.split(regex1m);\r\n      const part1m = ar1m[0];\r\n      const part250k = ar1m[1][0];\r\n      const part50k = ar1m[1].split(part250k)[1];\r\n      let separator = 1;\r\n      if (part1m.length === 3) {\r\n        separator = 2;\r\n      }\r\n      const partEW = part1m.substring(0, separator);\r\n      const partSN = part1m.substring(separator);\r\n      const unit1mEW = 8;\r\n      const unit1mSN = 4;\r\n      const unit250kEW = 2;\r\n      const unit250kSN = 1;\r\n      const unit50kEW = 0.5;\r\n      const unit50kSN = 0.25;\r\n      let index250kEW = 0;\r\n      let index250kSN = 0;\r\n      let index50kEW = 0;\r\n      let index50kSN = 0;\r\n      snrc250kIndex.forEach(element => {\r\n        if (element.indexOf(part250k) !== -1) {\r\n          index250kSN = snrc250kIndex.indexOf(element);\r\n          index250kEW = element.indexOf(part250k);\r\n        }\r\n      });\r\n      snrc50kIndex.forEach(element => {\r\n        if (element.indexOf(part50k) !== -1) {\r\n          index50kSN = snrc50kIndex.indexOf(element);\r\n          index50kEW = element.indexOf(part50k);\r\n        }\r\n      });\r\n\r\n      let increment250kEW = 0;\r\n      let increment250kSN = 0;\r\n      let increment50kEW = 0;\r\n      let increment50kSN = 0;\r\n      let unitPerTypeEW = unit1mEW;\r\n      let unitPerTypeSN = unit1mSN;\r\n      if (snrc250k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = 0;\r\n        increment50kSN = 0;\r\n        unitPerTypeEW = unit250kEW;\r\n        unitPerTypeSN = unit250kSN;\r\n      } else if (snrc50k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = index50kEW * unit50kEW;\r\n        increment50kSN = index50kSN * unit50kSN;\r\n        unitPerTypeEW = unit50kEW;\r\n        unitPerTypeSN = unit50kSN;\r\n      }\r\n\r\n      const coord: {ul?: any, lr?: any, ur?: any, ll?: any} = {\r\n        ul: [\r\n          ew[partEW].to + increment250kEW + increment50kEW,\r\n          sn[partSN].to - increment250kSN - increment50kSN\r\n        ]\r\n      };\r\n\r\n      coord.lr = [\r\n        coord.ul[0] + unitPerTypeEW,\r\n        coord.ul[1] - unitPerTypeSN\r\n      ];\r\n      coord.ur = [coord.ul[0], coord.ul[1] - unitPerTypeSN];\r\n      coord.ll = [coord.ul[0] + unitPerTypeEW, coord.ul[1]];\r\n\r\n      coord.ul = olproj.transform(\r\n        [coord.ul[0], coord.ul[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.lr = olproj.transform(\r\n        [coord.lr[0], coord.lr[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ur = olproj.transform(\r\n        [coord.ur[0], coord.ur[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ll = olproj.transform(\r\n        [coord.ll[0], coord.ll[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n\r\n      // Rounded coordinate to shorten url in get\r\n      coord.ul = this.roundCoordinateArray(coord.ul, epsgTO, 0);\r\n      coord.lr = this.roundCoordinateArray(coord.lr, epsgTO, 0);\r\n      coord.ur = this.roundCoordinateArray(coord.ur, epsgTO, 0);\r\n      coord.ll = this.roundCoordinateArray(coord.ll, epsgTO, 0);\r\n\r\n      wktPoly =\r\n        'POLYGON((' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        '))';\r\n      const wktLine =\r\n        'LINESTRING(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n\r\n      const wktMultiPoints =\r\n        'MULTIPOINT(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n      return {\r\n        wktPoly,\r\n        wktLine,\r\n        wktMultiPoints\r\n      };\r\n    }\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport {\r\n  OgcInterfaceFilterOptions,\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { WktService } from '../../wkt/shared/wkt.service';\r\nimport { IgoMap } from '../../map';\r\nimport { FloatLabelType } from '@angular/material';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-form',\r\n  templateUrl: './ogc-filter-form.component.html',\r\n  styleUrls: ['./ogc-filter-form.component.scss']\r\n})\r\nexport class OgcFilterFormComponent implements OnInit {\r\n  public allOgcFilterOperators;\r\n  public ogcFilterOperators$ = new BehaviorSubject<{ [key: string]: any }>(undefined);\r\n  public igoSpatialSelectors;\r\n  public value = '';\r\n  public inputOperator;\r\n  // public fields: any[];\r\n  public fields$ = new BehaviorSubject<SourceFieldsOptionsParams[]>([]);\r\n  public values: any[];\r\n  public color = 'primary';\r\n  public snrc = '';\r\n  public disabled;\r\n  public baseOverlayName = 'ogcFilterOverlay_';\r\n  public currentFilter$ = new BehaviorSubject<any>(undefined);\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  set currentFilter(currentFilter: any) {\r\n    this.currentFilter$.next(currentFilter);\r\n  }\r\n  get currentFilter(): any {\r\n    return this.currentFilter$.value;\r\n  }\r\n\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  get activeFilters() {\r\n    return this.datasource.options.ogcFilters.interfaceOgcFilters.filter(\r\n      f => f.active === true\r\n    );\r\n  }\r\n\r\n  constructor(\r\n    private wktService: WktService\r\n  ) {\r\n    // TODO: Filter permitted operator based on wfscapabilities\r\n    // Need to work on regex on XML capabilities because\r\n    // comaparison operator's name varies between WFS servers...\r\n    // Ex: IsNull vs PropertyIsNull vs IsNil ...\r\n    this.allOgcFilterOperators = new OgcFilterWriter().operators;\r\n    this.ogcFilterOperators$.next(this.allOgcFilterOperators);\r\n    this.igoSpatialSelectors = [\r\n      {\r\n        type: 'fixedExtent'\r\n      },\r\n      {\r\n        type: 'snrc'\r\n      }\r\n    ];\r\n    // TODO: selectFeature & drawFeature\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.updateField();\r\n  }\r\n\r\n  updateField() {\r\n    if (!this.datasource.options.sourceFields) {\r\n      return;\r\n    }\r\n    const fields = this.datasource.options.sourceFields\r\n      .filter(sf => (sf.excludeFromOgcFilters === undefined || !sf.excludeFromOgcFilters));\r\n    fields.filter(f => f.name === this.currentFilter.propertyName)\r\n      .forEach(element => {\r\n        this.values = element.values !== undefined ? element.values.sort() : [];\r\n      });\r\n\r\n    this.fields$.next(fields);\r\n    const allowedOperators = new OgcFilterWriter().computeAllowedOperators(\r\n      fields,\r\n      this.currentFilter.propertyName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType);\r\n    this.ogcFilterOperators$.next(allowedOperators);\r\n    if (Object.keys(allowedOperators).indexOf(this.currentFilter$.value.operator) === -1) {\r\n      this.currentFilter$.value.operator = Object.keys(allowedOperators)[0];\r\n    }\r\n    this.refreshFilters();\r\n  }\r\n\r\n  toggleFilterState(event, filter: OgcInterfaceFilterOptions, property) {\r\n    this.updateField();\r\n    if (event.checked) {\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters\r\n        .filter(f => f.filterid === filter.filterid)\r\n        .forEach(element => {\r\n          element[property] = true;\r\n        });\r\n    } else {\r\n      this.removeOverlayByID(filter.filterid);\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters\r\n        .filter(f => f.filterid === filter.filterid)\r\n        .forEach(element => {\r\n          element[property] = false;\r\n        });\r\n    }\r\n    this.refreshFilters();\r\n  }\r\n\r\n  deleteFilter(filter: OgcInterfaceFilterOptions) {\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    ogcFilters.interfaceOgcFilters = ogcFilters.interfaceOgcFilters.filter(\r\n      f => f.filterid !== filter.filterid\r\n    );\r\n    this.removeOverlayByID(filter.filterid);\r\n\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeNumericProperty(filter: OgcInterfaceFilterOptions, property, value) {\r\n    this.changeProperty(filter, property, parseFloat(value));\r\n    this.refreshFilters();\r\n  }\r\n\r\n  private removeOverlayByID(id) {\r\n    const overlayId = this.baseOverlayName + id;\r\n    if (this.map.overlay.dataSource.ol.getFeatureById(overlayId)) {\r\n      this.map.overlay.dataSource.ol.removeFeature(\r\n        this.map.overlay.dataSource.ol.getFeatureById(overlayId)\r\n      );\r\n    }\r\n  }\r\n\r\n  changeOperator(filter) {\r\n    if (this.ogcFilterOperators$.value[filter.operator].spatial === false) {\r\n      this.removeOverlayByID(filter.filterid);\r\n    }\r\n    this.refreshFilters();\r\n  }\r\n\r\n  // Issue with mapserver 7.2 and Postgis layers. Fixed in 7.4\r\n  // Due to this issue, the checkbox is hide.\r\n  changeCaseSensitive(matchCase) {\r\n    this.currentFilter.matchCase = matchCase.checked;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeProperty(filter: OgcInterfaceFilterOptions, property, value) {\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters\r\n      .filter(f => f.filterid === filter.filterid)\r\n      .forEach(element => {\r\n        element[property] = value;\r\n      });\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeGeometry(filter, value?) {\r\n    const checkSNRC50k = /\\d{2,3}[a-l][0,1][0-9]/gi;\r\n    const checkSNRC250k = /\\d{2,3}[a-p]/gi;\r\n    const checkSNRC1m = /\\d{2,3}/gi;\r\n    const mapProjection = this.map.projection;\r\n    this.removeOverlayByID(filter.filterid);\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters\r\n      .filter(f => f.filterid === filter.filterid)\r\n      .forEach(element => {\r\n        let wktPoly;\r\n        if (filter.igoSpatialSelector === 'snrc') {\r\n          if (value === '' && this.snrc !== '') {\r\n            wktPoly = this.wktService.snrcToWkt(this.snrc, this.map.projection).wktPoly;\r\n            element.wkt_geometry = wktPoly;\r\n          } else if (\r\n            value !== '' &&\r\n            (checkSNRC1m.test(value) ||\r\n              checkSNRC250k.test(value) ||\r\n              checkSNRC50k.test(value))\r\n          ) {\r\n            wktPoly = this.wktService.snrcToWkt(value, this.map.projection).wktPoly;\r\n            element.wkt_geometry = wktPoly;\r\n          }\r\n        } else if (filter.igoSpatialSelector === 'fixedExtent') {\r\n          wktPoly = this.wktService.extentToWkt(\r\n            mapProjection,\r\n            this.map.viewController.getExtent(),\r\n            mapProjection\r\n          ).wktPoly;\r\n          element.wkt_geometry = wktPoly;\r\n        }\r\n      });\r\n    this.refreshFilters();\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\nimport { OgcFilterableDataSource } from '../shared/ogc-filter.interface';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-form',\r\n  templateUrl: './ogc-filterable-form.component.html'\r\n})\r\nexport class OgcFilterableFormComponent {\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters;\r\n  }\r\n\r\n  get advancedOgcFilters(): boolean {\r\n    if (this.datasource.options.ogcFilters) {\r\n      return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n    }\r\n    return;\r\n  }\r\n\r\n  public color = 'primary';\r\n\r\n  constructor() {}\r\n}\r\n","import { Component, Input, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { DownloadService } from '../../download/shared/download.service';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { WFSDataSourceOptionsParams } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions,\r\n  OgcInterfaceFilterOptions\r\n} from '../shared/ogc-filter.interface';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterWriter } from '../shared/ogc-filter';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-item',\r\n  templateUrl: './ogc-filterable-item.component.html',\r\n  styleUrls: ['./ogc-filterable-item.component.scss']\r\n})\r\nexport class OgcFilterableItemComponent implements OnInit {\r\n  public color = 'primary';\r\n  private lastRunOgcFilter;\r\n  private defaultLogicalParent = 'And';\r\n  public hasActiveSpatialFilter = false;\r\n  public filtersAreEditable = true;\r\n  public filtersCollapsed = true;\r\n  public hasPushButton: boolean = false;\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private ogcFilterWriter;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters.bind(this);\r\n  }\r\n\r\n  get datasource(): OgcFilterableDataSource {\r\n    return this.layer.dataSource as OgcFilterableDataSource;\r\n  }\r\n\r\n  get downloadable() {\r\n    return (this.datasource.options as any).download;\r\n  }\r\n\r\n  constructor(\r\n    private ogcFilterService: OGCFilterService,\r\n    private downloadService: DownloadService\r\n  ) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n  }\r\n\r\n  ngOnInit() {\r\n    const ogcFilters = this.datasource.options.ogcFilters;\r\n    if (ogcFilters.pushButtons && ogcFilters.pushButtons.bundles.length > 0) {\r\n      if (ogcFilters.advancedOgcFilters === undefined) {\r\n        ogcFilters.advancedOgcFilters = false;\r\n      }\r\n      this.hasPushButton = true;\r\n    }\r\n\r\n    switch (this.datasource.options.type) {\r\n      case 'wms':\r\n        this.ogcFilterService.setOgcWMSFiltersOptions(this.datasource);\r\n        break;\r\n      case 'wfs':\r\n        this.ogcFilterService.setOgcWFSFiltersOptions(this.datasource);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    if (ogcFilters) {\r\n      if (ogcFilters.interfaceOgcFilters) {\r\n        this.lastRunOgcFilter = JSON.parse(\r\n          JSON.stringify(ogcFilters.interfaceOgcFilters)\r\n        );\r\n        if (\r\n          ogcFilters.interfaceOgcFilters.filter(f => f.wkt_geometry).length >= 1\r\n        ) {\r\n          this.hasActiveSpatialFilter = true;\r\n        }\r\n      }\r\n\r\n      this.filtersAreEditable = ogcFilters.editable\r\n        ? ogcFilters.editable\r\n        : false;\r\n    }\r\n  }\r\n\r\n  addFilterToSequence() {\r\n    this.filtersCollapsed = false;\r\n    const interfaceOgcFilters: OgcInterfaceFilterOptions[] = this.datasource\r\n      .options.ogcFilters.interfaceOgcFilters;\r\n    const arr = interfaceOgcFilters || [];\r\n    const lastLevel = arr.length === 0 ? 0 : arr[arr.length - 1].level;\r\n    let firstFieldName = '';\r\n    const includedFields = this.datasource.options.sourceFields.filter(f => !f.excludeFromOgcFilters);\r\n    if (includedFields.length > 0) {\r\n      firstFieldName =\r\n        includedFields[0].name === undefined ? '' : includedFields[0].name;\r\n    }\r\n    let fieldNameGeometry;\r\n    const datasourceOptions = this.datasource\r\n      .options as WFSDataSourceOptionsParams;\r\n    if (datasourceOptions.fieldNameGeometry) {\r\n      fieldNameGeometry = datasourceOptions.fieldNameGeometry;\r\n    } else if (\r\n      (this.datasource.options as any).paramsWFS &&\r\n      (this.datasource.options as any).paramsWFS.fieldNameGeometry\r\n    ) {\r\n      fieldNameGeometry = (this.datasource.options as any).paramsWFS\r\n        .fieldNameGeometry;\r\n    }\r\n    const status = arr.length === 0 ? true : false;\r\n    const allowedOperators = this.ogcFilterWriter.computeAllowedOperators(\r\n      this.datasource.options.sourceFields,\r\n      firstFieldName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType);\r\n    const firstOperatorName = Object.keys(allowedOperators)[0];\r\n\r\n    arr.push(\r\n      this.ogcFilterWriter.addInterfaceFilter(\r\n        {\r\n          propertyName: firstFieldName,\r\n          operator: firstOperatorName,\r\n          active: status,\r\n          igoSpatialSelector: 'fixedExtent',\r\n          srsName: this.map.projection,\r\n        } as OgcInterfaceFilterOptions,\r\n        fieldNameGeometry,\r\n        lastLevel,\r\n        this.defaultLogicalParent\r\n      )\r\n    );\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters = arr;\r\n  }\r\n\r\n  openDownload() {\r\n    this.downloadService.open(this.layer);\r\n  }\r\n\r\n  refreshFilters(force?: boolean) {\r\n    if (force === true) {\r\n      this.lastRunOgcFilter = undefined;\r\n    }\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    const activeFilters = ogcFilters.interfaceOgcFilters.filter(\r\n      f => f.active === true\r\n    );\r\n    if (activeFilters.length === 0) {\r\n      ogcFilters.filters = undefined;\r\n      ogcFilters.filtered = false;\r\n    }\r\n    if (activeFilters.length > 1) {\r\n      activeFilters[0].parentLogical = activeFilters[1].parentLogical;\r\n    }\r\n    if (\r\n      activeFilters.filter(\r\n        af => ['Contains', 'Intersects', 'Within'].indexOf(af.operator) !== -1\r\n      ).length === 0\r\n    ) {\r\n      this.hasActiveSpatialFilter = false;\r\n    } else {\r\n      this.hasActiveSpatialFilter = true;\r\n    }\r\n\r\n    if (\r\n      !(JSON.stringify(this.lastRunOgcFilter) === JSON.stringify(activeFilters))\r\n    ) {\r\n      if (this.layer.dataSource.options.type === 'wfs') {\r\n        const ogcDataSource: any = this.layer.dataSource;\r\n        const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n        ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n          activeFilters\r\n        );\r\n        this.layer.dataSource.ol.clear();\r\n      } else if (\r\n        this.layer.dataSource.options.type === 'wms' &&\r\n        ogcFilters.enabled\r\n      ) {\r\n        let rebuildFilter = '';\r\n        if (activeFilters.length >= 1) {\r\n          const ogcDataSource: any = this.layer.dataSource;\r\n          const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n          ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n            activeFilters\r\n          );\r\n          rebuildFilter = this.ogcFilterWriter.buildFilter(\r\n            ogcLayer.filters,\r\n            undefined,\r\n            undefined,\r\n            (this.layer.dataSource.options as any).fieldNameGeometry\r\n          );\r\n        }\r\n        this.ogcFilterService.filterByOgc(\r\n          this.datasource as WMSDataSource,\r\n          rebuildFilter\r\n        );\r\n        this.datasource.options.ogcFilters.filtered =\r\n          activeFilters.length === 0 ? false : true;\r\n      }\r\n\r\n      this.lastRunOgcFilter = JSON.parse(JSON.stringify(activeFilters));\r\n    } else {\r\n      // identical filter. Nothing triggered\r\n    }\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  public isAdvancedOgcFilters(): boolean {\r\n    return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n  }\r\n\r\n  public addFilterDisabled(): boolean {\r\n    return (\r\n      !this.datasource.options.sourceFields ||\r\n      this.datasource.options.sourceFields.length === 0\r\n    );\r\n  }\r\n\r\n  private changeOgcFiltersAdvancedOgcFilters(value: boolean) {\r\n    this.datasource.options.ogcFilters.advancedOgcFilters = value;\r\n  }\r\n\r\n  changeOgcFilterType(isAdvancedOgcFilters) {\r\n    this.changeOgcFiltersAdvancedOgcFilters(isAdvancedOgcFilters.checked);\r\n    if (isAdvancedOgcFilters.checked) {\r\n      this.refreshFilters(true);\r\n    }\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-list',\r\n  templateUrl: './ogc-filterable-list.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterableListComponent {\r\n\r\n  @Input() layers: Layer[];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  constructor() {}\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { OgcFilterableListComponent } from './ogc-filterable-list.component';\r\n\r\n@Directive({\r\n  selector: '[igoOgcFilterableListBinding]'\r\n})\r\nexport class OgcFilterableListBindingDirective implements OnInit, OnDestroy {\r\n  private component: OgcFilterableListComponent;\r\n  private layers$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() component: OgcFilterableListComponent,\r\n    private mapService: MapService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input layers\r\n    this.component.layers = [];\r\n\r\n    this.layers$$ = this.mapService.getMap().layers$.subscribe(layers => {\r\n      this.component.layers = layers;\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n  }\r\n}\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterableDataSourceOptions, IgoPushButton, OgcFiltersOptions } from '../shared/ogc-filter.interface';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-button',\r\n  templateUrl: './ogc-filter-button.component.html',\r\n  styleUrls: ['./ogc-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterButtonComponent implements OnInit {\r\n\r\n  public options: OgcFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.ogcFilters as any;\r\n    if (filter && !filter.advancedOgcFilters) {\r\n      if (filter.pushButtons) {\r\n        const pushButtons = filter.pushButtons as IgoPushButton;\r\n        const currentPushButtonGroup = pushButtons.groups.find(gr => gr.enabled);\r\n        let cntPushButtons = 0;\r\n        if (currentPushButtonGroup) {\r\n          currentPushButtonGroup.computedButtons.map(cb => cntPushButtons += cb.buttons.filter(button => button.enabled).length);\r\n        }\r\n        return cntPushButtons > 0 ? cntPushButtons : undefined;\r\n      } else {\r\n        return;\r\n      }\r\n    } else if (filter && filter.filters && !filter.filters.filters) {\r\n      return 1;\r\n    } else if (filter && filter.filters && filter.filters.filters) {\r\n      return filter.filters.filters.length;\r\n    }\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean;\r\n\r\n  public ogcFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  IgoOgcFilterObject,\r\n  OgcPushButton,\r\n  OgcPushButtonBundle,\r\n  PushButtonGroup\r\n\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { IgoMap } from '../../map';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-toggle-button',\r\n  templateUrl: './ogc-filter-toggle-button.component.html',\r\n  styleUrls: ['./ogc-filter-toggle-button.component.scss']\r\n})\r\nexport class OgcFilterToggleButtonComponent implements OnInit {\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  private ogcFilterWriter: OgcFilterWriter;\r\n  public color = 'primary';\r\n  public currentPushButtonGroup;\r\n\r\n  constructor(\r\n    private ogcFilterService: OGCFilterService\r\n  ) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n  }\r\n\r\n  getPushButtonsGroups(): PushButtonGroup[] {\r\n    return this.datasource.options.ogcFilters.pushButtons.groups;\r\n  }\r\n\r\n  ngOnInit() {\r\n    if (this.datasource.options.ogcFilters &&\r\n      this.datasource.options.ogcFilters.pushButtons) {\r\n      this.currentPushButtonGroup =\r\n        this.datasource.options.ogcFilters.pushButtons.groups.find(g => g.enabled) ||\r\n        this.datasource.options.ogcFilters.pushButtons.groups[0];\r\n    }\r\n    this.applyFilters();\r\n  }\r\n\r\n  getToolTip(pb: OgcPushButton): string  {\r\n    let tt;\r\n    if (pb.tooltip) {\r\n      if (Array.isArray(pb.tooltip)) {\r\n        tt = pb.tooltip.join('\\n');\r\n      } else {\r\n        tt = pb.tooltip;\r\n      }\r\n    }\r\n    return tt || '';\r\n  }\r\n\r\n  getButtonColor(pb: OgcPushButton): {} {\r\n\r\n    let styles;\r\n    if (pb.color) {\r\n      styles = {\r\n        'background-color': pb.enabled ? `rgba(${pb.color})` : `rgba(255,255,255,0)`,\r\n\r\n      };\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  bundleIsVertical(bundle: OgcPushButtonBundle): boolean {\r\n    return bundle.vertical ? bundle.vertical : false;\r\n  }\r\n\r\n  onChangeGroup() {\r\n\r\n    this.getPushButtonsGroups().map(g => g.enabled = false);\r\n    this.getPushButtonsGroups().find(g => g === this.currentPushButtonGroup).enabled = true;\r\n    this.applyFilters();\r\n  }\r\n\r\n  applyFilters(currentOgcPushButton?: OgcPushButton) {\r\n    if (currentOgcPushButton) {\r\n      currentOgcPushButton.enabled = !currentOgcPushButton.enabled;\r\n    }\r\n    let filterQueryString = '';\r\n    const conditions = [];\r\n    this.currentPushButtonGroup.computedButtons.map(buttonBundle => {\r\n      const bundleCondition = [];\r\n      buttonBundle.buttons\r\n      .filter(ogcpb => ogcpb.enabled === true)\r\n      .forEach(enabledPb => bundleCondition.push(enabledPb.filters));\r\n      if (bundleCondition.length >= 1 ) {\r\n        if (bundleCondition.length === 1) {\r\n          conditions.push(bundleCondition[0]);\r\n        } else {\r\n          conditions.push({logical: buttonBundle.logical, filters: bundleCondition});\r\n        }\r\n      }\r\n    });\r\n    if (conditions.length >= 1) {\r\n      filterQueryString = this.ogcFilterWriter\r\n        .buildFilter(conditions.length === 1 ?\r\n          conditions[0] : {logical: 'And', filters: conditions } as IgoOgcFilterObject);\r\n    }\r\n    if (this.datasource.options.type === 'wms') {\r\n      this.ogcFilterService.filterByOgc(this.datasource as WMSDataSource, filterQueryString );\r\n    }\r\n    if (this.datasource.options.type === 'wfs') {\r\n      // TODO: Check how to prevent wfs to refresh when filter icon is pushed...\r\n      this.datasource.ol.clear();\r\n    }\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { FormControl } from '@angular/forms';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { Feature } from '../../../feature';\r\n\r\n/**\r\n * Spatial Filter Type\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-type',\r\n  templateUrl: './spatial-filter-type.component.html',\r\n  styleUrls: ['./spatial-filter-type.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterTypeComponent implements OnInit {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  public queryType: string[] = ['Arrond', 'CircFed', 'CircProv', 'DirReg', 'Mun', 'MRC', 'AdmRegion', 'RegTour'];\r\n  public selectedTypeIndex = new FormControl(0);\r\n\r\n  /**\r\n   * Reference to the SpatialFIlterType enum\r\n   * @internal\r\n   */\r\n  public spatialType = SpatialFilterType;\r\n\r\n  public activeDrawType: SpatialFilterType = this.spatialType.Polygon;\r\n\r\n  @Input() selectedQueryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  public type: SpatialFilterType;\r\n\r\n  @Output() eventType = new EventEmitter<SpatialFilterType>();\r\n\r\n  @Output() eventQueryType = new EventEmitter<SpatialFilterQueryType>();\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = this.spatialType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onTypeChange(event) {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = SpatialFilterType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onQueryTypeChange(event) {\r\n    this.eventQueryType.emit(this.selectedQueryType);\r\n  }\r\n\r\n  onZoneChange(feature) {\r\n    this.zoneChange.emit(feature);\r\n  }\r\n\r\n  onDrawTypeChange(spatialType: SpatialFilterType) {\r\n    this.activeDrawType = spatialType;\r\n    this.eventType.emit(this.activeDrawType);\r\n  }\r\n}\r\n","import { EntityStore } from '@igo2/common';\r\nimport { SpatialFilterService } from './../../shared/spatial-filter.service';\r\nimport { SpatialFilterQueryType } from './../../shared/spatial-filter.enum';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { FormControl } from '@angular/forms';\r\nimport { Feature } from '../../../feature';\r\n\r\n@Component({\r\n  selector: 'igo-spatial-filter-list',\r\n  templateUrl: './spatial-filter-list.component.html',\r\n  styleUrls: ['./spatial-filter-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterListComponent implements OnInit, OnDestroy {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  @Input()\r\n  get queryType(): SpatialFilterQueryType {\r\n    return this._queryType;\r\n  }\r\n  set queryType(queryType: SpatialFilterQueryType) {\r\n    this.formControl.setValue('');\r\n    this._queryType = queryType;\r\n  }\r\n  private _queryType: SpatialFilterQueryType;\r\n\r\n  @Input() selectedZone: Feature;\r\n\r\n  public formControl = new FormControl();\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n\r\n  formValueChanges$$: Subscription;\r\n\r\n  ngOnInit() {\r\n    this.formValueChanges$$ = this.formControl.valueChanges.subscribe((value) => {\r\n      if (value.length) {\r\n        this.store.view.filter((feature) => {\r\n          const filterNormalized = value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          const featureNameNormalized = feature.properties.nom.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          return featureNameNormalized.includes(filterNormalized);\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.formValueChanges$$.unsubscribe();\r\n  }\r\n\r\n  displayFn(feature?: Feature): string | undefined {\r\n    return feature ? feature.properties.nom : undefined;\r\n  }\r\n\r\n  constructor(private spatialFilterService: SpatialFilterService) {}\r\n\r\n  onZoneChange(feature) {\r\n    if (feature && this.queryType) {\r\n      this.spatialFilterService.loadItemById(feature, this.queryType)\r\n      .subscribe((featureGeom: Feature) => {\r\n        this.selectedZone = featureGeom;\r\n        this.zoneChange.emit(featureGeom);\r\n      });\r\n    }\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\nimport { IgoMap } from '../../../map';\r\nimport { SpatialFilterItemType } from './../../shared/spatial-filter.enum';\r\nimport { Feature } from './../../../feature/shared/feature.interfaces';\r\nimport { FormControl } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport OlGeometryType from 'ol/geom/GeometryType';\r\nimport { GeoJSONGeometry } from '../../../geometry/shared/geometry.interfaces';\r\nimport { Style as OlStyle } from 'ol/style';\r\nimport * as olstyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\nimport { olFeature } from 'ol/Feature';\r\nimport { MatTreeNestedDataSource } from '@angular/material';\r\nimport { SpatialFilterService } from '../../shared/spatial-filter.service';\r\nimport { MeasureLengthUnit } from '../../../measure';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { Layer } from '../../../layer/shared';\r\nimport { NestedTreeControl } from '@angular/cdk/tree';\r\nimport { SpatialFilterThematic } from './../../shared/spatial-filter.interface';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\n/**\r\n * Spatial-Filter-Item (search parameters)\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-item',\r\n  templateUrl: './spatial-filter-item.component.html',\r\n  styleUrls: ['./spatial-filter-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterItemComponent implements OnDestroy, OnInit {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get type(): SpatialFilterType {\r\n    return this._type;\r\n  }\r\n  set type(type: SpatialFilterType) {\r\n    this._type = type;\r\n    const index = this.geometryTypes.findIndex(geom => geom === this.type);\r\n    this.geometryType = this.geometryTypes[index];\r\n    this.formControl.reset();\r\n    this.radius = undefined;\r\n    this.drawGuide$.next(null);\r\n    this.drawStyle$.next(undefined);\r\n\r\n    // Necessary to keep reference to the geometry form field input\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      const geojson: GeoJSONGeometry = {\r\n        type: 'Point',\r\n        coordinates: ''\r\n      };\r\n      this.formControl.setValue(geojson);\r\n    }\r\n\r\n    // Necessary to apply the right style when geometry type is Point\r\n    if (this.type === SpatialFilterType.Point) {\r\n      this.radius = 1000; // Base radius\r\n      this.radiusFormControl.setValue(this.radius);\r\n      this.PointStyle = (feature: olFeature, resolution: number) => {\r\n        const coordinates = olproj.transform(feature.getGeometry().getCoordinates(), this.map.projection, 'EPSG:4326');\r\n        return new olstyle.Style ({\r\n          image: new olstyle.Circle ({\r\n            radius: this.radius / (Math.cos((Math.PI / 180) * coordinates[1])) / resolution, // Latitude correction\r\n            stroke: new olstyle.Stroke({\r\n              width: 2,\r\n              color: 'rgba(0, 153, 255)'\r\n            }),\r\n            fill: new olstyle.Fill({\r\n              color: 'rgba(0, 153, 255, 0.2)'\r\n            })\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PointStyle;\r\n      this.drawStyle$.next(this.overlayStyle);\r\n    } else {\r\n      // If geometry types is Polygon\r\n      this.radius = undefined;\r\n      this.PolyStyle = (feature, resolution) => {\r\n        return new olstyle.Style ({\r\n          stroke: new olstyle.Stroke({\r\n            width: 2,\r\n            color: 'rgba(0, 153, 255)'\r\n          }),\r\n          fill: new olstyle.Fill({\r\n            color: 'rgba(0, 153, 255, 0.2)'\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PolyStyle;\r\n    }\r\n    this.overlayStyle$.next(this.overlayStyle);\r\n  }\r\n  private _type: SpatialFilterType;\r\n\r\n  @Input() queryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  @Input() loading;\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n    this._store.entities$.subscribe(() => { this.cdRef.detectChanges(); });\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters];\r\n  }\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  @Output() toggleSearch = new EventEmitter();\r\n\r\n  @Output() itemTypeChange = new EventEmitter<SpatialFilterItemType>();\r\n\r\n  @Output() thematicChange = new EventEmitter<SpatialFilterThematic[]>();\r\n\r\n  @Output() drawZoneEvent = new EventEmitter<Feature>();\r\n\r\n  @Output() radiusEvent = new EventEmitter<number>();\r\n  @Output() freehandControl = new EventEmitter<boolean>();\r\n\r\n  @Output() clearButtonEvent = new EventEmitter<Layer[]>();\r\n\r\n  @Output() clearSearchEvent = new EventEmitter();\r\n\r\n  @Output() export = new EventEmitter();\r\n\r\n  public itemType: SpatialFilterItemType[] = [SpatialFilterItemType.Address, SpatialFilterItemType.Thematics];\r\n  public selectedItemType: SpatialFilterItemType = SpatialFilterItemType.Address;\r\n  public selectedSourceAddress;\r\n\r\n  treeControl = new NestedTreeControl<SpatialFilterThematic>(node => node.children);\r\n\r\n  // For thematics and results tables\r\n  public displayedColumns: string[] = ['name', 'select'];\r\n  public childrens: SpatialFilterThematic[] = [];\r\n  public groups: string[] = [];\r\n  public thematics: SpatialFilterThematic[] = [];\r\n  public dataSource = new MatTreeNestedDataSource<SpatialFilterThematic>();\r\n  public selectedThematics = new SelectionModel<SpatialFilterThematic>(true, []);\r\n  public displayedColumnsResults: string[] = ['typeResults', 'nameResults'];\r\n\r\n  // For geometry form field input\r\n  value$: BehaviorSubject<GeoJSONGeometry> = new BehaviorSubject(undefined);\r\n  drawGuide$: BehaviorSubject<number> = new BehaviorSubject(null);\r\n  overlayStyle$: BehaviorSubject<OlStyle> = new BehaviorSubject(undefined);\r\n  drawStyle$: BehaviorSubject<OlStyle> = new BehaviorSubject(undefined);\r\n\r\n  private value$$: Subscription;\r\n  private radiusChanges$$: Subscription;\r\n\r\n  public formControl = new FormControl();\r\n  public geometryType: OlGeometryType;\r\n  public geometryTypeField = false;\r\n  public geometryTypes: string[] = ['Point', 'Polygon'];\r\n  public drawGuideField = false;\r\n  public drawGuide: number = null;\r\n  public drawGuidePlaceholder = '';\r\n  public measure = false;\r\n  public drawControlIsActive = true;\r\n  public freehandDrawIsActive = false;\r\n  public drawStyle: OlStyle;\r\n  public drawZone: Feature;\r\n  public overlayStyle: OlStyle;\r\n  public PointStyle: OlStyle;\r\n  public PolyStyle: OlStyle;\r\n\r\n  public radius: number;\r\n  public radiusFormControl = new FormControl();\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private spatialFilterService: SpatialFilterService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.spatialFilterService.loadThematicsList()\r\n    .subscribe((items: SpatialFilterThematic[]) => {\r\n      for (const item of items) {\r\n        this.childrens.push(item);\r\n        this.childrens.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      }\r\n      this.childrens.forEach(child => {\r\n        if (child.group && (this.groups.indexOf(child.group) === -1)) {\r\n          this.groups.push(child.group);\r\n          const thematic: SpatialFilterThematic = {\r\n            name: child.group,\r\n            children: []\r\n          };\r\n          this.thematics.push(thematic);\r\n        }\r\n        if (!child.group) {\r\n          const thematic: SpatialFilterThematic = {\r\n            name: child.name,\r\n            children: [],\r\n            source: child.source\r\n          };\r\n          this.thematics.push(thematic);\r\n        }\r\n        this.thematics.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      });\r\n      this.thematics.forEach(thematic => {\r\n        for (const child of this.childrens) {\r\n          if (child.group === thematic.name) {\r\n            thematic.children.push(child);\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.dataSource.data = this.thematics;\r\n\r\n    this.drawGuide$.next(null);\r\n    this.value$.next(this.formControl.value ? this.formControl.value : undefined);\r\n    this.value$$ = this.formControl.valueChanges.subscribe((value: GeoJSONGeometry) => {\r\n      this.value$.next(value ? value : undefined);\r\n    });\r\n\r\n    this.value$.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    this.radiusChanges$$ = this.radiusFormControl.valueChanges.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the value stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.value$$.unsubscribe();\r\n    this.cdRef.detach();\r\n  }\r\n\r\n  onItemTypeChange(event) {\r\n    this.selectedItemType = event.value;\r\n    this.itemTypeChange.emit(this.selectedItemType);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureLengthUnit) {\r\n    this.measureUnit = unit;\r\n  }\r\n\r\n  isPredefined() {\r\n    return this.type === SpatialFilterType.Predefined;\r\n  }\r\n\r\n  isPolygon() {\r\n    return this.type === SpatialFilterType.Polygon;\r\n  }\r\n\r\n  isPoint() {\r\n    return this.type === SpatialFilterType.Point;\r\n  }\r\n\r\n  hasChild(_: number, node: SpatialFilterThematic) {\r\n    if (node.children) {\r\n      return node.children.length;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  onToggleClick(node: SpatialFilterThematic) {\r\n    this.treeControl.isExpanded(node) ? this.treeControl.collapse(node) : this.treeControl.expand(node);\r\n  }\r\n\r\n  isAllSelected(node?: SpatialFilterThematic) {\r\n    let numSelected;\r\n    let numNodes = 0;\r\n    if (!node) {\r\n      numSelected = this.selectedThematics.selected.length;\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          numNodes++;\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.thematics.find(thematic => thematic.source === children.source)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    } else {\r\n      numSelected = node.children.length;\r\n      node.children.forEach(children => {\r\n        if (this.selectedThematics.selected.find(thematic => thematic === children)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (numNodes >= 1) {\r\n      return numSelected === numNodes;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  hasChildrenSelected(node: SpatialFilterThematic) {\r\n    let bool = false;\r\n    node.children.forEach(child => {\r\n      if (this.selectedThematics.selected.find(thematic => thematic.source === child.source)) {\r\n        bool = true;\r\n      }\r\n    });\r\n    return bool;\r\n  }\r\n\r\n  /**\r\n   * Apply header checkbox\r\n   */\r\n  masterToggle() {\r\n    this.isAllSelected() ?\r\n      this.selectedThematics.clear() :\r\n      this.selectAll();\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n\r\n    if (this.isAllSelected()) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.expand(thematic);\r\n        }\r\n      });\r\n    } else {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.collapse(thematic);\r\n        }\r\n      });\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  selectAll(node?: SpatialFilterThematic) {\r\n    if (!node) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          this.selectedThematics.select(thematic);\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.selectedThematics.selected.find(thematic => thematic.source === children.source)) {\r\n          this.selectedThematics.select(children);\r\n        }\r\n      });\r\n    } else {\r\n      if (this.hasChild(0, node)) {\r\n        node.children.forEach(children => this.selectedThematics.select(children));\r\n      }\r\n    }\r\n  }\r\n\r\n  childrensToggle(node: SpatialFilterThematic) {\r\n    this.isAllSelected(node) ?\r\n    node.children.forEach(child => this.selectedThematics.deselect(child)) :\r\n    this.selectAll(node);\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.treeControl.expand(node);\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  /**\r\n   * Apply changes to the thematics selected tree and emit event\r\n   */\r\n  onToggleChange(nodeSelected: SpatialFilterThematic) {\r\n    let selected = false;\r\n    if (this.selectedThematics.selected.find(thematic => thematic.source === nodeSelected.source) !== undefined) {\r\n      selected = true;\r\n    }\r\n\r\n    this.childrens.forEach(children => {\r\n      if (children === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(children);\r\n      }\r\n      if (children === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(children);\r\n      }\r\n    });\r\n    this.thematics.forEach(thematic => {\r\n      if (thematic === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(thematic);\r\n      }\r\n      if (thematic === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(thematic);\r\n      }\r\n    });\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  onDrawControlChange() {\r\n    this.drawControlIsActive = !this.drawControlIsActive;\r\n  }\r\n\r\n  onfreehandControlChange() {\r\n    this.freehandDrawIsActive = !this.freehandDrawIsActive;\r\n    this.freehandControl.emit(this.freehandDrawIsActive);\r\n  }\r\n\r\n  /**\r\n   * Launch search button\r\n   */\r\n  toggleSearchButton() {\r\n    if (this.isPolygon() || this.isPoint()) {\r\n      this.drawZone = this.formControl.value as Feature;\r\n      this.drawZone.meta = {\r\n        id: undefined,\r\n        title: 'Zone'\r\n      };\r\n      this.drawZone.properties = {\r\n        nom: 'Zone'\r\n      };\r\n      this.drawZoneEvent.emit(this.drawZone);\r\n    }\r\n    this.radiusEvent.emit(this.radius);\r\n    this.toggleSearch.emit();\r\n  }\r\n\r\n  /**\r\n   * Launch clear button (clear store and map layers)\r\n   */\r\n  clearButton() {\r\n    this.loading = true;\r\n    this.map.removeLayers(this.layers);\r\n    this.loading = false;\r\n    if (this.store) {\r\n      this.store.clear();\r\n    }\r\n    this.clearButtonEvent.emit([]);\r\n  }\r\n\r\n  /**\r\n   * Launch clear search (clear field if type is predefined)\r\n   */\r\n  clearSearch() {\r\n    this.selectedThematics.clear();\r\n    this.thematicChange.emit([]);\r\n    this.clearSearchEvent.emit();\r\n  }\r\n\r\n  /**\r\n   * Verify conditions of incomplete fields or busy service\r\n   */\r\n  disableSearchButton(): boolean {\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address) {\r\n        if (this.queryType !== undefined && this.zone !== undefined) {\r\n          return this.loading;\r\n        }\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.queryType !== undefined && this.zone !== undefined && this.selectedThematics.selected.length > 0) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    if (this.type === SpatialFilterType.Polygon || this.type === SpatialFilterType.Point) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address && this.formControl.value !== null) {\r\n        return this.loading;\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.selectedThematics.selected.length > 0 && this.formControl.value !== null) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Manage radius value at user change\r\n   */\r\n  getRadius() {\r\n    let formValue;\r\n    this.formControl.value !== null ? formValue = this.formControl.value.radius : formValue = undefined;\r\n    if (this.type === SpatialFilterType.Point) {\r\n      if (!this.freehandDrawIsActive) {\r\n        if (this.radiusFormControl.value >= 10000 || this.radiusFormControl.value < 0) {\r\n          this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.radiusAlert'),\r\n            this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n          this.radius = 1000;\r\n          this.radiusFormControl.setValue(this.radius);\r\n          this.drawGuide$.next(this.radius);\r\n          return;\r\n        }\r\n      } else {\r\n        if (this.radiusFormControl.value >= 10000 || this.radiusFormControl.value < 0) {\r\n          this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.radiusAlert'),\r\n            this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n          this.radius = 1000;\r\n          this.radiusFormControl.setValue(this.radius);\r\n          this.drawGuide$.next(this.radius);\r\n          return;\r\n        }\r\n        if (formValue >= 10000) {\r\n          this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.radiusAlert'),\r\n            this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n          this.formControl.reset();\r\n          return;\r\n        }\r\n        if (formValue) {\r\n          if (formValue !== this.radiusFormControl.value) {\r\n            this.radiusFormControl.setValue(formValue);\r\n          }\r\n          this.formControl.value.radius = undefined;\r\n        }\r\n      }\r\n      this.radius = this.radiusFormControl.value;\r\n      this.drawGuide$.next(this.radius);\r\n      this.overlayStyle$.next(this.PointStyle);\r\n      this.drawStyle$.next(this.PointStyle);\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport {\r\n  MatAutocompleteModule,\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatButtonToggleModule,\r\n  MatSliderModule,\r\n  MatSlideToggleModule,\r\n  MatFormFieldModule,\r\n  MatTableModule,\r\n  MatTreeModule,\r\n  MatInputModule,\r\n  MatOptionModule,\r\n  MatSelectModule,\r\n  MatListModule,\r\n  MatTooltipModule,\r\n  MatDatepickerModule,\r\n  MatNativeDateModule,\r\n  MAT_DATE_LOCALE,\r\n  MatCheckboxModule,\r\n  MatTabsModule,\r\n  MatRadioModule,\r\n  MatMenuModule,\r\n  MatBadgeModule\r\n} from '@angular/material';\r\n\r\nimport {\r\n  MatDatetimepickerModule,\r\n  MatNativeDatetimeModule\r\n} from '@mat-datetimepicker/core';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoKeyValueModule\r\n} from '@igo2/common';\r\nimport { IgoGeometryModule } from './../geometry/geometry.module';\r\n\r\nimport { FilterableDataSourcePipe } from './shared/filterable-datasource.pipe';\r\nimport { IgoLayerModule } from '../layer/layer.module';\r\nimport { TimeFilterButtonComponent } from './time-filter-button/time-filter-button.component';\r\nimport { TimeFilterFormComponent } from './time-filter-form/time-filter-form.component';\r\nimport { TimeFilterItemComponent } from './time-filter-item/time-filter-item.component';\r\nimport { TimeFilterListBindingDirective } from './time-filter-list/time-filter-list-binding.directive';\r\nimport { TimeFilterListComponent } from './time-filter-list/time-filter-list.component';\r\nimport { TimeFilterService } from './shared/time-filter.service';\r\n\r\nimport { OgcFilterFormComponent } from './ogc-filter-form/ogc-filter-form.component';\r\nimport { OgcFilterableFormComponent } from './ogc-filterable-form/ogc-filterable-form.component';\r\nimport { OgcFilterableItemComponent } from './ogc-filterable-item/ogc-filterable-item.component';\r\nimport { OgcFilterableListBindingDirective } from './ogc-filterable-list/ogc-filterable-list-binding.directive';\r\nimport { OgcFilterableListComponent } from './ogc-filterable-list/ogc-filterable-list.component';\r\nimport { OgcFilterButtonComponent } from './ogc-filter-button/ogc-filter-button.component';\r\nimport { OGCFilterService } from './shared/ogc-filter.service';\r\nimport { OgcFilterToggleButtonComponent } from './ogc-filter-toggle-button/ogc-filter-toggle-button.component';\r\n\r\nimport { SpatialFilterTypeComponent } from './spatial-filter/spatial-filter-type/spatial-filter-type.component';\r\nimport { SpatialFilterListComponent } from './spatial-filter/spatial-filter-list/spatial-filter-list.component';\r\nimport { SpatialFilterItemComponent } from './spatial-filter/spatial-filter-item/spatial-filter-item.component';\r\nimport { SpatialFilterService } from './shared/spatial-filter.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatAutocompleteModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTabsModule,\r\n    MatRadioModule,\r\n    MatMenuModule,\r\n    MatTableModule,\r\n    MatTreeModule,\r\n    MatButtonToggleModule,\r\n    MatCheckboxModule,\r\n    MatSliderModule,\r\n    MatSlideToggleModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    MatDatepickerModule,\r\n    MatNativeDateModule,\r\n    MatDatetimepickerModule,\r\n    MatNativeDatetimeModule,\r\n    IgoLanguageModule,\r\n    IgoLayerModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoKeyValueModule,\r\n    IgoGeometryModule,\r\n    MatBadgeModule\r\n  ],\r\n  exports: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterToggleButtonComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent\r\n  ],\r\n  declarations: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterToggleButtonComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent\r\n  ],\r\n  providers: [TimeFilterService, OGCFilterService, SpatialFilterService]\r\n})\r\nexport class IgoFilterModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoFilterModule,\r\n      providers: [\r\n        {\r\n          provide: MAT_DATE_LOCALE,\r\n          useValue: 'fr-FR'\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { Component, Input, ChangeDetectionStrategy } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { LayerOptions, VectorLayer } from '../../layer';\r\n\r\n@Component({\r\n  selector: 'igo-export-button',\r\n  templateUrl: './export-button.component.html',\r\n  styleUrls: ['./export-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ExportButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor() {}\r\n\r\n  get options(): LayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.dataSource.options;\r\n  }\r\n\r\n  layerIsExportable(): boolean {\r\n    if ((this.layer instanceof VectorLayer && this.layer.exportable === true) ||\r\n      (this.layer.dataSource.options.download && this.layer.dataSource.options.download.url)) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","export class ExportError extends Error {}\r\n\r\nexport class ExportInvalidFileError extends ExportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ExportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ExportNothingToExportError extends ExportError {\r\n  constructor() {\r\n    super('Nothing to export');\r\n    Object.setPrototypeOf(this, ExportNothingToExportError.prototype);\r\n  }\r\n}\r\n","import {\r\n  getEntityProperty,\r\n  EntityTableColumn,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { ExportNothingToExportError } from './export.errors';\r\n\r\nexport function handleFileExportError(\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  if (error instanceof ExportNothingToExportError) {\r\n    handleNothingToExportError(messageService, languageService);\r\n    return;\r\n  }\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.failed.title');\r\n  const message = translate.instant('igo.geo.export.failed.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleFileExportSuccess(\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.success.title');\r\n  const message = translate.instant('igo.geo.export.success.text');\r\n  messageService.success(message, title);\r\n}\r\n\r\nexport function handleNothingToExportError(\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.nothing.title');\r\n  const message = translate.instant('igo.geo.export.nothing.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\n/**\r\n * Export array to CSV\r\n *\r\n * @param rows Array of arrays to export as CSV\r\n * @param separator Cell separator\r\n */\r\nexport function exportToCSV(rows: any[][], fileName: string, separator: string = ';') {\r\n  const lines = rows.map((row: any[][], index: number) => row.join(separator));\r\n  const csvContent = lines.join('\\n');\r\n  downloadContent(csvContent, 'text/csv;charset=utf-8', fileName);\r\n}\r\n\r\n/**\r\n * Return an array of values from an array of entities.\r\n *\r\n * @param entities Array of entities\r\n * @param scolumns Columns definition of the output data\r\n */\r\nexport function entitiesToRowData(entities: object[], columns: EntityTableColumn[]) {\r\n  return entities.map((entity: object) => {\r\n    return columns.map((column: EntityTableColumn) => {\r\n      let valueAccessor;\r\n      if (column.renderer === undefined || column.renderer === EntityTableColumnRenderer.Default) {\r\n        valueAccessor = column.valueAccessor;\r\n      }\r\n      valueAccessor = valueAccessor ? valueAccessor : getEntityProperty;\r\n      return valueAccessor(entity, column.name);\r\n    });\r\n  });\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const ExportFormat = strEnum(['GeoJSON', 'GML', 'GPX', 'KML', 'Shapefile', 'CSVcomma', 'CSVsemicolon', 'URL']);\r\nexport type ExportFormat = keyof typeof ExportFormat;\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nimport { ExportFormat } from './export.type';\r\nimport {\r\n  ExportInvalidFileError,\r\n  ExportNothingToExportError\r\n} from './export.errors';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ExportService {\r\n  static ogreFormats = {\r\n    GML: 'gml',\r\n    GPX: 'gpx',\r\n    KML: 'kml',\r\n    Shapefile: 'ESRI Shapefile',\r\n    CSVcomma: 'CSVcomma',\r\n    CSVsemicolon: 'CSVsemicolon'\r\n  };\r\n\r\n  static noOgreFallbacks = ['GML', 'GPX', 'KML'];\r\n\r\n  private ogreUrl: string;\r\n  private aggregateInComment: boolean = true;\r\n\r\n  constructor(private config: ConfigService) {\r\n    this.ogreUrl = this.config.getConfig('importExport.url');\r\n    const gpxAggregateInComment = this.config.getConfig(\r\n      'importExport.gpxAggregateInComment'\r\n    );\r\n    if (gpxAggregateInComment !== undefined) {\r\n      this.aggregateInComment = gpxAggregateInComment;\r\n    }\r\n  }\r\n\r\n  export(\r\n    olFeatures: OlFeature[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<void> {\r\n    const exportOlFeatures = this.generateFeature(olFeatures, format);\r\n\r\n    return this.exportAsync(\r\n      exportOlFeatures,\r\n      format,\r\n      title,\r\n      projectionIn,\r\n      projectionOut\r\n    );\r\n  }\r\n\r\n  private generateFeature(\r\n    olFeatures: OlFeature[],\r\n    format: ExportFormat\r\n  ): OlFeature[] {\r\n    if (format === ExportFormat.GPX && this.aggregateInComment) {\r\n      return this.generateAggratedFeature(olFeatures);\r\n    }\r\n\r\n    return olFeatures.map((olFeature: OlFeature) => {\r\n      const keys = olFeature\r\n        .getKeys()\r\n        .filter((key: string) => !key.startsWith('_'));\r\n      const properties = keys.reduce(\r\n        (acc: object, key: string) => {\r\n          acc[key] = olFeature.get(key);\r\n          return acc;\r\n        },\r\n        { geometry: olFeature.getGeometry() }\r\n      );\r\n      return new OlFeature(properties);\r\n    });\r\n  }\r\n\r\n  private generateAggratedFeature(olFeatures: OlFeature[]): OlFeature[] {\r\n    return olFeatures.map((olFeature: OlFeature) => {\r\n      const keys = olFeature\r\n        .getKeys()\r\n        .filter((key: string) => !key.startsWith('_'));\r\n      let comment: string = '';\r\n      const properties: any[] = keys.reduce(\r\n        (acc: object, key: string) => {\r\n          if (key !== undefined && key !== 'geometry') {\r\n            comment += key + ':' + olFeature.get(key) + '   \\r\\n';\r\n          }\r\n          acc[key] = olFeature.get(key);\r\n          return acc;\r\n        },\r\n        { geometry: olFeature.getGeometry() }\r\n      );\r\n      const newFeature = new OlFeature(properties);\r\n      newFeature.set('name', olFeature.getId());\r\n      newFeature.set('cmt', comment);\r\n\r\n      return newFeature;\r\n    });\r\n  }\r\n\r\n  private exportAsync(\r\n    olFeatures: OlFeature[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<void> {\r\n    const doExport = (observer: Observer<void>) => {\r\n      const nothingToExport = this.nothingToExport(olFeatures, format);\r\n      if (nothingToExport === true) {\r\n        observer.error(new ExportNothingToExportError());\r\n        return;\r\n      }\r\n\r\n      const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n      if (ogreFormats.indexOf(format) >= 0) {\r\n        if (this.ogreUrl === undefined) {\r\n          if (ExportService.noOgreFallbacks.indexOf(format) >= 0) {\r\n            this.exportToFile(\r\n              olFeatures,\r\n              observer,\r\n              format,\r\n              title,\r\n              projectionIn,\r\n              projectionOut\r\n            );\r\n          } else {\r\n            observer.error(new ExportInvalidFileError());\r\n          }\r\n          return;\r\n        }\r\n        this.exportWithOgre(\r\n          olFeatures,\r\n          observer,\r\n          format,\r\n          title,\r\n          projectionIn,\r\n          projectionOut\r\n        );\r\n      } else {\r\n        this.exportToFile(\r\n          olFeatures,\r\n          observer,\r\n          format,\r\n          title,\r\n          projectionIn,\r\n          projectionOut\r\n        );\r\n      }\r\n    };\r\n\r\n    return new Observable(doExport);\r\n  }\r\n\r\n  protected exportToFile(\r\n    olFeatures: OlFeature[],\r\n    observer: Observer<void>,\r\n    format: ExportFormat,\r\n    title: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const olFormat = new olformat[format]();\r\n    const featuresText = olFormat.writeFeatures(olFeatures, {\r\n      dataProjection: projectionOut,\r\n      featureProjection: projectionIn,\r\n      featureType: 'feature',\r\n      featureNS: 'http://example.com/feature'\r\n    });\r\n\r\n    const fileName = `${title}.${format.toLowerCase()}`;\r\n\r\n    downloadContent(featuresText, 'text/plain;charset=utf-8', fileName);\r\n    observer.complete();\r\n  }\r\n\r\n  private exportWithOgre(\r\n    olFeatures: OlFeature[],\r\n    observer: Observer<void>,\r\n    format: string,\r\n    title: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const featuresText: string = new olformat.GeoJSON().writeFeatures(\r\n      olFeatures,\r\n      {\r\n        dataProjection: projectionOut,\r\n        featureProjection: projectionIn,\r\n        featureType: 'feature',\r\n        featureNS: 'http://example.com/feature'\r\n      }\r\n    );\r\n\r\n    const url = `${this.ogreUrl}/convertJson`;\r\n    const form = document.createElement('form');\r\n    form.style.display = 'none';\r\n    document.body.appendChild(form);\r\n    form.setAttribute('method', 'post');\r\n    form.setAttribute('target', '_blank');\r\n    form.setAttribute('action', url);\r\n\r\n    form.acceptCharset = 'UTF-8';\r\n    form.enctype = 'application/x-www-form-urlencoded; charset=utf-8;';\r\n\r\n    if (format === 'CSVsemicolon') {\r\n      const options = document.createElement('input');\r\n      options.setAttribute('type', 'hidden');\r\n      options.setAttribute('name', 'lco');\r\n      options.setAttribute('value', 'SEPARATOR=SEMICOLON');\r\n      form.appendChild(options);\r\n    }\r\n\r\n    const geojsonField = document.createElement('input');\r\n    geojsonField.setAttribute('type', 'hidden');\r\n    geojsonField.setAttribute('name', 'json');\r\n    geojsonField.setAttribute('value', featuresText);\r\n    form.appendChild(geojsonField);\r\n\r\n    const outputNameField = document.createElement('input');\r\n    let outputName =\r\n      format === 'Shapefile'\r\n        ? `${title}.zip`\r\n        : `${title}.${format.toLowerCase()}`;\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      outputName = `${title}.csv`;\r\n    }\r\n    outputName = outputName.replace(' ', '_');\r\n    outputName = outputName.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n    outputNameField.setAttribute('type', 'hidden');\r\n    outputNameField.setAttribute('name', 'outputName');\r\n    outputNameField.setAttribute('value', outputName);\r\n    form.appendChild(outputNameField);\r\n\r\n    let ogreFormat = ExportService.ogreFormats[format];\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      ogreFormat = 'CSV';\r\n    }\r\n    const outputFormatField = document.createElement('input');\r\n    outputFormatField.setAttribute('type', 'hidden');\r\n    outputFormatField.setAttribute('name', 'format');\r\n    outputFormatField.setAttribute('value', ogreFormat);\r\n    form.appendChild(outputFormatField);\r\n\r\n    form.submit();\r\n    document.body.removeChild(form);\r\n\r\n    observer.complete();\r\n  }\r\n\r\n  private nothingToExport(olFeatures: OlFeature[], format: string): boolean {\r\n    if (olFeatures.length === 0) {\r\n      return true;\r\n    }\r\n    if (format === 'GPX') {\r\n      const pointOrLine = olFeatures.find(olFeature => {\r\n        return (\r\n          ['Point', 'LineString', 'MultiLineString'].indexOf(olFeature.getGeometry().getType()) >=\r\n          0\r\n        );\r\n      });\r\n      return pointOrLine === undefined;\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","export class ImportError extends Error {}\r\n\r\nexport class ImportInvalidFileError extends ImportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ImportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportUnreadableFileError extends ImportError {\r\n  constructor() {\r\n      super('Failed to read file');\r\n      Object.setPrototypeOf(this, ImportUnreadableFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportNothingToImportError extends ImportError {\r\n  constructor() {\r\n      super('Nothing to import');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSizeError extends ImportError {\r\n  constructor() {\r\n      super('File is too large');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSRSError extends ImportError {\r\n  constructor() {\r\n      super('Invalid SRS definition');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n","import * as olStyle from 'ol/style';\r\n\r\nimport { MessageService, LanguageService, ConfigService } from '@igo2/core';\r\n\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { FeatureDataSourceOptions } from '../../datasource/shared/datasources/feature-datasource.interface';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { featureToOl, moveToOlFeatures } from '../../feature/shared/feature.utils';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { StyleByAttribute } from '../../layer/shared/vector-style.interface';\r\nimport { StyleListService } from '../style-list/style-list.service';\r\nimport { ClusterParam } from '../../layer/shared/clusterParam';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { ClusterDataSourceOptions } from '../../datasource/shared/datasources/cluster-datasource.interface';\r\n\r\nexport function addLayerAndFeaturesToMap(features: Feature[], map: IgoMap, layerTitle: string): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) => featureToOl(feature, map.projection));\r\n\r\n  const r = Math.floor(Math.random() * 255);\r\n  const g = Math.floor(Math.random() * 255);\r\n  const b = Math.floor(Math.random() * 255);\r\n  const stroke = new olStyle.Stroke({\r\n    color: [r, g, b, 1],\r\n    width: 2\r\n  });\r\n\r\n  const fill = new olStyle.Fill({\r\n    color: [r, g, b, 0.4]\r\n  });\r\n  const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n    type: 'vector',\r\n    queryable: true\r\n  };\r\n  const source = new FeatureDataSource(sourceOptions);\r\n  source.ol.addFeatures(olFeatures);\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    source,\r\n    style: new olStyle.Style({\r\n      stroke,\r\n      fill,\r\n      image: new olStyle.Circle({\r\n        radius: 5,\r\n        stroke,\r\n        fill\r\n      })\r\n    })\r\n  });\r\n  map.addLayer(layer);\r\n  moveToOlFeatures(map, olFeatures);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function addLayerAndFeaturesStyledToMap(features: Feature[], map: IgoMap, layerTitle: string,\r\n                                               styleListService: StyleListService, styleService: StyleService): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) => featureToOl(feature, map.projection));\r\n  let style;\r\n  let distance: number;\r\n\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute')) {\r\n    const styleByAttribute: StyleByAttribute = styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute');\r\n\r\n    style = feature => {\r\n      return styleService.createStyleByAttribute(\r\n        feature,\r\n        styleByAttribute\r\n      );\r\n    };\r\n\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(layerTitle.toString() + '.clusterParam');\r\n    distance = styleListService.getStyleList(layerTitle.toString() + '.distance');\r\n\r\n    const baseStyle = styleService.createStyle(styleListService.getStyleList(layerTitle.toString() + '.clusterStyle'));\r\n\r\n    style = feature => {\r\n      return styleService.createClusterStyle(\r\n        feature,\r\n        clusterParam,\r\n        baseStyle\r\n      );\r\n    };\r\n\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.style')) {\r\n\r\n    style = styleService.createStyle(styleListService.getStyleList(layerTitle.toString() + '.style'));\r\n\r\n  } else if (styleListService.getStyleList('default.clusterStyle') && features[0].geometry.type === 'Point') {\r\n      const clusterParam: ClusterParam = styleListService.getStyleList('default.clusterParam');\r\n      distance = styleListService.getStyleList('default.distance');\r\n\r\n      const baseStyle = styleService.createStyle(styleListService.getStyleList('default.clusterStyle'));\r\n\r\n      style = feature => {\r\n        return styleService.createClusterStyle(\r\n          feature,\r\n          clusterParam,\r\n          baseStyle\r\n        );\r\n      };\r\n  } else {\r\n    style = styleService.createStyle(styleListService.getStyleList('default.style'));\r\n  }\r\n\r\n  let source;\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const sourceOptions: ClusterDataSourceOptions & QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(sourceOptions);\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else if (styleListService.getStyleList(layerTitle.toString())) {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(sourceOptions);\r\n    source.ol.addFeatures(olFeatures);\r\n  } else if (styleListService.getStyleList('default.clusterStyle') && features[0].geometry.type === 'Point') {\r\n    const sourceOptions: ClusterDataSourceOptions & QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(sourceOptions);\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(sourceOptions);\r\n    source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    source,\r\n    style\r\n  });\r\n  map.addLayer(layer);\r\n  moveToOlFeatures(map, olFeatures);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function handleFileImportSuccess(\r\n  file: File,\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  styleListService?: StyleListService,\r\n  styleService?: StyleService\r\n) {\r\n  if (features.length === 0) {\r\n    handleNothingToImportError(file, messageService, languageService);\r\n    return;\r\n  }\r\n\r\n  const layerTitle = computeLayerTitleFromFile(file);\r\n\r\n  if (!styleListService) {\r\n    addLayerAndFeaturesToMap(features, map, layerTitle);\r\n  } else {\r\n    addLayerAndFeaturesStyledToMap(features, map, layerTitle, styleListService, styleService);\r\n  }\r\n\r\n  const translate = languageService.translate;\r\n  const messageTitle = translate.instant('igo.geo.dropGeoFile.success.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.success.text', {\r\n      value: layerTitle\r\n  });\r\n  messageService.success(message, messageTitle);\r\n}\r\n\r\nexport function handleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb?: number\r\n) {\r\n  sizeMb = sizeMb ? sizeMb : 30;\r\n  const errMapping = {\r\n    'Invalid file': handleInvalidFileImportError,\r\n    'File is too large': handleSizeFileImportError,\r\n    'Failed to read file': handleUnreadbleFileImportError,\r\n    'Invalid SRS definition': handleSRSImportError\r\n  };\r\n  errMapping[error.message](file, error, messageService, languageService, sizeMb);\r\n}\r\n\r\nexport function handleInvalidFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.invalid.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.invalid.text', {\r\n      value: file.name,\r\n      mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleUnreadbleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.unreadable.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.unreadable.text', {\r\n      value: file.name\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSizeFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb: number\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.tooLarge.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.tooLarge.text', {\r\n      value: file.name,\r\n      size: sizeMb\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleNothingToImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.empty.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.empty.text', {\r\n      value: file.name,\r\n      mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSRSImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.invalidSRS.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.invalidSRS.text', {\r\n      value: file.name,\r\n      mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function getFileExtension(file: File): string {\r\n  return file.name.split('.').pop().toLowerCase();\r\n}\r\n\r\nexport function computeLayerTitleFromFile(file: File): string {\r\n  return file.name.substr(0, file.name.lastIndexOf('.'));\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport {\r\n  ImportInvalidFileError,\r\n  ImportUnreadableFileError,\r\n  ImportSizeError,\r\n  ImportSRSError\r\n} from './import.errors';\r\nimport { computeLayerTitleFromFile, getFileExtension } from './import.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ImportService {\r\n  static allowedMimeTypes = [\r\n    'application/gml+xml',\r\n    'application/vnd.google-earth.kml+xml',\r\n    'application/gpx+xml',\r\n    'application/json'\r\n  ];\r\n\r\n  static allowedZipMimeTypes = [\r\n    'application/zip',\r\n    'application/x-zip-compressed',\r\n    'application/x-zip'\r\n  ];\r\n\r\n  static allowedExtensions = ['geojson', 'kml', 'gpx', 'json', 'gml'];\r\n\r\n  private ogreUrl: string;\r\n  private clientSideFileSizeMax: number;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    this.ogreUrl = this.config.getConfig('importExport.url');\r\n    const configFileSizeMb = this.config.getConfig('importExport.clientSideFileSizeMaxMb');\r\n    this.clientSideFileSizeMax = (configFileSizeMb ? configFileSizeMb : 30) *  Math.pow(1024, 2);\r\n  }\r\n\r\n  import(\r\n    file: File,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<Feature[]> {\r\n    return this.importAsync(file, projectionIn, projectionOut);\r\n  }\r\n\r\n  private getFileImporter(\r\n    file: File\r\n  ): (\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) => void {\r\n    const extension = getFileExtension(file);\r\n    const mimeType = file.type;\r\n    const allowedMimeTypes = [\r\n      ...ImportService.allowedMimeTypes,\r\n      ...ImportService.allowedZipMimeTypes\r\n    ];\r\n    const allowedExtensions = ImportService.allowedExtensions;\r\n\r\n    if (\r\n      allowedMimeTypes.indexOf(mimeType) < 0 &&\r\n      allowedExtensions.indexOf(extension) < 0\r\n    ) {\r\n      return undefined;\r\n    } else if (\r\n      mimeType === 'application/json' ||\r\n      ['json', 'geojson', 'kml', 'gpx'].indexOf(extension) >= 0\r\n    ) {\r\n      return this.importFile;\r\n    } else if (this.ogreUrl !== undefined) {\r\n      return this.importFileWithOgre;\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  private importAsync(\r\n    file: File,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<Feature[]> {\r\n    const doImport = (observer: Observer<Feature[]>) => {\r\n      if (file.size >= this.clientSideFileSizeMax) {\r\n        observer.error(new ImportSizeError());\r\n        return;\r\n      }\r\n      const importer = this.getFileImporter(file);\r\n      if (importer === undefined) {\r\n        observer.error(new ImportInvalidFileError());\r\n        return;\r\n      }\r\n\r\n      importer.call(this, file, observer, projectionIn, projectionOut);\r\n    };\r\n\r\n    return new Observable(doImport);\r\n  }\r\n\r\n  private importFile(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const reader = new FileReader();\r\n\r\n    reader.onload = (event: any) => {\r\n      try {\r\n        const features = this.parseFeaturesFromFile(\r\n          file,\r\n          event.target.result,\r\n          projectionIn,\r\n          projectionOut\r\n        );\r\n        observer.next(features);\r\n      } catch (e) {\r\n        observer.error(new ImportUnreadableFileError());\r\n      }\r\n\r\n      observer.complete();\r\n    };\r\n\r\n    reader.onerror = evt => {\r\n      observer.error(new ImportUnreadableFileError());\r\n    };\r\n\r\n    reader.readAsText(file, 'UTF-8');\r\n  }\r\n\r\n  private importFileWithOgre(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const url = `${this.ogreUrl}/convert`;\r\n    const formData = new FormData();\r\n    formData.append('upload', file);\r\n    formData.append('sourceSrs', projectionIn);\r\n    formData.append('targetSrs', projectionOut);\r\n    formData.append('formatOutput', 'GEOJSON');\r\n    formData.append('skipFailures', '');\r\n\r\n    this.http.post(url, formData, { headers: new HttpHeaders() }).subscribe(\r\n      (response: { errors?: string[] } | object | null) => {\r\n        if (response === null) {\r\n          observer.error(new ImportUnreadableFileError());\r\n          return;\r\n        }\r\n\r\n        const errors = (response as any).errors || [];\r\n        if (errors.length > 0) {\r\n          observer.error(new ImportUnreadableFileError());\r\n        } else {\r\n          const features = this.parseFeaturesFromGeoJSON(\r\n            file,\r\n            response,\r\n            projectionOut\r\n          );\r\n          observer.next(features);\r\n          observer.complete();\r\n        }\r\n      },\r\n      (error: any) => {\r\n        error.error.caught = true;\r\n        const errMsg = error.error.msg || '';\r\n        if (errMsg === 'No valid files found') {\r\n          observer.error(new ImportInvalidFileError());\r\n        } else if (\r\n          errMsg.startWith('ERROR 1: Failed to process SRS definition')\r\n        ) {\r\n          observer.error(new ImportSRSError());\r\n        } else {\r\n          observer.error(new ImportUnreadableFileError());\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  private parseFeaturesFromFile(\r\n    file: File,\r\n    data: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const extension = getFileExtension(file);\r\n    const mimeType = file.type;\r\n\r\n    const GeoJSON = new olformat.GeoJSON();\r\n\r\n    let format;\r\n    if (mimeType === 'application/vnd.google-earth.kml+xml') {\r\n      format = new olformat.KML();\r\n    } else if (mimeType === 'application/gml+xml') {\r\n      format = new olformat.GML();\r\n    } else if (mimeType === 'application/gpx+xml') {\r\n      format = new olformat.GPX();\r\n    } else {\r\n      switch (extension) {\r\n        case 'kml':\r\n          format = new olformat.KML();\r\n          break;\r\n        case 'gpx':\r\n          format = new olformat.GPX();\r\n          break;\r\n        case 'gml':\r\n          format = new olformat.GML();\r\n          break;\r\n        default:\r\n          format = GeoJSON;\r\n          break;\r\n      }\r\n    }\r\n\r\n    const olFeatures = format.readFeatures(data, {\r\n      dataProjection: projectionIn,\r\n      featureProjection: projectionOut\r\n    });\r\n    const features = olFeatures.map((olFeature: OlFeature) => {\r\n      return Object.assign(GeoJSON.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features;\r\n  }\r\n\r\n  private parseFeaturesFromGeoJSON(\r\n    file: File,\r\n    data: object,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const olFormat = new olformat.GeoJSON();\r\n    const olFeatures = olFormat.readFeatures(data);\r\n    const features = olFeatures.map((olFeature: OlFeature) => {\r\n      return Object.assign(olFormat.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features;\r\n  }\r\n}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleListService {\r\n  private styleList: object = {};\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  /**\r\n   * Use to get the data found in styleList file\r\n   */\r\n  public getStyleList(key: string): any {\r\n    return ObjectUtils.resolve(this.styleList, key);\r\n  }\r\n\r\n  /**\r\n   * This method loads \"[path]\" to get all styleList's variables\r\n   */\r\n  public load(options: StyleListOptions) {\r\n    const baseStyleList = options.default || {};\r\n    if (!options.path) {\r\n      this.styleList = baseStyleList;\r\n      return true;\r\n    }\r\n\r\n    const http = this.injector.get(HttpClient);\r\n\r\n    return new Promise((resolve, _reject) => {\r\n      http\r\n        .get(options.path)\r\n        .pipe(\r\n          catchError((error: any): any => {\r\n            console.log(`StyleList file ${options.path} could not be read`);\r\n            resolve(true);\r\n            return throwError(error.error || 'Server error');\r\n          })\r\n        )\r\n        .subscribe(styleListResponse => {\r\n          this.styleList = ObjectUtils.mergeDeep(baseStyleList, styleListResponse);\r\n          resolve(true);\r\n        });\r\n    });\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { FormGroup, FormBuilder, Validators } from '@angular/forms';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MessageService, LanguageService, ConfigService } from '@igo2/core';\r\nimport { strEnum } from '@igo2/utils';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\n\r\nimport {\r\n  handleFileExportError,\r\n  handleFileExportSuccess\r\n} from '../shared/export.utils';\r\nimport { ExportOptions } from '../shared/export.interface';\r\nimport { ExportFormat } from '../shared/export.type';\r\nimport { ExportService } from '../shared/export.service';\r\nimport { ImportService } from '../shared/import.service';\r\nimport {\r\n  handleFileImportSuccess,\r\n  handleFileImportError\r\n} from '../shared/import.utils';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { StyleListService } from '../style-list/style-list.service';\r\nimport { MatTabChangeEvent } from '@angular/material';\r\nimport { skipWhile } from 'rxjs/operators';\r\n\r\n@Component({\r\n  selector: 'igo-import-export',\r\n  templateUrl: './import-export.component.html',\r\n  styleUrls: ['./import-export.component.scss']\r\n})\r\nexport class ImportExportComponent implements OnDestroy, OnInit {\r\n  public form: FormGroup;\r\n  public formats$ = new BehaviorSubject(undefined);\r\n  public exportableLayers$: BehaviorSubject<AnyLayer[]> = new BehaviorSubject(\r\n    []\r\n  );\r\n  public inputProj: string = 'EPSG:4326';\r\n  public loading$ = new BehaviorSubject(false);\r\n  public forceNaming = false;\r\n\r\n  private layers$$: Subscription;\r\n  private exportableLayers$$: Subscription;\r\n  private formats$$: Subscription;\r\n  private formLayer$$: Subscription;\r\n  private exportOptions$$: Subscription;\r\n\r\n  private espgCodeRegex = new RegExp('^\\\\d{4,6}');\r\n  private clientSideFileSizeMax: number;\r\n  public activeImportExport: string = 'import';\r\n  public fileSizeMb: number;\r\n\r\n  private previousLayerSpecs$: BehaviorSubject<\r\n    {\r\n      id: string;\r\n      visible: boolean;\r\n      opacity: number;\r\n      queryable: boolean;\r\n    }[]\r\n  > = new BehaviorSubject(undefined);\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() selectedIndex: number = 0;\r\n\r\n  @Output() selectedTabIndex = new EventEmitter<number>();\r\n\r\n  @Input() exportOptions$: BehaviorSubject<ExportOptions> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  @Output() exportOptionsChange = new EventEmitter<ExportOptions>();\r\n\r\n  constructor(\r\n    private importService: ImportService,\r\n    private exportService: ExportService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    private formBuilder: FormBuilder,\r\n    private config: ConfigService\r\n  ) {\r\n    this.loadConfig();\r\n    this.buildForm();\r\n    console.log(this);\r\n    console.log(this.form);\r\n    console.log(this.form);\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      this.exportableLayers$.next(\r\n        layers.filter((layer: Layer) => {\r\n          return (\r\n            (layer instanceof VectorLayer && layer.exportable === true) ||\r\n            (layer.dataSource.options.download &&\r\n              layer.dataSource.options.download.url)\r\n          );\r\n        }) as AnyLayer[]\r\n      );\r\n    });\r\n    const configFileSizeMb = this.config.getConfig(\r\n      'importExport.clientSideFileSizeMaxMb'\r\n    );\r\n    this.clientSideFileSizeMax =\r\n      (configFileSizeMb ? configFileSizeMb : 30) * Math.pow(1024, 2);\r\n    this.fileSizeMb = this.clientSideFileSizeMax / Math.pow(1024, 2);\r\n\r\n    this.exportOptions$$ = this.exportOptions$\r\n      .pipe(skipWhile((exportOptions) => !exportOptions))\r\n      .subscribe((exportOptions) => {\r\n        this.form.patchValue(exportOptions, { emitEvent: true });\r\n        if (exportOptions.layer) {\r\n          this.computeFormats(\r\n            exportOptions.layer.map((l) => this.map.getLayerById(l))\r\n          );\r\n        }\r\n      });\r\n\r\n    this.formLayer$$ = this.form\r\n      .get('layer')\r\n      .valueChanges.subscribe((layerId) => {\r\n        this.handlePreviousLayerSpecs();\r\n        const layers = layerId.map((l) => this.map.getLayerById(l));\r\n        this.computeFormats(layers);\r\n\r\n        if (\r\n          Object.keys(this.formats$.value).indexOf(this.form.value.format) ===\r\n          -1\r\n        ) {\r\n          this.form.patchValue({ format: undefined });\r\n        }\r\n\r\n        this.loading$.next(true);\r\n        const previousSpecs: {\r\n          id: string;\r\n          visible: boolean;\r\n          opacity: number;\r\n          queryable: boolean;\r\n        }[] = [];\r\n        layers.forEach((layer) => {\r\n          if (\r\n            layer instanceof VectorLayer &&\r\n            layer.dataSource.ol.getFeatures().length === 0\r\n          ) {\r\n            previousSpecs.push({\r\n              id: layer.id,\r\n              visible: layer.visible,\r\n              opacity: layer.opacity,\r\n              queryable: (layer as any).queryable\r\n            });\r\n            layer.opacity = 0;\r\n            layer.visible = true;\r\n          }\r\n        });\r\n\r\n        this.previousLayerSpecs$.next(previousSpecs);\r\n        setTimeout(() => {\r\n          this.loading$.next(false);\r\n        }, 500);\r\n      });\r\n\r\n    this.formats$$ = this.formats$\r\n      .pipe(skipWhile((formats) => !formats))\r\n      .subscribe((formats) => {\r\n        if (Object.keys(formats).length === 1) {\r\n          this.form.patchValue({ format: formats[Object.keys(formats)[0]] });\r\n        }\r\n      });\r\n\r\n    this.exportableLayers$$ = this.exportableLayers$\r\n      .pipe(skipWhile((layers) => !layers))\r\n      .subscribe((layers) => {\r\n        if (layers.length === 1) {\r\n          this.form.patchValue({ layer: layers[0].id });\r\n        }\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n    this.exportableLayers$$.unsubscribe();\r\n    this.formats$$.unsubscribe();\r\n    this.formLayer$$.unsubscribe();\r\n    if (this.exportOptions$$) {\r\n      this.exportOptions$$.unsubscribe();\r\n    }\r\n    this.exportOptionsChange.emit(this.form.value);\r\n    this.handlePreviousLayerSpecs();\r\n  }\r\n\r\n  private handlePreviousLayerSpecs() {\r\n    const previousSpecs = this.previousLayerSpecs$.value;\r\n    if (previousSpecs && previousSpecs.length) {\r\n      previousSpecs.forEach((specs) => {\r\n        const previousLayer = this.map.getLayerById(specs.id);\r\n        previousLayer.visible = specs.visible;\r\n        previousLayer.opacity = specs.opacity;\r\n        (previousLayer as any).queryable = specs.queryable;\r\n      });\r\n    }\r\n    this.previousLayerSpecs$.next(undefined);\r\n  }\r\n\r\n  importFiles(files: File[]) {\r\n    let inputProj = this.inputProj;\r\n    if (this.espgCodeRegex.test(inputProj)) {\r\n      inputProj = `EPSG:${inputProj}`;\r\n    }\r\n\r\n    this.loading$.next(true);\r\n    for (const file of files) {\r\n      this.importService.import(file, inputProj).subscribe(\r\n        (features: Feature[]) => this.onFileImportSuccess(file, features),\r\n        (error: Error) => this.onFileImportError(file, error),\r\n        () => {\r\n          this.loading$.next(false);\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  handleExportFormSubmit(data: ExportOptions) {\r\n    this.loading$.next(true);\r\n    data.layer.forEach((layer) => {\r\n      const lay = this.map.getLayerById(layer);\r\n      let filename = lay.title;\r\n      if (data.name !== undefined) {\r\n        filename = data.name;\r\n      }\r\n      const dSOptions: DataSourceOptions = lay.dataSource.options;\r\n      if (\r\n        data.format === ExportFormat.URL &&\r\n        dSOptions.download &&\r\n        dSOptions.download.url\r\n      ) {\r\n        setTimeout(() => {\r\n          // better look an feel\r\n          window.open(dSOptions.download.url, '_blank');\r\n          this.loading$.next(false);\r\n        }, 500);\r\n        return;\r\n      }\r\n\r\n      let olFeatures;\r\n      if (data.featureInMapExtent) {\r\n        olFeatures = lay.dataSource.ol.getFeaturesInExtent(\r\n          lay.map.viewController.getExtent()\r\n        );\r\n      } else {\r\n        olFeatures = lay.dataSource.ol.getFeatures();\r\n      }\r\n      if (lay.dataSource instanceof ClusterDataSource) {\r\n        olFeatures = olFeatures.flatMap((cluster: any) =>\r\n          cluster.get('features')\r\n        );\r\n      }\r\n\r\n      this.exportService\r\n        .export(olFeatures, data.format, filename, this.map.projection)\r\n        .subscribe(\r\n          () => {},\r\n          (error: Error) => this.onFileExportError(error),\r\n          () => {\r\n            this.onFileExportSuccess();\r\n            this.loading$.next(false);\r\n          }\r\n        );\r\n    });\r\n  }\r\n\r\n  private buildForm() {\r\n    if (this.forceNaming) {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layer: ['', [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]],\r\n        name: ['', [Validators.required]]\r\n      });\r\n    } else {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layer: ['', [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]]\r\n      });\r\n    }\r\n  }\r\n\r\n  private onFileImportSuccess(file: File, features: Feature[]) {\r\n    if (!this.config.getConfig('importWithStyle')) {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.messageService,\r\n        this.languageService\r\n      );\r\n    } else {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.messageService,\r\n        this.languageService,\r\n        this.styleListService,\r\n        this.styleService\r\n      );\r\n    }\r\n  }\r\n\r\n  private onFileImportError(file: File, error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileImportError(\r\n      file,\r\n      error,\r\n      this.messageService,\r\n      this.languageService,\r\n      this.fileSizeMb\r\n    );\r\n  }\r\n\r\n  private onFileExportError(error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileExportError(error, this.messageService, this.languageService);\r\n  }\r\n\r\n  private loadConfig() {\r\n    if (this.config.getConfig('importExport.forceNaming') !== undefined) {\r\n      this.forceNaming = this.config.getConfig('importExport.forceNaming');\r\n    }\r\n    this.computeFormats();\r\n  }\r\n\r\n  private computeFormats(layers?: AnyLayer[]) {\r\n    if (layers && layers.length) {\r\n      const formatsType = {\r\n        onlyUrl: false,\r\n        onlyVector: false,\r\n        vectorAndUrl: false\r\n      };\r\n      layers.forEach((layer) => {\r\n        if (!layer) {\r\n          return;\r\n        }\r\n        if (\r\n          !(layer instanceof VectorLayer) &&\r\n          layer.dataSource.options.download &&\r\n          layer.dataSource.options.download.url\r\n        ) {\r\n          formatsType.onlyUrl = true;\r\n        } else if (\r\n          layer.dataSource.options.download &&\r\n          layer.dataSource.options.download.url\r\n        ) {\r\n          formatsType.vectorAndUrl = true;\r\n        } else if (layer instanceof VectorLayer) {\r\n          formatsType.onlyVector = true;\r\n        }\r\n      });\r\n\r\n      if (formatsType.onlyUrl === true && formatsType.onlyVector === false) {\r\n        this.formats$.next(strEnum(['URL']));\r\n      } else if (\r\n        formatsType.onlyVector === true &&\r\n        formatsType.onlyUrl === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (ExportFormat.URL in this.formats$.value) {\r\n          const keys = Object.keys(this.formats$.value).filter(\r\n            (key) => key !== 'URL'\r\n          );\r\n          this.formats$.next(strEnum(keys));\r\n        }\r\n      } else if (\r\n        formatsType.vectorAndUrl === true &&\r\n        formatsType.onlyUrl === false &&\r\n        formatsType.onlyVector === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (!(ExportFormat.URL in this.formats$.value)) {\r\n          const keys = Object.keys(this.formats$.value);\r\n          keys.push('URL');\r\n          this.formats$.next(strEnum(keys));\r\n        }\r\n      } else {\r\n        this.formats$.next([]);\r\n        this.messageService.alert(\r\n          this.languageService.translate.instant(\r\n            'igo.geo.export.noFormat.text'\r\n          ),\r\n          this.languageService.translate.instant(\r\n            'igo.geo.export.noFormat.title'\r\n          )\r\n        );\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (this.config.getConfig('importExport.formats') !== undefined) {\r\n      const validatedListFormat = this.validateListFormat(\r\n        this.config.getConfig('importExport.formats')\r\n      );\r\n      this.formats$.next(strEnum(validatedListFormat));\r\n    } else {\r\n      this.formats$.next(ExportFormat);\r\n    }\r\n  }\r\n\r\n  private validateListFormat(formats: string[]): string[] {\r\n    return formats\r\n      .filter((format) => {\r\n        if (\r\n          format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GPX.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.KML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.Shapefile.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.URL.toUpperCase()\r\n        ) {\r\n          return format;\r\n        }\r\n      })\r\n      .map((format) => {\r\n        if (format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase()) {\r\n          format = ExportFormat.CSVcomma;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase()) {\r\n          format = ExportFormat.CSVsemicolon;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GML.toUpperCase()) {\r\n          format = ExportFormat.GML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GPX.toUpperCase()) {\r\n          format = ExportFormat.GPX;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase()) {\r\n          format = ExportFormat.GeoJSON;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.KML.toUpperCase()) {\r\n          format = ExportFormat.KML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.Shapefile.toUpperCase()) {\r\n          format = ExportFormat.Shapefile;\r\n          return format;\r\n        }\r\n\r\n        if (format.toUpperCase() === ExportFormat.URL.toUpperCase()) {\r\n          format = ExportFormat.URL;\r\n          return format;\r\n        }\r\n      });\r\n  }\r\n\r\n  public tabChanged(tab: MatTabChangeEvent) {\r\n    this.selectedTabIndex.emit(tab.index);\r\n  }\r\n\r\n  private onFileExportSuccess() {\r\n    handleFileExportSuccess(this.messageService, this.languageService);\r\n  }\r\n\r\n  onImportExportChange(event) {\r\n    this.activeImportExport = event.value;\r\n  }\r\n}\r\n","import { Directive, HostListener, EventEmitter, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { MessageService, LanguageService, ConfigService } from '@igo2/core';\r\nimport { DragAndDropDirective } from '@igo2/common';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { ImportService } from './import.service';\r\nimport { handleFileImportSuccess, handleFileImportError } from '../shared/import.utils';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { StyleListService } from '../style-list/style-list.service';\r\n\r\n@Directive({\r\n  selector: '[igoDropGeoFile]'\r\n})\r\nexport class DropGeoFileDirective extends DragAndDropDirective implements OnInit, OnDestroy {\r\n\r\n  protected filesDropped: EventEmitter<File[]> = new EventEmitter();\r\n  protected filesInvalid: EventEmitter<File[]> = new EventEmitter();\r\n\r\n  private filesDropped$$: Subscription;\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    private component: MapBrowserComponent,\r\n    private importService: ImportService,\r\n    private languageService: LanguageService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    private config: ConfigService,\r\n    private messageService: MessageService\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.filesDropped$$ = this.filesDropped.subscribe((files: File[]) => {\r\n      this.onFilesDropped(files);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.filesDropped$$.unsubscribe();\r\n  }\r\n\r\n  @HostListener('dragover', ['$event'])\r\n  public onDragOver(evt) {\r\n    super.onDragOver(evt);\r\n  }\r\n\r\n  @HostListener('dragleave', ['$event'])\r\n  public onDragLeave(evt) {\r\n    super.onDragLeave(evt);\r\n  }\r\n\r\n  @HostListener('drop', ['$event'])\r\n  public onDrop(evt) {\r\n    super.onDrop(evt);\r\n  }\r\n\r\n  private onFilesDropped(files: File[]) {\r\n    for (const file of files) {\r\n      this.importService\r\n        .import(file)\r\n        .subscribe(\r\n          (features: Feature[]) => this.onFileImportSuccess(file, features),\r\n          (error: Error) => this.onFileImportError(file, error)\r\n        );\r\n    }\r\n  }\r\n\r\n  private onFileImportSuccess(file: File, features: Feature[]) {\r\n    if (!this.config.getConfig('importWithStyle')) {\r\n      handleFileImportSuccess(file, features, this.map, this.messageService, this.languageService);\r\n    } else {\r\n      handleFileImportSuccess(file, features, this.map, this.messageService, this.languageService,\r\n                               this.styleListService, this.styleService);\r\n    }\r\n  }\r\n\r\n  private onFileImportError(file: File, error: Error) {\r\n    handleFileImportError(file, error, this.messageService, this.languageService, this.config.getConfig('importExport.clientSideFileSizeMaxMb'));\r\n  }\r\n}\r\n","import { APP_INITIALIZER, InjectionToken } from '@angular/core';\r\n\r\nimport { StyleListService } from './style-list.service';\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\nexport let STYLELIST_OPTIONS = new InjectionToken<StyleListOptions>('styleListOptions');\r\n\r\nexport function provideStyleListOptions(options: StyleListOptions) {\r\n  return {\r\n    provide: STYLELIST_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\nexport function styleListFactory(\r\n  styleListService: StyleListService,\r\n  options: StyleListOptions\r\n) {\r\n  return () => styleListService.load(options);\r\n}\r\n\r\nexport function provideStyleListLoader() {\r\n  return {\r\n    provide: APP_INITIALIZER,\r\n    useFactory: styleListFactory,\r\n    multi: true,\r\n    deps: [StyleListService, STYLELIST_OPTIONS]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { provideStyleListOptions, provideStyleListLoader } from './style-list.provider';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoStyleListModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoStyleListModule,\r\n      providers: [provideStyleListOptions({}), provideStyleListLoader()]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { CommonModule } from '@angular/common';\r\nimport {\r\n  MatButtonModule,\r\n  MatTabsModule,\r\n  MatSelectModule,\r\n  MatOptionModule,\r\n  MatFormFieldModule,\r\n  MatInputModule,\r\n  MatSlideToggleModule,\r\n  MatIconModule,\r\n  MatTooltipModule,\r\n  MatButtonToggleModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule, IgoDrapDropModule, IgoSpinnerModule } from '@igo2/common';\r\n\r\nimport { ExportButtonComponent } from './export-button/export-button.component';\r\nimport { ImportExportComponent } from './import-export/import-export.component';\r\nimport { DropGeoFileDirective } from './shared/drop-geo-file.directive';\r\nimport { IgoStyleListModule } from './style-list/style-list.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatTabsModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoSpinnerModule,\r\n    IgoKeyValueModule,\r\n    IgoDrapDropModule,\r\n    IgoStyleListModule.forRoot()\r\n  ],\r\n  exports: [ImportExportComponent, DropGeoFileDirective, IgoStyleListModule, ExportButtonComponent],\r\n  declarations: [ImportExportComponent, DropGeoFileDirective, ExportButtonComponent]\r\n})\r\nexport class IgoImportExportModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoImportExportModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatTooltipModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoConfirmDialogModule } from '@igo2/common';\r\n\r\nimport { MapBrowserComponent } from './map-browser/map-browser.component';\r\nimport { ZoomButtonComponent } from './zoom-button/zoom-button.component';\r\nimport { GeolocateButtonComponent } from './geolocate-button/geolocate-button.component';\r\nimport { RotationButtonComponent } from './rotation-button/rotation-button.component';\r\nimport { BaseLayersSwitcherComponent } from './baselayers-switcher/baselayers-switcher.component';\r\nimport { MiniBaseMapComponent } from './baselayers-switcher/mini-basemap.component';\r\nimport { MapOfflineDirective } from './shared/mapOffline.directive';\r\nimport { OfflineButtonComponent } from './offline-button/offline-button.component';\r\nimport { PointerPositionDirective } from './shared/map-pointer-position.directive';\r\nimport { PointerPositionByKeyDirective } from './shared/map-pointer-position-by-key.directive';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoConfirmDialogModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule\r\n  ],\r\n  exports: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    RotationButtonComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    PointerPositionDirective,\r\n    PointerPositionByKeyDirective\r\n  ],\r\n  declarations: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    RotationButtonComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    PointerPositionDirective,\r\n    PointerPositionByKeyDirective\r\n  ]\r\n})\r\nexport class IgoMapModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit\r\n} from '../shared/measure.enum';\r\nimport { computeBestAreaUnit, computeBestLengthUnit } from '../shared/measure.utils';\r\n\r\n/**\r\n * Measurer item\r\n */\r\n@Component({\r\n  selector: 'igo-measurer-item',\r\n  templateUrl: './measurer-item.component.html',\r\n  styleUrls: ['./measurer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerItemComponent implements OnDestroy {\r\n\r\n  /**\r\n   * Measure observable\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<number> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the measure observable when the auto mode is on\r\n   * @internal\r\n   */\r\n  public measure$$: Subscription;\r\n\r\n  /**\r\n   * Measure type\r\n   */\r\n  @Input() measureType: MeasureType;\r\n\r\n  /**\r\n   * Measure unit\r\n   */\r\n  @Input() measureUnit: MeasureAreaUnit | MeasureLengthUnit;\r\n\r\n  /**\r\n   * Measure\r\n   */\r\n  @Input()\r\n  set measure(value: number) {\r\n    this.measure$.next(value);\r\n  }\r\n  get measure(): number { return this.measure$.value; }\r\n\r\n  /**\r\n   * Whther measure units should be automatically determined\r\n   */\r\n  @Input()\r\n  set auto(value: boolean) { this.toggleAutoUnit(value); }\r\n  get auto(): boolean { return this._auto; }\r\n  private _auto: boolean = false;\r\n\r\n  /**\r\n   * Placeholder\r\n   */\r\n  @Input() placeholder: string;\r\n\r\n  /**\r\n   * Event emitted when the measure unit changes\r\n   */\r\n  @Output() measureUnitChange = new EventEmitter<MeasureAreaUnit | MeasureLengthUnit>();\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    if (this.measureType === MeasureType.Area) {\r\n      return Object.values(MeasureAreaUnit);\r\n    }\r\n    return Object.values(MeasureLengthUnit);\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Toggle the auto unit off\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.toggleAutoUnit(false);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureAreaUnit | MeasureLengthUnit) {\r\n    this.measureUnit = unit;\r\n    this.measureUnitChange.emit(unit);\r\n  }\r\n\r\n  private toggleAutoUnit(toggle: boolean) {\r\n    if (this.measure$$ !== undefined) {\r\n      this.measure$$.unsubscribe();\r\n    }\r\n    if (toggle === true) {\r\n      this.measure$$ = this.measure$.subscribe((measure: number) => {\r\n        this.computeBestMeasureUnit(measure);\r\n      });\r\n    }\r\n    this._auto = toggle;\r\n  }\r\n\r\n  private computeBestMeasureUnit(measure: number) {\r\n    let measureUnit = this.measureUnit;\r\n    if (this.measureType === MeasureType.Area) {\r\n      measureUnit = computeBestAreaUnit(measure);\r\n    } else if (this.measureType === MeasureType.Length) {\r\n      measureUnit = computeBestLengthUnit(measure);\r\n    }\r\n    if (measureUnit !== this.measureUnit) {\r\n      this.onMeasureUnitChange(measureUnit);\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  MatButtonModule,\r\n  MatButtonToggleModule,\r\n  MatIconModule,\r\n  MatTooltipModule,\r\n  MatFormFieldModule,\r\n  MatInputModule,\r\n  MatSelectModule,\r\n  MatSlideToggleModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoEntityTableModule } from '@igo2/common';\r\n\r\nimport { MeasureFormatPipe } from './measure-format.pipe';\r\nimport { MeasurerItemComponent } from './measurer-item.component';\r\nimport { MeasurerComponent } from './measurer.component';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoEntityTableModule\r\n  ],\r\n  declarations: [\r\n    MeasureFormatPipe,\r\n    MeasurerItemComponent,\r\n    MeasurerComponent,\r\n    MeasurerDialogComponent\r\n  ],\r\n  exports: [\r\n    MeasureFormatPipe,\r\n    MeasurerComponent\r\n  ],\r\n  entryComponents: [\r\n    MeasurerDialogComponent\r\n  ]\r\n})\r\nexport class IgoMeasurerModule {}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoMeasurerModule } from './measurer/measurer.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n    IgoMeasurerModule\r\n  ]\r\n})\r\nexport class IgoMeasureModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\n\r\nimport { OverlayDirective } from './shared/overlay.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  exports: [OverlayDirective],\r\n  declarations: [OverlayDirective]\r\n})\r\nexport class IgoOverlayModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoOverlayModule\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Subject } from 'rxjs';\r\nimport { saveAs } from 'file-saver';\r\nimport * as jsPDF from 'jspdf';\r\nimport * as _html2canvas from 'html2canvas';\r\nimport * as JSZip from 'jszip';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { MessageService, ActivityService, LanguageService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { formatScale } from '../../map/shared/map.utils';\r\nimport { OutputLayerLegend } from '../../layer/shared/layers/layer.interface';\r\nimport { getLayersLegends } from '../../layer/utils/outputLegend';\r\n\r\nimport { PrintOptions } from './print.interface';\r\n\r\nconst html2canvas = _html2canvas;\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class PrintService {\r\n  zipFile: JSZip;\r\n  nbFileToProcess: number;\r\n  activityId: string;\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private activityService: ActivityService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  print(map: IgoMap, options: PrintOptions): Subject<any> {\r\n    const status$ = new Subject();\r\n\r\n    const paperFormat: string = options.paperFormat;\r\n    const resolution = +options.resolution; // Default is 96\r\n    const orientation = options.orientation;\r\n\r\n    this.activityId = this.activityService.register();\r\n    const doc = new jsPDF({\r\n      orientation,\r\n      format: paperFormat.toLowerCase()\r\n    });\r\n\r\n    const dimensions = [\r\n      doc.internal.pageSize.width,\r\n      doc.internal.pageSize.height\r\n    ];\r\n\r\n    const margins = [20, 10, 20, 10];\r\n    const width = dimensions[0] - margins[3] - margins[1];\r\n    const height = dimensions[1] - margins[0] - margins[2];\r\n    const size = [width, height];\r\n\r\n    if (options.title !== undefined) {\r\n      this.addTitle(doc, options.title, dimensions[0]);\r\n    }\r\n\r\n    if (options.showProjection === true || options.showScale === true) {\r\n      this.addProjScale(\r\n        doc,\r\n        map,\r\n        resolution,\r\n        options.showProjection,\r\n        options.showScale\r\n      );\r\n    }\r\n    if (options.comment !== '') {\r\n      this.addComment(doc, options.comment);\r\n    }\r\n\r\n    this.addMap(doc, map, resolution, size, margins).subscribe(\r\n      (status: SubjectStatus) => {\r\n        if (status === SubjectStatus.Done) {\r\n          if (options.showLegend === true) {\r\n            this.addLegend(doc, map, margins, resolution);\r\n          } else {\r\n            this.saveDoc(doc);\r\n          }\r\n        }\r\n\r\n        if (status === SubjectStatus.Done || status === SubjectStatus.Error) {\r\n          this.activityService.unregister(this.activityId);\r\n          status$.next(SubjectStatus.Done);\r\n        }\r\n      }\r\n    );\r\n\r\n    return status$;\r\n  }\r\n\r\n  /**\r\n   * Get html code for all layers legend\r\n   * @param  map IgoMap\r\n   * @param  width The width that the legend need to be\r\n   * @return Html code for the legend\r\n   */\r\n  getLayersLegendHtml(map: IgoMap, width: number, resolution: number): string {\r\n    let html = '';\r\n    const legends = getLayersLegends(\r\n      map.layers,\r\n      map.viewController.getScale(resolution)\r\n    );\r\n    if (legends.length === 0) {\r\n      return html;\r\n    }\r\n\r\n    // Define important style to be sure that all container is convert\r\n    // to image not just visible part\r\n    html += '<style media=\"screen\" type=\"text/css\">';\r\n    html += '.html2canvas-container { width: ' + width;\r\n    html += 'mm !important; height: 2000px !important; }';\r\n    html += '</style>';\r\n    html += '<font size=\"2\" face=\"Courier New\" >';\r\n    html += '<div style=\"display:inline-block;max-width:' + width + 'mm\">';\r\n    // For each legend, define an html table cell\r\n    legends.forEach((legend: OutputLayerLegend) => {\r\n      html +=\r\n        '<table border=1 style=\"display:inline-block;vertical-align:top\">';\r\n      html += '<tr><th width=\"170px\">' + legend.title + '</th>';\r\n      html += '<td><img class=\"printImageLegend\" src=\"' + legend.url + '\">';\r\n      html += '</td></tr></table>';\r\n    });\r\n    html += '</div>';\r\n\r\n    return html;\r\n  }\r\n\r\n  /**\r\n   * Get all the legend in a single image\r\n   * * @param  format - Image format. default value to \"png\"\r\n   * @return The image of the legend\r\n   */\r\n  getLayersLegendImage(\r\n    map,\r\n    format: string = 'png',\r\n    doZipFile: boolean,\r\n    resolution: number\r\n  ) {\r\n    const status$ = new Subject();\r\n    // Get html code for the legend\r\n    const width = 200; // milimeters unit, originally define for document pdf\r\n    let html = this.getLayersLegendHtml(map, width, resolution);\r\n    const that = this;\r\n    format = format.toLowerCase();\r\n\r\n    // If no legend show No LEGEND in an image\r\n    if (html.length === 0) {\r\n      html = '<font size=\"12\" face=\"Courier New\" >';\r\n      html += '<div align=\"center\"><b>NO LEGEND</b></div>';\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n    // Define event to execute after all images are loaded to create the canvas\r\n    setTimeout(() => {\r\n      html2canvas(div, { useCORS: true })\r\n        .then(canvas => {\r\n          let status = SubjectStatus.Done;\r\n          try {\r\n            if (!doZipFile) {\r\n              // Save the canvas as file\r\n              that.saveCanvasImageAsFile(canvas, 'legendImage', format);\r\n            } else {\r\n              // Add the canvas to zip\r\n              that.generateCanvaFileToZip(canvas, 'legendImage' + '.' + format);\r\n            }\r\n            div.parentNode.removeChild(div); // remove temp div (IE)\r\n          } catch (err) {\r\n            status = SubjectStatus.Error;\r\n          }\r\n          status$.next(status);\r\n        })\r\n        .catch(e => {\r\n          console.log(e);\r\n        });\r\n    }, 500);\r\n  }\r\n\r\n  private addTitle(doc: jsPDF, title: string, pageWidth: number) {\r\n    const pdfResolution = 96;\r\n    const titleSize = 32;\r\n    const titleWidth = ((titleSize * 25.4) / pdfResolution) * title.length;\r\n\r\n    let titleMarginLeft;\r\n    if (titleWidth > pageWidth) {\r\n      titleMarginLeft = 0;\r\n    } else {\r\n      titleMarginLeft = (pageWidth - titleWidth) / 2;\r\n    }\r\n\r\n    doc.setFont('courier');\r\n    doc.setFontSize(32);\r\n    doc.text(title, titleMarginLeft, 15);\r\n  }\r\n\r\n  /**\r\n   * Add comment to the document\r\n   * * @param  doc - pdf document\r\n   * * @param  comment - Comment to add in the document\r\n   * * @param  size - Size of the document\r\n   */\r\n  private addComment(doc: jsPDF, comment: string) {\r\n    const commentSize = 16;\r\n    const commentMarginLeft = 20;\r\n    const marginBottom = 5;\r\n    const heightPixels = doc.internal.pageSize.height - marginBottom;\r\n\r\n    doc.setFont('courier');\r\n    doc.setFontSize(commentSize);\r\n    doc.text(comment, commentMarginLeft, heightPixels);\r\n  }\r\n  /**\r\n   * Add projection and/or scale to the document\r\n   * @param  doc - pdf document\r\n   * @param  map - Map of the app\r\n   * @param  dpi - DPI resolution of the document\r\n   * @param  projection - Bool to indicate if projection need to be added\r\n   * @param  scale - Bool to indicate if scale need to be added\r\n   */\r\n  private addProjScale(\r\n    doc: jsPDF,\r\n    map: IgoMap,\r\n    dpi: number,\r\n    projection: boolean,\r\n    scale: boolean\r\n  ) {\r\n    const translate = this.languageService.translate;\r\n    const projScaleSize = 16;\r\n    const projScaleMarginLeft = 20;\r\n    const marginBottom = 15;\r\n    const heightPixels = doc.internal.pageSize.height - marginBottom;\r\n\r\n    let textProjScale: string = '';\r\n    if (projection === true) {\r\n      const projText = translate.instant('igo.geo.printForm.projection');\r\n      textProjScale += projText + ': ' + map.projection;\r\n    }\r\n    if (scale === true) {\r\n      if (projection === true) {\r\n        textProjScale += '   ';\r\n      }\r\n      const scaleText = translate.instant('igo.geo.printForm.scale');\r\n      const mapScale = map.viewController.getScale(dpi);\r\n      textProjScale += scaleText + ': ~ 1 / ' + formatScale(mapScale);\r\n    }\r\n    doc.setFont('courier');\r\n    doc.setFontSize(projScaleSize);\r\n    doc.text(textProjScale, projScaleMarginLeft, heightPixels);\r\n  }\r\n\r\n  /**\r\n   * Add the legend to the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private addLegend(\r\n    doc: jsPDF,\r\n    map: IgoMap,\r\n    margins: Array<number>,\r\n    resolution: number\r\n  ) {\r\n    const that = this;\r\n    // Get html code for the legend\r\n    const width = doc.internal.pageSize.width;\r\n    const html = this.getLayersLegendHtml(map, width, resolution);\r\n    // If no legend, save the map directly\r\n    if (html === '') {\r\n      this.saveDoc(doc);\r\n      return true;\r\n    }\r\n\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    html2canvas(div, { useCORS: true })\r\n      .then(canvas => {\r\n        let imgData;\r\n        const position = 10;\r\n\r\n        imgData = canvas.toDataURL('image/png');\r\n        doc.addPage();\r\n        const imageSize = this.getImageSizeToFitPdf(doc, canvas, margins);\r\n        doc.addImage(imgData, 'PNG', 10, position, imageSize[0], imageSize[1]);\r\n        that.saveDoc(doc);\r\n        div.parentNode.removeChild(div); // remove temp div (IE style)\r\n      })\r\n      .catch(e => {\r\n        console.log(e);\r\n      });\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n  }\r\n\r\n  private addCanvas(\r\n    doc: jsPDF,\r\n    canvas: HTMLCanvasElement,\r\n    margins: Array<number>\r\n  ) {\r\n    let image;\r\n\r\n    image = canvas.toDataURL('image/jpeg');\r\n\r\n    if (image !== undefined) {\r\n      const imageSize = this.getImageSizeToFitPdf(doc, canvas, margins);\r\n      doc.addImage(\r\n        image,\r\n        'JPEG',\r\n        margins[3],\r\n        margins[0],\r\n        imageSize[0],\r\n        imageSize[1]\r\n      );\r\n      doc.rect(margins[3], margins[0], imageSize[0], imageSize[1]);\r\n    }\r\n  }\r\n\r\n  // TODO fix printing with image resolution\r\n  private addMap(\r\n    doc: jsPDF,\r\n    map: IgoMap,\r\n    resolution: number,\r\n    size: Array<number>,\r\n    margins: Array<number>\r\n  ) {\r\n    const status$ = new Subject();\r\n\r\n    const mapSize = map.ol.getSize();\r\n    const extent = map.ol.getView().calculateExtent(mapSize);\r\n\r\n    const widthPixels = Math.round((size[0] * resolution) / 25.4);\r\n    const heightPixels = Math.round((size[1] * resolution) / 25.4);\r\n\r\n    let timeout;\r\n\r\n    map.ol.once('postcompose', (event: any) => {\r\n      const canvas = event.context.canvas;\r\n      const mapStatus$$ = map.status$.subscribe((mapStatus: SubjectStatus) => {\r\n        clearTimeout(timeout);\r\n\r\n        if (mapStatus !== SubjectStatus.Done) {\r\n          return;\r\n        }\r\n\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          this.addCanvas(doc, canvas, margins);\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error(\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageBody'\r\n            ),\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageHeader'\r\n            ),\r\n            'print'\r\n          );\r\n        }\r\n\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      });\r\n\r\n      // If no loading as started after 200ms, then probably no loading\r\n      // is required.\r\n      timeout = window.setTimeout(() => {\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          this.addCanvas(doc, canvas, margins);\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error(\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageBody'\r\n            ),\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageHeader'\r\n            ),\r\n            'print'\r\n          );\r\n        }\r\n\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      }, 200);\r\n    });\r\n\r\n    this.renderMap(map, [widthPixels, heightPixels], extent);\r\n\r\n    return status$;\r\n  }\r\n\r\n  defineNbFileToProcess(nbFileToProcess) {\r\n    this.nbFileToProcess = nbFileToProcess;\r\n  }\r\n\r\n  /**\r\n   * Download an image of the map with addition of informations\r\n   * @param  map - Map of the app\r\n   * @param  format - Image format. default value to \"png\"\r\n   * @param  projection - Indicate if projection need to be add. Default to false\r\n   * @param  scale - Indicate if scale need to be add. Default to false\r\n   * @param  legend - Indicate if the legend of layers need to be download. Default to false\r\n   * @param  title - Title to add for the map - Default to blank\r\n   * @param  comment - Comment to add for the map - Default to blank\r\n   * @param  doZipFile - Indicate if we do a zip with the file\r\n   * @return Image file of the map with extension format given as parameter\r\n   */\r\n  downloadMapImage(\r\n    map: IgoMap,\r\n    resolution: number,\r\n    format = 'png',\r\n    projection = false,\r\n    scale = false,\r\n    legend = false,\r\n    title = '',\r\n    comment = '',\r\n    doZipFile = true\r\n  ) {\r\n    const status$ = new Subject();\r\n    // const resolution = map.ol.getView().getResolution();\r\n    this.activityId = this.activityService.register();\r\n    const translate = this.languageService.translate;\r\n    map.ol.once('postcompose', (event: any) => {\r\n      format = format.toLowerCase();\r\n      const context = event.context;\r\n      const newCanvas = document.createElement('canvas');\r\n      const newContext = newCanvas.getContext('2d');\r\n      // Postion in height to set the canvas in new canvas\r\n      let positionHCanvas = 0;\r\n      // Position in width to set the Proj/Scale in new canvas\r\n      let positionWProjScale = 10;\r\n      // Get height/width of map canvas\r\n      const width = context.canvas.width;\r\n      let height = context.canvas.height;\r\n      // Set Font to calculate comment width\r\n      newContext.font = '20px Calibri';\r\n      const commentWidth = newContext.measureText(comment).width;\r\n      // Add height for title if defined\r\n      height = title !== '' ? height + 30 : height;\r\n      // Add height for projection or scale (same line) if defined\r\n      height = projection !== false || scale !== false ? height + 30 : height;\r\n      const positionHProjScale = height - 10;\r\n      // Define number of line depending of the comment length\r\n      const commentNbLine = Math.ceil(commentWidth / width);\r\n      // Add height for multiline comment if defined\r\n      height = comment !== '' ? height + commentNbLine * 30 : height;\r\n      let positionHComment = height - commentNbLine * 20 + 5;\r\n      // Set the new canvas with the new calculated size\r\n      newCanvas.width = width;\r\n      newCanvas.height = height;\r\n      // Patch Jpeg default black background to white\r\n      if (format === 'jpeg') {\r\n        newContext.fillStyle = '#ffffff';\r\n        newContext.fillRect(0, 0, width, height);\r\n        newContext.fillStyle = '#000000';\r\n      }\r\n      // If a title need to be added to canvas\r\n      if (title !== '') {\r\n        // Set font for title\r\n        newContext.font = '26px Calibri';\r\n        positionHCanvas = 30;\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(title, width / 2, 20);\r\n      }\r\n      // Set font for next section\r\n      newContext.font = '20px Calibri';\r\n      // If projection need to be added to canvas\r\n      if (projection !== false) {\r\n        const projText = translate.instant('igo.geo.printForm.projection');\r\n        newContext.textAlign = 'start';\r\n        newContext.fillText(\r\n          projText + ': ' + map.projection,\r\n          positionWProjScale,\r\n          positionHProjScale\r\n        );\r\n        positionWProjScale += 200; // Width position change for scale position\r\n      }\r\n      // If scale need to be added to canvas\r\n      if (scale !== false) {\r\n        const scaleText = translate.instant('igo.geo.printForm.scale');\r\n        const mapScale = map.viewController.getScale(resolution);\r\n        newContext.textAlign = 'start';\r\n        newContext.fillText(\r\n          scaleText + ': ~ 1 / ' + formatScale(mapScale),\r\n          positionWProjScale,\r\n          positionHProjScale\r\n        );\r\n      }\r\n      // If a comment need to be added to canvas\r\n      if (comment !== '') {\r\n        newContext.textAlign = 'center';\r\n        // If only one line, no need to multiline the comment\r\n        if (commentNbLine === 1) {\r\n          newContext.fillText(comment, width / 2, positionHComment);\r\n        } else {\r\n          // Separate the setenses to be approx. the same length\r\n          const nbCommentChar = comment.length;\r\n          const CommentLengthToCut = Math.floor(nbCommentChar / commentNbLine);\r\n          let commentCurrentLine = '';\r\n          let positionFirstCutChar = 0;\r\n          let positionLastBlank;\r\n          // Loop for the number of line calculated\r\n          for (let i = 0; i < commentNbLine; i++) {\r\n            // For all line except last\r\n            if (commentNbLine - 1 > i) {\r\n              // Get comment current line to find the right place tu cut comment\r\n              commentCurrentLine = comment.substr(\r\n                positionFirstCutChar,\r\n                CommentLengthToCut\r\n              );\r\n              // Cut the setence at blank\r\n              positionLastBlank = commentCurrentLine.lastIndexOf(' ');\r\n              newContext.fillText(\r\n                commentCurrentLine.substr(0, positionLastBlank),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n              positionFirstCutChar += positionLastBlank;\r\n              // Go to next line for insertion\r\n              positionHComment += 20;\r\n            } else {\r\n              // Don't cut last part\r\n              newContext.fillText(\r\n                comment.substr(positionFirstCutChar),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Add map to new canvas\r\n      newContext.drawImage(context.canvas, 0, positionHCanvas);\r\n\r\n      let status = SubjectStatus.Done;\r\n      try {\r\n        // Save the canvas as file\r\n        if (!doZipFile) {\r\n          this.saveCanvasImageAsFile(newCanvas, 'map', format);\r\n        } else if (format.toLowerCase() === 'tiff') {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(\r\n            newCanvas,\r\n            'map' + map.projection.replace(':', '_') + '.' + format\r\n          );\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(newCanvas, 'map' + '.' + format);\r\n        }\r\n      } catch (err) {\r\n        status = SubjectStatus.Error;\r\n      }\r\n\r\n      status$.next(status);\r\n\r\n      if (format.toLowerCase() === 'tiff') {\r\n        const tiwContent = this.getWorldFileInformation(map);\r\n        const blob = new Blob([tiwContent], {\r\n          type: 'text/plain;charset=utf-8'\r\n        });\r\n        if (!doZipFile) {\r\n          // saveAs automaticly replace ':' for '_'\r\n          saveAs(blob, 'map' + map.projection + '.tfw');\r\n          this.saveFileProcessing();\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.addFileToZip(\r\n            'map' + map.projection.replace(':', '_') + '.tfw',\r\n            blob\r\n          );\r\n        }\r\n      }\r\n    });\r\n    map.ol.renderSync();\r\n  }\r\n\r\n  private renderMap(map, size, extent) {\r\n    map.ol.renderSync();\r\n  }\r\n\r\n  /**\r\n   * Save document\r\n   * @param  doc - Document to save\r\n   */\r\n  protected saveDoc(doc: jsPDF) {\r\n    doc.save('map.pdf');\r\n  }\r\n\r\n  /**\r\n   * Calculate the best Image size to fit in pdf\r\n   * @param doc - Pdf Document\r\n   * @param canvas - Canvas of image\r\n   * @param margins - Page margins\r\n   */\r\n  private getImageSizeToFitPdf(doc, canvas, margins) {\r\n    // Define variable to calculate best size to fit in one page\r\n    const pageHeight =\r\n      doc.internal.pageSize.getHeight() - (margins[0] + margins[2]);\r\n    const pageWidth =\r\n      doc.internal.pageSize.getWidth() - (margins[1] + margins[3]);\r\n    const canHeight = canvas.height;\r\n    const canWidth = canvas.width;\r\n    const heightRatio = canHeight / pageHeight;\r\n    const widthRatio = canWidth / pageWidth;\r\n    const maxRatio = heightRatio > widthRatio ? heightRatio : widthRatio;\r\n    const imgHeigh = maxRatio > 1 ? canHeight / maxRatio : canHeight;\r\n    const imgWidth = maxRatio > 1 ? canWidth / maxRatio : canWidth;\r\n\r\n    return [imgWidth, imgHeigh];\r\n  }\r\n\r\n  /**\r\n   * Get a world file information for tiff\r\n   * @param  map - Map of the app\r\n   */\r\n  private getWorldFileInformation(map) {\r\n    const currentResolution = map.viewController.getResolution();\r\n    const currentExtent = map.viewController.getExtent(); // Return [minx, miny, maxx, maxy]\r\n    return [\r\n      currentResolution,\r\n      0,\r\n      0,\r\n      -currentResolution,\r\n      currentExtent[0] + currentResolution / 0.5,\r\n      currentExtent[3] - currentResolution / 0.5\r\n    ].join('\\n');\r\n  }\r\n\r\n  /**\r\n   * Save canvas image as file\r\n   * @param canvas - Canvas to save\r\n   * @param name - Name of the file\r\n   * @param format - file format\r\n   */\r\n  private saveCanvasImageAsFile(canvas, name, format) {\r\n    const blobFormat = 'image/' + format;\r\n    const that = this;\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      // If navigator is Internet Explorer\r\n      if (navigator.msSaveBlob) {\r\n        navigator.msSaveBlob(canvas.msToBlob(), name + '.' + format);\r\n        this.saveFileProcessing();\r\n      } else {\r\n        canvas.toBlob(blob => {\r\n          // download image\r\n          saveAs(blob, name + '.' + format);\r\n          that.saveFileProcessing();\r\n        }, blobFormat);\r\n      }\r\n    } catch (err) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageBody'\r\n        ),\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageHeader'\r\n        ),\r\n        'print'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to a zip\r\n   * @param canvas - File to add to the zip\r\n   * @param  name -Name of the fileoverview\r\n   */\r\n  private generateCanvaFileToZip(canvas, name) {\r\n    const blobFormat = 'image/' + 'jpeg';\r\n    const that = this;\r\n    if (\r\n      !this.hasOwnProperty('zipFile') ||\r\n      typeof this.zipFile === 'undefined'\r\n    ) {\r\n      this.zipFile = new JSZip();\r\n    }\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      if (navigator.msSaveBlob) {\r\n        this.addFileToZip(name, canvas.msToBlob());\r\n      } else {\r\n        canvas.toBlob(blob => {\r\n          that.addFileToZip(name, blob);\r\n        }, blobFormat);\r\n      }\r\n    } catch (err) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageBody'\r\n        ),\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageHeader'\r\n        ),\r\n        'print'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to zip, if all file are zipped, download\r\n   * @param name - Name of the files\r\n   * @param blob - Contain of file\r\n   */\r\n  private addFileToZip(name, blob) {\r\n    // add file to zip\r\n    this.zipFile.file(name, blob);\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Download zip file\r\n      this.getZipFile();\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  private saveFileProcessing() {\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the zipped file\r\n   * @return Retun a zip file\r\n   */\r\n  private getZipFile() {\r\n    const that = this;\r\n    this.zipFile.generateAsync({ type: 'blob' }).then(blob => {\r\n      // 1) generate the zip file\r\n      saveAs(blob, 'map.zip');\r\n      delete that.zipFile;\r\n    });\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat\r\n} from '../shared/print.type';\r\n\r\nimport { PrintService } from '../shared/print.service';\r\n\r\n@Component({\r\n  selector: 'igo-print',\r\n  templateUrl: './print.component.html'\r\n})\r\nexport class PrintComponent {\r\n  public disabled = false;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this._outputFormat;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this._outputFormat = value;\r\n  }\r\n  private _outputFormat: PrintOutputFormat;\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this._paperFormat;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this._paperFormat = value;\r\n  }\r\n  private _paperFormat: PrintPaperFormat;\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this._orientation;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this._orientation = value;\r\n  }\r\n  private _orientation: PrintOrientation;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this._imageFormat;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this._imageFormat = value;\r\n  }\r\n  private _imageFormat: PrintSaveImageFormat;\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this._resolution;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this._resolution = value;\r\n  }\r\n  private _resolution: PrintResolution;\r\n\r\n  constructor(private printService: PrintService) {}\r\n\r\n  handleFormSubmit(data: PrintOptions) {\r\n    this.disabled = true;\r\n\r\n    if (data.isPrintService === true) {\r\n      this.printService\r\n        .print(this.map, data)\r\n        .subscribe();\r\n    } else {\r\n      let nbFileToProcess = 1;\r\n\r\n      if (data.showLegend) {\r\n        nbFileToProcess++;\r\n      }\r\n      if (data.imageFormat.toLowerCase() === 'tiff') {\r\n        nbFileToProcess++;\r\n      }\r\n\r\n      this.printService.defineNbFileToProcess(nbFileToProcess);\r\n\r\n      const resolution = +data.resolution;\r\n      this.printService.downloadMapImage(\r\n        this.map,\r\n        resolution,\r\n        data.imageFormat,\r\n        data.showProjection,\r\n        data.showScale,\r\n        data.showLegend,\r\n        data.title,\r\n        data.comment,\r\n        data.doZipFile\r\n      );\r\n      if (data.showLegend) {\r\n        this.printService.getLayersLegendImage(\r\n          this.map,\r\n          data.imageFormat,\r\n          data.doZipFile,\r\n          +resolution\r\n        );\r\n      }\r\n    }\r\n    this.disabled = false;\r\n  }\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const PrintOutputFormat = strEnum(['Pdf', 'Image']);\r\n\r\nexport type PrintOutputFormat = keyof typeof PrintOutputFormat;\r\n\r\nexport const PrintPaperFormat = strEnum([\r\n  'A0',\r\n  'A1',\r\n  'A2',\r\n  'A3',\r\n  'A4',\r\n  'A5',\r\n  'Letter',\r\n  'Legal'\r\n]);\r\nexport type PrintPaperFormat = keyof typeof PrintPaperFormat;\r\n\r\nexport const PrintOrientation = strEnum(['landscape', 'portrait']);\r\nexport type PrintOrientation = keyof typeof PrintOrientation;\r\n\r\nexport const PrintResolution = strEnum(['72', '96', '150', '300']);\r\nexport type PrintResolution = keyof typeof PrintResolution;\r\n\r\nexport const PrintSaveImageFormat = strEnum([\r\n  'Bmp',\r\n  'Gif',\r\n  'Jpeg',\r\n  'Png',\r\n  'Tiff'\r\n]);\r\nexport type PrintSaveImageFormat = keyof typeof PrintSaveImageFormat;\r\n","import { Component, Input, Output, EventEmitter, OnInit } from '@angular/core';\r\nimport {\r\n  FormGroup,\r\n  FormBuilder,\r\n  FormControl,\r\n  Validators\r\n} from '@angular/forms';\r\n\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat\r\n} from '../shared/print.type';\r\n\r\n@Component({\r\n  selector: 'igo-print-form',\r\n  templateUrl: './print-form.component.html',\r\n  styleUrls: ['./print-form.component.scss']\r\n})\r\nexport class PrintFormComponent implements OnInit {\r\n  public form: FormGroup;\r\n  public submitted: boolean;\r\n\r\n  public outputFormats = PrintOutputFormat;\r\n  public paperFormats = PrintPaperFormat;\r\n  public orientations = PrintOrientation;\r\n  public resolutions = PrintResolution;\r\n  public imageFormats = PrintSaveImageFormat;\r\n  public isPrintService = true;\r\n\r\n  @Input()\r\n  get disabled(): boolean {\r\n    return this._disabled;\r\n  }\r\n  set disabled(value: boolean) {\r\n    this._disabled = value;\r\n  }\r\n  private _disabled = false;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this.imageFormatField.value;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this.imageFormatField.setValue(value || PrintSaveImageFormat.Jpeg, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this.outputFormatField.value;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this.outputFormatField.setValue(value || PrintOutputFormat.Pdf, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this.paperFormatField.value;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this.paperFormatField.setValue(value || PrintPaperFormat.Letter, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this.orientationField.value;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this.orientationField.setValue(value || PrintOrientation.landscape, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this.resolutionField.value;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this.resolutionField.setValue(value || PrintResolution['96'], {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get title(): string {\r\n    return this.titleField.value;\r\n  }\r\n  set title(value: string) {\r\n    this.titleField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  @Input()\r\n  get comment(): string {\r\n    return this.commentField.value;\r\n  }\r\n  set comment(value: string) {\r\n    this.commentField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showProjection(): boolean {\r\n    return this.showProjectionField.value;\r\n  }\r\n  set showProjection(value: boolean) {\r\n    this.showProjectionField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showScale(): boolean {\r\n    return this.showScaleField.value;\r\n  }\r\n  set showScale(value: boolean) {\r\n    this.showScaleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showLegend(): boolean {\r\n    return this.showLegendField.value;\r\n  }\r\n  set showLegend(value: boolean) {\r\n    this.showLegendField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  @Input()\r\n  get doZipFile(): boolean {\r\n    return this.doZipFileField.value;\r\n  }\r\n  set doZipFile(value: boolean) {\r\n    this.doZipFileField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  get outputFormatField() {\r\n    return (this.form.controls as any).outputFormat as FormControl;\r\n  }\r\n\r\n  get paperFormatField() {\r\n    return (this.form.controls as any).paperFormat as FormControl;\r\n  }\r\n\r\n  get imageFormatField() {\r\n    return (this.form.controls as any).imageFormat as FormControl;\r\n  }\r\n\r\n  get orientationField() {\r\n    return (this.form.controls as any).orientation as FormControl;\r\n  }\r\n\r\n  get resolutionField() {\r\n    return (this.form.controls as any).resolution as FormControl;\r\n  }\r\n\r\n  get commentField() {\r\n    return (this.form.controls as any).comment as FormControl;\r\n  }\r\n\r\n  get showProjectionField() {\r\n    return (this.form.controls as any).showProjection as FormControl;\r\n  }\r\n\r\n  get showScaleField() {\r\n    return (this.form.controls as any).showScale as FormControl;\r\n  }\r\n\r\n  get showLegendField() {\r\n    return (this.form.controls as any).showLegend as FormControl;\r\n  }\r\n\r\n  get doZipFileField() {\r\n    return (this.form.controls as any).doZipFile as FormControl;\r\n  }\r\n\r\n  get titleField() {\r\n    return (this.form.controls as any).title as FormControl;\r\n  }\r\n\r\n  @Output() submit: EventEmitter<PrintOptions> = new EventEmitter();\r\n\r\n  constructor(private formBuilder: FormBuilder) {\r\n    this.form = this.formBuilder.group({\r\n      title: ['', []],\r\n      comment: ['', []],\r\n      outputFormat: ['', [Validators.required]],\r\n      paperFormat: ['', [Validators.required]],\r\n      imageFormat: [ '', [Validators.required]],\r\n      resolution: ['', [Validators.required]],\r\n      orientation: ['', [Validators.required]],\r\n      showProjection: false,\r\n      showScale: false,\r\n      showLegend: false,\r\n      doZipFile: [{hidden: this.isPrintService }]\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.doZipFileField.setValue(false);\r\n  }\r\n\r\n  handleFormSubmit(data: PrintOptions, isValid: boolean) {\r\n    this.submitted = true;\r\n    data.isPrintService = this.isPrintService;\r\n    if (isValid) {\r\n      this.submit.emit(data);\r\n    }\r\n  }\r\n\r\n  toggleImageSaveProp() {\r\n    if (this.outputFormatField.value === 'Image') {\r\n      this.isPrintService = false;\r\n    } else {\r\n      this.isPrintService = true;\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport {\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatSelectModule,\r\n  MatOptionModule,\r\n  MatInputModule,\r\n  MatFormFieldModule,\r\n  MatSlideToggleModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule } from '@igo2/common';\r\n\r\nimport { PrintComponent } from './print/print.component';\r\nimport { PrintFormComponent } from './print-form/print-form.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatInputModule,\r\n    MatFormFieldModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule\r\n  ],\r\n  exports: [PrintComponent, PrintFormComponent],\r\n  declarations: [PrintComponent, PrintFormComponent]\r\n})\r\nexport class IgoPrintModule {}\r\n","import { ConfigService } from '@igo2/core';\r\n\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\n\r\nimport { QuerySearchSource } from './query-search-source';\r\n\r\n/**\r\n * Map search source factory\r\n * @ignore\r\n */\r\nexport function querySearchSourceFactory(config: ConfigService) {\r\n  return new QuerySearchSource(\r\n    config.getConfig(`searchSources.${QuerySearchSource.id}`) || {}\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the map search source\r\n */\r\nexport function provideQuerySearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: querySearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { QueryDirective } from './shared/query.directive';\r\nimport { QueryService } from './shared/query.service';\r\nimport { provideQuerySearchSource } from './shared/query-search-source.providers';\r\n\r\n@NgModule({\r\n  imports: [CommonModule],\r\n  exports: [QueryDirective],\r\n  declarations: [QueryDirective],\r\n  providers: [QueryService]\r\n})\r\nexport class IgoQueryModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoQueryModule,\r\n      providers: [provideQuerySearchSource()]\r\n    };\r\n  }\r\n}\r\n","import { SearchSource } from './sources/source';\r\nimport { SearchSourceSettings } from './sources/source.interfaces';\r\n\r\n/**\r\n * Service where all available search sources are registered.\r\n */\r\nexport class SearchSourceService {\r\n\r\n  constructor(private sources: SearchSource[]) {}\r\n\r\n  /**\r\n   * Return available search sources\r\n   * @returns Search sources\r\n   */\r\n  getSources(): SearchSource[] {\r\n    return this.sources;\r\n  }\r\n\r\n  /**\r\n   * Return enabled search sources\r\n   * @returns Search sources\r\n   */\r\n  getEnabledSources(): SearchSource[] {\r\n    return this.getSources().filter(\r\n      (source: SearchSource) => source.enabled === true\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Enable search sources of given type\r\n   * @param type Search type\r\n   * @todo It would be better to track the enabled search sources\r\n   *  without updating their 'enabled' property.\r\n   */\r\n  enableSourcesByType(type: string) {\r\n    this.getSources().forEach((source: SearchSource) => {\r\n      if ((source.constructor as typeof SearchSource).type === type) {\r\n        source.enabled = true;\r\n      } else {\r\n        source.enabled = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set Param from the selected settings\r\n   * @param source search-source\r\n   * @param setting settings\r\n   */\r\n  setParamFromSetting(source: SearchSource, setting: SearchSourceSettings) {\r\n    source.setParamFromSetting(setting);\r\n  }\r\n}\r\n","import { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchSource } from './sources/source';\r\nimport { SearchResult } from './search.interfaces';\r\n\r\n/**\r\n * Function that checks whether a search source implements TextSearch\r\n * @param source Search source\r\n * @returns True if the search source implements TextSearch\r\n */\r\nexport function sourceCanSearch(source: SearchSource): boolean {\r\n  return (source as any).search !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch\r\n */\r\nexport function sourceCanReverseSearch(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch AND is shown in the pointer summary\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch AND is shown in the pointer summary\r\n */\r\nexport function sourceCanReverseSearchAsSummary(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined && source.showInPointerSummary === true;\r\n}\r\n\r\n/**\r\n * Return a search result out of an Feature. This is used to adapt\r\n * the IGO query module to the new Feature/SearchResult interfaces\r\n * @param feature feature\r\n * @param source Search source\r\n * @returns SearchResult\r\n */\r\nexport function featureToSearchResult(\r\n  feature: Feature,\r\n  source: SearchSource\r\n): SearchResult<Feature> {\r\n  feature.sourceId = source.getId();\r\n  return {\r\n    source,\r\n    data: feature,\r\n    meta: {\r\n      dataType: FEATURE,\r\n      id: feature.meta.id as string,\r\n      title: feature.meta.title,\r\n      icon: feature.meta.icon || 'map-marker'\r\n    }\r\n  };\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { stringToLonLat } from '../../map';\r\nimport { MapService } from '../../map/shared/map.service';\r\n\r\nimport { SearchSource, TextSearch, ReverseSearch } from './sources/source';\r\nimport {\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './sources/source.interfaces';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { Research } from './search.interfaces';\r\nimport {\r\n  sourceCanSearch,\r\n  sourceCanReverseSearch,\r\n  sourceCanReverseSearchAsSummary\r\n} from './search.utils';\r\n\r\n/**\r\n * This service perform researches in all the search sources enabled.\r\n * It returns Research objects who's 'request' property needs to be\r\n * subscribed to in order to trigger the research. This services has\r\n * keeps internal state of the researches it performed\r\n * and the results they yielded.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SearchService {\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mapService: MapService\r\n  ) {}\r\n\r\n  /**\r\n   * Perform a research by text\r\n   * @param term Any text\r\n   * @returns Researches\r\n   */\r\n  search(term: string, options: TextSearchOptions = {}): Research[] {\r\n    if (!this.termIsValid(term)) {\r\n      return [];\r\n    }\r\n\r\n    const response = stringToLonLat(term, this.mapService.getMap().projection, {\r\n      forceNA: options.forceNA\r\n    });\r\n    if (response.lonLat) {\r\n      return this.reverseSearch(response.lonLat, { distance: response.radius });\r\n    } else if (response.message) {\r\n      console.log(response.message);\r\n    }\r\n\r\n    options.extent = this.mapService\r\n      .getMap()\r\n      .viewController.getExtent('EPSG:4326');\r\n\r\n    let sources;\r\n\r\n    if (options.getEnabledOnly || options.getEnabledOnly === undefined) {\r\n      sources = this.searchSourceService.getEnabledSources();\r\n    } else {\r\n      sources = this.searchSourceService.getSources();\r\n    }\r\n\r\n    if (options.sourceId) {\r\n      sources = sources.filter(source => source.getId() === options.sourceId);\r\n    } else if (options.searchType) {\r\n      sources = sources.filter(\r\n        source => source.getType() === options.searchType\r\n      );\r\n    }\r\n\r\n    sources = sources.filter(sourceCanSearch);\r\n    return this.searchSources(sources, term, options);\r\n  }\r\n\r\n  /**\r\n   * Perform a research by lon/lat\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Researches\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions,\r\n    asPointerSummary: boolean = false\r\n  ) {\r\n    const reverseSourceFonction = asPointerSummary\r\n      ? sourceCanReverseSearchAsSummary\r\n      : sourceCanReverseSearch;\r\n    const sources = this.searchSourceService\r\n      .getEnabledSources()\r\n      .filter(reverseSourceFonction);\r\n    return this.reverseSearchSources(sources, lonLat, options || {});\r\n  }\r\n\r\n  /**\r\n   * Create a text research out of all given search sources\r\n   * @param sources Search sources that implement TextSearch\r\n   * @param term Search term\r\n   * @returns Observable of Researches\r\n   */\r\n  private searchSources(\r\n    sources: SearchSource[],\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as TextSearch).search(term, options),\r\n        reverse: false,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a reverse research out of all given search sources\r\n   * @param sources Search sources that implement ReverseSearch\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Observable of Researches\r\n   */\r\n  private reverseSearchSources(\r\n    sources: SearchSource[],\r\n    lonLat: [number, number],\r\n    options: ReverseSearchOptions\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as ReverseSearch).reverseSearch(\r\n          lonLat,\r\n          options\r\n        ),\r\n        reverse: true,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Validate that a search term is valid\r\n   * @param term Search term\r\n   * @returns True if the search term is valid\r\n   */\r\n  private termIsValid(term: string): boolean {\r\n    return typeof term === 'string' && term !== '';\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { Message } from '@igo2/core';\r\n\r\nimport { Directions, DirectionsOptions } from '../shared/directions.interface';\r\n\r\nexport abstract class DirectionsSource {\r\n  abstract enabled: boolean;\r\n  abstract getName(): string;\r\n  abstract route(coordinates: [number, number][], directionsOptions: DirectionsOptions): Observable<Directions[]>;\r\n}\r\n","import { DirectionsSource } from '../directions-sources/directions-source';\r\n\r\nexport class DirectionsSourceService {\r\n  constructor(public sources: DirectionsSource[]) {}\r\n}\r\n\r\nexport function directionsSourceServiceFactory(sources: DirectionsSource[]) {\r\n  return new DirectionsSourceService(sources);\r\n}\r\n\r\nexport function provideDirectionsSourceService() {\r\n  return {\r\n    provide: DirectionsSourceService,\r\n    useFactory: directionsSourceServiceFactory,\r\n    deps: [DirectionsSource]\r\n  };\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { Message } from '@igo2/core';\r\n\r\nimport { Directions, DirectionsOptions } from '../shared/directions.interface';\r\nimport { DirectionsSource } from '../directions-sources/directions-source';\r\nimport { DirectionsSourceService } from './directions-source.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DirectionsService {\r\n  constructor(private directionsSourceService: DirectionsSourceService) {}\r\n\r\n  route(coordinates: [number, number][], directionsOptions: DirectionsOptions = {}): Observable<Directions[]>[] {\r\n    if (coordinates.length === 0) {\r\n      return;\r\n    }\r\n    return this.directionsSourceService.sources\r\n      .filter((source: DirectionsSource) => source.enabled)\r\n      .map((source: DirectionsSource) => this.routeSource(source, coordinates, directionsOptions));\r\n  }\r\n\r\n  routeSource(\r\n    source: DirectionsSource,\r\n    coordinates: [number, number][],\r\n    directionsOptions: DirectionsOptions = {}\r\n  ): Observable<Directions[]> {\r\n    const request = source.route(coordinates, directionsOptions );\r\n    return request;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Stop } from '../shared/directions.interface';\r\n\r\n@Injectable()\r\nexport class DirectionsFormService {\r\n  private stops: Stop[];\r\n\r\n  constructor() {}\r\n\r\n  getStopsCoordinates(): [number, number][] {\r\n    const stopsCoordinates = [];\r\n    if (this.stops) {\r\n      this.stops.forEach(stop => {\r\n        stopsCoordinates.push(stop.stopCoordinates);\r\n      });\r\n    }\r\n    return stopsCoordinates;\r\n  }\r\n\r\n  setStops(stops: Stop[]) {\r\n    this.stops = stops;\r\n  }\r\n\r\n  getStops() {\r\n    return this.stops;\r\n  }\r\n\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit,\r\n  OnDestroy,\r\n  Optional,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { FormGroup, FormBuilder, Validators, FormArray } from '@angular/forms';\r\nimport { Subscription, Subject } from 'rxjs';\r\nimport { debounceTime, distinctUntilChanged, map, take, skipWhile } from 'rxjs/operators';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olgeom from 'ol/geom';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport * as olcondition from 'ol/events/condition';\r\nimport * as olinteraction from 'ol/interaction';\r\nimport * as olobservable from 'ol/Observable';\r\n\r\nimport { Clipboard } from '@igo2/utils';\r\nimport {\r\n  Message,\r\n  LanguageService,\r\n  MessageService,\r\n  RouteService\r\n} from '@igo2/core';\r\nimport { getEntityTitle } from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { SearchService } from '../../search/shared/search.service';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { FeatureMotion, FEATURE } from '../../feature/shared/feature.enums';\r\nimport { moveToOlFeatures, tryBindStoreLayer, tryAddLoadingStrategy } from '../../feature/shared/feature.utils';\r\n\r\nimport { Directions, DirectionsOptions } from '../shared/directions.interface';\r\nimport { DirectionsService } from '../shared/directions.service';\r\nimport { DirectionsFormService } from './directions-form.service';\r\n\r\nimport { QueryService } from '../../query/shared/query.service';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { FeatureStoreLoadingStrategy } from '../../feature/shared/strategies/loading';\r\nimport { roundCoordTo } from '../../map/shared/map.utils';\r\n\r\n@Component({\r\n  selector: 'igo-directions-form',\r\n  templateUrl: './directions-form.component.html',\r\n  styleUrls: ['./directions-form.component.scss']\r\n})\r\nexport class DirectionsFormComponent implements OnInit, OnDestroy {\r\n  private readonly invalidKeys = ['Control', 'Shift', 'Alt'];\r\n\r\n  public stopsForm: FormGroup;\r\n  public projection = 'EPSG:4326';\r\n  public currentStopIndex: number;\r\n  private routesQueries$$: Subscription[] = [];\r\n  private search$$: Subscription;\r\n\r\n  private stream$ = new Subject<string>();\r\n\r\n  public routesResults: Directions[] | Message[];\r\n  public activeRoute: Directions;\r\n  private lastTimeoutRequest;\r\n\r\n  private focusOnStop = false;\r\n  private focusKey = [];\r\n  public initialStopsCoords;\r\n  private browserLanguage;\r\n\r\n  @Input() term: string;\r\n\r\n  @Input() debounce: number = 200;\r\n\r\n  @Input() length: number = 2;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The stops store\r\n   */\r\n  @Input() stopsStore: FeatureStore;\r\n\r\n  /**\r\n   * The route and vertex store\r\n   */\r\n  @Input() routeStore: FeatureStore;\r\n\r\n  @Output() submit: EventEmitter<any> = new EventEmitter();\r\n  constructor(\r\n    private formBuilder: FormBuilder,\r\n    private directionsService: DirectionsService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private searchService: SearchService,\r\n    private queryService: QueryService,\r\n    private directionsFormService: DirectionsFormService,\r\n    private changeDetectorRefs: ChangeDetectorRef,\r\n    @Optional() private route: RouteService\r\n  ) {}\r\n\r\n  changeRoute() {\r\n    this.showRouteGeometry();\r\n  }\r\n\r\n  prevent(event) {\r\n    event.preventDefault();\r\n   }\r\n\r\n  ngOnInit() {\r\n\r\n    this.queryService.queryEnabled = false;\r\n    this.focusOnStop = false;\r\n    this.browserLanguage = this.languageService.getLanguage();\r\n    this.stopsForm = this.formBuilder.group({\r\n      directionsType: 'car',\r\n      directionsMode: 'driving', // loop\r\n      stopOrderPriority: true,\r\n      directionsFixedStartEnd: false,\r\n      stops: this.formBuilder.array([\r\n        this.createStop('start'),\r\n        this.createStop('end')\r\n      ])\r\n    });\r\n\r\n    setTimeout(() => {\r\n      this.initStores();\r\n      this.initOlInteraction();\r\n    }, 1);\r\n\r\n    this.subscribeToFormChange();\r\n    this.routesQueries$$.push(\r\n      this.stream$\r\n        .pipe(\r\n          debounceTime(this.debounce),\r\n          distinctUntilChanged()\r\n        )\r\n        .subscribe((term: string) => this.handleTermChanged(term))\r\n    );\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.unsubscribeRoutesQueries();\r\n    this.unlistenSingleClick();\r\n    this.queryService.queryEnabled = true;\r\n    this.freezeStores();\r\n    this.writeStopsToFormService();\r\n\r\n  }\r\n\r\n  private initStores() {\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingStrategy({motion: FeatureMotion.None});\r\n\r\n    // STOP STORE\r\n    const stopsStore = this.stopsStore;\r\n    const stopsLayer = new VectorLayer({\r\n      title: 'Directions - stops',\r\n      zIndex: 911,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: stopMarker\r\n    });\r\n    tryBindStoreLayer(stopsStore, stopsLayer);\r\n    tryAddLoadingStrategy(stopsStore, loadingStrategy);\r\n\r\n    // ROUTE AND VERTEX STORE\r\n    const routeStore = this.routeStore;\r\n    const routeLayer = new VectorLayer({\r\n      title: 'Directions - route and vertex',\r\n      zIndex: 910,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: stopMarker\r\n    });\r\n    tryBindStoreLayer(routeStore, routeLayer);\r\n    tryAddLoadingStrategy(routeStore, loadingStrategy);\r\n\r\n  }\r\n\r\n  private initOlInteraction() {\r\n    let selectedStopFeature;\r\n    const selectStop = new olinteraction.Select({\r\n      layers: [this.stopsStore.layer.ol],\r\n      condition: olcondition.pointerMove,\r\n      hitTolerance: 7,\r\n      filter: (feature) => {\r\n        return feature.get('type') === 'stop';\r\n      }\r\n    });\r\n\r\n    selectStop.on('select', evt => {\r\n      selectedStopFeature = evt.target.getFeatures()[0];\r\n    });\r\n\r\n    const translateStop = new olinteraction.Translate({\r\n      layers: [this.stopsStore.layer.ol],\r\n      features: selectedStopFeature\r\n      // TODO In Openlayers >= 6.x, filter is now allowed.\r\n    });\r\n\r\n    translateStop.on('translating', evt => {\r\n      const features = evt.features;\r\n      if (features.getLength() === 0) { return; }\r\n      this.executeTranslation(features, false, 50, true);\r\n    });\r\n\r\n    translateStop.on('translateend', evt => {\r\n      const features = evt.features;\r\n      if (features.getLength() === 0) { return; }\r\n      this.executeTranslation(features, true, 0, false);\r\n    });\r\n\r\n    const selectedRoute = new olinteraction.Select({\r\n      layers: [this.routeStore.layer.ol],\r\n      condition: olcondition.click,\r\n      hitTolerance: 7,\r\n      filter: (feature) => {\r\n        return feature.getId() === 'route';\r\n      }\r\n    });\r\n    selectedRoute.on('select', evt => {\r\n      if (this.focusOnStop === false) {\r\n        const selectCoordinates = olproj.transform(\r\n          (evt as any).mapBrowserEvent.coordinate,\r\n          this.map.projection,\r\n          this.projection\r\n        );\r\n        this.addStop();\r\n        const pos = this.stops.length - 2;\r\n        this.stops.at(pos).patchValue({ stopCoordinates: selectCoordinates });\r\n        this.handleLocationProposals(selectCoordinates, pos);\r\n        this.addStopOverlay(selectCoordinates, pos);\r\n        selectedRoute.getFeatures().clear();\r\n      }\r\n      selectedRoute.getFeatures().clear();\r\n    });\r\n\r\n    this.map.ol.addInteraction(selectStop);\r\n    this.map.ol.addInteraction(translateStop);\r\n    this.map.ol.addInteraction(selectedRoute);\r\n\r\n  }\r\n\r\n  private subscribeToFormChange() {\r\n    this.routesQueries$$.push(\r\n      this.stopsForm.valueChanges\r\n        .pipe(debounceTime(this.debounce))\r\n        .subscribe(val => {\r\n          this.writeStopsToFormService();\r\n        })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Freeze any store, meaning the layer is removed, strategies are deactivated\r\n   * and some listener removed\r\n   * @internal\r\n   */\r\n  private freezeStores() {\r\n    const stopsStore = this.stopsStore;\r\n    const routeStore = this.routeStore;\r\n\r\n    this.map.removeLayer(stopsStore.layer);\r\n    this.map.removeLayer(routeStore.layer);\r\n    stopsStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    routeStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n\r\n  }\r\n\r\n  private executeTranslation(\r\n    features,\r\n    reverseSearchProposal = false,\r\n    delay: number = 0,\r\n    overview: boolean = false) {\r\n    this.routeStore.clear();\r\n    const firstFeature = features.getArray()[0];\r\n    const translatedID = firstFeature.getId();\r\n    const translatedPos = translatedID.split('_');\r\n    let p;\r\n    switch (translatedPos[1]) {\r\n      case 'start':\r\n        p = 0;\r\n        break;\r\n      case 'end':\r\n        p = this.stops.length - 1;\r\n        break;\r\n      default:\r\n        p = Number(translatedPos[1]);\r\n        break;\r\n    }\r\n    const translationCoordinates = olproj.transform(\r\n      firstFeature.getGeometry().getCoordinates(),\r\n      this.map.projection,\r\n      this.projection\r\n    );\r\n    this.stops\r\n      .at(p)\r\n      .patchValue({ stopCoordinates: translationCoordinates, stopProposals: [] });\r\n    if (reverseSearchProposal) {\r\n      this.handleLocationProposals(translationCoordinates, p);\r\n    }\r\n\r\n    const directionsOptions = {\r\n      steps: true,\r\n      overview: false,\r\n      alternatives: true\r\n    } as DirectionsOptions;\r\n\r\n    if (overview) {\r\n      directionsOptions.overview = true;\r\n      directionsOptions.steps = false;\r\n      directionsOptions.alternatives = false;\r\n    }\r\n\r\n    if (delay > 0) {\r\n      if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n        clearTimeout(this.lastTimeoutRequest);\r\n      }\r\n      this.lastTimeoutRequest = setTimeout(() => {\r\n        this.getRoutes(undefined, directionsOptions);\r\n      }, delay);\r\n\r\n    } else {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n      this.getRoutes(undefined, directionsOptions);\r\n    }\r\n\r\n  }\r\n\r\n  handleLocationProposals(coordinates: [number, number], stopIndex: number) {\r\n    const groupedLocations = [];\r\n    const roundedCoordinates = [coordinates[0].toFixed(5), coordinates[1].toFixed(5)];\r\n    this.stops.at(stopIndex).patchValue({ stopPoint: roundedCoordinates.join(',') });\r\n    this.searchService\r\n      .reverseSearch(coordinates, { zoom: this.map.viewController.getZoom() })\r\n      .map(res =>\r\n        this.routesQueries$$.push(\r\n          res.request.pipe(map(f => f)).subscribe(results => {\r\n            results.forEach(result => {\r\n              if (\r\n                groupedLocations.filter(f => f.source === result.source)\r\n                  .length === 0\r\n              ) {\r\n                groupedLocations.push({\r\n                  source: result.source,\r\n                  results: results.map(r => r.data)\r\n                });\r\n              }\r\n            });\r\n            this.stops\r\n              .at(stopIndex)\r\n              .patchValue({ stopProposals: groupedLocations });\r\n            // TODO: Prefer another source?\r\n            if (results[0]) {\r\n              if (results[0].source.getId() === 'icherchereverse') {\r\n                // prefer address type.\r\n                let resultPos = 0;\r\n                for (let i = 0; i < results.length; i++) {\r\n                  const feature: any = results[i].data;\r\n                  if (feature.properties.type === 'adresses') {\r\n                    resultPos = i;\r\n                    break;\r\n                  }\r\n                }\r\n                this.stops.at(stopIndex).patchValue({\r\n                  stopPoint: getEntityTitle(results[resultPos])\r\n                });\r\n                if (results[resultPos].data.geometry.type === 'Point') {\r\n                  this.stops.at(stopIndex).patchValue({\r\n                    stopCoordinates:\r\n                      results[resultPos].data.geometry.coordinates\r\n                  });\r\n                } else {\r\n                  // Not moving the translated point Only to suggest value into the UI.\r\n                }\r\n              } else if (results[0].source.getId() === 'coordinatesreverse') {\r\n                this.stops.at(stopIndex).patchValue({\r\n                  stopPoint: [\r\n                    results[0].data.geometry.coordinates[0].toFixed(5),\r\n                    results[0].data.geometry.coordinates[1].toFixed(5)\r\n                  ].join(',')\r\n                });\r\n                if (results[0].data.geometry.type === 'Point') {\r\n                  this.stops.at(stopIndex).patchValue({\r\n                    stopCoordinates:\r\n                      results[0].data.geometry.coordinates\r\n                  });\r\n                } else {\r\n                  // Not moving the translated point Only to suggest value into the UI.\r\n                }\r\n              }\r\n            } else {\r\n              this.stops.at(stopIndex).patchValue({ stopPoint: roundedCoordinates.join(','), stopProposals: [] });\r\n            }\r\n            this.changeDetectorRefs.detectChanges();\r\n          })\r\n        )\r\n      );\r\n  }\r\n\r\n  directionsText(index: number, stopsCounts = this.stops.length): string {\r\n    if (index === 0) {\r\n      return 'start';\r\n    } else if (index === stopsCounts - 1 || stopsCounts === 1) {\r\n      return 'end';\r\n    } else {\r\n      return 'intermediate';\r\n    }\r\n  }\r\n\r\n  raiseStop(index: number) {\r\n    if (index > 0) {\r\n      this.moveStop(index, -1);\r\n    }\r\n  }\r\n\r\n  lowerStop(index: number) {\r\n    if (index < this.stops.length - 1) {\r\n      this.moveStop(index, 1);\r\n    }\r\n  }\r\n\r\n  private moveStop(index, diff) {\r\n    const fromValue = this.stops.at(index);\r\n    this.removeStop(index);\r\n    this.stops.insert(index + diff, fromValue);\r\n    this.stops.at(index).patchValue({ directionsText: this.directionsText(index) });\r\n    this.stops\r\n      .at(index + diff)\r\n      .patchValue({ directionsText: this.directionsText(index + diff) });\r\n    if (this.stops.at(index).value.stopCoordinates) {\r\n      this.addStopOverlay(this.stops.at(index).value.stopCoordinates, index);\r\n    }\r\n    if (this.stops.at(index + diff).value.stopCoordinates) {\r\n      this.addStopOverlay(\r\n        this.stops.at(index + diff).value.stopCoordinates,\r\n        index + diff\r\n      );\r\n    }\r\n  }\r\n\r\n  get stops(): FormArray {\r\n    return this.stopsForm.get('stops') as FormArray;\r\n  }\r\n\r\n  public writeStopsToFormService() {\r\n    const stops = [];\r\n    this.stops.value.forEach(stop => {\r\n      if (stop.stopCoordinates instanceof Array) {\r\n        stops.push(stop);\r\n      }\r\n    });\r\n    this.directionsFormService.setStops(stops);\r\n  }\r\n\r\n  addStop(): void {\r\n    const insertIndex = this.stops.length - 1;\r\n    this.stops.insert(insertIndex, this.createStop());\r\n  }\r\n\r\n  createStop(directionsPos = 'intermediate'): FormGroup {\r\n    return this.formBuilder.group({\r\n      stopPoint: [''],\r\n      stopProposals: [[]],\r\n      directionsText: directionsPos,\r\n      stopCoordinates: ['', [Validators.required]]\r\n    });\r\n  }\r\n\r\n  removeStop(index: number): void {\r\n    const id = this.getStopOverlayID(index);\r\n    this.deleteStoreFeatureByID(this.stopsStore, id);\r\n    this.stops.removeAt(index);\r\n    let cnt = 0;\r\n    this.stops.value.forEach(stop => {\r\n      this.stops.at(cnt).patchValue({ directionsText: this.directionsText(cnt) });\r\n      this.addStopOverlay(this.stops.at(cnt).value.stopCoordinates, cnt);\r\n      cnt++;\r\n    });\r\n  }\r\n\r\n  resetForm() {\r\n    this.routesResults = undefined;\r\n    const nbStops = this.stops.length;\r\n    for (let i = 0; i < nbStops; i++) {\r\n      this.stops.removeAt(0);\r\n    }\r\n    this.stops.insert(0, this.createStop('start'));\r\n    this.stops.insert(1, this.createStop('end'));\r\n\r\n    this.stopsStore.clear();\r\n    this.routeStore.clear();\r\n  }\r\n\r\n  formatStep(step, cnt) {\r\n    return this.formatInstruction(\r\n      step.maneuver.type,\r\n      step.maneuver.modifier,\r\n      step.name,\r\n      step.maneuver.bearing_after,\r\n      cnt,\r\n      step.maneuver.exit,\r\n      cnt === this.activeRoute.steps.length - 1\r\n    );\r\n  }\r\n\r\n  formatInstruction(\r\n    type,\r\n    modifier,\r\n    route,\r\n    direction,\r\n    stepPosition,\r\n    exit,\r\n    lastStep = false\r\n  ) {\r\n    let directiveFr;\r\n    let directiveEn;\r\n    let image = 'forward';\r\n    let cssClass = 'rotate-270';\r\n    const translatedDirection = this.translateBearing(direction);\r\n    const translatedModifier = this.translateModifier(modifier);\r\n    const enPrefix = modifier === 'straight' ? '' : 'on the ';\r\n    const frPrefix = modifier === 'straight' ? '' : ' ';\r\n\r\n    let frAggregatedDirection = frPrefix + translatedModifier;\r\n    let enAggregatedDirection = enPrefix + translatedModifier;\r\n\r\n    if (modifier && modifier.search('slight') >= 0) {\r\n      enAggregatedDirection = translatedModifier;\r\n    }\r\n\r\n    if (modifier === 'uturn') {\r\n      image = 'forward';\r\n      cssClass = 'rotate-90';\r\n    } else if (modifier === 'sharp right') {\r\n      image = 'subdirectory-arrow-right';\r\n      cssClass = 'icon-flipped';\r\n    } else if (modifier === 'right') {\r\n      image = 'subdirectory-arrow-right';\r\n      cssClass = 'icon-flipped';\r\n    } else if (modifier === 'slight right') {\r\n      image = 'forward';\r\n      cssClass = 'rotate-290';\r\n    } else if (modifier === 'straight') {\r\n      image = 'forward';\r\n    } else if (modifier === 'slight left') {\r\n      image = 'forward';\r\n      cssClass = 'rotate-250';\r\n    } else if (modifier === 'left') {\r\n      image = 'subdirectory-arrow-left';\r\n      cssClass = 'icon-flipped';\r\n    } else if (modifier === 'sharp left') {\r\n      image = 'subdirectory-arrow-left';\r\n      cssClass = 'icon-flipped';\r\n    }\r\n\r\n    if (type === 'turn') {\r\n      if (modifier === 'straight') {\r\n        directiveFr = 'Continuer sur ' + route;\r\n        directiveEn = 'Continue on ' + route;\r\n      } else if (modifier === 'uturn') {\r\n        directiveFr = 'Faire demi-tour sur ' + route;\r\n        directiveEn = 'Make u-turn on ' + route;\r\n      } else {\r\n        directiveFr = 'Tourner ' + frAggregatedDirection + ' sur ' + route;\r\n        directiveEn = 'Turn ' + translatedModifier + ' onto ' + route;\r\n      }\r\n    } else if (type === 'new name') {\r\n      directiveFr =\r\n        'Continuer en direction ' + translatedDirection + ' sur ' + route;\r\n      directiveEn = 'Head ' + translatedDirection + ' on ' + route;\r\n      image = 'compass';\r\n      cssClass = '';\r\n    } else if (type === 'depart') {\r\n      directiveFr =\r\n        'Aller en direction ' + translatedDirection + ' sur ' + route;\r\n      directiveEn = 'Head ' + translatedDirection + ' on ' + route;\r\n      image = 'compass';\r\n      cssClass = '';\r\n    } else if (type === 'arrive') {\r\n      if (lastStep) {\r\n        let coma = ', ';\r\n        if (!translatedModifier) {\r\n          frAggregatedDirection = '';\r\n          enAggregatedDirection = '';\r\n          coma = '';\r\n        }\r\n        directiveFr = 'Vous tes arriv' + coma + frAggregatedDirection;\r\n        directiveEn =\r\n          'You have reached your destination' + coma + enAggregatedDirection;\r\n      } else {\r\n        directiveFr = 'Vous atteignez le point intermdiare sur ' + route;\r\n        directiveEn = 'You have reached the intermediate stop onto ' + route;\r\n        image = 'map-marker';\r\n        cssClass = '';\r\n      }\r\n    } else if (type === 'merge') {\r\n      directiveFr = 'Continuer sur ' + route;\r\n      directiveEn = 'Continue on ' + route;\r\n      image = 'forward';\r\n      cssClass = 'rotate-270';\r\n    } else if (type === 'on ramp') {\r\n      directiveFr = \"Prendre l'entre d'autoroute \" + frAggregatedDirection;\r\n      directiveEn = 'Take the ramp ' + enAggregatedDirection;\r\n    } else if (type === 'off ramp') {\r\n      directiveFr = \"Prendre la sortie d'autoroute \" + frAggregatedDirection;\r\n      directiveEn = 'Take exit ' + enAggregatedDirection;\r\n    } else if (type === 'fork') {\r\n      if (modifier.search('left') >= 0) {\r\n        directiveFr = 'Garder la gauche sur ' + route;\r\n        directiveEn = 'Merge left onto ' + route;\r\n      } else if (modifier.search('right') >= 0) {\r\n        directiveFr = 'Garder la droite sur ' + route;\r\n        directiveEn = 'Merge right onto ' + route;\r\n      } else {\r\n        directiveFr = 'Continuer sur ' + route;\r\n        directiveEn = 'Continue on ' + route;\r\n      }\r\n    } else if (type === 'end of road') {\r\n      directiveFr =\r\n        ' la fin de la route, tourner ' + translatedModifier + ' sur ' + route;\r\n      directiveEn =\r\n        'At the end of the road, turn ' + translatedModifier + ' onto ' + route;\r\n    } else if (type === 'use lane') {\r\n      directiveFr = 'Prendre la voie de ... ';\r\n      directiveEn = 'Take the lane ...';\r\n    } else if (type === 'continue' && modifier !== 'uturn') {\r\n      directiveFr = 'Continuer sur ' + route;\r\n      directiveEn = 'Continue on ' + route;\r\n      image = 'forward';\r\n      cssClass = 'rotate-270';\r\n    } else if (type === 'roundabout') {\r\n      directiveFr = 'Au rond-point, prendre la ' + exit;\r\n      directiveFr += exit === 1 ? 're' : 'e';\r\n      directiveFr += ' sortie vers ' + route;\r\n      directiveEn = 'At the roundabout, take the ' + exit;\r\n      directiveEn += exit === 1 ? 'st' : 'rd';\r\n      directiveEn += ' exit towards ' + route;\r\n      image = 'chart-donut';\r\n      cssClass = '';\r\n    } else if (type === 'rotary') {\r\n      directiveFr = 'Rond-point rotary....';\r\n      directiveEn = 'Roundabout rotary....';\r\n      image = 'chart-donut';\r\n      cssClass = '';\r\n    } else if (type === 'roundabout turn') {\r\n      directiveFr = 'Rond-point, prendre la ...';\r\n      directiveEn = 'Roundabout, take the ...';\r\n      image = 'chart-donut';\r\n      cssClass = '';\r\n    } else if (type === 'exit roundabout') {\r\n      directiveFr = 'Poursuivre vers ' + route;\r\n      directiveEn = 'Continue to ' + route;\r\n      image = 'forward';\r\n      cssClass = 'rotate-270';\r\n    } else if (type === 'notification') {\r\n      directiveFr = 'notification ....';\r\n      directiveEn = 'notification ....';\r\n    } else if (modifier === 'uturn') {\r\n      directiveFr =\r\n        'Faire demi-tour et continuer en direction ' +\r\n        translatedDirection +\r\n        ' sur ' +\r\n        route;\r\n      directiveEn =\r\n        'Make u-turn and head ' + translatedDirection + ' on ' + route;\r\n    } else {\r\n      directiveFr = '???';\r\n      directiveEn = '???';\r\n    }\r\n\r\n    if (lastStep) {\r\n      image = 'flag-variant';\r\n      cssClass = '';\r\n    }\r\n    if (stepPosition === 0) {\r\n      image = 'compass';\r\n      cssClass = '';\r\n    }\r\n\r\n    let directive;\r\n    if (this.browserLanguage === 'fr') {\r\n      directive = directiveFr;\r\n    } else if (this.browserLanguage === 'en') {\r\n      directive = directiveEn;\r\n    }\r\n\r\n    return { instruction: directive, image, cssClass };\r\n  }\r\n\r\n  translateModifier(modifier) {\r\n    if (modifier === 'uturn') {\r\n      return this.languageService.translate.instant('igo.geo.directions.uturn');\r\n    } else if (modifier === 'sharp right') {\r\n      return this.languageService.translate.instant(\r\n        'igo.geo.directions.sharp right'\r\n      );\r\n    } else if (modifier === 'right') {\r\n      return this.languageService.translate.instant('igo.geo.directions.right');\r\n    } else if (modifier === 'slight right') {\r\n      return this.languageService.translate.instant(\r\n        'igo.geo.directions.slight right'\r\n      );\r\n    } else if (modifier === 'sharp left') {\r\n      return this.languageService.translate.instant(\r\n        'igo.geo.directions.sharp left'\r\n      );\r\n    } else if (modifier === 'left') {\r\n      return this.languageService.translate.instant('igo.geo.directions.left');\r\n    } else if (modifier === 'slight left') {\r\n      return this.languageService.translate.instant(\r\n        'igo.geo.directions.slight left'\r\n      );\r\n    } else if (modifier === 'straight') {\r\n      return this.languageService.translate.instant('igo.geo.directions.straight');\r\n    } else {\r\n      return modifier;\r\n    }\r\n  }\r\n\r\n  translateBearing(bearing) {\r\n    if (bearing >= 337 || bearing < 23) {\r\n      return this.languageService.translate.instant('igo.geo.cardinalPoints.n');\r\n    } else if (bearing < 67) {\r\n      return this.languageService.translate.instant(\r\n        'igo.geo.cardinalPoints.ne'\r\n      );\r\n    } else if (bearing < 113) {\r\n      return this.languageService.translate.instant('igo.geo.cardinalPoints.e');\r\n    } else if (bearing < 157) {\r\n      return this.languageService.translate.instant(\r\n        'igo.geo.cardinalPoints.se'\r\n      );\r\n    } else if (bearing < 203) {\r\n      return this.languageService.translate.instant('igo.geo.cardinalPoints.s');\r\n    } else if (bearing < 247) {\r\n      return this.languageService.translate.instant(\r\n        'igo.geo.cardinalPoints.sw'\r\n      );\r\n    } else if (bearing < 293) {\r\n      return this.languageService.translate.instant('igo.geo.cardinalPoints.w');\r\n    } else if (bearing < 337) {\r\n      return this.languageService.translate.instant(\r\n        'igo.geo.cardinalPoints.nw'\r\n      );\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n\r\n  formatDistance(distance) {\r\n    if (distance === 0) {\r\n      return;\r\n    }\r\n    if (distance >= 100000) {\r\n      return Math.round(distance / 1000) + ' km';\r\n    }\r\n    if (distance >= 10000) {\r\n      return Math.round(distance / 100) / 10 + ' km';\r\n    }\r\n    if (distance >= 100) {\r\n      return Math.round(distance / 100) / 10 + ' km';\r\n    }\r\n    return distance + ' m';\r\n  }\r\n\r\n  formatDuration(duration: number, summary = false) {\r\n    if (duration >= 3600) {\r\n      const hour = Math.floor(duration / 3600);\r\n      const minute = Math.round((duration / 3600 - hour) * 60);\r\n      if (minute === 60) {\r\n        return hour + 1 + ' h';\r\n      }\r\n      return hour + ' h ' + minute + ' min';\r\n    }\r\n\r\n    if (duration >= 60) {\r\n      return Math.round(duration / 60) + ' min';\r\n    }\r\n    return duration + ' s';\r\n  }\r\n\r\n  showSegment(step, zoomToExtent = false) {\r\n    this.showRouteSegmentGeometry(step.geometry.coordinates, zoomToExtent);\r\n  }\r\n\r\n  showRouteSegmentGeometry(coordinates, zoomToExtent = false) {\r\n    const vertexId = 'vertex';\r\n    const geometry4326 = new olgeom.LineString(coordinates);\r\n    const geometryMapProjection = geometry4326.transform('EPSG:4326', this.map.projection);\r\n    const routeSegmentCoordinates = (geometryMapProjection as any).getCoordinates();\r\n    const lastPoint = routeSegmentCoordinates[0];\r\n\r\n    const geometry = new olgeom.Point(lastPoint);\r\n    const feature = new olFeature({ geometry });\r\n\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.map.projection,\r\n      dataProjection: this.map.projection\r\n    });\r\n\r\n    const previousVertex = this.routeStore.get(vertexId);\r\n    const previousVertexRevision = previousVertex ? previousVertex.meta.revision : 0;\r\n\r\n    const vertexFeature: Feature = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.map.projection,\r\n      properties: {\r\n        id: vertexId,\r\n        type: 'vertex'\r\n      },\r\n      meta: {\r\n        id: vertexId,\r\n        revision: previousVertexRevision + 1\r\n      },\r\n      ol: feature\r\n    };\r\n    this.routeStore.update(vertexFeature);\r\n    if (zoomToExtent) {\r\n      this.map.viewController.zoomToExtent(feature.getGeometry().getExtent());\r\n    }\r\n  }\r\n\r\n  zoomRoute(extent?) {\r\n\r\n    if (extent) {\r\n      this.map.viewController.zoomToExtent(extent);\r\n    } else {\r\n      const routeFeature = this.routeStore.layer.ol.getSource().getFeatures().find(f => f.getId() === 'route');\r\n      if (routeFeature) {\r\n        const routeExtent = routeFeature.getGeometry().getExtent();\r\n        this.map.viewController.zoomToExtent(routeExtent);\r\n      }\r\n    }\r\n  }\r\n\r\n  private showRouteGeometry(moveToExtent = false) {\r\n    const geom = this.activeRoute.geometry.coordinates;\r\n    const geometry4326 = new olgeom.LineString(geom);\r\n    const geometryMapProjection = geometry4326.transform('EPSG:4326', this.map.projection);\r\n    if (moveToExtent) {\r\n      this.zoomRoute(geometryMapProjection.getExtent());\r\n    }\r\n\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometryMapProjection, {\r\n      featureProjection: this.map.projection,\r\n      dataProjection: this.map.projection\r\n    });\r\n\r\n    const previousRoute = this.routeStore.get('route');\r\n    const previousRouteRevision = previousRoute ? previousRoute.meta.revision : 0;\r\n\r\n    const routeFeature: Feature = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.map.projection,\r\n      properties: {\r\n        id: 'route',\r\n        type: 'route'\r\n      },\r\n      meta: {\r\n        id: 'route',\r\n        revision: previousRouteRevision + 1\r\n      },\r\n      ol: new olFeature({ geometry: geometryMapProjection })\r\n    };\r\n    this.routeStore.update(routeFeature);\r\n\r\n  }\r\n\r\n  getRoutes(moveToExtent: boolean = false, directionsOptions: DirectionsOptions = {}) {\r\n    this.deleteStoreFeatureByID(this.routeStore, 'vertex');\r\n    this.writeStopsToFormService();\r\n    const coords = this.directionsFormService.getStopsCoordinates();\r\n    if (coords.length < 2) {\r\n      return;\r\n    }\r\n    const routeResponse = this.directionsService.route(coords, directionsOptions);\r\n    if (routeResponse) {\r\n      routeResponse.map(res =>\r\n        this.routesQueries$$.push(\r\n          res.subscribe(route => {\r\n            this.routesResults = route;\r\n            this.activeRoute = this.routesResults[0] as Directions;\r\n            this.showRouteGeometry(moveToExtent);\r\n            this.changeDetectorRefs.detectChanges();\r\n          })\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  private unlistenSingleClick() {\r\n    if (this.focusKey.length !== 0) {\r\n      this.focusKey.forEach(key => {\r\n        olobservable.unByKey(key);\r\n      });\r\n    }\r\n  }\r\n\r\n  private unsubscribeRoutesQueries() {\r\n    this.routesQueries$$.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.routesQueries$$ = [];\r\n  }\r\n\r\n  copyLinkToClipboard() {\r\n    const successful = Clipboard.copy(this.getUrl());\r\n    if (successful) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant('igo.geo.directionsForm.dialog.copyTitle');\r\n      const msg = translate.instant('igo.geo.directionsForm.dialog.copyMsgLink');\r\n      this.messageService.success(msg, title);\r\n    }\r\n  }\r\n\r\n  copyDirectionsToClipboard() {\r\n    const indent = '\\t';\r\n    let activeRouteDirective =\r\n      this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.instructions'\r\n      ) + ':\\n';\r\n    let wayPointList = '';\r\n    const summary =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.summary') +\r\n      ': \\n' +\r\n      indent +\r\n      this.activeRoute.title +\r\n      '\\n' +\r\n      indent +\r\n      this.formatDistance(this.activeRoute.distance) +\r\n      '\\n' +\r\n      indent +\r\n      this.formatDuration(this.activeRoute.duration) +\r\n      '\\n\\n' +\r\n      this.languageService.translate.instant('igo.geo.directionsForm.stopsList') +\r\n      ':\\n';\r\n\r\n    const url =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.link') +\r\n      ':\\n' +\r\n      indent +\r\n      this.getUrl();\r\n\r\n    let wayPointsCnt = 1;\r\n    this.stops.value.forEach(stop => {\r\n      let coord = '';\r\n      let stopPoint = '';\r\n      if (stop.stopPoint !== stop.stopCoordinates) {\r\n        stopPoint = stop.stopPoint;\r\n        coord =\r\n          ' (' +\r\n          [stop.stopCoordinates[1], stop.stopCoordinates[0]].join(',') +\r\n          ')';\r\n      } else {\r\n        stopPoint = [stop.stopCoordinates[1], stop.stopCoordinates[0]].join(\r\n          ','\r\n        );\r\n      }\r\n\r\n      wayPointList =\r\n        wayPointList +\r\n        indent +\r\n        wayPointsCnt.toLocaleString() +\r\n        '. ' +\r\n        stopPoint +\r\n        coord +\r\n        '\\n';\r\n      wayPointsCnt++;\r\n    });\r\n\r\n    // Directions\r\n    let localCnt = 0;\r\n    this.activeRoute.steps.forEach(step => {\r\n      const instruction = this.formatStep(step, localCnt).instruction;\r\n      const distance =\r\n        this.formatDistance(step.distance) === undefined\r\n          ? ''\r\n          : ' (' + this.formatDistance(step.distance) + ')';\r\n      activeRouteDirective =\r\n        activeRouteDirective +\r\n        indent +\r\n        (localCnt + 1).toLocaleString() +\r\n        '. ' +\r\n        instruction +\r\n        distance +\r\n        '\\n';\r\n      localCnt++;\r\n    });\r\n\r\n    const directionsBody =\r\n      summary + wayPointList + '\\n' + url + '\\n\\n' + activeRouteDirective;\r\n\r\n    const successful = Clipboard.copy(directionsBody);\r\n    if (successful) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant('igo.geo.directionsForm.dialog.copyTitle');\r\n      const msg = translate.instant('igo.geo.directionsForm.dialog.copyMsg');\r\n      this.messageService.success(msg, title);\r\n    }\r\n  }\r\n\r\n  private handleTermChanged(term: string) {\r\n    if (term !== undefined || term.length !== 0) {\r\n      const searchProposals = [];\r\n      if (this.search$$) {\r\n        this.search$$.unsubscribe();\r\n      }\r\n      const researches = this.searchService.search(term, {searchType: 'Feature'});\r\n      researches.map(res =>\r\n        this.search$$ =\r\n        res.request.subscribe(results => {\r\n          results\r\n            .filter(r => r.data.geometry)\r\n            .forEach(element => {\r\n              if (\r\n                searchProposals.filter(r => r.source === element.source)\r\n                  .length === 0\r\n              ) {\r\n                searchProposals.push({\r\n                  source: element.source,\r\n                  meta: element.meta,\r\n                  results: results.map(r => r.data)\r\n                });\r\n              }\r\n            });\r\n          this.stops\r\n            .at(this.currentStopIndex)\r\n            .patchValue({ stopProposals: searchProposals });\r\n          this.changeDetectorRefs.detectChanges();\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  setTerm(term: string) {\r\n    this.term = term;\r\n    if (\r\n      this.keyIsValid(term) &&\r\n      (term.length >= this.length || term.length === 0)\r\n    ) {\r\n      this.stream$.next(term);\r\n    }\r\n  }\r\n\r\n  private keyIsValid(key: string) {\r\n    return this.invalidKeys.find(value => value === key) === undefined;\r\n  }\r\n\r\n  keyup(i, event: KeyboardEvent) {\r\n    const term = (event.target as HTMLInputElement).value;\r\n    this.setTerm(term);\r\n    this.map.ol.un('singleclick', evt => {\r\n      this.handleMapClick(evt, i);\r\n    });\r\n  }\r\n\r\n  clearStop(stopIndex) {\r\n    // this.deleteDirectionsOverlaybyID(this.getStopOverlayID(stopIndex));\r\n    const id = this.getStopOverlayID(stopIndex);\r\n    this.deleteStoreFeatureByID(this.stopsStore, id);\r\n    this.routeStore.clear();\r\n    const stopsCounts = this.stops.length;\r\n    this.stops.removeAt(stopIndex);\r\n    this.stops.insert(stopIndex, this.createStop(this.directionsText(stopIndex, stopsCounts)));\r\n    this.routesResults = undefined;\r\n    this.getRoutes();\r\n  }\r\n\r\n  chooseProposal(proposal, i) {\r\n    if (proposal !== undefined) {\r\n      let geomCoord;\r\n      const geom = (proposal as any).geometry;\r\n      if (geom.type === 'Point') {\r\n        geomCoord = geom.coordinates;\r\n      } else if (geom.type.search('Line') >= 0) {\r\n        const line = (new OlGeoJSON()).readFeatures(geom);\r\n        geomCoord = line[0].getGeometry().getFirstCoordinate();\r\n        geomCoord = [geomCoord[0], geomCoord[1]];\r\n      } else if (geom.type.search('Polygon') >= 0) {\r\n        const poly = (new OlGeoJSON()).readFeatures(geom);\r\n        geomCoord = poly[0].getGeometry().getInteriorPoints().getFirstCoordinate();\r\n        geomCoord = [geomCoord[0], geomCoord[1]];\r\n      }\r\n\r\n      if (geomCoord !== undefined) {\r\n        this.stops.at(i).patchValue({ stopCoordinates: geomCoord });\r\n        this.addStopOverlay(geomCoord, i);\r\n      /*  const proposalExtent = this.directionsStopsOverlayDataSource.ol\r\n          .getFeatureById(this.getStopOverlayID(i))\r\n          .getGeometry()\r\n          .getExtent();*/\r\n\r\n       /* if (!olextent.intersects(proposalExtent, this.map.viewController.getExtent())) {\r\n          this.map.viewController.moveToExtent(proposalExtent);\r\n        }*/\r\n      }\r\n    }\r\n  }\r\n\r\n  focus(i) {\r\n    this.unlistenSingleClick();\r\n    this.currentStopIndex = i;\r\n    this.focusOnStop = true;\r\n    this.focusKey.push(\r\n      this.map.ol.once('singleclick', evt => {\r\n        this.handleMapClick(evt, i);\r\n      })\r\n    );\r\n  }\r\n\r\n  private handleMapClick(event: olcondition, indexPos?) {\r\n    if (this.currentStopIndex === undefined) {\r\n      this.addStop();\r\n      indexPos = this.stops.length - 2;\r\n      this.stops.at(indexPos).value.stopProposals = [];\r\n    } else {\r\n      indexPos = this.currentStopIndex;\r\n    }\r\n    const clickCoordinates = olproj.transform(\r\n      event.coordinate,\r\n      this.map.projection,\r\n      this.projection\r\n    );\r\n    this.stops.at(indexPos).patchValue({ stopProposals: [], stopCoordinates: clickCoordinates });\r\n\r\n    this.handleLocationProposals(clickCoordinates, indexPos);\r\n    this.addStopOverlay(clickCoordinates, indexPos);\r\n    setTimeout(() => {\r\n      this.focusOnStop = false; // prevent to trigger map click and Select on routes at same time.\r\n    }, 500);\r\n  }\r\n\r\n  geolocateStop(index: number) {\r\n    moveToOlFeatures(this.map, [this.map.geolocationFeature], FeatureMotion.Move);\r\n    const geolocateCoordinates = this.map.viewController.getCenter(this.projection);\r\n    this.stops.at(index).patchValue({ stopCoordinates: geolocateCoordinates });\r\n    this.addStopOverlay(geolocateCoordinates, index);\r\n    this.handleLocationProposals(geolocateCoordinates, index);\r\n  }\r\n\r\n  public addStopOverlay(coordinates: [number, number], index: number) {\r\n    const directionsText = this.directionsText(index);\r\n    let stopColor;\r\n    let stopText;\r\n    if (directionsText === 'start') {\r\n      stopColor = 'green';\r\n      stopText = this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.start'\r\n      );\r\n    } else if (directionsText === 'end') {\r\n      stopColor = 'red';\r\n      stopText = this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.end'\r\n      );\r\n    } else {\r\n      stopColor = 'yellow';\r\n      stopText =\r\n        this.languageService.translate.instant(\r\n          'igo.geo.directionsForm.intermediate'\r\n        ) +\r\n        ' #' +\r\n        index;\r\n    }\r\n\r\n    const geometry = new olgeom.Point(\r\n      olproj.transform(coordinates, this.projection, this.map.projection)\r\n    );\r\n\r\n    const stopID = this.getStopOverlayID(index);\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.map.projection,\r\n      dataProjection: this.map.projection\r\n    });\r\n\r\n    const previousStop = this.stopsStore.get(stopID);\r\n    const previousStopRevision = previousStop ? previousStop.meta.revision : 0;\r\n\r\n    const stopFeature: Feature = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.map.projection,\r\n      properties: {\r\n        id: stopID,\r\n        type: 'stop',\r\n        stopText,\r\n        stopColor,\r\n        stopOpacity: 1\r\n      },\r\n      meta: {\r\n        id: stopID,\r\n        revision: previousStopRevision + 1\r\n      },\r\n      ol: new olFeature({ geometry })\r\n    };\r\n\r\n    this.stopsStore.update(stopFeature);\r\n    this.getRoutes();\r\n\r\n  }\r\n\r\n  public getStopOverlayID(index: number): string {\r\n    let txt;\r\n    if (index === 0) {\r\n      txt = 'start';\r\n    } else if (index === this.stops.length - 1) {\r\n      txt = 'end';\r\n    } else {\r\n      txt = index;\r\n    }\r\n    return 'directionsStop_' + txt;\r\n  }\r\n\r\n  private deleteStoreFeatureByID(store, id) {\r\n    const entity = store.get(id);\r\n    if (entity) {\r\n      store.delete(entity);\r\n    }\r\n  }\r\n\r\n  private getUrl() {\r\n    if (!this.route) {\r\n      return;\r\n    }\r\n\r\n    const directionsKey = this.route.options.directionsCoordKey;\r\n    const stopsCoordinates = [];\r\n    if (\r\n      this.directionsFormService &&\r\n      this.directionsFormService.getStopsCoordinates() &&\r\n      this.directionsFormService.getStopsCoordinates().length !== 0\r\n    ) {\r\n      this.directionsFormService.getStopsCoordinates().forEach(coord => {\r\n        stopsCoordinates.push(roundCoordTo(coord, 6));\r\n      });\r\n    }\r\n    let directionsUrl = '';\r\n    if (stopsCoordinates.length >= 2) {\r\n      directionsUrl = `${directionsKey}=${stopsCoordinates.join(';')}`;\r\n    }\r\n\r\n    return `${location.origin}${\r\n      location.pathname\r\n    }?tool=directions&${directionsUrl}`;\r\n  }\r\n}\r\n\r\n/**\r\n * Create a style for the directions stops and routes\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function stopMarker(feature: olFeature, resolution: number): olstyle.Style {\r\n\r\n  const vertexStyle = [\r\n    new olstyle.Style({\r\n      geometry: feature.getGeometry(),\r\n      image: new olstyle.Circle({\r\n        radius: 7,\r\n        stroke: new olstyle.Stroke({ color: '#FF0000', width: 3 })\r\n      })\r\n    })\r\n  ];\r\n\r\n  const stopStyle = new olstyle.Style({\r\n    image: new olstyle.Icon({\r\n      src: './assets/igo2/geo/icons/place_' + feature.get('stopColor') + '_36px.svg',\r\n      opacity : feature.get('stopOpacity'),\r\n      imgSize: [36, 36], // for ie\r\n      anchor: [0.5, 0.92]\r\n    }),\r\n\r\n    text: new olstyle.Text({\r\n      text: feature.get('stopText'),\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n\r\n  const routeStyle = [\r\n    new olstyle.Style({\r\n      stroke: new olstyle.Stroke({ color: '#6a7982', width: 10, opacity: 0.75 })\r\n    }),\r\n    new olstyle.Style({\r\n      stroke: new olstyle.Stroke({ color: '#4fa9dd', width: 6, opacity: 0.75 })\r\n    })\r\n  ];\r\n\r\n  if (feature.get('type') === 'stop') {\r\n    return stopStyle;\r\n  }\r\n  if (feature.get('type') === 'vertex') {\r\n    return vertexStyle;\r\n  }\r\n  if (feature.get('type') === 'route') {\r\n    return routeStyle;\r\n  }\r\n\r\n}\r\n","import {\r\n  Directive,\r\n  Self,\r\n  AfterViewInit,\r\n  Optional\r\n} from '@angular/core';\r\n\r\nimport { RouteService } from '@igo2/core';\r\n\r\nimport { DirectionsFormComponent } from './directions-form.component';\r\nimport { DirectionsFormService } from './directions-form.service';\r\n\r\n@Directive({\r\n  selector: '[igoDirectionsFormBinding]'\r\n})\r\nexport class DirectionsFormBindingDirective implements AfterViewInit {\r\n\r\n  constructor(\r\n    @Self() private component: DirectionsFormComponent,\r\n    private directionsFormService: DirectionsFormService,\r\n    @Optional() private route: RouteService\r\n  ) {}\r\n\r\n  ngAfterViewInit(): void {\r\n    const storedStops = this.directionsFormService.getStops();\r\n    if (\r\n      !storedStops && this.route &&\r\n      this.route.options.directionsCoordKey\r\n    ) {\r\n      this.route.queryParams.subscribe(params => {\r\n        const directionsParams =\r\n          params[this.route.options.directionsCoordKey as string];\r\n        const stopsCoordinatesFromURL = [];\r\n        if (directionsParams) {\r\n          const directionsCoordUrl = directionsParams.split(';');\r\n          if (directionsCoordUrl.length >= 2) {\r\n            let cnt = 0;\r\n            directionsCoordUrl.forEach(coord => {\r\n              if (cnt !== 0 && cnt !== directionsCoordUrl.length - 1) {\r\n                this.component.stops.insert(cnt, this.component.createStop());\r\n              }\r\n\r\n              const stopCoordinatesFromURL = JSON.parse('[' + coord + ']');\r\n              this.component.stops\r\n                .at(cnt)\r\n                .patchValue({ stopCoordinates: stopCoordinatesFromURL });\r\n              this.component.stops\r\n                .at(cnt)\r\n                .patchValue({ stopPoint: stopCoordinatesFromURL });\r\n              this.component.handleLocationProposals(\r\n                stopCoordinatesFromURL,\r\n                cnt\r\n              );\r\n\r\n              stopsCoordinatesFromURL.push(stopCoordinatesFromURL);\r\n              this.component.addStopOverlay(stopCoordinatesFromURL, cnt);\r\n              cnt++;\r\n            });\r\n            this.component.getRoutes(true);\r\n          }\r\n        }\r\n      });\r\n    } else if (storedStops) {\r\n      for (let i = 0; i < storedStops.length; i++) {\r\n        if (i !== 0 && i !== storedStops.length - 1) {\r\n          this.component.stops.insert(i, this.component.createStop());\r\n        }\r\n        if (storedStops[i].stopCoordinates instanceof Array) {\r\n          this.component.addStopOverlay(storedStops[i].stopCoordinates, i);\r\n          this.component.stops.at(i).patchValue(storedStops[i] );\r\n        }\r\n      }\r\n      this.component.getRoutes();\r\n    }\r\n    this.component.writeStopsToFormService();\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\nimport {\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatListModule,\r\n  MatDividerModule,\r\n  MatFormFieldModule,\r\n  MatInputModule,\r\n  MatOptionModule,\r\n  MatSelectModule,\r\n  MatTooltipModule,\r\n  MatAutocompleteModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { DirectionsFormComponent } from './directions-form/directions-form.component';\r\nimport { DirectionsFormBindingDirective } from './directions-form/directions-form-binding.directive';\r\nimport { DirectionsFormService } from './directions-form/directions-form.service';\r\nimport { provideDirectionsSourceService } from './shared/directions-source.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatListModule,\r\n    MatDividerModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatAutocompleteModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [DirectionsFormComponent, DirectionsFormBindingDirective],\r\n  declarations: [DirectionsFormComponent, DirectionsFormBindingDirective],\r\n  providers: [DirectionsFormService, provideDirectionsSourceService()]\r\n})\r\nexport class IgoDirectionsModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoDirectionsModule\r\n    };\r\n  }\r\n}\r\n","import { SearchSource } from './sources/source';\r\nimport { SearchSourceService } from './search-source.service';\r\n\r\n/**\r\n * Search source factory\r\n * @ignore\r\n */\r\nexport function searchSourceServiceFactory(sources: SearchSource[]) {\r\n  return new SearchSourceService(sources);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the SearchSource service\r\n */\r\nexport function provideSearchSourceService() {\r\n  return {\r\n    provide: SearchSourceService,\r\n    useFactory: searchSourceServiceFactory,\r\n    deps: [SearchSource]\r\n  };\r\n}\r\n","import { Injectable, Inject, Injector } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport pointOnFeature from '@turf/point-on-feature';\r\n\r\nimport { FEATURE, Feature } from '../../../feature';\r\nimport { GoogleLinks } from './../../../utils/googleLinks';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  IChercheData,\r\n  IChercheResponse,\r\n  IChercheReverseData,\r\n  IChercheReverseResponse\r\n} from './icherche.interfaces';\r\n\r\n@Injectable()\r\nexport class IChercheSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n\r\n/**\r\n * ICherche search source\r\n */\r\n@Injectable()\r\nexport class IChercheSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'icherche';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  private hashtagsLieuxToKeep = [];\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    @Inject(IChercheSearchResultFormatter)\r\n    private formatter: IChercheSearchResultFormatter,\r\n    injector: Injector\r\n  ) {\r\n    super(options);\r\n\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    const ecmax =\r\n      this.options.params && this.options.params.ecmax\r\n        ? Number(this.options.params.ecmax)\r\n        : undefined;\r\n    const types =\r\n      this.options.params && this.options.params.type\r\n        ? this.options.params.type\r\n            .replace(/\\s/g, '')\r\n            .toLowerCase()\r\n            .split(',')\r\n        : [\r\n            'adresses',\r\n            'codes-postaux',\r\n            'routes',\r\n            'municipalites',\r\n            'mrc',\r\n            'regadmin',\r\n            'lieux'\r\n          ];\r\n    return {\r\n      title: 'igo.geo.search.icherche.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/icherche',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1,\r\n              hashtags: ['adresse']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldAddress',\r\n              value: 'anciennes-adresses',\r\n              enabled: types.indexOf('anciennes-adresses') !== -1,\r\n              hashtags: ['anciennes-adresses']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.postalCode',\r\n              value: 'codes-postaux',\r\n              enabled: types.indexOf('codes-postaux') !== -1,\r\n              hashtags: ['code-postal']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              hashtags: ['route']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1,\r\n              hashtags: ['municipalit', 'mun']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldCity',\r\n              value: 'anciennes-municipalites',\r\n              enabled: types.indexOf('anciennes-municipalites') !== -1,\r\n              hashtags: ['anciennes-municipalites']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1,\r\n              hashtags: ['mrc']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1,\r\n              hashtags: ['rgion-administrative', 'regadmin']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.entreprise',\r\n              value: 'entreprises',\r\n              enabled: types.indexOf('entreprises') !== -1,\r\n              available: false,\r\n              hashtags: ['entreprise']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.place',\r\n              value: 'lieux',\r\n              enabled: types.indexOf('lieux') !== -1,\r\n              hashtags: ['lieu']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.sumi',\r\n              value: 'bornes-sumi',\r\n              enabled: types.indexOf('bornes-sumi') !== -1,\r\n              hashtags: ['borne', 'bornes', 'sumi']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.km',\r\n              value: 'bornes-km',\r\n              enabled: false,\r\n              hashtags: ['borne', 'bornes', 'repre', 'km']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'ecmax',\r\n          name: 'ecmax',\r\n          values: [\r\n            {\r\n              title: '10 %',\r\n              value: 10,\r\n              enabled: ecmax === 10\r\n            },\r\n            {\r\n              title: '30 %',\r\n              value: 30,\r\n              enabled: ecmax === 30 || !ecmax\r\n            },\r\n            {\r\n              title: '50 %',\r\n              value: 50,\r\n              enabled: ecmax === 50\r\n            },\r\n            {\r\n              title: '75 %',\r\n              value: 75,\r\n              enabled: ecmax === 75\r\n            },\r\n            {\r\n              title: '100 %',\r\n              value: 100,\r\n              enabled: ecmax === 100\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'loc',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.map',\r\n              value: 'true',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.quebec',\r\n              value: 'false',\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(term, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http.get(`${this.searchUrl}/geocode`, { params }).pipe(\r\n      map((response: IChercheResponse) => this.extractResults(response)),\r\n      catchError(err => {\r\n        err.error.toDisplay = true;\r\n        err.error.title = this.languageService.translate.instant(\r\n          this.getDefaultOptions().title\r\n        );\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find(s => s.name === 'type');\r\n        typeSetting.values.forEach(v => {\r\n          const regex = new RegExp(`^${v.value}(\\\\.|$)`);\r\n          const typesMatched = types.filter(value => regex.test(value));\r\n          v.available = typesMatched.length > 0;\r\n          if (v.value === 'lieux') {\r\n            this.hashtagsLieuxToKeep = [\r\n              ...(new Set(\r\n                typesMatched\r\n                  .map(t => t.split('.'))\r\n                  .reduce((a, b) => a.concat(b))\r\n                  .filter(t => t !== 'lieux')\r\n              ) as any)\r\n            ];\r\n          }\r\n        });\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    const queryParams: any = Object.assign(\r\n      {\r\n        geometry: true,\r\n        bbox: true,\r\n        icon: true,\r\n        type:\r\n          'adresses,codes-postaux,municipalites,mrc,regadmin,lieux,entreprises,bornes-sumi'\r\n      },\r\n      this.params,\r\n      this.computeOptionsParam(term, options || {}).params,\r\n      {\r\n        q: this.computeTerm(term),\r\n        page: options.page\r\n      }\r\n    );\r\n\r\n    if (queryParams.loc === 'true') {\r\n      const [xMin, yMin, xMax, yMax] = options.extent;\r\n      queryParams.loc = `${xMin},${yMin};${xMax},${yMin};${xMax},${yMax};${xMin},${yMax};${xMin},${yMin}`;\r\n    } else if (queryParams.loc === 'false') {\r\n      delete queryParams.loc;\r\n    }\r\n\r\n    if (queryParams.q.indexOf('#') !== -1) {\r\n      queryParams.type = 'lieux';\r\n    }\r\n\r\n    return new HttpParams({ fromObject: ObjectUtils.removeUndefined(queryParams) });\r\n  }\r\n\r\n  private extractResults(response: IChercheResponse): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheData) => {\r\n      return this.formatter.formatResult(this.dataToResult(data, response));\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: IChercheData, response?: IChercheResponse): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.highlight.title || data.properties.nom;\r\n    const subtitleHtml = data.highlight.title2\r\n      ? ' <small> ' + data.highlight.title2 + '</small>'\r\n      : '';\r\n    const subtitleHtml2 = data.highlight.title3\r\n      ? '<br><small> ' + data.highlight.title3 + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml + subtitleHtml2,\r\n        icon: data.icon || 'map-marker',\r\n        nextPage: response.features.length % +this.options.params.limit === 0 && +this.options.params.page < 10\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheSearchSource.propertiesBlacklist\r\n    );\r\n\r\n    if (data.geometry === undefined) {\r\n      return Object.assign({ type: data.index }, properties);\r\n    }\r\n\r\n    const googleLinksProperties: {\r\n      GoogleMaps: string;\r\n      GoogleStreetView?: string;\r\n    } = {\r\n      GoogleMaps: ''\r\n    };\r\n\r\n    let googleMaps;\r\n    if (data.geometry.type === 'Point') {\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    } else {\r\n      const point = pointOnFeature(data.geometry);\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(point.geometry.coordinates[0], point.geometry.coordinates[1]);\r\n    }\r\n\r\n    let googleMapsNom;\r\n    if (data.index === 'routes') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(data.properties.nom + ', ' + data.properties.municipalite);\r\n    } else if (data.index === 'municipalites') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(data.properties.nom + ', ' + data.properties.regAdmin);\r\n    } else {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(data.properties.nom || data.highlight.title);\r\n    }\r\n\r\n    googleLinksProperties.GoogleMaps = '<a href=' + googleMaps + ' target=\"_blank\">' +\r\n      this.languageService.translate.instant('igo.geo.searchByCoord') + '</a> <br /> <a href=' + googleMapsNom +\r\n        ' target=\"_blank\">' + this.languageService.translate.instant('igo.geo.searchByName') + '</a>';\r\n\r\n    if (data.geometry.type === 'Point') {\r\n      googleLinksProperties.GoogleStreetView = GoogleLinks.getGoogleStreetViewLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    }\r\n\r\n    return Object.assign(\r\n      { type: data.index },\r\n      properties,\r\n      googleLinksProperties\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    // Keep hashtags for \"lieux\"\r\n    const hashtags = term.match(/(#[^\\s]+)/g) || [];\r\n    let keep = false;\r\n    keep = hashtags.some(hashtag => {\r\n      const hashtagKey = hashtag.substring(1);\r\n      return this.hashtagsLieuxToKeep.some(\r\n        h =>\r\n          h\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '') ===\r\n          hashtagKey\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n      );\r\n    });\r\n\r\n    if (!keep) {\r\n      term = term.replace(/(#[^\\s]*)/g, '');\r\n    }\r\n\r\n    return term.replace(/[^\\w- !\\-\\(\\),'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n}\r\n\r\n/**\r\n * IChercheReverse search source\r\n */\r\n@Injectable()\r\nexport class IChercheReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'icherchereverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    injector: Injector\r\n  ) {\r\n    super(options);\r\n\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const types =\r\n      this.options.params && this.options.params.type\r\n        ? this.options.params.type\r\n            .replace(/\\s/g, '')\r\n            .toLowerCase()\r\n            .split(',')\r\n        : ['adresses', 'municipalites', 'mrc', 'regadmin'];\r\n\r\n    return {\r\n      title: 'igo.geo.search.ichercheReverse.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/terrapi',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              available: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.district',\r\n              value: 'arrondissements',\r\n              enabled: types.indexOf('arrondissements') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'radius',\r\n          name: 'buffer',\r\n          values: [\r\n            {\r\n              title: '100 m',\r\n              value: 100,\r\n              enabled: !this.options.distance || this.options.distance === 100\r\n            },\r\n            {\r\n              title: '500 m',\r\n              value: 500,\r\n              enabled: this.options.distance === 500\r\n            },\r\n            {\r\n              title: '1 km',\r\n              value: 1000,\r\n              enabled: this.options.distance === 1000\r\n            },\r\n            {\r\n              title: '2 km',\r\n              value: 2000,\r\n              enabled: this.options.distance === 2000\r\n            },\r\n            {\r\n              title: '5 km',\r\n              value: 5000,\r\n              enabled: this.options.distance === 5000\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    return this.http.get(`${this.searchUrl}/locate`, { params }).pipe(\r\n      map((response: IChercheReverseResponse) => {\r\n        return this.extractResults(response);\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find(s => s.name === 'type');\r\n        typeSetting.values.forEach(v => {\r\n          v.available = types.indexOf(v.value as string) > -1;\r\n        });\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    if (options.distance || this.options.distance) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        buffer: options.distance || this.options.distance\r\n      });\r\n    }\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          loc: lonLat.join(','),\r\n          sort: 'distance',\r\n          geometry: true,\r\n          icon: true\r\n        },\r\n        options.params || {},\r\n        this.params\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: IChercheReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private getSubtitle(data: IChercheReverseData) {\r\n    if (!this.settings.length) {\r\n      return '';\r\n    }\r\n    let subtitle = '';\r\n    switch (data.properties.type) {\r\n      case 'arrondissements':\r\n        subtitle = data.properties.municipalite + ' (Arrondissement)';\r\n        break;\r\n      default:\r\n        const typeSetting = this.settings.find(s => s.name === 'type');\r\n        const type = typeSetting.values.find(\r\n          t => t.value === data.properties.type\r\n        );\r\n        if (type) {\r\n          subtitle = this.languageService.translate.instant(type.title);\r\n        }\r\n    }\r\n    return subtitle;\r\n  }\r\n\r\n  private dataToResult(data: IChercheReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.properties.nom;\r\n    const subtitleHtml = ' <small> ' + this.getSubtitle(data) + '</small>';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.icon || 'map-marker'\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheReverseData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheReverseSearchSource.propertiesBlacklist\r\n    );\r\n    return properties;\r\n  }\r\n\r\n  private computeExtent(\r\n    data: IChercheReverseData\r\n  ): [number, number, number, number] | undefined {\r\n    return data.bbox\r\n      ? [data.bbox[0], data.bbox[2], data.bbox[1], data.bbox[3]]\r\n      : undefined;\r\n  }\r\n}\r\n","import { Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  IChercheSearchSource,\r\n  IChercheSearchResultFormatter,\r\n  IChercheReverseSearchSource\r\n} from './icherche';\r\n\r\n/**\r\n * ICherche search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultIChercheSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new IChercheSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search result formatter\r\n */\r\nexport function provideDefaultIChercheSearchResultFormatter() {\r\n  return {\r\n    provide: IChercheSearchResultFormatter,\r\n    useFactory: defaultIChercheSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ICherche search source factory\r\n * @ignore\r\n */\r\nexport function ichercheSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  config: ConfigService,\r\n  formatter: IChercheSearchResultFormatter,\r\n  injector: Injector\r\n) {\r\n  return new IChercheSearchSource(\r\n    http,\r\n    languageService,\r\n    config.getConfig(`searchSources.${IChercheSearchSource.id}`),\r\n    formatter,\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search source\r\n */\r\nexport function provideIChercheSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheSearchSourceFactory,\r\n    multi: true,\r\n    deps: [\r\n      HttpClient,\r\n      LanguageService,\r\n      ConfigService,\r\n      IChercheSearchResultFormatter,\r\n      Injector\r\n    ]\r\n  };\r\n}\r\n\r\n/**\r\n * IChercheReverse search source factory\r\n * @ignore\r\n */\r\nexport function ichercheReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  config: ConfigService,\r\n  injector: Injector\r\n) {\r\n  return new IChercheReverseSearchSource(\r\n    http,\r\n    languageService,\r\n    config.getConfig(`searchSources.${IChercheReverseSearchSource.id}`),\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the IChercheReverse search source\r\n */\r\nexport function provideIChercheReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, ConfigService, Injector]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\n\r\nimport { FEATURE, Feature } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, ReverseSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { GoogleLinks } from '../../../utils/googleLinks';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { lonLatConversion, roundCoordTo } from '../../../map/shared/map.utils';\r\nimport { OsmLinks } from '../../../utils';\r\n\r\n@Injectable()\r\nexport class CoordinatesSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n/**\r\n * CoordinatesReverse search source\r\n */\r\n@Injectable()\r\nexport class CoordinatesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'coordinatesreverse';\r\n  static type = FEATURE;\r\n\r\n  private projections;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    @Inject('options') options: SearchSourceOptions,\r\n    private languageService: LanguageService,\r\n    @Inject('projections') projections: Projection[],\r\n  ) {\r\n    super(options);\r\n    this.projections = projections;\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n  }\r\n\r\n  getId(): string {\r\n    return CoordinatesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CoordinatesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'igo.geo.search.coordinates.name',\r\n      order: 1,\r\n      showInSettings: false\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    return of([this.dataToResult(lonLat)]);\r\n  }\r\n\r\n  private dataToResult(data: [number, number]): SearchResult<Feature> {\r\n    const convertedCoord = lonLatConversion(data, this.projections);\r\n    const coords = convertedCoord.reduce((obj, item) => (\r\n      obj[item.alias] = item.igo2CoordFormat, obj), {});\r\n\r\n    const roundedCoordString = roundCoordTo(data, 6).join(', ');\r\n\r\n    const coordKey =  this.languageService.translate.instant('igo.geo.search.coordinates.coord');\r\n    const coordLonLat = {};\r\n    coordLonLat[coordKey] = roundedCoordString;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [data[0], data[1]]\r\n        },\r\n        extent: undefined,\r\n        properties: Object.assign({},\r\n          coordLonLat,\r\n          coords,\r\n          {\r\n            GoogleMaps: GoogleLinks.getGoogleMapsCoordLink(data[0], data[1]),\r\n            GoogleStreetView: GoogleLinks.getGoogleStreetViewLink(\r\n              data[0],\r\n              data[1]\r\n            ),\r\n            OpenStreetMap: OsmLinks.getOpenStreetMapLink(data[0], data[1], 14)\r\n          }),\r\n        meta: {\r\n          id: data[0].toString() + ',' + data[1].toString(),\r\n          title: roundedCoordString\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id: data[0].toString() + ',' + data[1].toString(),\r\n        title: roundedCoordString,\r\n        icon: 'map-marker'\r\n      }\r\n    };\r\n  }\r\n}\r\n","import { ConfigService, LanguageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  CoordinatesReverseSearchSource,\r\n  CoordinatesSearchResultFormatter\r\n} from './coordinates';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { ProjectionService } from '../../../map/shared/projection.service';\r\n\r\n/**\r\n * ICherche search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultCoordinatesSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new CoordinatesSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search result formatter\r\n */\r\nexport function provideDefaultCoordinatesSearchResultFormatter() {\r\n  return {\r\n    provide: CoordinatesSearchResultFormatter,\r\n    useFactory: defaultCoordinatesSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * CoordinatesReverse search source factory\r\n * @ignore\r\n */\r\nexport function CoordinatesReverseSearchSourceFactory(\r\n  config: ConfigService,\r\n  languageService: LanguageService,\r\n  _projectionService: ProjectionService\r\n) {\r\n  return new CoordinatesReverseSearchSource(\r\n    config.getConfig(`searchSources.${CoordinatesReverseSearchSource.id}`),\r\n    languageService,\r\n    (config.getConfig('projections') as Projection[]) || []\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the IChercheReverse search source\r\n */\r\nexport function provideCoordinatesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: CoordinatesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService, LanguageService, ProjectionService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\nimport { LAYER } from '../../../layer';\r\nimport { QueryableDataSourceOptions, QueryFormat } from '../../../query';\r\nimport { QueryHtmlTarget } from './../../../query/shared/query.enums';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { TextSearchOptions } from './source.interfaces';\r\nimport {\r\n  ILayerSearchSourceOptions,\r\n  ILayerData,\r\n  ILayerItemResponse,\r\n  ILayerServiceResponse,\r\n  ILayerDataSource\r\n} from './ilayer.interfaces';\r\n\r\n@Injectable()\r\nexport class ILayerSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(data: ILayerData): ILayerData {\r\n    const allowedKey = [\r\n      'title',\r\n      'abstract',\r\n      'groupTitle',\r\n      'metadataUrl',\r\n      'downloadUrl',\r\n      'urlInfo',\r\n      'name'\r\n    ];\r\n\r\n    const property = Object.entries(data.properties)\r\n      .filter(([key]) => allowedKey.indexOf(key) !== -1)\r\n      .reduce((out: { [key: string]: any }, entries: [string, any]) => {\r\n        const [key, value] = entries;\r\n        let newKey;\r\n        try {\r\n          newKey = this.languageService.translate.instant(\r\n            'igo.geo.search.ilayer.properties.' + key\r\n          );\r\n        } catch (e) {\r\n          newKey = key;\r\n        }\r\n        out[newKey] = value ? value : '';\r\n        return out;\r\n      }, {});\r\n\r\n    const dataR = Object.assign({}, data);\r\n    dataR.properties = property as ILayerDataSource;\r\n\r\n    return dataR;\r\n  }\r\n}\r\n\r\n/**\r\n * ILayer search source\r\n */\r\n@Injectable()\r\nexport class ILayerSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'ilayer';\r\n  static type = LAYER;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    @Inject('options') options: ILayerSearchSourceOptions,\r\n    @Inject(ILayerSearchResultFormatter)\r\n    private formatter: ILayerSearchResultFormatter\r\n  ) {\r\n    super(options);\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n  }\r\n\r\n  getId(): string {\r\n    return ILayerSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return ILayerSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): ILayerSearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    return {\r\n      title: 'igo.geo.search.ilayer.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/layers/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.layer',\r\n              value: 'layer',\r\n              enabled: true,\r\n              hashtags: ['layer', 'layers', 'couche', 'couches']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.groupLayer',\r\n              value: 'group',\r\n              enabled: false,\r\n              hashtags: ['gr-layer', 'gr-layers', 'gr-couche', 'gr-couches']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a layer by name or keyword\r\n   * @param term Layer name or keyword\r\n   * @returns Observable of <SearchResult<LayerOptions>[]\r\n   */\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<ILayerItemResponse>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q') || !params.get('type')) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(\r\n        map((response: ILayerServiceResponse) => this.extractResults(response))\r\n      );\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: ObjectUtils.removeUndefined(\r\n        Object.assign(\r\n          {\r\n            q: this.computeTerm(term)\r\n          },\r\n          this.params,\r\n          this.computeOptionsParam(term, options || {}).params,\r\n          {\r\n            page: options.page\r\n          }\r\n        )\r\n      )\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    return term.replace(/(#[^\\s]*)/g, '').replace(/[^\\w- !\\-\\(\\),'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n\r\n  private extractResults(\r\n    response: ILayerServiceResponse\r\n  ): SearchResult<ILayerItemResponse>[] {\r\n    return response.items.map((data: ILayerData) =>\r\n      this.dataToResult(data, response)\r\n    );\r\n  }\r\n\r\n  private dataToResult(\r\n    data: ILayerData,\r\n    response?: ILayerServiceResponse\r\n  ): SearchResult<ILayerItemResponse> {\r\n    const layerOptions = this.computeLayerOptions(data);\r\n\r\n    const titleHtml = data.highlight.title || data.properties.title;\r\n    const groupTitle = data.highlight.groupTitle || data.properties.groupTitle;\r\n    const subtitleHtml = groupTitle\r\n      ? ' <small style=\"color: #6f6969\"> ' + groupTitle + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: LAYER,\r\n        id: [this.getId(), data.properties.id].join('.'),\r\n        title: data.properties.title,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.properties.type === 'Layer' ? 'layers' : 'map',\r\n        nextPage:\r\n          response.items.length % +this.options.params.limit === 0 &&\r\n          +this.options.params.page < 10\r\n      },\r\n      data: layerOptions\r\n    };\r\n  }\r\n\r\n  private computeLayerOptions(data: ILayerData): ILayerItemResponse {\r\n    const url = data.properties.url;\r\n    const queryParams: QueryableDataSourceOptions = this.extractQueryParamsFromSourceUrl(\r\n      url\r\n    );\r\n    return ObjectUtils.removeUndefined({\r\n      sourceOptions: {\r\n        id: data.properties.id,\r\n        type: data.properties.format,\r\n        url,\r\n        queryFormat: queryParams.queryFormat,\r\n        queryHtmlTarget: queryParams.queryHtmlTarget,\r\n        params: {\r\n          LAYERS: data.properties.name\r\n        },\r\n        optionsFromCapabilities: true,\r\n        crossOrigin: 'anonymous'\r\n      },\r\n      title: data.properties.title,\r\n      maxResolution: getResolutionFromScale(\r\n        Number(data.properties.maxScaleDenom)\r\n      ),\r\n      minResolution: getResolutionFromScale(\r\n        Number(data.properties.minScaleDenom)\r\n      ),\r\n      metadata: {\r\n        url: data.properties.metadataUrl,\r\n        extern: true\r\n      },\r\n      properties: this.formatter.formatResult(data).properties\r\n    });\r\n  }\r\n\r\n  private extractQueryParamsFromSourceUrl(\r\n    url: string\r\n  ): { queryFormat: QueryFormat; queryHtmlTarget: QueryHtmlTarget } {\r\n    let queryFormat;\r\n    let queryHtmlTarget;\r\n    const formatOpt = (this.options as ILayerSearchSourceOptions).queryFormat;\r\n    if (formatOpt) {\r\n      for (const key of Object.keys(formatOpt)) {\r\n        const value = formatOpt[key];\r\n        if (value === '*') {\r\n          queryFormat = QueryFormat[key.toUpperCase()];\r\n          break;\r\n        }\r\n\r\n        const urls = ((value as any) as { urls: string[] }).urls;\r\n        if (Array.isArray(urls)) {\r\n          urls.forEach(urlOpt => {\r\n            if (url.indexOf(urlOpt) !== -1) {\r\n              queryFormat = QueryFormat[key.toUpperCase()];\r\n            }\r\n          });\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (\r\n        queryFormat === QueryFormat.HTML ||\r\n        queryFormat === QueryFormat.HTMLGML2\r\n      ) {\r\n        queryHtmlTarget = 'iframe';\r\n      }\r\n    }\r\n\r\n    return {\r\n      queryFormat,\r\n      queryHtmlTarget\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { ILayerSearchSource, ILayerSearchResultFormatter } from './ilayer';\r\n\r\n/**\r\n * ILayer search result formatter factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new ILayerSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search result formatter\r\n */\r\nexport function provideILayerSearchResultFormatter() {\r\n  return {\r\n    provide: ILayerSearchResultFormatter,\r\n    useFactory: ilayerSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ILayer search source factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  config: ConfigService,\r\n  formatter: ILayerSearchResultFormatter\r\n) {\r\n  return new ILayerSearchSource(\r\n    http,\r\n    languageService,\r\n    config.getConfig(`searchSources.${ILayerSearchSource.id}`),\r\n    formatter\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search source\r\n */\r\nexport function provideILayerSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ilayerSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, ConfigService, ILayerSearchResultFormatter]\r\n  };\r\n}\r\n","import { FEATURE } from '../../feature';\r\nimport { LAYER } from '../../layer';\r\n\r\nexport const SEARCH_TYPES = [FEATURE, LAYER];\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-selector',\r\n  templateUrl: './search-selector.component.html',\r\n  styleUrls: ['./search-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSelectorComponent implements OnInit, OnDestroy {\r\n\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * The search type enabled\r\n   */\r\n  @Input()\r\n  set searchType(value: string) { this.setSearchType(value); }\r\n  get searchType(): string { return this.searchType$.value; }\r\n\r\n  /**\r\n   * Event emitted when the enabled search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  constructor(private searchSourceService: SearchSourceService) {}\r\n\r\n  ngOnInit() {\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Enable the selected search type\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Get a search type's title. The title\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  getSearchTypeTitle(searchType: string) {\r\n    return `igo.geo.search.${searchType.toLowerCase()}.title`;\r\n  }\r\n\r\n  /**\r\n   * Emit an event and enable the search sources of the given type.\r\n   * @param searchType Search type\r\n   */\r\n  private setSearchType(searchType: string | undefined) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchSourceService.enableSourcesByType(searchType);\r\n    this.searchTypeChange.emit(searchType);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  MatTooltipModule,\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatMenuModule,\r\n  MatRadioModule,\r\n  MatTabsModule,\r\n  MatCheckboxModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { SearchSelectorComponent } from './search-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatTabsModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSelectorComponent],\r\n  declarations: [SearchSelectorComponent]\r\n})\r\nexport class IgoSearchSelectorModule {}\r\n","import { MatCheckboxChange, MatRadioChange } from '@angular/material';\r\n\r\nimport {\r\n  Component,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  HostListener,\r\n  Input\r\n} from '@angular/core';\r\n\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\nimport { SearchSource } from '../shared/sources/source';\r\nimport {\r\n  SearchSourceSettings,\r\n  SettingOptions\r\n} from '../shared/sources/source.interfaces';\r\nimport { sourceCanReverseSearchAsSummary, sourceCanSearch, sourceCanReverseSearch } from '../shared/search.utils';\r\nimport { MediaService } from '@igo2/core';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-settings',\r\n  templateUrl: './search-settings.component.html',\r\n  styleUrls: ['./search-settings.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSettingsComponent implements OnInit {\r\n\r\n  public hasPointerReverseSearchSource: boolean = false;\r\n  public searchSourcesAllEnabled: boolean = false;\r\n\r\n  public buffer = [];\r\n  public lastKeyTime = Date.now();\r\n\r\n  get isTouchScreen(): boolean {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n\r\n  /**\r\n   * Event emitted when the enabled search source changes\r\n   */\r\n  @Output() searchSourceChange = new EventEmitter<SearchSource>();\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  @HostListener('document:keydown', ['$event'])\r\n  handleKeyboardEvent(event: KeyboardEvent) {\r\n\r\n    if (event.keyCode === 113) {\r\n      this.pointerSummaryEnabled = !this.pointerSummaryEnabled;\r\n      this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService\r\n    ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.hasPointerReverseSearchSource = this.hasReverseSearchSourcesForPointerSummary();\r\n  }\r\n\r\n  /**\r\n   * Get all search sources\r\n   * @internal\r\n   */\r\n  getSearchSources(): SearchSource[] {\r\n    const textSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanSearch)\r\n      .filter(s => s.available && s.getId() !== 'map' && s.showInSettings);\r\n\r\n    const reverseSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanReverseSearch)\r\n      .filter(s => s.available && s.getId() !== 'map' && s.showInSettings);\r\n    const sources = textSearchSources.concat(reverseSearchSources);\r\n    this.computeSourcesCheckAllBehavior(sources);\r\n    return sources;\r\n  }\r\n\r\n  /**\r\n   * Get all search sources usable for pointer summary\r\n   * @internal\r\n   */\r\n  hasReverseSearchSourcesForPointerSummary(): boolean {\r\n    if (this.searchSourceService.getEnabledSources().filter(sourceCanReverseSearchAsSummary).length) {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (checkbox style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedCheckbox(\r\n    event: MatCheckboxChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    settingValue.enabled = event.checked;\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (settings)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSettingCheckAllBehavior(setting: SearchSourceSettings) {\r\n    if (setting.allEnabled === undefined) {\r\n      if (setting.values.find(settingValue => settingValue.enabled)) {\r\n        setting.allEnabled = false;\r\n      } else {\r\n        setting.allEnabled = true;\r\n      }\r\n    } else {\r\n      setting.allEnabled = !setting.allEnabled;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (sources)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSourcesCheckAllBehavior(sources: SearchSource[]) {\r\n    const enabledSourcesCnt = sources.filter(source => source.enabled).length;\r\n    const disabledSourcesCnt = sources.filter(source => !source.enabled).length;\r\n    this.searchSourcesAllEnabled =  enabledSourcesCnt >= disabledSourcesCnt ? false : true;\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAll(event, source: SearchSource, setting: SearchSourceSettings) {\r\n    event.stopPropagation();\r\n    this.computeSettingCheckAllBehavior(setting);\r\n    setting.values.forEach(settingValue => {\r\n      settingValue.enabled = setting.allEnabled;\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAllSources(event) {\r\n    event.stopPropagation();\r\n    this.getSearchSources().map(source => {\r\n      source.enabled = this.searchSourcesAllEnabled;\r\n      this.searchSourceChange.emit(source);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (radiobutton style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedRadioButton(\r\n    event: MatRadioChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    setting.values.forEach(conf => {\r\n      if (conf.value !== settingValue.value) {\r\n        conf.enabled = !event.source.checked;\r\n      } else {\r\n        conf.enabled = event.source.checked;\r\n      }\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  onCheckSearchSource(event: MatCheckboxChange, source: SearchSource) {\r\n    source.enabled = event.checked;\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  getAvailableValues(setting: SearchSourceSettings) {\r\n    return setting.values.filter(s => s.available !== false);\r\n  }\r\n\r\n  getAvailableHashtagsValues(setting: SettingOptions) {\r\n    if (setting.hashtags) {\r\n      const output: string[] = [];\r\n      for (let value of setting.hashtags) {\r\n        value = '#' + value;\r\n        output.push(value);\r\n      }\r\n      return output;\r\n    }\r\n    return;\r\n  }\r\n\r\n  stopPropagation(event) {\r\n    event.stopPropagation();\r\n  }\r\n\r\n  changePointerReverseSearch(event, fromTitleButton?: boolean) {\r\n    if (fromTitleButton) {\r\n      event.stopPropagation();\r\n      this.pointerSummaryEnabled = !this.pointerSummaryEnabled;\r\n    } else {\r\n      this.pointerSummaryEnabled = event.checked;\r\n    }\r\n\r\n    this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { SearchSettingsComponent } from './search-settings.component';\r\nimport {\r\n  MatTooltipModule,\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatMenuModule,\r\n  MatRadioModule,\r\n  MatCheckboxModule,\r\n  MatDividerModule,\r\n  MatSlideToggleModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  declarations: [SearchSettingsComponent],\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatCheckboxModule,\r\n    MatDividerModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSettingsComponent]\r\n})\r\nexport class IgoSearchSettingsModule { }\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material';\r\n\r\nimport { BehaviorSubject, Subscription, EMPTY, timer } from 'rxjs';\r\nimport { debounce, distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\n\r\n/**\r\n * Searchbar that triggers a research in all search sources enabled.\r\n * If the store input is defined, the search results will be loaded\r\n * into that store. An event is always emitted when a research is completed.\r\n */\r\n@Component({\r\n  selector: 'igo-search-bar',\r\n  templateUrl: './search-bar.component.html',\r\n  styleUrls: ['./search-bar.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchBarComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Invalid keys\r\n   */\r\n  static invalidKeys = [\r\n    'Control',\r\n    'Shift',\r\n    'Alt',\r\n    'ArrowDown',\r\n    'ArrowUp',\r\n    'ArrowRight',\r\n    'ArrowLeft'\r\n  ];\r\n\r\n  readonly placeholder$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.search.placeholder'\r\n  );\r\n\r\n  readonly empty$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  /**\r\n   * Subscription to the ssearch bar term\r\n   */\r\n  private term$$: Subscription;\r\n\r\n  /**\r\n   * Search term stream\r\n   */\r\n  private stream$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Subscription to the search term stream\r\n   */\r\n  private stream$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  private researches$$: Subscription[];\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set searchType(value: string) {\r\n    this.setSearchType(value);\r\n  }\r\n  get searchType(): string {\r\n    return this.searchType$.value;\r\n  }\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated by the searchbar setting\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set term(value: string) {\r\n    this.setTerm(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n  readonly term$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Whether this component is disabled\r\n   */\r\n  @Input()\r\n  set disabled(value: boolean) {\r\n    this.disabled$.next(value);\r\n  }\r\n  get disabled(): boolean {\r\n    return this.disabled$.value;\r\n  }\r\n  readonly disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n  /**\r\n   * Whether a float label should be displayed\r\n   */\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  /**\r\n   * Icons color (search and clear)\r\n   */\r\n  @Input() color = 'primary';\r\n\r\n  /**\r\n   * Debounce time between each keystroke\r\n   */\r\n  @Input() debounce = 200;\r\n\r\n  /**\r\n   * Minimum term length required to trigger a research\r\n   */\r\n  @Input() minLength = 2;\r\n\r\n  /**\r\n   * Search icon\r\n   */\r\n  @Input() searchIcon: string;\r\n\r\n  /**\r\n   * Search Selector\r\n   */\r\n  @Input() searchSelector = false;\r\n\r\n  /**\r\n   * Search Settings\r\n   */\r\n  @Input() searchSettings = false;\r\n\r\n  /**\r\n   * Force coordinates in north america\r\n   */\r\n  @Input() forceNA = false;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * Event emitted when the search term changes\r\n   */\r\n  @Output() searchTermChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed\r\n   */\r\n  @Output() search = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() clearFeature = new EventEmitter();\r\n\r\n  /**\r\n   * Event emitted when the search settings changes\r\n   */\r\n  @Output() searchSettingsChange = new EventEmitter();\r\n\r\n  /**\r\n   * Input element\r\n   * @internal\r\n   */\r\n  @ViewChild('input') input: ElementRef;\r\n\r\n  /**\r\n   * Whether the search bar is empty\r\n   * @internal\r\n   */\r\n  get empty(): boolean {\r\n    return this.term.length === 0;\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private searchService: SearchService\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe((term: string) => {\r\n      this.empty$.next(term === undefined || term.length === 0);\r\n    });\r\n\r\n    this.stream$$ = this.stream$\r\n      .pipe(\r\n        debounce((term: string) => (term === '' ? EMPTY : timer(this.debounce)))\r\n      )\r\n      .subscribe((term: string) => this.onSetTerm(term));\r\n\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the search term stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.term$$.unsubscribe();\r\n    this.stream$$.unsubscribe();\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * When a user types, validates the key and send it into the\r\n   * stream if it's valid\r\n   * @param event Keyboard event\r\n   * @internal\r\n   */\r\n  onKeyup(event: KeyboardEvent) {\r\n    const key = event.key;\r\n    if (!this.keyIsValid(key)) {\r\n      return;\r\n    }\r\n    const term = (event.target as HTMLInputElement).value;\r\n    this.setTerm(term);\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   * @internal\r\n   */\r\n  onClearButtonClick() {\r\n    this.clear();\r\n    this.clearFeature.emit();\r\n  }\r\n\r\n  /**\r\n   * Update search type\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Update the placeholder with the enabled search type. The placeholder\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  setSearchType(searchType: string) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  onSearchSettingsChange() {\r\n    this.doSearch(this.term);\r\n    this.searchSettingsChange.emit();\r\n  }\r\n\r\n  /**\r\n   * Send the term into the stream only if this component is not disabled\r\n   * @param term Search term\r\n   */\r\n  setTerm(term: string) {\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    term = term || '';\r\n\r\n    if (term !== this.term) {\r\n      this.term$.next(term);\r\n    }\r\n\r\n    const slug = term.replace(/(#[^\\s]*)/g, '').trim();\r\n    if (slug.length >= this.minLength || slug.length === 0) {\r\n      this.stream$.next(term);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   */\r\n  private clear() {\r\n    this.term$.next('');\r\n    this.stream$.next('');\r\n    this.input.nativeElement.focus();\r\n  }\r\n\r\n  /**\r\n   * Validate if a given key stroke is a valid input\r\n   */\r\n  private keyIsValid(key: string) {\r\n    return SearchBarComponent.invalidKeys.indexOf(key) === -1;\r\n  }\r\n\r\n  /**\r\n   * When the search term changes, emit an event and trigger a\r\n   * research in every enabled search sources.\r\n   * @param term Search term\r\n   */\r\n  private onSetTerm(term: string | undefined) {\r\n    this.searchTermChange.emit(term);\r\n    this.doSearch(term);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchTypeChange.emit(searchType);\r\n\r\n    const placeholder = `igo.geo.search.${searchType.toLowerCase()}.placeholder`;\r\n    this.placeholder$.next(placeholder);\r\n\r\n    this.setTerm(this.term);\r\n  }\r\n\r\n  /**\r\n   * Execute the search\r\n   * @param term Search term\r\n   */\r\n  private doSearch(term: string | undefined) {\r\n    if (this.researches$$) {\r\n      this.researches$$.map(research => research.unsubscribe());\r\n      this.researches$$ = undefined;\r\n    }\r\n\r\n    const slug = term ? term.replace(/(#[^\\s]*)/g, '').trim() : '';\r\n    if (slug === '') {\r\n      if (this.store !== undefined) {\r\n        this.store.clear();\r\n      }\r\n      return;\r\n    }\r\n\r\n    const researches = this.searchService.search(term, {\r\n      forceNA: this.forceNA\r\n    });\r\n    this.researches$$ = researches.map(research => {\r\n      return research.request.subscribe((results: SearchResult[]) => {\r\n        this.onResearchCompleted(research, results);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * When a research  is completed, emit an event and update\r\n   * the store's items.\r\n   * @param research Research\r\n   * @param results Research results\r\n   */\r\n  private onResearchCompleted(research: Research, results: SearchResult[]) {\r\n    this.search.emit({ research, results });\r\n\r\n    if (this.store !== undefined) {\r\n      const newResults = this.store\r\n        .all()\r\n        .filter(result => result.source !== research.source)\r\n        .concat(results);\r\n      this.store.load(newResults);\r\n    }\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Self,\r\n  OnInit,\r\n  Optional,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { RouteService } from '@igo2/core';\r\n\r\nimport { SearchBarComponent } from './search-bar.component';\r\n\r\n@Directive({\r\n  selector: '[igoSearchUrlParam]'\r\n})\r\nexport class SearchUrlParamDirective implements OnInit {\r\n  constructor(\r\n    @Self() private component: SearchBarComponent,\r\n    private ref: ChangeDetectorRef,\r\n    @Optional() private route: RouteService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    if (this.route && this.route.options.searchKey) {\r\n      this.route.queryParams.subscribe(params => {\r\n        const searchParams = params[this.route.options.searchKey as string];\r\n        if (searchParams) {\r\n          this.component.setTerm(searchParams);\r\n          this.ref.detectChanges();\r\n        }\r\n      });\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport {\r\n  MatTooltipModule,\r\n  MatIconModule,\r\n  MatButtonModule,\r\n  MatMenuModule,\r\n  MatRadioModule,\r\n  MatFormFieldModule,\r\n  MatInputModule\r\n} from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoSearchSelectorModule } from '../search-selector/search-selector.module';\r\nimport { IgoSearchSettingsModule } from '../search-settings/search-settings.module';\r\nimport { SearchBarComponent } from './search-bar.component';\r\nimport { SearchUrlParamDirective } from './search-url-param.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    IgoLanguageModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    SearchBarComponent,\r\n  ],\r\n  declarations: [\r\n    SearchBarComponent,\r\n    SearchUrlParamDirective\r\n  ]\r\n})\r\nexport class IgoSearchBarModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ContentChild,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  TemplateRef,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { Observable, EMPTY, timer, BehaviorSubject } from 'rxjs';\r\nimport { debounce, map } from 'rxjs/operators';\r\n\r\nimport { EntityStore, EntityStoreWatcher } from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { TextSearchOptions } from '../shared/sources/source.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchSource } from '../shared/sources/source';\r\n\r\nexport enum SearchResultMode {\r\n  Grouped = 'grouped',\r\n  Flat = 'flat'\r\n}\r\n\r\n/**\r\n * List of search results with focus and selection capabilities.\r\n * This component is dumb and only emits events.\r\n */\r\n@Component({\r\n  selector: 'igo-search-results',\r\n  templateUrl: './search-results.component.html',\r\n  styleUrls: ['./search-results.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Reference to the SearchResultMode enum\r\n   * @internal\r\n   */\r\n  public searchResultMode = SearchResultMode;\r\n\r\n  /**\r\n   * Search results store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<SearchResult>;\r\n\r\n  public pageIterator: {sourceId: string}[] = [];\r\n\r\n  public collapsed: {sourceId: string}[] = [];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Search results display mode\r\n   */\r\n  @Input() mode: SearchResultMode = SearchResultMode.Grouped;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  get term(): string {\r\n    return this._term;\r\n  }\r\n  set term(value: string) {\r\n    this._term = value;\r\n    this.pageIterator = [];\r\n  }\r\n  public _term: string;\r\n\r\n  @Input() settingsChange$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  /**\r\n   * Event emitted when a result is focused\r\n   */\r\n  @Output() resultFocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is unfocused\r\n   */\r\n  @Output() resultUnfocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is selected\r\n   */\r\n  @Output() resultSelect = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed after displaying more results is clicked\r\n   */\r\n  @Output() moreResults = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Events emitted when a result is focus or unfocus by mouse event\r\n   */\r\n  @Output() resultMouseenter = new EventEmitter<SearchResult>();\r\n  @Output() resultMouseleave = new EventEmitter<SearchResult>();\r\n\r\n  @ContentChild('igoSearchItemToolbar') templateSearchToolbar: TemplateRef<any>;\r\n\r\n  get results$(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    if (this._results$ === undefined) {\r\n      this._results$ = this.liftResults();\r\n    }\r\n    return this._results$;\r\n  }\r\n  private _results$: Observable<\r\n    {source: SearchSource; results: SearchResult[]}[]\r\n  >;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef,\r\n              private searchService: SearchService) {}\r\n\r\n  /**\r\n   * Bind the search results store to the watcher\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n    this.settingsChange$.subscribe(() => {\r\n      this.pageIterator = [];\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unbind the search results store from the watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * Compute a group title\r\n   * @param group Search results group\r\n   * @returns Group title\r\n   * @internal\r\n   */\r\n  computeGroupTitle(group: {source: SearchSource; results: SearchResult[]}): string {\r\n    const parts = [group.source.title];\r\n    const count = group.results.length;\r\n    if (count > 1) {\r\n      parts.push(`(${count})`);\r\n    }\r\n    return parts.join(' ');\r\n  }\r\n\r\n  /**\r\n   * When a result is selected, update it's state in the store and emit\r\n   * an event. A selected result is also considered focused\r\n   * @param result Search result\r\n   * @internal\r\n   */\r\n  onResultSelect(result: SearchResult) {\r\n    if (this.store.state.get(result)) {\r\n      if (this.store.state.get(result).selected === true) {\r\n        return;\r\n      }\r\n    }\r\n    this.store.state.update(result, {focused: true, selected: true}, true);\r\n    this.resultSelect.emit(result);\r\n  }\r\n\r\n  /**\r\n   * Return an observable of the search results, grouped by search source\r\n   * @returns Observable of grouped search results\r\n   * @internal\r\n   */\r\n  private liftResults(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    return this.store.view.all$().pipe(\r\n      debounce((results: SearchResult[]) => {\r\n        return results.length === 0 ? EMPTY : timer(200);\r\n      }),\r\n      map((results: SearchResult[]) => {\r\n        return this.groupResults(results.sort(this.sortByOrder));\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Sort the results by display order.\r\n   * @param r1 First result\r\n   * @param r2 Second result\r\n   */\r\n  private sortByOrder(r1: SearchResult, r2: SearchResult) {\r\n    return r1.source.displayOrder - r2.source.displayOrder;\r\n  }\r\n\r\n  /**\r\n   * Group results by search source\r\n   * @param results Search results from all sources\r\n   * @returns Search results grouped by source\r\n   */\r\n  private groupResults(results: SearchResult[]): {source: SearchSource; results: SearchResult[]}[] {\r\n    const grouped = new Map<SearchSource, SearchResult[]>();\r\n    results.forEach((result: SearchResult) => {\r\n      const source = result.source;\r\n      let sourceResults = grouped.get(source);\r\n      if (sourceResults === undefined) {\r\n        sourceResults = [];\r\n        grouped.set(source, sourceResults);\r\n      }\r\n      sourceResults.push(result);\r\n    });\r\n\r\n    return Array.from(grouped.keys()).map((source: SearchSource) => {\r\n      if (this.pageIterator[source.getId()] === undefined) {\r\n        this.pageIterator[source.getId()] = 1;\r\n      }\r\n      return {source, results: grouped.get(source)};\r\n    });\r\n  }\r\n\r\n  isMoreResults(group: {source: SearchSource; results: SearchResult[]}) {\r\n    return group.results && group.results[group.results.length - 1].meta.nextPage === true;\r\n  }\r\n\r\n  displayMoreResults(group: {source: SearchSource; results: SearchResult[]}) {\r\n    const options: TextSearchOptions = {\r\n      sourceId: group.source.getId(),\r\n      page: ++this.pageIterator[group.source.getId()]\r\n    };\r\n\r\n    const researches = this.searchService.search(this.term, options);\r\n    researches.map(research => {\r\n      research.request.subscribe((results: SearchResult[]) => {\r\n        const newResults = group.results.concat(results);\r\n        if (!results.length) {\r\n          newResults[newResults.length - 1].meta.nextPage = false;\r\n        }\r\n        this.moreResults.emit({research, results: newResults});\r\n      });\r\n    });\r\n    return;\r\n  }\r\n}\r\n","import { Component, Input, ChangeDetectionStrategy, EventEmitter, Output } from '@angular/core';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport {\r\n  getEntityTitle,\r\n  getEntityTitleHtml,\r\n  getEntityIcon\r\n} from '@igo2/common';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { FeatureMotion, moveToOlFeatures } from '../../feature';\r\nimport { IgoMap } from '../../map';\r\n\r\n/**\r\n * Search results list item\r\n */\r\n@Component({\r\n  selector: 'igo-search-results-item',\r\n  templateUrl: './search-results-item.component.html',\r\n  styleUrls: ['./search-results-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsItemComponent {\r\n  /**\r\n   * Search result item\r\n   */\r\n  @Input() result: SearchResult;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search result title\r\n   * @internal\r\n   */\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  @Output() zoomEvent = new EventEmitter<boolean>();\r\n\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get title(): string {\r\n    return getEntityTitle(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result HTML title\r\n   * @internal\r\n   */\r\n  get titleHtml(): string {\r\n    return getEntityTitleHtml(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result tooltip\r\n   * @internal\r\n   */\r\n  get tooltipHtml(): string {\r\n    return this.titleHtml\r\n      .replace(/<small?[^>]+(>|$)/g, '\\n')\r\n      .replace(/<\\/?[^>]+(>|$)/g, '');\r\n  }\r\n\r\n  /**\r\n   * Search result icon\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.result);\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  onZoomHandler() {\r\n    const olFeature = this.format.readFeature(this.result.data, {\r\n      dataProjection: this.result.data.projection,\r\n      featureProjection: this.map.projection\r\n    });\r\n    moveToOlFeatures(this.map, [olFeature], FeatureMotion.Default);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { LayerOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { LAYER } from '../../layer/shared/layer.enums';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-search-add-button',\r\n  templateUrl: './search-results-add-button.component.html',\r\n  styleUrls: ['./search-results-add-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultAddButtonComponent implements OnInit, OnDestroy {\r\n  public tooltip$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.catalog.layer.addToMap'\r\n  );\r\n\r\n  private resolution$$: Subscription;\r\n\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private layersSubcriptions = [];\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  @Input() layer: SearchResult;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added: boolean;\r\n\r\n  /**\r\n   * The map to add the search result layer to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private layerService: LayerService) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    if (this.layer.meta.dataType === 'Layer') {\r\n      this.added =\r\n        this.map.layers.findIndex(\r\n          lay => lay.id === this.layer.data.sourceOptions.id\r\n        ) !== -1;\r\n    }\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(value => {\r\n      this.isInResolutionsRange(value);\r\n      this.tooltip$.next(this.computeTooltip());\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove();\r\n          } else {\r\n            this.add();\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add();\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove();\r\n          this.isPreview$.next(false);\r\n        }\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  private add() {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addLayerToMap();\r\n    }\r\n  }\r\n\r\n  private remove() {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.removeLayerFromMap();\r\n      this.layersSubcriptions.map(s => s.unsubscribe());\r\n      this.layersSubcriptions = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private addLayerToMap() {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const layerOptions = (this.layer as SearchResult<LayerOptions>).data;\r\n    if (layerOptions.sourceOptions.optionsFromApi === undefined) {\r\n      layerOptions.sourceOptions.optionsFromApi = true;\r\n    }\r\n    this.layersSubcriptions.push(\r\n      this.layerService\r\n        .createAsyncLayer(layerOptions)\r\n        .subscribe(layer => this.map.addLayer(layer))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private removeLayerFromMap() {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const oLayer = this.map.getLayerById(this.layer.data.sourceOptions.id);\r\n    this.map.removeLayer(oLayer);\r\n  }\r\n\r\n  isInResolutionsRange(resolution: number) {\r\n    const minResolution = this.layer.data.minResolution || 0;\r\n    const maxResolution = this.layer.data.maxResolution || Infinity;\r\n    this.inRange$.next(\r\n      resolution >= minResolution && resolution <= maxResolution\r\n    );\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  MatTooltipModule,\r\n  MatIconModule,\r\n  MatListModule,\r\n  MatButtonModule,\r\n  MatBadgeModule\r\n} from '@angular/material';\r\n\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoMatBadgeIconModule,\r\n  IgoStopPropagationModule\r\n} from '@igo2/common';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { SearchResultsComponent } from './search-results.component';\r\nimport { SearchResultsItemComponent } from './search-results-item.component';\r\nimport { SearchResultAddButtonComponent } from './search-results-add-button.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatButtonModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoStopPropagationModule,\r\n    IgoLanguageModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoMetadataModule,\r\n  ],\r\n  exports: [\r\n    SearchResultsComponent,\r\n    SearchResultAddButtonComponent\r\n  ],\r\n  declarations: [\r\n    SearchResultsComponent,\r\n    SearchResultsItemComponent,\r\n    SearchResultAddButtonComponent\r\n  ]\r\n})\r\nexport class IgoSearchResultsModule {}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit,\r\n  HostListener,\r\n  AfterContentChecked\r\n} from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { MapBrowserPointerEvent as OlMapBrowserPointerEvent } from 'ol/MapBrowserEvent';\r\nimport { ListenerFunction } from 'ol/events';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchService } from './search.service';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport { transform } from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport * as olgeom from 'ol/geom';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport { SearchResult, Research } from './search.interfaces';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { take } from 'rxjs/operators';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureMotion, FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { sourceCanReverseSearchAsSummary } from './search.utils';\r\nimport { MediaService } from '@igo2/core';\r\n\r\n/**\r\n * This directive makes the mouse coordinate trigger a reverse search on available search sources.\r\n * The search results are placed into a label, on a cross icon, representing the mouse coordinate.\r\n * By default, no search sources. Config in config file must be defined.\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoSearchPointerSummary]'\r\n})\r\nexport class SearchPointerSummaryDirective implements OnInit, OnDestroy, AfterContentChecked {\r\n\r\n  public store: FeatureStore<Feature>;\r\n  private lonLat: [number, number];\r\n  private pointerSearchStore: EntityStore<SearchResult> = new EntityStore<SearchResult>([]);\r\n  private lastTimeoutRequest;\r\n  private store$$: Subscription;\r\n  private layers$$: Subscription;\r\n  private reverseSearch$$: Subscription[] = [];\r\n  private hasPointerReverseSearchSource: boolean =  false;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener: ListenerFunction;\r\n\r\n  private searchPointerSummaryFeatureId: string = 'searchPointerSummaryFeatureId';\r\n  /**\r\n   * The delay where the mouse must be motionless before trigger the reverse search\r\n   */\r\n  @Input() igoSearchPointerSummaryDelay: number = 1000;\r\n\r\n  /**\r\n   * If the user has enabled or not the directive\r\n   */\r\n  @Input() igoSearchPointerSummaryEnabled: boolean = false;\r\n\r\n  @HostListener('mouseout')\r\n  mouseout() {\r\n    clearTimeout(this.lastTimeoutRequest);\r\n    this.clearLayer();\r\n  }\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private searchService: SearchService,\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.listenToMapPointerMove();\r\n    this.subscribeToPointerStore();\r\n\r\n    this.map.status$.pipe(take(1)).subscribe(() => {\r\n      this.store = new FeatureStore<Feature>([], {map: this.map});\r\n      this.initStore();\r\n    });\r\n\r\n    // To handle context change without using the contextService.\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      if (this.store && !layers.find(l => l.id === 'searchPointerSummaryId')) {\r\n        this.initStore();\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Initialize the pointer position store\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      id : 'searchPointerSummaryId',\r\n      title: 'searchPointerSummary',\r\n      zIndex: 900,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: pointerPositionSummaryMarker\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n  }\r\n\r\n  ngAfterContentChecked(): void {\r\n      if (!this.searchSourceService.getEnabledSources().filter(sourceCanReverseSearchAsSummary).length) {\r\n        this.hasPointerReverseSearchSource = false;\r\n      } else {\r\n        this.hasPointerReverseSearchSource = true;\r\n      }\r\n    }\r\n\r\n  /**\r\n   * Stop listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unsubscribeToPointerStore();\r\n    this.unsubscribeReverseSearch();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to pointermove result store\r\n   * @internal\r\n   */\r\n  subscribeToPointerStore() {\r\n    this.store$$ = this.pointerSearchStore.entities$.subscribe(resultsUnderPointerPosition => {\r\n      this.entitiesToPointerOverlay(resultsUnderPointerPosition);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Build an object based on the closest feature by type (base on type and distance properties )\r\n   * @param results SearchResult[]\r\n   * @returns OL style function\r\n   */\r\n  private computeSummaryClosestFeature(results: SearchResult[]): {} {\r\n    const closestResultByType = {};\r\n\r\n    results.map(result => {\r\n      if (result.data.properties.type && result.data.properties.distance >= 0) {\r\n        if (closestResultByType.hasOwnProperty(result.data.properties.type)) {\r\n          const prevDistance = closestResultByType[result.data.properties.type].distance;\r\n          if (result.data.properties.distance < prevDistance) {\r\n            closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title: result.meta.title };\r\n          }\r\n        } else {\r\n          closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title: result.meta.title };\r\n        }\r\n      }\r\n    });\r\n\r\n    return closestResultByType;\r\n  }\r\n\r\n  /**\r\n   * convert store entities to a pointer position overlay with label summary on.\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private entitiesToPointerOverlay(resultsUnderPointerPosition: SearchResult[]) {\r\n    const closestResultByType = this.computeSummaryClosestFeature(resultsUnderPointerPosition);\r\n    const summarizedClosestType = Object.keys(closestResultByType);\r\n    const processedSummarizedClosestType = [];\r\n    const summary = [];\r\n    resultsUnderPointerPosition.map(result => {\r\n      const typeIndex = summarizedClosestType.indexOf(result.data.properties.type);\r\n      if (typeIndex !== -1) {\r\n        summary.push(closestResultByType[result.data.properties.type].title);\r\n        summarizedClosestType.splice(typeIndex, 1);\r\n        processedSummarizedClosestType.push(result.data.properties.type);\r\n      } else {\r\n        if (processedSummarizedClosestType.indexOf(result.data.properties.type) === -1) {\r\n          summary.push(result.meta.title);\r\n        }\r\n      }\r\n    });\r\n    if (summary.length) {\r\n      this.addPointerOverlay(summary.join('\\n'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: OlMapBrowserPointerEvent) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to pointer store.\r\n   * @internal\r\n   */\r\n  unsubscribeToPointerStore() {\r\n    this.store$$.unsubscribe();\r\n  }\r\n  /**\r\n   * Unsubscribe to reverse seatch store.\r\n   * @internal\r\n   */\r\n  unsubscribeReverseSearch() {\r\n    this.reverseSearch$$.map(s => s.unsubscribe());\r\n    this.reverseSearch$$ = [];\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   * @internal\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    this.map.ol.un(this.pointerMoveListener.type, this.pointerMoveListener.listener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Trigger reverse search when the mouse is motionless during the defined delay (pointerMoveDelay).\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: OlMapBrowserPointerEvent) {\r\n    if (\r\n      event.dragging || !this.igoSearchPointerSummaryEnabled ||\r\n      !this.hasPointerReverseSearchSource || this.mediaService.isTouchScreen()) {\r\n      this.clearLayer();\r\n      return;\r\n    }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n      this.clearLayer();\r\n      this.unsubscribeReverseSearch();\r\n    }\r\n\r\n    this.lonLat = transform(event.coordinate, this.mapProjection, 'EPSG:4326');\r\n\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.onSearchCoordinate();\r\n    }, this.igoSearchPointerSummaryDelay);\r\n  }\r\n\r\n  private onSearchCoordinate() {\r\n    this.pointerSearchStore.clear();\r\n    const results = this.searchService.reverseSearch(this.lonLat, { params: { geometry: 'false', icon: 'false' } }, true);\r\n\r\n    for (const i in results) {\r\n      if (results.length > 0) {\r\n        this.reverseSearch$$.push(\r\n          results[i].request.subscribe((_results: SearchResult<Feature>[]) => {\r\n            this.onSearch({ research: results[i], results: _results });\r\n          }));\r\n      }\r\n    }\r\n  }\r\n\r\n  private onSearch(event: { research: Research; results: SearchResult[] }) {\r\n    const results = event.results;\r\n    const newResults = this.pointerSearchStore.all()\r\n      .filter((result: SearchResult) => result.source !== event.research.source)\r\n      .concat(results);\r\n    this.pointerSearchStore.load(newResults);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the pointer store\r\n   * @param text string\r\n   */\r\n  private addPointerOverlay(text: string) {\r\n    this.clearLayer();\r\n\r\n    const geometry = new olgeom.Point(\r\n      transform(this.lonLat, 'EPSG:4326', this.mapProjection)\r\n    );\r\n    const feature = new olFeature({ geometry });\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.mapProjection,\r\n      dataProjection: this.mapProjection\r\n    });\r\n\r\n    const f: Feature = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.mapProjection,\r\n      properties: {\r\n        id: this.searchPointerSummaryFeatureId,\r\n        pointerSummary: text\r\n      },\r\n      meta: {\r\n        id: this.searchPointerSummaryFeatureId\r\n      },\r\n      ol: feature\r\n    };\r\n    this.store.setLayerFeatures([f], FeatureMotion.None);\r\n  }\r\n\r\n/**\r\n * Clear the pointer store features\r\n */\r\nprivate clearLayer() {\r\n  if (this.store) {\r\n    this.store.clearLayer();\r\n  }\r\n}\r\n\r\n}\r\n\r\n/**\r\n * Create a default style for the pointer position and it's label summary.\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function pointerPositionSummaryMarker(feature: olFeature, resolution: number): olstyle.Style {\r\n  return new olstyle.Style({\r\n    image: new olstyle.Icon({\r\n      src: './assets/igo2/geo/icons/cross_black_18px.svg',\r\n      imgSize: [18, 18], // for ie\r\n    }),\r\n\r\n    text: new olstyle.Text({\r\n      text: feature.get('pointerSummary'),\r\n      textAlign: 'left',\r\n      textBaseline: 'bottom',\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      backgroundFill: new olstyle.Fill({ color: 'rgba(255, 255, 255, 0.5)' }),\r\n      backgroundStroke: new olstyle.Stroke({ color: 'rgba(200, 200, 200, 0.75)', width: 2 }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true,\r\n      offsetX: 10,\r\n      offsetY: -10,\r\n      padding: [2.5, 2.5, 2.5, 2.5]\r\n    })\r\n  });\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { provideSearchSourceService } from './shared/search-source-service.providers';\r\nimport { provideDefaultIChercheSearchResultFormatter } from './shared/sources/icherche.providers';\r\nimport { provideDefaultCoordinatesSearchResultFormatter } from './shared/sources/coordinates.providers';\r\nimport { provideILayerSearchResultFormatter } from './shared/sources/ilayer.providers';\r\n\r\nimport { IgoSearchBarModule } from './search-bar/search-bar.module';\r\nimport { IgoSearchSelectorModule } from './search-selector/search-selector.module';\r\nimport { IgoSearchResultsModule } from './search-results/search-results.module';\r\nimport { IgoSearchSettingsModule } from './search-settings/search-settings.module';\r\nimport { SearchPointerSummaryDirective } from './shared/search-pointer-summary.directive';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule,\r\n    SearchPointerSummaryDirective\r\n  ],\r\n  declarations: [SearchPointerSummaryDirective]\r\n})\r\nexport class IgoSearchModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoSearchModule,\r\n      providers: [\r\n        provideSearchSourceService(),\r\n        provideDefaultIChercheSearchResultFormatter(),\r\n        provideDefaultCoordinatesSearchResultFormatter(),\r\n        provideILayerSearchResultFormatter()\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { Component, Input, Output, EventEmitter } from '@angular/core';\r\n\r\nimport { FlexibleState, getEntityTitle } from '@igo2/common';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport { Feature } from '../feature/shared/feature.interfaces';\r\nimport { FeatureMotion } from '../feature/shared/feature.enums';\r\nimport { moveToOlFeatures } from '../feature/shared/feature.utils';\r\nimport { IgoMap } from '../map/shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-toast',\r\n  templateUrl: './toast.component.html',\r\n  styleUrls: ['./toast.component.scss']\r\n})\r\nexport class ToastComponent {\r\n  static SWIPE_ACTION = {\r\n    UP: 'swipeup',\r\n    DOWN: 'swipedown'\r\n  };\r\n  private format = new olFormatGeoJSON();\r\n\r\n  @Input()\r\n  get expanded(): boolean {\r\n    return this._expanded;\r\n  }\r\n  set expanded(value: boolean) {\r\n    this.state = value ? 'expanded' : 'collapsed';\r\n    this._expanded = value;\r\n  }\r\n  private _expanded: boolean;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get feature(): Feature {\r\n    return this._feature;\r\n  }\r\n  set feature(value: Feature) {\r\n    this._feature = value;\r\n  }\r\n  private _feature: Feature;\r\n\r\n  @Output() opened = new EventEmitter<boolean>();\r\n\r\n  public state: FlexibleState;\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return getEntityTitle(this.feature); }\r\n\r\n  constructor() {}\r\n\r\n  toggle() {\r\n    this.expanded = !this.expanded;\r\n    this.opened.emit(this.expanded);\r\n  }\r\n\r\n  zoomToFeatureExtent() {\r\n    if (this.feature.geometry) {\r\n      const olFeature = this.format.readFeature(this.feature, {\r\n        dataProjection: this.feature.projection,\r\n        featureProjection: this.map.projection\r\n      });\r\n      moveToOlFeatures(this.map, [olFeature], FeatureMotion.Zoom);\r\n    }\r\n  }\r\n\r\n  swipe(action: string) {\r\n    if (action === ToastComponent.SWIPE_ACTION.UP) {\r\n      if (!this.expanded) {\r\n        this.toggle();\r\n      }\r\n    } else if (action === ToastComponent.SWIPE_ACTION.DOWN) {\r\n      if (this.expanded) {\r\n        this.toggle();\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule, MatButtonModule } from '@angular/material';\r\n\r\nimport { IgoPanelModule, IgoFlexibleModule } from '@igo2/common';\r\n\r\nimport { IgoFeatureModule } from '../feature/feature.module';\r\nimport { ToastComponent } from './toast.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    IgoPanelModule,\r\n    IgoFlexibleModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [ToastComponent],\r\n  declarations: [ToastComponent]\r\n})\r\nexport class IgoToastModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoToastModule\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { OnUpdateInputs, WidgetComponent } from '@igo2/common';\r\n\r\nimport { Layer } from '../../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../../map/shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter',\r\n  templateUrl: './ogc-filter.component.html',\r\n  styleUrls: ['./ogc-filter.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterComponent implements OnUpdateInputs, WidgetComponent {\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Event emitted on complete\r\n   */\r\n  @Output() complete = new EventEmitter<void>();\r\n\r\n  /**\r\n   * Event emitted on cancel\r\n   */\r\n  @Output() cancel = new EventEmitter<void>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Implemented as part of OnUpdateInputs\r\n   */\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * On close, emit the cancel event\r\n   */\r\n  onClose() {\r\n    this.cancel.emit();\r\n  }\r\n\r\n}\r\n","import { InjectionToken } from '@angular/core';\r\n\r\nimport { Widget, WidgetService } from '@igo2/common';\r\n\r\nimport { OgcFilterComponent } from './ogc-filter/ogc-filter.component';\r\n\r\nexport const OgcFilterWidget = new InjectionToken<Widget>('OgcFilterWidget');\r\n\r\nexport function ogcFilterWidgetFactory(widgetService: WidgetService): Widget {\r\n  return widgetService.create(OgcFilterComponent);\r\n}\r\n\r\nexport function provideOgcFilterWidget() {\r\n  return {\r\n    provide: OgcFilterWidget,\r\n    useFactory: ogcFilterWidgetFactory,\r\n    deps: [WidgetService]\r\n  };\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoFilterModule } from '../../../filter/filter.module';\r\nimport { OgcFilterComponent } from './ogc-filter.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [OgcFilterComponent],\r\n  declarations: [OgcFilterComponent],\r\n  entryComponents: [OgcFilterComponent]\r\n})\r\nexport class IgoOgcFilterModule {}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\n\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface WfsWorkspaceOptions extends WorkspaceOptions {\r\n  layer: VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class WfsWorkspace extends Workspace {\r\n\r\n  get layer(): VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: WfsWorkspaceOptions) {\r\n    super(options);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport {\r\n  ActionStore,\r\n  EntityTableTemplate\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy\r\n} from '../../feature';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams } from '../../datasource';\r\n\r\nimport { WfsWorkspace } from './wfs-workspace';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WfsWorkspaceService {\r\n\r\n  constructor() {}\r\n\r\n  createWorkspace(layer: VectorLayer, map: IgoMap): WfsWorkspace {\r\n    return new WfsWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      entityStore: this.createFeatureStore(layer, map),\r\n      actionStore: new ActionStore([]),\r\n      meta: {\r\n        tableTemplate: this.createTableTemplate(layer)\r\n      }\r\n    });\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], {map});\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      map,\r\n      hitTolerance: 5\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name\r\n      };\r\n    });\r\n\r\n    return {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\n\r\nimport { ImageLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface WmsWorkspaceOptions extends WorkspaceOptions {\r\n  layer: ImageLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class WmsWorkspace extends Workspace {\r\n\r\n  get layer(): ImageLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: WmsWorkspaceOptions) {\r\n    super(options);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ActionStore } from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy\r\n} from '../../feature';\r\nimport { ImageLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { WmsWorkspace } from './wms-workspace';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WmsWorkspaceService {\r\n\r\n  constructor() {}\r\n\r\n  createWorkspace(layer: ImageLayer, map: IgoMap): WmsWorkspace {\r\n    return new WmsWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      actionStore: new ActionStore([])\r\n    });\r\n  }\r\n\r\n}\r\n","import { Directive, Input, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { Workspace, WorkspaceStore, WorkspaceSelectorComponent } from '@igo2/common';\r\n\r\nimport { Layer, ImageLayer, VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { WFSDataSource, WMSDataSource } from '../../datasource';\r\nimport { OgcFilterableDataSourceOptions } from '../../filter';\r\n\r\nimport { WfsWorkspaceService } from '../shared/wfs-workspace.service';\r\nimport { WmsWorkspaceService } from '../shared/wms-workspace.service';\r\n\r\n@Directive({\r\n  selector: '[igoWorkspaceSelector]'\r\n})\r\nexport class WorkspaceSelectorDirective implements OnInit, OnDestroy {\r\n\r\n  private layers$$: Subscription;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  get workspaceStore(): WorkspaceStore {\r\n    return this.component.store;\r\n  }\r\n\r\n  constructor(\r\n    private component: WorkspaceSelectorComponent,\r\n    private wfsWorkspaceService: WfsWorkspaceService,\r\n    private wmsWorkspaceService: WmsWorkspaceService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$\r\n      .pipe(debounceTime(50))\r\n      .subscribe((layers: Layer[]) =>\r\n        this.onLayersChange(layers)\r\n      );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  private onLayersChange(layers: Layer[]) {\r\n    const editableLayers = layers.filter((layer: Layer) =>\r\n      this.layerIsEditable(layer)\r\n    );\r\n    const editableLayersIds = editableLayers.map((layer: Layer) => layer.id);\r\n\r\n    const workspacesToAdd = editableLayers\r\n      .map((layer: VectorLayer) => this.getOrCreateWorkspace(layer))\r\n      .filter((workspace: Workspace | undefined) => workspace !== undefined);\r\n\r\n    const workspacesToRemove = this.workspaceStore.all()\r\n      .filter((workspace: Workspace) => {\r\n        return editableLayersIds.indexOf(workspace.id) < 0;\r\n      });\r\n\r\n    if (workspacesToRemove.length > 0) {\r\n      workspacesToRemove.forEach((workspace: Workspace) => {\r\n        workspace.deactivate();\r\n      });\r\n      this.workspaceStore.state.updateMany(workspacesToRemove, {active: false, selected: false});\r\n      this.workspaceStore.deleteMany(workspacesToRemove);\r\n    }\r\n\r\n    if (workspacesToAdd.length > 0) {\r\n      this.workspaceStore.insertMany(workspacesToAdd);\r\n    }\r\n  }\r\n\r\n  private getOrCreateWorkspace(layer: VectorLayer | ImageLayer): Workspace | undefined {\r\n    const workspace = this.workspaceStore.get(layer.id);\r\n    if (workspace !== undefined) {\r\n      return;\r\n    }\r\n    if (layer.dataSource instanceof WFSDataSource) {\r\n      return this.wfsWorkspaceService.createWorkspace(layer as VectorLayer, this.map);\r\n    } else if (layer.dataSource instanceof WMSDataSource) {\r\n      return this.wmsWorkspaceService.createWorkspace(layer as ImageLayer, this.map);\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  private layerIsEditable(layer: Layer): boolean {\r\n    const dataSource = layer.dataSource;\r\n    if (dataSource instanceof WFSDataSource) {\r\n      return true;\r\n    }\r\n\r\n    if (dataSource instanceof WMSDataSource) {\r\n      const dataSourceOptions = (dataSource.options ||\r\n        {}) as OgcFilterableDataSourceOptions;\r\n      return (\r\n        dataSourceOptions.ogcFilters && dataSourceOptions.ogcFilters.enabled\r\n      );\r\n    }\r\n\r\n    return false;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { WorkspaceSelectorDirective } from './workspace-selector.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n   WorkspaceSelectorDirective\r\n  ],\r\n  declarations: [\r\n    WorkspaceSelectorDirective\r\n  ]\r\n})\r\nexport class IgoWorkspaceSelectorModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { IgoWidgetModule } from '@igo2/common';\r\n\r\nimport { provideOgcFilterWidget } from './widgets/widgets';\r\n\r\nimport { IgoOgcFilterModule } from './widgets/ogc-filter/ogc-filter.module';\r\nimport { IgoWorkspaceSelectorModule } from './workspace-selector/workspace-selector.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoWidgetModule,\r\n    IgoWorkspaceSelectorModule,\r\n    IgoOgcFilterModule\r\n  ],\r\n  exports: [\r\n    IgoWorkspaceSelectorModule,\r\n    IgoOgcFilterModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    provideOgcFilterWidget()\r\n  ]\r\n})\r\nexport class IgoGeoWorkspaceModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  exports: [],\r\n  declarations: []\r\n})\r\nexport class IgoWktModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoWktModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\n\r\nimport { IgoCatalogModule } from './catalog/catalog.module';\r\nimport { IgoDataSourceModule } from './datasource/datasource.module';\r\nimport { IgoDownloadModule } from './download/download.module';\r\nimport { IgoFeatureModule } from './feature/feature.module';\r\nimport { IgoFilterModule } from './filter/filter.module';\r\nimport { IgoGeometryModule } from './geometry/geometry.module';\r\nimport { IgoImportExportModule } from './import-export/import-export.module';\r\nimport { IgoLayerModule } from './layer/layer.module';\r\nimport { IgoMapModule } from './map/map.module';\r\nimport { IgoMeasureModule } from './measure/measure.module';\r\nimport { IgoMetadataModule } from './metadata/metadata.module';\r\nimport { IgoOverlayModule } from './overlay/overlay.module';\r\nimport { IgoPrintModule } from './print/print.module';\r\nimport { IgoQueryModule } from './query/query.module';\r\nimport { IgoDirectionsModule } from './directions/directions.module';\r\nimport { IgoSearchModule } from './search/search.module';\r\nimport { IgoToastModule } from './toast/toast.module';\r\nimport { IgoGeoWorkspaceModule } from './workspace/workspace.module';\r\nimport { IgoWktModule } from './wkt/wkt.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n    IgoCatalogModule,\r\n    IgoDataSourceModule,\r\n    IgoDownloadModule,\r\n    IgoFeatureModule,\r\n    IgoFilterModule,\r\n    IgoGeometryModule,\r\n    IgoImportExportModule,\r\n    IgoLayerModule,\r\n    IgoMapModule,\r\n    IgoMeasureModule,\r\n    IgoMetadataModule,\r\n    IgoOverlayModule,\r\n    IgoPrintModule,\r\n    IgoQueryModule,\r\n    IgoDirectionsModule,\r\n    IgoSearchModule,\r\n    IgoToastModule,\r\n    IgoGeoWorkspaceModule,\r\n    IgoWktModule\r\n  ]\r\n})\r\nexport class IgoGeoModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: IgoGeoModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { OptionsService } from './options.service';\r\nimport { OptionsApiService } from './options-api.service';\r\n\r\nexport function optionsApiFactory(\r\n  http: HttpClient,\r\n  configService: ConfigService\r\n) {\r\n  return new OptionsApiService(\r\n    http,\r\n    configService.getConfig('optionsApi'),\r\n  );\r\n}\r\n\r\nexport function provideOptionsApi() {\r\n  return {\r\n    provide: OptionsService,\r\n    useFactory: optionsApiFactory,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olWKT from 'ol/format/WKT';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\n\r\n/**\r\n * Cadastre search source\r\n */\r\n@Injectable()\r\nexport class CadastreSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'cadastre';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options);\r\n  }\r\n\r\n  getId(): string {\r\n    return CadastreSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CadastreSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Cadastre (Qubec)',\r\n      searchUrl: 'https://carto.cptaq.gouv.qc.ca/php/find_lot_v1.php?'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    term = term.endsWith(',') ? term.slice(0, -1) : term;\r\n    term = term.startsWith(',') ? term.substr(1) : term;\r\n    term = term.replace(/ /g, '');\r\n\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('numero') || !params.get('numero').match(/^[0-9,]+$/g)) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params, responseType: 'text' })\r\n      .pipe(map((response: string) => this.extractResults(response)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          numero: term,\r\n          epsg: '4326'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: string): SearchResult<Feature>[] {\r\n    return response\r\n      .split('<br />')\r\n      .filter((lot: string) => lot.length > 0)\r\n      .map((lot: string) => this.dataToResult(lot));\r\n  }\r\n\r\n  private dataToResult(data: string): SearchResult<Feature> {\r\n    const lot = data.split(';');\r\n    const numero = lot[0];\r\n    const wkt = lot[7];\r\n    const geometry = this.computeGeometry(wkt);\r\n    const properties = { NoLot: numero };\r\n    const id = [this.getId(), 'cadastre', numero].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: numero,\r\n        icon: 'map-marker'\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: numero\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeGeometry(wkt: string): FeatureGeometry {\r\n    const feature = new olWKT().readFeature(wkt, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: 'EPSG:4326'\r\n    });\r\n    return {\r\n      type: feature.getGeometry().getType(),\r\n      coordinates: feature.getGeometry().getCoordinates()\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { CadastreSearchSource } from './cadastre';\r\n\r\n/**\r\n * Cadastre search source factory\r\n * @ignore\r\n */\r\nexport function cadastreSearchSourceFactory(\r\n  http: HttpClient,\r\n  config: ConfigService\r\n) {\r\n  return new CadastreSearchSource(\r\n    http,\r\n    config.getConfig(`searchSources.${CadastreSearchSource.id}`),\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Cadastre search source\r\n */\r\nexport function provideCadastreSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: cadastreSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\nimport { NominatimData } from './nominatim.interfaces';\r\n\r\n/**\r\n * Nominatim search source\r\n */\r\n@Injectable()\r\nexport class NominatimSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'nominatim';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options);\r\n  }\r\n\r\n  getId(): string {\r\n    return NominatimSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return NominatimSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Nominatim (OSM)',\r\n      searchUrl: 'https://nominatim.openstreetmap.org/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'amenity',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.food',\r\n              value:\r\n                'bar,bbq,biergaten,cafe,drinking_water,fast_food,food_court,ice_cream,pub,restaurant',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.health',\r\n              value:\r\n                'baby_hatch,clinic,dentist,doctors,hospital,nursing_home,pharmacy,social_facility,veterinary',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.entertainment',\r\n              value:\r\n                'arts_centre,brothel,casino,cinema,community_center_fountain,gambling,nightclub,planetarium \\\r\n                          ,public_bookcase,social_centre,stripclub,studio,swingerclub,theatre,internet_cafe',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.finance',\r\n              value: 'atm,bank,bureau_de_change',\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: true\r\n            },\r\n            {\r\n              title: '20',\r\n              value: 20,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'countrycodes',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.canada',\r\n              value: 'CA',\r\n              enabled: true\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.all',\r\n              value: null,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'multiple object',\r\n          name: 'dedupe',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.true',\r\n              value: 0,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.false',\r\n              value: 1,\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q')) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(map((response: NominatimData[]) => this.extractResults(response)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          q: this.computeTerm(term),\r\n          format: 'json'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: NominatimData[]): SearchResult<Feature>[] {\r\n    return response.map((data: NominatimData) => this.dataToResult(data));\r\n  }\r\n\r\n  private dataToResult(data: NominatimData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const geometry = this.computeGeometry(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), 'place', data.place_id].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.display_name,\r\n        icon: 'map-marker'\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.display_name\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: NominatimData): { [key: string]: any } {\r\n    return {\r\n      display_name: data.display_name,\r\n      place_id: data.place_id,\r\n      osm_type: data.osm_type,\r\n      class: data.class,\r\n      type: data.type\r\n    };\r\n  }\r\n\r\n  private computeGeometry(data: NominatimData): FeatureGeometry {\r\n    return {\r\n      type: 'Point',\r\n      coordinates: [parseFloat(data.lon), parseFloat(data.lat)]\r\n    };\r\n  }\r\n\r\n  private computeExtent(data: NominatimData): [number, number, number, number] {\r\n    return [\r\n      parseFloat(data.boundingbox[2]),\r\n      parseFloat(data.boundingbox[0]),\r\n      parseFloat(data.boundingbox[3]),\r\n      parseFloat(data.boundingbox[1])\r\n    ];\r\n  }\r\n\r\n  private computeTerm(term: string): string {\r\n    return this.computeTermTags(term);\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from query in Nominatim's format (+[])\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTermTags(term: string): string {\r\n    const hashtags = super.getHashtagsValid(term, 'amenity');\r\n    if (!hashtags) {\r\n      return this.computeTermSettings(term);\r\n    }\r\n\r\n    if (!hashtags.length) {\r\n      return null;\r\n    }\r\n\r\n    term = term.replace(/(#[^\\s]*)/g, '');\r\n    hashtags.forEach(tag => {\r\n      term += '+[' + tag + ']';\r\n    });\r\n\r\n    return term;\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from settings in Nominatim's format (+[])\r\n   * @param term Query\r\n   */\r\n  private computeTermSettings(term: string): string {\r\n    this.options.settings.forEach(settings => {\r\n      if (settings.name === 'amenity') {\r\n        settings.values.forEach(conf => {\r\n          if (conf.enabled && typeof conf.value === 'string') {\r\n            const splitted = conf.value.split(',');\r\n            splitted.forEach(value => {\r\n              term += '+[' + value + ']';\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n    return term;\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { NominatimSearchSource } from './nominatim';\r\n\r\n/**\r\n * Nominatim search source factory\r\n * @ignore\r\n */\r\nexport function nominatimSearchSourceFactory(\r\n  http: HttpClient,\r\n  config: ConfigService\r\n) {\r\n  return new NominatimSearchSource(\r\n    http,\r\n    config.getConfig(`searchSources.${NominatimSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Nominatim search source\r\n */\r\nexport function provideNominatimSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: nominatimSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { FEATURE, Feature } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  StoredQueriesData,\r\n  StoredQueriesResponse,\r\n  StoredQueriesReverseData,\r\n  StoredQueriesReverseResponse,\r\n  StoredQueriesSearchSourceOptions,\r\n  StoredQueriesFields,\r\n  StoredQueriesReverseSearchSourceOptions\r\n} from './storedqueries.interfaces';\r\n\r\nimport * as olformat from 'ol/format';\r\n\r\n/**\r\n * StoredQueries search source\r\n */\r\n@Injectable()\r\nexport class StoredQueriesSearchSource extends SearchSource\r\n  implements TextSearch {\r\n  static id = 'storedqueries';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [\r\n    'boundedBy',\r\n    'id',\r\n    'coord_x',\r\n    'coord_y'\r\n  ];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options);\r\n    this.storedQueriesOptions = options as StoredQueriesSearchSourceOptions;\r\n    if (this.storedQueriesOptions && !this.storedQueriesOptions.available) {\r\n      return;\r\n    }\r\n\r\n    const defaultStoredqueryId = 'rtss';\r\n    const defaultFieldSplitter: StoredQueriesFields[] = [\r\n      { name: 'rtss', defaultValue: '-99' },\r\n      { name: 'chainage', defaultValue: '0', splitPrefix: '\\\\+' }\r\n    ];\r\n    const defaultOutputformat = 'text/xml; subtype=gml/3.1.1';\r\n    const defaultSrsname = 'EPSG:4326';\r\n    const defaultResultTitle = 'title';\r\n\r\n    if (!this.storedQueriesOptions) {\r\n      console.log(\r\n        ' No configuration for this search source (storedqueries). You will use the default values'\r\n      );\r\n      this.storedQueriesOptions = {\r\n        storedquery_id: defaultStoredqueryId,\r\n        fields: defaultFieldSplitter,\r\n        outputformat: defaultOutputformat,\r\n        srsname: defaultSrsname,\r\n        resultTitle: defaultResultTitle\r\n      };\r\n      this.resultTitle = defaultResultTitle;\r\n      console.log('Default values', this.storedQueriesOptions);\r\n    }\r\n\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.fields) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"fields\" into options. ex: fields: {\"name\": \"rtss\", \"defaultValue\": \"-99\"}'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n\r\n    const storedQueryId = this.storedQueriesOptions.storedquery_id.toLowerCase();\r\n    if (\r\n      storedQueryId.includes('getfeaturebyid') &&\r\n      this.storedQueriesOptions.outputformat\r\n        .toLowerCase()\r\n        .includes('getfeaturebyid')\r\n    ) {\r\n      let err =\r\n        'You must set a geojson format for your stored query. This is due to an openlayers issue)';\r\n      err += ' (wfs 1.1.0 & gml 3.1.1 limitation)';\r\n      throw new Error(err);\r\n    }\r\n\r\n    if (!(this.storedQueriesOptions.fields instanceof Array)) {\r\n      this.storedQueriesOptions.fields = [this.storedQueriesOptions.fields];\r\n    }\r\n\r\n    this.multipleFieldsQuery =\r\n      this.storedQueriesOptions.fields.length > 1 ? true : false;\r\n\r\n    this.storedQueriesOptions.fields.forEach((field, index) => {\r\n      if (this.multipleFieldsQuery && !field.splitPrefix && index !== 0) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field spliter into your field definition (optional for the first one!)'\r\n        );\r\n      }\r\n      if (!field.defaultValue) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field default value into your field definition'\r\n        );\r\n      }\r\n    });\r\n\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/ws/swtq'\r\n    };\r\n  }\r\n\r\n  // URL CALL EXAMPLES:\r\n  //  GetFeatureById (mandatory storedquery for wfs server) (outputformat must be in geojson)\r\n  //  tslint:disable-next-line:max-line-length\r\n  //  https://geoegl.msp.gouv.qc.ca/apis/ws/swtq?service=wfs&version=2.0.0&request=GetFeature&storedquery_id=urn:ogc:def:query:OGC-WFS::GetFeatureById&srsname=epsg:4326&outputformat=geojson&ID=a_num_route.132\r\n  //  Custom StoredQuery\r\n  //  tslint:disable-next-line:max-line-length\r\n  //  https://geoegl.msp.gouv.qc.ca/apis/ws/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=rtss&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&rtss=0013801110000c&chainage=12\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const storedqueriesParams = this.termSplitter(\r\n      term,\r\n      this.storedQueriesOptions.fields\r\n    );\r\n    const params = this.computeRequestParams(\r\n      options || {},\r\n      storedqueriesParams\r\n    );\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            return this.extractResults(this.extractWFSData(response));\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response));\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private termSplitter(term: string, fields: StoredQueriesFields[]): {} {\r\n    const splittedTerm = {};\r\n    let remainingTerm = term;\r\n    let cnt = 0;\r\n\r\n    // Used to build the default values\r\n    fields.forEach(field => {\r\n      splittedTerm[field.name] = field.defaultValue;\r\n      const splitterRegex = new RegExp(field.splitPrefix + '(.+)', 'i');\r\n      if (splitterRegex.test(remainingTerm)) {\r\n        cnt = field.splitPrefix ? (cnt += 1) : cnt;\r\n        remainingTerm = remainingTerm.split(splitterRegex)[1];\r\n      }\r\n    });\r\n    if (cnt === 0) {\r\n      splittedTerm[fields[0].name] = term;\r\n      return splittedTerm;\r\n    }\r\n    remainingTerm = term;\r\n    const localFields = [...fields].reverse();\r\n    localFields.forEach(field => {\r\n      const splitterRegex = new RegExp(field.splitPrefix || '' + '(.+)', 'i');\r\n      if (remainingTerm || remainingTerm !== '') {\r\n        const values = remainingTerm.split(splitterRegex);\r\n        remainingTerm = values[0];\r\n        if (values[1]) {\r\n          splittedTerm[field.name] = values[1].trim();\r\n        }\r\n      }\r\n    });\r\n    return splittedTerm;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    options: TextSearchOptions,\r\n    queryParams\r\n  ): HttpParams {\r\n    const wfsversion = this.storedQueriesOptions.storedquery_id\r\n      .toLowerCase()\r\n      .includes('getfeaturebyid')\r\n      ? '2.0.0'\r\n      : '1.1.0';\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'wfs',\r\n          version: wfsversion,\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        queryParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        // extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.title,\r\n        titleHtml: data.properties[title],\r\n        icon: 'map-marker'\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: StoredQueriesData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      StoredQueriesSearchSource.propertiesBlacklist\r\n    );\r\n    return properties;\r\n  }\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source\r\n */\r\n\r\n// EXAMPLE CALLS\r\n// tslint:disable-next-line:max-line-length\r\n// https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=lim_adm&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&long=-71.292469&lat=46.748107\r\n//\r\n\r\n@Injectable()\r\nexport class StoredQueriesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'storedqueriesreverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesReverseSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options);\r\n    this.storedQueriesOptions = options as StoredQueriesReverseSearchSourceOptions;\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.longField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"longField\" to map the longitude coordinate to the query params.'\r\n      );\r\n    }\r\n    if (!this.storedQueriesOptions.latField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"latField\" to map the latitude coordinate to the query params.'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries (reverse)',\r\n      searchUrl: 'https://ws.mapserver.transports.gouv.qc.ca/swtq'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            return this.extractResults(this.extractWFSData(response));\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response));\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    const longLatParams = {};\r\n    longLatParams[this.storedQueriesOptions.longField] = lonLat[0];\r\n    longLatParams[this.storedQueriesOptions.latField] = lonLat[1];\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'WFS',\r\n          version: '1.1.0',\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        longLatParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties[title],\r\n        icon: 'map-marker'\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(\r\n    data: StoredQueriesReverseData\r\n  ): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      StoredQueriesReverseSearchSource.propertiesBlacklist\r\n    );\r\n    return Object.assign(properties, { type: data.properties.doc_type });\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  StoredQueriesSearchSource,\r\n  StoredQueriesReverseSearchSource\r\n} from './storedqueries';\r\n\r\n/**\r\n * StoredQueries search source factory\r\n * @ignore\r\n */\r\nexport function storedqueriesSearchSourceFactory(\r\n  http: HttpClient,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesSearchSource(\r\n    http,\r\n    config.getConfig(`searchSources.${StoredQueriesSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueries search source\r\n */\r\nexport function provideStoredQueriesSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source factory\r\n * @ignore\r\n */\r\n\r\nexport function storedqueriesReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesReverseSearchSource(\r\n    http,\r\n    config.getConfig(`searchSources.${StoredQueriesReverseSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueriesReverse search source\r\n */\r\nexport function provideStoredQueriesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","export enum DirectionsFormat {\r\n  GeoJSON,\r\n  JSON\r\n}\r\nexport enum SourceDirectionsType {\r\n  Route = 'Route',\r\n  Trip = 'Trip'\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { uuid } from '@igo2/utils';\r\nimport { ConfigService, Message } from '@igo2/core';\r\n\r\nimport { Directions, DirectionsOptions } from '../shared/directions.interface';\r\nimport { DirectionsFormat, SourceDirectionsType } from '../shared/directions.enum';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { DirectionsSourceOptions } from './directions-source.interface';\r\n\r\n@Injectable()\r\nexport class OsrmDirectionsSource extends DirectionsSource {\r\n  get enabled(): boolean {\r\n    return this.options.enabled !== false;\r\n  }\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  static _name = 'OSRM Qubec';\r\n  private directionsUrl =\r\n    'https://geoegl.msp.gouv.qc.ca/services/itineraire/route/v1/driving/';\r\n  private options: DirectionsSourceOptions;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    super();\r\n    this.options = this.config.getConfig('directionsSources.osrm') || {};\r\n    this.directionsUrl = this.options.url || this.directionsUrl;\r\n  }\r\n\r\n  getName(): string {\r\n    return OsrmDirectionsSource._name;\r\n  }\r\n\r\n  route(coordinates: [number, number][], directionsOptions: DirectionsOptions = {}): Observable<Directions[]> {\r\n    const directionsParams = this.getRouteParams(directionsOptions);\r\n    return this.http\r\n      .get<JSON[]>(this.directionsUrl + coordinates.join(';'), {\r\n        params: directionsParams\r\n      })\r\n      .pipe(map(res => this.extractRoutesData(res)));\r\n  }\r\n\r\n  private extractRoutesData(response): Directions[] {\r\n    const routeResponse = [];\r\n    response.routes.forEach(route => {\r\n      routeResponse.push(this.formatRoute(route, response.waypoints));\r\n    });\r\n    return routeResponse;\r\n  }\r\n\r\n  private getRouteParams(directionsOptions: DirectionsOptions = {}): HttpParams {\r\n\r\n    directionsOptions.alternatives = directionsOptions.alternatives !== undefined ? directionsOptions.alternatives : true;\r\n    directionsOptions.steps = directionsOptions.steps !== undefined  ? directionsOptions.steps : true;\r\n    directionsOptions.geometries = directionsOptions.geometries !== undefined  ? directionsOptions.geometries : 'geojson';\r\n    directionsOptions.overview = directionsOptions.overview !== undefined  ? directionsOptions.overview : false;\r\n\r\n    return new HttpParams({\r\n      fromObject: {\r\n        alternatives: directionsOptions.alternatives ? 'true' : 'false',\r\n        overview: directionsOptions.overview ? 'simplified' : 'full',\r\n        steps: directionsOptions.steps ? 'true' : 'false',\r\n        geometries: directionsOptions.geometries ? directionsOptions.geometries : 'geojson',\r\n      }\r\n    });\r\n  }\r\n\r\n  private formatRoute(roadNetworkRoute: any, waypoints: any): Directions {\r\n    const stepsUI = [];\r\n    roadNetworkRoute.legs.forEach(leg => {\r\n      leg.steps.forEach(step => {\r\n        stepsUI.push(step);\r\n      });\r\n    });\r\n    return {\r\n      id: uuid(),\r\n      title: roadNetworkRoute.legs[0].summary,\r\n      source: OsrmDirectionsSource._name,\r\n      sourceType: SourceDirectionsType.Route,\r\n      order: 1,\r\n      format: DirectionsFormat.GeoJSON,\r\n      icon: 'directions',\r\n      projection: 'EPSG:4326',\r\n      waypoints,\r\n      distance: roadNetworkRoute.distance,\r\n      duration: roadNetworkRoute.duration,\r\n      geometry: roadNetworkRoute.geometry,\r\n      legs: roadNetworkRoute.legs,\r\n      steps: stepsUI,\r\n      weight: roadNetworkRoute.weight,\r\n      weight_name: roadNetworkRoute.weight_name\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { OsrmDirectionsSource } from './osrm-directions-source';\r\n\r\nexport function osrmDirectionsSourcesFactory(\r\n  http: HttpClient,\r\n  config: ConfigService\r\n) {\r\n  return new OsrmDirectionsSource(http, config);\r\n}\r\n\r\nexport function provideOsrmDirectionsSource() {\r\n  return {\r\n    provide: DirectionsSource,\r\n    useFactory: osrmDirectionsSourcesFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nimport { ExportFormat } from './export.type';\r\n\r\nimport { Platform } from '@ionic/angular';\r\nimport { File } from '@ionic-native/file/ngx';\r\nimport { FileOpener } from '@ionic-native/file-opener/ngx';\r\nimport { ExportService } from './export.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ExportIonicService extends ExportService {\r\n\r\n  constructor(\r\n      config: ConfigService,\r\n      private platform: Platform,\r\n      private fileOpener: FileOpener,\r\n      private file: File\r\n    ) {\r\n      super(config);\r\n    }\r\n\r\n    protected exportToFile(\r\n      olFeatures: OlFeature[],\r\n      observer: Observer<void>,\r\n      format: ExportFormat,\r\n      title: string,\r\n      projectionIn: string,\r\n      projectionOut: string\r\n    ) {\r\n      if (this.platform.is('cordova')) {\r\n        const olFormat = new olformat[format]();\r\n        const featuresText = olFormat.writeFeatures(olFeatures, {\r\n          dataProjection: projectionOut,\r\n          featureProjection: projectionIn,\r\n          featureType: 'feature',\r\n          featureNS: 'http://example.com/feature'\r\n        });\r\n\r\n        const fileName = `${title}.${format.toLowerCase()}`;\r\n        const directory = this.file.externalRootDirectory + 'Download';\r\n        console.log(directory);\r\n        this.file.writeFile(directory, fileName, featuresText, { replace: true }).then((success) =>\r\n        this.fileOpener.open(directory + '/' + fileName, 'text/plain'));\r\n        observer.complete();\r\n      } else {\r\n        super.exportToFile(\r\n          olFeatures,\r\n          observer,\r\n          format,\r\n          title,\r\n          projectionIn,\r\n          projectionOut\r\n        );\r\n      }\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport * as jsPDF from 'jspdf';\r\nimport { Platform } from '@ionic/angular';\r\nimport { File } from '@ionic-native/file/ngx';\r\nimport { FileOpener } from '@ionic-native/file-opener/ngx';\r\n\r\nimport { MessageService, ActivityService, LanguageService } from '@igo2/core';\r\nimport { PrintService } from './print.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class PrintIonicService extends PrintService {\r\n  date: Date;\r\n  day: string;\r\n  month: any;\r\n  hour: string;\r\n  minute: string;\r\n  year: string;\r\n\r\n  constructor(\r\n    messageService: MessageService,\r\n    activityService: ActivityService,\r\n    languageService: LanguageService,\r\n    private platform: Platform,\r\n    private fileOpener: FileOpener,\r\n    private file: File\r\n  ) {\r\n    super(messageService, activityService, languageService);\r\n  }\r\n\r\n  protected saveDoc(doc: jsPDF) {\r\n    if (this.platform.is('cordova')) {\r\n      const docOutput = doc.output();\r\n      const buffer = new ArrayBuffer(docOutput.length);\r\n      const array = new Uint8Array(buffer);\r\n      this.setDate();\r\n      for (let i = 0; i < docOutput.length; i++) {\r\n          array[i] = docOutput.charCodeAt(i);\r\n      }\r\n      const fileName = 'map' + this.year + '-' + this.month + '-' + this.day + '-' + this.hour + '-' + this.minute + '.pdf';\r\n      const directory = this.file.externalRootDirectory + 'Download';\r\n      this.file.writeFile(directory, fileName, buffer, { replace: true }).then((success) =>\r\n        this.fileOpener.open(directory + '/' + fileName, 'application/pdf'));\r\n    } else {\r\n        super.saveDoc(doc);\r\n    }\r\n  }\r\n  private setDate() {\r\n      this.date = new Date();\r\n      this.day = this.date.getDate().toString();\r\n      this.month = this.date.getMonth() + 1;\r\n      if (this.month < 10) {\r\n        this.month = '0' + this.month.toString();\r\n      } else {\r\n          this.month = this.month.toString();\r\n      }\r\n      this.year = this.date.getFullYear().toString();\r\n      this.hour = this.date.getHours().toString();\r\n      this.minute = this.date.getMinutes().toString();\r\n  }\r\n}\r\n","export enum OgcFilterOperatorType {\r\n    BasicNumericOperator = 'BasicNumericOperator',\r\n    Basic = 'Basic',\r\n    BasicAndSpatial = 'BasicAndSpatial',\r\n    Spatial = 'Spatial',\r\n    All = 'All',\r\n    Time = 'time'\r\n}\r\n","export enum LayerListToolControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\n"]}